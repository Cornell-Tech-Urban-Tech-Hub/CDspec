---
import MainLayout from '../layouts/Default.astro';
import { getCollection } from 'astro:content';
import MapVisualizer from '../components/visualizations/MapVisualizer.js';
import studentData from '../../processing/student_data_verified_1204.json';

// Get all project CD codes for the map from the student data
const studentProjectCDs = studentData
  .filter(s => s.community_district && !s.needs_review)
  .map(s => s.community_district);

// Also get project CD codes from content collection (merging both sources)
const contentProjects = await getCollection('projects');
const contentProjectCDs = contentProjects
  .filter(p => !p.data.draft)
  .map(p => p.data.cdCode);

// Combine and deduplicate CD codes
let projectCDs = [...new Set([...studentProjectCDs, ...contentProjectCDs])].sort();

// Create a mapping from CD codes to project slugs/URLs
const cdToSlugMap: Record<string, string> = {};

// Add content collection projects first
contentProjects.forEach(project => {
  if (!project.data.draft) {
    cdToSlugMap[project.data.cdCode] = `/projects/${project.slug}`;
  }
});

// Add student data projects (this allows overriding or adding new ones)
studentData.forEach(student => {
  if (student.community_district && student.storymap_url && !student.needs_review) {
    // If we already have a proper project page, keep it, otherwise use the storymap URL directly
    // But since the prompt implies a modal -> storymap flow for these, we'll likely need to handle this in the map component
    // For now, we'll store the external URL. The MapVisualizer needs to handle external URLs vs internal slugs.
    if (!cdToSlugMap[student.community_district]) {
      cdToSlugMap[student.community_district] = student.storymap_url;
    }
  }
});
---

<MainLayout title="CDSpec - NYC Community District Analysis" 
            description="Targeted, speculative, and people-centered analyses of Community Districts in New York City">
  
  <!-- Hero Section - Make it full screen height with larger map -->
  <section class="flex flex-col bg-gradient-to-b from-background to-secondary/20 header-offset max-h-screen">
    <div class="w-full flex-1 flex flex-col">
      <!-- Hero Header -->
      <div class="hero-header-container fade-in">
        <!-- Three column row - title+button, description, logo+instructions -->
        <div class="hero-columns">
          <!-- Left: Title + Button -->
          <div class="hero-logo-col">
            <h1 class="hero-title">CDSpec NYC</h1>
            <p class="subtitle-description">
              Course project for the Fall 2025 Urban Systems course, a core component of the <a href='https://tech.cornell.edu/programs/masters-programs/jacobs-technion-cornell-dual-ms-urban-tech/'>Urban Tech Master's program</a> at Cornell Tech.
            </p>
            <a href="/" class="project-blog-btn hero-button hero-desktop-btn">
              <span class="btn-text">Project Blog Post</span>
              <span class="btn-subtitle">(coming soon!)</span>
            </a>
          </div>
          
          <!-- Center: Description -->
          <div class="hero-center-col">
            <p class="hero-description">
              CDSpec is a student-led project in Cornell Tech's Urban Systems class. Students selected and 'adopted' a NYC community district for the entire semester and undertook analyses that propose solutions to pressing local issues they discovered in their research. For the project, students analyzed, characterized, and mapped hard systems, soft systems, and their interactions in these neighborhoods to discover hidden patterns in these critical local urban systems. 
            </p>
          </div>
          
          <!-- Mobile-only: Button and Logo above instructions -->
          <div class="hero-mobile-top">
            <a href="/" class="project-blog-btn hero-button">
              <span class="btn-text">Project Blog Post</span>
              <span class="btn-subtitle">(coming soon!)</span>
            </a>
            <img 
              src="/images/ct-horizontal-black.png" 
              alt="Cornell Tech" 
              class="hero-logo"
            />
          </div>
          
          <!-- Right: Logo + Instructions -->
          <div class="hero-instructions-col">
            <img 
              src="/images/ct-horizontal-black.png" 
              alt="Cornell Tech" 
              class="hero-logo hero-desktop-logo"
            />
            <p class="hero-instructions">Orange areas on the map below represent community districts with a completed CDSpec StoryMap. Click on any such district to view the corresponding analysis.</p>
          </div>
        </div>
      </div>
      
      <!-- Map added to hero section -->
      <div id="home-map-section" class="relative overflow-hidden border-b border-black flex-1 w-full flex flex-col mb-0 pb-0">
        <!-- Curtain overlay - drops down to reveal map after 2 seconds -->
        <div id="map-curtain-overlay" class="map-curtain-overlay"></div>
        
        <!-- Gradient fade overlay at top (uses site background color #FBFBFD) -->
        <div style="position: absolute; top: 0; left: 0; right: 0; height: 40px; background: linear-gradient(to bottom, rgba(226,221,214,1) 0%, rgba(226,221,214,0.8) 30%, rgba(226,221,214,0) 100%); z-index: 10; pointer-events: none;"></div>
        
        <div id="home-map-container" class="h-full min-h-[65vh] w-full">
          <MapVisualizer 
            client:only="react" 
            projectCDs={projectCDs} 
            mapId="home-page-map" 
            CDToSlugMap={cdToSlugMap}
          />
        </div>
      </div>
    </div>
  </section>

  <!-- JavaScript for map navigation and fade effect -->
  <script>
    // Wait for the page to load
    document.addEventListener('DOMContentLoaded', function() {
      // Listen for map navigation events from other components
       window.addEventListener('navigateToCD', function(event) {
         const customEvent = event as CustomEvent;
         const { cdCode, mapId } = customEvent.detail || {};
         if (mapId !== 'home-page-map' || !cdCode) return;
      });
      
      // Trigger curtain drop animation 2 seconds after page load
      setTimeout(() => {
        const curtain = document.getElementById('map-curtain-overlay');
        if (curtain) {
          curtain.classList.add('curtain-dropped');
        }
      }, 2000);
    });
  </script>
</MainLayout>
