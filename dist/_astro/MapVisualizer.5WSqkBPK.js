import{r as Kn,g as Y0,R as xS}from"./index.BE634oiH.js";var Lg={exports:{}},Zu={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ev;function vS(){if(ev)return Zu;ev=1;var i=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function t(r,o,c){var d=null;if(c!==void 0&&(d=""+c),o.key!==void 0&&(d=""+o.key),"key"in o){c={};for(var a in o)a!=="key"&&(c[a]=o[a])}else c=o;return o=c.ref,{$$typeof:i,type:r,key:d,ref:o!==void 0?o:null,props:c}}return Zu.Fragment=e,Zu.jsx=t,Zu.jsxs=t,Zu}var tv;function bS(){return tv||(tv=1,Lg.exports=vS()),Lg.exports}var xs=bS();const Or={mapInstance:null,mapInitialized:!1,geojsonData:null,deckOverlay:null,tooltipElement:null,tooltips:{}},K0=Kn.createContext({mapInstance:null,setMapInstance:()=>{},mapInitialized:!1,setMapInitialized:()=>{},geojsonData:null,setGeojsonData:()=>{},deckOverlay:null,setDeckOverlay:()=>{},tooltipRef:{current:null},registerTooltip:()=>{},getTooltip:()=>null}),wS=({children:i})=>{const[e,t]=Kn.useState(Or.mapInstance),[r,o]=Kn.useState(Or.mapInitialized),[c,d]=Kn.useState(Or.geojsonData),[a,y]=Kn.useState(Or.deckOverlay),w=Kn.useRef(Or.tooltipElement),E=ge=>{Or.mapInstance=ge,t(ge)},I=ge=>{Or.mapInitialized=ge,o(ge)},D=ge=>{if(Or.geojsonData=ge,d(ge),ge&&Array.isArray(ge.features)&&typeof window<"u")try{sessionStorage.setItem("cd-geojson-data",JSON.stringify(ge))}catch(fe){console.warn("Error caching GeoJSON data:",fe)}},F=ge=>{Or.deckOverlay=ge,y(ge)},X=(ge,fe)=>{ge&&(console.log(`Registering tooltip for map: ${ge}`),Or.tooltips[ge]=fe,ge==="default-map"&&(Or.tooltipElement=fe,w.current=fe),typeof window<"u"&&(window.mapTooltips||(window.mapTooltips={}),window.mapTooltips[ge]=fe,window.getMapTooltip||(window.getMapTooltip=Te=>{const ke=`deck-tooltip-${Te}`;return document.getElementById(ke)})))},oe=ge=>{if(typeof document<"u"){if(!document.getElementById(`map-container-${ge}`))return console.log(`Map container for ${ge} no longer exists, skipping tooltip retrieval`),null;const ke=`deck-tooltip-${ge}`,Je=document.getElementById(ke);if(Je)return Je}const fe=Or.tooltips[ge];return fe||(Or.tooltipElement?Or.tooltipElement:(typeof window<"u"&&console.warn(`No tooltip found for map: ${ge}`),null))};Kn.useEffect(()=>{typeof window<"u"&&(window.CDMapContext={getTooltip:oe,registerTooltip:X})},[]),Kn.useEffect(()=>{if(!Or.geojsonData&&typeof window<"u")try{const ge=sessionStorage.getItem("cd-geojson-data");if(ge){const fe=JSON.parse(ge);fe&&Array.isArray(fe.features)&&(console.log("Using cached GeoJSON data"),Or.geojsonData=fe,d(fe))}}catch(ge){console.warn("Error retrieving cached GeoJSON:",ge)}},[]);const _e=Kn.useMemo(()=>({mapInstance:e,setMapInstance:E,mapInitialized:r,setMapInitialized:I,geojsonData:c,setGeojsonData:D,deckOverlay:a,setDeckOverlay:F,tooltipRef:w,registerTooltip:X,getTooltip:oe}),[e,r,c,a]);return xs.jsx(K0.Provider,{value:_e,children:i})},TS=()=>Kn.useContext(K0);class SS{constructor(){this.maps=new Map,this.overlays=new Map,this.destroyedMaps=new Set,this.setupCleanupHooks(),this.isScrolling=!1,this.scrollTimeout=null,this.lastCleanupTime=0,this.cleanupThrottleTime=1e3,this.inCleanupProcess=!1,this.isFullscreenActive=!1}setupCleanupHooks(){typeof window>"u"||(window.addEventListener("scroll",()=>{if(this.isFullscreenActive){console.log("Ignoring scroll event during fullscreen mode");return}this.isScrolling=!0,this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.scrollTimeout=setTimeout(()=>{this.isScrolling=!1},250)},{passive:!0}),this.setupFullscreenObserver(),"navigation"in window&&window.navigation.addEventListener("navigate",e=>{if(this.isScrolling||this.inCleanupProcess){console.log("Ignoring navigation event during scrolling or cleanup");return}const t=window.location.pathname,r=new URL(e.destination.url).pathname;t!==r?(console.log(`Navigation detected from ${t} to ${r}, cleaning up maps`),this.safeCleanupAll()):console.log("Same-page navigation detected, skipping cleanup")}),window.addEventListener("beforeunload",()=>{if(this.isFullscreenActive){console.log("Page unloading during fullscreen, deferring cleanup");return}console.log("Page unloading, cleaning up maps"),this.safeCleanupAll()}),document.addEventListener("astro:before-swap",()=>{if(this.isFullscreenActive){console.log("Ignoring astro:before-swap event during fullscreen");return}if(this.isScrolling||this.inCleanupProcess){console.log("Ignoring astro:before-swap event during scrolling or cleanup");return}if(this.shouldThrottleCleanup()){console.log("Throttling map cleanup to prevent multiple rapid cleanups");return}console.log("Astro navigation: cleaning up maps"),this.safeCleanupAll()}),document.addEventListener("viewtransitionstart",()=>{if(this.isScrolling||this.inCleanupProcess){console.log("Ignoring view transition event during scrolling or cleanup");return}console.log("View transition starting: preparing maps"),this.prepareForTransition()}))}setupFullscreenObserver(){if(typeof MutationObserver<"u"){const e=new MutationObserver(t=>{for(const r of t)r.type==="attributes"&&r.attributeName==="class"&&(document.body.classList.contains("fullscreen-active")?(this.isFullscreenActive=!0,console.log("Fullscreen mode detected, pausing map cleanup")):this.isFullscreenActive&&(this.isFullscreenActive=!1,console.log("Fullscreen mode exited, resuming normal operation"),setTimeout(()=>{this.isFullscreenActive=!1},500)))});typeof document<"u"&&e.observe(document.body,{attributes:!0})}}shouldThrottleCleanup(){const e=Date.now();return e-this.lastCleanupTime<this.cleanupThrottleTime?!0:(this.lastCleanupTime=e,!1)}registerMap(e,t){return this.destroyedMaps.has(e)&&this.destroyedMaps.delete(e),this.maps.set(e,t),console.log(`Registered map: ${e}`),this}registerOverlay(e,t){return this.overlays.set(e,t),console.log(`Registered overlay: ${e}`),this}prepareForTransition(){document.querySelectorAll(".map-tooltip").forEach(e=>{e instanceof HTMLElement&&(e.style.display="none")})}safeCleanupAll(){if(this.isScrolling)return console.log("Ignoring cleanup request during scrolling"),!1;if(this.inCleanupProcess)return console.log("Already in cleanup process, ignoring duplicate request"),!1;if(this.isFullscreenActive)return console.log("Ignoring cleanup request during fullscreen mode"),!1;try{return this.inCleanupProcess=!0,this.cleanupAll()}catch(e){return console.error("Error in safeCleanupAll:",e),!1}finally{this.inCleanupProcess=!1}}cleanupMap(e){try{if(this.destroyedMaps.has(e))return console.log(`Map ${e} was already cleaned up, skipping`),!0;const t=this.maps.get(e),r=this.overlays.get(e);if(!t)return console.log(`No map found with ID: ${e}`),!1;if(console.log(`Cleaning up map: ${e}`),!t._container||!t.style)return console.warn(`Map ${e} appears to be in an invalid state, marking as destroyed`),this.destroyedMaps.add(e),this.maps.delete(e),this.overlays.delete(e),!0;if(r){try{t._controls&&t._controls.includes(r)&&(t.removeControl(r),console.log(`Removed overlay from map: ${e}`))}catch(d){console.warn(`Failed to remove overlay from map ${e}:`,d)}this.overlays.delete(e)}try{t.off()}catch(d){console.warn(`Failed to remove map event listeners for ${e}:`,d)}const o=document.getElementById(`map-container-${e}`),c=document.getElementById(`maplibre-map-${e}`);if(!o)console.log(`Map container for ${e} not found, skipping remove()`);else try{const d=t.getContainer();t._canvas&&t._canvas.parentNode?(t.remove(),console.log(`Map ${e} removed`)):console.warn(`Map ${e} has invalid internal state, cleaning up references only`)}catch(d){console.warn(`Failed to call remove() on map ${e}:`,d)}return this.destroyedMaps.add(e),this.maps.delete(e),!0}catch(t){return console.error(`Error cleaning up map ${e}:`,t),this.destroyedMaps.add(e),this.maps.delete(e),this.overlays.delete(e),!1}}cleanupAll(){let e=!0;const t=Array.from(this.maps.keys());for(const r of t){const o=this.cleanupMap(r);e=e&&o}return e}}const ES=new SS;function Ih(i,e,t={}){const r={type:"Feature"};return(t.id===0||t.id)&&(r.id=t.id),t.bbox&&(r.bbox=t.bbox),r.properties=e||{},r.geometry=i,r}function AS(i,e,t={}){if(!i)throw new Error("coordinates is required");if(!Array.isArray(i))throw new Error("coordinates must be an Array");if(i.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!rv(i[0])||!rv(i[1]))throw new Error("coordinates must contain numbers");return Ih({type:"Point",coordinates:i},e,t)}function PS(i,e,t={}){for(const o of i){if(o.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");if(o[o.length-1].length!==o[0].length)throw new Error("First and last Position are not equivalent.");for(let c=0;c<o[o.length-1].length;c++)if(o[o.length-1][c]!==o[0][c])throw new Error("First and last Position are not equivalent.")}return Ih({type:"Polygon",coordinates:i},e,t)}function iv(i,e,t={}){if(i.length<2)throw new Error("coordinates must be an array of two or more positions");return Ih({type:"LineString",coordinates:i},e,t)}function CS(i,e,t={}){return Ih({type:"MultiLineString",coordinates:i},e,t)}function IS(i,e,t={}){return Ih({type:"MultiPolygon",coordinates:i},e,t)}function rv(i){return!isNaN(i)&&i!==null&&!Array.isArray(i)}function J0(i,e,t){if(i!==null)for(var r,o,c,d,a,y,w,E=0,I=0,D,F=i.type,X=F==="FeatureCollection",oe=F==="Feature",_e=X?i.features.length:1,ge=0;ge<_e;ge++){w=X?i.features[ge].geometry:oe?i.geometry:i,D=w?w.type==="GeometryCollection":!1,a=D?w.geometries.length:1;for(var fe=0;fe<a;fe++){var Te=0,ke=0;if(d=D?w.geometries[fe]:w,d!==null){y=d.coordinates;var Je=d.type;switch(E=0,Je){case null:break;case"Point":if(e(y,I,ge,Te,ke)===!1)return!1;I++,Te++;break;case"LineString":case"MultiPoint":for(r=0;r<y.length;r++){if(e(y[r],I,ge,Te,ke)===!1)return!1;I++,Je==="MultiPoint"&&Te++}Je==="LineString"&&Te++;break;case"Polygon":case"MultiLineString":for(r=0;r<y.length;r++){for(o=0;o<y[r].length-E;o++){if(e(y[r][o],I,ge,Te,ke)===!1)return!1;I++}Je==="MultiLineString"&&Te++,Je==="Polygon"&&ke++}Je==="Polygon"&&Te++;break;case"MultiPolygon":for(r=0;r<y.length;r++){for(ke=0,o=0;o<y[r].length;o++){for(c=0;c<y[r][o].length-E;c++){if(e(y[r][o][c],I,ge,Te,ke)===!1)return!1;I++}ke++}Te++}break;case"GeometryCollection":for(r=0;r<d.geometries.length;r++)if(J0(d.geometries[r],e)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function MS(i,e){var t,r,o,c,d,a,y,w,E,I,D=0,F=i.type==="FeatureCollection",X=i.type==="Feature",oe=F?i.features.length:1;for(t=0;t<oe;t++){for(a=F?i.features[t].geometry:X?i.geometry:i,w=F?i.features[t].properties:X?i.properties:{},E=F?i.features[t].bbox:X?i.bbox:void 0,I=F?i.features[t].id:X?i.id:void 0,y=a?a.type==="GeometryCollection":!1,d=y?a.geometries.length:1,o=0;o<d;o++){if(c=y?a.geometries[o]:a,c===null){if(e(null,D,w,E,I)===!1)return!1;continue}switch(c.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(e(c,D,w,E,I)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<c.geometries.length;r++)if(e(c.geometries[r],D,w,E,I)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}D++}}function RS(i,e={}){if(i.bbox!=null&&e.recompute!==!0)return i.bbox;const t=[1/0,1/0,-1/0,-1/0];return J0(i,r=>{t[0]>r[0]&&(t[0]=r[0]),t[1]>r[1]&&(t[1]=r[1]),t[2]<r[0]&&(t[2]=r[0]),t[3]<r[1]&&(t[3]=r[1])}),t}function kS(i,e={}){const t=RS(i),r=(t[0]+t[2])/2,o=(t[1]+t[3])/2;return AS([r,o],e.properties,e)}var DS=/^-?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?$/i,Fg=Math.ceil,Mn=Math.floor,nn="[BigNumber Error] ",nv=nn+"Number primitive has more than 15 significant digits: ",Xn=1e14,Xt=14,Bg=9007199254740991,Ng=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11,1e12,1e13],Oo=1e7,Sr=1e9;function Q0(i){var e,t,r,o=fe.prototype={constructor:fe,toString:null,valueOf:null},c=new fe(1),d=20,a=4,y=-7,w=21,E=-1e7,I=1e7,D=!1,F=1,X=0,oe={prefix:"",groupSize:3,secondaryGroupSize:0,groupSeparator:",",decimalSeparator:".",fractionGroupSize:0,fractionGroupSeparator:"Â ",suffix:""},_e="0123456789abcdefghijklmnopqrstuvwxyz",ge=!0;function fe(G,J){var ae,be,ye,we,Se,Ee,W,ee,K=this;if(!(K instanceof fe))return new fe(G,J);if(J==null){if(G&&G._isBigNumber===!0){K.s=G.s,!G.c||G.e>I?K.c=K.e=null:G.e<E?K.c=[K.e=0]:(K.e=G.e,K.c=G.c.slice());return}if((Ee=typeof G=="number")&&G*0==0){if(K.s=1/G<0?(G=-G,-1):1,G===~~G){for(we=0,Se=G;Se>=10;Se/=10,we++);we>I?K.c=K.e=null:(K.e=we,K.c=[G]);return}ee=String(G)}else{if(!DS.test(ee=String(G)))return r(K,ee,Ee);K.s=ee.charCodeAt(0)==45?(ee=ee.slice(1),-1):1}(we=ee.indexOf("."))>-1&&(ee=ee.replace(".","")),(Se=ee.search(/e/i))>0?(we<0&&(we=Se),we+=+ee.slice(Se+1),ee=ee.substring(0,Se)):we<0&&(we=ee.length)}else{if(Vi(J,2,_e.length,"Base"),J==10&&ge)return K=new fe(G),Xe(K,d+K.e+1,a);if(ee=String(G),Ee=typeof G=="number"){if(G*0!=0)return r(K,ee,Ee,J);if(K.s=1/G<0?(ee=ee.slice(1),-1):1,fe.DEBUG&&ee.replace(/^0\.0*|\./,"").length>15)throw Error(nv+G)}else K.s=ee.charCodeAt(0)===45?(ee=ee.slice(1),-1):1;for(ae=_e.slice(0,J),we=Se=0,W=ee.length;Se<W;Se++)if(ae.indexOf(be=ee.charAt(Se))<0){if(be=="."){if(Se>we){we=W;continue}}else if(!ye&&(ee==ee.toUpperCase()&&(ee=ee.toLowerCase())||ee==ee.toLowerCase()&&(ee=ee.toUpperCase()))){ye=!0,Se=-1,we=0;continue}return r(K,String(G),Ee,J)}Ee=!1,ee=t(ee,J,10,K.s),(we=ee.indexOf("."))>-1?ee=ee.replace(".",""):we=ee.length}for(Se=0;ee.charCodeAt(Se)===48;Se++);for(W=ee.length;ee.charCodeAt(--W)===48;);if(ee=ee.slice(Se,++W)){if(W-=Se,Ee&&fe.DEBUG&&W>15&&(G>Bg||G!==Mn(G)))throw Error(nv+K.s*G);if((we=we-Se-1)>I)K.c=K.e=null;else if(we<E)K.c=[K.e=0];else{if(K.e=we,K.c=[],Se=(we+1)%Xt,we<0&&(Se+=Xt),Se<W){for(Se&&K.c.push(+ee.slice(0,Se)),W-=Xt;Se<W;)K.c.push(+ee.slice(Se,Se+=Xt));Se=Xt-(ee=ee.slice(Se)).length}else Se-=W;for(;Se--;ee+="0");K.c.push(+ee)}}else K.c=[K.e=0]}fe.clone=Q0,fe.ROUND_UP=0,fe.ROUND_DOWN=1,fe.ROUND_CEIL=2,fe.ROUND_FLOOR=3,fe.ROUND_HALF_UP=4,fe.ROUND_HALF_DOWN=5,fe.ROUND_HALF_EVEN=6,fe.ROUND_HALF_CEIL=7,fe.ROUND_HALF_FLOOR=8,fe.EUCLID=9,fe.config=fe.set=function(G){var J,ae;if(G!=null)if(typeof G=="object"){if(G.hasOwnProperty(J="DECIMAL_PLACES")&&(ae=G[J],Vi(ae,0,Sr,J),d=ae),G.hasOwnProperty(J="ROUNDING_MODE")&&(ae=G[J],Vi(ae,0,8,J),a=ae),G.hasOwnProperty(J="EXPONENTIAL_AT")&&(ae=G[J],ae&&ae.pop?(Vi(ae[0],-Sr,0,J),Vi(ae[1],0,Sr,J),y=ae[0],w=ae[1]):(Vi(ae,-Sr,Sr,J),y=-(w=ae<0?-ae:ae))),G.hasOwnProperty(J="RANGE"))if(ae=G[J],ae&&ae.pop)Vi(ae[0],-Sr,-1,J),Vi(ae[1],1,Sr,J),E=ae[0],I=ae[1];else if(Vi(ae,-Sr,Sr,J),ae)E=-(I=ae<0?-ae:ae);else throw Error(nn+J+" cannot be zero: "+ae);if(G.hasOwnProperty(J="CRYPTO"))if(ae=G[J],ae===!!ae)if(ae)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))D=ae;else throw D=!ae,Error(nn+"crypto unavailable");else D=ae;else throw Error(nn+J+" not true or false: "+ae);if(G.hasOwnProperty(J="MODULO_MODE")&&(ae=G[J],Vi(ae,0,9,J),F=ae),G.hasOwnProperty(J="POW_PRECISION")&&(ae=G[J],Vi(ae,0,Sr,J),X=ae),G.hasOwnProperty(J="FORMAT"))if(ae=G[J],typeof ae=="object")oe=ae;else throw Error(nn+J+" not an object: "+ae);if(G.hasOwnProperty(J="ALPHABET"))if(ae=G[J],typeof ae=="string"&&!/^.?$|[+\-.\s]|(.).*\1/.test(ae))ge=ae.slice(0,10)=="0123456789",_e=ae;else throw Error(nn+J+" invalid: "+ae)}else throw Error(nn+"Object expected: "+G);return{DECIMAL_PLACES:d,ROUNDING_MODE:a,EXPONENTIAL_AT:[y,w],RANGE:[E,I],CRYPTO:D,MODULO_MODE:F,POW_PRECISION:X,FORMAT:oe,ALPHABET:_e}},fe.isBigNumber=function(G){if(!G||G._isBigNumber!==!0)return!1;if(!fe.DEBUG)return!0;var J,ae,be=G.c,ye=G.e,we=G.s;e:if({}.toString.call(be)=="[object Array]"){if((we===1||we===-1)&&ye>=-Sr&&ye<=Sr&&ye===Mn(ye)){if(be[0]===0){if(ye===0&&be.length===1)return!0;break e}if(J=(ye+1)%Xt,J<1&&(J+=Xt),String(be[0]).length==J){for(J=0;J<be.length;J++)if(ae=be[J],ae<0||ae>=Xn||ae!==Mn(ae))break e;if(ae!==0)return!0}}}else if(be===null&&ye===null&&(we===null||we===1||we===-1))return!0;throw Error(nn+"Invalid BigNumber: "+G)},fe.maximum=fe.max=function(){return ke(arguments,-1)},fe.minimum=fe.min=function(){return ke(arguments,1)},fe.random=(function(){var G=9007199254740992,J=Math.random()*G&2097151?function(){return Mn(Math.random()*G)}:function(){return(Math.random()*1073741824|0)*8388608+(Math.random()*8388608|0)};return function(ae){var be,ye,we,Se,Ee,W=0,ee=[],K=new fe(c);if(ae==null?ae=d:Vi(ae,0,Sr),Se=Fg(ae/Xt),D)if(crypto.getRandomValues){for(be=crypto.getRandomValues(new Uint32Array(Se*=2));W<Se;)Ee=be[W]*131072+(be[W+1]>>>11),Ee>=9e15?(ye=crypto.getRandomValues(new Uint32Array(2)),be[W]=ye[0],be[W+1]=ye[1]):(ee.push(Ee%1e14),W+=2);W=Se/2}else if(crypto.randomBytes){for(be=crypto.randomBytes(Se*=7);W<Se;)Ee=(be[W]&31)*281474976710656+be[W+1]*1099511627776+be[W+2]*4294967296+be[W+3]*16777216+(be[W+4]<<16)+(be[W+5]<<8)+be[W+6],Ee>=9e15?crypto.randomBytes(7).copy(be,W):(ee.push(Ee%1e14),W+=7);W=Se/7}else throw D=!1,Error(nn+"crypto unavailable");if(!D)for(;W<Se;)Ee=J(),Ee<9e15&&(ee[W++]=Ee%1e14);for(Se=ee[--W],ae%=Xt,Se&&ae&&(Ee=Ng[Xt-ae],ee[W]=Mn(Se/Ee)*Ee);ee[W]===0;ee.pop(),W--);if(W<0)ee=[we=0];else{for(we=-1;ee[0]===0;ee.splice(0,1),we-=Xt);for(W=1,Ee=ee[0];Ee>=10;Ee/=10,W++);W<Xt&&(we-=Xt-W)}return K.e=we,K.c=ee,K}})(),fe.sum=function(){for(var G=1,J=arguments,ae=new fe(J[0]);G<J.length;)ae=ae.plus(J[G++]);return ae},t=(function(){var G="0123456789";function J(ae,be,ye,we){for(var Se,Ee=[0],W,ee=0,K=ae.length;ee<K;){for(W=Ee.length;W--;Ee[W]*=be);for(Ee[0]+=we.indexOf(ae.charAt(ee++)),Se=0;Se<Ee.length;Se++)Ee[Se]>ye-1&&(Ee[Se+1]==null&&(Ee[Se+1]=0),Ee[Se+1]+=Ee[Se]/ye|0,Ee[Se]%=ye)}return Ee.reverse()}return function(ae,be,ye,we,Se){var Ee,W,ee,K,Ce,je,Ge,tt,pt=ae.indexOf("."),bt=d,_t=a;for(pt>=0&&(K=X,X=0,ae=ae.replace(".",""),tt=new fe(be),je=tt.pow(ae.length-pt),X=K,tt.c=J(Ks(In(je.c),je.e,"0"),10,ye,G),tt.e=tt.c.length),Ge=J(ae,be,ye,Se?(Ee=_e,G):(Ee=G,_e)),ee=K=Ge.length;Ge[--K]==0;Ge.pop());if(!Ge[0])return Ee.charAt(0);if(pt<0?--ee:(je.c=Ge,je.e=ee,je.s=we,je=e(je,tt,bt,_t,ye),Ge=je.c,Ce=je.r,ee=je.e),W=ee+bt+1,pt=Ge[W],K=ye/2,Ce=Ce||W<0||Ge[W+1]!=null,Ce=_t<4?(pt!=null||Ce)&&(_t==0||_t==(je.s<0?3:2)):pt>K||pt==K&&(_t==4||Ce||_t==6&&Ge[W-1]&1||_t==(je.s<0?8:7)),W<1||!Ge[0])ae=Ce?Ks(Ee.charAt(1),-bt,Ee.charAt(0)):Ee.charAt(0);else{if(Ge.length=W,Ce)for(--ye;++Ge[--W]>ye;)Ge[W]=0,W||(++ee,Ge=[1].concat(Ge));for(K=Ge.length;!Ge[--K];);for(pt=0,ae="";pt<=K;ae+=Ee.charAt(Ge[pt++]));ae=Ks(ae,ee,Ee.charAt(0))}return ae}})(),e=(function(){function G(be,ye,we){var Se,Ee,W,ee,K=0,Ce=be.length,je=ye%Oo,Ge=ye/Oo|0;for(be=be.slice();Ce--;)W=be[Ce]%Oo,ee=be[Ce]/Oo|0,Se=Ge*W+ee*je,Ee=je*W+Se%Oo*Oo+K,K=(Ee/we|0)+(Se/Oo|0)+Ge*ee,be[Ce]=Ee%we;return K&&(be=[K].concat(be)),be}function J(be,ye,we,Se){var Ee,W;if(we!=Se)W=we>Se?1:-1;else for(Ee=W=0;Ee<we;Ee++)if(be[Ee]!=ye[Ee]){W=be[Ee]>ye[Ee]?1:-1;break}return W}function ae(be,ye,we,Se){for(var Ee=0;we--;)be[we]-=Ee,Ee=be[we]<ye[we]?1:0,be[we]=Ee*Se+be[we]-ye[we];for(;!be[0]&&be.length>1;be.splice(0,1));}return function(be,ye,we,Se,Ee){var W,ee,K,Ce,je,Ge,tt,pt,bt,_t,Lt,Ut,Wt,oi,ei,ci,di,Ai=be.s==ye.s?1:-1,Yt=be.c,kt=ye.c;if(!Yt||!Yt[0]||!kt||!kt[0])return new fe(!be.s||!ye.s||(Yt?kt&&Yt[0]==kt[0]:!kt)?NaN:Yt&&Yt[0]==0||!kt?Ai*0:Ai/0);for(pt=new fe(Ai),bt=pt.c=[],ee=be.e-ye.e,Ai=we+ee+1,Ee||(Ee=Xn,ee=Rn(be.e/Xt)-Rn(ye.e/Xt),Ai=Ai/Xt|0),K=0;kt[K]==(Yt[K]||0);K++);if(kt[K]>(Yt[K]||0)&&ee--,Ai<0)bt.push(1),Ce=!0;else{for(oi=Yt.length,ci=kt.length,K=0,Ai+=2,je=Mn(Ee/(kt[0]+1)),je>1&&(kt=G(kt,je,Ee),Yt=G(Yt,je,Ee),ci=kt.length,oi=Yt.length),Wt=ci,_t=Yt.slice(0,ci),Lt=_t.length;Lt<ci;_t[Lt++]=0);di=kt.slice(),di=[0].concat(di),ei=kt[0],kt[1]>=Ee/2&&ei++;do{if(je=0,W=J(kt,_t,ci,Lt),W<0){if(Ut=_t[0],ci!=Lt&&(Ut=Ut*Ee+(_t[1]||0)),je=Mn(Ut/ei),je>1)for(je>=Ee&&(je=Ee-1),Ge=G(kt,je,Ee),tt=Ge.length,Lt=_t.length;J(Ge,_t,tt,Lt)==1;)je--,ae(Ge,ci<tt?di:kt,tt,Ee),tt=Ge.length,W=1;else je==0&&(W=je=1),Ge=kt.slice(),tt=Ge.length;if(tt<Lt&&(Ge=[0].concat(Ge)),ae(_t,Ge,Lt,Ee),Lt=_t.length,W==-1)for(;J(kt,_t,ci,Lt)<1;)je++,ae(_t,ci<Lt?di:kt,Lt,Ee),Lt=_t.length}else W===0&&(je++,_t=[0]);bt[K++]=je,_t[0]?_t[Lt++]=Yt[Wt]||0:(_t=[Yt[Wt]],Lt=1)}while((Wt++<oi||_t[0]!=null)&&Ai--);Ce=_t[0]!=null,bt[0]||bt.splice(0,1)}if(Ee==Xn){for(K=1,Ai=bt[0];Ai>=10;Ai/=10,K++);Xe(pt,we+(pt.e=K+ee*Xt-1)+1,Se,Ce)}else pt.e=ee,pt.r=+Ce;return pt}})();function Te(G,J,ae,be){var ye,we,Se,Ee,W;if(ae==null?ae=a:Vi(ae,0,8),!G.c)return G.toString();if(ye=G.c[0],Se=G.e,J==null)W=In(G.c),W=be==1||be==2&&(Se<=y||Se>=w)?Yd(W,Se):Ks(W,Se,"0");else if(G=Xe(new fe(G),J,ae),we=G.e,W=In(G.c),Ee=W.length,be==1||be==2&&(J<=we||we<=y)){for(;Ee<J;W+="0",Ee++);W=Yd(W,we)}else if(J-=Se+(be===2&&we>Se),W=Ks(W,we,"0"),we+1>Ee){if(--J>0)for(W+=".";J--;W+="0");}else if(J+=we-Ee,J>0)for(we+1==Ee&&(W+=".");J--;W+="0");return G.s<0&&ye?"-"+W:W}function ke(G,J){for(var ae,be,ye=1,we=new fe(G[0]);ye<G.length;ye++)be=new fe(G[ye]),(!be.s||(ae=wa(we,be))===J||ae===0&&we.s===J)&&(we=be);return we}function Je(G,J,ae){for(var be=1,ye=J.length;!J[--ye];J.pop());for(ye=J[0];ye>=10;ye/=10,be++);return(ae=be+ae*Xt-1)>I?G.c=G.e=null:ae<E?G.c=[G.e=0]:(G.e=ae,G.c=J),G}r=(function(){var G=/^(-?)0([xbo])(?=\w[\w.]*$)/i,J=/^([^.]+)\.$/,ae=/^\.([^.]+)$/,be=/^-?(Infinity|NaN)$/,ye=/^\s*\+(?=[\w.])|^\s+|\s+$/g;return function(we,Se,Ee,W){var ee,K=Ee?Se:Se.replace(ye,"");if(be.test(K))we.s=isNaN(K)?null:K<0?-1:1;else{if(!Ee&&(K=K.replace(G,function(Ce,je,Ge){return ee=(Ge=Ge.toLowerCase())=="x"?16:Ge=="b"?2:8,!W||W==ee?je:Ce}),W&&(ee=W,K=K.replace(J,"$1").replace(ae,"0.$1")),Se!=K))return new fe(K,ee);if(fe.DEBUG)throw Error(nn+"Not a"+(W?" base "+W:"")+" number: "+Se);we.s=null}we.c=we.e=null}})();function Xe(G,J,ae,be){var ye,we,Se,Ee,W,ee,K,Ce=G.c,je=Ng;if(Ce){e:{for(ye=1,Ee=Ce[0];Ee>=10;Ee/=10,ye++);if(we=J-ye,we<0)we+=Xt,Se=J,W=Ce[ee=0],K=Mn(W/je[ye-Se-1]%10);else if(ee=Fg((we+1)/Xt),ee>=Ce.length)if(be){for(;Ce.length<=ee;Ce.push(0));W=K=0,ye=1,we%=Xt,Se=we-Xt+1}else break e;else{for(W=Ee=Ce[ee],ye=1;Ee>=10;Ee/=10,ye++);we%=Xt,Se=we-Xt+ye,K=Se<0?0:Mn(W/je[ye-Se-1]%10)}if(be=be||J<0||Ce[ee+1]!=null||(Se<0?W:W%je[ye-Se-1]),be=ae<4?(K||be)&&(ae==0||ae==(G.s<0?3:2)):K>5||K==5&&(ae==4||be||ae==6&&(we>0?Se>0?W/je[ye-Se]:0:Ce[ee-1])%10&1||ae==(G.s<0?8:7)),J<1||!Ce[0])return Ce.length=0,be?(J-=G.e+1,Ce[0]=je[(Xt-J%Xt)%Xt],G.e=-J||0):Ce[0]=G.e=0,G;if(we==0?(Ce.length=ee,Ee=1,ee--):(Ce.length=ee+1,Ee=je[Xt-we],Ce[ee]=Se>0?Mn(W/je[ye-Se]%je[Se])*Ee:0),be)for(;;)if(ee==0){for(we=1,Se=Ce[0];Se>=10;Se/=10,we++);for(Se=Ce[0]+=Ee,Ee=1;Se>=10;Se/=10,Ee++);we!=Ee&&(G.e++,Ce[0]==Xn&&(Ce[0]=1));break}else{if(Ce[ee]+=Ee,Ce[ee]!=Xn)break;Ce[ee--]=0,Ee=1}for(we=Ce.length;Ce[--we]===0;Ce.pop());}G.e>I?G.c=G.e=null:G.e<E&&(G.c=[G.e=0])}return G}function mt(G){var J,ae=G.e;return ae===null?G.toString():(J=In(G.c),J=ae<=y||ae>=w?Yd(J,ae):Ks(J,ae,"0"),G.s<0?"-"+J:J)}return o.absoluteValue=o.abs=function(){var G=new fe(this);return G.s<0&&(G.s=1),G},o.comparedTo=function(G,J){return wa(this,new fe(G,J))},o.decimalPlaces=o.dp=function(G,J){var ae,be,ye,we=this;if(G!=null)return Vi(G,0,Sr),J==null?J=a:Vi(J,0,8),Xe(new fe(we),G+we.e+1,J);if(!(ae=we.c))return null;if(be=((ye=ae.length-1)-Rn(this.e/Xt))*Xt,ye=ae[ye])for(;ye%10==0;ye/=10,be--);return be<0&&(be=0),be},o.dividedBy=o.div=function(G,J){return e(this,new fe(G,J),d,a)},o.dividedToIntegerBy=o.idiv=function(G,J){return e(this,new fe(G,J),0,1)},o.exponentiatedBy=o.pow=function(G,J){var ae,be,ye,we,Se,Ee,W,ee,K,Ce=this;if(G=new fe(G),G.c&&!G.isInteger())throw Error(nn+"Exponent not an integer: "+mt(G));if(J!=null&&(J=new fe(J)),Ee=G.e>14,!Ce.c||!Ce.c[0]||Ce.c[0]==1&&!Ce.e&&Ce.c.length==1||!G.c||!G.c[0])return K=new fe(Math.pow(+mt(Ce),Ee?G.s*(2-Gd(G)):+mt(G))),J?K.mod(J):K;if(W=G.s<0,J){if(J.c?!J.c[0]:!J.s)return new fe(NaN);be=!W&&Ce.isInteger()&&J.isInteger(),be&&(Ce=Ce.mod(J))}else{if(G.e>9&&(Ce.e>0||Ce.e<-1||(Ce.e==0?Ce.c[0]>1||Ee&&Ce.c[1]>=24e7:Ce.c[0]<8e13||Ee&&Ce.c[0]<=9999975e7)))return we=Ce.s<0&&Gd(G)?-0:0,Ce.e>-1&&(we=1/we),new fe(W?1/we:we);X&&(we=Fg(X/Xt+2))}for(Ee?(ae=new fe(.5),W&&(G.s=1),ee=Gd(G)):(ye=Math.abs(+mt(G)),ee=ye%2),K=new fe(c);;){if(ee){if(K=K.times(Ce),!K.c)break;we?K.c.length>we&&(K.c.length=we):be&&(K=K.mod(J))}if(ye){if(ye=Mn(ye/2),ye===0)break;ee=ye%2}else if(G=G.times(ae),Xe(G,G.e+1,1),G.e>14)ee=Gd(G);else{if(ye=+mt(G),ye===0)break;ee=ye%2}Ce=Ce.times(Ce),we?Ce.c&&Ce.c.length>we&&(Ce.c.length=we):be&&(Ce=Ce.mod(J))}return be?K:(W&&(K=c.div(K)),J?K.mod(J):we?Xe(K,X,a,Se):K)},o.integerValue=function(G){var J=new fe(this);return G==null?G=a:Vi(G,0,8),Xe(J,J.e+1,G)},o.isEqualTo=o.eq=function(G,J){return wa(this,new fe(G,J))===0},o.isFinite=function(){return!!this.c},o.isGreaterThan=o.gt=function(G,J){return wa(this,new fe(G,J))>0},o.isGreaterThanOrEqualTo=o.gte=function(G,J){return(J=wa(this,new fe(G,J)))===1||J===0},o.isInteger=function(){return!!this.c&&Rn(this.e/Xt)>this.c.length-2},o.isLessThan=o.lt=function(G,J){return wa(this,new fe(G,J))<0},o.isLessThanOrEqualTo=o.lte=function(G,J){return(J=wa(this,new fe(G,J)))===-1||J===0},o.isNaN=function(){return!this.s},o.isNegative=function(){return this.s<0},o.isPositive=function(){return this.s>0},o.isZero=function(){return!!this.c&&this.c[0]==0},o.minus=function(G,J){var ae,be,ye,we,Se=this,Ee=Se.s;if(G=new fe(G,J),J=G.s,!Ee||!J)return new fe(NaN);if(Ee!=J)return G.s=-J,Se.plus(G);var W=Se.e/Xt,ee=G.e/Xt,K=Se.c,Ce=G.c;if(!W||!ee){if(!K||!Ce)return K?(G.s=-J,G):new fe(Ce?Se:NaN);if(!K[0]||!Ce[0])return Ce[0]?(G.s=-J,G):new fe(K[0]?Se:a==3?-0:0)}if(W=Rn(W),ee=Rn(ee),K=K.slice(),Ee=W-ee){for((we=Ee<0)?(Ee=-Ee,ye=K):(ee=W,ye=Ce),ye.reverse(),J=Ee;J--;ye.push(0));ye.reverse()}else for(be=(we=(Ee=K.length)<(J=Ce.length))?Ee:J,Ee=J=0;J<be;J++)if(K[J]!=Ce[J]){we=K[J]<Ce[J];break}if(we&&(ye=K,K=Ce,Ce=ye,G.s=-G.s),J=(be=Ce.length)-(ae=K.length),J>0)for(;J--;K[ae++]=0);for(J=Xn-1;be>Ee;){if(K[--be]<Ce[be]){for(ae=be;ae&&!K[--ae];K[ae]=J);--K[ae],K[be]+=Xn}K[be]-=Ce[be]}for(;K[0]==0;K.splice(0,1),--ee);return K[0]?Je(G,K,ee):(G.s=a==3?-1:1,G.c=[G.e=0],G)},o.modulo=o.mod=function(G,J){var ae,be,ye=this;return G=new fe(G,J),!ye.c||!G.s||G.c&&!G.c[0]?new fe(NaN):!G.c||ye.c&&!ye.c[0]?new fe(ye):(F==9?(be=G.s,G.s=1,ae=e(ye,G,0,3),G.s=be,ae.s*=be):ae=e(ye,G,0,F),G=ye.minus(ae.times(G)),!G.c[0]&&F==1&&(G.s=ye.s),G)},o.multipliedBy=o.times=function(G,J){var ae,be,ye,we,Se,Ee,W,ee,K,Ce,je,Ge,tt,pt,bt,_t=this,Lt=_t.c,Ut=(G=new fe(G,J)).c;if(!Lt||!Ut||!Lt[0]||!Ut[0])return!_t.s||!G.s||Lt&&!Lt[0]&&!Ut||Ut&&!Ut[0]&&!Lt?G.c=G.e=G.s=null:(G.s*=_t.s,!Lt||!Ut?G.c=G.e=null:(G.c=[0],G.e=0)),G;for(be=Rn(_t.e/Xt)+Rn(G.e/Xt),G.s*=_t.s,W=Lt.length,Ce=Ut.length,W<Ce&&(tt=Lt,Lt=Ut,Ut=tt,ye=W,W=Ce,Ce=ye),ye=W+Ce,tt=[];ye--;tt.push(0));for(pt=Xn,bt=Oo,ye=Ce;--ye>=0;){for(ae=0,je=Ut[ye]%bt,Ge=Ut[ye]/bt|0,Se=W,we=ye+Se;we>ye;)ee=Lt[--Se]%bt,K=Lt[Se]/bt|0,Ee=Ge*ee+K*je,ee=je*ee+Ee%bt*bt+tt[we]+ae,ae=(ee/pt|0)+(Ee/bt|0)+Ge*K,tt[we--]=ee%pt;tt[we]=ae}return ae?++be:tt.splice(0,1),Je(G,tt,be)},o.negated=function(){var G=new fe(this);return G.s=-G.s||null,G},o.plus=function(G,J){var ae,be=this,ye=be.s;if(G=new fe(G,J),J=G.s,!ye||!J)return new fe(NaN);if(ye!=J)return G.s=-J,be.minus(G);var we=be.e/Xt,Se=G.e/Xt,Ee=be.c,W=G.c;if(!we||!Se){if(!Ee||!W)return new fe(ye/0);if(!Ee[0]||!W[0])return W[0]?G:new fe(Ee[0]?be:ye*0)}if(we=Rn(we),Se=Rn(Se),Ee=Ee.slice(),ye=we-Se){for(ye>0?(Se=we,ae=W):(ye=-ye,ae=Ee),ae.reverse();ye--;ae.push(0));ae.reverse()}for(ye=Ee.length,J=W.length,ye-J<0&&(ae=W,W=Ee,Ee=ae,J=ye),ye=0;J;)ye=(Ee[--J]=Ee[J]+W[J]+ye)/Xn|0,Ee[J]=Xn===Ee[J]?0:Ee[J]%Xn;return ye&&(Ee=[ye].concat(Ee),++Se),Je(G,Ee,Se)},o.precision=o.sd=function(G,J){var ae,be,ye,we=this;if(G!=null&&G!==!!G)return Vi(G,1,Sr),J==null?J=a:Vi(J,0,8),Xe(new fe(we),G,J);if(!(ae=we.c))return null;if(ye=ae.length-1,be=ye*Xt+1,ye=ae[ye]){for(;ye%10==0;ye/=10,be--);for(ye=ae[0];ye>=10;ye/=10,be++);}return G&&we.e+1>be&&(be=we.e+1),be},o.shiftedBy=function(G){return Vi(G,-Bg,Bg),this.times("1e"+G)},o.squareRoot=o.sqrt=function(){var G,J,ae,be,ye,we=this,Se=we.c,Ee=we.s,W=we.e,ee=d+4,K=new fe("0.5");if(Ee!==1||!Se||!Se[0])return new fe(!Ee||Ee<0&&(!Se||Se[0])?NaN:Se?we:1/0);if(Ee=Math.sqrt(+mt(we)),Ee==0||Ee==1/0?(J=In(Se),(J.length+W)%2==0&&(J+="0"),Ee=Math.sqrt(+J),W=Rn((W+1)/2)-(W<0||W%2),Ee==1/0?J="5e"+W:(J=Ee.toExponential(),J=J.slice(0,J.indexOf("e")+1)+W),ae=new fe(J)):ae=new fe(Ee+""),ae.c[0]){for(W=ae.e,Ee=W+ee,Ee<3&&(Ee=0);;)if(ye=ae,ae=K.times(ye.plus(e(we,ye,ee,1))),In(ye.c).slice(0,Ee)===(J=In(ae.c)).slice(0,Ee))if(ae.e<W&&--Ee,J=J.slice(Ee-3,Ee+1),J=="9999"||!be&&J=="4999"){if(!be&&(Xe(ye,ye.e+d+2,0),ye.times(ye).eq(we))){ae=ye;break}ee+=4,Ee+=4,be=1}else{(!+J||!+J.slice(1)&&J.charAt(0)=="5")&&(Xe(ae,ae.e+d+2,1),G=!ae.times(ae).eq(we));break}}return Xe(ae,ae.e+d+1,a,G)},o.toExponential=function(G,J){return G!=null&&(Vi(G,0,Sr),G++),Te(this,G,J,1)},o.toFixed=function(G,J){return G!=null&&(Vi(G,0,Sr),G=G+this.e+1),Te(this,G,J)},o.toFormat=function(G,J,ae){var be,ye=this;if(ae==null)G!=null&&J&&typeof J=="object"?(ae=J,J=null):G&&typeof G=="object"?(ae=G,G=J=null):ae=oe;else if(typeof ae!="object")throw Error(nn+"Argument not an object: "+ae);if(be=ye.toFixed(G,J),ye.c){var we,Se=be.split("."),Ee=+ae.groupSize,W=+ae.secondaryGroupSize,ee=ae.groupSeparator||"",K=Se[0],Ce=Se[1],je=ye.s<0,Ge=je?K.slice(1):K,tt=Ge.length;if(W&&(we=Ee,Ee=W,W=we,tt-=we),Ee>0&&tt>0){for(we=tt%Ee||Ee,K=Ge.substr(0,we);we<tt;we+=Ee)K+=ee+Ge.substr(we,Ee);W>0&&(K+=ee+Ge.slice(we)),je&&(K="-"+K)}be=Ce?K+(ae.decimalSeparator||"")+((W=+ae.fractionGroupSize)?Ce.replace(new RegExp("\\d{"+W+"}\\B","g"),"$&"+(ae.fractionGroupSeparator||"")):Ce):K}return(ae.prefix||"")+be+(ae.suffix||"")},o.toFraction=function(G){var J,ae,be,ye,we,Se,Ee,W,ee,K,Ce,je,Ge=this,tt=Ge.c;if(G!=null&&(Ee=new fe(G),!Ee.isInteger()&&(Ee.c||Ee.s!==1)||Ee.lt(c)))throw Error(nn+"Argument "+(Ee.isInteger()?"out of range: ":"not an integer: ")+mt(Ee));if(!tt)return new fe(Ge);for(J=new fe(c),ee=ae=new fe(c),be=W=new fe(c),je=In(tt),we=J.e=je.length-Ge.e-1,J.c[0]=Ng[(Se=we%Xt)<0?Xt+Se:Se],G=!G||Ee.comparedTo(J)>0?we>0?J:ee:Ee,Se=I,I=1/0,Ee=new fe(je),W.c[0]=0;K=e(Ee,J,0,1),ye=ae.plus(K.times(be)),ye.comparedTo(G)!=1;)ae=be,be=ye,ee=W.plus(K.times(ye=ee)),W=ye,J=Ee.minus(K.times(ye=J)),Ee=ye;return ye=e(G.minus(ae),be,0,1),W=W.plus(ye.times(ee)),ae=ae.plus(ye.times(be)),W.s=ee.s=Ge.s,we=we*2,Ce=e(ee,be,we,a).minus(Ge).abs().comparedTo(e(W,ae,we,a).minus(Ge).abs())<1?[ee,be]:[W,ae],I=Se,Ce},o.toNumber=function(){return+mt(this)},o.toPrecision=function(G,J){return G!=null&&Vi(G,1,Sr),Te(this,G,J,2)},o.toString=function(G){var J,ae=this,be=ae.s,ye=ae.e;return ye===null?be?(J="Infinity",be<0&&(J="-"+J)):J="NaN":(G==null?J=ye<=y||ye>=w?Yd(In(ae.c),ye):Ks(In(ae.c),ye,"0"):G===10&&ge?(ae=Xe(new fe(ae),d+ye+1,a),J=Ks(In(ae.c),ae.e,"0")):(Vi(G,2,_e.length,"Base"),J=t(Ks(In(ae.c),ye,"0"),10,G,be,!0)),be<0&&ae.c[0]&&(J="-"+J)),J},o.valueOf=o.toJSON=function(){return mt(this)},o._isBigNumber=!0,o[Symbol.toStringTag]="BigNumber",o[Symbol.for("nodejs.util.inspect.custom")]=o.valueOf,i!=null&&fe.set(i),fe}function Rn(i){var e=i|0;return i>0||i===e?e:e-1}function In(i){for(var e,t,r=1,o=i.length,c=i[0]+"";r<o;){for(e=i[r++]+"",t=Xt-e.length;t--;e="0"+e);c+=e}for(o=c.length;c.charCodeAt(--o)===48;);return c.slice(0,o+1||1)}function wa(i,e){var t,r,o=i.c,c=e.c,d=i.s,a=e.s,y=i.e,w=e.e;if(!d||!a)return null;if(t=o&&!o[0],r=c&&!c[0],t||r)return t?r?0:-a:d;if(d!=a)return d;if(t=d<0,r=y==w,!o||!c)return r?0:!o^t?1:-1;if(!r)return y>w^t?1:-1;for(a=(y=o.length)<(w=c.length)?y:w,d=0;d<a;d++)if(o[d]!=c[d])return o[d]>c[d]^t?1:-1;return y==w?0:y>w^t?1:-1}function Vi(i,e,t,r){if(i<e||i>t||i!==Mn(i))throw Error(nn+(r||"Argument")+(typeof i=="number"?i<e||i>t?" out of range: ":" not an integer: ":" not a primitive number: ")+String(i))}function Gd(i){var e=i.c.length-1;return Rn(i.e/Xt)==e&&i.c[e]%2!=0}function Yd(i,e){return(i.length>1?i.charAt(0)+"."+i.slice(1):i)+(e<0?"e":"e+")+e}function Ks(i,e,t){var r,o;if(e<0){for(o=t+".";++e;o+=t);i=o+i}else if(r=i.length,++e>r){for(o=t,e-=r;--e;o+=t);i+=o}else e<r&&(i=i.slice(0,e)+"."+i.slice(e));return i}var Ts=Q0(),OS=class{key;left=null;right=null;constructor(i){this.key=i}},qu=class extends OS{constructor(i){super(i)}},LS=class{size=0;modificationCount=0;splayCount=0;splay(i){const e=this.root;if(e==null)return this.compare(i,i),-1;let t=null,r=null,o=null,c=null,d=e;const a=this.compare;let y;for(;;)if(y=a(d.key,i),y>0){let w=d.left;if(w==null||(y=a(w.key,i),y>0&&(d.left=w.right,w.right=d,d=w,w=d.left,w==null)))break;t==null?r=d:t.left=d,t=d,d=w}else if(y<0){let w=d.right;if(w==null||(y=a(w.key,i),y<0&&(d.right=w.left,w.left=d,d=w,w=d.right,w==null)))break;o==null?c=d:o.right=d,o=d,d=w}else break;return o!=null&&(o.right=d.left,d.left=c),t!=null&&(t.left=d.right,d.right=r),this.root!==d&&(this.root=d,this.splayCount++),y}splayMin(i){let e=i,t=e.left;for(;t!=null;){const r=t;e.left=r.right,r.right=e,e=r,t=e.left}return e}splayMax(i){let e=i,t=e.right;for(;t!=null;){const r=t;e.right=r.left,r.left=e,e=r,t=e.right}return e}_delete(i){if(this.root==null||this.splay(i)!=0)return null;let t=this.root;const r=t,o=t.left;if(this.size--,o==null)this.root=t.right;else{const c=t.right;t=this.splayMax(o),t.right=c,this.root=t}return this.modificationCount++,r}addNewRoot(i,e){this.size++,this.modificationCount++;const t=this.root;if(t==null){this.root=i;return}e<0?(i.left=t,i.right=t.right,t.right=null):(i.right=t,i.left=t.left,t.left=null),this.root=i}_first(){const i=this.root;return i==null?null:(this.root=this.splayMin(i),this.root)}_last(){const i=this.root;return i==null?null:(this.root=this.splayMax(i),this.root)}clear(){this.root=null,this.size=0,this.modificationCount++}has(i){return this.validKey(i)&&this.splay(i)==0}defaultCompare(){return(i,e)=>i<e?-1:i>e?1:0}wrap(){return{getRoot:()=>this.root,setRoot:i=>{this.root=i},getSize:()=>this.size,getModificationCount:()=>this.modificationCount,getSplayCount:()=>this.splayCount,setSplayCount:i=>{this.splayCount=i},splay:i=>this.splay(i),has:i=>this.has(i)}}},Nf=class eh extends LS{root=null;compare;validKey;constructor(e,t){super(),this.compare=e??this.defaultCompare(),this.validKey=t??(r=>r!=null&&r!=null)}delete(e){return this.validKey(e)?this._delete(e)!=null:!1}deleteAll(e){for(const t of e)this.delete(t)}forEach(e){const t=this[Symbol.iterator]();let r;for(;r=t.next(),!r.done;)e(r.value,r.value,this)}add(e){const t=this.splay(e);return t!=0&&this.addNewRoot(new qu(e),t),this}addAndReturn(e){const t=this.splay(e);return t!=0&&this.addNewRoot(new qu(e),t),this.root.key}addAll(e){for(const t of e)this.add(t)}isEmpty(){return this.root==null}isNotEmpty(){return this.root!=null}single(){if(this.size==0)throw"Bad state: No element";if(this.size>1)throw"Bad state: Too many element";return this.root.key}first(){if(this.size==0)throw"Bad state: No element";return this._first().key}last(){if(this.size==0)throw"Bad state: No element";return this._last().key}lastBefore(e){if(e==null)throw"Invalid arguments(s)";if(this.root==null)return null;if(this.splay(e)<0)return this.root.key;let r=this.root.left;if(r==null)return null;let o=r.right;for(;o!=null;)r=o,o=r.right;return r.key}firstAfter(e){if(e==null)throw"Invalid arguments(s)";if(this.root==null)return null;if(this.splay(e)>0)return this.root.key;let r=this.root.right;if(r==null)return null;let o=r.left;for(;o!=null;)r=o,o=r.left;return r.key}retainAll(e){const t=new eh(this.compare,this.validKey),r=this.modificationCount;for(const o of e){if(r!=this.modificationCount)throw"Concurrent modification during iteration.";this.validKey(o)&&this.splay(o)==0&&t.add(this.root.key)}t.size!=this.size&&(this.root=t.root,this.size=t.size,this.modificationCount++)}lookup(e){return!this.validKey(e)||this.splay(e)!=0?null:this.root.key}intersection(e){const t=new eh(this.compare,this.validKey);for(const r of this)e.has(r)&&t.add(r);return t}difference(e){const t=new eh(this.compare,this.validKey);for(const r of this)e.has(r)||t.add(r);return t}union(e){const t=this.clone();return t.addAll(e),t}clone(){const e=new eh(this.compare,this.validKey);return e.size=this.size,e.root=this.copyNode(this.root),e}copyNode(e){if(e==null)return null;function t(o,c){let d,a;do{if(d=o.left,a=o.right,d!=null){const y=new qu(d.key);c.left=y,t(d,y)}if(a!=null){const y=new qu(a.key);c.right=y,o=a,c=y}}while(a!=null)}const r=new qu(e.key);return t(e,r),r}toSet(){return this.clone()}entries(){return new BS(this.wrap())}keys(){return this[Symbol.iterator]()}values(){return this[Symbol.iterator]()}[Symbol.iterator](){return new FS(this.wrap())}[Symbol.toStringTag]="[object Set]"},ew=class{tree;path=new Array;modificationCount=null;splayCount;constructor(i){this.tree=i,this.splayCount=i.getSplayCount()}[Symbol.iterator](){return this}next(){return this.moveNext()?{done:!1,value:this.current()}:{done:!0,value:null}}current(){if(!this.path.length)return null;const i=this.path[this.path.length-1];return this.getValue(i)}rebuildPath(i){this.path.splice(0,this.path.length),this.tree.splay(i),this.path.push(this.tree.getRoot()),this.splayCount=this.tree.getSplayCount()}findLeftMostDescendent(i){for(;i!=null;)this.path.push(i),i=i.left}moveNext(){if(this.modificationCount!=this.tree.getModificationCount()){if(this.modificationCount==null){this.modificationCount=this.tree.getModificationCount();let t=this.tree.getRoot();for(;t!=null;)this.path.push(t),t=t.left;return this.path.length>0}throw"Concurrent modification during iteration."}if(!this.path.length)return!1;this.splayCount!=this.tree.getSplayCount()&&this.rebuildPath(this.path[this.path.length-1].key);let i=this.path[this.path.length-1],e=i.right;if(e!=null){for(;e!=null;)this.path.push(e),e=e.left;return!0}for(this.path.pop();this.path.length&&this.path[this.path.length-1].right===i;)i=this.path.pop();return this.path.length>0}},FS=class extends ew{getValue(i){return i.key}},BS=class extends ew{getValue(i){return[i.key,i.key]}},tw=i=>()=>i,Rm=i=>{const e=i?(t,r)=>r.minus(t).abs().isLessThanOrEqualTo(i):tw(!1);return(t,r)=>e(t,r)?0:t.comparedTo(r)};function NS(i){const e=i?(t,r,o,c,d)=>t.exponentiatedBy(2).isLessThanOrEqualTo(c.minus(r).exponentiatedBy(2).plus(d.minus(o).exponentiatedBy(2)).times(i)):tw(!1);return(t,r,o)=>{const c=t.x,d=t.y,a=o.x,y=o.y,w=d.minus(y).times(r.x.minus(a)).minus(c.minus(a).times(r.y.minus(y)));return e(w,c,d,a,y)?0:w.comparedTo(0)}}var zS=i=>i,US=i=>{if(i){const e=new Nf(Rm(i)),t=new Nf(Rm(i)),r=(c,d)=>d.addAndReturn(c),o=c=>({x:r(c.x,e),y:r(c.y,t)});return o({x:new Ts(0),y:new Ts(0)}),o}return zS},km=i=>({set:e=>{io=km(e)},reset:()=>km(i),compare:Rm(i),snap:US(i),orient:NS(i)}),io=km(),Xu=(i,e)=>i.ll.x.isLessThanOrEqualTo(e.x)&&e.x.isLessThanOrEqualTo(i.ur.x)&&i.ll.y.isLessThanOrEqualTo(e.y)&&e.y.isLessThanOrEqualTo(i.ur.y),Dm=(i,e)=>{if(e.ur.x.isLessThan(i.ll.x)||i.ur.x.isLessThan(e.ll.x)||e.ur.y.isLessThan(i.ll.y)||i.ur.y.isLessThan(e.ll.y))return null;const t=i.ll.x.isLessThan(e.ll.x)?e.ll.x:i.ll.x,r=i.ur.x.isLessThan(e.ur.x)?i.ur.x:e.ur.x,o=i.ll.y.isLessThan(e.ll.y)?e.ll.y:i.ll.y,c=i.ur.y.isLessThan(e.ur.y)?i.ur.y:e.ur.y;return{ll:{x:t,y:o},ur:{x:r,y:c}}},vf=(i,e)=>i.x.times(e.y).minus(i.y.times(e.x)),iw=(i,e)=>i.x.times(e.x).plus(i.y.times(e.y)),zf=i=>iw(i,i).sqrt(),VS=(i,e,t)=>{const r={x:e.x.minus(i.x),y:e.y.minus(i.y)},o={x:t.x.minus(i.x),y:t.y.minus(i.y)};return vf(o,r).div(zf(o)).div(zf(r))},jS=(i,e,t)=>{const r={x:e.x.minus(i.x),y:e.y.minus(i.y)},o={x:t.x.minus(i.x),y:t.y.minus(i.y)};return iw(o,r).div(zf(o)).div(zf(r))},sv=(i,e,t)=>e.y.isZero()?null:{x:i.x.plus(e.x.div(e.y).times(t.minus(i.y))),y:t},ov=(i,e,t)=>e.x.isZero()?null:{x:t,y:i.y.plus(e.y.div(e.x).times(t.minus(i.x)))},$S=(i,e,t,r)=>{if(e.x.isZero())return ov(t,r,i.x);if(r.x.isZero())return ov(i,e,t.x);if(e.y.isZero())return sv(t,r,i.y);if(r.y.isZero())return sv(i,e,t.y);const o=vf(e,r);if(o.isZero())return null;const c={x:t.x.minus(i.x),y:t.y.minus(i.y)},d=vf(c,e).div(o),a=vf(c,r).div(o),y=i.x.plus(a.times(e.x)),w=t.x.plus(d.times(r.x)),E=i.y.plus(a.times(e.y)),I=t.y.plus(d.times(r.y)),D=y.plus(w).div(2),F=E.plus(I).div(2);return{x:D,y:F}},vs=class rw{point;isLeft;segment;otherSE;consumedBy;static compare(e,t){const r=rw.comparePoints(e.point,t.point);return r!==0?r:(e.point!==t.point&&e.link(t),e.isLeft!==t.isLeft?e.isLeft?1:-1:Uf.compare(e.segment,t.segment))}static comparePoints(e,t){return e.x.isLessThan(t.x)?-1:e.x.isGreaterThan(t.x)?1:e.y.isLessThan(t.y)?-1:e.y.isGreaterThan(t.y)?1:0}constructor(e,t){e.events===void 0?e.events=[this]:e.events.push(this),this.point=e,this.isLeft=t}link(e){if(e.point===this.point)throw new Error("Tried to link already linked events");const t=e.point.events;for(let r=0,o=t.length;r<o;r++){const c=t[r];this.point.events.push(c),c.point=this.point}this.checkForConsuming()}checkForConsuming(){const e=this.point.events.length;for(let t=0;t<e;t++){const r=this.point.events[t];if(r.segment.consumedBy===void 0)for(let o=t+1;o<e;o++){const c=this.point.events[o];c.consumedBy===void 0&&r.otherSE.point.events===c.otherSE.point.events&&r.segment.consume(c.segment)}}}getAvailableLinkedEvents(){const e=[];for(let t=0,r=this.point.events.length;t<r;t++){const o=this.point.events[t];o!==this&&!o.segment.ringOut&&o.segment.isInResult()&&e.push(o)}return e}getLeftmostComparator(e){const t=new Map,r=o=>{const c=o.otherSE;t.set(o,{sine:VS(this.point,e.point,c.point),cosine:jS(this.point,e.point,c.point)})};return(o,c)=>{t.has(o)||r(o),t.has(c)||r(c);const{sine:d,cosine:a}=t.get(o),{sine:y,cosine:w}=t.get(c);return d.isGreaterThanOrEqualTo(0)&&y.isGreaterThanOrEqualTo(0)?a.isLessThan(w)?1:a.isGreaterThan(w)?-1:0:d.isLessThan(0)&&y.isLessThan(0)?a.isLessThan(w)?-1:a.isGreaterThan(w)?1:0:y.isLessThan(d)?-1:y.isGreaterThan(d)?1:0}}},WS=class Om{events;poly;_isExteriorRing;_enclosingRing;static factory(e){const t=[];for(let r=0,o=e.length;r<o;r++){const c=e[r];if(!c.isInResult()||c.ringOut)continue;let d=null,a=c.leftSE,y=c.rightSE;const w=[a],E=a.point,I=[];for(;d=a,a=y,w.push(a),a.point!==E;)for(;;){const D=a.getAvailableLinkedEvents();if(D.length===0){const oe=w[0].point,_e=w[w.length-1].point;throw new Error(`Unable to complete output ring starting at [${oe.x}, ${oe.y}]. Last matching segment found ends at [${_e.x}, ${_e.y}].`)}if(D.length===1){y=D[0].otherSE;break}let F=null;for(let oe=0,_e=I.length;oe<_e;oe++)if(I[oe].point===a.point){F=oe;break}if(F!==null){const oe=I.splice(F)[0],_e=w.splice(oe.index);_e.unshift(_e[0].otherSE),t.push(new Om(_e.reverse()));continue}I.push({index:w.length,point:a.point});const X=a.getLeftmostComparator(d);y=D.sort(X)[0].otherSE;break}t.push(new Om(w))}return t}constructor(e){this.events=e;for(let t=0,r=e.length;t<r;t++)e[t].segment.ringOut=this;this.poly=null}getGeom(){let e=this.events[0].point;const t=[e];for(let w=1,E=this.events.length-1;w<E;w++){const I=this.events[w].point,D=this.events[w+1].point;io.orient(I,e,D)!==0&&(t.push(I),e=I)}if(t.length===1)return null;const r=t[0],o=t[1];io.orient(r,e,o)===0&&t.shift(),t.push(t[0]);const c=this.isExteriorRing()?1:-1,d=this.isExteriorRing()?0:t.length-1,a=this.isExteriorRing()?t.length:-1,y=[];for(let w=d;w!=a;w+=c)y.push([t[w].x.toNumber(),t[w].y.toNumber()]);return y}isExteriorRing(){if(this._isExteriorRing===void 0){const e=this.enclosingRing();this._isExteriorRing=e?!e.isExteriorRing():!0}return this._isExteriorRing}enclosingRing(){return this._enclosingRing===void 0&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}_calcEnclosingRing(){let e=this.events[0];for(let o=1,c=this.events.length;o<c;o++){const d=this.events[o];vs.compare(e,d)>0&&(e=d)}let t=e.segment.prevInResult(),r=t?t.prevInResult():null;for(;;){if(!t)return null;if(!r)return t.ringOut;if(r.ringOut!==t.ringOut)return r.ringOut?.enclosingRing()!==t.ringOut?t.ringOut:t.ringOut?.enclosingRing();t=r.prevInResult(),r=t?t.prevInResult():null}}},av=class{exteriorRing;interiorRings;constructor(i){this.exteriorRing=i,i.poly=this,this.interiorRings=[]}addInterior(i){this.interiorRings.push(i),i.poly=this}getGeom(){const i=this.exteriorRing.getGeom();if(i===null)return null;const e=[i];for(let t=0,r=this.interiorRings.length;t<r;t++){const o=this.interiorRings[t].getGeom();o!==null&&e.push(o)}return e}},HS=class{rings;polys;constructor(i){this.rings=i,this.polys=this._composePolys(i)}getGeom(){const i=[];for(let e=0,t=this.polys.length;e<t;e++){const r=this.polys[e].getGeom();r!==null&&i.push(r)}return i}_composePolys(i){const e=[];for(let t=0,r=i.length;t<r;t++){const o=i[t];if(!o.poly)if(o.isExteriorRing())e.push(new av(o));else{const c=o.enclosingRing();c?.poly||e.push(new av(c)),c?.poly?.addInterior(o)}}return e}},ZS=class{queue;tree;segments;constructor(i,e=Uf.compare){this.queue=i,this.tree=new Nf(e),this.segments=[]}process(i){const e=i.segment,t=[];if(i.consumedBy)return i.isLeft?this.queue.delete(i.otherSE):this.tree.delete(e),t;i.isLeft&&this.tree.add(e);let r=e,o=e;do r=this.tree.lastBefore(r);while(r!=null&&r.consumedBy!=null);do o=this.tree.firstAfter(o);while(o!=null&&o.consumedBy!=null);if(i.isLeft){let c=null;if(r){const a=r.getIntersection(e);if(a!==null&&(e.isAnEndpoint(a)||(c=a),!r.isAnEndpoint(a))){const y=this._splitSafely(r,a);for(let w=0,E=y.length;w<E;w++)t.push(y[w])}}let d=null;if(o){const a=o.getIntersection(e);if(a!==null&&(e.isAnEndpoint(a)||(d=a),!o.isAnEndpoint(a))){const y=this._splitSafely(o,a);for(let w=0,E=y.length;w<E;w++)t.push(y[w])}}if(c!==null||d!==null){let a=null;c===null?a=d:d===null?a=c:a=vs.comparePoints(c,d)<=0?c:d,this.queue.delete(e.rightSE),t.push(e.rightSE);const y=e.split(a);for(let w=0,E=y.length;w<E;w++)t.push(y[w])}t.length>0?(this.tree.delete(e),t.push(i)):(this.segments.push(e),e.prev=r)}else{if(r&&o){const c=r.getIntersection(o);if(c!==null){if(!r.isAnEndpoint(c)){const d=this._splitSafely(r,c);for(let a=0,y=d.length;a<y;a++)t.push(d[a])}if(!o.isAnEndpoint(c)){const d=this._splitSafely(o,c);for(let a=0,y=d.length;a<y;a++)t.push(d[a])}}}this.tree.delete(e)}return t}_splitSafely(i,e){this.tree.delete(i);const t=i.rightSE;this.queue.delete(t);const r=i.split(e);return r.push(t),i.consumedBy===void 0&&this.tree.add(i),r}},qS=class{type;numMultiPolys;run(i,e,t){th.type=i;const r=[new cv(e,!0)];for(let w=0,E=t.length;w<E;w++)r.push(new cv(t[w],!1));if(th.numMultiPolys=r.length,th.type==="difference"){const w=r[0];let E=1;for(;E<r.length;)Dm(r[E].bbox,w.bbox)!==null?E++:r.splice(E,1)}if(th.type==="intersection")for(let w=0,E=r.length;w<E;w++){const I=r[w];for(let D=w+1,F=r.length;D<F;D++)if(Dm(I.bbox,r[D].bbox)===null)return[]}const o=new Nf(vs.compare);for(let w=0,E=r.length;w<E;w++){const I=r[w].getSweepEvents();for(let D=0,F=I.length;D<F;D++)o.add(I[D])}const c=new ZS(o);let d=null;for(o.size!=0&&(d=o.first(),o.delete(d));d;){const w=c.process(d);for(let E=0,I=w.length;E<I;E++){const D=w[E];D.consumedBy===void 0&&o.add(D)}o.size!=0?(d=o.first(),o.delete(d)):d=null}io.reset();const a=WS.factory(c.segments);return new HS(a).getGeom()}},th=new qS,Lm=th,XS=0,Uf=class bf{id;leftSE;rightSE;rings;windings;ringOut;consumedBy;prev;_prevInResult;_beforeState;_afterState;_isInResult;static compare(e,t){const r=e.leftSE.point.x,o=t.leftSE.point.x,c=e.rightSE.point.x,d=t.rightSE.point.x;if(d.isLessThan(r))return 1;if(c.isLessThan(o))return-1;const a=e.leftSE.point.y,y=t.leftSE.point.y,w=e.rightSE.point.y,E=t.rightSE.point.y;if(r.isLessThan(o)){if(y.isLessThan(a)&&y.isLessThan(w))return 1;if(y.isGreaterThan(a)&&y.isGreaterThan(w))return-1;const I=e.comparePoint(t.leftSE.point);if(I<0)return 1;if(I>0)return-1;const D=t.comparePoint(e.rightSE.point);return D!==0?D:-1}if(r.isGreaterThan(o)){if(a.isLessThan(y)&&a.isLessThan(E))return-1;if(a.isGreaterThan(y)&&a.isGreaterThan(E))return 1;const I=t.comparePoint(e.leftSE.point);if(I!==0)return I;const D=e.comparePoint(t.rightSE.point);return D<0?1:D>0?-1:1}if(a.isLessThan(y))return-1;if(a.isGreaterThan(y))return 1;if(c.isLessThan(d)){const I=t.comparePoint(e.rightSE.point);if(I!==0)return I}if(c.isGreaterThan(d)){const I=e.comparePoint(t.rightSE.point);if(I<0)return 1;if(I>0)return-1}if(!c.eq(d)){const I=w.minus(a),D=c.minus(r),F=E.minus(y),X=d.minus(o);if(I.isGreaterThan(D)&&F.isLessThan(X))return 1;if(I.isLessThan(D)&&F.isGreaterThan(X))return-1}return c.isGreaterThan(d)?1:c.isLessThan(d)||w.isLessThan(E)?-1:w.isGreaterThan(E)?1:e.id<t.id?-1:e.id>t.id?1:0}constructor(e,t,r,o){this.id=++XS,this.leftSE=e,e.segment=this,e.otherSE=t,this.rightSE=t,t.segment=this,t.otherSE=e,this.rings=r,this.windings=o}static fromRing(e,t,r){let o,c,d;const a=vs.comparePoints(e,t);if(a<0)o=e,c=t,d=1;else if(a>0)o=t,c=e,d=-1;else throw new Error(`Tried to create degenerate segment at [${e.x}, ${e.y}]`);const y=new vs(o,!0),w=new vs(c,!1);return new bf(y,w,[r],[d])}replaceRightSE(e){this.rightSE=e,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}bbox(){const e=this.leftSE.point.y,t=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:e.isLessThan(t)?e:t},ur:{x:this.rightSE.point.x,y:e.isGreaterThan(t)?e:t}}}vector(){return{x:this.rightSE.point.x.minus(this.leftSE.point.x),y:this.rightSE.point.y.minus(this.leftSE.point.y)}}isAnEndpoint(e){return e.x.eq(this.leftSE.point.x)&&e.y.eq(this.leftSE.point.y)||e.x.eq(this.rightSE.point.x)&&e.y.eq(this.rightSE.point.y)}comparePoint(e){return io.orient(this.leftSE.point,e,this.rightSE.point)}getIntersection(e){const t=this.bbox(),r=e.bbox(),o=Dm(t,r);if(o===null)return null;const c=this.leftSE.point,d=this.rightSE.point,a=e.leftSE.point,y=e.rightSE.point,w=Xu(t,a)&&this.comparePoint(a)===0,E=Xu(r,c)&&e.comparePoint(c)===0,I=Xu(t,y)&&this.comparePoint(y)===0,D=Xu(r,d)&&e.comparePoint(d)===0;if(E&&w)return D&&!I?d:!D&&I?y:null;if(E)return I&&c.x.eq(y.x)&&c.y.eq(y.y)?null:c;if(w)return D&&d.x.eq(a.x)&&d.y.eq(a.y)?null:a;if(D&&I)return null;if(D)return d;if(I)return y;const F=$S(c,this.vector(),a,e.vector());return F===null||!Xu(o,F)?null:io.snap(F)}split(e){const t=[],r=e.events!==void 0,o=new vs(e,!0),c=new vs(e,!1),d=this.rightSE;this.replaceRightSE(c),t.push(c),t.push(o);const a=new bf(o,d,this.rings.slice(),this.windings.slice());return vs.comparePoints(a.leftSE.point,a.rightSE.point)>0&&a.swapEvents(),vs.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),r&&(o.checkForConsuming(),c.checkForConsuming()),t}swapEvents(){const e=this.rightSE;this.rightSE=this.leftSE,this.leftSE=e,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(let t=0,r=this.windings.length;t<r;t++)this.windings[t]*=-1}consume(e){let t=this,r=e;for(;t.consumedBy;)t=t.consumedBy;for(;r.consumedBy;)r=r.consumedBy;const o=bf.compare(t,r);if(o!==0){if(o>0){const c=t;t=r,r=c}if(t.prev===r){const c=t;t=r,r=c}for(let c=0,d=r.rings.length;c<d;c++){const a=r.rings[c],y=r.windings[c],w=t.rings.indexOf(a);w===-1?(t.rings.push(a),t.windings.push(y)):t.windings[w]+=y}r.rings=null,r.windings=null,r.consumedBy=t,r.leftSE.consumedBy=t.leftSE,r.rightSE.consumedBy=t.rightSE}}prevInResult(){return this._prevInResult!==void 0?this._prevInResult:(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null,this._prevInResult)}beforeState(){if(this._beforeState!==void 0)return this._beforeState;if(!this.prev)this._beforeState={rings:[],windings:[],multiPolys:[]};else{const e=this.prev.consumedBy||this.prev;this._beforeState=e.afterState()}return this._beforeState}afterState(){if(this._afterState!==void 0)return this._afterState;const e=this.beforeState();this._afterState={rings:e.rings.slice(0),windings:e.windings.slice(0),multiPolys:[]};const t=this._afterState.rings,r=this._afterState.windings,o=this._afterState.multiPolys;for(let a=0,y=this.rings.length;a<y;a++){const w=this.rings[a],E=this.windings[a],I=t.indexOf(w);I===-1?(t.push(w),r.push(E)):r[I]+=E}const c=[],d=[];for(let a=0,y=t.length;a<y;a++){if(r[a]===0)continue;const w=t[a],E=w.poly;if(d.indexOf(E)===-1)if(w.isExterior)c.push(E);else{d.indexOf(E)===-1&&d.push(E);const I=c.indexOf(w.poly);I!==-1&&c.splice(I,1)}}for(let a=0,y=c.length;a<y;a++){const w=c[a].multiPoly;o.indexOf(w)===-1&&o.push(w)}return this._afterState}isInResult(){if(this.consumedBy)return!1;if(this._isInResult!==void 0)return this._isInResult;const e=this.beforeState().multiPolys,t=this.afterState().multiPolys;switch(Lm.type){case"union":{const r=e.length===0,o=t.length===0;this._isInResult=r!==o;break}case"intersection":{let r,o;e.length<t.length?(r=e.length,o=t.length):(r=t.length,o=e.length),this._isInResult=o===Lm.numMultiPolys&&r<o;break}case"xor":{const r=Math.abs(e.length-t.length);this._isInResult=r%2===1;break}case"difference":{const r=o=>o.length===1&&o[0].isSubject;this._isInResult=r(e)!==r(t);break}}return this._isInResult}},lv=class{poly;isExterior;segments;bbox;constructor(i,e,t){if(!Array.isArray(i)||i.length===0)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=e,this.isExterior=t,this.segments=[],typeof i[0][0]!="number"||typeof i[0][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");const r=io.snap({x:new Ts(i[0][0]),y:new Ts(i[0][1])});this.bbox={ll:{x:r.x,y:r.y},ur:{x:r.x,y:r.y}};let o=r;for(let c=1,d=i.length;c<d;c++){if(typeof i[c][0]!="number"||typeof i[c][1]!="number")throw new Error("Input geometry is not a valid Polygon or MultiPolygon");const a=io.snap({x:new Ts(i[c][0]),y:new Ts(i[c][1])});a.x.eq(o.x)&&a.y.eq(o.y)||(this.segments.push(Uf.fromRing(o,a,this)),a.x.isLessThan(this.bbox.ll.x)&&(this.bbox.ll.x=a.x),a.y.isLessThan(this.bbox.ll.y)&&(this.bbox.ll.y=a.y),a.x.isGreaterThan(this.bbox.ur.x)&&(this.bbox.ur.x=a.x),a.y.isGreaterThan(this.bbox.ur.y)&&(this.bbox.ur.y=a.y),o=a)}(!r.x.eq(o.x)||!r.y.eq(o.y))&&this.segments.push(Uf.fromRing(o,r,this))}getSweepEvents(){const i=[];for(let e=0,t=this.segments.length;e<t;e++){const r=this.segments[e];i.push(r.leftSE),i.push(r.rightSE)}return i}},GS=class{multiPoly;exteriorRing;interiorRings;bbox;constructor(i,e){if(!Array.isArray(i))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new lv(i[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(let t=1,r=i.length;t<r;t++){const o=new lv(i[t],this,!1);o.bbox.ll.x.isLessThan(this.bbox.ll.x)&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y.isLessThan(this.bbox.ll.y)&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x.isGreaterThan(this.bbox.ur.x)&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y.isGreaterThan(this.bbox.ur.y)&&(this.bbox.ur.y=o.bbox.ur.y),this.interiorRings.push(o)}this.multiPoly=e}getSweepEvents(){const i=this.exteriorRing.getSweepEvents();for(let e=0,t=this.interiorRings.length;e<t;e++){const r=this.interiorRings[e].getSweepEvents();for(let o=0,c=r.length;o<c;o++)i.push(r[o])}return i}},cv=class{isSubject;polys;bbox;constructor(i,e){if(!Array.isArray(i))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{typeof i[0][0][0]=="number"&&(i=[i])}catch{}this.polys=[],this.bbox={ll:{x:new Ts(Number.POSITIVE_INFINITY),y:new Ts(Number.POSITIVE_INFINITY)},ur:{x:new Ts(Number.NEGATIVE_INFINITY),y:new Ts(Number.NEGATIVE_INFINITY)}};for(let t=0,r=i.length;t<r;t++){const o=new GS(i[t],this);o.bbox.ll.x.isLessThan(this.bbox.ll.x)&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y.isLessThan(this.bbox.ll.y)&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x.isGreaterThan(this.bbox.ur.x)&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y.isGreaterThan(this.bbox.ur.y)&&(this.bbox.ur.y=o.bbox.ur.y),this.polys.push(o)}this.isSubject=e}getSweepEvents(){const i=[];for(let e=0,t=this.polys.length;e<t;e++){const r=this.polys[e].getSweepEvents();for(let o=0,c=r.length;o<c;o++)i.push(r[o])}return i}},YS=(i,...e)=>Lm.run("union",i,e);io.set;var Kd={exports:{}},uv;function KS(){if(uv)return Kd.exports;uv=1,Kd.exports=i,Kd.exports.default=i;function i(W,ee,K){K=K||2;var Ce=ee&&ee.length,je=Ce?ee[0]*K:W.length,Ge=e(W,0,je,K,!0),tt=[];if(!Ge||Ge.next===Ge.prev)return tt;var pt,bt,_t,Lt,Ut,Wt,oi;if(Ce&&(Ge=y(W,ee,Ge,K)),W.length>80*K){pt=_t=W[0],bt=Lt=W[1];for(var ei=K;ei<je;ei+=K)Ut=W[ei],Wt=W[ei+1],Ut<pt&&(pt=Ut),Wt<bt&&(bt=Wt),Ut>_t&&(_t=Ut),Wt>Lt&&(Lt=Wt);oi=Math.max(_t-pt,Lt-bt),oi=oi!==0?32767/oi:0}return r(Ge,tt,K,pt,bt,oi,0),tt}function e(W,ee,K,Ce,je){var Ge,tt;if(je===Ee(W,ee,K,Ce)>0)for(Ge=ee;Ge<K;Ge+=Ce)tt=ye(Ge,W[Ge],W[Ge+1],tt);else for(Ge=K-Ce;Ge>=ee;Ge-=Ce)tt=ye(Ge,W[Ge],W[Ge+1],tt);return tt&&ke(tt,tt.next)&&(we(tt),tt=tt.next),tt}function t(W,ee){if(!W)return W;ee||(ee=W);var K=W,Ce;do if(Ce=!1,!K.steiner&&(ke(K,K.next)||Te(K.prev,K,K.next)===0)){if(we(K),K=ee=K.prev,K===K.next)break;Ce=!0}else K=K.next;while(Ce||K!==ee);return ee}function r(W,ee,K,Ce,je,Ge,tt){if(W){!tt&&Ge&&F(W,Ce,je,Ge);for(var pt=W,bt,_t;W.prev!==W.next;){if(bt=W.prev,_t=W.next,Ge?c(W,Ce,je,Ge):o(W)){ee.push(bt.i/K|0),ee.push(W.i/K|0),ee.push(_t.i/K|0),we(W),W=_t.next,pt=_t.next;continue}if(W=_t,W===pt){tt?tt===1?(W=d(t(W),ee,K),r(W,ee,K,Ce,je,Ge,2)):tt===2&&a(W,ee,K,Ce,je,Ge):r(t(W),ee,K,Ce,je,Ge,1);break}}}}function o(W){var ee=W.prev,K=W,Ce=W.next;if(Te(ee,K,Ce)>=0)return!1;for(var je=ee.x,Ge=K.x,tt=Ce.x,pt=ee.y,bt=K.y,_t=Ce.y,Lt=je<Ge?je<tt?je:tt:Ge<tt?Ge:tt,Ut=pt<bt?pt<_t?pt:_t:bt<_t?bt:_t,Wt=je>Ge?je>tt?je:tt:Ge>tt?Ge:tt,oi=pt>bt?pt>_t?pt:_t:bt>_t?bt:_t,ei=Ce.next;ei!==ee;){if(ei.x>=Lt&&ei.x<=Wt&&ei.y>=Ut&&ei.y<=oi&&ge(je,pt,Ge,bt,tt,_t,ei.x,ei.y)&&Te(ei.prev,ei,ei.next)>=0)return!1;ei=ei.next}return!0}function c(W,ee,K,Ce){var je=W.prev,Ge=W,tt=W.next;if(Te(je,Ge,tt)>=0)return!1;for(var pt=je.x,bt=Ge.x,_t=tt.x,Lt=je.y,Ut=Ge.y,Wt=tt.y,oi=pt<bt?pt<_t?pt:_t:bt<_t?bt:_t,ei=Lt<Ut?Lt<Wt?Lt:Wt:Ut<Wt?Ut:Wt,ci=pt>bt?pt>_t?pt:_t:bt>_t?bt:_t,di=Lt>Ut?Lt>Wt?Lt:Wt:Ut>Wt?Ut:Wt,Ai=oe(oi,ei,ee,K,Ce),Yt=oe(ci,di,ee,K,Ce),kt=W.prevZ,Jt=W.nextZ;kt&&kt.z>=Ai&&Jt&&Jt.z<=Yt;){if(kt.x>=oi&&kt.x<=ci&&kt.y>=ei&&kt.y<=di&&kt!==je&&kt!==tt&&ge(pt,Lt,bt,Ut,_t,Wt,kt.x,kt.y)&&Te(kt.prev,kt,kt.next)>=0||(kt=kt.prevZ,Jt.x>=oi&&Jt.x<=ci&&Jt.y>=ei&&Jt.y<=di&&Jt!==je&&Jt!==tt&&ge(pt,Lt,bt,Ut,_t,Wt,Jt.x,Jt.y)&&Te(Jt.prev,Jt,Jt.next)>=0))return!1;Jt=Jt.nextZ}for(;kt&&kt.z>=Ai;){if(kt.x>=oi&&kt.x<=ci&&kt.y>=ei&&kt.y<=di&&kt!==je&&kt!==tt&&ge(pt,Lt,bt,Ut,_t,Wt,kt.x,kt.y)&&Te(kt.prev,kt,kt.next)>=0)return!1;kt=kt.prevZ}for(;Jt&&Jt.z<=Yt;){if(Jt.x>=oi&&Jt.x<=ci&&Jt.y>=ei&&Jt.y<=di&&Jt!==je&&Jt!==tt&&ge(pt,Lt,bt,Ut,_t,Wt,Jt.x,Jt.y)&&Te(Jt.prev,Jt,Jt.next)>=0)return!1;Jt=Jt.nextZ}return!0}function d(W,ee,K){var Ce=W;do{var je=Ce.prev,Ge=Ce.next.next;!ke(je,Ge)&&Je(je,Ce,Ce.next,Ge)&&J(je,Ge)&&J(Ge,je)&&(ee.push(je.i/K|0),ee.push(Ce.i/K|0),ee.push(Ge.i/K|0),we(Ce),we(Ce.next),Ce=W=Ge),Ce=Ce.next}while(Ce!==W);return t(Ce)}function a(W,ee,K,Ce,je,Ge){var tt=W;do{for(var pt=tt.next.next;pt!==tt.prev;){if(tt.i!==pt.i&&fe(tt,pt)){var bt=be(tt,pt);tt=t(tt,tt.next),bt=t(bt,bt.next),r(tt,ee,K,Ce,je,Ge,0),r(bt,ee,K,Ce,je,Ge,0);return}pt=pt.next}tt=tt.next}while(tt!==W)}function y(W,ee,K,Ce){var je=[],Ge,tt,pt,bt,_t;for(Ge=0,tt=ee.length;Ge<tt;Ge++)pt=ee[Ge]*Ce,bt=Ge<tt-1?ee[Ge+1]*Ce:W.length,_t=e(W,pt,bt,Ce,!1),_t===_t.next&&(_t.steiner=!0),je.push(_e(_t));for(je.sort(w),Ge=0;Ge<je.length;Ge++)K=E(je[Ge],K);return K}function w(W,ee){return W.x-ee.x}function E(W,ee){var K=I(W,ee);if(!K)return ee;var Ce=be(K,W);return t(Ce,Ce.next),t(K,K.next)}function I(W,ee){var K=ee,Ce=W.x,je=W.y,Ge=-1/0,tt;do{if(je<=K.y&&je>=K.next.y&&K.next.y!==K.y){var pt=K.x+(je-K.y)*(K.next.x-K.x)/(K.next.y-K.y);if(pt<=Ce&&pt>Ge&&(Ge=pt,tt=K.x<K.next.x?K:K.next,pt===Ce))return tt}K=K.next}while(K!==ee);if(!tt)return null;var bt=tt,_t=tt.x,Lt=tt.y,Ut=1/0,Wt;K=tt;do Ce>=K.x&&K.x>=_t&&Ce!==K.x&&ge(je<Lt?Ce:Ge,je,_t,Lt,je<Lt?Ge:Ce,je,K.x,K.y)&&(Wt=Math.abs(je-K.y)/(Ce-K.x),J(K,W)&&(Wt<Ut||Wt===Ut&&(K.x>tt.x||K.x===tt.x&&D(tt,K)))&&(tt=K,Ut=Wt)),K=K.next;while(K!==bt);return tt}function D(W,ee){return Te(W.prev,W,ee.prev)<0&&Te(ee.next,W,W.next)<0}function F(W,ee,K,Ce){var je=W;do je.z===0&&(je.z=oe(je.x,je.y,ee,K,Ce)),je.prevZ=je.prev,je.nextZ=je.next,je=je.next;while(je!==W);je.prevZ.nextZ=null,je.prevZ=null,X(je)}function X(W){var ee,K,Ce,je,Ge,tt,pt,bt,_t=1;do{for(K=W,W=null,Ge=null,tt=0;K;){for(tt++,Ce=K,pt=0,ee=0;ee<_t&&(pt++,Ce=Ce.nextZ,!!Ce);ee++);for(bt=_t;pt>0||bt>0&&Ce;)pt!==0&&(bt===0||!Ce||K.z<=Ce.z)?(je=K,K=K.nextZ,pt--):(je=Ce,Ce=Ce.nextZ,bt--),Ge?Ge.nextZ=je:W=je,je.prevZ=Ge,Ge=je;K=Ce}Ge.nextZ=null,_t*=2}while(tt>1);return W}function oe(W,ee,K,Ce,je){return W=(W-K)*je|0,ee=(ee-Ce)*je|0,W=(W|W<<8)&16711935,W=(W|W<<4)&252645135,W=(W|W<<2)&858993459,W=(W|W<<1)&1431655765,ee=(ee|ee<<8)&16711935,ee=(ee|ee<<4)&252645135,ee=(ee|ee<<2)&858993459,ee=(ee|ee<<1)&1431655765,W|ee<<1}function _e(W){var ee=W,K=W;do(ee.x<K.x||ee.x===K.x&&ee.y<K.y)&&(K=ee),ee=ee.next;while(ee!==W);return K}function ge(W,ee,K,Ce,je,Ge,tt,pt){return(je-tt)*(ee-pt)>=(W-tt)*(Ge-pt)&&(W-tt)*(Ce-pt)>=(K-tt)*(ee-pt)&&(K-tt)*(Ge-pt)>=(je-tt)*(Ce-pt)}function fe(W,ee){return W.next.i!==ee.i&&W.prev.i!==ee.i&&!G(W,ee)&&(J(W,ee)&&J(ee,W)&&ae(W,ee)&&(Te(W.prev,W,ee.prev)||Te(W,ee.prev,ee))||ke(W,ee)&&Te(W.prev,W,W.next)>0&&Te(ee.prev,ee,ee.next)>0)}function Te(W,ee,K){return(ee.y-W.y)*(K.x-ee.x)-(ee.x-W.x)*(K.y-ee.y)}function ke(W,ee){return W.x===ee.x&&W.y===ee.y}function Je(W,ee,K,Ce){var je=mt(Te(W,ee,K)),Ge=mt(Te(W,ee,Ce)),tt=mt(Te(K,Ce,W)),pt=mt(Te(K,Ce,ee));return!!(je!==Ge&&tt!==pt||je===0&&Xe(W,K,ee)||Ge===0&&Xe(W,Ce,ee)||tt===0&&Xe(K,W,Ce)||pt===0&&Xe(K,ee,Ce))}function Xe(W,ee,K){return ee.x<=Math.max(W.x,K.x)&&ee.x>=Math.min(W.x,K.x)&&ee.y<=Math.max(W.y,K.y)&&ee.y>=Math.min(W.y,K.y)}function mt(W){return W>0?1:W<0?-1:0}function G(W,ee){var K=W;do{if(K.i!==W.i&&K.next.i!==W.i&&K.i!==ee.i&&K.next.i!==ee.i&&Je(K,K.next,W,ee))return!0;K=K.next}while(K!==W);return!1}function J(W,ee){return Te(W.prev,W,W.next)<0?Te(W,ee,W.next)>=0&&Te(W,W.prev,ee)>=0:Te(W,ee,W.prev)<0||Te(W,W.next,ee)<0}function ae(W,ee){var K=W,Ce=!1,je=(W.x+ee.x)/2,Ge=(W.y+ee.y)/2;do K.y>Ge!=K.next.y>Ge&&K.next.y!==K.y&&je<(K.next.x-K.x)*(Ge-K.y)/(K.next.y-K.y)+K.x&&(Ce=!Ce),K=K.next;while(K!==W);return Ce}function be(W,ee){var K=new Se(W.i,W.x,W.y),Ce=new Se(ee.i,ee.x,ee.y),je=W.next,Ge=ee.prev;return W.next=ee,ee.prev=W,K.next=je,je.prev=K,Ce.next=K,K.prev=Ce,Ge.next=Ce,Ce.prev=Ge,Ce}function ye(W,ee,K,Ce){var je=new Se(W,ee,K);return Ce?(je.next=Ce.next,je.prev=Ce,Ce.next.prev=je,Ce.next=je):(je.prev=je,je.next=je),je}function we(W){W.next.prev=W.prev,W.prev.next=W.next,W.prevZ&&(W.prevZ.nextZ=W.nextZ),W.nextZ&&(W.nextZ.prevZ=W.prevZ)}function Se(W,ee,K){this.i=W,this.x=ee,this.y=K,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}i.deviation=function(W,ee,K,Ce){var je=ee&&ee.length,Ge=je?ee[0]*K:W.length,tt=Math.abs(Ee(W,0,Ge,K));if(je)for(var pt=0,bt=ee.length;pt<bt;pt++){var _t=ee[pt]*K,Lt=pt<bt-1?ee[pt+1]*K:W.length;tt-=Math.abs(Ee(W,_t,Lt,K))}var Ut=0;for(pt=0;pt<Ce.length;pt+=3){var Wt=Ce[pt]*K,oi=Ce[pt+1]*K,ei=Ce[pt+2]*K;Ut+=Math.abs((W[Wt]-W[ei])*(W[oi+1]-W[Wt+1])-(W[Wt]-W[oi])*(W[ei+1]-W[Wt+1]))}return tt===0&&Ut===0?0:Math.abs((Ut-tt)/tt)};function Ee(W,ee,K,Ce){for(var je=0,Ge=ee,tt=K-Ce;Ge<K;Ge+=Ce)je+=(W[tt]-W[Ge])*(W[Ge+1]+W[tt+1]),tt=Ge;return je}return i.flatten=function(W){for(var ee=W[0][0].length,K={vertices:[],holes:[],dimensions:ee},Ce=0,je=0;je<W.length;je++){for(var Ge=0;Ge<W[je].length;Ge++)for(var tt=0;tt<ee;tt++)K.vertices.push(W[je][Ge][tt]);je>0&&(Ce+=W[je-1].length,K.holes.push(Ce))}return K},Kd.exports}var JS=KS();const QS=Y0(JS);function eE(i,e={}){const t=[];if(MS(i,o=>{t.push(o.coordinates)}),t.length<2)throw new Error("Must have at least 2 geometries");const r=YS(t[0],...t.slice(1));return r.length===0?null:r.length===1?PS(r[0],e.properties):IS(r,e.properties)}function tE(i){if(!i||!Array.isArray(i.features))return console.error("Invalid GeoJSON data structure"),[];const e={};i.features.forEach(r=>{if(!r||!r.properties)return;const o=r.properties.boro_cd;o&&(e[o]||(e[o]=[]),e[o].push(r))});const t=[];return Object.entries(e).forEach(([r,o])=>{try{if(!o||o.length===0)return;let c=o[0];for(let a=1;a<o.length;a++)try{c=eE(c,o[a])}catch(y){console.warn(`Error unioning features for CD ${r}:`,y)}if(!c||!c.geometry)return;let d;try{if(c.geometry.type==="Polygon"){const a=c.geometry.coordinates[0];if(!Array.isArray(a))return;d=iv(a)}else if(c.geometry.type==="MultiPolygon"){const a=c.geometry.coordinates.filter(w=>Array.isArray(w)&&w.length>0&&Array.isArray(w[0]));if(a.length===0)return;const y=a.map(w=>iv(w[0]));d=CS(y.map(w=>w.geometry.coordinates))}else return;d.properties={cdCode:r},t.push(d)}catch(a){console.error(`Error creating perimeter for CD ${r}:`,a)}}catch(c){console.error(`Error processing perimeter for CD ${r}:`,c)}}),t}function iE(i){let e=1/0,t=1/0,r=-1/0,o=-1/0;const c=d=>{Array.isArray(d[0])&&typeof d[0][0]!="number"?d.forEach(c):Array.isArray(d[0])&&d.forEach(a=>{e=Math.min(e,a[0]),r=Math.max(r,a[0]),t=Math.min(t,a[1]),o=Math.max(o,a[1])})};return c(i.geometry.coordinates),{minLng:e,minLat:t,maxLng:r,maxLat:o}}class rE{constructor(){this.handlers={},this._isReady=!1,this.setupGlobalHandler()}setupGlobalHandler(){typeof window<"u"&&window.removeEventListener("navigateToCD",this._navigationHandler),this._navigationHandler=e=>{const{mapId:t,cdCode:r}=e.detail||{};if(t&&typeof document<"u"&&!document.getElementById(`map-container-${t}`)){console.log(`MapEventManager: Ignoring event for non-existent map: ${t}`);return}t&&r&&this.handlers[t]?(console.log(`MapEventManager: Navigation to CD ${r} on map ${t}`),this.handlers[t](r)):(t||console.warn("MapEventManager: Missing mapId in event"),r||console.warn("MapEventManager: Missing cdCode in event"),t&&!this.handlers[t]&&console.warn(`MapEventManager: No handler for ${t}`))},typeof window<"u"&&(window.addEventListener("navigateToCD",this._navigationHandler),window.MapEventManager=this,document.addEventListener("DOMContentLoaded",()=>{console.log("MapEventManager: Ready to handle map navigation events"),this._isReady=!0}))}registerNavigationHandler(e,t){return!e||!t?(console.warn("MapEventManager: Invalid registration parameters"),!1):(this.handlers[e]=t,console.log(`MapEventManager: Registered handler for map ${e}`),!0)}unregisterNavigationHandler(e){this.handlers[e]&&(delete this.handlers[e],console.log(`MapEventManager: Unregistered handler for map ${e}`))}cleanup(){typeof window<"u"&&window.removeEventListener("navigateToCD",this._navigationHandler),this.handlers={},this._isReady=!1}navigateToCdProject(e,t){if(!e||!t||!t[e])return console.warn(`MapEventManager: Cannot navigate to CD project: missing slug for ${e}`),!1;try{const r=t[e],c=(()=>{if(typeof import.meta<"u")return"/";if(typeof document<"u"){const d=document.querySelector("base");if(d&&d.href)try{const w=new URL(d.href).pathname.split("/").filter(Boolean);if(w.length>0)return`/${w.join("/")}`}catch(y){console.warn("Error parsing base URL:",y)}const a=document.querySelector("script[data-astro-repo-base]");if(a&&a.dataset.astroRepoBase)return a.dataset.astroRepoBase}return"/"})();return console.log(`MapEventManager: Navigating to CD project ${e} (${r}) at ${c}/projects/${r}`),window.location.href=`${c}/projects/${r}`,!0}catch(r){return console.error(`MapEventManager: Error navigating to CD project ${e}:`,r),!1}}}const hv=new rE;function Vf(i,e){if(!i)throw new Error(e||"loader assertion failed.")}const y_=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),dv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);dv&&parseFloat(dv[1]);const fv=globalThis,pv=globalThis.process||{},nE=globalThis.navigator||{};function nw(i){if(typeof window<"u"&&window.process?.type==="renderer"||typeof process<"u"&&process.versions?.electron)return!0;const t=typeof navigator<"u"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function ja(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process?.browser)||nw()}function sE(i){return ja()?nw()?"Electron":(nE.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node"}const sw="4.1.0";function oE(i){try{const e=window[i],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class aE{constructor(e,t,r="sessionStorage"){this.storage=oE(r),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function lE(i){let e;return i<10?e=`${i.toFixed(2)}ms`:i<100?e=`${i.toFixed(1)}ms`:i<1e3?e=`${i.toFixed(0)}ms`:e=`${(i/1e3).toFixed(2)}s`,e}function cE(i,e=8){const t=Math.max(e-i.length,0);return`${" ".repeat(t)}${i}`}var jf;(function(i){i[i.BLACK=30]="BLACK",i[i.RED=31]="RED",i[i.GREEN=32]="GREEN",i[i.YELLOW=33]="YELLOW",i[i.BLUE=34]="BLUE",i[i.MAGENTA=35]="MAGENTA",i[i.CYAN=36]="CYAN",i[i.WHITE=37]="WHITE",i[i.BRIGHT_BLACK=90]="BRIGHT_BLACK",i[i.BRIGHT_RED=91]="BRIGHT_RED",i[i.BRIGHT_GREEN=92]="BRIGHT_GREEN",i[i.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",i[i.BRIGHT_BLUE=94]="BRIGHT_BLUE",i[i.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",i[i.BRIGHT_CYAN=96]="BRIGHT_CYAN",i[i.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(jf||(jf={}));const uE=10;function gv(i){return typeof i!="string"?i:(i=i.toUpperCase(),jf[i]||jf.WHITE)}function hE(i,e,t){return!ja&&typeof i=="string"&&(e&&(i=`\x1B[${gv(e)}m${i}\x1B[39m`),t&&(i=`\x1B[${gv(t)+uE}m${i}\x1B[49m`)),i}function dE(i,e=["constructor"]){const t=Object.getPrototypeOf(i),r=Object.getOwnPropertyNames(t),o=i;for(const c of r){const d=o[c];typeof d=="function"&&(e.find(a=>c===a)||(o[c]=d.bind(i)))}}function x_(i,e){if(!i)throw new Error("Assertion failed")}function Kl(){let i;if(ja()&&fv.performance)i=fv?.performance?.now?.();else if("hrtime"in pv){const e=pv?.hrtime?.();i=e[0]*1e3+e[1]/1e6}else i=Date.now();return i}const Jl={debug:ja()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},fE={enabled:!0,level:0};function Ql(){}const mv={},_v={once:!0};class Mh{constructor({id:e}={id:""}){this.VERSION=sw,this._startTs=Kl(),this._deltaTs=Kl(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new aE(`__probe-${this.id}__`,fE),this.timeStamp(`${this.id} started`),dE(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Kl()-this._startTs).toPrecision(10))}getDelta(){return Number((Kl()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,Jl.warn,arguments,_v)}error(e){return this._getLogFunction(0,e,Jl.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,Jl.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,Jl.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,Jl.debug||Jl.info,arguments,_v)}table(e,t,r){return t?this._getLogFunction(e,t,console.table||Ql,r&&[r],{tag:gE(t)}):Ql}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Ql)}group(e,t,r={collapsed:!1}){const o=yv({logLevel:e,message:t,opts:r}),{collapsed:c}=r;return o.method=(c?console.groupCollapsed:console.group)||console.info,this._getLogFunction(o)}groupCollapsed(e,t,r={}){return this.group(e,t,Object.assign({},r,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Ql)}withGroup(e,t,r){this.group(e,t)();try{r()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=ow(e)}_getLogFunction(e,t,r,o,c){if(this._shouldLog(e)){c=yv({logLevel:e,message:t,args:o,opts:c}),r=r||c.method,x_(r),c.total=this.getTotal(),c.delta=this.getDelta(),this._deltaTs=Kl();const d=c.tag||c.message;if(c.once&&d)if(!mv[d])mv[d]=Kl();else return Ql;return t=pE(this.id,c.message,c),r.bind(console,t,...c.args)}return Ql}}Mh.VERSION=sw;function ow(i){if(!i)return 0;let e;switch(typeof i){case"number":e=i;break;case"object":e=i.logLevel||i.priority||0;break;default:return 0}return x_(Number.isFinite(e)&&e>=0),e}function yv(i){const{logLevel:e,message:t}=i;i.logLevel=ow(e);const r=i.args?Array.from(i.args):[];for(;r.length&&r.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&r.unshift(t),i.message=e;break;case"object":Object.assign(i,e);break}typeof i.message=="function"&&(i.message=i.message());const o=typeof i.message;return x_(o==="string"||o==="object"),Object.assign(i,{args:r},i.opts)}function pE(i,e,t){if(typeof e=="string"){const r=t.time?cE(lE(t.total)):"";e=t.time?`${i}: ${r}  ${e}`:`${i}: ${e}`,e=hE(e,t.color,t.background)}return e}function gE(i){for(const e in i)for(const t in i[e])return t||"untitled";return"empty"}const zg="4.3.3",mE=zg[0]>="0"&&zg[0]<="9"?`v${zg}`:"";function _E(){const i=new Mh({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=i,globalThis.loaders.version=mE,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=i,i}const yE=_E();function xE(i,e){return aw(i||{},e)}function aw(i,e,t=0){if(t>3)return e;const r={...i};for(const[o,c]of Object.entries(e))c&&typeof c=="object"&&!Array.isArray(c)?r[o]=aw(r[o]||{},e[o],t+1):r[o]=e[o];return r}const vE="latest";function bE(){return globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version}const wE=bE();function Zo(i,e){if(!i)throw new Error(e||"loaders.gl assertion failed.")}const Ma=typeof process!="object"||String(process)!=="[object process]"||process.browser,TE=typeof window<"u"&&typeof window.orientation<"u",xv=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);xv&&parseFloat(xv[1]);class SE{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,t){this.name=e,this.workerThread=t,this.result=new Promise((r,o)=>{this._resolve=r,this._reject=o})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Zo(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Zo(this.isRunning),this.isRunning=!1,this._reject(e)}}class Ug{terminate(){}}const Vg=new Map;function EE(i){Zo(i.source&&!i.url||!i.source&&i.url);let e=Vg.get(i.source||i.url);return e||(i.url&&(e=AE(i.url),Vg.set(i.url,e)),i.source&&(e=lw(i.source),Vg.set(i.source,e))),Zo(e),e}function AE(i){if(!i.startsWith("http"))return i;const e=PE(i);return lw(e)}function lw(i){const e=new Blob([i],{type:"application/javascript"});return URL.createObjectURL(e)}function PE(i){return`try {
  importScripts('${i}');
} catch (error) {
  console.error(error);
  throw error;
}`}function cw(i,e=!0,t){const r=t||new Set;if(i){if(vv(i))r.add(i);else if(vv(i.buffer))r.add(i.buffer);else if(!ArrayBuffer.isView(i)){if(e&&typeof i=="object")for(const o in i)cw(i[o],e,r)}}return t===void 0?Array.from(r):[]}function vv(i){return i?i instanceof ArrayBuffer||typeof MessagePort<"u"&&i instanceof MessagePort||typeof ImageBitmap<"u"&&i instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas:!1}const jg=()=>{};class Fm{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return typeof Worker<"u"&&Ma||typeof Ug<"u"&&!Ma}constructor(e){const{name:t,source:r,url:o}=e;Zo(r||o),this.name=t,this.source=r,this.url=o,this.onMessage=jg,this.onError=c=>console.log(c),this.worker=Ma?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=jg,this.onError=jg,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||cw(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=EE({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const r=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Ug(r,{eval:!1})}else if(this.source)e=new Ug(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class CE{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return Fm.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(o,c,d)=>o.done(d),r=(o,c)=>o.error(c)){const o=new Promise(c=>(this.jobQueue.push({name:e,onMessage:t,onError:r,onStart:c}),this));return this._startQueuedJob(),await o}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const r=new SE(t.name,e);e.onMessage=o=>t.onMessage(r,o.type,o.payload),e.onError=o=>t.onError(r,o),t.onStart(r);try{await r.result}catch(o){console.error(`Worker exception: ${o}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!Ma||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new Fm({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return TE?this.maxMobileConcurrency:this.maxConcurrency}}const IE={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class zo{props;workerPools=new Map;static _workerFarm;static isSupported(){return Fm.isSupported()}static getWorkerFarm(e={}){return zo._workerFarm=zo._workerFarm||new zo({}),zo._workerFarm.setProps(e),zo._workerFarm}constructor(e){this.props={...IE},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:r,url:o}=e;let c=this.workerPools.get(t);return c||(c=new CE({name:t,source:r,url:o}),c.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,c)),c}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}function ME(i,e={}){const t=e[i.id]||{},r=Ma?`${i.id}-worker.js`:`${i.id}-worker-node.js`;let o=t.workerUrl;if(!o&&i.id==="compression"&&(o=e.workerUrl),e._workerType==="test"&&(Ma?o=`modules/${i.module}/dist/${r}`:o=`modules/${i.module}/src/workers/${i.id}-worker-node.ts`),!o){let c=i.version;c==="latest"&&(c=vE);const d=c?`@${c}`:"";o=`https://unpkg.com/@loaders.gl/${i.module}${d}/dist/${r}`}return Zo(o),o}function RE(i,e=wE){Zo(i,"no worker provided");const t=i.version;return!(!e||!t)}function kE(i,e){return!zo.isSupported()||!Ma&&!e?._nodeWorkers?!1:i.worker&&e?.worker}async function DE(i,e,t,r,o){const c=i.id,d=ME(i,t),y=zo.getWorkerFarm(t).getWorkerPool({name:c,url:d});t=JSON.parse(JSON.stringify(t)),r=JSON.parse(JSON.stringify(r||{}));const w=await y.startJob("process-on-worker",OE.bind(null,o));return w.postMessage("process",{input:e,options:t,context:r}),await(await w.result).result}async function OE(i,e,t,r){switch(t){case"done":e.done(r);break;case"error":e.error(new Error(r.error));break;case"process":const{id:o,input:c,options:d}=r;try{const a=await i(c,d);e.postMessage("done",{id:o,result:a})}catch(a){const y=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:o,error:y})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function LE(i,e,t){if(t=t||i.byteLength,i.byteLength<t||e.byteLength<t)return!1;const r=new Uint8Array(i),o=new Uint8Array(e);for(let c=0;c<r.length;++c)if(r[c]!==o[c])return!1;return!0}function FE(...i){return BE(i)}function BE(i){const e=i.map(c=>c instanceof ArrayBuffer?new Uint8Array(c):c),t=e.reduce((c,d)=>c+d.byteLength,0),r=new Uint8Array(t);let o=0;for(const c of e)r.set(c,o),o+=c.byteLength;return r.buffer}async function NE(i){const e=[];for await(const t of i)e.push(t);return FE(...e)}function bv(){let i;if(typeof window<"u"&&window.performance)i=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();i=e[0]*1e3+e[1]/1e6}else i=Date.now();return i}class wv{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=bv(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(bv()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class hp{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(t=>this._getOrCreate(t))}_getOrCreate(e){const{name:t,type:r}=e;let o=this.stats[t];return o||(e instanceof wv?o=e:o=new wv(t,r),this.stats[t]=o),o}}let zE="";const Tv={};function UE(i){for(const e in Tv)if(i.startsWith(e)){const t=Tv[e];i=i.replace(e,t)}return!i.startsWith("http://")&&!i.startsWith("https://")&&(i=`${zE}${i}`),i}function VE(i){return i&&typeof i=="object"&&i.isBuffer}function uw(i){if(VE(i))return i;if(i instanceof ArrayBuffer)return i;if(ArrayBuffer.isView(i))return i.byteOffset===0&&i.byteLength===i.buffer.byteLength?i.buffer:i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength);if(typeof i=="string"){const e=i;return new TextEncoder().encode(e).buffer}if(i&&typeof i=="object"&&i._toArrayBuffer)return i._toArrayBuffer();throw new Error("toArrayBuffer")}function hw(i){const e=i?i.lastIndexOf("/"):-1;return e>=0?i.substr(e+1):""}function jE(i){const e=i?i.lastIndexOf("/"):-1;return e>=0?i.substr(0,e):""}const $E=i=>typeof i=="boolean",lh=i=>typeof i=="function",Rh=i=>i!==null&&typeof i=="object",Sv=i=>Rh(i)&&i.constructor==={}.constructor,WE=i=>!!i&&typeof i[Symbol.iterator]=="function",HE=i=>i&&typeof i[Symbol.asyncIterator]=="function",$a=i=>typeof Response<"u"&&i instanceof Response||i&&i.arrayBuffer&&i.text&&i.json,Wa=i=>typeof Blob<"u"&&i instanceof Blob,ZE=i=>i&&typeof i=="object"&&i.isBuffer,qE=i=>typeof ReadableStream<"u"&&i instanceof ReadableStream||Rh(i)&&lh(i.tee)&&lh(i.cancel)&&lh(i.getReader),XE=i=>Rh(i)&&lh(i.read)&&lh(i.pipe)&&$E(i.readable),dw=i=>qE(i)||XE(i);class GE extends Error{constructor(e,t){super(e),this.reason=t.reason,this.url=t.url,this.response=t.response}reason;url;response}const YE=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,KE=/^([-\w.]+\/[-\w.+]+)/;function Ev(i,e){return i.toLowerCase()===e.toLowerCase()}function JE(i){const e=KE.exec(i);return e?e[1]:i}function Av(i){const e=YE.exec(i);return e?e[1]:""}const fw=/\?.*/;function QE(i){const e=i.match(fw);return e&&e[0]}function v_(i){return i.replace(fw,"")}function eA(i){if(i.length<50)return i;const e=i.slice(i.length-15);return`${i.substr(0,32)}...${e}`}function dp(i){return $a(i)?i.url:Wa(i)?i.name||"":typeof i=="string"?i:""}function b_(i){if($a(i)){const e=i,t=e.headers.get("content-type")||"",r=v_(e.url);return JE(t)||Av(r)}return Wa(i)?i.type||"":typeof i=="string"?Av(i):""}function tA(i){return $a(i)?i.headers["content-length"]||-1:Wa(i)?i.size:typeof i=="string"?i.length:i instanceof ArrayBuffer||ArrayBuffer.isView(i)?i.byteLength:-1}async function pw(i){if($a(i))return i;const e={},t=tA(i);t>=0&&(e["content-length"]=String(t));const r=dp(i),o=b_(i);o&&(e["content-type"]=o);const c=await nA(i);c&&(e["x-first-bytes"]=c),typeof i=="string"&&(i=new TextEncoder().encode(i));const d=new Response(i,{headers:e});return Object.defineProperty(d,"url",{value:r}),d}async function iA(i){if(!i.ok)throw await rA(i)}async function rA(i){const e=eA(i.url);let t=`Failed to fetch resource (${i.status}) ${i.statusText}: ${e}`;t=t.length>100?`${t.slice(0,100)}...`:t;const r={reason:i.statusText,url:i.url,response:i};try{const o=i.headers.get("Content-Type");r.reason=!i.bodyUsed&&o?.includes("application/json")?await i.json():await i.text()}catch{}return new GE(t,r)}async function nA(i){if(typeof i=="string")return`data:,${i.slice(0,5)}`;if(i instanceof Blob){const t=i.slice(0,5);return await new Promise(r=>{const o=new FileReader;o.onload=c=>r(c?.target?.result),o.readAsDataURL(t)})}if(i instanceof ArrayBuffer){const t=i.slice(0,5);return`data:base64,${sA(t)}`}return null}function sA(i){let e="";const t=new Uint8Array(i);for(let r=0;r<t.byteLength;r++)e+=String.fromCharCode(t[r]);return btoa(e)}function oA(i){return!aA(i)&&!lA(i)}function aA(i){return i.startsWith("http:")||i.startsWith("https:")}function lA(i){return i.startsWith("data:")}async function Pv(i,e){if(typeof i=="string"){const t=UE(i);return oA(t)&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(t,e):await fetch(t,e)}return await pw(i)}const Cv=new Mh({id:"loaders.gl"});class cA{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class uA{console;constructor(){this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const gw={fetch:null,mimeType:void 0,nothrow:!1,log:new uA,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:y_,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},hA={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function mw(){globalThis.loaders=globalThis.loaders||{};const{loaders:i}=globalThis;return i._state||(i._state={}),i._state}function _w(){const i=mw();return i.globalOptions=i.globalOptions||{...gw},i.globalOptions}function dA(i,e,t,r){return t=t||[],t=Array.isArray(t)?t:[t],fA(i,t),gA(e,i,r)}function fA(i,e){Iv(i,null,gw,hA,e);for(const t of e){const r=i&&i[t.id]||{},o=t.options&&t.options[t.id]||{},c=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Iv(r,t.id,o,c,e)}}function Iv(i,e,t,r,o){const c=e||"Top level",d=e?`${e}.`:"";for(const a in i){const y=!e&&Rh(i[a]),w=a==="baseUri"&&!e,E=a==="workerUrl"&&e;if(!(a in t)&&!w&&!E){if(a in r)Cv.warn(`${c} loader option '${d}${a}' no longer supported, use '${r[a]}'`)();else if(!y){const I=pA(a,o);Cv.warn(`${c} loader option '${d}${a}' not recognized. ${I}`)()}}}}function pA(i,e){const t=i.toLowerCase();let r="";for(const o of e)for(const c in o.options){if(i===c)return`Did you mean '${o.id}.${c}'?`;const d=c.toLowerCase();(t.startsWith(d)||d.startsWith(t))&&(r=r||`Did you mean '${o.id}.${c}'?`)}return r}function gA(i,e,t){const o={...i.options||{}};return mA(o,t),o.log===null&&(o.log=new cA),Mv(o,_w()),Mv(o,e),o}function Mv(i,e){for(const t in e)if(t in e){const r=e[t];Sv(r)&&Sv(i[t])?i[t]={...i[t],...e[t]}:i[t]=e[t]}}function mA(i,e){e&&!("baseUri"in i)&&(i.baseUri=e)}function w_(i){return i?(Array.isArray(i)&&(i=i[0]),Array.isArray(i?.extensions)):!1}function T_(i){Vf(i,"null loader"),Vf(w_(i),"invalid loader");let e;return Array.isArray(i)&&(e=i[1],i=i[0],i={...i,options:{...i.options,...e}}),(i?.parseTextSync||i?.parseText)&&(i.text=!0),i.text||(i.binary=!0),i}const yw=()=>{const i=mw();return i.loaderRegistry=i.loaderRegistry||[],i.loaderRegistry};function _A(i){const e=yw();i=Array.isArray(i)?i:[i];for(const t of i){const r=T_(t);e.find(o=>r===o)||e.unshift(r)}}function yA(){return yw()}const xA=/\.([^.]+)$/;async function vA(i,e=[],t,r){if(!xw(i))return null;let o=Rv(i,e,{...t,nothrow:!0},r);if(o)return o;if(Wa(i)&&(i=await i.slice(0,10).arrayBuffer(),o=Rv(i,e,t,r)),!o&&!t?.nothrow)throw new Error(vw(i));return o}function Rv(i,e=[],t,r){if(!xw(i))return null;if(e&&!Array.isArray(e))return T_(e);let o=[];e&&(o=o.concat(e)),t?.ignoreRegisteredLoaders||o.push(...yA()),wA(o);const c=bA(i,o,t,r);if(!c&&!t?.nothrow)throw new Error(vw(i));return c}function bA(i,e,t,r){const o=dp(i),c=b_(i),d=v_(o)||r?.url;let a=null,y="";return t?.mimeType&&(a=$g(e,t?.mimeType),y=`match forced by supplied MIME type ${t?.mimeType}`),a=a||TA(e,d),y=y||(a?`matched url ${d}`:""),a=a||$g(e,c),y=y||(a?`matched MIME type ${c}`:""),a=a||EA(e,i),y=y||(a?`matched initial data ${bw(i)}`:""),t?.fallbackMimeType&&(a=a||$g(e,t?.fallbackMimeType),y=y||(a?`matched fallback MIME type ${c}`:"")),y&&yE.log(1,`selectLoader selected ${a?.name}: ${y}.`),a}function xw(i){return!(i instanceof Response&&i.status===204)}function vw(i){const e=dp(i),t=b_(i);let r="No valid loader found (";r+=e?`${hw(e)}, `:"no url provided, ",r+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const o=i?bw(i):"";return r+=o?` first bytes: "${o}"`:"first bytes: not available",r+=")",r}function wA(i){for(const e of i)T_(e)}function TA(i,e){const t=e&&xA.exec(e),r=t&&t[1];return r?SA(i,r):null}function SA(i,e){e=e.toLowerCase();for(const t of i)for(const r of t.extensions)if(r.toLowerCase()===e)return t;return null}function $g(i,e){for(const t of i)if(t.mimeTypes?.some(r=>Ev(e,r))||Ev(e,`application/x.${t.id}`))return t;return null}function EA(i,e){if(!e)return null;for(const t of i)if(typeof e=="string"){if(AA(e,t))return t}else if(ArrayBuffer.isView(e)){if(kv(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&kv(e,0,t))return t;return null}function AA(i,e){return e.testText?e.testText(i):(Array.isArray(e.tests)?e.tests:[e.tests]).some(r=>i.startsWith(r))}function kv(i,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(o=>PA(i,e,t,o))}function PA(i,e,t,r){if(r instanceof ArrayBuffer)return LE(r,i,r.byteLength);switch(typeof r){case"function":return r(i);case"string":const o=Bm(i,e,r.length);return r===o;default:return!1}}function bw(i,e=5){return typeof i=="string"?i.slice(0,e):ArrayBuffer.isView(i)?Bm(i.buffer,i.byteOffset,e):i instanceof ArrayBuffer?Bm(i,0,e):""}function Bm(i,e,t){if(i.byteLength<e+t)return"";const r=new DataView(i);let o="";for(let c=0;c<t;c++)o+=String.fromCharCode(r.getUint8(e+c));return o}const CA=256*1024;function*IA(i,e){const t=e?.chunkSize||CA;let r=0;const o=new TextEncoder;for(;r<i.length;){const c=Math.min(i.length-r,t),d=i.slice(r,r+c);r+=c,yield o.encode(d)}}const MA=256*1024;function*RA(i,e={}){const{chunkSize:t=MA}=e;let r=0;for(;r<i.byteLength;){const o=Math.min(i.byteLength-r,t),c=new ArrayBuffer(o),d=new Uint8Array(i,r,o);new Uint8Array(c).set(d),r+=o,yield c}}const kA=1024*1024;async function*DA(i,e){const t=e?.chunkSize||kA;let r=0;for(;r<i.size;){const o=r+t,c=await i.slice(r,o).arrayBuffer();r=o,yield c}}function Dv(i,e){return y_?OA(i,e):LA(i)}async function*OA(i,e){const t=i.getReader();let r;try{for(;;){const o=r||t.read();e?._streamReadAhead&&(r=t.read());const{done:c,value:d}=await o;if(c)return;yield uw(d)}}catch{t.releaseLock()}}async function*LA(i,e){for await(const t of i)yield uw(t)}function FA(i,e){if(typeof i=="string")return IA(i,e);if(i instanceof ArrayBuffer)return RA(i,e);if(Wa(i))return DA(i,e);if(dw(i))return Dv(i,e);if($a(i))return Dv(i.body,e);throw new Error("makeIterator")}const ww="Cannot convert supplied data type";function BA(i,e,t){if(e.text&&typeof i=="string")return i;if(ZE(i)&&(i=i.buffer),i instanceof ArrayBuffer){const r=i;return e.text&&!e.binary?new TextDecoder("utf8").decode(r):r}if(ArrayBuffer.isView(i)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(i);let r=i.buffer;const o=i.byteLength||i.length;return(i.byteOffset!==0||o!==r.byteLength)&&(r=r.slice(i.byteOffset,i.byteOffset+o)),r}throw new Error(ww)}async function NA(i,e,t){const r=i instanceof ArrayBuffer||ArrayBuffer.isView(i);if(typeof i=="string"||r)return BA(i,e);if(Wa(i)&&(i=await pw(i)),$a(i)){const o=i;return await iA(o),e.binary?await o.arrayBuffer():await o.text()}if(dw(i)&&(i=FA(i,t)),WE(i)||HE(i))return NE(i);throw new Error(ww)}function Tw(i,e){const t=_w(),r=i||t;return typeof r.fetch=="function"?r.fetch:Rh(r.fetch)?o=>Pv(o,r.fetch):e?.fetch?e?.fetch:Pv}function zA(i,e,t){if(t)return t;const r={fetch:Tw(e,i),...i};if(r.url){const o=v_(r.url);r.baseUrl=o,r.queryString=QE(r.url),r.filename=hw(o),r.baseUrl=jE(o)}return Array.isArray(r.loaders)||(r.loaders=null),r}function UA(i,e){if(i&&!Array.isArray(i))return i;let t;if(i&&(t=Array.isArray(i)?i:[i]),e&&e.loaders){const r=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...r]:r}return t&&t.length?t:void 0}async function $f(i,e,t,r){e&&!Array.isArray(e)&&!w_(e)&&(r=void 0,t=e,e=void 0),i=await i,t=t||{};const o=dp(i),d=UA(e,r),a=await vA(i,d,t);return a?(t=dA(t,a,d,o),r=zA({url:o,_parse:$f,loaders:d},t,r||null),await VA(a,i,t,r)):null}async function VA(i,e,t,r){if(RE(i),t=xE(i.options,t),$a(e)){const c=e,{ok:d,redirected:a,status:y,statusText:w,type:E,url:I}=c,D=Object.fromEntries(c.headers.entries());r.response={headers:D,ok:d,redirected:a,status:y,statusText:w,type:E,url:I}}e=await NA(e,i,t);const o=i;if(o.parseTextSync&&typeof e=="string")return o.parseTextSync(e,t,r);if(kE(i,t))return await DE(i,e,t,r,$f);if(o.parseText&&typeof e=="string")return await o.parseText(e,t,r);if(o.parse)return await o.parse(e,t,r);throw Zo(!o.parseSync),new Error(`${i.id} loader - no parser found and worker is disabled`)}async function Wf(i,e,t,r){let o,c;!Array.isArray(e)&&!w_(e)?(o=[],c=e):(o=e,c=t);const d=Tw(c);let a=i;return typeof i=="string"&&(a=await d(i)),Wa(i)&&(a=await d(i)),Array.isArray(o)?await $f(a,o,c):await $f(a,o,c)}const jA="4.3.3",$A=globalThis.loaders?.parseImageNode,Nm=typeof Image<"u",zm=typeof ImageBitmap<"u",WA=!!$A,Um=y_?!0:WA;function HA(i){switch(i){case"auto":return zm||Nm||Um;case"imagebitmap":return zm;case"image":return Nm;case"data":return Um;default:throw new Error(`@loaders.gl/images: image ${i} not supported in this environment`)}}function ZA(){if(zm)return"imagebitmap";if(Nm)return"image";if(Um)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function qA(i){const e=GA(i);if(!e)throw new Error("Not an image");return e}function XA(i){switch(qA(i)){case"data":return i;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=i.width,e.height=i.height,t.drawImage(i,0,0),t.getImageData(0,0,i.width,i.height);default:throw new Error("getImageData")}}function GA(i){return typeof ImageBitmap<"u"&&i instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&i instanceof Image?"image":i&&typeof i=="object"&&i.data&&i.width&&i.height?"data":null}const YA=/^data:image\/svg\+xml/,KA=/\.svg((\?|#).*)?$/;function S_(i){return i&&(YA.test(i)||KA.test(i))}function JA(i,e){if(S_(e)){let r=new TextDecoder().decode(i);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(r=unescape(encodeURIComponent(r)))}catch(c){throw new Error(c.message)}return`data:image/svg+xml;base64,${btoa(r)}`}return Sw(i,e)}function Sw(i,e){if(S_(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(i)])}async function Ew(i,e,t){const r=JA(i,t),o=self.URL||self.webkitURL,c=typeof r!="string"&&o.createObjectURL(r);try{return await QA(c||r,e)}finally{c&&o.revokeObjectURL(c)}}async function QA(i,e){const t=new Image;return t.src=i,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((r,o)=>{try{t.onload=()=>r(t),t.onerror=c=>{const d=c instanceof Error?c.message:"error";o(new Error(d))}}catch(c){o(c)}})}const eP={};let Ov=!0;async function tP(i,e,t){let r;S_(t)?r=await Ew(i,e,t):r=Sw(i,t);const o=e&&e.imagebitmap;return await iP(r,o)}async function iP(i,e=null){if((rP(e)||!Ov)&&(e=null),e)try{return await createImageBitmap(i,e)}catch(t){console.warn(t),Ov=!1}return await createImageBitmap(i)}function rP(i){for(const e in i||eP)return!1;return!0}function nP(i){return!lP(i,"ftyp",4)||(i[8]&96)===0?null:sP(i)}function sP(i){switch(oP(i,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function oP(i,e,t){return String.fromCharCode(...i.slice(e,t))}function aP(i){return[...i].map(e=>e.charCodeAt(0))}function lP(i,e,t=0){const r=aP(e);for(let o=0;o<r.length;++o)if(r[o]!==i[o+t])return!1;return!0}const ws=!1,ch=!0;function Aw(i){const e=kh(i);return uP(e)||fP(e)||hP(e)||dP(e)||cP(e)}function cP(i){const e=new Uint8Array(i instanceof DataView?i.buffer:i),t=nP(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function uP(i){const e=kh(i);return e.byteLength>=24&&e.getUint32(0,ws)===2303741511?{mimeType:"image/png",width:e.getUint32(16,ws),height:e.getUint32(20,ws)}:null}function hP(i){const e=kh(i);return e.byteLength>=10&&e.getUint32(0,ws)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,ch),height:e.getUint16(8,ch)}:null}function dP(i){const e=kh(i);return e.byteLength>=14&&e.getUint16(0,ws)===16973&&e.getUint32(2,ch)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,ch),height:e.getUint32(22,ch)}:null}function fP(i){const e=kh(i);if(!(e.byteLength>=3&&e.getUint16(0,ws)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:r,sofMarkers:o}=pP();let c=2;for(;c+9<e.byteLength;){const d=e.getUint16(c,ws);if(o.has(d))return{mimeType:"image/jpeg",height:e.getUint16(c+5,ws),width:e.getUint16(c+7,ws)};if(!r.has(d))return null;c+=2,c+=e.getUint16(c,ws)}return null}function pP(){const i=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)i.add(t);return{tableMarkers:i,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function kh(i){if(i instanceof DataView)return i;if(ArrayBuffer.isView(i))return new DataView(i.buffer);if(i instanceof ArrayBuffer)return new DataView(i);throw new Error("toDataView")}async function gP(i,e){const{mimeType:t}=Aw(i)||{},r=globalThis.loaders?.parseImageNode;return Vf(r),await r(i,t)}async function mP(i,e,t){e=e||{};const o=(e.image||{}).type||"auto",{url:c}=t||{},d=_P(o);let a;switch(d){case"imagebitmap":a=await tP(i,e,c);break;case"image":a=await Ew(i,e,c);break;case"data":a=await gP(i);break;default:Vf(!1)}return o==="data"&&(a=XA(a)),a}function _P(i){switch(i){case"auto":case"data":return ZA();default:return HA(i),i}}const yP=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],xP=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],vP={image:{type:"auto",decode:!0}},bP={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:jA,mimeTypes:xP,extensions:yP,parse:mP,tests:[i=>!!Aw(new DataView(i))],options:vP},ii=new Mh({id:"deck"});let Vm={};function wP(i){Vm=i}function Nr(i,e,t,r){ii.level>0&&Vm[i]&&Vm[i].call(null,e,t,r)}function TP(i){const e=i[0],t=i[i.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const SP={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:TP,parseTextSync:JSON.parse};function EP(){const i="9.2.2",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==i)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${i}`);return e||(ii.log(1,`deck.gl ${i}`)(),globalThis.deck={...globalThis.deck,VERSION:i,version:i,log:ii,_registerLoggers:wP},_A([SP,[bP,{imagebitmap:{premultiplyAlpha:"none"}}]])),i}const AP=EP();function E_(i,e){if(!i)throw new Error(e||"shadertools: assertion failed.")}const Wg={number:{type:"number",validate(i,e){return Number.isFinite(i)&&typeof e=="object"&&(e.max===void 0||i<=e.max)&&(e.min===void 0||i>=e.min)}},array:{type:"array",validate(i,e){return Array.isArray(i)||ArrayBuffer.isView(i)}}};function PP(i){const e={};for(const[t,r]of Object.entries(i))e[t]=CP(r);return e}function CP(i){let e=Lv(i);if(e!=="object")return{value:i,...Wg[e],type:e};if(typeof i=="object")return i?i.type!==void 0?{...i,...Wg[i.type],type:i.type}:i.value===void 0?{type:"object",value:i}:(e=Lv(i.value),{...i,...Wg[e],type:e}):{type:"object",value:null};throw new Error("props")}function Lv(i){return Array.isArray(i)||ArrayBuffer.isView(i)?"array":typeof i}const IP=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,MP=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,RP={vertex:IP,fragment:MP},Fv=/void\s+main\s*\([^)]*\)\s*\{\n?/,Bv=/}\n?[^{}]*$/,Hg=[],wf="__LUMA_INJECT_DECLARATIONS__";function kP(i){const e={vertex:{},fragment:{}};for(const t in i){let r=i[t];const o=DP(t);typeof r=="string"&&(r={order:0,injection:r}),e[o][t]=r}return e}function DP(i){const e=i.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function Hf(i,e,t,r=!1){const o=e==="vertex";for(const c in t){const d=t[c];d.sort((y,w)=>y.order-w.order),Hg.length=d.length;for(let y=0,w=d.length;y<w;++y)Hg[y]=d[y].injection;const a=`${Hg.join(`
`)}
`;switch(c){case"vs:#decl":o&&(i=i.replace(wf,a));break;case"vs:#main-start":o&&(i=i.replace(Fv,y=>y+a));break;case"vs:#main-end":o&&(i=i.replace(Bv,y=>a+y));break;case"fs:#decl":o||(i=i.replace(wf,a));break;case"fs:#main-start":o||(i=i.replace(Fv,y=>y+a));break;case"fs:#main-end":o||(i=i.replace(Bv,y=>a+y));break;default:i=i.replace(c,y=>y+a)}}return i=i.replace(wf,""),r&&(i=i.replace(/\}\s*$/,c=>c+RP[e])),i}function Zf(i){i.map(e=>OP(e))}function OP(i){if(i.instance)return;Zf(i.dependencies||[]);const{propTypes:e={},deprecations:t=[],inject:r={}}=i,o={normalizedInjections:kP(r),parsedDeprecations:LP(t)};e&&(o.propValidators=PP(e)),i.instance=o;let c={};e&&(c=Object.entries(e).reduce((d,[a,y])=>{const w=y?.value;return w&&(d[a]=w),d},{})),i.defaultUniforms={...i.defaultUniforms,...c}}function Pw(i,e,t){i.deprecations?.forEach(r=>{r.regex?.test(e)&&(r.deprecated?t.deprecated(r.old,r.new)():t.removed(r.old,r.new)())})}function LP(i){return i.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),i}function A_(i){Zf(i);const e={},t={};Cw({modules:i,level:0,moduleMap:e,moduleDepth:t});const r=Object.keys(t).sort((o,c)=>t[c]-t[o]).map(o=>e[o]);return Zf(r),r}function Cw(i){const{modules:e,level:t,moduleMap:r,moduleDepth:o}=i;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const c of e)r[c.name]=c,(o[c.name]===void 0||o[c.name]<t)&&(o[c.name]=t);for(const c of e)c.dependencies&&Cw({modules:c.dependencies,level:t+1,moduleMap:r,moduleDepth:o})}function FP(i){switch(i?.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function BP(i,e){if(Number(i.match(/^#version[ \t]+(\d+)/m)?.[1]||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return i=Nv(i,NP),i;case"fragment":return i=Nv(i,zP),i;default:throw new Error(e)}}const Iw=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],NP=[...Iw,[jm("attribute"),"in $1"],[jm("varying"),"out $1"]],zP=[...Iw,[jm("varying"),"in $1"]];function Nv(i,e){for(const[t,r]of e)i=i.replace(t,r);return i}function jm(i){return new RegExp(`\\b${i}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function Mw(i,e){let t="";for(const r in i){const o=i[r];if(t+=`void ${o.signature} {
`,o.header&&(t+=`  ${o.header}`),e[r]){const c=e[r];c.sort((d,a)=>d.order-a.order);for(const d of c)t+=`  ${d.injection}
`}o.footer&&(t+=`  ${o.footer}`),t+=`}
`}return t}function Rw(i){const e={vertex:{},fragment:{}};for(const t of i){let r,o;typeof t!="string"?(r=t,o=r.hook):(r={},o=t),o=o.trim();const[c,d]=o.split(":"),a=o.replace(/\(.+/,""),y=Object.assign(r,{signature:d});switch(c){case"vs":e.vertex[a]=y;break;case"fs":e.fragment[a]=y;break;default:throw new Error(c)}}return e}function UP(i,e){return{name:VP(i,e),language:"glsl",version:jP(i)}}function VP(i,e="unnamed"){const r=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(i);return r?r[1]:e}function jP(i){let e=100;const t=i.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const r=parseInt(t[1],10);Number.isFinite(r)&&(e=r)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const kw=`

${wf}
`,$P=`precision highp float;
`;function WP(i){const e=A_(i.modules||[]);return{source:ZP(i.platformInfo,{...i,source:i.source,stage:"vertex",modules:e}),getUniforms:Dw(e)}}function HP(i){const{vs:e,fs:t}=i,r=A_(i.modules||[]);return{vs:zv(i.platformInfo,{...i,source:e,stage:"vertex",modules:r}),fs:zv(i.platformInfo,{...i,source:t,stage:"fragment",modules:r}),getUniforms:Dw(r)}}function ZP(i,e){const{source:t,stage:r,modules:o,hookFunctions:c=[],inject:d={},log:a}=e;E_(typeof t=="string","shader source must be a string");const y=t;let w="";const E=Rw(c),I={},D={},F={};for(const oe in d){const _e=typeof d[oe]=="string"?{injection:d[oe],order:0}:d[oe],ge=/^(v|f)s:(#)?([\w-]+)$/.exec(oe);if(ge){const fe=ge[2],Te=ge[3];fe?Te==="decl"?D[oe]=[_e]:F[oe]=[_e]:I[oe]=[_e]}else F[oe]=[_e]}const X=o;for(const oe of X){a&&Pw(oe,y,a);const _e=Ow(oe,"wgsl");w+=_e;const ge=oe.injections?.[r]||{};for(const fe in ge){const Te=/^(v|f)s:#([\w-]+)$/.exec(fe);if(Te){const Je=Te[2]==="decl"?D:F;Je[fe]=Je[fe]||[],Je[fe].push(ge[fe])}else I[fe]=I[fe]||[],I[fe].push(ge[fe])}}return w+=kw,w=Hf(w,r,D),w+=Mw(E[r],I),w+=y,w=Hf(w,r,F),w}function zv(i,e){const{source:t,stage:r,language:o="glsl",modules:c,defines:d={},hookFunctions:a=[],inject:y={},prologue:w=!0,log:E}=e;E_(typeof t=="string","shader source must be a string");const I=o==="glsl"?UP(t).version:-1,D=i.shaderLanguageVersion,F=I===100?"#version 100":"#version 300 es",oe=t.split(`
`).slice(1).join(`
`),_e={};c.forEach(Xe=>{Object.assign(_e,Xe.defines)}),Object.assign(_e,d);let ge="";switch(o){case"wgsl":break;case"glsl":ge=w?`${F}

// ----- PROLOGUE -------------------------
${`#define SHADER_TYPE_${r.toUpperCase()}`}

${FP(i)}
${r==="fragment"?$P:""}

// ----- APPLICATION DEFINES -------------------------

${qP(_e)}

`:`${F}
`;break}const fe=Rw(a),Te={},ke={},Je={};for(const Xe in y){const mt=typeof y[Xe]=="string"?{injection:y[Xe],order:0}:y[Xe],G=/^(v|f)s:(#)?([\w-]+)$/.exec(Xe);if(G){const J=G[2],ae=G[3];J?ae==="decl"?ke[Xe]=[mt]:Je[Xe]=[mt]:Te[Xe]=[mt]}else Je[Xe]=[mt]}for(const Xe of c){E&&Pw(Xe,oe,E);const mt=Ow(Xe,r);ge+=mt;const G=Xe.instance?.normalizedInjections[r]||{};for(const J in G){const ae=/^(v|f)s:#([\w-]+)$/.exec(J);if(ae){const ye=ae[2]==="decl"?ke:Je;ye[J]=ye[J]||[],ye[J].push(G[J])}else Te[J]=Te[J]||[],Te[J].push(G[J])}}return ge+="// ----- MAIN SHADER SOURCE -------------------------",ge+=kw,ge=Hf(ge,r,ke),ge+=Mw(fe[r],Te),ge+=oe,ge=Hf(ge,r,Je),o==="glsl"&&I!==D&&(ge=BP(ge,r)),ge.trim()}function Dw(i){return function(t){const r={};for(const o of i){const c=o.getUniforms?.(t,r);Object.assign(r,c)}return r}}function qP(i={}){let e="";for(const t in i){const r=i[t];(r||Number.isFinite(r))&&(e+=`#define ${t.toUpperCase()} ${i[t]}
`)}return e}function Ow(i,e){let t;switch(e){case"vertex":t=i.vs||"";break;case"fragment":t=i.fs||"";break;case"wgsl":t=i.source||"";break;default:E_(!1)}if(!i.name)throw new Error("Shader module must have a name");const r=i.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let o=`// ----- MODULE ${i.name} ---------------

`;return e!=="wgsl"&&(o+=`#define MODULE_${r}
`),o+=`${t}
`,o}const XP=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,GP=/^\s*\#\s*endif\s*$/;function YP(i,e){const t=i.split(`
`),r=[];let o=!0,c=null;for(const d of t){const a=d.match(XP),y=d.match(GP);a?(c=a[1],o=!!e?.defines?.[c]):y?o=!0:o&&r.push(d)}return r.join(`
`)}class Pa{static defaultShaderAssembler;_hookFunctions=[];_defaultModules=[];static getDefaultShaderAssembler(){return Pa.defaultShaderAssembler=Pa.defaultShaderAssembler||new Pa,Pa.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(r=>r.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),r=this._hookFunctions,{source:o,getUniforms:c}=WP({...e,source:e.source,modules:t,hookFunctions:r});return{source:e.platformInfo.shaderLanguage==="wgsl"?YP(o):o,getUniforms:c,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),r=this._hookFunctions;return{...HP({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:r}),modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),r={};let o=0;for(let c=0,d=this._defaultModules.length;c<d;++c){const a=this._defaultModules[c],y=a.name;t[o++]=a,r[y]=!0}for(let c=0,d=e.length;c<d;++c){const a=e[c],y=a.name;r[y]||(t[o++]=a,r[y]=!0)}return t.length=o,Zf(t),t}}const KP=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,JP=`#version 300 es
${KP}`;function QP(i){const{input:e,inputChannels:t,output:r}={};if(!e)return JP;if(!t)throw new Error("inputChannels");const o=e3(t),c=t3(e,t);return`#version 300 es
in ${o} ${e};
out vec4 ${r};
void main() {
  ${r} = ${c};
}`}function e3(i){switch(i){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${i}`)}}function t3(i,e){switch(e){case 1:return`vec4(${i}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${i}, 0.0, 1.0)`;case 3:return`vec4(${i}, 1.0)`;case 4:return i;default:throw new Error(`invalid channels: ${e}`)}}class i3{stats=new Map;getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new hp({id:e})),this.stats.get(e)}}const Lw=new i3,dt=new Mh({id:"luma.gl"}),Zg={};function fp(i="id"){Zg[i]=Zg[i]||1;const e=Zg[i]++;return`${i}-${e}`}let Ei=class{static defaultProps={id:"undefined",handle:void 0,userData:void 0};toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}id;props;userData={};_device;destroyed=!1;allocatedBytes=0;_attachedResources=new Set;constructor(e,t,r){if(!e)throw new Error("no device");this._device=e,this.props=r3(t,r);const o=this.props.id!=="undefined"?this.props.id:fp(this[Symbol.toStringTag]);this.props.id=o,this.id=o,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const r=this._device.statsManager.getStats("Resource Counts");r.get("GPU Memory").addCount(e),r.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}};function r3(i,e){const t={...e};for(const r in i)i[r]!==void 0&&(t[r]=i[r]);return t}class Mi extends Ei{static INDEX=16;static VERTEX=32;static UNIFORM=64;static STORAGE=128;static INDIRECT=256;static QUERY_RESOLVE=512;static MAP_READ=1;static MAP_WRITE=2;static COPY_SRC=4;static COPY_DST=8;get[Symbol.toStringTag](){return"Buffer"}usage;indexType;updateTimestamp;constructor(e,t){const r={...t};(t.usage||0)&Mi.INDEX&&!t.indexType&&(t.data instanceof Uint32Array?r.indexType="uint32":t.data instanceof Uint16Array&&(r.indexType="uint16")),delete r.data,super(e,r,Mi.defaultProps),this.usage=r.usage||0,this.indexType=r.indexType,this.updateTimestamp=e.incrementTimestamp()}clone(e){return this.device.createBuffer({...this.props,...e})}static DEBUG_DATA_MAX_LENGTH=32;debugData=new ArrayBuffer(0);_setDebugData(e,t,r){const o=ArrayBuffer.isView(e)?e.buffer:e,c=Math.min(e?e.byteLength:r,Mi.DEBUG_DATA_MAX_LENGTH);o===null?this.debugData=new ArrayBuffer(c):t===0&&r===o.byteLength?this.debugData=o.slice(0,c):this.debugData=o.slice(t,t+c)}static defaultProps={...Ei.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",onMapped:void 0}}function Fw(i){const[e,t,r]=I_[i],o=i.includes("norm"),c=!o&&!i.startsWith("float"),d=i.startsWith("s");return{signedType:e,primitiveType:t,byteLength:r,normalized:o,integer:c,signed:d}}function n3(i){const e=i;switch(e){case"uint8":return"unorm8";case"sint8":return"snorm8";case"uint16":return"unorm16";case"sint16":return"snorm16";default:return e}}function s3(i,e){switch(e){case 1:return i;case 2:return i+i%2;default:return i+(4-i%4)%4}}function P_(i){const e=ArrayBuffer.isView(i)?i.constructor:i;if(e===Uint8ClampedArray)return"uint8";const t=Object.values(I_).find(r=>e===r[4]);if(!t)throw new Error(e.name);return t[0]}function C_(i){const[,,,,e]=I_[i];return e}const I_={uint8:["uint8","u32",1,!1,Uint8Array],sint8:["sint8","i32",1,!1,Int8Array],unorm8:["uint8","f32",1,!0,Uint8Array],snorm8:["sint8","f32",1,!0,Int8Array],uint16:["uint16","u32",2,!1,Uint16Array],sint16:["sint16","i32",2,!1,Int16Array],unorm16:["uint16","u32",2,!0,Uint16Array],snorm16:["sint16","i32",2,!0,Int16Array],float16:["float16","f16",2,!1,Uint16Array],float32:["float32","f32",4,!1,Float32Array],uint32:["uint32","u32",4,!1,Uint32Array],sint32:["sint32","i32",4,!1,Int32Array]};function M_(i){let e;i.endsWith("-webgl")&&(i.replace("-webgl",""),e=!0);const[t,r]=i.split("x"),o=t,c=r?parseInt(r):1,d=Fw(o),a={type:o,components:c,byteLength:d.byteLength*c,integer:d.integer,signed:d.signed,normalized:d.normalized};return e&&(a.webglOnly=!0),a}function o3(i,e,t){const r=t?n3(i):i;switch(r){case"unorm8":return e===1?"unorm8":e===3?"unorm8x3-webgl":`${r}x${e}`;case"snorm8":case"uint8":case"sint8":case"uint16":case"sint16":case"unorm16":case"snorm16":case"float16":if(e===1||e===3)throw new Error(`size: ${e}`);return`${r}x${e}`;default:return e===1?r:`${r}x${e}`}}function a3(i,e,t){if(!e||e>4)throw new Error(`size ${e}`);const r=e,o=P_(i);return o3(o,r,t)}function l3(i){let e;switch(i.primitiveType){case"f32":e="float32";break;case"i32":e="sint32";break;case"u32":e="uint32";break;case"f16":return i.components<=2?"float16x2":"float16x4"}return i.components===1?e:`${e}x${i.components}`}const Lr="texture-compression-bc",Si="texture-compression-astc",_s="texture-compression-etc2",c3="texture-compression-etc1-webgl",Jd="texture-compression-pvrtc-webgl",qg="texture-compression-atc-webgl",Qd="float32-renderable-webgl",Xg="float16-renderable-webgl",u3="rgb9e5ufloat-renderable-webgl",Gg="snorm8-renderable-webgl",Gu="norm16-renderable-webgl",Yg="snorm16-renderable-webgl",ef="float32-filterable",Uv="float16-filterable-webgl";function Bw(i){const e=f3[i];if(!e)throw new Error(`Unsupported texture format ${i}`);return e}const h3={r8unorm:{},rg8unorm:{},"rgb8unorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},r8snorm:{render:Gg},rg8snorm:{render:Gg},"rgb8snorm-webgl":{},rgba8snorm:{render:Gg},r8uint:{},rg8uint:{},rgba8uint:{},r8sint:{},rg8sint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},r16unorm:{f:Gu},rg16unorm:{render:Gu},"rgb16unorm-webgl":{f:Gu},rgba16unorm:{render:Gu},r16snorm:{f:Yg},rg16snorm:{render:Yg},"rgb16snorm-webgl":{f:Gu},rgba16snorm:{render:Yg},r16uint:{},rg16uint:{},rgba16uint:{},r16sint:{},rg16sint:{},rgba16sint:{},r16float:{render:Xg,filter:"float16-filterable-webgl"},rg16float:{render:Xg,filter:Uv},rgba16float:{render:Xg,filter:Uv},r32uint:{},rg32uint:{},rgba32uint:{},r32sint:{},rg32sint:{},rgba32sint:{},r32float:{render:Qd,filter:ef},rg32float:{render:!1,filter:ef},"rgb32float-webgl":{render:Qd,filter:ef},rgba32float:{render:Qd,filter:ef},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},rgb9e5ufloat:{channels:"rgb",packed:!0,render:u3},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:Qd},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},rgb10a2uint:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0}},d3={"bc1-rgb-unorm-webgl":{f:Lr},"bc1-rgb-unorm-srgb-webgl":{f:Lr},"bc1-rgba-unorm":{f:Lr},"bc1-rgba-unorm-srgb":{f:Lr},"bc2-rgba-unorm":{f:Lr},"bc2-rgba-unorm-srgb":{f:Lr},"bc3-rgba-unorm":{f:Lr},"bc3-rgba-unorm-srgb":{f:Lr},"bc4-r-unorm":{f:Lr},"bc4-r-snorm":{f:Lr},"bc5-rg-unorm":{f:Lr},"bc5-rg-snorm":{f:Lr},"bc6h-rgb-ufloat":{f:Lr},"bc6h-rgb-float":{f:Lr},"bc7-rgba-unorm":{f:Lr},"bc7-rgba-unorm-srgb":{f:Lr},"etc2-rgb8unorm":{f:_s},"etc2-rgb8unorm-srgb":{f:_s},"etc2-rgb8a1unorm":{f:_s},"etc2-rgb8a1unorm-srgb":{f:_s},"etc2-rgba8unorm":{f:_s},"etc2-rgba8unorm-srgb":{f:_s},"eac-r11unorm":{f:_s},"eac-r11snorm":{f:_s},"eac-rg11unorm":{f:_s},"eac-rg11snorm":{f:_s},"astc-4x4-unorm":{f:Si},"astc-4x4-unorm-srgb":{f:Si},"astc-5x4-unorm":{f:Si},"astc-5x4-unorm-srgb":{f:Si},"astc-5x5-unorm":{f:Si},"astc-5x5-unorm-srgb":{f:Si},"astc-6x5-unorm":{f:Si},"astc-6x5-unorm-srgb":{f:Si},"astc-6x6-unorm":{f:Si},"astc-6x6-unorm-srgb":{f:Si},"astc-8x5-unorm":{f:Si},"astc-8x5-unorm-srgb":{f:Si},"astc-8x6-unorm":{f:Si},"astc-8x6-unorm-srgb":{f:Si},"astc-8x8-unorm":{f:Si},"astc-8x8-unorm-srgb":{f:Si},"astc-10x5-unorm":{f:Si},"astc-10x5-unorm-srgb":{f:Si},"astc-10x6-unorm":{f:Si},"astc-10x6-unorm-srgb":{f:Si},"astc-10x8-unorm":{f:Si},"astc-10x8-unorm-srgb":{f:Si},"astc-10x10-unorm":{f:Si},"astc-10x10-unorm-srgb":{f:Si},"astc-12x10-unorm":{f:Si},"astc-12x10-unorm-srgb":{f:Si},"astc-12x12-unorm":{f:Si},"astc-12x12-unorm-srgb":{f:Si},"pvrtc-rgb4unorm-webgl":{f:Jd},"pvrtc-rgba4unorm-webgl":{f:Jd},"pvrtc-rbg2unorm-webgl":{f:Jd},"pvrtc-rgba2unorm-webgl":{f:Jd},"etc1-rbg-unorm-webgl":{f:c3},"atc-rgb-unorm-webgl":{f:qg},"atc-rgba-unorm-webgl":{f:qg},"atc-rgbai-unorm-webgl":{f:qg}},f3={...h3,...d3},p3=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],g3=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;class m3{getInfo(e){return Vv(e)}isColor(e){return e.startsWith("rgba")||e.startsWith("bgra")||e.startsWith("rgb")}isDepthStencil(e){return e.startsWith("depth")||e.startsWith("stencil")}isCompressed(e){return p3.some(t=>e.startsWith(t))}getCapabilities(e){const t=Bw(e),r={format:e,create:t.f??!0,render:t.render??!0,filter:t.filter??!0,blend:t.blend??!0,store:t.store??!0},o=Vv(e),c=e.startsWith("depth")||e.startsWith("stencil"),d=o?.signed,a=o?.integer,y=o?.webgl;return r.render&&=!d,r.filter&&=!c&&!d&&!a&&!y,r}}const uc=new m3;function Vv(i){let e=_3(i);if(uc.isCompressed(i)){e.channels="rgb",e.components=3,e.bytesPerPixel=1,e.srgb=!1,e.compressed=!0;const r=y3(i);r&&(e.blockWidth=r.blockWidth,e.blockHeight=r.blockHeight)}const t=g3.exec(i);if(t){const[,r,o,c,d,a]=t,y=`${c}${o}`,w=Fw(y),E=w.byteLength*8,I=r.length,D=[E,I>=2?E:0,I>=3?E:0,I>=4?E:0];e={format:i,attachment:e.attachment,dataType:w.signedType,components:I,channels:r,integer:w.integer,signed:w.signed,normalized:w.normalized,bitsPerChannel:D,bytesPerPixel:w.byteLength*r.length,packed:e.packed,srgb:e.srgb},a==="-webgl"&&(e.webgl=!0),d==="-srgb"&&(e.srgb=!0)}return i.endsWith("-webgl")&&(e.webgl=!0),i.endsWith("-srgb")&&(e.srgb=!0),e}function _3(i){const e=Bw(i),t=e.bytesPerPixel||1,r=e.bitsPerChannel||[8,8,8,8];return delete e.bitsPerChannel,delete e.bytesPerPixel,delete e.f,delete e.render,delete e.filter,delete e.blend,delete e.store,{...e,format:i,attachment:e.attachment||"color",channels:e.channels||"r",components:e.components||e.channels?.length||1,bytesPerPixel:t,bitsPerChannel:r,dataType:e.dataType||"uint8",srgb:e.srgb??!1,packed:e.packed??!1,webgl:e.webgl??!1,integer:e.integer??!1,signed:e.signed??!1,normalized:e.normalized??!1,compressed:e.compressed??!1}}function y3(i){const t=/.*-(\d+)x(\d+)-.*/.exec(i);if(t){const[,r,o]=t;return{blockWidth:Number(r),blockHeight:Number(o)}}return null}function x3(i){return typeof ImageData<"u"&&i instanceof ImageData||typeof ImageBitmap<"u"&&i instanceof ImageBitmap||typeof HTMLImageElement<"u"&&i instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&i instanceof HTMLVideoElement||typeof VideoFrame<"u"&&i instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&i instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas}function v3(i){if(typeof ImageData<"u"&&i instanceof ImageData||typeof ImageBitmap<"u"&&i instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&i instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&i instanceof OffscreenCanvas)return{width:i.width,height:i.height};if(typeof HTMLImageElement<"u"&&i instanceof HTMLImageElement)return{width:i.naturalWidth,height:i.naturalHeight};if(typeof HTMLVideoElement<"u"&&i instanceof HTMLVideoElement)return{width:i.videoWidth,height:i.videoHeight};if(typeof VideoFrame<"u"&&i instanceof VideoFrame)return{width:i.displayWidth,height:i.displayHeight};throw new Error("Unknown image type")}class b3{}class w3{features;disabledFeatures;constructor(e=[],t){this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){return!this.disabledFeatures?.[e]&&this.features.has(e)}}class La{static defaultProps={id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,webgl:{},onError:(e,t)=>{},onResize:(e,t)=>{const[r,o]=e.getDevicePixelSize();dt.log(1,`${e} resized => ${r}x${o}px`)()},onPositionChange:(e,t)=>{const[r,o]=e.getPosition();dt.log(1,`${e} repositioned => ${r},${o}`)()},onVisibilityChange:e=>dt.log(1,`${e} Visibility changed ${e.isVisible}`)(),onDevicePixelRatioChange:(e,t)=>dt.log(1,`${e} DPR changed ${t.oldRatio} => ${e.devicePixelRatio}`)(),debug:dt.get("debug")||void 0,debugShaders:dt.get("debug-shaders")||void 0,debugFramebuffers:!!dt.get("debug-framebuffers"),debugFactories:!!dt.get("debug-factories"),debugWebGL:!!dt.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_reuseDevices:!1,_requestMaxLimits:!0,_cacheShaders:!1,_cachePipelines:!1,_cacheDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_handle:void 0};get[Symbol.toStringTag](){return"Device"}toString(){return`Device(${this.id})`}id;props;userData={};statsManager=Lw;timestamp=0;_reused=!1;_lumaData={};_textureCaps={};constructor(e){this.props={...La.defaultProps,...e},this.id=this.props.id||fp(this[Symbol.toStringTag].toLowerCase())}getVertexFormatInfo(e){return M_(e)}isVertexFormatSupported(e){return!0}getTextureFormatInfo(e){return uc.getInfo(e)}getTextureFormatCapabilities(e){let t=this._textureCaps[e];if(!t){const r=this._getDeviceTextureFormatCapabilities(e);t=this._getDeviceSpecificTextureFormatCapabilities(r),this._textureCaps[e]=t}return t}getMipLevelCount(e,t,r=1){const o=Math.max(e,t,r);return 1+Math.floor(Math.log2(o))}isExternalImage(e){return x3(e)}getExternalImageSize(e){return v3(e)}isTextureFormatSupported(e){return this.getTextureFormatCapabilities(e).create}isTextureFormatFilterable(e){return this.getTextureFormatCapabilities(e).filter}isTextureFormatRenderable(e){return this.getTextureFormatCapabilities(e).render}isTextureFormatCompressed(e){return uc.isCompressed(e)}pushDebugGroup(e){this.commandEncoder.pushDebugGroup(e)}popDebugGroup(){this.commandEncoder?.popDebugGroup()}insertDebugMarker(e){this.commandEncoder?.insertDebugMarker(e)}loseDevice(){return!1}incrementTimestamp(){return this.timestamp++}reportError(e,t,...r){return this.props.onError(e,t)?()=>{}:dt.error(e.message,t,...r)}debug(){if(this.props.debug)debugger;else dt.once(0,`'Type luma.log.set({debug: true}) in console to enable debug breakpoints',
or create a device with the 'debug: true' prop.`)()}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}beginRenderPass(e){return this.commandEncoder.beginRenderPass(e)}beginComputePass(e){return this.commandEncoder.beginComputePass(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(e){return e.createCanvasContext===!0?{}:e.createCanvasContext}_getDeviceTextureFormatCapabilities(e){const t=uc.getCapabilities(e),r=c=>(typeof c=="string"?this.features.has(c):c)??!0,o=r(t.create);return{format:e,create:o,render:o&&r(t.render),filter:o&&r(t.filter),blend:o&&r(t.blend),store:o&&r(t.store)}}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};if((e.usage||0)&Mi.INDEX&&(e.indexType||(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array&&(t.indexType="uint16")),!t.indexType))throw new Error("indices buffer content must be of type uint16 or uint32");return t}}const T3="set luma.log.level=1 (or higher) to trace rendering",jv="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.";class qf{static defaultProps={...La.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0};stats=Lw;log=dt;VERSION="9.2.4";spector;preregisteredAdapters=new Map;constructor(){if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw dt.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),dt.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");dt.error("This version of luma.gl has already been initialized")()}dt.log(1,`${this.VERSION} - ${T3}`)(),globalThis.luma=this}async createDevice(e={}){const t={...qf.defaultProps,...e},r=this.selectAdapter(t.type,t.adapters);if(!r)throw new Error(jv);return t.waitForPageLoad&&await r.pageLoaded,await r.create(t)}async attachDevice(e,t){const r=this._getTypeFromHandle(e,t.adapters),o=r&&this.selectAdapter(r,t.adapters);if(!o)throw new Error(jv);return await o?.attach?.(e,t)}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this._getAdapterMap(e);return Array.from(t).map(([,r])=>r).filter(r=>r.isSupported?.()).map(r=>r.type)}getBestAvailableAdapterType(e=[]){const t=["webgpu","webgl","null"],r=this._getAdapterMap(e);for(const o of t)if(r.get(o)?.isSupported?.())return o;return null}selectAdapter(e,t=[]){let r=e;e==="best-available"&&(r=this.getBestAvailableAdapterType(t));const o=this._getAdapterMap(t);return r&&o.get(r)||null}enforceWebGL2(e=!0,t=[]){const o=this._getAdapterMap(t).get("webgl");o||dt.warn("enforceWebGL2: webgl adapter not found")(),o?.enforceWebGL2?.(e)}setDefaultDeviceProps(e){Object.assign(qf.defaultProps,e)}_getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const r of e)t.set(r.type,r);return t}_getTypeFromHandle(e,t=[]){return e instanceof WebGL2RenderingContext?"webgl":typeof GPUDevice<"u"&&e instanceof GPUDevice||e?.queue?"webgpu":e===null?"null":(e instanceof WebGLRenderingContext?dt.warn("WebGL1 is not supported",e)():dt.warn("Unknown handle type",e)(),null)}}const $m=new qf;class S3{get pageLoaded(){return P3()}}const E3=ja()&&typeof document<"u",A3=()=>E3&&document.readyState==="complete";let tf=null;function P3(){return tf||(A3()||typeof window>"u"?tf=Promise.resolve():tf=new Promise(i=>window.addEventListener("load",()=>i()))),tf}function C3(){let i,e;return{promise:new Promise((r,o)=>{i=r,e=o}),resolve:i,reject:e}}class Ca{static isHTMLCanvas(e){return typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement}static isOffscreenCanvas(e){return typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas}static defaultProps={id:void 0,canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb",trackPosition:!1};id;props;canvas;htmlCanvas;offscreenCanvas;type;initialized;isInitialized=!1;isVisible=!0;cssWidth;cssHeight;devicePixelRatio;devicePixelWidth;devicePixelHeight;drawingBufferWidth;drawingBufferHeight;_initializedResolvers=C3();_resizeObserver;_intersectionObserver;_position;destroyed=!1;toString(){return`${this[Symbol.toStringTag]}(${this.id})`}constructor(e){if(this.props={...Ca.defaultProps,...e},e=this.props,this.initialized=this._initializedResolvers.promise,ja()?e.canvas?typeof e.canvas=="string"?this.canvas=M3(e.canvas):this.canvas=e.canvas:this.canvas=R3(e):this.canvas={width:e.width||1,height:e.height||1},Ca.isHTMLCanvas(this.canvas)?(this.id=e.id||this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):Ca.isOffscreenCanvas(this.canvas)?(this.id=e.id||"offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas):(this.id=e.id||"node-canvas-context",this.type="node"),this.cssWidth=this.htmlCanvas?.clientWidth||this.canvas.width,this.cssHeight=this.htmlCanvas?.clientHeight||this.canvas.height,this.devicePixelWidth=this.canvas.width,this.devicePixelHeight=this.canvas.height,this.drawingBufferWidth=this.canvas.width,this.drawingBufferHeight=this.canvas.height,this.devicePixelRatio=globalThis.devicePixelRatio||1,this._position=[0,0],Ca.isHTMLCanvas(this.canvas)){this._intersectionObserver=new IntersectionObserver(t=>this._handleIntersection(t)),this._intersectionObserver.observe(this.canvas),this._resizeObserver=new ResizeObserver(t=>this._handleResize(t));try{this._resizeObserver.observe(this.canvas,{box:"device-pixel-content-box"})}catch{this._resizeObserver.observe(this.canvas,{box:"content-box"})}setTimeout(()=>this._observeDevicePixelRatio(),0),this.props.trackPosition&&this._trackPosition()}}destroy(){this.destroyed=!0}setProps(e){return"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1,this._updateDrawingBufferSize()),this}getCSSSize(){return[this.cssWidth,this.cssHeight]}getPosition(){return this._position}getDevicePixelSize(){return[this.devicePixelWidth,this.devicePixelHeight]}getDrawingBufferSize(){return[this.drawingBufferWidth,this.drawingBufferHeight]}getMaxDrawingBufferSize(){const e=this.device.limits.maxTextureDimension2D;return[e,e]}setDrawingBufferSize(e,t){this.canvas.width=e,this.canvas.height=t,this.drawingBufferWidth=e,this.drawingBufferHeight=t}getDevicePixelRatio(){return typeof window<"u"&&window.devicePixelRatio||1}cssToDevicePixels(e,t=!0){const r=this.cssToDeviceRatio(),[o,c]=this.getDrawingBufferSize();return k3(e,r,o,c,t)}getPixelSize(){return this.getDevicePixelSize()}getAspect(){const[e,t]=this.getDevicePixelSize();return e/t}cssToDeviceRatio(){try{const[e]=this.getDrawingBufferSize(),[t]=this.getCSSSize();return t?e/t:1}catch{return 1}}resize(e){this.setDrawingBufferSize(e.width,e.height)}_setAutoCreatedCanvasId(e){this.htmlCanvas?.id==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}_handleIntersection(e){const t=e.find(o=>o.target===this.canvas);if(!t)return;const r=t.isIntersecting;this.isVisible!==r&&(this.isVisible=r,this.device.props.onVisibilityChange(this))}_handleResize(e){const t=e.find(y=>y.target===this.canvas);if(!t)return;this.cssWidth=t.contentBoxSize[0].inlineSize,this.cssHeight=t.contentBoxSize[0].blockSize;const r=this.getDevicePixelSize(),o=t.devicePixelContentBoxSize?.[0].inlineSize||t.contentBoxSize[0].inlineSize*devicePixelRatio,c=t.devicePixelContentBoxSize?.[0].blockSize||t.contentBoxSize[0].blockSize*devicePixelRatio,[d,a]=this.getMaxDrawingBufferSize();this.devicePixelWidth=Math.max(1,Math.min(o,d)),this.devicePixelHeight=Math.max(1,Math.min(c,a)),this._updateDrawingBufferSize(),this.device.props.onResize(this,{oldPixelSize:r})}_updateDrawingBufferSize(){if(this.props.autoResize){if(typeof this.props.useDevicePixels=="number"){const e=this.props.useDevicePixels;this.setDrawingBufferSize(this.cssWidth*e,this.cssHeight*e)}else this.props.useDevicePixels?this.setDrawingBufferSize(this.devicePixelWidth,this.devicePixelHeight):this.setDrawingBufferSize(this.cssWidth,this.cssHeight);this._updateDevice()}this._initializedResolvers.resolve(),this.isInitialized=!0,this.updatePosition()}_observeDevicePixelRatio(){const e=this.devicePixelRatio;this.devicePixelRatio=window.devicePixelRatio,this.updatePosition(),this.device.props.onDevicePixelRatioChange(this,{oldRatio:e}),matchMedia(`(resolution: ${this.devicePixelRatio}dppx)`).addEventListener("change",()=>this._observeDevicePixelRatio(),{once:!0})}_trackPosition(e=100){const t=setInterval(()=>{this.destroyed?clearInterval(t):this.updatePosition()},e)}updatePosition(){const e=this.htmlCanvas?.getBoundingClientRect();if(e){const t=[e.left,e.top];if(this._position??=t,t[0]!==this._position[0]||t[1]!==this._position[1]){const o=this._position;this._position=t,this.device.props.onPositionChange?.(this,{oldPosition:o})}}}}function I3(i){if(typeof i=="string"){const e=document.getElementById(i);if(!e)throw new Error(`${i} is not an HTML element`);return e}return i||document.body}function M3(i){const e=document.getElementById(i);if(!Ca.isHTMLCanvas(e))throw new Error("Object is not a canvas element");return e}function R3(i){const{width:e,height:t}=i,r=document.createElement("canvas");r.id=fp("lumagl-auto-created-canvas"),r.width=e||1,r.height=t||1,r.style.width=Number.isFinite(e)?`${e}px`:"100%",r.style.height=Number.isFinite(t)?`${t}px`:"100%",i?.visible||(r.style.visibility="hidden");const o=I3(i?.container||null);return o.insertBefore(r,o.firstChild),r}function k3(i,e,t,r,o){const c=i,d=$v(c[0],e,t);let a=Wv(c[1],e,r,o),y=$v(c[0]+1,e,t);const w=y===t-1?y:y-1;y=Wv(c[1]+1,e,r,o);let E;return o?(y=y===0?y:y+1,E=a,a=y):E=y===r-1?y:y-1,{x:d,y:a,width:Math.max(w-d+1,1),height:Math.max(E-a+1,1)}}function $v(i,e,t){return Math.min(Math.round(i*e),t-1)}function Wv(i,e,t,r){return r?Math.max(0,t-1-Math.round(i*e)):Math.min(Math.round(i*e),t-1)}class Fa extends Ei{static defaultProps={...Ei.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1};get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){t=Fa.normalizeProps(e,t),super(e,t,Fa.defaultProps)}static normalizeProps(e,t){return t}}const D3={"1d":"1d","2d":"2d","2d-array":"2d",cube:"2d","cube-array":"2d","3d":"3d"};class xr extends Ei{static SAMPLE=4;static STORAGE=8;static RENDER=16;static COPY_SRC=1;static COPY_DST=2;static TEXTURE=4;static RENDER_ATTACHMENT=16;dimension;baseDimension;format;width;height;depth;mipLevels;updateTimestamp;get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}constructor(e,t){if(t=xr.normalizeProps(e,t),super(e,t,xr.defaultProps),this.dimension=this.props.dimension,this.baseDimension=D3[this.dimension],this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.mipLevels=this.props.mipLevels,this.props.width===void 0||this.props.height===void 0)if(e.isExternalImage(t.data)){const r=e.getExternalImageSize(t.data);this.width=r?.width||1,this.height=r?.height||1}else this.width=1,this.height=1,(this.props.width===void 0||this.props.height===void 0)&&dt.warn(`${this} created with undefined width or height. This is deprecated. Use AsyncTexture instead.`)();this.updateTimestamp=e.incrementTimestamp()}setSampler(e){this.sampler=e instanceof Fa?e:this.device.createSampler(e)}clone(e){return this.device.createTexture({...this.props,...e})}static normalizeProps(e,t){const r={...t},{width:o,height:c}=r;return typeof o=="number"&&(r.width=Math.max(1,Math.ceil(o))),typeof c=="number"&&(r.height=Math.max(1,Math.ceil(c))),r}_initializeData(e){this.device.isExternalImage(e)?this.copyExternalImage({image:e,width:this.width,height:this.height,depth:this.depth,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1}):e&&this.copyImageData({data:e,mipLevel:0,x:0,y:0,z:0,aspect:"all"})}_normalizeCopyImageDataOptions(e){const{width:t,height:r,depth:o}=this,c={...xr.defaultCopyDataOptions,width:t,height:r,depth:o,...e},d=this.device.getTextureFormatInfo(this.format);if(!e.bytesPerRow&&!d.bytesPerPixel)throw new Error(`bytesPerRow must be provided for texture format ${this.format}`);return c.bytesPerRow=e.bytesPerRow||t*(d.bytesPerPixel||4),c.rowsPerImage=e.rowsPerImage||r,c}_normalizeCopyExternalImageOptions(e){const t=this.device.getExternalImageSize(e.image),r={...xr.defaultCopyExternalImageOptions,...t,...e};return r.width=Math.min(r.width,this.width-r.x),r.height=Math.min(r.height,this.height-r.y),r}static defaultProps={...Ei.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",usage:xr.TEXTURE|xr.RENDER_ATTACHMENT|xr.COPY_DST,width:void 0,height:void 0,depth:1,mipLevels:1,samples:void 0,sampler:{},view:void 0};static defaultCopyDataOptions={data:void 0,byteOffset:0,bytesPerRow:void 0,rowsPerImage:void 0,mipLevel:0,x:0,y:0,z:0,aspect:"all"};static defaultCopyExternalImageOptions={image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1}}class pp extends Ei{get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,pp.defaultProps)}static defaultProps={...Ei.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0}}function O3(i,e,t){let r="";const o=e.split(/\r?\n/),c=i.slice().sort((d,a)=>d.lineNum-a.lineNum);switch(t?.showSourceCode||"no"){case"all":let d=0;for(let a=1;a<=o.length;a++)for(r+=Nw(o[a-1],a,t);c.length>d&&c[d].lineNum===a;){const y=c[d++];r+=Kg(y,o,y.lineNum,{...t,inlineSource:!1})}for(;c.length>d;){const a=c[d++];r+=Kg(a,[],0,{...t,inlineSource:!1})}return r;case"issues":case"no":for(const a of i)r+=Kg(a,o,a.lineNum,{inlineSource:t?.showSourceCode!=="no"});return r}}function Kg(i,e,t,r){if(r?.inlineSource){const c=L3(e,t),d=i.linePos>0?`${" ".repeat(i.linePos+5)}^^^
`:"";return`
${c}${d}${i.type.toUpperCase()}: ${i.message}

`}const o=i.type==="error"?"red":"#8B4000";return r?.html?`<div class='luma-compiler-log-error' style="color:${o};"><b> ${i.type.toUpperCase()}: ${i.message}</b></div>`:`${i.type.toUpperCase()}: ${i.message}`}function L3(i,e,t){let r="";for(let o=e-2;o<=e;o++){const c=i[o-1];c!==void 0&&(r+=Nw(c,e,t))}return r}function Nw(i,e,t){const r=t?.html?B3(i):i;return`${F3(String(e),4)}: ${r}${t?.html?"<br/>":`
`}`}function F3(i,e){let t="";for(let r=i.length;r<e;++r)t+=" ";return t+i}function B3(i){return i.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}class gp extends Ei{get[Symbol.toStringTag](){return"Shader"}stage;source;compilationStatus="pending";constructor(e,t){t={...t,debugShaders:t.debugShaders||e.props.debugShaders||"errors"},super(e,{id:N3(t),...t},gp.defaultProps),this.stage=this.props.stage,this.source=this.props.source}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const e=this.props.debugShaders;switch(e){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const t=await this.getCompilationInfo();e==="warnings"&&t?.length===0||this._displayShaderLog(t,this.id)}_displayShaderLog(e,t){if(typeof document>"u"||!document?.createElement)return;const r=t,o=`${this.stage} shader "${r}"`;let c=O3(e,this.source,{showSourceCode:"all",html:!0});const d=this.getTranslatedSource();d&&(c+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${d}</pre></code>`);const a=document.createElement("Button");a.innerHTML=`
<h1>Compilation error in ${o}</h1><br /><br />
<code style="user-select:text;"><pre>
${c}
</pre></code>`,a.style.top="10px",a.style.left="10px",a.style.position="absolute",a.style.zIndex="9999",a.style.width="100%",a.style.textAlign="left",document.body.appendChild(a),document.getElementsByClassName("luma-compiler-log-error")[0]?.scrollIntoView(),a.onclick=()=>{const w=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(w)}}static defaultProps={...Ei.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0}}function N3(i){return z3(i.source)||i.id||fp(`unnamed ${i.stage}-shader`)}function z3(i,e="unnamed"){const r=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(i);return r?r[1]:e}class mp extends Ei{get[Symbol.toStringTag](){return"Framebuffer"}width;height;constructor(e,t={}){super(e,t,mp.defaultProps),this.width=this.props.width,this.height=this.props.height}clone(e){const t=this.colorAttachments.map(o=>o.texture.clone(e)),r=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(e);return this.device.createFramebuffer({...this.props,colorAttachments:t,depthStencilAttachment:r})}resize(e){let t=!e;if(e){const[r,o]=Array.isArray(e)?e:[e.width,e.height];t=t||o!==this.height||r!==this.width,this.width=r,this.height=o}t&&(dt.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((t,r)=>{if(typeof t=="string"){const o=this.createColorTexture(t,r);return this.attachResource(o),o.view}return t instanceof xr?t.view:t});const e=this.props.depthStencilAttachment;if(e)if(typeof e=="string"){const t=this.createDepthStencilTexture(e);this.attachResource(t),this.depthStencilAttachment=t.view}else e instanceof xr?this.depthStencilAttachment=e.view:this.depthStencilAttachment=e}createColorTexture(e,t){return this.device.createTexture({id:`${this.id}-color-attachment-${t}`,usage:xr.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(e){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:xr.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height})}resizeAttachments(e,t){for(let r=0;r<this.colorAttachments.length;++r)if(this.colorAttachments[r]){const o=this.colorAttachments[r].texture.clone({width:e,height:t});this.destroyAttachedResource(this.colorAttachments[r]),this.colorAttachments[r]=o.view,this.attachResource(o.view)}if(this.depthStencilAttachment){const r=this.depthStencilAttachment.texture.clone({width:e,height:t});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=r.view,this.attachResource(r)}this.updateAttachments()}static defaultProps={...Ei.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null}}class Ra extends Ei{get[Symbol.toStringTag](){return"RenderPipeline"}shaderLayout;bufferLayout;linkStatus="pending";hash="";constructor(e,t){super(e,t,Ra.defaultProps),this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}static defaultProps={...Ei.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",colorAttachmentFormats:void 0,depthStencilAttachmentFormat:void 0,parameters:{},bindings:{},uniforms:{}}}class Aa extends Ei{static defaultClearColor=[0,0,0,1];static defaultClearDepth=1;static defaultClearStencil=0;get[Symbol.toStringTag](){return"RenderPass"}constructor(e,t){t=Aa.normalizeProps(e,t),super(e,t,Aa.defaultProps)}static normalizeProps(e,t){return t}static defaultProps={...Ei.defaultProps,framebuffer:null,parameters:void 0,clearColor:Aa.defaultClearColor,clearColors:void 0,clearDepth:Aa.defaultClearDepth,clearStencil:Aa.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0}}class Xf extends Ei{get[Symbol.toStringTag](){return"ComputePipeline"}hash="";shaderLayout;constructor(e,t){super(e,t,Xf.defaultProps),this.shaderLayout=t.shaderLayout}static defaultProps={...Ei.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0}}class R_ extends Ei{get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,t){super(e,t,R_.defaultProps)}static defaultProps={...Ei.defaultProps,measureExecutionTime:void 0}}class k_ extends Ei{get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,t){super(e,t,k_.defaultProps)}static defaultProps={...Ei.defaultProps}}function zw(i){return $3[i]}function U3(i){const[e,t]=j3[i],r=e==="i32"||e==="u32",o=e!=="u32",c=V3[e]*t;return{primitiveType:e,components:t,byteLength:c,integer:r,signed:o}}const V3={f32:4,f16:2,i32:4,u32:4},j3={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},$3={f32:{type:"f32",components:1},f16:{type:"f16",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<f16>":{type:"f16",components:2},"vec3<f16>":{type:"f16",components:3},"vec4<f16>":{type:"f16",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16},"mat2x2<f16>":{type:"f16",components:4},"mat2x3<f16>":{type:"f16",components:6},"mat2x4<f16>":{type:"f16",components:8},"mat3x2<f16>":{type:"f16",components:6},"mat3x3<f16>":{type:"f16",components:9},"mat3x4<f16>":{type:"f16",components:12},"mat4x2<f16>":{type:"f16",components:8},"mat4x3<f16>":{type:"f16",components:12},"mat4x4<f16>":{type:"f16",components:16},"mat2x2<i32>":{type:"i32",components:4},"mat2x3<i32>":{type:"i32",components:6},"mat2x4<i32>":{type:"i32",components:8},"mat3x2<i32>":{type:"i32",components:6},"mat3x3<i32>":{type:"i32",components:9},"mat3x4<i32>":{type:"i32",components:12},"mat4x2<i32>":{type:"i32",components:8},"mat4x3<i32>":{type:"i32",components:12},"mat4x4<i32>":{type:"i32",components:16},"mat2x2<u32>":{type:"u32",components:4},"mat2x3<u32>":{type:"u32",components:6},"mat2x4<u32>":{type:"u32",components:8},"mat3x2<u32>":{type:"u32",components:6},"mat3x3<u32>":{type:"u32",components:9},"mat3x4<u32>":{type:"u32",components:12},"mat4x2<u32>":{type:"u32",components:8},"mat4x3<u32>":{type:"u32",components:12},"mat4x4<u32>":{type:"u32",components:16}};function Uw(i,e){const t={};for(const r of i.attributes){const o=H3(i,e,r.name);o&&(t[r.name]=o)}return t}function W3(i,e,t=16){const r=Uw(i,e),o=new Array(t).fill(null);for(const c of Object.values(r))o[c.location]=c;return o}function H3(i,e,t){const r=Z3(i,t),o=q3(e,t);if(!r)return null;const c=U3(r.type),d=l3(c),a=o?.vertexFormat||d,y=M_(a);return{attributeName:o?.attributeName||r.name,bufferName:o?.bufferName||r.name,location:r.location,shaderType:r.type,primitiveType:c.primitiveType,shaderComponents:c.components,vertexFormat:a,bufferDataType:y.type,bufferComponents:y.components,normalized:y.normalized,integer:c.integer,stepMode:o?.stepMode||r.stepMode||"vertex",byteOffset:o?.byteOffset||0,byteStride:o?.byteStride||0}}function Z3(i,e){const t=i.attributes.find(r=>r.name===e);return t||dt.warn(`shader layout attribute "${e}" not present in shader`),t||null}function q3(i,e){X3(i);let t=G3(i,e);return t||(t=Y3(i,e),t)?t:(dt.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function X3(i){for(const e of i)(e.attributes&&e.format||!e.attributes&&!e.format)&&dt.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function G3(i,e){for(const t of i)if(t.format&&t.name===e)return{attributeName:t.name,bufferName:e,stepMode:t.stepMode,vertexFormat:t.format,byteOffset:0,byteStride:t.byteStride||0};return null}function Y3(i,e){for(const t of i){let r=t.byteStride;if(typeof t.byteStride!="number")for(const c of t.attributes||[]){const d=M_(c.format);r+=d.byteLength}const o=t.attributes?.find(c=>c.attribute===e);if(o)return{attributeName:o.attribute,bufferName:t.name,stepMode:t.stepMode,vertexFormat:o.format,byteOffset:o.byteOffset,byteStride:r}}return null}class D_ extends Ei{static defaultProps={...Ei.defaultProps,shaderLayout:void 0,bufferLayout:[]};get[Symbol.toStringTag](){return"VertexArray"}maxVertexAttributes;attributeInfos;indexBuffer=null;attributes;constructor(e,t){super(e,t,D_.defaultProps),this.maxVertexAttributes=e.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null),this.attributeInfos=W3(t.shaderLayout,t.bufferLayout,this.maxVertexAttributes)}setConstantWebGL(e,t){this.device.reportError(new Error("constant attributes not supported"),this)()}}class O_ extends Ei{static defaultProps={...Ei.defaultProps,layout:void 0,buffers:{}};get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,t){super(e,t,O_.defaultProps)}}class L_ extends Ei{get[Symbol.toStringTag](){return"QuerySet"}constructor(e,t){super(e,t,L_.defaultProps)}static defaultProps={...Ei.defaultProps,type:void 0,count:void 0}}let rf;function Vw(i){return(!rf||rf.byteLength<i)&&(rf=new ArrayBuffer(i)),rf}function K3(i,e){const t=Vw(i.BYTES_PER_ELEMENT*e);return new i(t,0,e)}function J3(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function Gf(i){return Array.isArray(i)?i.length===0||typeof i[0]=="number":J3(i)}const Q3=1024;class eC{layout={};byteLength;constructor(e,t={}){let r=0;for(const[c,d]of Object.entries(e)){const a=zw(d),{type:y,components:w}=a,E=w*(t?.[c]??1);r=s3(r,E);const I=r;r+=E,this.layout[c]={type:y,size:E,offset:I}}r+=(4-r%4)%4;const o=r*4;this.byteLength=Math.max(o,Q3)}getData(e){const t=Vw(this.byteLength),r={i32:new Int32Array(t),u32:new Uint32Array(t),f32:new Float32Array(t),f16:new Uint16Array(t)};for(const[o,c]of Object.entries(e)){const d=this.layout[o];if(!d){dt.warn(`Supplied uniform value ${o} not present in uniform block layout`)();continue}const{type:a,size:y,offset:w}=d,E=r[a];if(y===1){if(typeof c!="number"&&typeof c!="boolean"){dt.warn(`Supplied value for single component uniform ${o} is not a number: ${c}`)();continue}E[w]=Number(c)}else{if(!Gf(c)){dt.warn(`Supplied value for multi component / array uniform ${o} is not a numeric array: ${c}`)();continue}E.set(c,w)}}return new Uint8Array(t,0,this.byteLength)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function tC(i,e,t=16){if(i!==e)return!1;const r=i,o=e;if(!Gf(r))return!1;if(Gf(o)&&r.length===o.length){for(let c=0;c<r.length;++c)if(o[c]!==r[c])return!1}return!0}function iC(i){return Gf(i)?i.slice():i}class rC{name;uniforms={};modifiedUniforms={};modified=!0;bindingLayout={};needsRedraw="initialized";constructor(e){if(this.name=e?.name||"unnamed",e?.name&&e?.shaderLayout){const t=e?.shaderLayout.bindings?.find(o=>o.type==="uniform"&&o.name===e?.name);if(!t)throw new Error(e?.name);const r=t;for(const o of r.uniforms||[])this.bindingLayout[o.name]=o}}setUniforms(e){for(const[t,r]of Object.entries(e))this._setUniform(t,r),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${r}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){tC(this.uniforms[e],t)||(this.uniforms[e]=iC(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}class nC{uniformBlocks=new Map;uniformBufferLayouts=new Map;uniformBuffers=new Map;constructor(e){for(const[t,r]of Object.entries(e)){const o=t,c=new eC(r.uniformTypes??{},r.uniformSizes??{});this.uniformBufferLayouts.set(o,c);const d=new rC({name:t});d.setUniforms(r.defaultUniforms||{}),this.uniformBlocks.set(o,d)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(const[t,r]of Object.entries(e))this.uniformBlocks.get(t)?.setUniforms(r);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e)?.byteLength||0}getUniformBufferData(e){const t=this.uniformBlocks.get(e)?.getAllUniforms()||{};return this.uniformBufferLayouts.get(e)?.getData(t)}createUniformBuffer(e,t,r){r&&this.setUniforms(r);const o=this.getUniformBufferByteLength(t),c=e.createBuffer({usage:Mi.UNIFORM|Mi.COPY_DST,byteLength:o}),d=this.getUniformBufferData(t);return c.write(d),c}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const r=this.getUniformBufferByteLength(t),o=e.createBuffer({usage:Mi.UNIFORM|Mi.COPY_DST,byteLength:r});this.uniformBuffers.set(t,o)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const r=this.updateUniformBuffer(t);e||=r}return e&&dt.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){const t=this.uniformBlocks.get(e);let r=this.uniformBuffers.get(e),o=!1;if(r&&t?.needsRedraw){o||=t.needsRedraw;const c=this.getUniformBufferData(e);r=this.uniformBuffers.get(e),r?.write(c);const d=this.uniformBlocks.get(e)?.getAllUniforms();dt.log(4,`Writing to uniform buffer ${String(e)}`,c,d)()}return o}}class Dn{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}}class Hv{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Uo extends Dn{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Wo extends Dn{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}}class Wm extends Dn{constructor(e,t,r){super(e,r),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}}class Ba extends Dn{constructor(e,t,r,o){super(e,r),this.format=t,this.access=o}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}var No;(i=>{i[i.Uniform=0]="Uniform",i[i.Storage=1]="Storage",i[i.Texture=2]="Texture",i[i.Sampler=3]="Sampler",i[i.StorageTexture=4]="StorageTexture"})(No||(No={}));class nf{constructor(e,t,r,o,c,d,a){this.name=e,this.type=t,this.group=r,this.binding=o,this.attributes=c,this.resourceType=d,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class sC{constructor(e,t){this.name=e,this.type=t}}class oC{constructor(e,t,r,o){this.name=e,this.type=t,this.locationType=r,this.location=o,this.interpolation=null}}class Zv{constructor(e,t,r,o){this.name=e,this.type=t,this.locationType=r,this.location=o}}class aC{constructor(e,t,r,o){this.name=e,this.type=t,this.attributes=r,this.id=o}}class lC{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r}}class cC{constructor(e,t=null,r){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=r}}class uC{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}function hC(i){var e=(32768&i)>>15,t=(31744&i)>>10,r=1023&i;return t==0?(e?-1:1)*Math.pow(2,-14)*(r/Math.pow(2,10)):t==31?r?NaN:1/0*(e?-1:1):(e?-1:1)*Math.pow(2,t-15)*(1+r/Math.pow(2,10))}const jw=new Float32Array(1),dC=new Int32Array(jw.buffer),Fr=new Uint16Array(1);function fC(i){jw[0]=i;const e=dC[0],t=e>>31&1;let r=e>>23&255,o=8388607&e;if(r===255)return Fr[0]=t<<15|31744|(o!==0?512:0),Fr[0];if(r===0){if(o===0)return Fr[0]=t<<15,Fr[0];o|=8388608;let c=113;for(;!(8388608&o);)o<<=1,c--;return r=127-c,o&=8388607,r>0?(o=(o>>126-r)+(o>>127-r&1),Fr[0]=t<<15|r<<10|o>>13,Fr[0]):(Fr[0]=t<<15,Fr[0])}return r=r-127+15,r>=31?(Fr[0]=t<<15|31744,Fr[0]):r<=0?r<-10?(Fr[0]=t<<15,Fr[0]):(o=(8388608|o)>>1-r,Fr[0]=t<<15|o>>13,Fr[0]):(o>>=13,Fr[0]=t<<15|r<<10|o,Fr[0])}const F_=new Uint32Array(1),$w=new Float32Array(F_.buffer,0,1);function qv(i){const e=112+(i>>6&31)<<23|(63&i)<<17;return F_[0]=e,$w[0]}function pC(i,e,t,r,o,c,d,a,y){const w=r*(d>>=o)*(c>>=o)+t*d+e*a;switch(y){case"r8unorm":return[gi(i,w,"8unorm",1)[0]];case"r8snorm":return[gi(i,w,"8snorm",1)[0]];case"r8uint":return[gi(i,w,"8uint",1)[0]];case"r8sint":return[gi(i,w,"8sint",1)[0]];case"rg8unorm":{const E=gi(i,w,"8unorm",2);return[E[0],E[1]]}case"rg8snorm":{const E=gi(i,w,"8snorm",2);return[E[0],E[1]]}case"rg8uint":{const E=gi(i,w,"8uint",2);return[E[0],E[1]]}case"rg8sint":{const E=gi(i,w,"8sint",2);return[E[0],E[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const E=gi(i,w,"8unorm",4);return[E[0],E[1],E[2],E[3]]}case"rgba8snorm":{const E=gi(i,w,"8snorm",4);return[E[0],E[1],E[2],E[3]]}case"rgba8uint":{const E=gi(i,w,"8uint",4);return[E[0],E[1],E[2],E[3]]}case"rgba8sint":{const E=gi(i,w,"8sint",4);return[E[0],E[1],E[2],E[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const E=gi(i,w,"8unorm",4);return[E[2],E[1],E[0],E[3]]}case"r16uint":return[gi(i,w,"16uint",1)[0]];case"r16sint":return[gi(i,w,"16sint",1)[0]];case"r16float":return[gi(i,w,"16float",1)[0]];case"rg16uint":{const E=gi(i,w,"16uint",2);return[E[0],E[1]]}case"rg16sint":{const E=gi(i,w,"16sint",2);return[E[0],E[1]]}case"rg16float":{const E=gi(i,w,"16float",2);return[E[0],E[1]]}case"rgba16uint":{const E=gi(i,w,"16uint",4);return[E[0],E[1],E[2],E[3]]}case"rgba16sint":{const E=gi(i,w,"16sint",4);return[E[0],E[1],E[2],E[3]]}case"rgba16float":{const E=gi(i,w,"16float",4);return[E[0],E[1],E[2],E[3]]}case"r32uint":return[gi(i,w,"32uint",1)[0]];case"r32sint":return[gi(i,w,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[gi(i,w,"32float",1)[0]];case"rg32uint":{const E=gi(i,w,"32uint",2);return[E[0],E[1]]}case"rg32sint":{const E=gi(i,w,"32sint",2);return[E[0],E[1]]}case"rg32float":{const E=gi(i,w,"32float",2);return[E[0],E[1]]}case"rgba32uint":{const E=gi(i,w,"32uint",4);return[E[0],E[1],E[2],E[3]]}case"rgba32sint":{const E=gi(i,w,"32sint",4);return[E[0],E[1],E[2],E[3]]}case"rgba32float":{const E=gi(i,w,"32float",4);return[E[0],E[1],E[2],E[3]]}case"rg11b10ufloat":{const E=new Uint32Array(i.buffer,w,1)[0],I=(4192256&E)>>11,D=(4290772992&E)>>22;return[qv(2047&E),qv(I),(function(F){const X=112+(F>>5&31)<<23|(31&F)<<18;return F_[0]=X,$w[0]})(D),1]}}return null}function gi(i,e,t,r){const o=[0,0,0,0];for(let c=0;c<r;++c)switch(t){case"8unorm":o[c]=i[e]/255,e++;break;case"8snorm":o[c]=i[e]/255*2-1,e++;break;case"8uint":o[c]=i[e],e++;break;case"8sint":o[c]=i[e]-127,e++;break;case"16uint":o[c]=i[e]|i[e+1]<<8,e+=2;break;case"16sint":o[c]=(i[e]|i[e+1]<<8)-32768,e+=2;break;case"16float":o[c]=hC(i[e]|i[e+1]<<8),e+=2;break;case"32uint":case"32sint":o[c]=i[e]|i[e+1]<<8|i[e+2]<<16|i[e+3]<<24,e+=4;break;case"32float":o[c]=new Float32Array(i.buffer,e,1)[0],e+=4}return o}function yi(i,e,t,r,o){for(let c=0;c<r;++c)switch(t){case"8unorm":i[e]=255*o[c],e++;break;case"8snorm":i[e]=.5*(o[c]+1)*255,e++;break;case"8uint":i[e]=o[c],e++;break;case"8sint":i[e]=o[c]+127,e++;break;case"16uint":new Uint16Array(i.buffer,e,1)[0]=o[c],e+=2;break;case"16sint":new Int16Array(i.buffer,e,1)[0]=o[c],e+=2;break;case"16float":{const d=fC(o[c]);new Uint16Array(i.buffer,e,1)[0]=d,e+=2;break}case"32uint":new Uint32Array(i.buffer,e,1)[0]=o[c],e+=4;break;case"32sint":new Int32Array(i.buffer,e,1)[0]=o[c],e+=4;break;case"32float":new Float32Array(i.buffer,e,1)[0]=o[c],e+=4}return o}const Jg={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class Bn{constructor(){this.id=Bn._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(Yf.instance);for(const r of e)r instanceof Array?this.searchBlock(r,t):r.search(t);t(Kf.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}Bn._id=0;class Yf extends Bn{}Yf.instance=new Yf;class Kf extends Bn{}Kf.instance=new Kf;const Ww=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class Bi extends Bn{constructor(){super()}}class yh extends Bi{constructor(e,t,r,o,c,d){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=r,this.body=o,this.startLine=c,this.endLine=d}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}}class gC extends Bi{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Hw extends Bi{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Hm extends Bi{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Zw extends Bi{constructor(e,t,r,o){super(),this.init=e,this.condition=t,this.increment=r,this.body=o}get astNodeType(){return"for"}search(e){var t,r,o;(t=this.init)===null||t===void 0||t.search(e),(r=this.condition)===null||r===void 0||r.search(e),(o=this.increment)===null||o===void 0||o.search(e),this.searchBlock(this.body,e)}}class to extends Bi{constructor(e,t,r,o,c){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=o,this.value=c}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class B_ extends Bi{constructor(e,t,r){super(),this.attributes=null,this.name=e,this.type=t,this.value=r}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class uh extends Bi{constructor(e,t,r,o,c){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=o,this.value=c}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Tf extends Bi{constructor(e,t,r,o,c){super(),this.attributes=null,this.name=e,this.type=t,this.storage=r,this.access=o,this.value=c}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var nc,ih,Ze,Fe;(i=>{i.increment="++",i.decrement="--"})(nc||(nc={})),(i=>{i.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return i[t]}})(nc||(nc={}));class qw extends Bi{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(i=>{i.assign="=",i.addAssign="+=",i.subtractAssin="-=",i.multiplyAssign="*=",i.divideAssign="/=",i.moduloAssign="%=",i.andAssign="&=",i.orAssign="|=",i.xorAssign="^=",i.shiftLeftAssign="<<=",i.shiftRightAssign=">>="})(ih||(ih={})),(i=>{i.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(ih||(ih={}));class Xw extends Bi{constructor(e,t,r){super(),this.operator=e,this.variable=t,this.value=r}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class N_ extends Bi{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return Ww.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}}class Gw extends Bi{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}search(e){var t;this.searchBlock(this.body,e),(t=this.continuing)===null||t===void 0||t.search(e)}}class Yw extends Bi{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}search(e){e(this);for(const t of this.cases)t.search(e)}}class Kw extends Bi{constructor(e,t,r,o){super(),this.condition=e,this.body=t,this.elseif=r,this.else=o}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Jw extends Bi{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class mC extends Bi{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class _C extends Bi{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Qw extends Bi{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class z_ extends Bi{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class yC extends Bi{constructor(){super()}get astNodeType(){return"discard"}}class e1 extends Bi{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class t1 extends Bi{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class ht extends Bi{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let r=1;r<e.length;++r){const o=ht._priority.get(t.name);ht._priority.get(e[r].name)<o&&(t=e[r])}return t.name==="x32"?ht.i32:t}getTypeName(){return this.name}}ht.x32=new ht("x32"),ht.f32=new ht("f32"),ht.i32=new ht("i32"),ht.u32=new ht("u32"),ht.f16=new ht("f16"),ht.bool=new ht("bool"),ht.void=new ht("void"),ht._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class Xv extends ht{constructor(e){super(e)}}class Qs extends ht{constructor(e,t,r,o){super(e),this.members=t,this.startLine=r,this.endLine=o}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class Ve extends ht{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}Ve.vec2f=new Ve("vec2",ht.f32,null),Ve.vec3f=new Ve("vec3",ht.f32,null),Ve.vec4f=new Ve("vec4",ht.f32,null),Ve.vec2i=new Ve("vec2",ht.i32,null),Ve.vec3i=new Ve("vec3",ht.i32,null),Ve.vec4i=new Ve("vec4",ht.i32,null),Ve.vec2u=new Ve("vec2",ht.u32,null),Ve.vec3u=new Ve("vec3",ht.u32,null),Ve.vec4u=new Ve("vec4",ht.u32,null),Ve.vec2h=new Ve("vec2",ht.f16,null),Ve.vec3h=new Ve("vec3",ht.f16,null),Ve.vec4h=new Ve("vec4",ht.f16,null),Ve.vec2b=new Ve("vec2",ht.bool,null),Ve.vec3b=new Ve("vec3",ht.bool,null),Ve.vec4b=new Ve("vec4",ht.bool,null),Ve.mat2x2f=new Ve("mat2x2",ht.f32,null),Ve.mat2x3f=new Ve("mat2x3",ht.f32,null),Ve.mat2x4f=new Ve("mat2x4",ht.f32,null),Ve.mat3x2f=new Ve("mat3x2",ht.f32,null),Ve.mat3x3f=new Ve("mat3x3",ht.f32,null),Ve.mat3x4f=new Ve("mat3x4",ht.f32,null),Ve.mat4x2f=new Ve("mat4x2",ht.f32,null),Ve.mat4x3f=new Ve("mat4x3",ht.f32,null),Ve.mat4x4f=new Ve("mat4x4",ht.f32,null),Ve.mat2x2h=new Ve("mat2x2",ht.f16,null),Ve.mat2x3h=new Ve("mat2x3",ht.f16,null),Ve.mat2x4h=new Ve("mat2x4",ht.f16,null),Ve.mat3x2h=new Ve("mat3x2",ht.f16,null),Ve.mat3x3h=new Ve("mat3x3",ht.f16,null),Ve.mat3x4h=new Ve("mat3x4",ht.f16,null),Ve.mat4x2h=new Ve("mat4x2",ht.f16,null),Ve.mat4x3h=new Ve("mat4x3",ht.f16,null),Ve.mat4x4h=new Ve("mat4x4",ht.f16,null),Ve.mat2x2i=new Ve("mat2x2",ht.i32,null),Ve.mat2x3i=new Ve("mat2x3",ht.i32,null),Ve.mat2x4i=new Ve("mat2x4",ht.i32,null),Ve.mat3x2i=new Ve("mat3x2",ht.i32,null),Ve.mat3x3i=new Ve("mat3x3",ht.i32,null),Ve.mat3x4i=new Ve("mat3x4",ht.i32,null),Ve.mat4x2i=new Ve("mat4x2",ht.i32,null),Ve.mat4x3i=new Ve("mat4x3",ht.i32,null),Ve.mat4x4i=new Ve("mat4x4",ht.i32,null),Ve.mat2x2u=new Ve("mat2x2",ht.u32,null),Ve.mat2x3u=new Ve("mat2x3",ht.u32,null),Ve.mat2x4u=new Ve("mat2x4",ht.u32,null),Ve.mat3x2u=new Ve("mat3x2",ht.u32,null),Ve.mat3x3u=new Ve("mat3x3",ht.u32,null),Ve.mat3x4u=new Ve("mat3x4",ht.u32,null),Ve.mat4x2u=new Ve("mat4x2",ht.u32,null),Ve.mat4x3u=new Ve("mat4x3",ht.u32,null),Ve.mat4x4u=new Ve("mat4x4",ht.u32,null);class Sf extends ht{constructor(e,t,r,o){super(e),this.storage=t,this.type=r,this.access=o}get astNodeType(){return"pointer"}}class hh extends ht{constructor(e,t,r,o){super(e),this.attributes=t,this.format=r,this.count=o}get astNodeType(){return"array"}get isArray(){return!0}}class rh extends ht{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"sampler"}}class is extends Bn{constructor(){super(),this.postfix=null}}class Na extends is{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class bs extends is{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class U_ extends is{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return Ww.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class xn extends is{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class i1 extends is{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const r=e.evalExpression(this.initializer,e.context);return r!==null&&this.postfix?r.getSubData(e,this.postfix,e.context):r}return null}search(e){this.initializer.search(e)}}class _r extends is{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof Le}get isVector(){return this.value instanceof de||this.value instanceof jt}get scalarValue(){return this.value instanceof Le?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof de||this.value instanceof jt?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class r1 extends is{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class pc extends is{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class n1 extends is{constructor(){super()}}class cr extends n1{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Yn extends n1{constructor(e,t,r){super(),this.operator=e,this.left=t,this.right=r}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?ht.f32:e.name==="u32"||t.name==="u32"?ht.u32:ht.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class s1 extends Bn{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}}class Ef extends is{constructor(){super()}get astNodeType(){return"default"}}class o1 extends s1{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class a1 extends s1{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class Gv extends Bn{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"argument"}}class xC extends Bn{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Yv extends Bn{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"member"}}class l1 extends Bn{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class Fn{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=Fn._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,r,o){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,r){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}Fn._id=0;class Zm extends Fn{constructor(){super(new Dn("void",null),null)}toString(){return"void"}}Zm.void=new Zm;class ec extends Fn{constructor(e){super(new Wm("pointer",e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,r,o){this.reference.setDataValue(e,t,r,o)}getSubData(e,t,r){return t?this.reference.getSubData(e,t,r):this}toString(){return`&${this.reference.toString()}`}}class Le extends Fn{constructor(e,t,r=null){super(t,r),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name==="x32"?e-Math.floor(e)!==0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([e]):this.typeInfo.name==="u32"?this.data=new Uint32Array([e]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new Le(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new Le(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new Le(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,r,o){if(r)return void console.error("SetDataValue: Scalar data does not support postfix",r);if(!(t instanceof Le))return void console.error("SetDataValue: Invalid value",t);let c=t.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?c=Math.floor(c):this.typeInfo.name==="bool"&&(c=c?1:0),this.data[0]=c}getSubData(e,t,r){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function vC(i,e,t){const r=e.length;return r===2?t==="f32"?new de(new Float32Array(e),i.getTypeInfo("vec2f")):t==="i32"||t==="bool"?new de(new Int32Array(e),i.getTypeInfo("vec2i")):t==="u32"?new de(new Uint32Array(e),i.getTypeInfo("vec2u")):t==="f16"?new de(new Float32Array(e),i.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${t}`),null):r===3?t==="f32"?new de(new Float32Array(e),i.getTypeInfo("vec3f")):t==="i32"||t==="bool"?new de(new Int32Array(e),i.getTypeInfo("vec3i")):t==="u32"?new de(new Uint32Array(e),i.getTypeInfo("vec3u")):t==="f16"?new de(new Float32Array(e),i.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${t}`),null):r===4?t==="f32"?new de(new Float32Array(e),i.getTypeInfo("vec4f")):t==="i32"||t==="bool"?new de(new Int32Array(e),i.getTypeInfo("vec4i")):t==="u32"?new de(new Uint32Array(e),i.getTypeInfo("vec4u")):t==="f16"?new de(new Float32Array(e),i.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${t}`),null):(console.error(`getSubData: Invalid vector size ${e.length}`),null)}class de extends Fn{constructor(e,t,r=null){if(super(t,r),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const o=this.typeInfo.name;o==="vec2f"||o==="vec3f"||o==="vec4f"?this.data=new Float32Array(e):o==="vec2i"||o==="vec3i"||o==="vec4i"?this.data=new Int32Array(e):o==="vec2u"||o==="vec3u"||o==="vec4u"?this.data=new Uint32Array(e):o==="vec2h"||o==="vec3h"||o==="vec4h"?this.data=new Float32Array(e):o==="vec2b"||o==="vec3b"||o==="vec4b"?this.data=new Int32Array(e):o==="vec2"||o==="vec3"||o==="vec4"?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${o}`)}}clone(){if(this.data instanceof Float32Array)return new de(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new de(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new de(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,r,o){r instanceof Na?console.error("TODO: Set vector postfix"):t instanceof de?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,r){if(t===null)return this;let o=e.getTypeInfo("f32");if(this.typeInfo instanceof Ba)o=this.typeInfo.format||o;else{const d=this.typeInfo.name;d==="vec2f"||d==="vec3f"||d==="vec4f"?o=e.getTypeInfo("f32"):d==="vec2i"||d==="vec3i"||d==="vec4i"?o=e.getTypeInfo("i32"):d==="vec2b"||d==="vec3b"||d==="vec4b"?o=e.getTypeInfo("bool"):d==="vec2u"||d==="vec3u"||d==="vec4u"?o=e.getTypeInfo("u32"):d==="vec2h"||d==="vec3h"||d==="vec4h"?o=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${d}`)}let c=this;for(;t!==null&&c!==null;){if(t instanceof pc){const d=t.index;let a=-1;if(d instanceof _r){if(!(d.value instanceof Le))return console.error(`GetSubData: Invalid array index ${d.value}`),null;a=d.value.value}else{const y=e.evalExpression(d,r);if(!(y instanceof Le))return console.error("GetSubData: Unknown index type",d),null;a=y.value}if(a<0||a>=c.data.length)return console.error("GetSubData: Index out of range",a),null;if(c.data instanceof Float32Array){const y=new Float32Array(c.data.buffer,c.data.byteOffset+4*a,1);return new Le(y,o)}if(c.data instanceof Int32Array){const y=new Int32Array(c.data.buffer,c.data.byteOffset+4*a,1);return new Le(y,o)}if(c.data instanceof Uint32Array){const y=new Uint32Array(c.data.buffer,c.data.byteOffset+4*a,1);return new Le(y,o)}throw"GetSubData: Invalid data type"}if(!(t instanceof Na))return console.error("GetSubData: Unknown postfix",t),null;{const d=t.value.toLowerCase();if(d.length===1){let y=0;if(d==="x"||d==="r")y=0;else if(d==="y"||d==="g")y=1;else if(d==="z"||d==="b")y=2;else{if(d!=="w"&&d!=="a")return console.error(`GetSubData: Unknown member ${d}`),null;y=3}if(this.data instanceof Float32Array){let w=new Float32Array(this.data.buffer,this.data.byteOffset+4*y,1);return new Le(w,o,this)}if(this.data instanceof Int32Array){let w=new Int32Array(this.data.buffer,this.data.byteOffset+4*y,1);return new Le(w,o,this)}if(this.data instanceof Uint32Array){let w=new Uint32Array(this.data.buffer,this.data.byteOffset+4*y,1);return new Le(w,o,this)}}const a=[];for(const y of d)y==="x"||y==="r"?a.push(this.data[0]):y==="y"||y==="g"?a.push(this.data[1]):y==="z"||y==="b"?a.push(this.data[2]):y==="w"||y==="a"?a.push(this.data[3]):console.error(`GetDataValue: Unknown member ${y}`);c=vC(e,a,o.name)}t=t.postfix}return c}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class jt extends Fn{constructor(e,t,r=null){super(t,r),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new jt(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,r,o){r instanceof Na?console.error("TODO: Set matrix postfix"):t instanceof jt?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,r){if(t===null)return this;const o=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof Ba)this.typeInfo.format;else if(o.endsWith("f"))e.getTypeInfo("f32");else if(o.endsWith("i"))e.getTypeInfo("i32");else if(o.endsWith("u"))e.getTypeInfo("u32");else{if(!o.endsWith("h"))return console.error(`GetDataValue: Unknown type ${o}`),null;e.getTypeInfo("f16")}if(t instanceof pc){const c=t.index;let d=-1;if(c instanceof _r){if(!(c.value instanceof Le))return console.error(`GetDataValue: Invalid array index ${c.value}`),null;d=c.value.value}else{const w=e.evalExpression(c,r);if(!(w instanceof Le))return console.error("GetDataValue: Unknown index type",c),null;d=w.value}if(d<0||d>=this.data.length)return console.error("GetDataValue: Index out of range",d),null;const a=o.endsWith("h")?"h":"f";let y;if(o==="mat2x2"||o==="mat2x2f"||o==="mat2x2h"||o==="mat3x2"||o==="mat3x2f"||o==="mat3x2h"||o==="mat4x2"||o==="mat4x2f"||o==="mat4x2h")y=new de(new Float32Array(this.data.buffer,this.data.byteOffset+2*d*4,2),e.getTypeInfo(`vec2${a}`));else if(o==="mat2x3"||o==="mat2x3f"||o==="mat2x3h"||o==="mat3x3"||o==="mat3x3f"||o==="mat3x3h"||o==="mat4x3"||o==="mat4x3f"||o==="mat4x3h")y=new de(new Float32Array(this.data.buffer,this.data.byteOffset+3*d*4,3),e.getTypeInfo(`vec3${a}`));else{if(o!=="mat2x4"&&o!=="mat2x4f"&&o!=="mat2x4h"&&o!=="mat3x4"&&o!=="mat3x4f"&&o!=="mat3x4h"&&o!=="mat4x4"&&o!=="mat4x4f"&&o!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${o}`),null;y=new de(new Float32Array(this.data.buffer,this.data.byteOffset+4*d*4,4),e.getTypeInfo(`vec4${a}`))}return t.postfix?y.getSubData(e,t.postfix,r):y}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class Zi extends Fn{constructor(e,t,r=0,o=null){super(t,o),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=r}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new Zi(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,r,o){if(t===null)return void console.log("setDataValue: NULL data.");let c=this.offset,d=this.typeInfo;for(;r;){if(r instanceof pc)if(d instanceof Wo){const a=r.index;if(a instanceof _r){if(!(a.value instanceof Le))return void console.error(`SetDataValue: Invalid index type ${a.value}`);c+=a.value.value*d.stride}else{const y=e.evalExpression(a,o);if(!(y instanceof Le))return void console.error("SetDataValue: Unknown index type",a);c+=y.value*d.stride}d=d.format}else console.error(`SetDataValue: Type ${d.getTypeName()} is not an array`);else{if(!(r instanceof Na))return void console.error("SetDataValue: Unknown postfix type",r);{const a=r.value;if(d instanceof Uo){let y=!1;for(const w of d.members)if(w.name===a){c+=w.offset,d=w.type,y=!0;break}if(!y)return void console.error(`SetDataValue: Member ${a} not found`)}else if(d instanceof Dn){const y=d.getTypeName();let w=0;if(a==="x"||a==="r")w=0;else if(a==="y"||a==="g")w=1;else if(a==="z"||a==="b")w=2;else{if(a!=="w"&&a!=="a")return void console.error(`SetDataValue: Unknown member ${a}`);w=3}if(!(t instanceof Le))return void console.error("SetDataValue: Invalid value",t);const E=t.value;return y==="vec2f"?void(new Float32Array(this.buffer,c,2)[w]=E):y==="vec3f"?void(new Float32Array(this.buffer,c,3)[w]=E):y==="vec4f"?void(new Float32Array(this.buffer,c,4)[w]=E):y==="vec2i"?void(new Int32Array(this.buffer,c,2)[w]=E):y==="vec3i"?void(new Int32Array(this.buffer,c,3)[w]=E):y==="vec4i"?void(new Int32Array(this.buffer,c,4)[w]=E):y==="vec2u"?void(new Uint32Array(this.buffer,c,2)[w]=E):y==="vec3u"?void(new Uint32Array(this.buffer,c,3)[w]=E):y==="vec4u"?void(new Uint32Array(this.buffer,c,4)[w]=E):void console.error(`SetDataValue: Type ${y} is not a struct`)}}}r=r.postfix}this.setData(e,t,d,c,o)}setData(e,t,r,o,c){const d=r.getTypeName();if(d!=="f32"&&d!=="f16")if(d!=="i32"&&d!=="atomic<i32>"&&d!=="x32")if(d!=="u32"&&d!=="atomic<u32>")if(d!=="bool"){if(d==="vec2f"||d==="vec2h"){const a=new Float32Array(this.buffer,o,2);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(d==="vec3f"||d==="vec3h"){const a=new Float32Array(this.buffer,o,3);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(d==="vec4f"||d==="vec4h"){const a=new Float32Array(this.buffer,o,4);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(d==="vec2i"){const a=new Int32Array(this.buffer,o,2);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(d==="vec3i"){const a=new Int32Array(this.buffer,o,3);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(d==="vec4i"){const a=new Int32Array(this.buffer,o,4);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(d==="vec2u"){const a=new Uint32Array(this.buffer,o,2);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(d==="vec3u"){const a=new Uint32Array(this.buffer,o,3);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(d==="vec4u"){const a=new Uint32Array(this.buffer,o,4);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(d==="vec2b"){const a=new Uint32Array(this.buffer,o,2);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(d==="vec3b"){const a=new Uint32Array(this.buffer,o,3);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(d==="vec4b"){const a=new Uint32Array(this.buffer,o,4);return void(t instanceof de?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(d==="mat2x2f"||d==="mat2x2h"){const a=new Float32Array(this.buffer,o,4);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(d==="mat2x3f"||d==="mat2x3h"){const a=new Float32Array(this.buffer,o,6);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5]))}if(d==="mat2x4f"||d==="mat2x4h"){const a=new Float32Array(this.buffer,o,8);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7]))}if(d==="mat3x2f"||d==="mat3x2h"){const a=new Float32Array(this.buffer,o,6);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5]))}if(d==="mat3x3f"||d==="mat3x3h"){const a=new Float32Array(this.buffer,o,9);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8]))}if(d==="mat3x4f"||d==="mat3x4h"){const a=new Float32Array(this.buffer,o,12);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11]))}if(d==="mat4x2f"||d==="mat4x2h"){const a=new Float32Array(this.buffer,o,8);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7]))}if(d==="mat4x3f"||d==="mat4x3h"){const a=new Float32Array(this.buffer,o,12);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11]))}if(d==="mat4x4f"||d==="mat4x4h"){const a=new Float32Array(this.buffer,o,16);return void(t instanceof jt?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11],a[12]=t.data[12],a[13]=t.data[13],a[14]=t.data[14],a[15]=t.data[15]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11],a[12]=t[12],a[13]=t[13],a[14]=t[14],a[15]=t[15]))}if(t instanceof Zi){if(r===t.typeInfo)return void new Uint8Array(this.buffer,o,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",d,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${d}`)}else t instanceof Le&&(new Int32Array(this.buffer,o,1)[0]=t.value);else t instanceof Le&&(new Uint32Array(this.buffer,o,1)[0]=t.value);else t instanceof Le&&(new Int32Array(this.buffer,o,1)[0]=t.value);else t instanceof Le&&(new Float32Array(this.buffer,o,1)[0]=t.value)}getSubData(e,t,r){var o,c,d;if(t===null)return this;let a=this.offset,y=this.typeInfo;for(;t;){if(t instanceof pc){const E=t.index,I=E instanceof is?e.evalExpression(E,r):E;let D=0;if(I instanceof Le?D=I.value:typeof I=="number"?D=I:console.error("GetDataValue: Invalid index type",E),y instanceof Wo)a+=D*y.stride,y=y.format;else{const F=y.getTypeName();F==="mat4x4"||F==="mat4x4f"||F==="mat4x4h"?(a+=16*D,y=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${y.getTypeName()} is not an array`)}}else{if(!(t instanceof Na))return console.error("GetDataValue: Unknown postfix type",t),null;{const E=t.value;if(y instanceof Uo){let I=!1;for(const D of y.members)if(D.name===E){a+=D.offset,y=D.type,I=!0;break}if(!I)return console.error(`GetDataValue: Member ${E} not found`),null}else if(y instanceof Dn){const I=y.getTypeName();if(I==="vec2f"||I==="vec3f"||I==="vec4f"||I==="vec2i"||I==="vec3i"||I==="vec4i"||I==="vec2u"||I==="vec3u"||I==="vec4u"||I==="vec2b"||I==="vec3b"||I==="vec4b"||I==="vec2h"||I==="vec3h"||I==="vec4h"||I==="vec2"||I==="vec3"||I==="vec4"){if(E.length>0&&E.length<5){let D="f";const F=[];for(let X=0;X<E.length;++X){const oe=E[X].toLowerCase();let _e=0;if(oe==="x"||oe==="r")_e=0;else if(oe==="y"||oe==="g")_e=1;else if(oe==="z"||oe==="b")_e=2;else{if(oe!=="w"&&oe!=="a")return console.error(`Unknown member ${E}`),null;_e=3}if(E.length===1){if(I.endsWith("f"))return this.buffer.byteLength<a+4*_e+4?(console.log("Insufficient buffer data"),null):new Le(new Float32Array(this.buffer,a+4*_e,1),e.getTypeInfo("f32"),this);if(I.endsWith("h"))return new Le(new Float32Array(this.buffer,a+4*_e,1),e.getTypeInfo("f16"),this);if(I.endsWith("i"))return new Le(new Int32Array(this.buffer,a+4*_e,1),e.getTypeInfo("i32"),this);if(I.endsWith("b"))return new Le(new Int32Array(this.buffer,a+4*_e,1),e.getTypeInfo("bool"),this);if(I.endsWith("u"))return new Le(new Uint32Array(this.buffer,a+4*_e,1),e.getTypeInfo("i32"),this)}if(I==="vec2f")F.push(new Float32Array(this.buffer,a,2)[_e]);else if(I==="vec3f"){if(a+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const ge=new Float32Array(this.buffer,a,3);F.push(ge[_e])}else if(I==="vec4f")F.push(new Float32Array(this.buffer,a,4)[_e]);else if(I==="vec2i")D="i",F.push(new Int32Array(this.buffer,a,2)[_e]);else if(I==="vec3i")D="i",F.push(new Int32Array(this.buffer,a,3)[_e]);else if(I==="vec4i")D="i",F.push(new Int32Array(this.buffer,a,4)[_e]);else if(I==="vec2u"){D="u";const ge=new Uint32Array(this.buffer,a,2);F.push(ge[_e])}else I==="vec3u"?(D="u",F.push(new Uint32Array(this.buffer,a,3)[_e])):I==="vec4u"&&(D="u",F.push(new Uint32Array(this.buffer,a,4)[_e]))}return F.length===2?y=e.getTypeInfo(`vec2${D}`):F.length===3?y=e.getTypeInfo(`vec3${D}`):F.length===4?y=e.getTypeInfo(`vec4${D}`):console.error(`GetDataValue: Invalid vector length ${F.length}`),new de(F,y,null)}return console.error(`GetDataValue: Unknown member ${E}`),null}return console.error(`GetDataValue: Type ${I} is not a struct`),null}}}t=t.postfix}const w=y.getTypeName();return w==="f32"?new Le(new Float32Array(this.buffer,a,1),y,this):w==="i32"?new Le(new Int32Array(this.buffer,a,1),y,this):w==="u32"?new Le(new Uint32Array(this.buffer,a,1),y,this):w==="vec2f"?new de(new Float32Array(this.buffer,a,2),y,this):w==="vec3f"?new de(new Float32Array(this.buffer,a,3),y,this):w==="vec4f"?new de(new Float32Array(this.buffer,a,4),y,this):w==="vec2i"?new de(new Int32Array(this.buffer,a,2),y,this):w==="vec3i"?new de(new Int32Array(this.buffer,a,3),y,this):w==="vec4i"?new de(new Int32Array(this.buffer,a,4),y,this):w==="vec2u"?new de(new Uint32Array(this.buffer,a,2),y,this):w==="vec3u"?new de(new Uint32Array(this.buffer,a,3),y,this):w==="vec4u"?new de(new Uint32Array(this.buffer,a,4),y,this):y instanceof Ba&&y.name==="atomic"?((o=y.format)===null||o===void 0?void 0:o.name)==="u32"?new Le(new Uint32Array(this.buffer,a,1)[0],y.format,this):((c=y.format)===null||c===void 0?void 0:c.name)==="i32"?new Le(new Int32Array(this.buffer,a,1)[0],y.format,this):(console.error(`GetDataValue: Invalid atomic format ${(d=y.format)===null||d===void 0?void 0:d.name}`),null):new Zi(this.buffer,y,a,this)}toString(){let e="";if(this.typeInfo instanceof Wo)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let r=1;r<t.length;++r)e+=`, ${t[r]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let r=1;r<t.length/2;++r)e+=`, [${t[2*r]}, ${t[2*r+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let r=4;r<t.length;r+=4)e+=`, [${t[r]}, ${t[r+1]}, ${t[r+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let r=4;r<t.length;r+=4)e+=`, [${t[r]}, ${t[r+1]}, ${t[r+2]}, ${t[r+3]}]`}else e="[...]";else this.typeInfo instanceof Uo?e+="{...}":e="[...]";return e}}class eo extends Fn{constructor(e,t,r,o){super(t,null),this.data=e,this.descriptor=r,this.view=o}clone(){return new eo(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>0?(e=r[0])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.width)!==null&&t!==void 0?t:0}get height(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>1?(e=r[1])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.height)!==null&&t!==void 0?t:0}get depthOrArrayLayers(){var e,t;const r=this.descriptor.size;return r instanceof Array&&r.length>2?(e=r[2])!==null&&e!==void 0?e:0:r instanceof Object&&(t=r.depthOrArrayLayers)!==null&&t!==void 0?t:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!==null&&e!==void 0?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!==null&&e!==void 0?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!==null&&e!==void 0?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!==null&&e!==void 0?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let r=0;r<t.length;++r)t[r]=Math.max(1,t[r]>>e);return t}get texelByteSize(){const e=this.format,t=Jg[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=Jg[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=Jg[e],r=this.width;if(!e||r<=0||!t)return-1;const o=this.height,c=this.depthOrArrayLayers,d=this.dimension;return r/t.blockWidth*(d==="1d"?1:o/t.blockHeight)*t.bytesPerBlock*c}getPixel(e,t,r=0,o=0){const c=this.texelByteSize,d=this.bytesPerRow,a=this.height,y=this.data[o];return pC(new Uint8Array(y),e,t,r,o,a,d,c,this.format)}setPixel(e,t,r,o,c){const d=this.texelByteSize,a=this.bytesPerRow,y=this.height,w=this.data[o];(function(E,I,D,F,X,oe,_e,ge,fe,Te){const ke=F*(_e>>=X)*(oe>>=X)+D*_e+I*ge;switch(fe){case"r8unorm":return void yi(E,ke,"8unorm",1,Te);case"r8snorm":return void yi(E,ke,"8snorm",1,Te);case"r8uint":return void yi(E,ke,"8uint",1,Te);case"r8sint":return void yi(E,ke,"8sint",1,Te);case"rg8unorm":return void yi(E,ke,"8unorm",2,Te);case"rg8snorm":return void yi(E,ke,"8snorm",2,Te);case"rg8uint":return void yi(E,ke,"8uint",2,Te);case"rg8sint":return void yi(E,ke,"8sint",2,Te);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void yi(E,ke,"8unorm",4,Te);case"rgba8snorm":return void yi(E,ke,"8snorm",4,Te);case"rgba8uint":return void yi(E,ke,"8uint",4,Te);case"rgba8sint":return void yi(E,ke,"8sint",4,Te);case"r16uint":return void yi(E,ke,"16uint",1,Te);case"r16sint":return void yi(E,ke,"16sint",1,Te);case"r16float":return void yi(E,ke,"16float",1,Te);case"rg16uint":return void yi(E,ke,"16uint",2,Te);case"rg16sint":return void yi(E,ke,"16sint",2,Te);case"rg16float":return void yi(E,ke,"16float",2,Te);case"rgba16uint":return void yi(E,ke,"16uint",4,Te);case"rgba16sint":return void yi(E,ke,"16sint",4,Te);case"rgba16float":return void yi(E,ke,"16float",4,Te);case"r32uint":return void yi(E,ke,"32uint",1,Te);case"r32sint":return void yi(E,ke,"32sint",1,Te);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void yi(E,ke,"32float",1,Te);case"rg32uint":return void yi(E,ke,"32uint",2,Te);case"rg32sint":return void yi(E,ke,"32sint",2,Te);case"rg32float":return void yi(E,ke,"32float",2,Te);case"rgba32uint":return void yi(E,ke,"32uint",4,Te);case"rgba32sint":return void yi(E,ke,"32sint",4,Te);case"rgba32float":return void yi(E,ke,"32float",4,Te);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(w),e,t,r,o,y,a,d,this.format,c)}}(i=>{i[i.token=0]="token",i[i.keyword=1]="keyword",i[i.reserved=2]="reserved"})(Fe||(Fe={}));class Be{constructor(e,t,r){this.name=e,this.type=t,this.rule=r}toString(){return this.name}}class re{}Ze=re,re.none=new Be("",Fe.reserved,""),re.eof=new Be("EOF",Fe.token,""),re.reserved={asm:new Be("asm",Fe.reserved,"asm"),bf16:new Be("bf16",Fe.reserved,"bf16"),do:new Be("do",Fe.reserved,"do"),enum:new Be("enum",Fe.reserved,"enum"),f16:new Be("f16",Fe.reserved,"f16"),f64:new Be("f64",Fe.reserved,"f64"),handle:new Be("handle",Fe.reserved,"handle"),i8:new Be("i8",Fe.reserved,"i8"),i16:new Be("i16",Fe.reserved,"i16"),i64:new Be("i64",Fe.reserved,"i64"),mat:new Be("mat",Fe.reserved,"mat"),premerge:new Be("premerge",Fe.reserved,"premerge"),regardless:new Be("regardless",Fe.reserved,"regardless"),typedef:new Be("typedef",Fe.reserved,"typedef"),u8:new Be("u8",Fe.reserved,"u8"),u16:new Be("u16",Fe.reserved,"u16"),u64:new Be("u64",Fe.reserved,"u64"),unless:new Be("unless",Fe.reserved,"unless"),using:new Be("using",Fe.reserved,"using"),vec:new Be("vec",Fe.reserved,"vec"),void:new Be("void",Fe.reserved,"void")},re.keywords={array:new Be("array",Fe.keyword,"array"),atomic:new Be("atomic",Fe.keyword,"atomic"),bool:new Be("bool",Fe.keyword,"bool"),f32:new Be("f32",Fe.keyword,"f32"),i32:new Be("i32",Fe.keyword,"i32"),mat2x2:new Be("mat2x2",Fe.keyword,"mat2x2"),mat2x3:new Be("mat2x3",Fe.keyword,"mat2x3"),mat2x4:new Be("mat2x4",Fe.keyword,"mat2x4"),mat3x2:new Be("mat3x2",Fe.keyword,"mat3x2"),mat3x3:new Be("mat3x3",Fe.keyword,"mat3x3"),mat3x4:new Be("mat3x4",Fe.keyword,"mat3x4"),mat4x2:new Be("mat4x2",Fe.keyword,"mat4x2"),mat4x3:new Be("mat4x3",Fe.keyword,"mat4x3"),mat4x4:new Be("mat4x4",Fe.keyword,"mat4x4"),ptr:new Be("ptr",Fe.keyword,"ptr"),sampler:new Be("sampler",Fe.keyword,"sampler"),sampler_comparison:new Be("sampler_comparison",Fe.keyword,"sampler_comparison"),struct:new Be("struct",Fe.keyword,"struct"),texture_1d:new Be("texture_1d",Fe.keyword,"texture_1d"),texture_2d:new Be("texture_2d",Fe.keyword,"texture_2d"),texture_2d_array:new Be("texture_2d_array",Fe.keyword,"texture_2d_array"),texture_3d:new Be("texture_3d",Fe.keyword,"texture_3d"),texture_cube:new Be("texture_cube",Fe.keyword,"texture_cube"),texture_cube_array:new Be("texture_cube_array",Fe.keyword,"texture_cube_array"),texture_multisampled_2d:new Be("texture_multisampled_2d",Fe.keyword,"texture_multisampled_2d"),texture_storage_1d:new Be("texture_storage_1d",Fe.keyword,"texture_storage_1d"),texture_storage_2d:new Be("texture_storage_2d",Fe.keyword,"texture_storage_2d"),texture_storage_2d_array:new Be("texture_storage_2d_array",Fe.keyword,"texture_storage_2d_array"),texture_storage_3d:new Be("texture_storage_3d",Fe.keyword,"texture_storage_3d"),texture_depth_2d:new Be("texture_depth_2d",Fe.keyword,"texture_depth_2d"),texture_depth_2d_array:new Be("texture_depth_2d_array",Fe.keyword,"texture_depth_2d_array"),texture_depth_cube:new Be("texture_depth_cube",Fe.keyword,"texture_depth_cube"),texture_depth_cube_array:new Be("texture_depth_cube_array",Fe.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new Be("texture_depth_multisampled_2d",Fe.keyword,"texture_depth_multisampled_2d"),texture_external:new Be("texture_external",Fe.keyword,"texture_external"),u32:new Be("u32",Fe.keyword,"u32"),vec2:new Be("vec2",Fe.keyword,"vec2"),vec3:new Be("vec3",Fe.keyword,"vec3"),vec4:new Be("vec4",Fe.keyword,"vec4"),bitcast:new Be("bitcast",Fe.keyword,"bitcast"),block:new Be("block",Fe.keyword,"block"),break:new Be("break",Fe.keyword,"break"),case:new Be("case",Fe.keyword,"case"),continue:new Be("continue",Fe.keyword,"continue"),continuing:new Be("continuing",Fe.keyword,"continuing"),default:new Be("default",Fe.keyword,"default"),diagnostic:new Be("diagnostic",Fe.keyword,"diagnostic"),discard:new Be("discard",Fe.keyword,"discard"),else:new Be("else",Fe.keyword,"else"),enable:new Be("enable",Fe.keyword,"enable"),fallthrough:new Be("fallthrough",Fe.keyword,"fallthrough"),false:new Be("false",Fe.keyword,"false"),fn:new Be("fn",Fe.keyword,"fn"),for:new Be("for",Fe.keyword,"for"),function:new Be("function",Fe.keyword,"function"),if:new Be("if",Fe.keyword,"if"),let:new Be("let",Fe.keyword,"let"),const:new Be("const",Fe.keyword,"const"),loop:new Be("loop",Fe.keyword,"loop"),while:new Be("while",Fe.keyword,"while"),private:new Be("private",Fe.keyword,"private"),read:new Be("read",Fe.keyword,"read"),read_write:new Be("read_write",Fe.keyword,"read_write"),return:new Be("return",Fe.keyword,"return"),requires:new Be("requires",Fe.keyword,"requires"),storage:new Be("storage",Fe.keyword,"storage"),switch:new Be("switch",Fe.keyword,"switch"),true:new Be("true",Fe.keyword,"true"),alias:new Be("alias",Fe.keyword,"alias"),type:new Be("type",Fe.keyword,"type"),uniform:new Be("uniform",Fe.keyword,"uniform"),var:new Be("var",Fe.keyword,"var"),override:new Be("override",Fe.keyword,"override"),workgroup:new Be("workgroup",Fe.keyword,"workgroup"),write:new Be("write",Fe.keyword,"write"),r8unorm:new Be("r8unorm",Fe.keyword,"r8unorm"),r8snorm:new Be("r8snorm",Fe.keyword,"r8snorm"),r8uint:new Be("r8uint",Fe.keyword,"r8uint"),r8sint:new Be("r8sint",Fe.keyword,"r8sint"),r16uint:new Be("r16uint",Fe.keyword,"r16uint"),r16sint:new Be("r16sint",Fe.keyword,"r16sint"),r16float:new Be("r16float",Fe.keyword,"r16float"),rg8unorm:new Be("rg8unorm",Fe.keyword,"rg8unorm"),rg8snorm:new Be("rg8snorm",Fe.keyword,"rg8snorm"),rg8uint:new Be("rg8uint",Fe.keyword,"rg8uint"),rg8sint:new Be("rg8sint",Fe.keyword,"rg8sint"),r32uint:new Be("r32uint",Fe.keyword,"r32uint"),r32sint:new Be("r32sint",Fe.keyword,"r32sint"),r32float:new Be("r32float",Fe.keyword,"r32float"),rg16uint:new Be("rg16uint",Fe.keyword,"rg16uint"),rg16sint:new Be("rg16sint",Fe.keyword,"rg16sint"),rg16float:new Be("rg16float",Fe.keyword,"rg16float"),rgba8unorm:new Be("rgba8unorm",Fe.keyword,"rgba8unorm"),rgba8unorm_srgb:new Be("rgba8unorm_srgb",Fe.keyword,"rgba8unorm_srgb"),rgba8snorm:new Be("rgba8snorm",Fe.keyword,"rgba8snorm"),rgba8uint:new Be("rgba8uint",Fe.keyword,"rgba8uint"),rgba8sint:new Be("rgba8sint",Fe.keyword,"rgba8sint"),bgra8unorm:new Be("bgra8unorm",Fe.keyword,"bgra8unorm"),bgra8unorm_srgb:new Be("bgra8unorm_srgb",Fe.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new Be("rgb10a2unorm",Fe.keyword,"rgb10a2unorm"),rg11b10float:new Be("rg11b10float",Fe.keyword,"rg11b10float"),rg32uint:new Be("rg32uint",Fe.keyword,"rg32uint"),rg32sint:new Be("rg32sint",Fe.keyword,"rg32sint"),rg32float:new Be("rg32float",Fe.keyword,"rg32float"),rgba16uint:new Be("rgba16uint",Fe.keyword,"rgba16uint"),rgba16sint:new Be("rgba16sint",Fe.keyword,"rgba16sint"),rgba16float:new Be("rgba16float",Fe.keyword,"rgba16float"),rgba32uint:new Be("rgba32uint",Fe.keyword,"rgba32uint"),rgba32sint:new Be("rgba32sint",Fe.keyword,"rgba32sint"),rgba32float:new Be("rgba32float",Fe.keyword,"rgba32float"),static_assert:new Be("static_assert",Fe.keyword,"static_assert")},re.tokens={decimal_float_literal:new Be("decimal_float_literal",Fe.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new Be("hex_float_literal",Fe.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new Be("int_literal",Fe.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new Be("uint_literal",Fe.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new Be("name",Fe.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new Be("ident",Fe.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new Be("and",Fe.token,"&"),and_and:new Be("and_and",Fe.token,"&&"),arrow:new Be("arrow ",Fe.token,"->"),attr:new Be("attr",Fe.token,"@"),forward_slash:new Be("forward_slash",Fe.token,"/"),bang:new Be("bang",Fe.token,"!"),bracket_left:new Be("bracket_left",Fe.token,"["),bracket_right:new Be("bracket_right",Fe.token,"]"),brace_left:new Be("brace_left",Fe.token,"{"),brace_right:new Be("brace_right",Fe.token,"}"),colon:new Be("colon",Fe.token,":"),comma:new Be("comma",Fe.token,","),equal:new Be("equal",Fe.token,"="),equal_equal:new Be("equal_equal",Fe.token,"=="),not_equal:new Be("not_equal",Fe.token,"!="),greater_than:new Be("greater_than",Fe.token,">"),greater_than_equal:new Be("greater_than_equal",Fe.token,">="),shift_right:new Be("shift_right",Fe.token,">>"),less_than:new Be("less_than",Fe.token,"<"),less_than_equal:new Be("less_than_equal",Fe.token,"<="),shift_left:new Be("shift_left",Fe.token,"<<"),modulo:new Be("modulo",Fe.token,"%"),minus:new Be("minus",Fe.token,"-"),minus_minus:new Be("minus_minus",Fe.token,"--"),period:new Be("period",Fe.token,"."),plus:new Be("plus",Fe.token,"+"),plus_plus:new Be("plus_plus",Fe.token,"++"),or:new Be("or",Fe.token,"|"),or_or:new Be("or_or",Fe.token,"||"),paren_left:new Be("paren_left",Fe.token,"("),paren_right:new Be("paren_right",Fe.token,")"),semicolon:new Be("semicolon",Fe.token,";"),star:new Be("star",Fe.token,"*"),tilde:new Be("tilde",Fe.token,"~"),underscore:new Be("underscore",Fe.token,"_"),xor:new Be("xor",Fe.token,"^"),plus_equal:new Be("plus_equal",Fe.token,"+="),minus_equal:new Be("minus_equal",Fe.token,"-="),times_equal:new Be("times_equal",Fe.token,"*="),division_equal:new Be("division_equal",Fe.token,"/="),modulo_equal:new Be("modulo_equal",Fe.token,"%="),and_equal:new Be("and_equal",Fe.token,"&="),or_equal:new Be("or_equal",Fe.token,"|="),xor_equal:new Be("xor_equal",Fe.token,"^="),shift_right_equal:new Be("shift_right_equal",Fe.token,">>="),shift_left_equal:new Be("shift_left_equal",Fe.token,"<<=")},re.simpleTokens={"@":Ze.tokens.attr,"{":Ze.tokens.brace_left,"}":Ze.tokens.brace_right,":":Ze.tokens.colon,",":Ze.tokens.comma,"(":Ze.tokens.paren_left,")":Ze.tokens.paren_right,";":Ze.tokens.semicolon},re.literalTokens={"&":Ze.tokens.and,"&&":Ze.tokens.and_and,"->":Ze.tokens.arrow,"/":Ze.tokens.forward_slash,"!":Ze.tokens.bang,"[":Ze.tokens.bracket_left,"]":Ze.tokens.bracket_right,"=":Ze.tokens.equal,"==":Ze.tokens.equal_equal,"!=":Ze.tokens.not_equal,">":Ze.tokens.greater_than,">=":Ze.tokens.greater_than_equal,">>":Ze.tokens.shift_right,"<":Ze.tokens.less_than,"<=":Ze.tokens.less_than_equal,"<<":Ze.tokens.shift_left,"%":Ze.tokens.modulo,"-":Ze.tokens.minus,"--":Ze.tokens.minus_minus,".":Ze.tokens.period,"+":Ze.tokens.plus,"++":Ze.tokens.plus_plus,"|":Ze.tokens.or,"||":Ze.tokens.or_or,"*":Ze.tokens.star,"~":Ze.tokens.tilde,_:Ze.tokens.underscore,"^":Ze.tokens.xor,"+=":Ze.tokens.plus_equal,"-=":Ze.tokens.minus_equal,"*=":Ze.tokens.times_equal,"/=":Ze.tokens.division_equal,"%=":Ze.tokens.modulo_equal,"&=":Ze.tokens.and_equal,"|=":Ze.tokens.or_equal,"^=":Ze.tokens.xor_equal,">>=":Ze.tokens.shift_right_equal,"<<=":Ze.tokens.shift_left_equal},re.regexTokens={decimal_float_literal:Ze.tokens.decimal_float_literal,hex_float_literal:Ze.tokens.hex_float_literal,int_literal:Ze.tokens.int_literal,uint_literal:Ze.tokens.uint_literal,ident:Ze.tokens.ident},re.storage_class=[Ze.keywords.function,Ze.keywords.private,Ze.keywords.workgroup,Ze.keywords.uniform,Ze.keywords.storage],re.access_mode=[Ze.keywords.read,Ze.keywords.write,Ze.keywords.read_write],re.sampler_type=[Ze.keywords.sampler,Ze.keywords.sampler_comparison],re.sampled_texture_type=[Ze.keywords.texture_1d,Ze.keywords.texture_2d,Ze.keywords.texture_2d_array,Ze.keywords.texture_3d,Ze.keywords.texture_cube,Ze.keywords.texture_cube_array],re.multisampled_texture_type=[Ze.keywords.texture_multisampled_2d],re.storage_texture_type=[Ze.keywords.texture_storage_1d,Ze.keywords.texture_storage_2d,Ze.keywords.texture_storage_2d_array,Ze.keywords.texture_storage_3d],re.depth_texture_type=[Ze.keywords.texture_depth_2d,Ze.keywords.texture_depth_2d_array,Ze.keywords.texture_depth_cube,Ze.keywords.texture_depth_cube_array,Ze.keywords.texture_depth_multisampled_2d],re.texture_external_type=[Ze.keywords.texture_external],re.any_texture_type=[...Ze.sampled_texture_type,...Ze.multisampled_texture_type,...Ze.storage_texture_type,...Ze.depth_texture_type,...Ze.texture_external_type],re.texel_format=[Ze.keywords.r8unorm,Ze.keywords.r8snorm,Ze.keywords.r8uint,Ze.keywords.r8sint,Ze.keywords.r16uint,Ze.keywords.r16sint,Ze.keywords.r16float,Ze.keywords.rg8unorm,Ze.keywords.rg8snorm,Ze.keywords.rg8uint,Ze.keywords.rg8sint,Ze.keywords.r32uint,Ze.keywords.r32sint,Ze.keywords.r32float,Ze.keywords.rg16uint,Ze.keywords.rg16sint,Ze.keywords.rg16float,Ze.keywords.rgba8unorm,Ze.keywords.rgba8unorm_srgb,Ze.keywords.rgba8snorm,Ze.keywords.rgba8uint,Ze.keywords.rgba8sint,Ze.keywords.bgra8unorm,Ze.keywords.bgra8unorm_srgb,Ze.keywords.rgb10a2unorm,Ze.keywords.rg11b10float,Ze.keywords.rg32uint,Ze.keywords.rg32sint,Ze.keywords.rg32float,Ze.keywords.rgba16uint,Ze.keywords.rgba16sint,Ze.keywords.rgba16float,Ze.keywords.rgba32uint,Ze.keywords.rgba32sint,Ze.keywords.rgba32float],re.const_literal=[Ze.tokens.int_literal,Ze.tokens.uint_literal,Ze.tokens.decimal_float_literal,Ze.tokens.hex_float_literal,Ze.keywords.true,Ze.keywords.false],re.literal_or_ident=[Ze.tokens.ident,Ze.tokens.int_literal,Ze.tokens.uint_literal,Ze.tokens.decimal_float_literal,Ze.tokens.hex_float_literal,Ze.tokens.name],re.element_count_expression=[Ze.tokens.int_literal,Ze.tokens.uint_literal,Ze.tokens.ident],re.template_types=[Ze.keywords.vec2,Ze.keywords.vec3,Ze.keywords.vec4,Ze.keywords.mat2x2,Ze.keywords.mat2x3,Ze.keywords.mat2x4,Ze.keywords.mat3x2,Ze.keywords.mat3x3,Ze.keywords.mat3x4,Ze.keywords.mat4x2,Ze.keywords.mat4x3,Ze.keywords.mat4x4,Ze.keywords.atomic,Ze.keywords.bitcast,...Ze.any_texture_type],re.attribute_name=[Ze.tokens.ident,Ze.keywords.block,Ze.keywords.diagnostic],re.assignment_operators=[Ze.tokens.equal,Ze.tokens.plus_equal,Ze.tokens.minus_equal,Ze.tokens.times_equal,Ze.tokens.division_equal,Ze.tokens.modulo_equal,Ze.tokens.and_equal,Ze.tokens.or_equal,Ze.tokens.xor_equal,Ze.tokens.shift_right_equal,Ze.tokens.shift_left_equal],re.increment_operators=[Ze.tokens.plus_plus,Ze.tokens.minus_minus];class Kv{constructor(e,t,r,o,c){this.type=e,this.lexeme=t,this.line=r,this.start=o,this.end=c}toString(){return this.lexeme}isTemplateType(){return re.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==re.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class bC{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Kv(re.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let d=1;for(;d>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),d--,d==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),d++)}return!0}}const t=re.simpleTokens[e];if(t)return this._addToken(t),!0;let r=re.none;const o=this._isAlpha(e),c=e==="_";if(this._isAlphaNumeric(e)){let d=this._peekAhead();for(;this._isAlphaNumeric(d);)e+=this._advance(),d=this._peekAhead()}if(o){const d=re.keywords[e];if(d)return this._addToken(d),!0}if(o||c)return this._addToken(re.tokens.ident),!0;for(;;){let d=this._findType(e);const a=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(a=="=")return this._current++,e+=a,this._addToken(re.tokens.minus_equal),!0;if(a=="-")return this._current++,e+=a,this._addToken(re.tokens.minus_minus),!0;const y=this._tokens.length-1;if((re.literal_or_ident.indexOf(this._tokens[y].type)!=-1||this._tokens[y].type==re.tokens.paren_right)&&a!=">")return this._addToken(d),!0}if(e==">"&&(a==">"||a=="=")){let y=!1,w=this._tokens.length-1;for(let E=0;E<5&&w>=0&&re.assignment_operators.indexOf(this._tokens[w].type)===-1;++E,--w)if(this._tokens[w].type===re.tokens.less_than){w>0&&this._tokens[w-1].isArrayOrTemplateType()&&(y=!0);break}if(y)return this._addToken(d),!0}if(d===re.none){let y=e,w=0;const E=2;for(let I=0;I<E;++I)if(y+=this._peekAhead(I),d=this._findType(y),d!==re.none){w=I;break}if(d===re.none)return r!==re.none&&(this._current--,this._addToken(r),!0);e=y,this._current+=w+1}if(r=d,this._isAtEnd())break;e+=this._advance()}return r!==re.none&&(this._addToken(r),!0)}_findType(e){for(const r in re.regexTokens){const o=re.regexTokens[r];if(this._match(e,o.rule))return o}return re.literalTokens[e]||re.none}_match(e,t){const r=t.exec(e);return r&&r.index==0&&r[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!=="_"&&e!=="."&&e!=="("&&e!==")"&&e!=="["&&e!=="]"&&e!=="{"&&e!=="}"&&e!==","&&e!==";"&&e!==":"&&e!=="="&&e!=="!"&&e!=="<"&&e!==">"&&e!=="+"&&e!=="-"&&e!=="*"&&e!=="/"&&e!=="%"&&e!=="&"&&e!=="|"&&e!=="^"&&e!=="~"&&e!=="@"&&e!=="#"&&e!=="?"&&e!=="'"&&e!=="`"&&e!=='"'&&e!=="\\"&&e!==`
`&&e!=="\r"&&e!=="	"&&e!=="\0"}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e==="_"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Kv(e,t,this._line,this._start,this._current))}}function Tt(i){return Array.isArray(i)||i?.buffer instanceof ArrayBuffer}const Jf=new Float32Array(1),wC=new Uint32Array(Jf.buffer),TC=new Uint32Array(Jf.buffer),Qf=new Int32Array(1),SC=new Float32Array(Qf.buffer),EC=new Uint32Array(Qf.buffer),ep=new Uint32Array(1),AC=new Float32Array(ep.buffer),PC=new Int32Array(ep.buffer);function Jv(i,e,t){if(e===t)return i;if(e==="f32"){if(t==="i32"||t==="x32")return Jf[0]=i,wC[0];if(t==="u32")return Jf[0]=i,TC[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return Qf[0]=i,SC[0];if(t==="u32")return Qf[0]=i,EC[0]}else if(e==="u32"){if(t==="f32")return ep[0]=i,AC[0];if(t==="i32"||t==="x32")return ep[0]=i,PC[0]}return console.error(`Unsupported cast from ${e} to ${t}`),i}class CC{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class sf{constructor(e,t){this.align=e,this.size=t}}class Ss{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new uC,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof yh&&this._functions.set(t.name,new CC(t));for(const t of e)if(t instanceof Qs){const r=this.getTypeInfo(t,null);r instanceof Uo&&this.structs.push(r)}for(const t of e)if(t instanceof z_)this.aliases.push(this._getAliasInfo(t));else{if(t instanceof B_){const r=t,o=this._getAttributeNum(r.attributes,"id",0),c=r.type!=null?this.getTypeInfo(r.type,r.attributes):null;this.overrides.push(new aC(r.name,c,r.attributes,o));continue}if(this._isUniformVar(t)){const r=t,o=this._getAttributeNum(r.attributes,"group",0),c=this._getAttributeNum(r.attributes,"binding",0),d=this.getTypeInfo(r.type,r.attributes),a=new nf(r.name,d,o,c,r.attributes,No.Uniform,r.access);a.access||(a.access="read"),this.uniforms.push(a);continue}if(this._isStorageVar(t)){const r=t,o=this._getAttributeNum(r.attributes,"group",0),c=this._getAttributeNum(r.attributes,"binding",0),d=this.getTypeInfo(r.type,r.attributes),a=this._isStorageTexture(d),y=new nf(r.name,d,o,c,r.attributes,a?No.StorageTexture:No.Storage,r.access);y.access||(y.access="read"),this.storage.push(y);continue}if(this._isTextureVar(t)){const r=t,o=this._getAttributeNum(r.attributes,"group",0),c=this._getAttributeNum(r.attributes,"binding",0),d=this.getTypeInfo(r.type,r.attributes),a=this._isStorageTexture(d),y=new nf(r.name,d,o,c,r.attributes,a?No.StorageTexture:No.Texture,r.access);y.access||(y.access="read"),a?this.storage.push(y):this.textures.push(y);continue}if(this._isSamplerVar(t)){const r=t,o=this._getAttributeNum(r.attributes,"group",0),c=this._getAttributeNum(r.attributes,"binding",0),d=this.getTypeInfo(r.type,r.attributes),a=new nf(r.name,d,o,c,r.attributes,No.Sampler,r.access);this.samplers.push(a);continue}}for(const t of e)if(t instanceof yh){const r=this._getAttribute(t,"vertex"),o=this._getAttribute(t,"fragment"),c=this._getAttribute(t,"compute"),d=r||o||c,a=new cC(t.name,d?.name,t.attributes);a.attributes=t.attributes,a.startLine=t.startLine,a.endLine=t.endLine,this.functions.push(a),this._functions.get(t.name).info=a,d&&(this._functions.get(t.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(t,!!d),a.inputs=this._getInputs(t.args),a.outputs=this._getOutputs(t.returnType),this.entry[d.name].push(a)),a.arguments=t.args.map(y=>new lC(y.name,this.getTypeInfo(y.type,y.attributes),y.attributes)),a.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null;continue}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(r=>{var o,c,d;if(r instanceof l1){if(r.value)if(Tt(r.value))for(const a of r.value)for(const y of this.overrides)a===y.name&&((o=t.info)===null||o===void 0||o.overrides.push(y));else for(const a of this.overrides)r.value===a.name&&((c=t.info)===null||c===void 0||c.overrides.push(a))}else if(r instanceof xn)for(const a of this.overrides)r.name===a.name&&((d=t.info)===null||d===void 0||d.overrides.push(a))});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getFunctionInfo(e){for(const t of this.functions)if(t.name==e)return t;return null}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var r;for(const o of e.calls){const c=(r=this._functions.get(o.name))===null||r===void 0?void 0:r.info;c&&t.add(c)}}findResource(e,t,r){if(r){for(const o of this.entry.compute)if(o.name===r){for(const c of o.resources)if(c.group==e&&c.binding==t)return c}for(const o of this.entry.vertex)if(o.name===r){for(const c of o.resources)if(c.group==e&&c.binding==t)return c}for(const o of this.entry.fragment)if(o.name===r){for(const c of o.resources)if(c.group==e&&c.binding==t)return c}}for(const o of this.uniforms)if(o.group==e&&o.binding==t)return o;for(const o of this.storage)if(o.group==e&&o.binding==t)return o;for(const o of this.textures)if(o.group==e&&o.binding==t)return o;for(const o of this.samplers)if(o.group==e&&o.binding==t)return o;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const r=[],o=this,c=[];return e.search(d=>{if(d instanceof Yf)c.push({});else if(d instanceof Kf)c.pop();else if(d instanceof to){const a=d;t&&a.type!==null&&this._markStructsFromAST(a.type),c.length>0&&(c[c.length-1][a.name]=a)}else if(d instanceof bs){const a=d;t&&a.type!==null&&this._markStructsFromAST(a.type)}else if(d instanceof uh){const a=d;t&&a.type!==null&&this._markStructsFromAST(a.type),c.length>0&&(c[c.length-1][a.name]=a)}else if(d instanceof xn){const a=d;if(c.length>0&&c[c.length-1][a.name])return;const y=o._findResource(a.name);y&&r.push(y)}else if(d instanceof U_){const a=d,y=o._functions.get(a.name);y&&(t&&(y.inUse=!0),e.calls.add(y.node),y.resources===null&&(y.resources=o._findResources(y.node,t)),r.push(...y.resources))}else if(d instanceof N_){const a=d,y=o._functions.get(a.name);y&&(t&&(y.inUse=!0),e.calls.add(y.node),y.resources===null&&(y.resources=o._findResources(y.node,t)),r.push(...y.resources))}}),[...new Map(r.map(d=>[d.name,d])).values()]}getBindGroups(){const e=[];function t(r,o){r>=e.length&&(e.length=r+1),e[r]===void 0&&(e[r]=[]),o>=e[r].length&&(e[r].length=o+1)}for(const r of this.uniforms)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.storage)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.textures)t(r.group,r.binding),e[r.group][r.binding]=r;for(const r of this.samplers)t(r.group,r.binding),e[r.group][r.binding]=r;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof Qs)this._getStructOutputs(e,t);else{const r=this._getOutputInfo(e);r!==null&&t.push(r)}return t}_getStructOutputs(e,t){for(const r of e.members)if(r.type instanceof Qs)this._getStructOutputs(r.type,t);else{const o=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(o!==null){const c=this.getTypeInfo(r.type,r.type.attributes),d=this._parseInt(o.value),a=new Zv(r.name,c,o.name,d);t.push(a)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this.getTypeInfo(e,e.attributes),o=this._parseInt(t.value);return new Zv("",r,t.name,o)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const r of e)if(r.type instanceof Qs)this._getStructInputs(r.type,t);else{const o=this._getInputInfo(r);o!==null&&t.push(o)}return t}_getStructInputs(e,t){for(const r of e.members)if(r.type instanceof Qs)this._getStructInputs(r.type,t);else{const o=this._getInputInfo(r);o!==null&&t.push(o)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const r=this._getAttribute(e,"interpolation"),o=this.getTypeInfo(e.type,e.attributes),c=this._parseInt(t.value),d=new oC(e.name,o,t.name,c);return r!==null&&(d.interpolation=this._parseString(r.value)),d}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new sC(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Sf){const o=e.type?this.getTypeInfo(e.type,e.attributes):null,c=new Wm(e.name,o,t);return this._types.set(e,c),this._updateTypeInfo(c),c}if(e instanceof hh){const o=e,c=o.format?this.getTypeInfo(o.format,o.attributes):null,d=new Wo(o.name,t);return d.format=c,d.count=o.count,this._types.set(e,d),this._updateTypeInfo(d),d}if(e instanceof Qs){const o=e,c=new Uo(o.name,t);c.startLine=o.startLine,c.endLine=o.endLine;for(const d of o.members){const a=this.getTypeInfo(d.type,d.attributes);c.members.push(new Hv(d.name,a,d.attributes))}return this._types.set(e,c),this._updateTypeInfo(c),c}if(e instanceof rh){const o=e,c=o.format instanceof ht,d=o.format?c?this.getTypeInfo(o.format,null):new Dn(o.format,null):null,a=new Ba(o.name,d,t,o.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof Ve){const o=e,c=o.format?this.getTypeInfo(o.format,null):null,d=new Ba(o.name,c,t,o.access);return this._types.set(e,d),this._updateTypeInfo(d),d}const r=new Dn(e.name,t);return this._types.set(e,r),this._updateTypeInfo(r),r}_updateTypeInfo(e){var t,r,o;const c=this._getTypeSize(e);if(e.size=(t=c?.size)!==null&&t!==void 0?t:0,e instanceof Wo&&e.format){const d=this._getTypeSize(e.format);e.stride=Math.max((r=d?.size)!==null&&r!==void 0?r:0,(o=d?.align)!==null&&o!==void 0?o:0),this._updateTypeInfo(e.format)}e instanceof Wm&&this._updateTypeInfo(e.format),e instanceof Uo&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let r=0,o=0,c=0,d=0;for(let a=0,y=e.members.length;a<y;++a){const w=e.members[a],E=this._getTypeSize(w);if(!E)continue;(t=this._getAlias(w.type.name))!==null&&t!==void 0||w.type;const I=E.align,D=E.size;r=this._roundUp(I,r+o),o=D,c=r,d=Math.max(d,I),w.offset=r,w.size=D,this._updateTypeInfo(w.type)}e.size=this._roundUp(d,c+o),e.align=d}_getTypeSize(e){var t,r;if(e==null)return null;const o=this._getAttributeNum(e.attributes,"size",0),c=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Hv&&(e=e.type),e instanceof Dn){const d=this._getAlias(e.name);d!==null&&(e=d)}{const d=Ss._typeInfo[e.name];if(d!==void 0){const a=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new sf(Math.max(c,d.align/a),Math.max(o,d.size/a))}}{const d=Ss._typeInfo[e.name.substring(0,e.name.length-1)];if(d){const a=e.name[e.name.length-1]==="h"?2:1;return new sf(Math.max(c,d.align/a),Math.max(o,d.size/a))}}if(e instanceof Wo){let d=e,a=8,y=8;const w=this._getTypeSize(d.format);return w!==null&&(y=w.size,a=w.align),y=d.count*this._getAttributeNum((r=e?.attributes)!==null&&r!==void 0?r:null,"stride",this._roundUp(a,y)),o&&(y=o),new sf(Math.max(c,a),Math.max(o,y))}if(e instanceof Uo){let d=0,a=0,y=0,w=0,E=0;for(const I of e.members){const D=this._getTypeSize(I.type);D!==null&&(d=Math.max(D.align,d),y=this._roundUp(D.align,y+w),w=D.size,E=y)}return a=this._roundUp(d,E+w),new sf(Math.max(c,d),Math.max(o,a))}return null}_isUniformVar(e){return e instanceof to&&e.storage=="uniform"}_isStorageVar(e){return e instanceof to&&e.storage=="storage"}_isTextureVar(e){return e instanceof to&&e.type!==null&&Ss._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof to&&e.type!==null&&Ss._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const r=e;if(!r||!r.attributes)return null;const o=r.attributes;for(let c of o)if(c.name==t)return c;return null}_getAttributeNum(e,t,r){if(e===null)return r;for(let o of e)if(o.name==t){let c=o!==null&&o.value!==null?o.value:r;return c instanceof Array&&(c=c[0]),typeof c=="number"?c:typeof c=="string"?parseInt(c):r}return r}_roundUp(e,t){return Math.ceil(t/e)*e}}Ss._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Ss._textureTypes=re.any_texture_type.map(i=>i.name),Ss._samplerTypes=re.sampler_type.map(i=>i.name);let V_=0;class j_{constructor(e,t,r){this.id=V_++,this.name=e,this.value=t,this.node=r}clone(){return new j_(this.name,this.value,this.node)}}class $_{constructor(e){this.id=V_++,this.name=e.name,this.node=e}clone(){return new $_(this.node)}}class W_{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=V_++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,r){this.variables.set(e,new j_(e,t,r??null))}setVariable(e,t,r){const o=this.getVariable(e);o!==null?o.value=t:this.createVariable(e,t,r)}getVariableValue(e){var t;const r=this.getVariable(e);return(t=r?.value)!==null&&t!==void 0?t:null}clone(){return new W_(this)}}class IC{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class MC{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const r=this.exec.evalExpression(e.args[0],t);let o=!0;if(r instanceof de)return r.data.forEach(c=>{c||(o=!1)}),new Le(o?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de){const o=r.data.some(c=>c);return new Le(o?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const r=this.exec.evalExpression(e.args[2],t);if(!(r instanceof Le))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return r.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.evalExpression(r,t);if(o instanceof Zi&&o.typeInfo.size===0){const c=o.typeInfo,d=o.buffer.byteLength/c.stride;return new Le(d,this.getTypeInfo("u32"))}return new Le(o.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.abs(c)),r.typeInfo);const o=r;return new Le(Math.abs(o.value),o.typeInfo)}Acos(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.acos(c)),r.typeInfo);const o=r;return new Le(Math.acos(o.value),r.typeInfo)}Acosh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.acosh(c)),r.typeInfo);const o=r;return new Le(Math.acosh(o.value),r.typeInfo)}Asin(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.asin(c)),r.typeInfo);const o=r;return new Le(Math.asin(o.value),r.typeInfo)}Asinh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.asinh(c)),r.typeInfo);const o=r;return new Le(Math.asinh(o.value),r.typeInfo)}Atan(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.atan(c)),r.typeInfo);const o=r;return new Le(Math.atan(o.value),r.typeInfo)}Atanh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.atanh(c)),r.typeInfo);const o=r;return new Le(Math.atanh(o.value),r.typeInfo)}Atan2(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof de&&o instanceof de)return new de(r.data.map((a,y)=>Math.atan2(a,o.data[y])),r.typeInfo);const c=r,d=o;return new Le(Math.atan2(c.value,d.value),r.typeInfo)}Ceil(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.ceil(c)),r.typeInfo);const o=r;return new Le(Math.ceil(o.value),r.typeInfo)}_clamp(e,t,r){return Math.min(Math.max(e,t),r)}Clamp(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof de&&o instanceof de&&c instanceof de)return new de(r.data.map((w,E)=>this._clamp(w,o.data[E],c.data[E])),r.typeInfo);const d=r,a=o,y=c;return new Le(this._clamp(d.value,a.value,y.value),r.typeInfo)}Cos(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.cos(c)),r.typeInfo);const o=r;return new Le(Math.cos(o.value),r.typeInfo)}Cosh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.cosh(c)),r.typeInfo);const o=r;return new Le(Math.cos(o.value),r.typeInfo)}CountLeadingZeros(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.clz32(c)),r.typeInfo);const o=r;return new Le(Math.clz32(o.value),r.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>this._countOneBits(c)),r.typeInfo);const o=r;return new Le(this._countOneBits(o.value),r.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>this._countTrailingZeros(c)),r.typeInfo);const o=r;return new Le(this._countTrailingZeros(o.value),r.typeInfo)}Cross(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof de&&o instanceof de){if(r.data.length!==3||o.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const c=r.data,d=o.data;return new de([c[1]*d[2]-d[1]*c[2],c[2]*d[0]-d[2]*c[0],c[0]*d[1]-d[0]*c[1]],r.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const r=this.exec.evalExpression(e.args[0],t),o=180/Math.PI;return r instanceof de?new de(r.data.map(c=>c*o),r.typeInfo):new Le(r.value*o,this.getTypeInfo("f32"))}Determinant(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof jt){const o=r.data,c=r.typeInfo.getTypeName(),d=c.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(c==="mat2x2"||c==="mat2x2f"||c==="mat2x2h")return new Le(o[0]*o[3]-o[1]*o[2],d);if(c==="mat2x3"||c==="mat2x3f"||c==="mat2x3h")return new Le(o[0]*(o[4]*o[8]-o[5]*o[7])-o[1]*(o[3]*o[8]-o[5]*o[6])+o[2]*(o[3]*o[7]-o[4]*o[6]),d);if(c==="mat2x4"||c==="mat2x4f"||c==="mat2x4h")console.error(`TODO: Determinant for ${c}`);else if(c==="mat3x2"||c==="mat3x2f"||c==="mat3x2h")console.error(`TODO: Determinant for ${c}`);else{if(c==="mat3x3"||c==="mat3x3f"||c==="mat3x3h")return new Le(o[0]*(o[4]*o[8]-o[5]*o[7])-o[1]*(o[3]*o[8]-o[5]*o[6])+o[2]*(o[3]*o[7]-o[4]*o[6]),d);c==="mat3x4"||c==="mat3x4f"||c==="mat3x4h"||c==="mat4x2"||c==="mat4x2f"||c==="mat4x2h"||c==="mat4x3"||c==="mat4x3f"||c==="mat4x3h"?console.error(`TODO: Determinant for ${c}`):c!=="mat4x4"&&c!=="mat4x4f"&&c!=="mat4x4h"||console.error(`TODO: Determinant for ${c}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof de&&o instanceof de){let a=0;for(let y=0;y<r.data.length;++y)a+=(r.data[y]-o.data[y])*(r.data[y]-o.data[y]);return new Le(Math.sqrt(a),this.getTypeInfo("f32"))}const c=r,d=o;return new Le(Math.abs(c.value-d.value),r.typeInfo)}_dot(e,t){let r=0;for(let o=0;o<e.length;++o)r+=t[o]*e[o];return r}Dot(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);return r instanceof de&&o instanceof de?new Le(this._dot(r.data,o.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.exp(c)),r.typeInfo);const o=r;return new Le(Math.exp(o.value),r.typeInfo)}Exp2(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.pow(2,c)),r.typeInfo);const o=r;return new Le(Math.pow(2,o.value),r.typeInfo)}ExtractBits(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(o.typeInfo.name!=="u32"&&o.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(c.typeInfo.name!=="u32"&&c.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const d=o.value,a=c.value;if(r instanceof de)return new de(r.data.map(w=>w>>d&(1<<a)-1),r.typeInfo);if(r.typeInfo.name!=="i32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const y=r.value;return new Le(y>>d&(1<<a)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof de&&o instanceof de&&c instanceof de){const d=this._dot(o.data,c.data);return new de(d<0?Array.from(r.data):r.data.map(a=>-a),r.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>this._firstLeadingBit(c)),r.typeInfo);const o=r;return new Le(this._firstLeadingBit(o.value),r.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>this._firstTrailingBit(c)),r.typeInfo);const o=r;return new Le(this._firstTrailingBit(o.value),r.typeInfo)}Floor(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.floor(c)),r.typeInfo);const o=r;return new Le(Math.floor(o.value),r.typeInfo)}Fma(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof de&&o instanceof de&&c instanceof de)return r.data.length!==o.data.length||r.data.length!==c.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new de(r.data.map((w,E)=>w*o.data[E]+c.data[E]),r.typeInfo);const d=r,a=o,y=c;return new Le(d.value*a.value+y.value,d.typeInfo)}Fract(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>c-Math.floor(c)),r.typeInfo);const o=r;return new Le(o.value-Math.floor(o.value),r.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t),d=this.exec.evalExpression(e.args[3],t);if(c.typeInfo.name!=="u32"&&c.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const a=c.value,y=(1<<d.value)-1<<a,w=~y;if(r instanceof de&&o instanceof de)return new de(r.data.map((D,F)=>D&w|o.data[F]<<a&y),r.typeInfo);const E=r.value,I=o.value;return new Le(E&w|I<<a&y,r.typeInfo)}InverseSqrt(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>1/Math.sqrt(c)),r.typeInfo);const o=r;return new Le(1/Math.sqrt(o.value),r.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de){let c=0;return r.data.forEach(d=>{c+=d*d}),new Le(Math.sqrt(c),this.getTypeInfo("f32"))}const o=r;return new Le(Math.abs(o.value),r.typeInfo)}Log(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.log(c)),r.typeInfo);const o=r;return new Le(Math.log(o.value),r.typeInfo)}Log2(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.log2(c)),r.typeInfo);const o=r;return new Le(Math.log2(o.value),r.typeInfo)}Max(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof de&&o instanceof de)return new de(r.data.map((a,y)=>Math.max(a,o.data[y])),r.typeInfo);const c=r,d=o;return new Le(Math.max(c.value,d.value),r.typeInfo)}Min(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof de&&o instanceof de)return new de(r.data.map((a,y)=>Math.min(a,o.data[y])),r.typeInfo);const c=r,d=o;return new Le(Math.min(c.value,d.value),r.typeInfo)}Mix(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof de&&o instanceof de&&c instanceof de)return new de(r.data.map((y,w)=>r.data[w]*(1-c.data[w])+o.data[w]*c.data[w]),r.typeInfo);const d=o,a=c;return new Le(r.value*(1-a.value)+d.value*a.value,r.typeInfo)}Modf(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof de&&o instanceof de)return new de(r.data.map((d,a)=>d%o.data[a]),r.typeInfo);const c=o;return new Le(r.value%c.value,r.typeInfo)}Normalize(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de){const o=this.Length(e,t).value;return new de(r.data.map(c=>c/o),r.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof de&&o instanceof de)return new de(r.data.map((a,y)=>Math.pow(a,o.data[y])),r.typeInfo);const c=r,d=o;return new Le(Math.pow(c.value,d.value),r.typeInfo)}QuantizeToF16(e,t){const r=this.exec.evalExpression(e.args[0],t);return r instanceof de?new de(r.data.map(o=>o),r.typeInfo):new Le(r.value,r.typeInfo)}Radians(e,t){const r=this.exec.evalExpression(e.args[0],t);return r instanceof de?new de(r.data.map(o=>o*Math.PI/180),r.typeInfo):new Le(r.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(r instanceof de&&o instanceof de){const c=this._dot(r.data,o.data);return new de(r.data.map((d,a)=>d-2*c*o.data[a]),r.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(r instanceof de&&o instanceof de&&c instanceof Le){const d=this._dot(o.data,r.data);return new de(r.data.map((a,y)=>{const w=1-c.value*c.value*(1-d*d);if(w<0)return 0;const E=Math.sqrt(w);return c.value*a-(c.value*d+E)*o.data[y]}),r.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.round(c)),r.typeInfo);const o=r;return new Le(Math.round(o.value),r.typeInfo)}Saturate(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.min(Math.max(c,0),1)),r.typeInfo);const o=r;return new Le(Math.min(Math.max(o.value,0),1),r.typeInfo)}Sign(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.sign(c)),r.typeInfo);const o=r;return new Le(Math.sign(o.value),r.typeInfo)}Sin(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.sin(c)),r.typeInfo);const o=r;return new Le(Math.sin(o.value),r.typeInfo)}Sinh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.sinh(c)),r.typeInfo);const o=r;return new Le(Math.sinh(o.value),r.typeInfo)}_smoothstep(e,t,r){const o=Math.min(Math.max((r-e)/(t-e),0),1);return o*o*(3-2*o)}SmoothStep(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t),c=this.exec.evalExpression(e.args[2],t);if(c instanceof de&&r instanceof de&&o instanceof de)return new de(c.data.map((w,E)=>this._smoothstep(r.data[E],o.data[E],w)),c.typeInfo);const d=r,a=o,y=c;return new Le(this._smoothstep(d.value,a.value,y.value),c.typeInfo)}Sqrt(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.sqrt(c)),r.typeInfo);const o=r;return new Le(Math.sqrt(o.value),r.typeInfo)}Step(e,t){const r=this.exec.evalExpression(e.args[0],t),o=this.exec.evalExpression(e.args[1],t);if(o instanceof de&&r instanceof de)return new de(o.data.map((d,a)=>d<r.data[a]?0:1),o.typeInfo);const c=r;return new Le(o.value<c.value?0:1,c.typeInfo)}Tan(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.tan(c)),r.typeInfo);const o=r;return new Le(Math.tan(o.value),r.typeInfo)}Tanh(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.tanh(c)),r.typeInfo);const o=r;return new Le(Math.tanh(o.value),r.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const r=this.exec.evalExpression(e.args[0],t);if(!(r instanceof jt))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const o=this._getTransposeType(r.typeInfo);if(r.typeInfo.name==="mat2x2"||r.typeInfo.name==="mat2x2f"||r.typeInfo.name==="mat2x2h"){const c=r.data;return new jt([c[0],c[2],c[1],c[3]],o)}if(r.typeInfo.name==="mat2x3"||r.typeInfo.name==="mat2x3f"||r.typeInfo.name==="mat2x3h"){const c=r.data;return new jt([c[0],c[3],c[6],c[1],c[4],c[7]],o)}if(r.typeInfo.name==="mat2x4"||r.typeInfo.name==="mat2x4f"||r.typeInfo.name==="mat2x4h"){const c=r.data;return new jt([c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13]],o)}if(r.typeInfo.name==="mat3x2"||r.typeInfo.name==="mat3x2f"||r.typeInfo.name==="mat3x2h"){const c=r.data;return new jt([c[0],c[3],c[1],c[4],c[2],c[5]],o)}if(r.typeInfo.name==="mat3x3"||r.typeInfo.name==="mat3x3f"||r.typeInfo.name==="mat3x3h"){const c=r.data;return new jt([c[0],c[3],c[6],c[1],c[4],c[7],c[2],c[5],c[8]],o)}if(r.typeInfo.name==="mat3x4"||r.typeInfo.name==="mat3x4f"||r.typeInfo.name==="mat3x4h"){const c=r.data;return new jt([c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13],c[2],c[6],c[10],c[14]],o)}if(r.typeInfo.name==="mat4x2"||r.typeInfo.name==="mat4x2f"||r.typeInfo.name==="mat4x2h"){const c=r.data;return new jt([c[0],c[4],c[1],c[5],c[2],c[6]],o)}if(r.typeInfo.name==="mat4x3"||r.typeInfo.name==="mat4x3f"||r.typeInfo.name==="mat4x3h"){const c=r.data;return new jt([c[0],c[4],c[8],c[1],c[5],c[9],c[2],c[6],c[10]],o)}if(r.typeInfo.name==="mat4x4"||r.typeInfo.name==="mat4x4f"||r.typeInfo.name==="mat4x4h"){const c=r.data;return new jt([c[0],c[4],c[8],c[12],c[1],c[5],c[9],c[13],c[2],c[6],c[10],c[14],c[3],c[7],c[11],c[15]],o)}return console.error(`Invalid matrix type ${r.typeInfo.name}`),null}Trunc(e,t){const r=this.exec.evalExpression(e.args[0],t);if(r instanceof de)return new de(r.data.map(c=>Math.trunc(c)),r.typeInfo);const o=r;return new Le(Math.trunc(o.value),r.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const r=e.args[0],o=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(r instanceof xn){const c=r.name,d=t.getVariableValue(c);if(d instanceof eo){if(o<0||o>=d.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;const a=d.getMipLevelSize(o),y=d.dimension;return y==="1d"?new Le(a[0],this.getTypeInfo("u32")):y==="3d"?new de(a,this.getTypeInfo("vec3u")):y==="2d"?new de(a.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${y} not found. Line ${e.line}`),null)}return console.error(`Texture ${c} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const r=e.args[0],o=this.exec.evalExpression(e.args[1],t),c=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(o instanceof de)||o.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(r instanceof xn){const d=r.name,a=t.getVariableValue(d);if(a instanceof eo){const y=Math.floor(o.data[0]),w=Math.floor(o.data[1]);if(y<0||y>=a.width||w<0||w>=a.height)return console.error(`Texture ${d} out of bounds. Line ${e.line}`),null;const E=a.getPixel(y,w,0,c);return E===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new de(E,this.getTypeInfo("vec4f"))}return console.error(`Texture ${d} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){const r=e.args[0];if(r instanceof xn){const o=r.name,c=t.getVariableValue(o);return c instanceof eo?new Le(c.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${o} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){const r=e.args[0];if(r instanceof xn){const o=r.name,c=t.getVariableValue(o);return c instanceof eo?new Le(c.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${o} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){const r=e.args[0];if(r instanceof xn){const o=r.name,c=t.getVariableValue(o);return c instanceof eo?new Le(c.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${o} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const r=e.args[0],o=this.exec.evalExpression(e.args[1],t),c=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,d=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(d.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(o instanceof de)||o.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(r instanceof xn){const a=r.name,y=t.getVariableValue(a);if(y instanceof eo){const w=y.getMipLevelSize(0),E=Math.floor(o.data[0]),I=Math.floor(o.data[1]);return E<0||E>=w[0]||I<0||I>=w[1]?(console.error(`Texture ${a} out of bounds. Line ${e.line}`),null):(y.setPixel(E,I,0,c,Array.from(d)),null)}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t);return t.getVariable(o).value.getSubData(this.exec,r.postfix,t)}AtomicStore(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t);return y instanceof Le&&a instanceof Le&&(y.value=a.value),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),null}AtomicAdd(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t),w=new Le(y.value,y.typeInfo);return y instanceof Le&&a instanceof Le&&(y.value+=a.value),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),w}AtomicSub(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t),w=new Le(y.value,y.typeInfo);return y instanceof Le&&a instanceof Le&&(y.value-=a.value),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),w}AtomicMax(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t),w=new Le(y.value,y.typeInfo);return y instanceof Le&&a instanceof Le&&(y.value=Math.max(y.value,a.value)),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),w}AtomicMin(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t),w=new Le(y.value,y.typeInfo);return y instanceof Le&&a instanceof Le&&(y.value=Math.min(y.value,a.value)),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),w}AtomicAnd(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t),w=new Le(y.value,y.typeInfo);return y instanceof Le&&a instanceof Le&&(y.value=y.value&a.value),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),w}AtomicOr(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t),w=new Le(y.value,y.typeInfo);return y instanceof Le&&a instanceof Le&&(y.value=y.value|a.value),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),w}AtomicXor(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t),w=new Le(y.value,y.typeInfo);return y instanceof Le&&a instanceof Le&&(y.value=y.value^a.value),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),w}AtomicExchange(e,t){let r=e.args[0];r instanceof cr&&(r=r.right);const o=this.exec.getVariableName(r,t),c=t.getVariable(o);let d=e.args[1];const a=this.exec.evalExpression(d,t),y=c.value.getSubData(this.exec,r.postfix,t),w=new Le(y.value,y.typeInfo);return y instanceof Le&&a instanceof Le&&(y.value=a.value),c.value instanceof Zi&&c.value.setDataValue(this.exec,y,r.postfix,t),w}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}const Qg={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},Zr={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class Br extends IC{constructor(e,t){var r;super(),this.ast=e??[],this.reflection=new Ss,this.reflection.updateAST(this.ast),this.context=(r=t?.clone())!==null&&r!==void 0?r:new W_,this.builtins=new MC(this),this.typeInfo={bool:this.getTypeInfo(ht.bool),i32:this.getTypeInfo(ht.i32),u32:this.getTypeInfo(ht.u32),f32:this.getTypeInfo(ht.f32),f16:this.getTypeInfo(ht.f16),vec2f:this.getTypeInfo(Ve.vec2f),vec2u:this.getTypeInfo(Ve.vec2u),vec2i:this.getTypeInfo(Ve.vec2i),vec2h:this.getTypeInfo(Ve.vec2h),vec3f:this.getTypeInfo(Ve.vec3f),vec3u:this.getTypeInfo(Ve.vec3u),vec3i:this.getTypeInfo(Ve.vec3i),vec3h:this.getTypeInfo(Ve.vec3h),vec4f:this.getTypeInfo(Ve.vec4f),vec4u:this.getTypeInfo(Ve.vec4u),vec4i:this.getTypeInfo(Ve.vec4i),vec4h:this.getTypeInfo(Ve.vec4h),mat2x2f:this.getTypeInfo(Ve.mat2x2f),mat2x3f:this.getTypeInfo(Ve.mat2x3f),mat2x4f:this.getTypeInfo(Ve.mat2x4f),mat3x2f:this.getTypeInfo(Ve.mat3x2f),mat3x3f:this.getTypeInfo(Ve.mat3x3f),mat3x4f:this.getTypeInfo(Ve.mat3x4f),mat4x2f:this.getTypeInfo(Ve.mat4x2f),mat4x3f:this.getTypeInfo(Ve.mat4x3f),mat4x4f:this.getTypeInfo(Ve.mat4x4f)}}getVariableValue(e){var t,r;const o=(r=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&r!==void 0?r:null;if(o===null)return null;if(o instanceof Le)return o.value;if(o instanceof de||o instanceof jt)return Array.from(o.data);if(o instanceof Zi&&o.typeInfo instanceof Wo){if(o.typeInfo.format.name==="u32")return Array.from(new Uint32Array(o.buffer,o.offset,o.typeInfo.count));if(o.typeInfo.format.name==="i32")return Array.from(new Int32Array(o.buffer,o.offset,o.typeInfo.count));if(o.typeInfo.format.name==="f32")return Array.from(new Float32Array(o.buffer,o.offset,o.typeInfo.count))}return console.error(`Unsupported return variable type ${o.typeInfo.name}`),null}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,r,o){const c=this.context.clone();(o=o??{}).constants&&this._setOverrides(o.constants,c),this._execStatements(this.ast,c);const d=c.getFunction(e);if(!d)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const a=t[0],y=t[1],w=t[2],E=this.getTypeInfo("vec3u");c.setVariable("@num_workgroups",new de(t,E));const I=this.reflection.getFunctionInfo(e);I===null&&console.error(`Function ${e} not found in reflection data`);for(const D in r)for(const F in r[D]){const X=r[D][F];c.variables.forEach(oe=>{var _e;const ge=oe.node;if(ge?.attributes){let fe=null,Te=null;for(const ke of ge.attributes)ke.name==="binding"?fe=ke.value:ke.name==="group"&&(Te=ke.value);if(F==fe&&D==Te){let ke=!1;for(const Je of I.resources)if(Je.name===oe.name&&Je.group===parseInt(D)&&Je.binding===parseInt(F)){ke=!0;break}if(ke)if(X.texture!==void 0&&X.descriptor!==void 0){const Je=new eo(X.texture,this.getTypeInfo(ge.type),X.descriptor,(_e=X.texture.view)!==null&&_e!==void 0?_e:null);oe.value=Je}else X.uniform!==void 0?oe.value=new Zi(X.uniform,this.getTypeInfo(ge.type)):oe.value=new Zi(X,this.getTypeInfo(ge.type))}}})}for(let D=0;D<w;++D)for(let F=0;F<y;++F)for(let X=0;X<a;++X)c.setVariable("@workgroup_id",new de([X,F,D],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(d,[X,F,D],c)}execStatement(e,t){if(e instanceof Jw)return this.evalExpression(e.value,t);if(e instanceof e1){if(e.condition){const r=this.evalExpression(e.condition,t);if(!(r instanceof Le))throw new Error("Invalid break-if condition");if(!r.value)return null}return Br._breakObj}if(e instanceof t1)return Br._continueObj;if(e instanceof uh)this._let(e,t);else if(e instanceof to)this._var(e,t);else if(e instanceof Tf)this._const(e,t);else if(e instanceof yh)this._function(e,t);else{if(e instanceof Kw)return this._if(e,t);if(e instanceof Yw)return this._switch(e,t);if(e instanceof Zw)return this._for(e,t);if(e instanceof Hw)return this._while(e,t);if(e instanceof Gw)return this._loop(e,t);if(e instanceof Hm){const r=t.clone();return r.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,r)}if(e instanceof Xw)this._assign(e,t);else if(e instanceof qw)this._increment(e,t);else{if(e instanceof Qs)return null;if(e instanceof B_){const r=e.name;t.getVariable(r)===null&&t.setVariable(r,new Le(0,this.getTypeInfo("u32")))}else if(e instanceof N_)this._call(e,t);else{if(e instanceof Qw||e instanceof z_)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof Yn?this._evalBinaryOp(e,t):e instanceof _r?this._evalLiteral(e,t):e instanceof xn?this._evalVariable(e,t):e instanceof U_?this._evalCall(e,t):e instanceof bs?this._evalCreate(e,t):e instanceof i1?this._evalConst(e,t):e instanceof r1?this._evalBitcast(e,t):e instanceof cr?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof ht){const o=this.reflection.getTypeInfo(e);if(o!==null)return o}let r=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return r!==null||(r=this.reflection.getTypeInfoByName(e)),r}_setOverrides(e,t){for(const r in e){const o=e[r],c=this.reflection.getOverrideInfo(r);c!==null?(c.type===null&&(c.type=this.getTypeInfo("u32")),c.type.name==="u32"||c.type.name==="i32"||c.type.name==="f32"||c.type.name==="f16"?t.setVariable(r,new Le(o,c.type)):c.type.name==="bool"?t.setVariable(r,new Le(o?1:0,c.type)):c.type.name==="vec2"||c.type.name==="vec3"||c.type.name==="vec4"||c.type.name==="vec2f"||c.type.name==="vec3f"||c.type.name==="vec4f"||c.type.name==="vec2i"||c.type.name==="vec3i"||c.type.name==="vec4i"||c.type.name==="vec2u"||c.type.name==="vec3u"||c.type.name==="vec4u"||c.type.name==="vec2h"||c.type.name==="vec3h"||c.type.name==="vec4h"?t.setVariable(r,new de(o,c.type)):console.error(`Invalid constant type for ${r}`)):console.error(`Override ${r} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,r){const o=[1,1,1];for(const E of e.node.attributes)if(E.name==="workgroup_size"){if(E.value.length>0){const I=r.getVariableValue(E.value[0]);o[0]=I instanceof Le?I.value:parseInt(E.value[0])}if(E.value.length>1){const I=r.getVariableValue(E.value[1]);o[1]=I instanceof Le?I.value:parseInt(E.value[1])}if(E.value.length>2){const I=r.getVariableValue(E.value[2]);o[2]=I instanceof Le?I.value:parseInt(E.value[2])}}const c=this.getTypeInfo("vec3u"),d=this.getTypeInfo("u32");r.setVariable("@workgroup_size",new de(o,c));const a=o[0],y=o[1],w=o[2];for(let E=0,I=0;E<w;++E)for(let D=0;D<y;++D)for(let F=0;F<a;++F,++I){const X=[F,D,E],oe=[F+t[0]*o[0],D+t[1]*o[1],E+t[2]*o[2]];r.setVariable("@local_invocation_id",new de(X,c)),r.setVariable("@global_invocation_id",new de(oe,c)),r.setVariable("@local_invocation_index",new Le(I,d)),this._dispatchExec(e,r)}}_dispatchExec(e,t){for(const r of e.node.args)for(const o of r.attributes)if(o.name==="builtin"){const c=`@${o.value}`,d=t.getVariable(c);d!==void 0&&t.variables.set(r.name,d)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof cr;)e=e.right;return e instanceof xn?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const r of e){if(r instanceof Array){const c=t.clone(),d=this._execStatements(r,c);if(d)return d;continue}const o=this.execStatement(r,t);if(o)return o}return null}_call(e,t){const r=t.clone();r.currentFunctionName=e.name;const o=t.getFunction(e.name);if(o){for(let c=0;c<o.node.args.length;++c){const d=o.node.args[c],a=this.evalExpression(e.args[c],r);r.setVariable(d.name,a,d)}this._execStatements(o.node.body,r)}else e.isBuiltin?this._callBuiltinFunction(e,r):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const r=this.getVariableName(e.variable,t),o=t.getVariable(r);o?e.operator==="++"?o.value instanceof Le?o.value.value++:console.error(`Variable ${r} is not a scalar. Line ${e.line}`):e.operator==="--"?o.value instanceof Le?o.value.value--:console.error(`Variable ${r} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${r} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof xn){const r=this.getVariableName(e,t),o=t.getVariable(r);return o===null?(console.error(`Variable ${r} not found. Line ${e.line}`),null):o.value.getSubData(this,e.postfix,t)}if(e instanceof cr){if(e.operator==="*"){const r=this._getVariableData(e.right,t);return r instanceof ec?r.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator==="&"){const r=this._getVariableData(e.right,t);return new ec(r)}}return null}_assign(e,t){let r=null,o="<var>",c=null;if(e.variable instanceof cr){const y=this._getVariableData(e.variable,t),w=this.evalExpression(e.value,t),E=e.operator;if(E==="="){if(y instanceof Le||y instanceof de||y instanceof jt){if(w instanceof Le||w instanceof de||w instanceof jt&&y.data.length===w.data.length)return void y.data.set(w.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(y instanceof Zi&&w instanceof Zi&&y.buffer.byteLength-y.offset>=w.buffer.byteLength-w.offset)return void(y.buffer.byteLength%4==0?new Uint32Array(y.buffer,y.offset,y.typeInfo.size/4).set(new Uint32Array(w.buffer,w.offset,w.typeInfo.size/4)):new Uint8Array(y.buffer,y.offset,y.typeInfo.size).set(new Uint8Array(w.buffer,w.offset,w.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(E==="+=")return y instanceof Le||y instanceof de||y instanceof jt?w instanceof Le||w instanceof de||w instanceof jt?void y.data.set(w.data.map((I,D)=>y.data[D]+I)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(E==="-=")return(y instanceof Le||y instanceof de||y instanceof jt)&&(w instanceof Le||w instanceof de||w instanceof jt)?void y.data.set(w.data.map((I,D)=>y.data[D]-I)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof cr){if(e.variable.operator==="*"){o=this.getVariableName(e.variable.right,t);const y=t.getVariable(o);if(!(y&&y.value instanceof ec))return void console.error(`Variable ${o} is not a pointer. Line ${e.line}`);r=y.value.reference;let w=e.variable.postfix;if(!w){let E=e.variable.right;for(;E instanceof cr;){if(E.postfix){w=E.postfix;break}E=E.right}}w&&(r=r.getSubData(this,w,t))}}else{c=e.variable.postfix,o=this.getVariableName(e.variable,t);const y=t.getVariable(o);if(y===null)return void console.error(`Variable ${o} not found. Line ${e.line}`);r=y.value}if(r instanceof ec&&(r=r.reference),r===null)return void console.error(`Variable ${o} not found. Line ${e.line}`);const d=this.evalExpression(e.value,t),a=e.operator;if(a!=="="){const y=r.getSubData(this,c,t);if(y instanceof de&&d instanceof Le){const w=y.data,E=d.value;if(a==="+=")for(let I=0;I<w.length;++I)w[I]+=E;else if(a==="-=")for(let I=0;I<w.length;++I)w[I]-=E;else if(a==="*=")for(let I=0;I<w.length;++I)w[I]*=E;else if(a==="/=")for(let I=0;I<w.length;++I)w[I]/=E;else if(a==="%=")for(let I=0;I<w.length;++I)w[I]%=E;else if(a==="&=")for(let I=0;I<w.length;++I)w[I]&=E;else if(a==="|=")for(let I=0;I<w.length;++I)w[I]|=E;else if(a==="^=")for(let I=0;I<w.length;++I)w[I]^=E;else if(a==="<<=")for(let I=0;I<w.length;++I)w[I]<<=E;else if(a===">>=")for(let I=0;I<w.length;++I)w[I]>>=E;else console.error(`Invalid operator ${a}. Line ${e.line}`)}else if(y instanceof de&&d instanceof de){const w=y.data,E=d.data;if(w.length!==E.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(a==="+=")for(let I=0;I<w.length;++I)w[I]+=E[I];else if(a==="-=")for(let I=0;I<w.length;++I)w[I]-=E[I];else if(a==="*=")for(let I=0;I<w.length;++I)w[I]*=E[I];else if(a==="/=")for(let I=0;I<w.length;++I)w[I]/=E[I];else if(a==="%=")for(let I=0;I<w.length;++I)w[I]%=E[I];else if(a==="&=")for(let I=0;I<w.length;++I)w[I]&=E[I];else if(a==="|=")for(let I=0;I<w.length;++I)w[I]|=E[I];else if(a==="^=")for(let I=0;I<w.length;++I)w[I]^=E[I];else if(a==="<<=")for(let I=0;I<w.length;++I)w[I]<<=E[I];else if(a===">>=")for(let I=0;I<w.length;++I)w[I]>>=E[I];else console.error(`Invalid operator ${a}. Line ${e.line}`)}else{if(!(y instanceof Le&&d instanceof Le))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);a==="+="?y.value+=d.value:a==="-="?y.value-=d.value:a==="*="?y.value*=d.value:a==="/="?y.value/=d.value:a==="%="?y.value%=d.value:a==="&="?y.value&=d.value:a==="|="?y.value|=d.value:a==="^="?y.value^=d.value:a==="<<="?y.value<<=d.value:a===">>="?y.value>>=d.value:console.error(`Invalid operator ${a}. Line ${e.line}`)}return void(r instanceof Zi&&r.setDataValue(this,y,c,t))}if(r instanceof Zi)r.setDataValue(this,d,c,t);else if(c){if(!(r instanceof de||r instanceof jt))return void console.error(`Variable ${o} is not a vector or matrix. Line ${e.line}`);if(c instanceof pc){const y=this.evalExpression(c.index,t).value;if(r instanceof de){if(!(d instanceof Le))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[y]=d.value}else{if(!(r instanceof jt))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);{const w=this.evalExpression(c.index,t).value;if(w<0)return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);if(!(d instanceof de))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);{const E=r.typeInfo.getTypeName();if(E==="mat2x2"||E==="mat2x2f"||E==="mat2x2h"){if(!(w<2&&d.data.length===2))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[2*w]=d.data[0],r.data[2*w+1]=d.data[1]}else if(E==="mat2x3"||E==="mat2x3f"||E==="mat2x3h"){if(!(w<2&&d.data.length===3))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[3*w]=d.data[0],r.data[3*w+1]=d.data[1],r.data[3*w+2]=d.data[2]}else if(E==="mat2x4"||E==="mat2x4f"||E==="mat2x4h"){if(!(w<2&&d.data.length===4))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[4*w]=d.data[0],r.data[4*w+1]=d.data[1],r.data[4*w+2]=d.data[2],r.data[4*w+3]=d.data[3]}else if(E==="mat3x2"||E==="mat3x2f"||E==="mat3x2h"){if(!(w<3&&d.data.length===2))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[2*w]=d.data[0],r.data[2*w+1]=d.data[1]}else if(E==="mat3x3"||E==="mat3x3f"||E==="mat3x3h"){if(!(w<3&&d.data.length===3))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[3*w]=d.data[0],r.data[3*w+1]=d.data[1],r.data[3*w+2]=d.data[2]}else if(E==="mat3x4"||E==="mat3x4f"||E==="mat3x4h"){if(!(w<3&&d.data.length===4))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[4*w]=d.data[0],r.data[4*w+1]=d.data[1],r.data[4*w+2]=d.data[2],r.data[4*w+3]=d.data[3]}else if(E==="mat4x2"||E==="mat4x2f"||E==="mat4x2h"){if(!(w<4&&d.data.length===2))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[2*w]=d.data[0],r.data[2*w+1]=d.data[1]}else if(E==="mat4x3"||E==="mat4x3f"||E==="mat4x3h"){if(!(w<4&&d.data.length===3))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[3*w]=d.data[0],r.data[3*w+1]=d.data[1],r.data[3*w+2]=d.data[2]}else{if(E!=="mat4x4"&&E!=="mat4x4f"&&E!=="mat4x4h")return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);if(!(w<4&&d.data.length===4))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);r.data[4*w]=d.data[0],r.data[4*w+1]=d.data[1],r.data[4*w+2]=d.data[2],r.data[4*w+3]=d.data[3]}}}}}else if(c instanceof Na){const y=c.value;if(!(r instanceof de))return void console.error(`Invalid assignment to ${y}. Variable ${o} is not a vector. Line ${e.line}`);if(d instanceof Le){if(y.length>1)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);if(y==="x")r.data[0]=d.value;else if(y==="y"){if(r.data.length<2)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);r.data[1]=d.value}else if(y==="z"){if(r.data.length<3)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);r.data[2]=d.value}else if(y==="w"){if(r.data.length<4)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);r.data[3]=d.value}}else{if(!(d instanceof de))return void console.error(`Invalid assignment to ${o}. Line ${e.line}`);if(y.length!==d.data.length)return void console.error(`Invalid assignment to ${y} for variable ${o}. Line ${e.line}`);for(let w=0;w<y.length;++w){const E=y[w];if(E==="x"||E==="r")r.data[0]=d.data[w];else if(E==="y"||E==="g"){if(d.data.length<2)return void console.error(`Invalid assignment to ${E} for variable ${o}. Line ${e.line}`);r.data[1]=d.data[w]}else if(E==="z"||E==="b"){if(d.data.length<3)return void console.error(`Invalid assignment to ${E} for variable ${o}. Line ${e.line}`);r.data[2]=d.data[w]}else{if(E!=="w"&&E!=="a")return void console.error(`Invalid assignment to ${E} for variable ${o}. Line ${e.line}`);if(d.data.length<4)return void console.error(`Invalid assignment to ${E} for variable ${o}. Line ${e.line}`);r.data[3]=d.data[w]}}}}}else r instanceof Le&&d instanceof Le?r.value=d.value:r instanceof de&&d instanceof de||r instanceof jt&&d instanceof jt?r.data.set(d.data):console.error(`Invalid assignment to ${o}. Line ${e.line}`)}_function(e,t){const r=new $_(e);t.functions.set(e.name,r)}_const(e,t){let r=null;e.value!==null&&(r=this.evalExpression(e.value,t)),t.createVariable(e.name,r,e)}_let(e,t){let r=null;if(e.value!==null){if(r=this.evalExpression(e.value,t),r===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof cr||(r=r.clone())}else{const o=e.type.name;if(o==="f32"||o==="i32"||o==="u32"||o==="bool"||o==="f16"||o==="vec2"||o==="vec3"||o==="vec4"||o==="vec2f"||o==="vec3f"||o==="vec4f"||o==="vec2i"||o==="vec3i"||o==="vec4i"||o==="vec2u"||o==="vec3u"||o==="vec4u"||o==="vec2h"||o==="vec3h"||o==="vec4h"||o==="vec2b"||o==="vec3b"||o==="vec4b"||o==="mat2x2"||o==="mat2x3"||o==="mat2x4"||o==="mat3x2"||o==="mat3x3"||o==="mat3x4"||o==="mat4x2"||o==="mat4x3"||o==="mat4x4"||o==="mat2x2f"||o==="mat2x3f"||o==="mat2x4f"||o==="mat3x2f"||o==="mat3x3f"||o==="mat3x4f"||o==="mat4x2f"||o==="mat4x3f"||o==="mat4x4f"||o==="mat2x2h"||o==="mat2x3h"||o==="mat2x4h"||o==="mat3x2h"||o==="mat3x3h"||o==="mat3x4h"||o==="mat4x2h"||o==="mat4x3h"||o==="mat4x4h"||o==="array"){const c=new bs(e.type,[]);r=this._evalCreate(c,t)}}t.createVariable(e.name,r,e)}_var(e,t){let r=null;if(e.value!==null){if(r=this.evalExpression(e.value,t),r===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof cr||(r=r.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);const o=e.type.name;if(o==="f32"||o==="i32"||o==="u32"||o==="bool"||o==="f16"||o==="vec2"||o==="vec3"||o==="vec4"||o==="vec2f"||o==="vec3f"||o==="vec4f"||o==="vec2i"||o==="vec3i"||o==="vec4i"||o==="vec2u"||o==="vec3u"||o==="vec4u"||o==="vec2h"||o==="vec3h"||o==="vec4h"||o==="vec2b"||o==="vec3b"||o==="vec4b"||o==="mat2x2"||o==="mat2x3"||o==="mat2x4"||o==="mat3x2"||o==="mat3x3"||o==="mat3x4"||o==="mat4x2"||o==="mat4x3"||o==="mat4x4"||o==="mat2x2f"||o==="mat2x3f"||o==="mat2x4f"||o==="mat3x2f"||o==="mat3x3f"||o==="mat3x4f"||o==="mat4x2f"||o==="mat4x3f"||o==="mat4x4f"||o==="mat2x2h"||o==="mat2x3h"||o==="mat2x4h"||o==="mat3x2h"||o==="mat3x3h"||o==="mat3x4h"||o==="mat4x2h"||o==="mat4x3h"||o==="mat4x4h"||e.type instanceof hh||e.type instanceof Qs||e.type instanceof Ve){const c=new bs(e.type,[]);r=this._evalCreate(c,t)}}t.createVariable(e.name,r,e)}_switch(e,t){t=t.clone();const r=this.evalExpression(e.condition,t);if(!(r instanceof Le))return console.error(`Invalid if condition. Line ${e.line}`),null;let o=null;for(const c of e.cases)if(c instanceof o1)for(const d of c.selectors){if(d instanceof Ef){o=c;continue}const a=this.evalExpression(d,t);if(!(a instanceof Le))return console.error(`Invalid case selector. Line ${e.line}`),null;if(a.value===r.value)return this._execStatements(c.body,t)}else c instanceof a1&&(o=c);return o?this._execStatements(o.body,t):null}_if(e,t){t=t.clone();const r=this.evalExpression(e.condition,t);if(!(r instanceof Le))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(e.body,t);for(const o of e.elseif){const c=this.evalExpression(o.condition,t);if(!(c instanceof Le))return console.error(`Invalid if condition. Line ${e.line}`),null;if(c.value)return this._execStatements(o.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof Le?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const r=this._execStatements(e.body,t);if(r===Br._breakObj)break;if(r!==null&&r!==Br._continueObj)return r;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const r=this._execStatements(e.body,t);if(r===Br._breakObj)break;if(r===Br._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===Br._breakObj)break}else if(r!==null)return r}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const r=this._execStatements(e.body,t);if(r===Br._breakObj)break;if(r!==Br._continueObj&&r!==null)return r}return null}_evalBitcast(e,t){const r=this.evalExpression(e.value,t),o=e.type;if(r instanceof Le){const c=Jv(r.value,r.typeInfo.name,o.name);return new Le(c,this.getTypeInfo(o))}if(r instanceof de){const c=r.typeInfo.getTypeName();let d="";if(c.endsWith("f"))d="f32";else if(c.endsWith("i"))d="i32";else if(c.endsWith("u"))d="u32";else if(c.endsWith("b"))d="bool";else{if(!c.endsWith("h"))return console.error(`Unknown vector type ${c}. Line ${e.line}`),null;d="f16"}const a=o.getTypeName();let y="";if(a.endsWith("f"))y="f32";else if(a.endsWith("i"))y="i32";else if(a.endsWith("u"))y="u32";else if(a.endsWith("b"))y="bool";else{if(!a.endsWith("h"))return console.error(`Unknown vector type ${y}. Line ${e.line}`),null;y="f16"}const w=(function(E,I,D){if(I===D)return E;const F=new Array(E.length);for(let X=0;X<E.length;X++)F[X]=Jv(E[X],I,D);return F})(Array.from(r.data),d,y);return new de(w,this.getTypeInfo(o))}return console.error(`TODO: bitcast for ${r.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var r;if(e instanceof bs){if(e.type===null)return Zm.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}const o=e instanceof bs?e.type.name:e.name,c=e instanceof bs?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(c===null)return console.error(`Unknown type ${o}. Line ${e.line}`),null;if(c.size===0)return null;const d=new Zi(new ArrayBuffer(c.size),c,0);if(c instanceof Uo){if(e.args)for(let a=0;a<e.args.length;++a){const y=c.members[a],w=e.args[a],E=this.evalExpression(w,t);d.setData(this,E,y.type,y.offset,t)}}else if(c instanceof Wo){let a=0;if(e.args)for(let y=0;y<e.args.length;++y){const w=e.args[y],E=this.evalExpression(w,t);c.format===null&&(((r=E.typeInfo)===null||r===void 0?void 0:r.name)==="x32"?c.format=this.getTypeInfo("i32"):c.format=E.typeInfo),d.setData(this,E,c.format,a,t),a+=c.stride}}else console.error(`Unknown type "${o}". Line ${e.line}`);return e instanceof bs?d.getSubData(this,e.postfix,t):d}_evalLiteral(e,t){const r=this.getTypeInfo(e.type),o=r.name;return o==="x32"||o==="u32"||o==="f32"||o==="f16"||o==="i32"||o==="bool"?new Le(e.scalarValue,r):o==="vec2"||o==="vec3"||o==="vec4"||o==="vec2f"||o==="vec3f"||o==="vec4f"||o==="vec2h"||o==="vec3h"||o==="vec4h"||o==="vec2i"||o==="vec3i"||o==="vec4i"||o==="vec2u"||o==="vec3u"||o==="vec4u"?this._callConstructorVec(e,t):o==="mat2x2"||o==="mat2x3"||o==="mat2x4"||o==="mat3x2"||o==="mat3x3"||o==="mat3x4"||o==="mat4x2"||o==="mat4x3"||o==="mat4x4"||o==="mat2x2f"||o==="mat2x3f"||o==="mat2x4f"||o==="mat3x2f"||o==="mat3x3f"||o==="mat3x4f"||o==="mat4x2f"||o==="mat4x3f"||o==="mat4x4f"||o==="mat2x2h"||o==="mat2x3h"||o==="mat2x4h"||o==="mat3x2h"||o==="mat3x3h"||o==="mat3x4h"||o==="mat4x2h"||o==="mat4x3h"||o==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const r=t.getVariableValue(e.name);return r===null?r:r.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let r=1;r<e.length;++r){const o=Br._priority.get(t.name);Br._priority.get(e[r].name)<o&&(t=e[r])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const r=this.evalExpression(e.right,t);if(e.operator==="&")return new ec(r);if(e.operator==="*")return r instanceof ec?r.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);const o=r instanceof Le?r.value:r instanceof de?Array.from(r.data):null;switch(e.operator){case"+":{if(Tt(o)){const a=o.map((y,w)=>+y);return new de(a,r.typeInfo)}const c=o,d=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Le(+c,d)}case"-":{if(Tt(o)){const a=o.map((y,w)=>-y);return new de(a,r.typeInfo)}const c=o,d=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Le(-c,d)}case"!":{if(Tt(o)){const a=o.map((y,w)=>y?0:1);return new de(a,r.typeInfo)}const c=o,d=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Le(c?0:1,d)}case"~":{if(Tt(o)){const a=o.map((y,w)=>~y);return new de(a,r.typeInfo)}const c=o,d=this._maxFormatTypeInfo([r.typeInfo,r.typeInfo]);return new Le(~c,d)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const r=this.evalExpression(e.left,t),o=this.evalExpression(e.right,t),c=r instanceof Le?r.value:r instanceof de||r instanceof jt?Array.from(r.data):null,d=o instanceof Le?o.value:o instanceof de||o instanceof jt?Array.from(o.data):null;switch(e.operator){case"+":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F+I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D+E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E+D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a+y,w)}case"-":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F-I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D-E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E-D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a-y,w)}case"*":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(r instanceof jt&&o instanceof jt){const D=(function(_e,ge,fe,Te){if(Zr[ge.name]===void 0||Zr[Te.name]===void 0)return null;const ke=Zr[ge.name][0],Je=Zr[ge.name][1],Xe=Zr[Te.name][0];if(ke!==Zr[Te.name][1])return null;const mt=new Array(Xe*Je);for(let G=0;G<Je;G++)for(let J=0;J<Xe;J++){let ae=0;for(let be=0;be<ke;be++)ae+=_e[be*Je+G]*fe[J*ke+be];mt[G*Xe+J]=ae}return mt})(E,r.typeInfo,I,o.typeInfo);if(D===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;const F=Zr[o.typeInfo.name][0],X=Zr[r.typeInfo.name][1],oe=this.getTypeInfo(`mat${F}x${X}f`);return new jt(D,oe)}if(r instanceof jt&&o instanceof de){const D=(function(F,X,oe,_e){if(Zr[X.name]===void 0||Qg[_e.name]===void 0)return null;const ge=Zr[X.name][0],fe=Zr[X.name][1];if(ge!==oe.length)return null;const Te=new Array(fe);for(let ke=0;ke<fe;ke++){let Je=0;for(let Xe=0;Xe<ge;Xe++)Je+=F[Xe*fe+ke]*oe[Xe];Te[ke]=Je}return Te})(E,r.typeInfo,I,o.typeInfo);return D===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new de(D,o.typeInfo)}if(r instanceof de&&o instanceof jt){const D=(function(F,X,oe,_e){if(Qg[X.name]===void 0||Zr[_e.name]===void 0)return null;const ge=Zr[_e.name][0],fe=Zr[_e.name][1];if(fe!==F.length)return null;const Te=[];for(let ke=0;ke<ge;ke++){let Je=0;for(let Xe=0;Xe<fe;Xe++)Je+=F[Xe]*oe[Xe*ge+ke];Te[ke]=Je}return Te})(E,r.typeInfo,I,o.typeInfo);return D===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new de(D,r.typeInfo)}{if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F*I[X]);return new de(D,r.typeInfo)}}if(Tt(c)){const E=d,I=c.map((D,F)=>D*E);return r instanceof jt?new jt(I,r.typeInfo):new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E*D);return o instanceof jt?new jt(I,o.typeInfo):new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a*y,w)}case"%":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F%I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D%E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E%D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a%y,w)}case"/":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F/I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D/E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E/D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a/y,w)}case"&":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F&I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D&E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E&D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a&y,w)}case"|":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F|I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D|E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E|D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a|y,w)}case"^":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F^I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D^E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E^D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a^y,w)}case"<<":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F<<I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D<<E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E<<D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a<<y,w)}case">>":{if(Tt(c)&&Tt(d)){const E=c,I=d;if(E.length!==I.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const D=E.map((F,X)=>F>>I[X]);return new de(D,r.typeInfo)}if(Tt(c)){const E=d,I=c.map((D,F)=>D>>E);return new de(I,r.typeInfo)}if(Tt(d)){const E=c,I=d.map((D,F)=>E>>D);return new de(I,o.typeInfo)}const a=c,y=d,w=this._maxFormatTypeInfo([r.typeInfo,o.typeInfo]);return new Le(a>>y,w)}case">":if(Tt(c)&&Tt(d)){const a=c,y=d;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const w=a.map((E,I)=>E>y[I]?1:0);return new de(w,r.typeInfo)}if(Tt(c)){const a=d,y=c.map((w,E)=>w>a?1:0);return new de(y,r.typeInfo)}if(Tt(d)){const a=c,y=d.map((w,E)=>a>w?1:0);return new de(y,o.typeInfo)}return new Le(c>d?1:0,this.getTypeInfo("bool"));case"<":if(Tt(c)&&Tt(d)){const a=c,y=d;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const w=a.map((E,I)=>E<y[I]?1:0);return new de(w,r.typeInfo)}if(Tt(c)){const a=d,y=c.map((w,E)=>w<a?1:0);return new de(y,r.typeInfo)}if(Tt(d)){const a=c,y=d.map((w,E)=>a<w?1:0);return new de(y,o.typeInfo)}return new Le(c<d?1:0,this.getTypeInfo("bool"));case"==":if(Tt(c)&&Tt(d)){const a=c,y=d;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const w=a.map((E,I)=>E===y[I]?1:0);return new de(w,r.typeInfo)}if(Tt(c)){const a=d,y=c.map((w,E)=>w==a?1:0);return new de(y,r.typeInfo)}if(Tt(d)){const a=c,y=d.map((w,E)=>a==w?1:0);return new de(y,o.typeInfo)}return new Le(c===d?1:0,this.getTypeInfo("bool"));case"!=":if(Tt(c)&&Tt(d)){const a=c,y=d;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const w=a.map((E,I)=>E!==y[I]?1:0);return new de(w,r.typeInfo)}if(Tt(c)){const a=d,y=c.map((w,E)=>w!==a?1:0);return new de(y,r.typeInfo)}if(Tt(d)){const a=c,y=d.map((w,E)=>a!==w?1:0);return new de(y,o.typeInfo)}return new Le(c!==d?1:0,this.getTypeInfo("bool"));case">=":if(Tt(c)&&Tt(d)){const a=c,y=d;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const w=a.map((E,I)=>E>=y[I]?1:0);return new de(w,r.typeInfo)}if(Tt(c)){const a=d,y=c.map((w,E)=>w>=a?1:0);return new de(y,r.typeInfo)}if(Tt(d)){const a=c,y=d.map((w,E)=>a>=w?1:0);return new de(y,o.typeInfo)}return new Le(c>=d?1:0,this.getTypeInfo("bool"));case"<=":if(Tt(c)&&Tt(d)){const a=c,y=d;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const w=a.map((E,I)=>E<=y[I]?1:0);return new de(w,r.typeInfo)}if(Tt(c)){const a=d,y=c.map((w,E)=>w<=a?1:0);return new de(y,r.typeInfo)}if(Tt(d)){const a=c,y=d.map((w,E)=>a<=w?1:0);return new de(y,o.typeInfo)}return new Le(c<=d?1:0,this.getTypeInfo("bool"));case"&&":if(Tt(c)&&Tt(d)){const a=c,y=d;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const w=a.map((E,I)=>E&&y[I]?1:0);return new de(w,r.typeInfo)}if(Tt(c)){const a=d,y=c.map((w,E)=>w&&a?1:0);return new de(y,r.typeInfo)}if(Tt(d)){const a=c,y=d.map((w,E)=>a&&w?1:0);return new de(y,o.typeInfo)}return new Le(c&&d?1:0,this.getTypeInfo("bool"));case"||":if(Tt(c)&&Tt(d)){const a=c,y=d;if(a.length!==y.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const w=a.map((E,I)=>E||y[I]?1:0);return new de(w,r.typeInfo)}if(Tt(c)){const a=d,y=c.map((w,E)=>w||a?1:0);return new de(y,r.typeInfo)}if(Tt(d)){const a=c,y=d.map((w,E)=>a||w?1:0);return new de(y,o.typeInfo)}return new Le(c||d?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const r=t.clone();r.currentFunctionName=e.name;const o=t.getFunction(e.name);if(!o)return e.isBuiltin?this._callBuiltinFunction(e,r):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let c=0;c<o.node.args.length;++c){const d=o.node.args[c],a=this.evalExpression(e.args[c],r);r.createVariable(d.name,a,d)}return this._execStatements(o.node.body,r)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothstep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const r=t.getFunction(e.name);if(r){const o=t.clone();for(let c=0;c<r.node.args.length;++c){const d=r.node.args[c],a=this.evalExpression(e.args[c],o);o.setVariable(d.name,a,d)}return this._execStatements(r.node.body,o)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new Le(0,this.getTypeInfo(e.type));const r=this.evalExpression(e.args[0],t);return r.typeInfo=this.getTypeInfo(e.type),r.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const r=this.getTypeInfo(e.type),o=e.type.getTypeName(),c=Qg[o];if(c===void 0)return console.error(`Invalid vec constructor ${o}. Line ${e.line}`),null;const d=[];if(e instanceof _r)if(e.isVector){const a=e.vectorValue;for(const y of a)d.push(y)}else d.push(e.scalarValue);else if(e.args)for(const a of e.args){const y=this.evalExpression(a,t);if(y instanceof de){const w=y.data;for(let E=0;E<w.length;++E){let I=w[E];d.push(I)}}else if(y instanceof Le){let w=y.value;d.push(w)}}if(e.type instanceof Ve&&e.type.format===null&&(e.type.format=Ve.f32),d.length===0){const a=new Array(c).fill(0);return new de(a,r).getSubData(this,e.postfix,t)}if(d.length===1)for(;d.length<c;)d.push(d[0]);return d.length<c?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new de(d.length>c?d.slice(0,c):d,r).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const r=this.getTypeInfo(e.type),o=e.type.getTypeName(),c=Zr[o];if(c===void 0)return console.error(`Invalid matrix constructor ${o}. Line ${e.line}`),null;const d=[];if(e instanceof _r)if(e.isVector){const a=e.vectorValue;for(const y of a)d.push(y)}else d.push(e.scalarValue);else if(e.args)for(const a of e.args){const y=this.evalExpression(a,t);y instanceof de?d.push(...y.data):y instanceof Le?d.push(y.value):y instanceof jt&&d.push(...y.data)}if(r instanceof Ba&&r.format===null&&(r.format=this.getTypeInfo("f32")),d.length===0){const a=new Array(c[2]).fill(0);return new jt(a,r).getSubData(this,e.postfix,t)}return d.length!==c[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new jt(d,r).getSubData(this,e.postfix,t)}}Br._breakObj=new Fn(new Dn("BREAK",null),null),Br._continueObj=new Fn(new Dn("CONTINUE",null),null),Br._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class RC{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class kC{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new RC,this._exec=new Br,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const r=this._global_decl_or_directive();if(!r)break;t.push(r)}if(this._deferArrayCountEval.length>0){for(const r of this._deferArrayCountEval){const o=r.arrayType,c=r.countNode;if(c instanceof xn){const d=c.name,a=this._context.constants.get(d);if(a)try{const y=a.constEvaluate(this._exec);o.count=y}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const r of t)r.search(o=>{o instanceof Yv||o instanceof Sf?o.type=this._forwardType(o.type):o instanceof hh?o.format=this._forwardType(o.format):o instanceof to||o instanceof uh||o instanceof Tf?o.type=this._forwardType(o.type):o instanceof yh?o.returnType=this._forwardType(o.returnType):o instanceof Gv&&(o.type=this._forwardType(o.type))});return t}_forwardType(e){if(e instanceof Xv){const t=this._getType(e.name);if(t)return t}else e instanceof Sf?e.type=this._forwardType(e.type):e instanceof hh&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if(typeof e=="string"){const t=new bC(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==re.eof}_match(e){if(e instanceof Be)return!!this._check(e)&&(this._advance(),!0);for(let t=0,r=e.length;t<r;++t){const o=e[t];if(this._check(o))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const r=t.type;let o=!1;for(const c of e){if(r===c)return!0;c===re.tokens.name&&(o=!0)}if(o){const c=re.tokens.name.rule.exec(t.lexeme);if(c&&c.index==0&&c[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===re.tokens.name){const r=re.tokens.name.rule.exec(t.lexeme);return r&&r.index==0&&r[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(re.tokens.semicolon)&&!this._isAtEnd(););if(this._match(re.keywords.alias)){const t=this._type_alias();return this._consume(re.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(re.keywords.diagnostic)){const t=this._diagnostic();return this._consume(re.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(re.keywords.requires)){const t=this._requires_directive();return this._consume(re.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(re.keywords.enable)){const t=this._enable_directive();return this._consume(re.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(re.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(re.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(re.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(re.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(re.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(re.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(re.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(re.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(re.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(re.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(re.keywords.fn))return null;const e=this._currentLine,t=this._consume(re.tokens.ident,"Expected function name.").toString();this._consume(re.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(re.tokens.paren_right))do{if(this._check(re.tokens.paren_right))break;const a=this._attribute(),y=this._consume(re.tokens.name,"Expected argument name.").toString();this._consume(re.tokens.colon,"Expected ':' for argument type.");const w=this._attribute(),E=this._type_decl();E!=null&&(E.attributes=w,r.push(this._updateNode(new Gv(y,E,a))))}while(this._match(re.tokens.comma));this._consume(re.tokens.paren_right,"Expected ')' after function arguments.");let o=null;if(this._match(re.tokens.arrow)){const a=this._attribute();o=this._type_decl(),o!=null&&(o.attributes=a)}const c=this._compound_statement(),d=this._currentLine;return this._updateNode(new yh(t,r,o,c,e,d),e)}_compound_statement(){const e=[];for(this._consume(re.tokens.brace_left,"Expected '{' for block.");!this._check(re.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(re.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(re.tokens.semicolon)&&!this._isAtEnd(););if(this._check(re.tokens.attr)&&this._attribute(),this._check(re.keywords.if))return this._if_statement();if(this._check(re.keywords.switch))return this._switch_statement();if(this._check(re.keywords.loop))return this._loop_statement();if(this._check(re.keywords.for))return this._for_statement();if(this._check(re.keywords.while))return this._while_statement();if(this._check(re.keywords.continuing))return this._continuing_statement();if(this._check(re.keywords.static_assert))return this._static_assert_statement();if(this._check(re.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(re.keywords.return))e=this._return_statement();else if(this._check([re.keywords.var,re.keywords.let,re.keywords.const]))e=this._variable_statement();else if(this._match(re.keywords.discard))e=this._updateNode(new yC);else if(this._match(re.keywords.break)){const t=this._updateNode(new e1);if(this._currentLoop.length>0){const r=this._currentLoop[this._currentLoop.length-1];t.loopId=r.id}e=t,this._check(re.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(re.keywords.continue)){const t=this._updateNode(new t1);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const r=this._currentLoop[this._currentLoop.length-1];t.loopId=r.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(re.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(re.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new gC(t),e)}_while_statement(){if(!this._match(re.keywords.while))return null;const e=this._updateNode(new Hw(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(re.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(re.keywords.continuing))return null;const t=this._currentLine,r=this._compound_statement();return this._updateNode(new Hm(r,e),t)}_for_statement(){if(!this._match(re.keywords.for))return null;this._consume(re.tokens.paren_left,"Expected '('.");const e=this._updateNode(new Zw(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(re.tokens.semicolon)?null:this._for_init(),this._consume(re.tokens.semicolon,"Expected ';'."),e.condition=this._check(re.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(re.tokens.semicolon,"Expected ';'."),e.increment=this._check(re.tokens.paren_right)?null:this._for_increment(),this._consume(re.tokens.paren_right,"Expected ')'."),this._check(re.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(re.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(re.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new to(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(re.keywords.let)){const e=this._currentLine,t=this._consume(re.tokens.name,"Expected name for let.").toString();let r=null;if(this._match(re.tokens.colon)){const c=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=c)}this._consume(re.tokens.equal,"Expected '=' for let.");const o=this._short_circuit_or_expression();return this._updateNode(new uh(t,r,null,null,o),e)}if(this._match(re.keywords.const)){const e=this._currentLine,t=this._consume(re.tokens.name,"Expected name for const.").toString();let r=null;if(this._match(re.tokens.colon)){const c=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=c)}this._consume(re.tokens.equal,"Expected '=' for const.");const o=this._short_circuit_or_expression();return r===null&&o instanceof _r&&(r=o.type),this._updateNode(new Tf(t,r,null,null,o),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(re.increment_operators))return this._current=e,null;const r=this._consume(re.increment_operators,"Expected increment operator");return this._updateNode(new qw(r.type===re.tokens.plus_plus?nc.increment:nc.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(re.tokens.brace_right))return null;let r=this._match(re.tokens.underscore);if(r||(e=this._unary_expression()),!r&&e==null)return null;const o=this._consume(re.assignment_operators,"Expected assignment operator."),c=this._short_circuit_or_expression();return this._updateNode(new Xw(ih.parse(o.lexeme),e,c),t)}_func_call_statement(){if(!this._check(re.tokens.ident))return null;const e=this._currentLine,t=this._current,r=this._consume(re.tokens.ident,"Expected function name."),o=this._argument_expression_list();return o===null?(this._current=t,null):this._updateNode(new N_(r.lexeme,o),e)}_loop_statement(){if(!this._match(re.keywords.loop))return null;this._check(re.tokens.attr)&&this._attribute(),this._consume(re.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new Gw([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let r of t)e.body.push(r);else e.body.push(t);if(t instanceof Hm){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(re.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(re.keywords.switch))return null;const e=this._updateNode(new Yw(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(re.tokens.attr)&&this._attribute(),this._consume(re.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(re.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([re.keywords.default,re.keywords.case]);){if(this._match(re.keywords.case)){const r=this._case_selectors();for(const c of r)if(c instanceof Ef){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(re.tokens.colon),this._check(re.tokens.attr)&&this._attribute(),this._consume(re.tokens.brace_left,"Exected '{' for switch case.");const o=this._case_body();this._consume(re.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new o1(r,o)))}if(this._match(re.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(re.tokens.colon),this._check(re.tokens.attr)&&this._attribute(),this._consume(re.tokens.brace_left,"Exected '{' for switch default.");const r=this._case_body();this._consume(re.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new a1(r)))}}return e}_case_selectors(){const e=[];for(this._match(re.keywords.default)?e.push(this._updateNode(new Ef)):e.push(this._shift_expression());this._match(re.tokens.comma);)this._match(re.keywords.default)?e.push(this._updateNode(new Ef)):e.push(this._shift_expression());return e}_case_body(){if(this._match(re.keywords.fallthrough))return this._consume(re.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(re.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(re.tokens.attr)&&this._attribute();const r=this._compound_statement();let o=[];this._match_elseif()&&(this._check(re.tokens.attr)&&this._attribute(),o=this._elseif_statement(o));let c=null;return this._match(re.keywords.else)&&(this._check(re.tokens.attr)&&this._attribute(),c=this._compound_statement()),this._updateNode(new Kw(t,r,o,c),e)}_match_elseif(){return this._tokens[this._current].type===re.keywords.else&&this._tokens[this._current+1].type===re.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),r=this._compound_statement();return e.push(this._updateNode(new xC(t,r))),this._match_elseif()&&(this._check(re.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(re.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new Jw(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(re.tokens.or_or);)e=this._updateNode(new Yn(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(re.tokens.and_and);)e=this._updateNode(new Yn(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(re.tokens.or);)e=this._updateNode(new Yn(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(re.tokens.xor);)e=this._updateNode(new Yn(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(re.tokens.and);)e=this._updateNode(new Yn(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([re.tokens.equal_equal,re.tokens.not_equal])?this._updateNode(new Yn(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([re.tokens.less_than,re.tokens.greater_than,re.tokens.less_than_equal,re.tokens.greater_than_equal]);)e=this._updateNode(new Yn(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([re.tokens.shift_left,re.tokens.shift_right]);)e=this._updateNode(new Yn(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([re.tokens.plus,re.tokens.minus]);)e=this._updateNode(new Yn(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([re.tokens.star,re.tokens.forward_slash,re.tokens.modulo]);)e=this._updateNode(new Yn(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([re.tokens.minus,re.tokens.bang,re.tokens.tilde,re.tokens.star,re.tokens.and])?this._updateNode(new cr(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(re.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(re.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new pc(e)),r=this._postfix_expression();return r&&(t.postfix=r),t}if(this._match(re.tokens.period)){const e=this._consume(re.tokens.name,"Expected member name."),t=this._postfix_expression(),r=this._updateNode(new Na(e.lexeme));return t&&(r.postfix=t),r}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"void":return ht.void;case"bool":return ht.bool;case"i32":return ht.i32;case"u32":return ht.u32;case"f32":return ht.f32;case"f16":return ht.f16;case"vec2f":return Ve.vec2f;case"vec3f":return Ve.vec3f;case"vec4f":return Ve.vec4f;case"vec2i":return Ve.vec2i;case"vec3i":return Ve.vec3i;case"vec4i":return Ve.vec4i;case"vec2u":return Ve.vec2u;case"vec3u":return Ve.vec3u;case"vec4u":return Ve.vec4u;case"vec2h":return Ve.vec2h;case"vec3h":return Ve.vec3h;case"vec4h":return Ve.vec4h;case"mat2x2f":return Ve.mat2x2f;case"mat2x3f":return Ve.mat2x3f;case"mat2x4f":return Ve.mat2x4f;case"mat3x2f":return Ve.mat3x2f;case"mat3x3f":return Ve.mat3x3f;case"mat3x4f":return Ve.mat3x4f;case"mat4x2f":return Ve.mat4x2f;case"mat4x3f":return Ve.mat4x3f;case"mat4x4f":return Ve.mat4x4f;case"mat2x2h":return Ve.mat2x2h;case"mat2x3h":return Ve.mat2x3h;case"mat2x4h":return Ve.mat2x4h;case"mat3x2h":return Ve.mat3x2h;case"mat3x3h":return Ve.mat3x3h;case"mat3x4h":return Ve.mat3x4h;case"mat4x2h":return Ve.mat4x2h;case"mat4x3h":return Ve.mat4x3h;case"mat4x4h":return Ve.mat4x4h;case"mat2x2i":return Ve.mat2x2i;case"mat2x3i":return Ve.mat2x3i;case"mat2x4i":return Ve.mat2x4i;case"mat3x2i":return Ve.mat3x2i;case"mat3x3i":return Ve.mat3x3i;case"mat3x4i":return Ve.mat3x4i;case"mat4x2i":return Ve.mat4x2i;case"mat4x3i":return Ve.mat4x3i;case"mat4x4i":return Ve.mat4x4i;case"mat2x2u":return Ve.mat2x2u;case"mat2x3u":return Ve.mat2x3u;case"mat2x4u":return Ve.mat2x4u;case"mat3x2u":return Ve.mat3x2u;case"mat3x3u":return Ve.mat3x3u;case"mat3x4u":return Ve.mat3x4u;case"mat4x2u":return Ve.mat4x2u;case"mat4x3u":return Ve.mat4x3u;case"mat4x4u":return Ve.mat4x4u}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(re.tokens.ident)){const r=this._previous().toString();if(this._check(re.tokens.paren_left)){const o=this._argument_expression_list(),c=this._getType(r);return c!==null?this._updateNode(new bs(c,o)):this._updateNode(new U_(r,o))}if(this._context.constants.has(r)){const o=this._context.constants.get(r);return this._updateNode(new i1(r,o.value))}return this._updateNode(new xn(r))}if(this._match(re.tokens.int_literal)){const r=this._previous().toString();let o=r.endsWith("i")||r.endsWith("i")?ht.i32:r.endsWith("u")||r.endsWith("U")?ht.u32:ht.x32;const c=parseInt(r);return this._validateTypeRange(c,o),this._updateNode(new _r(new Le(c,this._exec.getTypeInfo(o)),o))}if(this._match(re.tokens.uint_literal)){const r=parseInt(this._previous().toString());return this._validateTypeRange(r,ht.u32),this._updateNode(new _r(new Le(r,this._exec.getTypeInfo(ht.u32)),ht.u32))}if(this._match([re.tokens.decimal_float_literal,re.tokens.hex_float_literal])){let r=this._previous().toString(),o=r.endsWith("h");o&&(r=r.substring(0,r.length-1));const c=parseFloat(r);this._validateTypeRange(c,o?ht.f16:ht.f32);const d=o?ht.f16:ht.f32;return this._updateNode(new _r(new Le(c,this._exec.getTypeInfo(d)),d))}if(this._match([re.keywords.true,re.keywords.false])){let r=this._previous().toString()===re.keywords.true.rule;return this._updateNode(new _r(new Le(r?1:0,this._exec.getTypeInfo(ht.bool)),ht.bool))}if(this._check(re.tokens.paren_left))return this._paren_expression();if(this._match(re.keywords.bitcast)){this._consume(re.tokens.less_than,"Expected '<'.");const r=this._type_decl();this._consume(re.tokens.greater_than,"Expected '>'.");const o=this._paren_expression();return this._updateNode(new r1(r,o))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new bs(e,t))}_argument_expression_list(){if(!this._match(re.tokens.paren_left))return null;const e=[];do{if(this._check(re.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(re.tokens.comma));return this._consume(re.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(re.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(re.tokens.paren_right),e}_paren_expression(){this._consume(re.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(re.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(re.keywords.struct))return null;const e=this._currentLine,t=this._consume(re.tokens.ident,"Expected name for struct.").toString();this._consume(re.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(re.tokens.brace_right);){const d=this._attribute(),a=this._consume(re.tokens.name,"Expected variable name.").toString();this._consume(re.tokens.colon,"Expected ':' for struct member type.");const y=this._attribute(),w=this._type_decl();w!=null&&(w.attributes=y),this._check(re.tokens.brace_right)?this._match(re.tokens.comma):this._consume(re.tokens.comma,"Expected ',' for struct member."),r.push(this._updateNode(new Yv(a,w,d)))}this._consume(re.tokens.brace_right,"Expected '}' after struct body.");const o=this._currentLine,c=this._updateNode(new Qs(t,r,e,o),e);return this._context.structs.set(t,c),c}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(re.tokens.equal)){const t=this._const_expression();e.value=t}if(e.type!==null&&e.value instanceof _r){if(e.value.type.name!=="x32"&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof _r&&(e.type=e.value.type.name==="x32"?ht.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(re.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(re.keywords.const))return null;const t=this._consume(re.tokens.name,"Expected variable name"),r=this._currentLine;let o=null;if(this._match(re.tokens.colon)){const y=this._attribute();o=this._type_decl(),o!=null&&(o.attributes=y)}let c=null;this._consume(re.tokens.equal,"const declarations require an assignment");const d=this._short_circuit_or_expression();try{let y=[ht.f32],w=d.constEvaluate(this._exec,y);w instanceof Le&&this._validateTypeRange(w.value,y[0]),y[0]instanceof Ve&&y[0].format===null&&w.typeInfo instanceof Ba&&w.typeInfo.format!==null&&(w.typeInfo.format.name==="f16"?y[0].format=ht.f16:w.typeInfo.format.name==="f32"?y[0].format=ht.f32:w.typeInfo.format.name==="i32"?y[0].format=ht.i32:w.typeInfo.format.name==="u32"?y[0].format=ht.u32:w.typeInfo.format.name==="bool"?y[0].format=ht.bool:console.error(`TODO: impelement template format type ${w.typeInfo.format.name}`)),c=this._updateNode(new _r(w,y[0])),this._exec.context.setVariable(t.toString(),w)}catch{c=d}if(o!==null&&c instanceof _r){if(c.type.name!=="x32"&&o.getTypeName()!==c.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${c.type.name} to ${o.name}. Line:${this._currentLine}`);c.type=o,c.isScalar&&this._validateTypeRange(c.scalarValue,c.type)}else o===null&&c instanceof _r&&(o=(e=c?.type)!==null&&e!==void 0?e:ht.f32,o===ht.x32&&(o=ht.i32));const a=this._updateNode(new Tf(t.toString(),o,"","",c),r);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(re.keywords.let))return null;const e=this._currentLine,t=this._consume(re.tokens.name,"Expected variable name");let r=null;if(this._match(re.tokens.colon)){const c=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=c)}let o=null;if(this._match(re.tokens.equal)&&(o=this._const_expression()),r!==null&&o instanceof _r){if(o.type.name!=="x32"&&r.getTypeName()!==o.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${o.type.name} to ${r.name}. Line:${this._currentLine}`);o.type=r}else r===null&&o instanceof _r&&(r=o.type.name==="x32"?ht.i32:o.type);return o instanceof _r&&o.isScalar&&this._validateTypeRange(o.scalarValue,r),this._updateNode(new uh(t.toString(),r,"","",o),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(re.keywords.var))return null;const e=this._currentLine;let t="",r="";this._match(re.tokens.less_than)&&(t=this._consume(re.storage_class,"Expected storage_class.").toString(),this._match(re.tokens.comma)&&(r=this._consume(re.access_mode,"Expected access_mode.").toString()),this._consume(re.tokens.greater_than,"Expected '>'."));const o=this._consume(re.tokens.name,"Expected variable name");let c=null;if(this._match(re.tokens.colon)){const d=this._attribute();c=this._type_decl(),c!=null&&(c.attributes=d)}return this._updateNode(new to(o.toString(),c,t,r,null),e)}_override_decl(){if(!this._match(re.keywords.override))return null;const e=this._consume(re.tokens.name,"Expected variable name");let t=null;if(this._match(re.tokens.colon)){const r=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=r)}return this._updateNode(new B_(e.toString(),t,null))}_diagnostic(){this._consume(re.tokens.paren_left,"Expected '('");const e=this._consume(re.tokens.ident,"Expected severity control name.");this._consume(re.tokens.comma,"Expected ','");let t=this._consume(re.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(re.tokens.period)&&(t+=`.${this._consume(re.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(re.tokens.paren_right,"Expected ')'"),this._updateNode(new Qw(e.toString(),t))}_enable_directive(){const e=this._consume(re.tokens.ident,"identity expected.");return this._updateNode(new mC(e.toString()))}_requires_directive(){const e=[this._consume(re.tokens.ident,"identity expected.").toString()];for(;this._match(re.tokens.comma);){const t=this._consume(re.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new _C(e))}_type_alias(){const e=this._consume(re.tokens.ident,"identity expected.");this._consume(re.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const r=this._updateNode(new z_(e.toString(),t));return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([re.tokens.ident,...re.texel_format,re.keywords.bool,re.keywords.f32,re.keywords.i32,re.keywords.u32])){const r=this._advance().toString();if(this._context.structs.has(r))return this._context.structs.get(r);if(this._context.aliases.has(r))return this._context.aliases.get(r).type;if(!this._getType(r)){const o=this._updateNode(new Xv(r));return this._forwardTypeCount++,o}return this._updateNode(new ht(r))}let e=this._texture_sampler_types();if(e)return e;if(this._check(re.template_types)){let r=this._advance().toString(),o=null,c=null;return this._match(re.tokens.less_than)&&(o=this._type_decl(),c=null,this._match(re.tokens.comma)&&(c=this._consume(re.access_mode,"Expected access_mode for pointer").toString()),this._consume(re.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new Ve(r,o,c))}if(this._match(re.keywords.ptr)){let r=this._previous().toString();this._consume(re.tokens.less_than,"Expected '<' for pointer.");const o=this._consume(re.storage_class,"Expected storage_class for pointer");this._consume(re.tokens.comma,"Expected ',' for pointer.");const c=this._type_decl();let d=null;return this._match(re.tokens.comma)&&(d=this._consume(re.access_mode,"Expected access_mode for pointer").toString()),this._consume(re.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new Sf(r,o.toString(),c,d))}const t=this._attribute();if(this._match(re.keywords.array)){let r=null,o=-1;const c=this._previous();let d=null;if(this._match(re.tokens.less_than)){r=this._type_decl(),this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);let y="";if(this._match(re.tokens.comma)){d=this._shift_expression();try{y=d.constEvaluate(this._exec).toString(),d=null}catch{y="1"}}this._consume(re.tokens.greater_than,"Expected '>' for array."),o=y?parseInt(y):0}const a=this._updateNode(new hh(c.toString(),t,r,o));return d&&this._deferArrayCountEval.push({arrayType:a,countNode:d}),a}return null}_texture_sampler_types(){if(this._match(re.sampler_type))return this._updateNode(new rh(this._previous().toString(),null,null));if(this._match(re.depth_texture_type))return this._updateNode(new rh(this._previous().toString(),null,null));if(this._match(re.sampled_texture_type)||this._match(re.multisampled_texture_type)){const e=this._previous();this._consume(re.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(re.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new rh(e.toString(),t,null))}if(this._match(re.storage_texture_type)){const e=this._previous();this._consume(re.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(re.texel_format,"Invalid texel format.").toString();this._consume(re.tokens.comma,"Expected ',' after texel format.");const r=this._consume(re.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(re.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new rh(e.toString(),t,r))}return null}_attribute(){let e=[];for(;this._match(re.tokens.attr);){const t=this._consume(re.attribute_name,"Expected attribute name"),r=this._updateNode(new l1(t.toString(),null));if(this._match(re.tokens.paren_left)){if(r.value=this._consume(re.literal_or_ident,"Expected attribute value").toString(),this._check(re.tokens.comma)){this._advance();do{const o=this._consume(re.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(o)}while(this._match(re.tokens.comma))}this._consume(re.tokens.paren_right,"Expected ')'")}e.push(r)}return e.length==0?null:e}}class DC extends Ss{constructor(e){super(),e&&this.update(e)}update(e){const t=new kC().parse(e);this.updateAST(t)}}function OC(i){const e={attributes:[],bindings:[]};let t;try{t=LC(i)}catch(c){return dt.error(c.message)(),e}for(const c of t.uniforms){const d=[];for(const a of c.type?.members||[])d.push({name:a.name,type:Qv(a.type)});e.bindings.push({type:"uniform",name:c.name,group:c.group,location:c.binding,members:d})}for(const c of t.textures)e.bindings.push({type:"texture",name:c.name,group:c.group,location:c.binding});for(const c of t.samplers)e.bindings.push({type:"sampler",name:c.name,group:c.group,location:c.binding});const r=t.entry.vertex[0],o=r?.inputs.length||0;for(let c=0;c<o;c++){const d=r.inputs[c];if(d.locationType==="location"){const a=Qv(d.type);e.attributes.push({name:d.name,location:Number(d.location),type:a})}}return e}function Qv(i){return i?.format?`${i.name}<${i.format.name}>`:i.name}function LC(i){try{return new DC(i)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw typeof e=="object"&&e?.message&&(t+=`: ${e.message} `),typeof e=="object"&&e?.token&&(t+=e.token.line||""),new Error(t,{cause:e})}}const FC={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...FC}};const On=globalThis.mathgl.config;function BC(i,{precision:e=On.precision}={}){return i=NC(i),`${parseFloat(i.toPrecision(e))}`}function gc(i){return Array.isArray(i)||ArrayBuffer.isView(i)&&!(i instanceof DataView)}function Es(i,e,t){return UC(i,r=>Math.max(e,Math.min(t,r)))}function tp(i,e,t){return gc(i)?i.map((r,o)=>tp(r,e[o],t)):t*e+(1-t)*i}function xh(i,e,t){const r=On.EPSILON;try{if(i===e)return!0;if(gc(i)&&gc(e)){if(i.length!==e.length)return!1;for(let o=0;o<i.length;++o)if(!xh(i[o],e[o]))return!1;return!0}return i&&i.equals?i.equals(e):e&&e.equals?e.equals(i):typeof i=="number"&&typeof e=="number"?Math.abs(i-e)<=On.EPSILON*Math.max(1,Math.abs(i),Math.abs(e)):!1}finally{On.EPSILON=r}}function NC(i){return Math.round(i/On.EPSILON)*On.EPSILON}function zC(i){return i.clone?i.clone():new Array(i.length)}function UC(i,e,t){if(gc(i)){const r=i;t=t||zC(r);for(let o=0;o<t.length&&o<r.length;++o){const c=typeof i=="number"?i:i[o];t[o]=e(c,o,t)}return t}return e(i)}class c1 extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let r=0;r<this.ELEMENTS;++r)this[r]=e[r+t];return this.check()}toArray(e=[],t=0){for(let r=0;r<this.ELEMENTS;++r)e[t+r]=this[r];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:gc(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(On)}formatString(e){let t="";for(let r=0;r<this.ELEMENTS;++r)t+=(r>0?", ":"")+BC(this[r],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!xh(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,r){if(r===void 0)return this.lerp(this,e,t);for(let o=0;o<this.ELEMENTS;++o){const c=e[o],d=typeof t=="number"?t:t[o];this[o]=c+r*(d-c)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e[r]),t[r]);return this.check()}add(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]+=t[r];return this.check()}subtract(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]-=t[r];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(On.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let r=0;r<this.ELEMENTS;++r)this[r]=Math.min(Math.max(this[r],e),t);return this.check()}get elements(){return this}}function VC(i,e){if(i.length!==e)return!1;for(let t=0;t<i.length;++t)if(!Number.isFinite(i[t]))return!1;return!0}function yn(i){if(!Number.isFinite(i))throw new Error(`Invalid number ${JSON.stringify(i)}`);return i}function em(i,e,t=""){if(On.debug&&!VC(i,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return i}function eb(i,e){if(!i)throw new Error(`math.gl assertion ${e}`)}class jC extends c1{get x(){return this[0]}set x(e){this[0]=yn(e)}get y(){return this[1]}set y(e){this[1]=yn(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let r=0;r<this.ELEMENTS;++r){const o=this[r]-e[r];t+=o*o}return yn(t)}dot(e){let t=0;for(let r=0;r<this.ELEMENTS;++r)t+=this[r]*e[r];return yn(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]*=t[r];return this.check()}divide(...e){for(const t of e)for(let r=0;r<this.ELEMENTS;++r)this[r]/=t[r];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return eb(e>=0&&e<this.ELEMENTS,"index is out of range"),yn(this[e])}setComponent(e,t){return eb(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const Af=1e-6;let mc=typeof Float32Array<"u"?Float32Array:Array;function $C(){const i=new mc(2);return mc!=Float32Array&&(i[0]=0,i[1]=0),i}function tb(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i}function WC(i,e){return i[0]=-e[0],i[1]=-e[1],i}function u1(i,e,t,r){const o=e[0],c=e[1];return i[0]=o+r*(t[0]-o),i[1]=c+r*(t[1]-c),i}function HC(i,e,t){const r=e[0],o=e[1];return i[0]=t[0]*r+t[4]*o+t[12],i[1]=t[1]*r+t[5]*o+t[13],i}(function(){const i=$C();return function(e,t,r,o,c,d){let a,y;for(t||(t=2),r||(r=0),o?y=Math.min(o*t+r,e.length):y=e.length,a=r;a<y;a+=t)i[0]=e[a],i[1]=e[a+1],c(i,i,d),e[a]=i[0],e[a+1]=i[1];return e}})();function ZC(i,e,t){const r=e[0],o=e[1],c=t[3]*r+t[7]*o||1;return i[0]=(t[0]*r+t[4]*o)/c,i[1]=(t[1]*r+t[5]*o)/c,i}function h1(i,e,t){const r=e[0],o=e[1],c=e[2],d=t[3]*r+t[7]*o+t[11]*c||1;return i[0]=(t[0]*r+t[4]*o+t[8]*c)/d,i[1]=(t[1]*r+t[5]*o+t[9]*c)/d,i[2]=(t[2]*r+t[6]*o+t[10]*c)/d,i}function qC(i,e,t){const r=e[0],o=e[1];return i[0]=t[0]*r+t[2]*o,i[1]=t[1]*r+t[3]*o,i[2]=e[2],i}function XC(){const i=new mc(3);return mc!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function GC(i){const e=i[0],t=i[1],r=i[2];return Math.sqrt(e*e+t*t+r*r)}function YC(i,e,t){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i}function KC(i){const e=i[0],t=i[1],r=i[2];return e*e+t*t+r*r}function JC(i,e){return i[0]=-e[0],i[1]=-e[1],i[2]=-e[2],i}function QC(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function eI(i,e,t){const r=e[0],o=e[1],c=e[2],d=t[0],a=t[1],y=t[2];return i[0]=o*y-c*a,i[1]=c*d-r*y,i[2]=r*a-o*d,i}function tI(i,e,t,r){const o=e[0],c=e[1],d=e[2];return i[0]=o+r*(t[0]-o),i[1]=c+r*(t[1]-c),i[2]=d+r*(t[2]-d),i}function d1(i,e,t){const r=e[0],o=e[1],c=e[2];let d=t[3]*r+t[7]*o+t[11]*c+t[15];return d=d||1,i[0]=(t[0]*r+t[4]*o+t[8]*c+t[12])/d,i[1]=(t[1]*r+t[5]*o+t[9]*c+t[13])/d,i[2]=(t[2]*r+t[6]*o+t[10]*c+t[14])/d,i}function iI(i,e,t){const r=e[0],o=e[1],c=e[2];return i[0]=r*t[0]+o*t[3]+c*t[6],i[1]=r*t[1]+o*t[4]+c*t[7],i[2]=r*t[2]+o*t[5]+c*t[8],i}function rI(i,e,t){const r=t[0],o=t[1],c=t[2],d=t[3],a=e[0],y=e[1],w=e[2];let E=o*w-c*y,I=c*a-r*w,D=r*y-o*a,F=o*D-c*I,X=c*E-r*D,oe=r*I-o*E;const _e=d*2;return E*=_e,I*=_e,D*=_e,F*=2,X*=2,oe*=2,i[0]=a+E+F,i[1]=y+I+X,i[2]=w+D+oe,i}function nI(i,e,t,r){const o=[],c=[];return o[0]=e[0]-t[0],o[1]=e[1]-t[1],o[2]=e[2]-t[2],c[0]=o[0],c[1]=o[1]*Math.cos(r)-o[2]*Math.sin(r),c[2]=o[1]*Math.sin(r)+o[2]*Math.cos(r),i[0]=c[0]+t[0],i[1]=c[1]+t[1],i[2]=c[2]+t[2],i}function sI(i,e,t,r){const o=[],c=[];return o[0]=e[0]-t[0],o[1]=e[1]-t[1],o[2]=e[2]-t[2],c[0]=o[2]*Math.sin(r)+o[0]*Math.cos(r),c[1]=o[1],c[2]=o[2]*Math.cos(r)-o[0]*Math.sin(r),i[0]=c[0]+t[0],i[1]=c[1]+t[1],i[2]=c[2]+t[2],i}function oI(i,e,t,r){const o=[],c=[];return o[0]=e[0]-t[0],o[1]=e[1]-t[1],o[2]=e[2]-t[2],c[0]=o[0]*Math.cos(r)-o[1]*Math.sin(r),c[1]=o[0]*Math.sin(r)+o[1]*Math.cos(r),c[2]=o[2],i[0]=c[0]+t[0],i[1]=c[1]+t[1],i[2]=c[2]+t[2],i}function aI(i,e){const t=i[0],r=i[1],o=i[2],c=e[0],d=e[1],a=e[2],y=Math.sqrt((t*t+r*r+o*o)*(c*c+d*d+a*a)),w=y&&QC(i,e)/y;return Math.acos(Math.min(Math.max(w,-1),1))}const f1=YC,lI=GC,tm=KC;(function(){const i=XC();return function(e,t,r,o,c,d){let a,y;for(t||(t=3),r||(r=0),o?y=Math.min(o*t+r,e.length):y=e.length,a=r;a<y;a+=t)i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2],c(i,i,d),e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2];return e}})();const im=[0,0,0];let of;class As extends jC{static get ZERO(){return of||(of=new As(0,0,0),Object.freeze(of)),of}constructor(e=0,t=0,r=0){super(-0,-0,-0),arguments.length===1&&gc(e)?this.copy(e):(On.debug&&(yn(e),yn(t),yn(r)),this[0]=e,this[1]=t,this[2]=r)}set(e,t,r){return this[0]=e,this[1]=t,this[2]=r,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return On.debug&&(yn(e.x),yn(e.y),yn(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=yn(e)}angle(e){return aI(this,e)}cross(e){return eI(this,this,e),this.check()}rotateX({radians:e,origin:t=im}){return nI(this,this,t,e),this.check()}rotateY({radians:e,origin:t=im}){return sI(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=im}){return oI(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return d1(this,this,e),this.check()}transformAsVector(e){return h1(this,this,e),this.check()}transformByMatrix3(e){return iI(this,this,e),this.check()}transformByMatrix2(e){return qC(this,this,e),this.check()}transformByQuaternion(e){return rI(this,this,e),this.check()}}class cI extends c1{toString(){let e="[";if(On.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let r=0;r<this.RANK;++r)e+=` ${this[r*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,r){return this[t*this.RANK+e]=yn(r),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const r=e*this.RANK;for(let o=0;o<this.RANK;++o)t[o]=this[r+o];return t}setColumn(e,t){const r=e*this.RANK;for(let o=0;o<this.RANK;++o)this[r+o]=t[o];return this}}function uI(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function hI(i,e){if(i===e){const t=e[1],r=e[2],o=e[3],c=e[6],d=e[7],a=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=t,i[6]=e[9],i[7]=e[13],i[8]=r,i[9]=c,i[11]=e[14],i[12]=o,i[13]=d,i[14]=a}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i}function qm(i,e){const t=e[0],r=e[1],o=e[2],c=e[3],d=e[4],a=e[5],y=e[6],w=e[7],E=e[8],I=e[9],D=e[10],F=e[11],X=e[12],oe=e[13],_e=e[14],ge=e[15],fe=t*a-r*d,Te=t*y-o*d,ke=t*w-c*d,Je=r*y-o*a,Xe=r*w-c*a,mt=o*w-c*y,G=E*oe-I*X,J=E*_e-D*X,ae=E*ge-F*X,be=I*_e-D*oe,ye=I*ge-F*oe,we=D*ge-F*_e;let Se=fe*we-Te*ye+ke*be+Je*ae-Xe*J+mt*G;return Se?(Se=1/Se,i[0]=(a*we-y*ye+w*be)*Se,i[1]=(o*ye-r*we-c*be)*Se,i[2]=(oe*mt-_e*Xe+ge*Je)*Se,i[3]=(D*Xe-I*mt-F*Je)*Se,i[4]=(y*ae-d*we-w*J)*Se,i[5]=(t*we-o*ae+c*J)*Se,i[6]=(_e*ke-X*mt-ge*Te)*Se,i[7]=(E*mt-D*ke+F*Te)*Se,i[8]=(d*ye-a*ae+w*G)*Se,i[9]=(r*ae-t*ye-c*G)*Se,i[10]=(X*Xe-oe*ke+ge*fe)*Se,i[11]=(I*ke-E*Xe-F*fe)*Se,i[12]=(a*J-d*be-y*G)*Se,i[13]=(t*be-r*J+o*G)*Se,i[14]=(oe*Te-X*Je-_e*fe)*Se,i[15]=(E*Je-I*Te+D*fe)*Se,i):null}function dI(i){const e=i[0],t=i[1],r=i[2],o=i[3],c=i[4],d=i[5],a=i[6],y=i[7],w=i[8],E=i[9],I=i[10],D=i[11],F=i[12],X=i[13],oe=i[14],_e=i[15],ge=e*d-t*c,fe=e*a-r*c,Te=t*a-r*d,ke=w*X-E*F,Je=w*oe-I*F,Xe=E*oe-I*X,mt=e*Xe-t*Je+r*ke,G=c*Xe-d*Je+a*ke,J=w*Te-E*fe+I*ge,ae=F*Te-X*fe+oe*ge;return y*mt-o*G+_e*J-D*ae}function ka(i,e,t){const r=e[0],o=e[1],c=e[2],d=e[3],a=e[4],y=e[5],w=e[6],E=e[7],I=e[8],D=e[9],F=e[10],X=e[11],oe=e[12],_e=e[13],ge=e[14],fe=e[15];let Te=t[0],ke=t[1],Je=t[2],Xe=t[3];return i[0]=Te*r+ke*a+Je*I+Xe*oe,i[1]=Te*o+ke*y+Je*D+Xe*_e,i[2]=Te*c+ke*w+Je*F+Xe*ge,i[3]=Te*d+ke*E+Je*X+Xe*fe,Te=t[4],ke=t[5],Je=t[6],Xe=t[7],i[4]=Te*r+ke*a+Je*I+Xe*oe,i[5]=Te*o+ke*y+Je*D+Xe*_e,i[6]=Te*c+ke*w+Je*F+Xe*ge,i[7]=Te*d+ke*E+Je*X+Xe*fe,Te=t[8],ke=t[9],Je=t[10],Xe=t[11],i[8]=Te*r+ke*a+Je*I+Xe*oe,i[9]=Te*o+ke*y+Je*D+Xe*_e,i[10]=Te*c+ke*w+Je*F+Xe*ge,i[11]=Te*d+ke*E+Je*X+Xe*fe,Te=t[12],ke=t[13],Je=t[14],Xe=t[15],i[12]=Te*r+ke*a+Je*I+Xe*oe,i[13]=Te*o+ke*y+Je*D+Xe*_e,i[14]=Te*c+ke*w+Je*F+Xe*ge,i[15]=Te*d+ke*E+Je*X+Xe*fe,i}function ip(i,e,t){const r=t[0],o=t[1],c=t[2];let d,a,y,w,E,I,D,F,X,oe,_e,ge;return e===i?(i[12]=e[0]*r+e[4]*o+e[8]*c+e[12],i[13]=e[1]*r+e[5]*o+e[9]*c+e[13],i[14]=e[2]*r+e[6]*o+e[10]*c+e[14],i[15]=e[3]*r+e[7]*o+e[11]*c+e[15]):(d=e[0],a=e[1],y=e[2],w=e[3],E=e[4],I=e[5],D=e[6],F=e[7],X=e[8],oe=e[9],_e=e[10],ge=e[11],i[0]=d,i[1]=a,i[2]=y,i[3]=w,i[4]=E,i[5]=I,i[6]=D,i[7]=F,i[8]=X,i[9]=oe,i[10]=_e,i[11]=ge,i[12]=d*r+E*o+X*c+e[12],i[13]=a*r+I*o+oe*c+e[13],i[14]=y*r+D*o+_e*c+e[14],i[15]=w*r+F*o+ge*c+e[15]),i}function H_(i,e,t){const r=t[0],o=t[1],c=t[2];return i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i[3]=e[3]*r,i[4]=e[4]*o,i[5]=e[5]*o,i[6]=e[6]*o,i[7]=e[7]*o,i[8]=e[8]*c,i[9]=e[9]*c,i[10]=e[10]*c,i[11]=e[11]*c,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function fI(i,e,t,r){let o=r[0],c=r[1],d=r[2],a=Math.sqrt(o*o+c*c+d*d),y,w,E,I,D,F,X,oe,_e,ge,fe,Te,ke,Je,Xe,mt,G,J,ae,be,ye,we,Se,Ee;return a<Af?null:(a=1/a,o*=a,c*=a,d*=a,w=Math.sin(t),y=Math.cos(t),E=1-y,I=e[0],D=e[1],F=e[2],X=e[3],oe=e[4],_e=e[5],ge=e[6],fe=e[7],Te=e[8],ke=e[9],Je=e[10],Xe=e[11],mt=o*o*E+y,G=c*o*E+d*w,J=d*o*E-c*w,ae=o*c*E-d*w,be=c*c*E+y,ye=d*c*E+o*w,we=o*d*E+c*w,Se=c*d*E-o*w,Ee=d*d*E+y,i[0]=I*mt+oe*G+Te*J,i[1]=D*mt+_e*G+ke*J,i[2]=F*mt+ge*G+Je*J,i[3]=X*mt+fe*G+Xe*J,i[4]=I*ae+oe*be+Te*ye,i[5]=D*ae+_e*be+ke*ye,i[6]=F*ae+ge*be+Je*ye,i[7]=X*ae+fe*be+Xe*ye,i[8]=I*we+oe*Se+Te*Ee,i[9]=D*we+_e*Se+ke*Ee,i[10]=F*we+ge*Se+Je*Ee,i[11]=X*we+fe*Se+Xe*Ee,e!==i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i)}function p1(i,e,t){const r=Math.sin(t),o=Math.cos(t),c=e[4],d=e[5],a=e[6],y=e[7],w=e[8],E=e[9],I=e[10],D=e[11];return e!==i&&(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[4]=c*o+w*r,i[5]=d*o+E*r,i[6]=a*o+I*r,i[7]=y*o+D*r,i[8]=w*o-c*r,i[9]=E*o-d*r,i[10]=I*o-a*r,i[11]=D*o-y*r,i}function pI(i,e,t){const r=Math.sin(t),o=Math.cos(t),c=e[0],d=e[1],a=e[2],y=e[3],w=e[8],E=e[9],I=e[10],D=e[11];return e!==i&&(i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=c*o-w*r,i[1]=d*o-E*r,i[2]=a*o-I*r,i[3]=y*o-D*r,i[8]=c*r+w*o,i[9]=d*r+E*o,i[10]=a*r+I*o,i[11]=y*r+D*o,i}function g1(i,e,t){const r=Math.sin(t),o=Math.cos(t),c=e[0],d=e[1],a=e[2],y=e[3],w=e[4],E=e[5],I=e[6],D=e[7];return e!==i&&(i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i[0]=c*o+w*r,i[1]=d*o+E*r,i[2]=a*o+I*r,i[3]=y*o+D*r,i[4]=w*o-c*r,i[5]=E*o-d*r,i[6]=I*o-a*r,i[7]=D*o-y*r,i}function gI(i,e){const t=e[0],r=e[1],o=e[2],c=e[3],d=t+t,a=r+r,y=o+o,w=t*d,E=r*d,I=r*a,D=o*d,F=o*a,X=o*y,oe=c*d,_e=c*a,ge=c*y;return i[0]=1-I-X,i[1]=E+ge,i[2]=D-_e,i[3]=0,i[4]=E-ge,i[5]=1-w-X,i[6]=F+oe,i[7]=0,i[8]=D+_e,i[9]=F-oe,i[10]=1-w-I,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function mI(i,e,t,r,o,c,d){const a=1/(t-e),y=1/(o-r),w=1/(c-d);return i[0]=c*2*a,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=c*2*y,i[6]=0,i[7]=0,i[8]=(t+e)*a,i[9]=(o+r)*y,i[10]=(d+c)*w,i[11]=-1,i[12]=0,i[13]=0,i[14]=d*c*2*w,i[15]=0,i}function _I(i,e,t,r,o){const c=1/Math.tan(e/2);if(i[0]=c/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=c,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,o!=null&&o!==1/0){const d=1/(r-o);i[10]=(o+r)*d,i[14]=2*o*r*d}else i[10]=-1,i[14]=-2*r;return i}const yI=_I;function xI(i,e,t,r,o,c,d){const a=1/(e-t),y=1/(r-o),w=1/(c-d);return i[0]=-2*a,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*y,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*w,i[11]=0,i[12]=(e+t)*a,i[13]=(o+r)*y,i[14]=(d+c)*w,i[15]=1,i}const vI=xI;function bI(i,e,t,r){let o,c,d,a,y,w,E,I,D,F;const X=e[0],oe=e[1],_e=e[2],ge=r[0],fe=r[1],Te=r[2],ke=t[0],Je=t[1],Xe=t[2];return Math.abs(X-ke)<Af&&Math.abs(oe-Je)<Af&&Math.abs(_e-Xe)<Af?uI(i):(I=X-ke,D=oe-Je,F=_e-Xe,o=1/Math.sqrt(I*I+D*D+F*F),I*=o,D*=o,F*=o,c=fe*F-Te*D,d=Te*I-ge*F,a=ge*D-fe*I,o=Math.sqrt(c*c+d*d+a*a),o?(o=1/o,c*=o,d*=o,a*=o):(c=0,d=0,a=0),y=D*a-F*d,w=F*c-I*a,E=I*d-D*c,o=Math.sqrt(y*y+w*w+E*E),o?(o=1/o,y*=o,w*=o,E*=o):(y=0,w=0,E=0),i[0]=c,i[1]=y,i[2]=I,i[3]=0,i[4]=d,i[5]=w,i[6]=D,i[7]=0,i[8]=a,i[9]=E,i[10]=F,i[11]=0,i[12]=-(c*X+d*oe+a*_e),i[13]=-(y*X+w*oe+E*_e),i[14]=-(I*X+D*oe+F*_e),i[15]=1,i)}function wI(){const i=new mc(4);return mc!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function m1(i,e,t){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i}function Tc(i,e,t){const r=e[0],o=e[1],c=e[2],d=e[3];return i[0]=t[0]*r+t[4]*o+t[8]*c+t[12]*d,i[1]=t[1]*r+t[5]*o+t[9]*c+t[13]*d,i[2]=t[2]*r+t[6]*o+t[10]*c+t[14]*d,i[3]=t[3]*r+t[7]*o+t[11]*c+t[15]*d,i}(function(){const i=wI();return function(e,t,r,o,c,d){let a,y;for(t||(t=4),r||(r=0),o?y=Math.min(o*t+r,e.length):y=e.length,a=r;a<y;a+=t)i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2],i[3]=e[a+3],c(i,i,d),e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2],e[a+3]=i[3];return e}})();var Xm;(function(i){i[i.COL0ROW0=0]="COL0ROW0",i[i.COL0ROW1=1]="COL0ROW1",i[i.COL0ROW2=2]="COL0ROW2",i[i.COL0ROW3=3]="COL0ROW3",i[i.COL1ROW0=4]="COL1ROW0",i[i.COL1ROW1=5]="COL1ROW1",i[i.COL1ROW2=6]="COL1ROW2",i[i.COL1ROW3=7]="COL1ROW3",i[i.COL2ROW0=8]="COL2ROW0",i[i.COL2ROW1=9]="COL2ROW1",i[i.COL2ROW2=10]="COL2ROW2",i[i.COL2ROW3=11]="COL2ROW3",i[i.COL3ROW0=12]="COL3ROW0",i[i.COL3ROW1=13]="COL3ROW1",i[i.COL3ROW2=14]="COL3ROW2",i[i.COL3ROW3=15]="COL3ROW3"})(Xm||(Xm={}));const TI=45*Math.PI/180,SI=1,rm=.1,nm=500,EI=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class ts extends cI{static get IDENTITY(){return PI()}static get ZERO(){return AI()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return Xm}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,r,o,c,d,a,y,w,E,I,D,F,X,oe,_e){return this[0]=e,this[1]=t,this[2]=r,this[3]=o,this[4]=c,this[5]=d,this[6]=a,this[7]=y,this[8]=w,this[9]=E,this[10]=I,this[11]=D,this[12]=F,this[13]=X,this[14]=oe,this[15]=_e,this.check()}setRowMajor(e,t,r,o,c,d,a,y,w,E,I,D,F,X,oe,_e){return this[0]=e,this[1]=c,this[2]=w,this[3]=F,this[4]=t,this[5]=d,this[6]=E,this[7]=X,this[8]=r,this[9]=a,this[10]=I,this[11]=oe,this[12]=o,this[13]=y,this[14]=D,this[15]=_e,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(EI)}fromObject(e){return this.check()}fromQuaternion(e){return gI(this,e),this.check()}frustum(e){const{left:t,right:r,bottom:o,top:c,near:d=rm,far:a=nm}=e;return a===1/0?CI(this,t,r,o,c,d):mI(this,t,r,o,c,d,a),this.check()}lookAt(e){const{eye:t,center:r=[0,0,0],up:o=[0,1,0]}=e;return bI(this,t,r,o),this.check()}ortho(e){const{left:t,right:r,bottom:o,top:c,near:d=rm,far:a=nm}=e;return vI(this,t,r,o,c,d,a),this.check()}orthographic(e){const{fovy:t=TI,aspect:r=SI,focalDistance:o=1,near:c=rm,far:d=nm}=e;ib(t);const a=t/2,y=o*Math.tan(a),w=y*r;return this.ortho({left:-w,right:w,bottom:-y,top:y,near:c,far:d})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:r=1,near:o=.1,far:c=500}=e;return ib(t),yI(this,t,r,o,c),this.check()}determinant(){return dI(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const r=this.getScale(t),o=1/r[0],c=1/r[1],d=1/r[2];return e[0]=this[0]*o,e[1]=this[1]*c,e[2]=this[2]*d,e[3]=0,e[4]=this[4]*o,e[5]=this[5]*c,e[6]=this[6]*d,e[7]=0,e[8]=this[8]*o,e[9]=this[9]*c,e[10]=this[10]*d,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const r=this.getScale(t),o=1/r[0],c=1/r[1],d=1/r[2];return e[0]=this[0]*o,e[1]=this[1]*c,e[2]=this[2]*d,e[3]=this[4]*o,e[4]=this[5]*c,e[5]=this[6]*d,e[6]=this[8]*o,e[7]=this[9]*c,e[8]=this[10]*d,e}transpose(){return hI(this,this),this.check()}invert(){return qm(this,this),this.check()}multiplyLeft(e){return ka(this,e,this),this.check()}multiplyRight(e){return ka(this,this,e),this.check()}rotateX(e){return p1(this,this,e),this.check()}rotateY(e){return pI(this,this,e),this.check()}rotateZ(e){return g1(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return fI(this,this,e,t),this.check()}scale(e){return H_(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return ip(this,this,e),this.check()}transform(e,t){return e.length===4?(t=Tc(t||[-0,-0,-0,-0],e,this),em(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:r}=e;let o;switch(r){case 2:o=HC(t||[-0,-0],e,this);break;case 3:o=d1(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return em(o,e.length),o}transformAsVector(e,t){let r;switch(e.length){case 2:r=ZC(t||[-0,-0],e,this);break;case 3:r=h1(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return em(r,e.length),r}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,r){return this.identity().translate([e,t,r])}}let af,lf;function AI(){return af||(af=new ts([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(af)),af}function PI(){return lf||(lf=new ts,Object.freeze(lf)),lf}function ib(i){if(i>Math.PI*2)throw Error("expected radians")}function CI(i,e,t,r,o,c){const d=2*c/(t-e),a=2*c/(o-r),y=(t+e)/(t-e),w=(o+r)/(o-r),E=-1,I=-1,D=-2*c;return i[0]=d,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a,i[6]=0,i[7]=0,i[8]=y,i[9]=w,i[10]=E,i[11]=I,i[12]=0,i[13]=0,i[14]=D,i[15]=0,i}function _1(i,e=[],t=0){const r=Math.fround(i),o=i-r;return e[t]=r,e[t+1]=o,e}function II(i){return i-Math.fround(i)}function MI(i){const e=new Float32Array(32);for(let t=0;t<4;++t)for(let r=0;r<4;++r){const o=t*4+r;_1(i[r*4+t],e,o*2)}return e}const RI=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,kI={name:"fp32",vs:RI},DI=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,OI={ONE:1},LI={name:"fp64arithmetic",vs:DI,defaultUniforms:OI,uniformTypes:{ONE:"f32"},fp64ify:_1,fp64LowPart:II,fp64ifyMatrix4:MI},FI=[0,1,1,1],BI=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,NI=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,rb={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:FI},vs:BI,fs:NI,getUniforms:zI};function zI(i={},e){const t={};if(i.highlightedObjectColor!==void 0)if(i.highlightedObjectColor===null)t.isHighlightActive=!1;else{t.isHighlightActive=!0;const r=i.highlightedObjectColor.slice(0,3);t.highlightedObjectColor=r}if(i.highlightColor){const r=Array.from(i.highlightColor,o=>o/255);Number.isFinite(r[3])||(r[3]=1),t.highlightColor=r}return i.isActive!==void 0&&(t.isActive=!!i.isActive,t.isAttribute=!!i.isAttribute),i.useFloatColors!==void 0&&(t.useFloatColors=!!i.useFloatColors),t}const nb=`precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,UI=`// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  pointLightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`,VI=5,jI=255;var vh;(function(i){i[i.POINT=0]="POINT",i[i.DIRECTIONAL=1]="DIRECTIONAL"})(vh||(vh={}));const Pf={props:{},uniforms:{},name:"lighting",defines:{},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:vh.POINT,directionalLightCount:0,pointLightCount:0,ambientColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:UI,vs:nb,fs:nb,getUniforms:$I};function $I(i,e={}){if(i=i&&{...i},!i)return{...Pf.defaultUniforms};i.lights&&(i={...i,...HI(i.lights),lights:void 0});const{ambientLight:t,pointLights:r,directionalLights:o}=i||{};if(!(t||r&&r.length>0||o&&o.length>0))return{...Pf.defaultUniforms,enabled:0};const d={...Pf.defaultUniforms,...e,...WI({ambientLight:t,pointLights:r,directionalLights:o})};return i.enabled!==void 0&&(d.enabled=i.enabled?1:0),d}function WI({ambientLight:i,pointLights:e=[],directionalLights:t=[]}){const r={};r.ambientColor=sm(i);let o=0;for(const c of e){r.lightType=vh.POINT;const d=o;r[`lightColor${d}`]=sm(c),r[`lightPosition${d}`]=c.position,r[`lightAttenuation${d}`]=c.attenuation||[1,0,0],o++}for(const c of t){r.lightType=vh.DIRECTIONAL;const d=o;r[`lightColor${d}`]=sm(c),r[`lightDirection${d}`]=c.direction,o++}return o>VI&&dt.warn("MAX_LIGHTS exceeded")(),r.directionalLightCount=t.length,r.pointLightCount=e.length,r}function HI(i){const e={pointLights:[],directionalLights:[]};for(const t of i||[])switch(t.type){case"ambient":e.ambientLight=t;break;case"directional":e.directionalLights?.push(t);break;case"point":e.pointLights?.push(t);break}return e}function sm(i={}){const{color:e=[0,0,0],intensity:t=1}=i;return e.map(r=>r*t/jI)}const ZI=`uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,qI=`#define MAX_LIGHTS 3

uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,XI=`struct phongMaterialUniforms {
  ambient: f32,
  diffuse: f32,
  shininess: f32,
  specularColor: vec3<f32>,
};

@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;

fn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {
  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);
  var lambertian: f32 = dot(light_direction, normal_worldspace);
  var specular: f32 = 0.0;
  if (lambertian > 0.0) {
    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, phongMaterial.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;
}

fn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {
  var lightColor: vec3<f32> = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);
  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;

  if (lighting.lightType == 0) {
    let pointLight: PointLight  = lighting_getPointLight(0);
    let light_position_worldspace: vec3<f32> = pointLight.position;
    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  } else if (lighting.lightType == 1) {
    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
  /*
  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.pointLightCount) {
      break;
    }
    PointLight pointLight = lighting.pointLight[i];
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  }

  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.directionalLightCount) {
      break;
    }
    DirectionalLight directionalLight = lighting.directionalLight[i];
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  */
}

fn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{
  var lightColor = vec3<f32>(0, 0, 0);
  let surfaceColor = vec3<f32>(0, 0, 0);

  if (lighting.enabled == 0) {
    let view_direction = normalize(cameraPosition - position_worldspace);

    switch (lighting.lightType) {
      case 0, default: {
        let pointLight: PointLight = lighting_getPointLight(0);
        let light_position_worldspace: vec3<f32> = pointLight.position;
        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
      }
      case 1: {
        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
      }
    }
  }
  return lightColor;
}
`,y1={props:{},name:"gouraudMaterial",vs:qI.replace("phongMaterial","gouraudMaterial"),fs:ZI.replace("phongMaterial","gouraudMaterial"),source:XI.replaceAll("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:!0},dependencies:[Pf],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(i){const e={...i};return e.specularColor&&(e.specularColor=e.specularColor.map(t=>t/255)),{...y1.defaultUniforms,...e}}},sb=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,GI={name:"layer",vs:sb,fs:sb,getUniforms:i=>({opacity:Math.pow(i.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},YI=`

struct ColorUniforms {
  opacity: f32,
};

var<private> color: ColorUniforms = ColorUniforms(1.0);
// TODO (kaapp) avoiding binding index collisions to handle layer opacity 
// requires some thought.
// @group(0) @binding(0) var<uniform> color: ColorUniforms;

@must_use
fn deckgl_premultiplied_alpha(fragColor: vec4<f32>) -> vec4<f32> {
    return vec4(fragColor.rgb * fragColor.a, fragColor.a); 
};
`,KI={name:"color",dependencies:[],source:YI,getUniforms:i=>({}),uniformTypes:{opacity:"f32"}},JI=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,x1="#define SMOOTH_EDGE_RADIUS 0.5",QI=`${x1}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,eM=`${x1}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,v1={name:"geometry",source:JI,vs:QI,fs:eM},tM=25;var hr;(function(i){i[i.Start=1]="Start",i[i.Move=2]="Move",i[i.End=4]="End",i[i.Cancel=8]="Cancel"})(hr||(hr={}));var yr;(function(i){i[i.None=0]="None",i[i.Left=1]="Left",i[i.Right=2]="Right",i[i.Up=4]="Up",i[i.Down=8]="Down",i[i.Horizontal=3]="Horizontal",i[i.Vertical=12]="Vertical",i[i.All=15]="All"})(yr||(yr={}));var Gt;(function(i){i[i.Possible=1]="Possible",i[i.Began=2]="Began",i[i.Changed=4]="Changed",i[i.Ended=8]="Ended",i[i.Recognized=8]="Recognized",i[i.Cancelled=16]="Cancelled",i[i.Failed=32]="Failed"})(Gt||(Gt={}));const iM="compute",rM="auto",Gm="manipulation",Cf="none",Ym="pan-x",Km="pan-y";function nM(i){if(i.includes(Cf))return Cf;const e=i.includes(Ym),t=i.includes(Km);return e&&t?Cf:e||t?e?Ym:Km:i.includes(Gm)?Gm:rM}class sM{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){e===iM&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return nM(e.join(" "))}}function rp(i){return i.trim().split(/\s+/g)}function om(i,e,t){if(i)for(const r of rp(e))i.addEventListener(r,t,!1)}function am(i,e,t){if(i)for(const r of rp(e))i.removeEventListener(r,t,!1)}function ob(i){return(i.ownerDocument||i).defaultView}function oM(i,e){let t=i;for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function b1(i){const e=i.length;if(e===1)return{x:Math.round(i[0].clientX),y:Math.round(i[0].clientY)};let t=0,r=0,o=0;for(;o<e;)t+=i[o].clientX,r+=i[o].clientY,o++;return{x:Math.round(t/e),y:Math.round(r/e)}}function ab(i){const e=[];let t=0;for(;t<i.pointers.length;)e[t]={clientX:Math.round(i.pointers[t].clientX),clientY:Math.round(i.pointers[t].clientY)},t++;return{timeStamp:Date.now(),pointers:e,center:b1(e),deltaX:i.deltaX,deltaY:i.deltaY}}function w1(i,e){const t=e.x-i.x,r=e.y-i.y;return Math.sqrt(t*t+r*r)}function lb(i,e){const t=e.clientX-i.clientX,r=e.clientY-i.clientY;return Math.sqrt(t*t+r*r)}function aM(i,e){const t=e.x-i.x,r=e.y-i.y;return Math.atan2(r,t)*180/Math.PI}function cb(i,e){const t=e.clientX-i.clientX,r=e.clientY-i.clientY;return Math.atan2(r,t)*180/Math.PI}function T1(i,e){return i===e?yr.None:Math.abs(i)>=Math.abs(e)?i<0?yr.Left:yr.Right:e<0?yr.Up:yr.Down}function lM(i,e){const t=e.center;let r=i.offsetDelta,o=i.prevDelta;const c=i.prevInput;return(e.eventType===hr.Start||c?.eventType===hr.End)&&(o=i.prevDelta={x:c?.deltaX||0,y:c?.deltaY||0},r=i.offsetDelta={x:t.x,y:t.y}),{deltaX:o.x+(t.x-r.x),deltaY:o.y+(t.y-r.y)}}function S1(i,e,t){return{x:e/i||0,y:t/i||0}}function cM(i,e){return lb(e[0],e[1])/lb(i[0],i[1])}function uM(i,e){return cb(e[1],e[0])-cb(i[1],i[0])}function hM(i,e){const t=i.lastInterval||e,r=e.timeStamp-t.timeStamp;let o,c,d,a;if(e.eventType!==hr.Cancel&&(r>tM||t.velocity===void 0)){const y=e.deltaX-t.deltaX,w=e.deltaY-t.deltaY,E=S1(r,y,w);c=E.x,d=E.y,o=Math.abs(E.x)>Math.abs(E.y)?E.x:E.y,a=T1(y,w),i.lastInterval=e}else o=t.velocity,c=t.velocityX,d=t.velocityY,a=t.direction;e.velocity=o,e.velocityX=c,e.velocityY=d,e.direction=a}function dM(i,e){const{session:t}=i,{pointers:r}=e,{length:o}=r;t.firstInput||(t.firstInput=ab(e)),o>1&&!t.firstMultiple?t.firstMultiple=ab(e):o===1&&(t.firstMultiple=!1);const{firstInput:c,firstMultiple:d}=t,a=d?d.center:c.center,y=e.center=b1(r);e.timeStamp=Date.now(),e.deltaTime=e.timeStamp-c.timeStamp,e.angle=aM(a,y),e.distance=w1(a,y);const{deltaX:w,deltaY:E}=lM(t,e);e.deltaX=w,e.deltaY=E,e.offsetDirection=T1(e.deltaX,e.deltaY);const I=S1(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=I.x,e.overallVelocityY=I.y,e.overallVelocity=Math.abs(I.x)>Math.abs(I.y)?I.x:I.y,e.scale=d?cM(d.pointers,r):1,e.rotation=d?uM(d.pointers,r):0,e.maxPointers=t.prevInput?e.pointers.length>t.prevInput.maxPointers?e.pointers.length:t.prevInput.maxPointers:e.pointers.length;let D=i.element;return oM(e.srcEvent.target,D)&&(D=e.srcEvent.target),e.target=D,hM(t,e),e}function fM(i,e,t){const r=t.pointers.length,o=t.changedPointers.length,c=e&hr.Start&&r-o===0,d=e&(hr.End|hr.Cancel)&&r-o===0;t.isFirst=!!c,t.isFinal=!!d,c&&(i.session={}),t.eventType=e;const a=dM(i,t);i.emit("hammer.input",a),i.recognize(a),i.session.prevInput=a}let pM=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=t=>{this.manager.options.enable&&this.handler(t)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){fM(this.manager,e,t)}init(){om(this.element,this.evEl,this.domHandler),om(this.target,this.evTarget,this.domHandler),om(ob(this.element),this.evWin,this.domHandler)}destroy(){am(this.element,this.evEl,this.domHandler),am(this.target,this.evTarget,this.domHandler),am(ob(this.element),this.evWin,this.domHandler)}};const gM={pointerdown:hr.Start,pointermove:hr.Move,pointerup:hr.End,pointercancel:hr.Cancel,pointerout:hr.Cancel},mM="pointerdown",_M="pointermove pointerup pointercancel";class yM extends pM{constructor(e){super(e),this.evEl=mM,this.evWin=_M,this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:t}=this;let r=!1;const o=gM[e.type],c=e.pointerType,d=c==="touch";let a=t.findIndex(y=>y.pointerId===e.pointerId);o&hr.Start&&(e.buttons||d)?a<0&&(t.push(e),a=t.length-1):o&(hr.End|hr.Cancel)&&(r=!0),!(a<0)&&(t[a]=e,this.callback(o,{pointers:t,changedPointers:[e],eventType:o,pointerType:c,srcEvent:e}),r&&t.splice(a,1))}}const xM=["","webkit","Moz","MS","ms","o"];function vM(i,e){const t=e[0].toUpperCase()+e.slice(1);for(const r of xM){const o=r?r+t:e;if(o in i)return o}}const bM=1,ub=2,hb={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class wM{constructor(e,t){this.options={...hb,...t,cssProps:{...hb.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new yM(this),this.touchAction=new sM(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?ub:bM}recognize(e){const{session:t}=this;if(t.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let r;const{recognizers:o}=this;let{curRecognizer:c}=t;(!c||c&&c.state&Gt.Recognized)&&(c=t.curRecognizer=null);let d=0;for(;d<o.length;)r=o[d],t.stopped!==ub&&(!c||r===c||r.canRecognizeWith(c))?r.recognize(e):r.reset(),!c&&r.state&(Gt.Began|Gt.Changed|Gt.Ended)&&(c=t.curRecognizer=r),d++}get(e){const{recognizers:t}=this;for(let r=0;r<t.length;r++)if(t[r].options.event===e)return t[r];return null}add(e){if(Array.isArray(e)){for(const r of e)this.add(r);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const r of e)this.remove(r);return this}const t=typeof e=="string"?this.get(e):e;if(t){const{recognizers:r}=this,o=r.indexOf(t);o!==-1&&(r.splice(o,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:r}=this;for(const o of rp(e))r[o]=r[o]||[],r[o].push(t)}off(e,t){if(!e)return;const{handlers:r}=this;for(const o of rp(e))t?r[o]&&r[o].splice(r[o].indexOf(t),1):delete r[o]}emit(e,t){const r=this.handlers[e]&&this.handlers[e].slice();if(!r||!r.length)return;const o=t;o.type=e,o.preventDefault=function(){t.srcEvent.preventDefault()};let c=0;for(;c<r.length;)r[c](o),c++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[r,o]of Object.entries(this.options.cssProps)){const c=vM(t.style,r);e?(this.oldCssProps[c]=t.style[c],t.style[c]=o):t.style[c]=this.oldCssProps[c]||""}e||(this.oldCssProps={})}}}let TM=1;function SM(){return TM++}function db(i){return i&Gt.Cancelled?"cancel":i&Gt.Ended?"end":i&Gt.Changed?"move":i&Gt.Began?"start":""}class E1{constructor(e){this.options=e,this.id=SM(),this.state=Gt.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const o of e)this.recognizeWith(o);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{simultaneous:r}=this;return r[t.id]||(r[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const r of e)this.dropRecognizeWith(r);return this}let t;return typeof e=="string"?t=this.manager.get(e):t=e,t&&delete this.simultaneous[t.id],this}requireFailure(e){if(Array.isArray(e)){for(const o of e)this.requireFailure(o);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{requireFail:r}=this;return r.indexOf(t)===-1&&(r.push(t),t.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const r of e)this.dropRequireFailure(r);return this}let t;if(typeof e=="string"?t=this.manager.get(e):t=e,t){const r=this.requireFail.indexOf(t);r>-1&&this.requireFail.splice(r,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;const{state:t}=this;t<Gt.Ended&&this.manager.emit(this.options.event+db(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=Gt.Ended&&this.manager.emit(this.options.event+db(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=Gt.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(Gt.Failed|Gt.Possible)))return!1;e++}return!0}recognize(e){const t={...e};if(!this.options.enable){this.reset(),this.state=Gt.Failed;return}this.state&(Gt.Recognized|Gt.Cancelled|Gt.Failed)&&(this.state=Gt.Possible),this.state=this.process(t),this.state&(Gt.Began|Gt.Changed|Gt.Ended|Gt.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class A1 extends E1{attrTest(e){const t=this.options.pointers;return t===0||e.pointers.length===t}process(e){const{state:t}=this,{eventType:r}=e,o=t&(Gt.Began|Gt.Changed),c=this.attrTest(e);return o&&(r&hr.Cancel||!c)?t|Gt.Cancelled:o||c?r&hr.End?t|Gt.Ended:t&Gt.Began?t|Gt.Changed:Gt.Began:Gt.Failed}}class fb extends E1{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[Gm]}process(e){const{options:t}=this,r=e.pointers.length===t.pointers,o=e.distance<t.threshold,c=e.deltaTime<t.time;if(this.reset(),e.eventType&hr.Start&&this.count===0)return this.failTimeout();if(o&&c&&r){if(e.eventType!==hr.End)return this.failTimeout();const d=this.pTime?e.timeStamp-this.pTime<t.interval:!0,a=!this.pCenter||w1(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,!a||!d?this.count=1:this.count+=1,this._input=e,this.count%t.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=Gt.Recognized,this.tryEmit(this._input)},t.interval),Gt.Began):Gt.Recognized}return Gt.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=Gt.Failed},this.options.interval),Gt.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===Gt.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const EM=["","start","move","end","cancel","up","down","left","right"];class pb extends A1{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:yr.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,t=[];return e&yr.Horizontal&&t.push(Km),e&yr.Vertical&&t.push(Ym),t}getEventNames(){return EM.map(e=>this.options.event+e)}directionTest(e){const{options:t}=this;let r=!0,{distance:o}=e,{direction:c}=e;const d=e.deltaX,a=e.deltaY;return c&t.direction||(t.direction&yr.Horizontal?(c=d===0?yr.None:d<0?yr.Left:yr.Right,r=d!==this.pX,o=Math.abs(e.deltaX)):(c=a===0?yr.None:a<0?yr.Up:yr.Down,r=a!==this.pY,o=Math.abs(e.deltaY))),e.direction=c,r&&o>t.threshold&&!!(c&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&Gt.Began)||!(this.state&Gt.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const t=yr[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}const AM=["","start","move","end","cancel","in","out"];class PM extends A1{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[Cf]}getEventNames(){return AM.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&Gt.Began))}emit(e){if(e.scale!==1){const t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}}class _p{constructor(e,t,r){this.element=e,this.callback=t,this.options=r}}const CM=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",IM=CM.indexOf("firefox")!==-1,gb=4.000244140625,MM=40,RM=.25;class kM extends _p{constructor(e,t,r){super(e,t,{enable:!0,...r}),this.handleEvent=o=>{if(!this.options.enable)return;let c=o.deltaY;globalThis.WheelEvent&&(IM&&o.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(c/=globalThis.devicePixelRatio),o.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(c*=MM)),c!==0&&c%gb===0&&(c=Math.floor(c/gb)),o.shiftKey&&c&&(c=c*RM),this.callback({type:"wheel",center:{x:o.clientX,y:o.clientY},delta:-c,srcEvent:o,pointerType:"mouse",target:o.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){e==="wheel"&&(this.options.enable=t)}}const mb=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class DM extends _p{constructor(e,t,r){super(e,t,{enable:!0,...r}),this.handleEvent=c=>{this.handleOverEvent(c),this.handleOutEvent(c),this.handleEnterEvent(c),this.handleLeaveEvent(c),this.handleMoveEvent(c)},this.pressed=!1;const{enable:o}=this.options;this.enableMoveEvent=o,this.enableLeaveEvent=o,this.enableEnterEvent=o,this.enableOutEvent=o,this.enableOverEvent=o,mb.forEach(c=>e.addEventListener(c,this.handleEvent))}destroy(){mb.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const _b=["keydown","keyup"];class OM extends _p{constructor(e,t,r){super(e,t,{enable:!0,tabIndex:0,...r}),this.handleEvent=o=>{const c=o.target||o.srcElement;c.tagName==="INPUT"&&c.type==="text"||c.tagName==="TEXTAREA"||(this.enableDownEvent&&o.type==="keydown"&&this.callback({type:"keydown",srcEvent:o,key:o.key,target:o.target}),this.enableUpEvent&&o.type==="keyup"&&this.callback({type:"keyup",srcEvent:o,key:o.key,target:o.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",_b.forEach(o=>e.addEventListener(o,this.handleEvent))}destroy(){_b.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e==="keydown"&&(this.enableDownEvent=t),e==="keyup"&&(this.enableUpEvent=t)}}class LM extends _p{constructor(e,t,r){super(e,t,r),this.handleEvent=o=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:o.clientX,y:o.clientY},srcEvent:o,pointerType:"mouse",target:o.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e==="contextmenu"&&(this.options.enable=t)}}const yb=1,Jm=2,xb=4,FM={pointerdown:yb,pointermove:Jm,pointerup:xb,mousedown:yb,mousemove:Jm,mouseup:xb},BM=0,NM=1,zM=2,UM=1,VM=2,jM=4;function $M(i){const e=FM[i.srcEvent.type];if(!e)return null;const{buttons:t,button:r}=i.srcEvent;let o=!1,c=!1,d=!1;return e===Jm?(o=!!(t&UM),c=!!(t&jM),d=!!(t&VM)):(o=r===BM,c=r===NM,d=r===zM),{leftButton:o,middleButton:c,rightButton:d}}function WM(i,e){const t=i.center;if(!t)return null;const r=e.getBoundingClientRect(),o=r.width/e.offsetWidth||1,c=r.height/e.offsetHeight||1,d={x:(t.x-r.left-e.clientLeft)/o,y:(t.y-r.top-e.clientTop)/c};return{center:t,offsetCenter:d}}const HM={srcElement:"root",priority:0};class ZM{constructor(e,t){this.handleEvent=r=>{if(this.isEmpty())return;const o=this._normalizeEvent(r);let c=r.srcEvent.target;for(;c&&c!==o.rootElement;){if(this._emit(o,c),o.handled)return;c=c.parentNode}this._emit(o,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,r,o=!1,c=!1){const{handlers:d,handlersByElement:a}=this,y={...HM,...r};let w=a.get(y.srcElement);w||(w=[],a.set(y.srcElement,w));const E={type:e,handler:t,srcElement:y.srcElement,priority:y.priority};o&&(E.once=!0),c&&(E.passive=!0),d.push(E),this._active=this._active||!E.passive;let I=w.length-1;for(;I>=0&&!(w[I].priority>=E.priority);)I--;w.splice(I+1,0,E)}remove(e,t){const{handlers:r,handlersByElement:o}=this;for(let c=r.length-1;c>=0;c--){const d=r[c];if(d.type===e&&d.handler===t){r.splice(c,1);const a=o.get(d.srcElement);a.splice(a.indexOf(d),1),a.length===0&&o.delete(d.srcElement)}}this._active=r.some(c=>!c.passive)}_emit(e,t){const r=this.handlersByElement.get(t);if(r){let o=!1;const c=()=>{e.handled=!0},d=()=>{e.handled=!0,o=!0},a=[];for(let y=0;y<r.length;y++){const{type:w,handler:E,once:I}=r[y];if(E({...e,type:w,stopPropagation:c,stopImmediatePropagation:d}),I&&a.push(r[y]),o)break}for(let y=0;y<a.length;y++){const{type:w,handler:E}=a[y];this.remove(w,E)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...$M(e),...WM(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function qM(i){if("recognizer"in i)return i;let e;const t=Array.isArray(i)?[...i]:[i];if(typeof t[0]=="function"){const r=t.shift(),o=t.shift()||{};e=new r(o)}else e=t.shift();return{recognizer:e,recognizeWith:typeof t[0]=="string"?[t[0]]:t[0],requireFailure:typeof t[1]=="string"?[t[1]]:t[1]}}class XM{constructor(e=null,t={}){if(this._onBasicInput=r=>{this.manager.emit(r.srcEvent.type,r)},this._onOtherEvent=r=>{this.manager.emit(r.type,r)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!!e){this.manager=new wM(e,this.options);for(const r of this.options.recognizers){const{recognizer:o,recognizeWith:c,requireFailure:d}=qM(r);this.manager.add(o),c&&o.recognizeWith(c),d&&o.requireFailure(d)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new kM(e,this._onOtherEvent,{enable:!1}),this.moveInput=new DM(e,this._onOtherEvent,{enable:!1}),this.keyInput=new OM(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new LM(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,r){this._addEventHandler(e,t,r,!1)}once(e,t,r){this._addEventHandler(e,t,r,!0)}watch(e,t,r){this._addEventHandler(e,t,r,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){const{manager:r}=this;if(!r)return;const o=r.get(e);o&&(o.set({enable:t}),r.touchAction.update()),this.wheelInput?.enableEventType(e,t),this.moveInput?.enableEventType(e,t),this.keyInput?.enableEventType(e,t),this.contextmenuInput?.enableEventType(e,t)}_addEventHandler(e,t,r,o,c){if(typeof e!="string"){r=t;for(const[w,E]of Object.entries(e))this._addEventHandler(w,E,r,o,c);return}const{manager:d,events:a}=this;if(!d)return;let y=a.get(e);if(!y){const w=this._getRecognizerName(e)||e;y=new ZM(this,w),a.set(e,y),d&&d.on(e,y.handleEvent)}y.add(e,t,r,o,c),y.isEmpty()||this._toggleRecognizer(y.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const[c,d]of Object.entries(e))this._removeEventHandler(c,d);return}const{events:r}=this,o=r.get(e);if(o&&(o.remove(e,t),o.isEmpty())){const{recognizerName:c}=o;let d=!1;for(const a of r.values())if(a.recognizerName===c&&!a.isEmpty()){d=!0;break}d||this._toggleRecognizer(c,!1)}}_getRecognizerName(e){return this.manager.recognizers.find(t=>t.getEventNames().includes(e))?.options.event}}const hi={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(hi,"IDENTITY",{get:()=>(ii.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const vn={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},ro={common:0,meters:1,pixels:2},Qm={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},vb={multipan:[pb,{threshold:10,direction:yr.Vertical,pointers:2}],pinch:[PM,{},null,["multipan"]],pan:[pb,{threshold:1},["pinch"],["multipan"]],dblclick:[fb,{event:"dblclick",taps:2}],click:[fb,{event:"click"},null,["dblclick"]]};function GM(i,e){if(i===e)return!0;if(Array.isArray(i)){const t=i.length;if(!e||e.length!==t)return!1;for(let r=0;r<t;r++)if(i[r]!==e[r])return!1;return!0}return!1}function Dh(i){let e={},t;return r=>{for(const o in r)if(!GM(r[o],e[o])){t=i(r),e=r;break}return t}}const bb=[0,0,0,0],YM=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],P1=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],KM=[0,0,0],C1=[0,0,0],JM=Dh(tR);function I1(i,e,t=C1){t.length<3&&(t=[t[0],t[1],0]);let r=t,o,c=!0;switch(e===hi.LNGLAT_OFFSETS||e===hi.METER_OFFSETS?o=t:o=i.isGeospatial?[Math.fround(i.longitude),Math.fround(i.latitude),0]:null,i.projectionMode){case vn.WEB_MERCATOR:(e===hi.LNGLAT||e===hi.CARTESIAN)&&(o=[0,0,0],c=!1);break;case vn.WEB_MERCATOR_AUTO_OFFSET:e===hi.LNGLAT?r=o:e===hi.CARTESIAN&&(r=[Math.fround(i.center[0]),Math.fround(i.center[1]),0],o=i.unprojectPosition(r),r[0]-=t[0],r[1]-=t[1],r[2]-=t[2]);break;case vn.IDENTITY:r=i.position.map(Math.fround),r[2]=r[2]||0;break;case vn.GLOBE:c=!1,o=null;break;default:c=!1}return{geospatialOrigin:o,shaderCoordinateOrigin:r,offsetMode:c}}function QM(i,e,t){const{viewMatrixUncentered:r,projectionMatrix:o}=i;let{viewMatrix:c,viewProjectionMatrix:d}=i,a=bb,y=bb,w=i.cameraPosition;const{geospatialOrigin:E,shaderCoordinateOrigin:I,offsetMode:D}=I1(i,e,t);return D&&(y=i.projectPosition(E||I),w=[w[0]-y[0],w[1]-y[1],w[2]-y[2]],y[3]=1,a=Tc([],y,d),c=r||c,d=ka([],o,c),d=ka([],d,YM)),{viewMatrix:c,viewProjectionMatrix:d,projectionCenter:a,originCommon:y,cameraPosCommon:w,shaderCoordinateOrigin:I,geospatialOrigin:E}}function eR({viewport:i,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:r=hi.DEFAULT,coordinateOrigin:o=C1,autoWrapLongitude:c=!1}){r===hi.DEFAULT&&(r=i.isGeospatial?hi.LNGLAT:hi.CARTESIAN);const d=JM({viewport:i,devicePixelRatio:e,coordinateSystem:r,coordinateOrigin:o});return d.wrapLongitude=c,d.modelMatrix=t||P1,d}function tR({viewport:i,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:r}){const{projectionCenter:o,viewProjectionMatrix:c,originCommon:d,cameraPosCommon:a,shaderCoordinateOrigin:y,geospatialOrigin:w}=QM(i,t,r),E=i.getDistanceScales(),I=[i.width*e,i.height*e],D=Tc([],[0,0,-i.focalDistance,1],i.projectionMatrix)[3]||1,F={coordinateSystem:t,projectionMode:i.projectionMode,coordinateOrigin:y,commonOrigin:d.slice(0,3),center:o,pseudoMeters:!!i._pseudoMeters,viewportSize:I,devicePixelRatio:e,focalDistance:D,commonUnitsPerMeter:E.unitsPerMeter,commonUnitsPerWorldUnit:E.unitsPerMeter,commonUnitsPerWorldUnit2:KM,scale:i.scale,wrapLongitude:!1,viewProjectionMatrix:c,modelMatrix:P1,cameraPosition:a};if(w){const X=i.getDistanceScales(w);switch(t){case hi.METER_OFFSETS:F.commonUnitsPerWorldUnit=X.unitsPerMeter,F.commonUnitsPerWorldUnit2=X.unitsPerMeter2;break;case hi.LNGLAT:case hi.LNGLAT_OFFSETS:i._pseudoMeters||(F.commonUnitsPerMeter=X.unitsPerMeter),F.commonUnitsPerWorldUnit=X.unitsPerDegree,F.commonUnitsPerWorldUnit2=X.unitsPerDegree2;break;case hi.CARTESIAN:F.commonUnitsPerWorldUnit=[1,1,X.unitsPerMeter[2]],F.commonUnitsPerWorldUnit2=[0,0,X.unitsPerMeter2[2]];break}}return F}const iR=Object.keys(hi).map(i=>`const COORDINATE_SYSTEM_${i}: i32 = ${hi[i]};`).join(""),rR=Object.keys(vn).map(i=>`const PROJECTION_MODE_${i}: i32 = ${vn[i]};`).join(""),nR=Object.keys(ro).map(i=>`const UNIT_${i.toUpperCase()}: i32 = ${ro[i]};`).join(""),sR=`${iR}
${rR}
${nR}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,oR=`${sR}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the zâaxis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,aR=Object.keys(hi).map(i=>`const int COORDINATE_SYSTEM_${i} = ${hi[i]};`).join(""),lR=Object.keys(vn).map(i=>`const int PROJECTION_MODE_${i} = ${vn[i]};`).join(""),cR=Object.keys(ro).map(i=>`const int UNIT_${i.toUpperCase()} = ${ro[i]};`).join(""),uR=`${aR}
${lR}
${cR}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,hR={};function dR(i=hR){return"viewport"in i?eR(i):{}}const Z_={name:"project",dependencies:[kI,v1],source:oR,vs:uR,getUniforms:dR,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},fR=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,pR=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,Oh={name:"project32",dependencies:[Z_],source:fR,vs:pR};function gR(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function hc(i,e){const t=Tc([],e,i);return m1(t,t,1/t[3]),t}function wb(i,e){const t=i%e;return t<0?e+t:t}function e_(i,e,t){return i<e?e:i>t?t:i}function mR(i){return Math.log(i)*Math.LOG2E}const q_=Math.log2||mR;function no(i,e){if(!i)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const Jn=Math.PI,M1=Jn/4,Ln=Jn/180,t_=180/Jn,_c=512,np=4003e4,Vo=85.051129,_R=1.5;function yR(i){return q_(i)}function bh(i){const[e,t]=i;no(Number.isFinite(e)),no(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const r=e*Ln,o=t*Ln,c=_c*(r+Jn)/(2*Jn),d=_c*(Jn+Math.log(Math.tan(M1+o*.5)))/(2*Jn);return[c,d]}function yc(i){const[e,t]=i,r=e/_c*(2*Jn)-Jn,o=2*(Math.atan(Math.exp(t/_c*(2*Jn)-Jn))-M1);return[r*t_,o*t_]}function xR(i){const{latitude:e}=i;no(Number.isFinite(e));const t=Math.cos(e*Ln);return yR(np*t)-9}function If(i){const e=Math.cos(i*Ln);return _c/np/e}function i_(i){const{latitude:e,longitude:t,highPrecision:r=!1}=i;no(Number.isFinite(e)&&Number.isFinite(t));const o=_c,c=Math.cos(e*Ln),d=o/360,a=d/c,y=o/np/c,w={unitsPerMeter:[y,y,y],metersPerUnit:[1/y,1/y,1/y],unitsPerDegree:[d,a,y],degreesPerUnit:[1/d,1/a,1/y]};if(r){const E=Ln*Math.tan(e*Ln)/c,I=d*E/2,D=o/np*E,F=D/a*y;w.unitsPerDegree2=[0,I,D],w.unitsPerMeter2=[F,0,F]}return w}function R1(i,e){const[t,r,o]=i,[c,d,a]=e,{unitsPerMeter:y,unitsPerMeter2:w}=i_({longitude:t,latitude:r,highPrecision:!0}),E=bh(i);E[0]+=c*(y[0]+w[0]*d),E[1]+=d*(y[1]+w[1]*d);const I=yc(E),D=(o||0)+(a||0);return Number.isFinite(o)||Number.isFinite(a)?[I[0],I[1],D]:I}function vR(i){const{height:e,pitch:t,bearing:r,altitude:o,scale:c,center:d}=i,a=gR();ip(a,a,[0,0,-o]),p1(a,a,-t*Ln),g1(a,a,r*Ln);const y=c/e;return H_(a,a,[y,y,y]),d&&ip(a,a,JC([],d)),a}function bR(i){const{width:e,height:t,altitude:r,pitch:o=0,offset:c,center:d,scale:a,nearZMultiplier:y=1,farZMultiplier:w=1}=i;let{fovy:E=wh(_R)}=i;r!==void 0&&(E=wh(r));const I=E*Ln,D=o*Ln,F=X_(E);let X=F;d&&(X+=d[2]*a/Math.cos(D)/t);const oe=I*(.5+(c?c[1]:0)/t),_e=Math.sin(oe)*X/Math.sin(e_(Math.PI/2-D-oe,.01,Math.PI-.01)),ge=Math.sin(D)*_e+X,fe=X*10,Te=Math.min(ge*w,fe);return{fov:I,aspect:e/t,focalDistance:F,near:y,far:Te}}function wh(i){return 2*Math.atan(.5/i)*t_}function X_(i){return .5/Math.tan(.5*i*Ln)}function k1(i,e){const[t,r,o=0]=i;return no(Number.isFinite(t)&&Number.isFinite(r)&&Number.isFinite(o)),hc(e,[t,r,o,1])}function G_(i,e,t=0){const[r,o,c]=i;if(no(Number.isFinite(r)&&Number.isFinite(o),"invalid pixel coordinate"),Number.isFinite(c))return hc(e,[r,o,c,1]);const d=hc(e,[r,o,0,1]),a=hc(e,[r,o,1,1]),y=d[2],w=a[2],E=y===w?0:((t||0)-y)/(w-y);return u1([],d,a,E)}function wR(i){const{width:e,height:t,bounds:r,minExtent:o=0,maxZoom:c=24,offset:d=[0,0]}=i,[[a,y],[w,E]]=r,I=TR(i.padding),D=bh([a,e_(E,-Vo,Vo)]),F=bh([w,e_(y,-Vo,Vo)]),X=[Math.max(Math.abs(F[0]-D[0]),o),Math.max(Math.abs(F[1]-D[1]),o)],oe=[e-I.left-I.right-Math.abs(d[0])*2,t-I.top-I.bottom-Math.abs(d[1])*2];no(oe[0]>0&&oe[1]>0);const _e=oe[0]/X[0],ge=oe[1]/X[1],fe=(I.right-I.left)/2/_e,Te=(I.top-I.bottom)/2/ge,ke=[(F[0]+D[0])/2+fe,(F[1]+D[1])/2+Te],Je=yc(ke),Xe=Math.min(c,q_(Math.abs(Math.min(_e,ge))));return no(Number.isFinite(Xe)),{longitude:Je[0],latitude:Je[1],zoom:Xe}}function TR(i=0){return typeof i=="number"?{top:i,bottom:i,left:i,right:i}:(no(Number.isFinite(i.top)&&Number.isFinite(i.bottom)&&Number.isFinite(i.left)&&Number.isFinite(i.right)),i)}const Tb=Math.PI/180;function SR(i,e=0){const{width:t,height:r,unproject:o}=i,c={targetZ:e},d=o([0,r],c),a=o([t,r],c);let y,w;const E=i.fovy?.5*i.fovy*Tb:Math.atan(.5/i.altitude),I=(90-i.pitch)*Tb;return E>I-.01?(y=Sb(i,0,e),w=Sb(i,t,e)):(y=o([0,0],c),w=o([t,0],c)),[d,a,w,y]}function Sb(i,e,t){const{pixelUnprojectionMatrix:r}=i,o=hc(r,[e,0,1,1]),c=hc(r,[e,i.height,1,1]),a=(t*i.distanceScales.unitsPerMeter[2]-o[2])/(c[2]-o[2]),y=u1([],o,c,a),w=yc(y);return w.push(t),w}const Eb=512;function ER(i){const{width:e,height:t,pitch:r=0}=i;let{longitude:o,latitude:c,zoom:d,bearing:a=0}=i;(o<-180||o>180)&&(o=wb(o+180,360)-180),(a<-180||a>180)&&(a=wb(a+180,360)-180);const y=q_(t/Eb);if(d<=y)d=y,c=0;else{const w=t/2/Math.pow(2,d),E=yc([0,w])[1];if(c<E)c=E;else{const I=yc([0,Eb-w])[1];c>I&&(c=I)}}return{width:e,height:t,longitude:o,latitude:c,zoom:d,pitch:r,bearing:a}}const D1=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,AR=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,PR=`
${D1}
${AR}
`,CR=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,IR=`
${D1}
${CR}
`,MR=Dh(LR),RR=Dh(FR),kR=[0,0,0,1],DR=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function OR(i,e){const[t,r,o]=i,c=G_([t,r,o],e);return Number.isFinite(o)?c:[c[0],c[1],0]}function LR({viewport:i,center:e}){return new ts(i.viewProjectionMatrix).invert().transform(e)}function FR({viewport:i,shadowMatrices:e}){const t=[],r=i.pixelUnprojectionMatrix,o=i.isGeospatial?void 0:1,c=[[0,0,o],[i.width,0,o],[0,i.height,o],[i.width,i.height,o],[0,0,-1],[i.width,0,-1],[0,i.height,-1],[i.width,i.height,-1]].map(d=>OR(d,r));for(const d of e){const a=d.clone().translate(new As(i.center).negate()),y=c.map(E=>a.transform(E)),w=new ts().ortho({left:Math.min(...y.map(E=>E[0])),right:Math.max(...y.map(E=>E[0])),bottom:Math.min(...y.map(E=>E[1])),top:Math.max(...y.map(E=>E[1])),near:Math.min(...y.map(E=>-E[2])),far:Math.max(...y.map(E=>-E[2]))});t.push(w.multiplyRight(d))}return t}function BR(i){const{shadowEnabled:e=!0,project:t}=i;if(!e||!t||!i.shadowMatrices||!i.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:i.dummyShadowMap,shadow_uShadowMap1:i.dummyShadowMap};const r=Z_.getUniforms(t),o=MR({viewport:t.viewport,center:r.center}),c=[],d=RR({shadowMatrices:i.shadowMatrices,viewport:t.viewport}).slice();for(let y=0;y<i.shadowMatrices.length;y++){const w=d[y],E=w.clone().translate(new As(t.viewport.center).negate());r.coordinateSystem===hi.LNGLAT&&r.projectionMode===vn.WEB_MERCATOR?(d[y]=E,c[y]=o):(d[y]=w.clone().multiplyRight(DR),c[y]=E.transform(o))}const a={drawShadowMap:!!i.drawToShadowMap,useShadowMap:i.shadowMaps?i.shadowMaps.length>0:!1,color:i.shadowColor||kR,lightId:i.shadowLightId||0,lightCount:i.shadowMatrices.length,shadow_uShadowMap0:i.dummyShadowMap,shadow_uShadowMap1:i.dummyShadowMap};for(let y=0;y<d.length;y++)a[`viewProjectionMatrix${y}`]=d[y],a[`projectCenter${y}`]=c[y];for(let y=0;y<2;y++)a[`shadow_uShadowMap${y}`]=i.shadowMaps&&i.shadowMaps[y]||i.dummyShadowMap;return a}const Ab={name:"shadow",dependencies:[Z_],vs:PR,fs:IR,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:BR,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},Lh={...rb,defaultUniforms:{...rb.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},NR=[v1],zR=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],UR=[];function VR(i){const e=Pa.getDefaultShaderAssembler();for(const r of NR)e.addDefaultModule(r);e._hookFunctions.length=0;const t=i==="glsl"?zR:UR;for(const r of t)e.addShaderHook(r);return e}const jR=[255,255,255],$R=1;let WR=0;class HR{constructor(e={}){this.type="ambient";const{color:t=jR}=e,{intensity:r=$R}=e;this.id=e.id||`ambient-${WR++}`,this.color=t,this.intensity=r}}const ZR=[255,255,255],qR=1,XR=[0,0,-1];let GR=0;class Pb{constructor(e={}){this.type="directional";const{color:t=ZR}=e,{intensity:r=qR}=e,{direction:o=XR}=e,{_shadow:c=!1}=e;this.id=e.id||`directional-${GR++}`,this.color=t,this.intensity=r,this.type="directional",this.direction=new As(o).normalize().toArray(),this.shadow=c}getProjectedLight(e){return this}}class YR{constructor(e,t={id:"pass"}){const{id:r}=t;this.id=r,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class Y_ extends YR{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,r]=this.device.canvasContext.getDrawingBufferSize(),o=e.clearCanvas??!0,c=e.clearColor??(o?[0,0,0,0]:!1),d=o?1:!1,a=o?0:!1,y=e.colorMask??15,w={viewport:[0,0,t,r]};e.colorMask&&(w.colorMask=y),e.scissorRect&&(w.scissorRect=e.scissorRect);const E=this.device.beginRenderPass({framebuffer:e.target,parameters:w,clearColor:c,clearDepth:d,clearStencil:a});try{return this._drawLayers(E,e)}finally{E.end(),this.device.submit()}}_drawLayers(e,t){const{target:r,shaderModuleProps:o,viewports:c,views:d,onViewportActive:a,clearStack:y=!0}=t;t.pass=t.pass||"unknown",y&&(this._lastRenderIndex=-1);const w=[];for(const E of c){const I=d&&d[E.id];a?.(E);const D=this._getDrawLayerParams(E,t),F=E.subViewports||[E];for(const X of F){const oe=this._drawLayersInViewport(e,{target:r,shaderModuleProps:o,viewport:X,view:I,pass:t.pass,layers:t.layers},D);w.push(oe)}}return w}_getDrawLayerParams(e,{layers:t,pass:r,isPicking:o=!1,layerFilter:c,cullRect:d,effects:a,shaderModuleProps:y},w=!1){const E=[],I=O1(this._lastRenderIndex+1),D={layer:t[0],viewport:e,isPicking:o,renderPass:r,cullRect:d},F={};for(let X=0;X<t.length;X++){const oe=t[X],_e=this._shouldDrawLayer(oe,D,c,F),ge={shouldDrawLayer:_e};_e&&!w&&(ge.shouldDrawLayer=!0,ge.layerRenderIndex=I(oe,_e),ge.shaderModuleProps=this._getShaderModuleProps(oe,a,r,y),ge.layerParameters={...oe.context.deck?.props.parameters,...this.getLayerParameters(oe,X,e)}),E[X]=ge}return E}_drawLayersInViewport(e,{layers:t,shaderModuleProps:r,pass:o,target:c,viewport:d,view:a},y){const w=KR(this.device,{shaderModuleProps:r,target:c,viewport:d});if(a){const{clear:I,clearColor:D,clearDepth:F,clearStencil:X}=a.props;if(I){let oe=[0,0,0,0],_e=1,ge=0;Array.isArray(D)?oe=[...D.slice(0,3),D[3]||255].map(Te=>Te/255):D===!1&&(oe=!1),F!==void 0&&(_e=F),X!==void 0&&(ge=X),this.device.beginRenderPass({framebuffer:c,parameters:{viewport:w,scissorRect:w},clearColor:oe,clearDepth:_e,clearStencil:ge}).end()}}const E={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:w});for(let I=0;I<t.length;I++){const D=t[I],F=y[I],{shouldDrawLayer:X}=F;if(X&&D.props.pickable&&E.pickableCount++,D.isComposite&&E.compositeCount++,D.isDrawable&&F.shouldDrawLayer){const{layerRenderIndex:oe,shaderModuleProps:_e,layerParameters:ge}=F;E.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,oe),_e.project&&(_e.project.viewport=d),D.context.renderPass=e;try{D._drawLayer({renderPass:e,shaderModuleProps:_e,uniforms:{layerIndex:oe},parameters:ge})}catch(fe){D.raiseError(fe,`drawing ${D} to ${o}`)}}}return E}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,r){return null}getLayerParameters(e,t,r){return e.props.parameters}_shouldDrawLayer(e,t,r,o){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let d=e.parent;for(;d;){if(!d.props.visible||!d.filterSubLayer(t))return!1;t.layer=d,d=d.parent}if(r){const a=t.layer.id;if(a in o||(o[a]=r(t)),!o[a])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,r,o){const c=this.device.canvasContext.cssToDeviceRatio(),d=e.internalState?.propsInTransition||e.props,a={layer:d,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:c,modelMatrix:d.modelMatrix,coordinateSystem:d.coordinateSystem,coordinateOrigin:d.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const y of t)Cb(a,y.getShaderModuleProps?.(e,a));return Cb(a,this.getShaderModuleProps(e,t,a),o)}}function O1(i=0,e={}){const t={},r=(o,c)=>{const d=o.props._offset,a=o.id,y=o.parent&&o.parent.id;let w;if(y&&!(y in e)&&r(o.parent,!1),y in t){const E=t[y]=t[y]||O1(e[y],e);w=E(o,c),t[a]=E}else Number.isFinite(d)?(w=d+(e[y]||0),t[a]=null):w=i;return c&&w>=i&&(i=w+1),e[a]=w,w};return r}function KR(i,{shaderModuleProps:e,target:t,viewport:r}){const o=e?.project?.devicePixelRatio??i.canvasContext.cssToDeviceRatio(),[,c]=i.canvasContext.getDrawingBufferSize(),d=t?t.height:c,a=r;return[a.x*o,d-(a.y+a.height)*o,a.width*o,a.height*o]}function Cb(i,...e){for(const t of e)if(t)for(const r in t)i[r]?Object.assign(i[r],t[r]):i[r]=t[r];return i}class JR extends Y_{constructor(e,t){super(e,t);const r=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}}),o=e.createTexture({format:"depth16unorm",width:1,height:1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[r],depthStencilAttachment:o})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,r=this.device.canvasContext.cssToDeviceRatio(),o=e.viewports[0],c=o.width*r,d=o.height*r,a=[1,1,1,1];(c!==t.width||d!==t.height)&&t.resize({width:c,height:d}),super.render({...e,clearColor:a,target:t,pass:"shadow"})}getLayerParameters(e,t,r){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getShaderModuleProps(e,t,r){return{shadow:{project:r.project,drawToShadowMap:!0}}}}const QR={color:[255,255,255],intensity:1},Ib=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],ek=[0,0,0,200/255];class L1{constructor(e={}){this.id="lighting-effect",this.shadowColor=ek,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:r}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),r._addDefaultShaderModule(Ab),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const r=e[t];switch(r.type){case"ambient":this.ambientLight=r;break;case"directional":this.directionalLights.push(r);break;case"point":this.pointLights.push(r);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:r,onViewportActive:o,views:c}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let d=0;d<this.shadowPasses.length;d++)this.shadowPasses[d].render({layers:e,layerFilter:t,viewports:r,onViewportActive:o,views:c,shaderModuleProps:{shadow:{shadowLightId:d,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){const r=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(d=>d.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},o={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(d=>d.getProjectedLight({layer:e})),pointLights:this.pointLights.map(d=>d.getProjectedLight({layer:e}))},c=e.props.material;return{shadow:r,lighting:o,phongMaterial:c,gouraudMaterial:c}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(Ab))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const r=new ts().lookAt({eye:new As(t.direction).negate()});e.push(r)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const r=new JR(e);this.shadowPasses[t]=r}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:r}=this;!e&&t.length===0&&r.length===0&&(this.ambientLight=new HR(QR),this.directionalLights.push(new Pb(Ib[0]),new Pb(Ib[1])))}}class tk{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:r=1,type:o,padding:c=0,copy:d=!1,initialize:a=!1,maxCount:y}){const w=o||e&&e.constructor||Float32Array,E=t*r+c;if(ArrayBuffer.isView(e)){if(E<=e.length)return e;if(E*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new w(e.buffer,0,E)}let I=1/0;y&&(I=y*r+c);const D=this._allocate(w,E,a,I);return e&&d?D.set(e):a||D.fill(0,0,4),this._release(e),D}release(e){this._release(e)}_allocate(e,t,r,o){let c=Math.max(Math.ceil(t*this.opts.overAlloc),1);c>o&&(c=o);const d=this._pool,a=e.BYTES_PER_ELEMENT*c,y=d.findIndex(w=>w.byteLength>=a);if(y>=0){const w=new e(d.splice(y,1)[0],0,c);return r&&w.fill(0),w}return new e(c)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:r}=e,{byteLength:o}=r,c=t.findIndex(d=>d.byteLength>=o);c<0?t.push(r):(c>0||t.length<this.opts.poolSize)&&t.splice(c,0,r),t.length>this.opts.poolSize&&t.shift()}}const xc=new tk;function nh(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function ik(i,e){const t=i%e;return t<0?e+t:t}function rk(i){return[i[12],i[13],i[14]]}function nk(i){return{left:tc(i[3]+i[0],i[7]+i[4],i[11]+i[8],i[15]+i[12]),right:tc(i[3]-i[0],i[7]-i[4],i[11]-i[8],i[15]-i[12]),bottom:tc(i[3]+i[1],i[7]+i[5],i[11]+i[9],i[15]+i[13]),top:tc(i[3]-i[1],i[7]-i[5],i[11]-i[9],i[15]-i[13]),near:tc(i[3]+i[2],i[7]+i[6],i[11]+i[10],i[15]+i[14]),far:tc(i[3]-i[2],i[7]-i[6],i[11]-i[10],i[15]-i[14])}}const Mb=new As;function tc(i,e,t,r){Mb.set(i,e,t);const o=Mb.len();return{distance:r/o,normal:new As(-i/o,-e/o,-t/o)}}function sk(i){return i-Math.fround(i)}let Yu;function lm(i,e){const{size:t=1,startIndex:r=0}=e,o=e.endIndex!==void 0?e.endIndex:i.length,c=(o-r)/t;Yu=xc.allocate(Yu,c,{type:Float32Array,size:t*2});let d=r,a=0;for(;d<o;){for(let y=0;y<t;y++){const w=i[d++];Yu[a+y]=w,Yu[a+y+t]=sk(w)}a+=t*2}return Yu.subarray(0,c*t*2)}function ok(i){let e=null,t=!1;for(const r of i)r&&(e?(t||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],t=!0),e[0][0]=Math.min(e[0][0],r[0][0]),e[0][1]=Math.min(e[0][1],r[0][1]),e[1][0]=Math.max(e[1][0],r[1][0]),e[1][1]=Math.max(e[1][1],r[1][1])):e=r);return e}const ak=Math.PI/180,lk=nh(),Rb=[0,0,0],ck={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function uk({width:i,height:e,orthographic:t,fovyRadians:r,focalDistance:o,padding:c,near:d,far:a}){const y=i/e,w=t?new ts().orthographic({fovy:r,aspect:y,focalDistance:o,near:d,far:a}):new ts().perspective({fovy:r,aspect:y,near:d,far:a});if(c){const{left:E=0,right:I=0,top:D=0,bottom:F=0}=c,X=Es((E+i-I)/2,0,i)-i/2,oe=Es((D+e-F)/2,0,e)-e/2;w[8]-=X*2/i,w[9]+=oe*2/e}return w}class Sc{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||ck,this.focalDistance=e.focalDistance||1,this.position=e.position||Rb,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:r}=e;this.isGeospatial=Number.isFinite(r)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?vn.WEB_MERCATOR:vn.WEB_MERCATOR_AUTO_OFFSET:vn.IDENTITY}equals(e){return e instanceof Sc?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&xh(e.projectionMatrix,this.projectionMatrix)&&xh(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){const r=this.projectPosition(e),o=k1(r,this.pixelProjectionMatrix),[c,d]=o,a=t?d:this.height-d;return e.length===2?[c,a]:[c,a,o[2]]}unproject(e,{topLeft:t=!0,targetZ:r}={}){const[o,c,d]=e,a=t?c:this.height-c,y=r&&r*this.distanceScales.unitsPerMeter[2],w=G_([o,a,d],this.pixelUnprojectionMatrix,y),[E,I,D]=this.unprojectPosition(w);return Number.isFinite(d)?[E,I,D]:Number.isFinite(r)?[E,I,r]:[E,I]}projectPosition(e){const[t,r]=this.projectFlat(e),o=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,r,o]}unprojectPosition(e){const[t,r]=this.unprojectFlat(e),o=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,r,o]}projectFlat(e){if(this.isGeospatial){const t=bh(e);return t[1]=Es(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?yc(e):e}getBounds(e={}){const t={targetZ:e.z||0},r=this.unproject([0,0],t),o=this.unproject([this.width,0],t),c=this.unproject([0,this.height],t),d=this.unproject([this.width,this.height],t);return[Math.min(r[0],o[0],c[0],d[0]),Math.min(r[1],o[1],c[1],d[1]),Math.max(r[0],o[0],c[0],d[0]),Math.max(r[1],o[1],c[1],d[1])]}getDistanceScales(e){return e&&this.isGeospatial?i_({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:r=1,height:o=1}){return e<this.x+this.width&&this.x<e+r&&t<this.y+this.height&&this.y<t+o}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,nk(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,r=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=xR({latitude:r})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||i_({latitude:r,longitude:t}));const o=Math.pow(2,this.zoom);this.scale=o;const{position:c,modelMatrix:d}=e;let a=Rb;if(c&&(a=d?new ts(d).transformAsVector(c,[]):c),this.isGeospatial){const y=this.projectPosition([t,r,0]);this.center=new As(a).scale(this.distanceScales.unitsPerMeter).add(y)}else this.center=this.projectPosition(a)}_initMatrices(e){const{viewMatrix:t=lk,projectionMatrix:r=null,orthographic:o=!1,fovyRadians:c,fovy:d=75,near:a=.1,far:y=1e3,padding:w=null,focalDistance:E=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new ts().multiplyRight(t).translate(new As(this.center).negate()),this.projectionMatrix=r||uk({width:this.width,height:this.height,orthographic:o,fovyRadians:c||d*ak,focalDistance:E,padding:w,near:a,far:y});const I=nh();ka(I,I,this.projectionMatrix),ka(I,I,this.viewMatrix),this.viewProjectionMatrix=I,this.viewMatrixInverse=qm([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=rk(this.viewMatrixInverse);const D=nh(),F=nh();H_(D,D,[this.width/2,-this.height/2,1]),ip(D,D,[1,-1,0]),ka(F,D,this.viewProjectionMatrix),this.pixelProjectionMatrix=F,this.pixelUnprojectionMatrix=qm(nh(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||ii.warn("Pixel project matrix not invertible")()}}Sc.displayName="Viewport";class za extends Sc{constructor(e={}){const{latitude:t=0,longitude:r=0,zoom:o=0,pitch:c=0,bearing:d=0,nearZMultiplier:a=.1,farZMultiplier:y=1.01,nearZ:w,farZ:E,orthographic:I=!1,projectionMatrix:D,repeat:F=!1,worldOffset:X=0,position:oe,padding:_e,legacyMeterSizes:ge=!1}=e;let{width:fe,height:Te,altitude:ke=1.5}=e;const Je=Math.pow(2,o);fe=fe||1,Te=Te||1;let Xe,mt=null;if(D)ke=D[5]/2,Xe=wh(ke);else{e.fovy?(Xe=e.fovy,ke=X_(Xe)):Xe=wh(ke);let J;if(_e){const{top:ae=0,bottom:be=0}=_e;J=[0,Es((ae+Te-be)/2,0,Te)-Te/2]}mt=bR({width:fe,height:Te,scale:Je,center:oe&&[0,0,oe[2]*If(t)],offset:J,pitch:c,fovy:Xe,nearZMultiplier:a,farZMultiplier:y}),Number.isFinite(w)&&(mt.near=w),Number.isFinite(E)&&(mt.far=E)}let G=vR({height:Te,pitch:c,bearing:d,scale:Je,altitude:ke});X&&(G=new ts().translate([512*X,0,0]).multiplyLeft(G)),super({...e,width:fe,height:Te,viewMatrix:G,longitude:r,latitude:t,zoom:o,...mt,fovy:Xe,focalDistance:ke}),this.latitude=t,this.longitude=r,this.zoom=o,this.pitch=c,this.bearing=d,this.altitude=ke,this.fovy=Xe,this.orthographic=I,this._subViewports=F?[]:null,this._pseudoMeters=ge,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),r=Math.ceil((e[2]-180)/360);for(let o=t;o<=r;o++){const c=o?new za({...this,worldOffset:o}):this;this._subViewports.push(c)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,r]=this.projectFlat(e),o=(e[2]||0)*If(e[1]);return[t,r,o]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,r]=this.unprojectFlat(e),o=(e[2]||0)/If(r);return[t,r,o]}addMetersToLngLat(e,t){return R1(e,t)}panByPosition(e,t){const r=G_(t,this.pixelUnprojectionMatrix),o=this.projectFlat(e),c=tb([],o,WC([],r)),d=tb([],this.center,c),[a,y]=this.unprojectFlat(d);return{longitude:a,latitude:y}}getBounds(e={}){const t=SR(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:r,height:o}=this,{longitude:c,latitude:d,zoom:a}=wR({width:r,height:o,bounds:e,...t});return new za({width:r,height:o,longitude:c,latitude:d,zoom:a})}}za.displayName="WebMercatorViewport";const kb=[0,0,0];function cm(i,e,t=!1){const r=e.projectPosition(i);if(t&&e instanceof za){const[o,c,d=0]=i,a=e.getDistanceScales([o,c]);r[2]=d*a.unitsPerMeter[2]}return r}function hk(i){const{viewport:e,modelMatrix:t,coordinateOrigin:r}=i;let{coordinateSystem:o,fromCoordinateSystem:c,fromCoordinateOrigin:d}=i;return o===hi.DEFAULT&&(o=e.isGeospatial?hi.LNGLAT:hi.CARTESIAN),c===void 0&&(c=o),d===void 0&&(d=r),{viewport:e,coordinateSystem:o,coordinateOrigin:r,modelMatrix:t,fromCoordinateSystem:c,fromCoordinateOrigin:d}}function F1(i,{viewport:e,modelMatrix:t,coordinateSystem:r,coordinateOrigin:o,offsetMode:c}){let[d,a,y=0]=i;switch(t&&([d,a,y]=Tc([],[d,a,y,1],t)),r){case hi.LNGLAT:return cm([d,a,y],e,c);case hi.LNGLAT_OFFSETS:return cm([d+o[0],a+o[1],y+(o[2]||0)],e,c);case hi.METER_OFFSETS:return cm(R1(o,[d,a,y]),e,c);case hi.CARTESIAN:default:return e.isGeospatial?[d+o[0],a+o[1],y+o[2]]:e.projectPosition([d,a,y])}}function dk(i,e){const{viewport:t,coordinateSystem:r,coordinateOrigin:o,modelMatrix:c,fromCoordinateSystem:d,fromCoordinateOrigin:a}=hk(e),{autoOffset:y=!0}=e,{geospatialOrigin:w=kb,shaderCoordinateOrigin:E=kb,offsetMode:I=!1}=y?I1(t,r,o):{},D=F1(i,{viewport:t,modelMatrix:c,coordinateSystem:d,coordinateOrigin:a,offsetMode:I});if(I){const F=t.projectPosition(w||E);f1(D,D,F)}return D}let fk=1,pk=1;class B1{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;constructor(){}addChannel(e){const{delay:t=0,duration:r=Number.POSITIVE_INFINITY,rate:o=1,repeat:c=1}=e,d=fk++,a={time:0,delay:t,duration:r,rate:o,repeat:c};return this._setChannelTime(a,this.time),this.channels.set(d,a),d}removeChannel(e){this.channels.delete(e);for(const[t,r]of this.animations)r.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const o of t)this._setChannelTime(o,this.time);const r=this.animations.values();for(const o of r){const{animation:c,channel:d}=o;c.setTime(this.getTime(d))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const r=pk++;return this.animations.set(r,{animation:e,channel:t}),e.setTime(this.getTime(t)),r}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const r=t-e.delay,o=e.duration*e.repeat;r>=o?e.time=e.duration*e.rate:(e.time=Math.max(0,r)%e.duration,e.time*=e.rate)}}function gk(i){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(i):setTimeout(i,1e3/60)}function mk(i){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(i):clearTimeout(i)}let _k=0;class K_{static defaultAnimationLoopProps={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:e=>console.error(e),stats:$m.stats.get(`animation-loop-${_k++}`),autoResizeViewport:!1};device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(e){if(this.props={...K_.defaultAnimationLoopProps,...e},e=this.props,!e.device)throw new Error("No device provided");this.stats=e.stats||new hp({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}reportError(e){this.props.onError(e),this._error=e}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=gk(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(mk(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),this.device?.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeViewport()}_initializeAnimationProps(){const e=this.device?.getDefaultCanvasContext();if(!this.device||!e)throw new Error("loop");const t=e?.canvas,r=e.props.useDevicePixels;this.animationProps={animationLoop:this,device:this.device,canvasContext:e,canvas:t,useDevicePixels:r,timeline:this.timeline,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:r}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),r!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=r,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=this.device.getDefaultCanvasContext().canvas||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const r=this.props.onAddHTML(t);r&&(t.innerHTML=r)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=this.device?.getDefaultCanvasContext().getDevicePixelSize()||[1,1];let r=1;const o=this.device?.getDefaultCanvasContext().canvas;return o&&o.clientHeight?r=o.clientWidth/o.clientHeight:e>0&&t>0&&(r=e/t),{width:e,height:t,aspect:r}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const um={};function Fh(i="id"){um[i]=um[i]||1;const e=um[i]++;return`${i}-${e}`}class Db{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(e){if(this.id=e.id||Fh("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&Mi.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){this.indices?.destroy();for(const e of Object.values(this.attributes))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function yk(i,e){if(e instanceof Db)return e;const t=xk(i,e),{attributes:r,bufferLayout:o}=vk(i,e);return new Db({topology:e.topology||"triangle-list",bufferLayout:o,vertexCount:e.vertexCount,indices:t,attributes:r})}function xk(i,e){if(!e.indices)return;const t=e.indices.value;return i.createBuffer({usage:Mi.INDEX,data:t})}function vk(i,e){const t=[],r={};for(const[c,d]of Object.entries(e.attributes)){let a=c;switch(c){case"POSITION":a="positions";break;case"NORMAL":a="normals";break;case"TEXCOORD_0":a="texCoords";break;case"COLOR_0":a="colors";break}if(d){r[a]=i.createBuffer({data:d.value,id:`${c}-buffer`});const{value:y,size:w,normalized:E}=d;t.push({name:a,format:a3(y,w,E)})}}const o=e._calculateVertexCount(e.attributes,e.indices);return{attributes:r,bufferLayout:t,vertexCount:o}}class J_{static defaultProps={...Ra.defaultProps};static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new J_(e),e._lumaData.defaultPipelineFactory}device;cachingEnabled;destroyPolicy;debug;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};get[Symbol.toStringTag](){return"PipelineFactory"}toString(){return`PipelineFactory(${this.device.id})`}constructor(e){this.device=e,this.cachingEnabled=e.props._cachePipelines,this.destroyPolicy=e.props._cacheDestroyPolicy,this.debug=e.props.debugFactories}createRenderPipeline(e){if(!this.cachingEnabled)return this.device.createRenderPipeline(e);const t={...Ra.defaultProps,...e},r=this._renderPipelineCache,o=this._hashRenderPipeline(t);let c=r[o]?.pipeline;return c?(r[o].useCount++,this.debug&&dt.warn(`${this}: ${r[o].pipeline} reused, count=${r[o].useCount}, (id=${e.id})`)()):(c=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:Fh("unnamed-cached")}),c.hash=o,r[o]={pipeline:c,useCount:1},this.debug&&dt.warn(`${this}: ${c} created, count=${r[o].useCount}`)()),c}createComputePipeline(e){if(!this.cachingEnabled)return this.device.createComputePipeline(e);const t={...Xf.defaultProps,...e},r=this._computePipelineCache,o=this._hashComputePipeline(t);let c=r[o]?.pipeline;return c?(r[o].useCount++,this.debug&&dt.warn(`${this}: ${r[o].pipeline} reused, count=${r[o].useCount}, (id=${e.id})`)()):(c=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0}),c.hash=o,r[o]={pipeline:c,useCount:1},this.debug&&dt.warn(`${this}: ${c} created, count=${r[o].useCount}`)()),c}release(e){if(!this.cachingEnabled){e.destroy();return}const t=this._getCache(e),r=e.hash;t[r].useCount--,t[r].useCount===0?(this._destroyPipeline(e),this.debug&&dt.warn(`${this}: ${e} released and destroyed`)()):t[r].useCount<0?(dt.error(`${this}: ${e} released, useCount < 0, resetting`)(),t[r].useCount=0):this.debug&&dt.warn(`${this}: ${e} released, count=${t[r].useCount}`)()}_destroyPipeline(e){const t=this._getCache(e);switch(this.destroyPolicy){case"never":return!1;case"unused":return delete t[e.hash],e.destroy(),!0}}_getCache(e){let t;if(e instanceof Xf&&(t=this._computePipelineCache),e instanceof Ra&&(t=this._renderPipelineCache),!t)throw new Error(`${this}`);if(!t[e.hash])throw new Error(`${this}: ${e} matched incorrect entry`);return t}_hashComputePipeline(e){const{type:t}=this.device,r=this._getHash(e.shader.source);return`${t}/C/${r}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,r=e.fs?this._getHash(e.fs.source):0,o="-",c=this._getHash(JSON.stringify(e.bufferLayout)),{type:d}=this.device;switch(d){case"webgl":return`${d}/R/${t}/${r}V${o}BL${c}`;case"webgpu":default:const a=this._getHash(JSON.stringify(e.parameters));return`${d}/R/${t}/${r}V${o}T${e.topology}P${a}BL${c}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}}class Q_{static defaultProps={...gp.defaultProps};static getDefaultShaderFactory(e){return e._lumaData.defaultShaderFactory||=new Q_(e),e._lumaData.defaultShaderFactory}device;cachingEnabled;destroyPolicy;debug;_cache={};get[Symbol.toStringTag](){return"ShaderFactory"}toString(){return`${this[Symbol.toStringTag]}(${this.device.id})`}constructor(e){this.device=e,this.cachingEnabled=e.props._cacheShaders,this.destroyPolicy=e.props._cacheDestroyPolicy,this.debug=!0}createShader(e){if(!this.cachingEnabled)return this.device.createShader(e);const t=this._hashShader(e);let r=this._cache[t];if(r)r.useCount++,this.debug&&dt.warn(`${this}: Reusing shader ${r.shader.id} count=${r.useCount}`)();else{const o=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=r={shader:o,useCount:1},this.debug&&dt.warn(`${this}: Created new shader ${o.id}`)()}return r.shader}release(e){if(!this.cachingEnabled){e.destroy();return}const t=this._hashShader(e),r=this._cache[t];if(r)if(r.useCount--,r.useCount===0)this.destroyPolicy==="unused"&&(delete this._cache[t],r.shader.destroy(),this.debug&&dt.warn(`${this}: Releasing shader ${e.id}, destroyed`)());else{if(r.useCount<0)throw new Error(`ShaderFactory: Shader ${e.id} released too many times`);this.debug&&dt.warn(`${this}: Releasing shader ${e.id} count=${r.useCount}`)()}}_hashShader(e){return`${e.stage}:${e.source}`}}function bk(i,e){const t={},r="Values";if(i.attributes.length===0&&!i.varyings?.length)return{"No attributes or varyings":{[r]:"N/A"}};for(const o of i.attributes)if(o){const c=`${o.location} ${o.name}: ${o.type}`;t[`in ${c}`]={[r]:o.stepMode||"vertex"}}for(const o of i.varyings||[]){const c=`${o.location} ${o.name}`;t[`out ${c}`]={[r]:JSON.stringify(o)}}return t}let Er=null,hm=null;function wk(i,{id:e,minimap:t,opaque:r,top:o="0",left:c="0",rgbaScale:d=1}){Er||(Er=document.createElement("canvas"),Er.id=e,Er.title=e,Er.style.zIndex="100",Er.style.position="absolute",Er.style.top=o,Er.style.left=c,Er.style.border="blue 5px solid",Er.style.transform="scaleY(-1)",document.body.appendChild(Er),hm=Er.getContext("2d")),(Er.width!==i.width||Er.height!==i.height)&&(Er.width=i.width/2,Er.height=i.height/2,Er.style.width="400px",Er.style.height="400px");const a=i.device.readPixelsToArrayWebGL(i),y=hm?.createImageData(i.width,i.height);if(y){for(let E=0;E<a.length;E+=4)y.data[0+E+0]=a[E+0]*d,y.data[0+E+1]=a[E+1]*d,y.data[0+E+2]=a[E+2]*d,y.data[0+E+3]=r?255:a[E+3]*d;hm?.putImageData(y,0,0)}}function r_(i,e,t){if(i===e)return!0;if(!t||!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!r_(i[r],e[r],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const r=Object.keys(i),o=Object.keys(e);if(r.length!==o.length)return!1;for(const c of r)if(!e.hasOwnProperty(c)||!r_(i[c],e[c],t-1))return!1;return!0}return!1}class dm{bufferLayouts;constructor(e){this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){return e.attributes?e.attributes?.map(t=>t.attribute):[e.name]}mergeBufferLayouts(e,t){const r=[...e];for(const o of t){const c=r.findIndex(d=>d.name===o.name);c<0?r.push(o):r[c]=o}return r}getBufferIndex(e){const t=this.bufferLayouts.findIndex(r=>r.name===e);return t===-1&&dt.warn(`BufferLayout: Missing buffer for "${e}".`)(),t}}function Tk(i,e){const t=Object.fromEntries(i.attributes.map(o=>[o.name,o.location])),r=e.slice();return r.sort((o,c)=>{const d=o.attributes?o.attributes.map(E=>E.attribute):[o.name],a=c.attributes?c.attributes.map(E=>E.attribute):[c.name],y=Math.min(...d.map(E=>t[E])),w=Math.min(...a.map(E=>t[E]));return y-w}),r}function Sk(i){return ArrayBuffer.isView(i)&&!(i instanceof DataView)}function Ek(i){return Array.isArray(i)?i.length===0||typeof i[0]=="number":!1}function Ak(i){return Sk(i)||Ek(i)}function Pk(i){return Ak(i)||typeof i=="number"||typeof i=="boolean"}function Ck(i){const e={bindings:{},uniforms:{}};return Object.keys(i).forEach(t=>{const r=i[t];Pk(r)?e.uniforms[t]=r:e.bindings[t]=r}),e}class Ik{options={disableWarnings:!1};modules;moduleUniforms;moduleBindings;constructor(e,t){Object.assign(this.options,t);const r=A_(Object.values(e).filter(o=>o.dependencies));for(const o of r)e[o.name]=o;dt.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[o,c]of Object.entries(e))this._addModule(c),c.name&&o!==c.name&&!this.options.disableWarnings&&dt.warn(`Module name: ${o} vs ${c.name}`)()}destroy(){}setProps(e){for(const t of Object.keys(e)){const r=t,o=e[r]||{},c=this.modules[r];if(!c){this.options.disableWarnings||dt.warn(`Module ${t} not found`)();continue}const d=this.moduleUniforms[r],a=this.moduleBindings[r],y=c.getUniforms?.(o,d)||o,{uniforms:w,bindings:E}=Ck(y);this.moduleUniforms[r]={...d,...w},this.moduleBindings[r]={...a,...E}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){const e={};for(const[t,r]of Object.entries(this.moduleUniforms))for(const[o,c]of Object.entries(r))e[`${t}.${o}`]={type:this.modules[t].uniformTypes?.[o],value:String(c)};return e}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}let Mk="";async function Rk(i,e){const t=new Image;return t.crossOrigin="anonymous",t.src=i.startsWith("http")?i:Mk+i,await t.decode(),e?await createImageBitmap(t,e):await createImageBitmap(t)}const kk=["+X","-X","+Y","-Y","+Z","-Z"],Dk=["+X","-X","+Y","-Y","+Z","-Z"];class dh{device;id;props;texture;sampler;view;ready;isReady=!1;destroyed=!1;resolveReady=()=>{};rejectReady=()=>{};get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(e,t){this.device=e;const r=Fh("async-texture");this.props={...dh.defaultProps,id:r,...t},this.id=this.props.id,t={...t},typeof t?.data=="string"&&t.dimension==="2d"&&(t.data=Rk(t.data)),t.mipmaps&&(t.mipLevels="auto"),this.ready=new Promise((o,c)=>{this.resolveReady=()=>{this.isReady=!0,o()},this.rejectReady=c}),this.initAsync(t)}async initAsync(e){const t=e.data,r=await N1(t).then(void 0,this.rejectReady);if(this.destroyed)return;const o=this.props.width&&this.props.height?{width:this.props.width,height:this.props.height}:this.getTextureDataSize(r);if(!o)throw new Error("Texture size could not be determined");const c={...o,...e,data:void 0,mipLevels:1},d=this.device.getMipLevelCount(c.width,c.height);if(c.mipLevels=this.props.mipLevels==="auto"?d:Math.min(d,this.props.mipLevels),this.texture=this.device.createTexture(c),this.sampler=this.texture.sampler,this.view=this.texture.view,e.data)switch(this.props.dimension){case"1d":this._setTexture1DData(this.texture,r);break;case"2d":this._setTexture2DData(r);break;case"3d":this._setTexture3DData(this.texture,r);break;case"2d-array":this._setTextureArrayData(this.texture,r);break;case"cube":this._setTextureCubeData(this.texture,r);break;case"cube-array":this._setTextureCubeArrayData(this.texture,r);break}this.props.mipmaps&&this.generateMipmaps(),dt.info(1,`${this} loaded`),this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}generateMipmaps(){this.texture.generateMipmapsWebGL()}setSampler(e={}){this.texture.setSampler(e instanceof Fa?e:this.device.createSampler(e))}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}isTextureLevelData(e){const t=e?.data;return ArrayBuffer.isView(t)}getTextureDataSize(e){if(!e||ArrayBuffer.isView(e))return null;if(Array.isArray(e))return this.getTextureDataSize(e[0]);if(this.device.isExternalImage(e))return this.device.getExternalImageSize(e);if(e&&typeof e=="object"&&e.constructor===Object){const r=Object.values(e)[0];return{width:r.width,height:r.height}}throw new Error("texture size deduction failed")}getCubeFaceDepth(e){switch(e){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(e)}}setTextureData(e){}_setTexture1DData(e,t){throw new Error("setTexture1DData not supported in WebGL.")}_setTexture2DData(e,t=0){if(!this.texture)throw new Error("Texture not initialized");const r=this._normalizeTextureData(e);r.length>1&&this.props.mipmaps!==!1&&dt.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let o=0;o<r.length;o++){const c=r[o];this.device.isExternalImage(c)?this.texture.copyExternalImage({image:c,depth:t,mipLevel:o,flipY:!0}):this.texture.copyImageData({data:c.data,mipLevel:o})}}_setTexture3DData(e,t){if(this.texture?.props.dimension!=="3d")throw new Error(this.id);for(let r=0;r<t.length;r++)this._setTexture2DData(t[r],r)}_setTextureCubeData(e,t){if(this.texture?.props.dimension!=="cube")throw new Error(this.id);for(const[r,o]of Object.entries(t)){const c=Dk.indexOf(r);this._setTexture2DData(o,c)}}_setTextureArrayData(e,t){if(this.texture?.props.dimension!=="2d-array")throw new Error(this.id);for(let r=0;r<t.length;r++)this._setTexture2DData(t[r],r)}_setTextureCubeArrayData(e,t){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}_setTextureCubeFaceData(e,t,r,o=0){Array.isArray(t)&&t.length>1&&this.props.mipmaps!==!1&&dt.warn(`${this.id} has mipmap and multiple LODs.`)();const c=kk.indexOf(r);this._setTexture2DData(t,c)}_normalizeTextureData(e){const t=this.texture;let r;return ArrayBuffer.isView(e)?r=[{data:e,width:t.width,height:t.height}]:Array.isArray(e)?r=e:r=[e],r}static defaultProps={...xr.defaultProps,data:null,mipmaps:!1}}async function N1(i){if(i=await i,Array.isArray(i))return await Promise.all(i.map(N1));if(i&&typeof i=="object"&&i.constructor===Object){const e=i,t=await Promise.all(Object.values(e)),r=Object.keys(e),o={};for(let c=0;c<r.length;c++)o[r[c]]=t[c];return o}return i}const Ta=2,Ok=1e4;class es{static defaultProps={...Ra.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:Pa.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0};device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(e,t){this.props={...es.defaultProps,...t},t=this.props,this.id=t.id||Fh("model"),this.device=e,Object.assign(this.userData,t.userData);const r=Object.fromEntries(this.props.modules?.map(y=>[y.name,y])||[]),o=t.shaderInputs||new Ik(r,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(o);const c=Fk(e),d=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){const{source:y,getUniforms:w}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:c,...this.props,modules:d});this.source=y,this._getModuleUniforms=w,this.props.shaderLayout||=OC(this.source)}else{const{vs:y,fs:w,getUniforms:E}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:c,...this.props,modules:d});this.vs=y,this.fs=w,this._getModuleUniforms=E}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||J_.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||Q_.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||=e}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return dt.info(Ta,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let r;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const o=this._getBindings();this.pipeline.setBindings(o,{disableWarnings:this.props.disableWarnings});const{indexBuffer:c}=this.vertexArray,d=c?c.byteLength/(c.indexType==="uint32"?4:2):void 0;r=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:d,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),r?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",r}setGeometry(e){this._gpuGeometry?.destroy();const t=e&&yk(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");const r=new dm(this.bufferLayout);this.bufferLayout=r.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new dm(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){r_(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new nC(this.shaderInputs.modules);for(const[t,r]of Object.entries(this.shaderInputs.modules))if(Lk(r)){const o=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=o}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){const r=t?.disableWarnings??this.props.disableWarnings;e.indices&&dt.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=Tk(this.pipeline.shaderLayout,this.bufferLayout);const o=new dm(this.bufferLayout);for(const[c,d]of Object.entries(e)){const a=o.getBufferLayout(c);if(!a){r||dt.warn(`Model(${this.id}): Missing layout for buffer "${c}".`)();continue}const y=o.getAttributeNamesForBuffer(a);let w=!1;for(const E of y){const I=this._attributeInfos[E];if(I){const D=this.device.type==="webgpu"?o.getBufferIndex(I.bufferName):I.location;this.vertexArray.setBuffer(D,d),w=!0}}!w&&!r&&dt.warn(`Model(${this.id}): Ignoring buffer "${d.id}" for unknown attribute "${c}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[r,o]of Object.entries(e)){const c=this._attributeInfos[r];c?this.vertexArray.setConstantWebGL(c.location,o):(t?.disableWarnings??this.props.disableWarnings)||dt.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${r}"`)()}this.setNeedsRedraw("constants")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof dh&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,r]of Object.entries(this.bindings))r instanceof dh?r.isReady&&(e[t]=r.texture):e[t]=r;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof pp?e=Math.max(e,t.texture.updateTimestamp):t instanceof Mi||t instanceof xr?e=Math.max(e,t.updateTimestamp):t instanceof dh?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof Fa||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[r]of Object.entries(t))!this.pipeline.shaderLayout.attributes.find(o=>o.name===r)&&r!=="positions"&&delete t[r];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||=e,this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(dt.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const r=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let o=null;this.source?o=r:this.fs&&(o=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:r,fs:o}),this._attributeInfos=Uw(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){const e=dt.level>3?0:Ok;dt.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,dt.group(Ta,`>>> DRAWING MODEL ${this.id}`,{collapsed:dt.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=bk(this.pipeline.shaderLayout,this.id);dt.table(Ta,e)();const t=this.shaderInputs.getDebugTable();dt.table(Ta,t)();const r=this._getAttributeDebugTable();dt.table(Ta,this._attributeInfos)(),dt.table(Ta,r)(),dt.groupEnd(Ta)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const r=e.props.framebuffer;r&&wk(r,{id:r.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,r]of Object.entries(this._attributeInfos)){const o=this.vertexArray.attributes[r.location];e[r.location]={name:t,type:r.shaderType,values:o?this._getBufferOrConstantValues(o,r.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,r=t.indexType==="uint32"?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:r.toString()}}return e}_getBufferOrConstantValues(e,t){const r=C_(t);return(e instanceof Mi?new r(e.debugData):e).toString()}}function Lk(i){return!!(i.uniformTypes&&!Bk(i.uniformTypes))}function Fk(i){return{type:i.type,shaderLanguage:i.info.shadingLanguage,shaderLanguageVersion:i.info.shadingLanguageVersion,gpu:i.info.gpu,features:i.features}}function Bk(i){for(const e in i)return!1;return!0}class vc{device;model;transformFeedback;static defaultProps={...es.defaultProps,outputs:void 0,feedbackBuffers:void 0};static isSupported(e){return e?.info?.type==="webgl"}constructor(e,t=vc.defaultProps){if(!vc.isSupported(e))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new es(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||QP(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e?.inputBuffers&&this.model.setAttributes(e.inputBuffers),e?.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(!t)throw new Error("BufferTransform#getBuffer");if(t instanceof Mi)return t.readAsync();const{buffer:r,byteOffset:o=0,byteLength:c=r.byteLength}=t;return r.readAsync(o,c)}}class bc{id;topology;vertexCount;indices;attributes;userData={};constructor(e){const{attributes:t={},indices:r=null,vertexCount:o=null}=e;this.id=e.id||Fh("geometry"),this.topology=e.topology,r&&(this.indices=ArrayBuffer.isView(r)?{value:r,size:1}:r),this.attributes={};for(const[c,d]of Object.entries(t)){const a=ArrayBuffer.isView(d)?{value:d}:d;if(!ArrayBuffer.isView(a.value))throw new Error(`${this._print(c)}: must be typed array or object with value as typed array`);if((c==="POSITION"||c==="positions")&&!a.size&&(a.size=3),c==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=a}else this.attributes[c]=a}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=o||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let r=1/0;for(const o of Object.values(e)){const{value:c,size:d,constant:a}=o;!a&&c&&d!==void 0&&d>=1&&(r=Math.min(r,c.length/d))}return r}}const Nk={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant",blendAlphaDstFactor:"zero"};class z1 extends Y_{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:r,viewports:o,onViewportActive:c,pickingFBO:d,deviceRect:{x:a,y,width:w,height:E},cullRect:I,effects:D,pass:F="picking",pickZ:X,shaderModuleProps:oe}){this.pickZ=X;const _e=this._resetColorEncoder(X),ge=[a,y,w,E],fe=super.render({target:d,layers:e,layerFilter:t,views:r,viewports:o,onViewportActive:c,cullRect:I,effects:D?.filter(ke=>ke.useInPicking),pass:F,isPicking:!0,shaderModuleProps:oe,clearColor:[0,0,0,0],colorMask:15,scissorRect:ge});return this._colorEncoderState=null,{decodePickingColor:_e&&Uk.bind(null,_e),stats:fe}}shouldDrawLayer(e){const{pickable:t,operation:r}=e.props;return t&&r.includes("draw")||r.includes("terrain")||r.includes("mask")}getShaderModuleProps(e,t,r){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,r){const o={...e.props.parameters},{pickable:c,operation:d}=e.props;return!this._colorEncoderState||d.includes("terrain")?o.blend=!1:c&&d.includes("draw")&&(Object.assign(o,Nk),o.blend=!0,o.blendColor=zk(this._colorEncoderState,e,r)),o}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function zk(i,e,t){const{byLayer:r,byAlpha:o}=i;let c,d=r.get(e);return d?(d.viewports.push(t),c=d.a):(c=r.size+1,c<=255?(d={a:c,layer:e,viewports:[t]},r.set(e,d),o[c]=d):(ii.warn("Too many pickable layers, only picking the first 255")(),c=0)),[0,0,0,c/255]}function Uk(i,e){const t=i.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}const rc={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},sp=Symbol.for("component"),Ho=Symbol.for("propTypes"),fm=Symbol.for("deprecatedProps"),dc=Symbol.for("asyncPropDefaults"),Ua=Symbol.for("asyncPropOriginal"),jo=Symbol.for("asyncPropResolved");function Va(i,e=()=>!0){return Array.isArray(i)?U1(i,e,[]):e(i)?[i]:[]}function U1(i,e,t){let r=-1;for(;++r<i.length;){const o=i[r];Array.isArray(o)?U1(o,e,t):e(o)&&t.push(o)}return t}function Vk({target:i,source:e,start:t=0,count:r=1}){const o=e.length,c=r*o;let d=0;for(let a=t;d<o;d++)i[a++]=e[d];for(;d<c;)d<c-d?(i.copyWithin(t+d,t,t+d),d*=2):(i.copyWithin(t+d,t,t+c-d),d=c);return i}class jk{constructor(e,t,r){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=r,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const r=++this._loadCount;let o=e;typeof e=="string"&&(o=Wf(e)),o instanceof Promise?(this.isLoaded=!1,this._loader=o.then(c=>{this._loadCount===r&&(this.isLoaded=!0,this._error=void 0,this._content=c)}).catch(c=>{this._loadCount===r&&(this.isLoaded=!0,this._error=c||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const c of this._subscribers)c.onChange(this.getData())}}class $k{constructor(e){this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:e.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:r=!1,persistent:o=!0}){let c=this._resources[e];c?c.setData(t,r):(c=new jk(e,t,this._context),this._resources[e]=c),c.persistent=o}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const r in t){const o=t[r],c=this._resources[o.resourceId];c&&c.unsubscribe(o)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:r,requestId:o="default"}){const{_resources:c,protocol:d}=this;e.startsWith(d)&&(e=e.replace(d,""),c[e]||this.add({resourceId:e,data:null,persistent:!1}));const a=c[e];if(this._track(r,o,a,t),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,r,o){const c=this._consumers,d=c[e]=c[e]||{};let a=d[t];const y=a&&a.resourceId&&this._resources[a.resourceId];y&&(y.unsubscribe(a),this.prune()),r&&(a?(a.onChange=o,a.resourceId=r.id):a={onChange:o,resourceId:r.id},d[t]=a,r.subscribe(a))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const Wk="layerManager.setLayers",Hk="layerManager.activateViewport";class Zk{constructor(e,t){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=a=>{Nr(Hk,this,a),a&&(this.context.viewport=a)};const{deck:r,stats:o,viewport:c,timeline:d}=t||{};this.layers=[],this.resourceManager=new $k({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e?.gl,deck:r,shaderAssembler:VR(e?.info?.shadingLanguage||"glsl"),defaultShaderModules:[GI],renderPass:void 0,stats:o||new hp({id:"deck.gl"}),viewport:c||new Sc({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:d||new B1,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const r of this.layers){const o=r.getNeedsRedraw(e);t=t||o}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(r=>t.id.indexOf(r)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){Nr(Wk,this,t,e),this._lastRenderedLayers=e;const r=Va(e,Boolean);for(const o of r)o.context=this.context;this._updateLayers(this.layers,r)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(r=>r.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,r=t.findIndex(o=>o.name===e.name);r>=0&&(t.splice(r,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,r){r.raiseError(t,`${e} of ${r}`)}_updateLayers(e,t){const r={};for(const d of e)r[d.id]?ii.warn(`Multiple old layers with same id ${d.id}`)():r[d.id]=d;if(this._defaultShaderModulesChanged){for(const d of e)d.setNeedsUpdate(),d.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const o=[];this._updateSublayersRecursively(t,r,o),this._finalizeOldLayers(r);let c=!1;for(const d of o)if(d.hasUniformTransition()){c=`Uniform transition in ${d}`;break}this._needsUpdate=c,this.layers=o}_updateSublayersRecursively(e,t,r){for(const o of e){o.context=this.context;const c=t[o.id];c===null&&ii.warn(`Multiple new layers with same id ${o.id}`)(),t[o.id]=null;let d=null;try{this._debug&&c!==o&&o.validateProps(),c?(this._transferLayerState(c,o),this._updateLayer(o)):this._initializeLayer(o),r.push(o),d=o.isComposite?o.getSubLayers():null}catch(a){this._handleError("matching",a,o)}d&&this._updateSublayersRecursively(d,t,r)}}_finalizeOldLayers(e){for(const t in e){const r=e[t];r&&this._finalizeLayer(r)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=rc.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=rc.MATCHED,t!==e&&(e.lifecycle=rc.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=rc.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=rc.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}function kn(i,e,t){if(i===e)return!0;if(!t||!i||!e)return!1;if(Array.isArray(i)){if(!Array.isArray(e)||i.length!==e.length)return!1;for(let r=0;r<i.length;r++)if(!kn(i[r],e[r],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof i=="object"&&typeof e=="object"){const r=Object.keys(i),o=Object.keys(e);if(r.length!==o.length)return!1;for(const c of r)if(!e.hasOwnProperty(c)||!kn(i[c],e[c],t-1))return!1;return!0}return!1}class qk{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,r=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(r):r}getViewport(e){return this._viewportMap[e]}unproject(e,t){const r=this.getViewports(),o={x:e[0],y:e[1]};for(let c=r.length-1;c>=0;--c){const d=r[c];if(d.containsPixel(o)){const a=e.slice();return a[0]-=d.x,a[1]-=d.y,d.unproject(a,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Va(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!kn(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):ii.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const r=t.type;return new r({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:c=>this.getView(e.id)?.makeViewport({viewState:c,width:this.width,height:this.height})})}_updateController(e,t,r,o){const c=e.controller;if(c&&r){const d={...t,...c,id:e.id,x:r.x,y:r.y,width:r.width,height:r.height};return(!o||o.constructor!==c.type)&&(o=this._createController(e,d)),o&&o.setProps(d),o}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let r=!1;for(let o=e.length;o--;){const c=e[o],d=this.getViewState(c),a=c.makeViewport({viewState:d,width:this.width,height:this.height});let y=t[c.id];const w=!!c.controller;w&&!y&&(r=!0),(r||!w)&&y&&(y.finalize(),y=null),this.controllers[c.id]=this._updateController(c,d,a,y),a&&this._viewports.unshift(a)}for(const o in t){const c=t[o];c&&!this.controllers[o]&&c.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((r,o)=>!e[o].equals(t[o]))}}const Xk=/([0-9]+\.?[0-9]*)(%|px)/;function Lo(i){switch(typeof i){case"number":return{position:i,relative:!1};case"string":const e=Xk.exec(i);if(e&&e.length>=3){const t=e[2]==="%",r=parseFloat(e[1]);return{position:t?r/100:r,relative:t}}default:throw new Error(`Could not parse position string ${i}`)}}function Fo(i,e){return i.relative?Math.round(i.position*e):i.position}class V1{constructor(e){const{id:t,x:r=0,y:o=0,width:c="100%",height:d="100%",padding:a=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=Lo(r),this._y=Lo(o),this._width=Lo(c),this._height=Lo(d),this._padding=a&&{left:Lo(a.left||0),right:Lo(a.right||0),top:Lo(a.top||0),bottom:Lo(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.constructor===e.constructor&&kn(this.props,e.props,2)}clone(e){const t=this.constructor;return new t({...this.props,...e})}makeViewport({width:e,height:t,viewState:r}){r=this.filterViewState(r);const o=this.getDimensions({width:e,height:t});if(!o.height||!o.width)return null;const c=this.getViewportType(r);return new c({...r,...this.props,...o})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const r in this.props.viewState)r!=="id"&&(t[r]=this.props.viewState[r]);return t}return e}getDimensions({width:e,height:t}){const r={x:Fo(this._x,e),y:Fo(this._y,t),width:Fo(this._width,e),height:Fo(this._height,t)};return this._padding&&(r.padding={left:Fo(this._padding.left,e),top:Fo(this._padding.top,t),right:Fo(this._padding.right,e),bottom:Fo(this._padding.bottom,t)}),r}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class yp{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){this.cancel(),this.settings=e,this._inProgress=!0,this.settings.onStart?.(this)}end(){this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd?.(this))}cancel(){this._inProgress&&(this.settings.onInterrupt?.(this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate?.(this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const Ob=()=>{},n_={BREAK:1,SNAP_TO_END:2,IGNORE:3},Gk=i=>i,Yk=n_.BREAK;class Kk{constructor(e){this._onTransitionUpdate=t=>{const{time:r,settings:{interpolator:o,startProps:c,endProps:d,duration:a,easing:y}}=t,w=y(r/a),E=o.interpolateProps(c,d,w);this.propsInTransition=this.getControllerState({...this.props,...E}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new yp(e.timeline),this.onViewStateChange=e.onViewStateChange||Ob,this.onStateChange=e.onStateChange||Ob}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const r=this.props;if(this.props=e,!r||this._shouldIgnoreViewportChange(r,e))return!1;if(this._isTransitionEnabled(e)){let o=r;if(this.transition.inProgress){const{interruption:c,endProps:d}=this.transition.settings;o={...r,...c===n_.SNAP_TO_END?d:this.propsInTransition||r}}this._triggerTransition(o,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:r}=e;return(t>0||t==="auto")&&!!r}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===n_.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const r=this.getControllerState(e),o=this.getControllerState(t).shortestPathFrom(r),c=t.transitionInterpolator,d=c.getDuration?c.getDuration(e,t):t.transitionDuration;if(d===0)return;const a=c.initializeProps(e,o);this.propsInTransition={};const y={duration:d,easing:t.transitionEasing||Gk,interpolator:c,interruption:t.transitionInterruption||Yk,startProps:a.start,endProps:a.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(y),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}}function ur(i,e){if(!i)throw new Error(e||"deck.gl: assertion failed.")}class Jk{constructor(e){const{compare:t,extract:r,required:o}=e;this._propsToCompare=t,this._propsToExtract=r||t,this._requiredProps=o}arePropsEqual(e,t){for(const r of this._propsToCompare)if(!(r in e)||!(r in t)||!xh(e[r],t[r]))return!1;return!0}initializeProps(e,t){const r={},o={};for(const c of this._propsToExtract)(c in e||c in t)&&(r[c]=e[c],o[c]=t[c]);return this._checkRequiredProps(r),this._checkRequiredProps(o),{start:r,end:o}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const r=e[t];ur(Number.isFinite(r)||Array.isArray(r),`${t} is required for transition`)})}}const Qk=["longitude","latitude","zoom","bearing","pitch"],eD=["longitude","latitude","zoom"];class ey extends Jk{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,r=Array.isArray(e)?{}:e;r.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:Qk,required:eD},super(r.transitionProps),this.opts=r}initializeProps(e,t){const r=super.initializeProps(e,t),{makeViewport:o,around:c}=this.opts;if(o&&c){const d=o(e),a=o(t),y=d.unproject(c);r.start.around=c,Object.assign(r.end,{around:a.project(y),aroundPosition:y,width:t.width,height:t.height})}return r}interpolateProps(e,t,r){const o={};for(const c of this._propsToExtract)o[c]=tp(e[c]||0,t[c]||0,r);if(t.aroundPosition&&this.opts.makeViewport){const c=this.opts.makeViewport({...t,...o});Object.assign(o,c.panByPosition(t.aroundPosition,tp(e.around,t.around,r)))}return o}}const Js={transitionDuration:0},tD=300,cf=i=>1-(1-i)*(1-i),ic={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},Sa={};class j1{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new Kk({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(const e in this._events)this._events[e]&&this.eventManager?.off(e,this.handleEvent);this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return t?!1:this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:r}=this.props,{offsetCenter:o}=e;return[o.x-t,o.y-r]}isPointInBounds(e,t){const{width:r,height:o}=this.props;if(t&&t.handled)return!1;const c=e[0]>=0&&e[0]<=r&&e[1]>=0&&e[1]<=o;return c&&t&&t.stopPropagation(),c}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?tD:0;const{scrollZoom:r=!0,dragPan:o=!0,dragRotate:c=!0,doubleClickZoom:d=!0,touchZoom:a=!0,touchRotate:y=!1,keyboard:w=!0}=e,E=!!this.onViewStateChange;this.toggleEvents(ic.WHEEL,E&&r),this.toggleEvents(ic.PAN,E),this.toggleEvents(ic.PINCH,E&&(a||y)),this.toggleEvents(ic.MULTI_PAN,E&&y),this.toggleEvents(ic.DOUBLE_CLICK,E&&d),this.toggleEvents(ic.KEYBOARD,E&&w),this.scrollZoom=r,this.dragPan=o,this.dragRotate=c,this.doubleClickZoom=d,this.touchZoom=a,this.touchRotate=y,this.keyboard=w}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(r=>{this._events[r]!==t&&(this._events[r]=t,t?this.eventManager.on(r,this.handleEvent):this.eventManager.off(r,this.handleEvent))})}updateViewport(e,t=null,r={}){const o={...e.getViewportProps(),...t},c=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(r),c){const d=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:o,interactionState:this._interactionState,oldViewState:d,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let r=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(r=!r);const o=this.controllerState[r?"panStart":"rotateStart"]({pos:t});return this._panMove=r,this.updateViewport(o,Js,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),r=this.controllerState.pan({pos:t});return this.updateViewport(r,Js,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const r=this.getCenter(e),o=[r[0]+e.velocityX*t/2,r[1]+e.velocityY*t/2],c=this.controllerState.pan({pos:o}).panEnd();this.updateViewport(c,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:cf},{isDragging:!1,isPanning:!0})}else{const r=this.controllerState.panEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),r=this.controllerState.rotate({pos:t});return this.updateViewport(r,Js,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const r=this.getCenter(e),o=[r[0]+e.velocityX*t/2,r[1]+e.velocityY*t/2],c=this.controllerState.rotate({pos:o}).rotateEnd();this.updateViewport(c,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:cf},{isDragging:!1,isRotating:!0})}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:r=.01,smooth:o=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:c}=e;let d=2/(1+Math.exp(-Math.abs(c*r)));c<0&&d!==0&&(d=1/d);const a=o?{...this._getTransitionProps({around:t}),transitionDuration:250}:Js,y=this.controllerState.zoom({pos:t,scale:d});return this.updateViewport(y,a,{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.controllerState.rotateStart({pos:t});return this.updateViewport(r,Js,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const r=this.controllerState.rotate({pos:t});return this.updateViewport(r,Js,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const r=this.getCenter(e),o=[r[0],r[1]+=e.velocityY*t/2],c=this.controllerState.rotate({pos:o});this.updateViewport(c,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:cf},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const r=this.controllerState.rotateEnd();this.updateViewport(r,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return Sa._startPinchRotation=e.rotation,Sa._lastPinchEvent=e,this.updateViewport(r,Js,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:r}=e,o=this.getCenter(e);t=t.zoom({pos:o,scale:r})}if(this.touchRotate){const{rotation:r}=e;t=t.rotate({deltaAngleX:Sa._startPinchRotation-r})}return this.updateViewport(t,Js,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Sa._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:r}=Sa;if(this.touchZoom&&t&&r&&e.scale!==r.scale){const o=this.getCenter(e);let c=this.controllerState.rotateEnd();const d=Math.log2(e.scale),a=(d-Math.log2(r.scale))/(e.deltaTime-r.deltaTime),y=Math.pow(2,d+a*t/2);c=c.zoom({pos:o,scale:y}).zoomEnd(),this.updateViewport(c,{...this._getTransitionProps({around:o}),transitionDuration:t,transitionEasing:cf},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const o=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(o,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Sa._startPinchRotation=null,Sa._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const r=this.isFunctionKeyPressed(e),o=this.controllerState.zoom({pos:t,scale:r?.5:2});return this.updateViewport(o,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:r,moveSpeed:o,rotateSpeedX:c,rotateSpeedY:d}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let y;const w={};switch(e.srcEvent.code){case"Minus":y=t?a.zoomOut(r).zoomOut(r):a.zoomOut(r),w.isZooming=!0;break;case"Equal":y=t?a.zoomIn(r).zoomIn(r):a.zoomIn(r),w.isZooming=!0;break;case"ArrowLeft":t?(y=a.rotateLeft(c),w.isRotating=!0):(y=a.moveLeft(o),w.isPanning=!0);break;case"ArrowRight":t?(y=a.rotateRight(c),w.isRotating=!0):(y=a.moveRight(o),w.isPanning=!0);break;case"ArrowUp":t?(y=a.rotateUp(d),w.isRotating=!0):(y=a.moveUp(o),w.isPanning=!0);break;case"ArrowDown":t?(y=a.rotateDown(d),w.isRotating=!0):(y=a.moveDown(o),w.isPanning=!0);break;default:return!1}return this.updateViewport(y,this._getTransitionProps(),w),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?Js:e?{...t,transitionInterpolator:new ey({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class iD{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const Lb=5,rD=1.2;class $1 extends iD{constructor(e){const{width:t,height:r,latitude:o,longitude:c,zoom:d,bearing:a=0,pitch:y=0,altitude:w=1.5,position:E=[0,0,0],maxZoom:I=20,minZoom:D=0,maxPitch:F=60,minPitch:X=0,startPanLngLat:oe,startZoomLngLat:_e,startRotatePos:ge,startBearing:fe,startPitch:Te,startZoom:ke,normalize:Je=!0}=e;ur(Number.isFinite(c)),ur(Number.isFinite(o)),ur(Number.isFinite(d)),super({width:t,height:r,latitude:o,longitude:c,zoom:d,bearing:a,pitch:y,altitude:w,maxZoom:I,minZoom:D,maxPitch:F,minPitch:X,normalize:Je,position:E},{startPanLngLat:oe,startZoomLngLat:_e,startRotatePos:ge,startBearing:fe,startPitch:Te,startZoom:ke}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const r=this.getState().startPanLngLat||this._unproject(t);if(!r)return this;const c=this.makeViewport(this.getViewportProps()).panByPosition(r,e);return this._getUpdatedState(c)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:r=0}){const{startRotatePos:o,startBearing:c,startPitch:d}=this.getState();if(!o||c===void 0||d===void 0)return this;let a;return e?a=this._getNewRotation(e,o,d,c):a={bearing:c+t,pitch:d+r},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:r}){let{startZoom:o,startZoomLngLat:c}=this.getState();if(c||(o=this.getViewportProps().zoom,c=this._unproject(t)||this._unproject(e)),!c)return this;const{maxZoom:d,minZoom:a}=this.getViewportProps();let y=o+Math.log2(r);y=Es(y,a,d);const w=this.makeViewport({...this.getViewportProps(),zoom:y});return this._getUpdatedState({zoom:y,...w.panByPosition(c,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),r={...this.getViewportProps()},{bearing:o,longitude:c}=r;return Math.abs(o-t.bearing)>180&&(r.bearing=o<0?o+360:o-360),Math.abs(c-t.longitude)>180&&(r.longitude=c<0?c+360:c-360),r}applyConstraints(e){const{maxZoom:t,minZoom:r,zoom:o}=e;e.zoom=Es(o,r,t);const{maxPitch:c,minPitch:d,pitch:a}=e;e.pitch=Es(a,d,c);const{normalize:y=!0}=e;return y&&Object.assign(e,ER(e)),e}_zoomFromCenter(e){const{width:t,height:r}=this.getViewportProps();return this.zoom({pos:[t/2,r/2],scale:e})}_panFromCenter(e){const{width:t,height:r}=this.getViewportProps();return this.pan({startPos:[t/2,r/2],pos:[t/2+e[0],r/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,r,o){const c=e[0]-t[0],d=e[1]-t[1],a=e[1],y=t[1],{width:w,height:E}=this.getViewportProps(),I=c/w;let D=0;d>0?Math.abs(E-y)>Lb&&(D=d/(y-E)*rD):d<0&&y>Lb&&(D=1-a/y),D=Es(D,-1,1);const{minPitch:F,maxPitch:X}=this.getViewportProps(),oe=o+180*I;let _e=r;return D>0?_e=r+D*(X-r):D<0&&(_e=r-D*(F-r)),{pitch:_e,bearing:oe}}}class nD extends j1{constructor(){super(...arguments),this.ControllerState=$1,this.transition={transitionDuration:300,transitionInterpolator:new ey({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class ty extends V1{constructor(e={}){super(e)}getViewportType(){return za}get ControllerType(){return nD}}ty.displayName="MapView";const sD=new L1;function oD(i,e){const t=i.order??1/0,r=e.order??1/0;return t-r}class aD{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(r=>r.id===e.id)){const r=t.findIndex(o=>oD(o,e)>0);r<0?t.push(e):t.splice(r,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(kn(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const o of this.effects)t[o.id]=o;const r=[];for(const o of e){const c=t[o.id];let d=o;c&&c!==o?c.setProps?(c.setProps(o.props),d=c):c.cleanup(this._context):c||o.setup(this._context),r.push(d),delete t[o.id]}for(const o in t)t[o].cleanup(this._context);this.effects=r,this._resolvedEffects=r.concat(this._defaultEffects),e.some(o=>o instanceof L1)||this._resolvedEffects.push(sD),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class lD extends Y_{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const cD="deckRenderer.renderLayers";class uD{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new lD(e),this.pickLayersPass=new z1(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,r={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};r.effects&&this._preRender(r.effects,r);const o=this.lastPostProcessEffect?this.renderBuffers[0]:r.target;this.lastPostProcessEffect&&(r.clearColor=[0,0,0,0],r.clearCanvas=!0);const c=t.render({...r,target:o});r.effects&&(this.lastPostProcessEffect&&(r.clearCanvas=e.clearCanvas===void 0?!0:e.clearCanvas),this._postRender(r.effects,r)),this.renderCount++,Nr(cD,this,c,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const r of e)t.preRenderStats[r.id]=r.preRender(t),r.postRender&&(this.lastPostProcessEffect=r.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize(),[r,o]=t;e.length===0&&[0,1].map(c=>{const d=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"},width:r,height:o});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${c}`,colorAttachments:[d]}))});for(const c of e)c.resize(t)}_postRender(e,t){const{renderBuffers:r}=this,o={...t,inputBuffer:r[0],swapBuffer:r[1]};for(const c of e)if(c.postRender){o.target=c.id===this.lastPostProcessEffect?t.target:void 0;const d=c.postRender(o);o.inputBuffer=d,o.swapBuffer=d===r[0]?r[1]:r[0]}}}const hD={pickedColor:null,pickedObjectIndex:-1};function Fb({pickedColors:i,decodePickingColor:e,deviceX:t,deviceY:r,deviceRadius:o,deviceRect:c}){const{x:d,y:a,width:y,height:w}=c;let E=o*o,I=-1,D=0;for(let F=0;F<w;F++){const X=F+a-r,oe=X*X;if(oe>E)D+=4*y;else for(let _e=0;_e<y;_e++){if(i[D+3]-1>=0){const fe=_e+d-t,Te=fe*fe+oe;Te<=E&&(E=Te,I=D)}D+=4}}if(I>=0){const F=i.slice(I,I+4),X=e(F);if(X){const oe=Math.floor(I/4/y),_e=I/4-oe*y;return{...X,pickedColor:F,pickedX:d+_e,pickedY:a+oe}}ii.error("Picked non-existent layer. Is picking buffer corrupt?")()}return hD}function Bb({pickedColors:i,decodePickingColor:e}){const t=new Map;if(i){for(let r=0;r<i.length;r+=4)if(i[r+3]-1>=0){const c=i.slice(r,r+4),d=c.join(",");if(!t.has(d)){const a=e(c);a?t.set(d,{...a,color:c}):ii.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function s_({pickInfo:i,viewports:e,pixelRatio:t,x:r,y:o,z:c}){let d=e[0];e.length>1&&(d=dD(i?.pickedViewports||e,{x:r,y:o}));let a;if(d){const y=[r-d.x,o-d.y];c!==void 0&&(y[2]=c),a=d.unproject(y)}return{color:null,layer:null,viewport:d,index:-1,picked:!1,x:r,y:o,pixel:[r,o],coordinate:a,devicePixel:i&&"pickedX"in i?[i.pickedX,i.pickedY]:void 0,pixelRatio:t}}function Nb(i){const{pickInfo:e,lastPickedInfo:t,mode:r,layers:o}=i,{pickedColor:c,pickedLayer:d,pickedObjectIndex:a}=e,y=d?[d]:[];if(r==="hover"){const I=t.index,D=t.layerId,F=d?d.props.id:null;if(F!==D||a!==I){if(F!==D){const X=o.find(oe=>oe.props.id===D);X&&y.unshift(X)}t.layerId=F,t.index=a,t.info=null}}const w=s_(i),E=new Map;return E.set(null,w),y.forEach(I=>{let D={...w};I===d&&(D.color=c,D.index=a,D.picked=!0),D=o_({layer:I,info:D,mode:r});const F=D.layer;I===d&&r==="hover"&&(t.info=D),E.set(F.id,D),r==="hover"&&F.updateAutoHighlight(D)}),E}function o_({layer:i,info:e,mode:t}){for(;i&&e;){const r=e.layer||null;e.sourceLayer=r,e.layer=i,e=i.getPickingInfo({info:e,mode:t,sourceLayer:r}),i=i.parent}return e}function dD(i,e){for(let t=i.length-1;t>=0;t--){const r=i[t];if(r.containsPixel(e))return r}return i[0]}class fD{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new z1(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObjectAsync(e){return this._pickClosestObjectAsync(e)}pickObjectsAsync(e){return this._pickVisibleObjectsAsync(e)}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:r,viewports:o},c=this.lastPickedInfo.info){const d=c&&c.layer&&c.layer.id,a=c&&c.viewport&&c.viewport.id,y=d?r.find(D=>D.id===d):null,w=a&&o.find(D=>D.id===a)||o[0],E=w&&w.unproject([e-w.x,t-w.y]);return{...c,...{x:e,y:t,viewport:w,coordinate:E,layer:y}}}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const t=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=t}const{canvas:e}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:e.width,height:e.height}),this.depthFBO?.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(r=>this.pickLayersPass.shouldDrawLayer(r)&&!r.isComposite);return t.length?t:null}async _pickClosestObjectAsync({layers:e,views:t,viewports:r,x:o,y:c,radius:d=0,depth:a=1,mode:y="query",unproject3D:w,onViewportActive:E,effects:I}){const D=this.device.canvasContext.cssToDeviceRatio(),F=this._getPickable(e);if(!F||r.length===0)return{result:[],emptyInfo:s_({viewports:r,x:o,y:c,pixelRatio:D})};this._resizeBuffer();const X=this.device.canvasContext.cssToDevicePixels([o,c],!0),oe=[X.x+Math.floor(X.width/2),X.y+Math.floor(X.height/2)],_e=Math.round(d*D),{width:ge,height:fe}=this.pickingFBO,Te=this._getPickingRect({deviceX:oe[0],deviceY:oe[1],deviceRadius:_e,deviceWidth:ge,deviceHeight:fe}),ke={x:o-d,y:c-d,width:d*2+1,height:d*2+1};let Je;const Xe=[],mt=new Set;for(let G=0;G<a;G++){let J;if(Te){const be=this._drawAndSample({layers:F,views:t,viewports:r,onViewportActive:E,deviceRect:Te,cullRect:ke,effects:I,pass:`picking:${y}`});J=Fb({...be,deviceX:oe[0],deviceY:oe[1],deviceRadius:_e,deviceRect:Te})}else J={pickedColor:null,pickedObjectIndex:-1};let ae;if(J.pickedLayer&&w&&this.depthFBO){const{pickedColors:be}=this._drawAndSample({layers:[J.pickedLayer],views:t,viewports:r,onViewportActive:E,deviceRect:{x:J.pickedX,y:J.pickedY,width:1,height:1},cullRect:ke,effects:I,pass:`picking:${y}:z`},!0);be[3]&&(ae=be[0])}J.pickedLayer&&G+1<a&&(mt.add(J.pickedLayer),J.pickedLayer.disablePickingIndex(J.pickedObjectIndex)),Je=Nb({pickInfo:J,lastPickedInfo:this.lastPickedInfo,mode:y,layers:F,viewports:r,x:o,y:c,z:ae,pixelRatio:D});for(const be of Je.values())be.layer&&Xe.push(be);if(!J.pickedColor)break}for(const G of mt)G.restorePickingColors();return{result:Xe,emptyInfo:Je.get(null)}}_pickClosestObject({layers:e,views:t,viewports:r,x:o,y:c,radius:d=0,depth:a=1,mode:y="query",unproject3D:w,onViewportActive:E,effects:I}){const D=this.device.canvasContext.cssToDeviceRatio(),F=this._getPickable(e);if(!F||r.length===0)return{result:[],emptyInfo:s_({viewports:r,x:o,y:c,pixelRatio:D})};this._resizeBuffer();const X=this.device.canvasContext.cssToDevicePixels([o,c],!0),oe=[X.x+Math.floor(X.width/2),X.y+Math.floor(X.height/2)],_e=Math.round(d*D),{width:ge,height:fe}=this.pickingFBO,Te=this._getPickingRect({deviceX:oe[0],deviceY:oe[1],deviceRadius:_e,deviceWidth:ge,deviceHeight:fe}),ke={x:o-d,y:c-d,width:d*2+1,height:d*2+1};let Je;const Xe=[],mt=new Set;for(let G=0;G<a;G++){let J;if(Te){const be=this._drawAndSample({layers:F,views:t,viewports:r,onViewportActive:E,deviceRect:Te,cullRect:ke,effects:I,pass:`picking:${y}`});J=Fb({...be,deviceX:oe[0],deviceY:oe[1],deviceRadius:_e,deviceRect:Te})}else J={pickedColor:null,pickedObjectIndex:-1};let ae;if(J.pickedLayer&&w&&this.depthFBO){const{pickedColors:be}=this._drawAndSample({layers:[J.pickedLayer],views:t,viewports:r,onViewportActive:E,deviceRect:{x:J.pickedX,y:J.pickedY,width:1,height:1},cullRect:ke,effects:I,pass:`picking:${y}:z`},!0);be[3]&&(ae=be[0])}J.pickedLayer&&G+1<a&&(mt.add(J.pickedLayer),J.pickedLayer.disablePickingIndex(J.pickedObjectIndex)),Je=Nb({pickInfo:J,lastPickedInfo:this.lastPickedInfo,mode:y,layers:F,viewports:r,x:o,y:c,z:ae,pixelRatio:D});for(const be of Je.values())be.layer&&Xe.push(be);if(!J.pickedColor)break}for(const G of mt)G.restorePickingColors();return{result:Xe,emptyInfo:Je.get(null)}}async _pickVisibleObjectsAsync({layers:e,views:t,viewports:r,x:o,y:c,width:d=1,height:a=1,mode:y="query",maxObjects:w=null,onViewportActive:E,effects:I}){const D=this._getPickable(e);if(!D||r.length===0)return[];this._resizeBuffer();const F=this.device.canvasContext.cssToDeviceRatio(),X=this.device.canvasContext.cssToDevicePixels([o,c],!0),oe=X.x,_e=X.y+X.height,ge=this.device.canvasContext.cssToDevicePixels([o+d,c+a],!0),fe=ge.x+ge.width,Te=ge.y,ke={x:oe,y:Te,width:fe-oe,height:_e-Te},Je=this._drawAndSample({layers:D,views:t,viewports:r,onViewportActive:E,deviceRect:ke,cullRect:{x:o,y:c,width:d,height:a},effects:I,pass:`picking:${y}`}),Xe=Bb(Je),mt=new Map,G=[],J=Number.isFinite(w);for(let ae=0;ae<Xe.length&&!(J&&G.length>=w);ae++){const be=Xe[ae];let ye={color:be.pickedColor,layer:null,index:be.pickedObjectIndex,picked:!0,x:o,y:c,pixelRatio:F};ye=o_({layer:be.pickedLayer,info:ye,mode:y});const we=ye.layer.id;mt.has(we)||mt.set(we,new Set);const Se=mt.get(we),Ee=ye.object??ye.index;Se.has(Ee)||(Se.add(Ee),G.push(ye))}return G}_pickVisibleObjects({layers:e,views:t,viewports:r,x:o,y:c,width:d=1,height:a=1,mode:y="query",maxObjects:w=null,onViewportActive:E,effects:I}){const D=this._getPickable(e);if(!D||r.length===0)return[];this._resizeBuffer();const F=this.device.canvasContext.cssToDeviceRatio(),X=this.device.canvasContext.cssToDevicePixels([o,c],!0),oe=X.x,_e=X.y+X.height,ge=this.device.canvasContext.cssToDevicePixels([o+d,c+a],!0),fe=ge.x+ge.width,Te=ge.y,ke={x:oe,y:Te,width:fe-oe,height:_e-Te},Je=this._drawAndSample({layers:D,views:t,viewports:r,onViewportActive:E,deviceRect:ke,cullRect:{x:o,y:c,width:d,height:a},effects:I,pass:`picking:${y}`}),Xe=Bb(Je),mt=new Map,G=[],J=Number.isFinite(w);for(let ae=0;ae<Xe.length&&!(J&&G.length>=w);ae++){const be=Xe[ae];let ye={color:be.pickedColor,layer:null,index:be.pickedObjectIndex,picked:!0,x:o,y:c,pixelRatio:F};ye=o_({layer:be.pickedLayer,info:ye,mode:y});const we=ye.layer.id;mt.has(we)||mt.set(we,new Set);const Se=mt.get(we),Ee=ye.object??ye.index;Se.has(Ee)||(Se.add(Ee),G.push(ye))}return G}async _drawAndSampleAsync({layers:e,views:t,viewports:r,onViewportActive:o,deviceRect:c,cullRect:d,effects:a,pass:y},w=!1){const E=w?this.depthFBO:this.pickingFBO,I={layers:e,layerFilter:this.layerFilter,views:t,viewports:r,onViewportActive:o,pickingFBO:E,deviceRect:c,cullRect:d,effects:a,pass:y,pickZ:w,preRenderStats:{},isPicking:!0};for(const fe of a)fe.useInPicking&&(I.preRenderStats[fe.id]=fe.preRender(I));const{decodePickingColor:D}=this.pickLayersPass.render(I),{x:F,y:X,width:oe,height:_e}=c,ge=new(w?Float32Array:Uint8Array)(oe*_e*4);return this.device.readPixelsToArrayWebGL(E,{sourceX:F,sourceY:X,sourceWidth:oe,sourceHeight:_e,target:ge}),{pickedColors:ge,decodePickingColor:D}}_drawAndSample({layers:e,views:t,viewports:r,onViewportActive:o,deviceRect:c,cullRect:d,effects:a,pass:y},w=!1){const E=w?this.depthFBO:this.pickingFBO,I={layers:e,layerFilter:this.layerFilter,views:t,viewports:r,onViewportActive:o,pickingFBO:E,deviceRect:c,cullRect:d,effects:a,pass:y,pickZ:w,preRenderStats:{},isPicking:!0};for(const fe of a)fe.useInPicking&&(I.preRenderStats[fe.id]=fe.preRender(I));const{decodePickingColor:D}=this.pickLayersPass.render(I),{x:F,y:X,width:oe,height:_e}=c,ge=new(w?Float32Array:Uint8Array)(oe*_e*4);return this.device.readPixelsToArrayWebGL(E,{sourceX:F,sourceY:X,sourceWidth:oe,sourceHeight:_e,target:ge}),{pickedColors:ge,decodePickingColor:D}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:r,deviceWidth:o,deviceHeight:c}){const d=Math.max(0,e-r),a=Math.max(0,t-r),y=Math.min(o,e+r+1)-d,w=Math.min(c,t+r+1)-a;return y<=0||w<=0?null:{x:d,y:a,width:y,height:w}}}const pD={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},gD="top-left",zb="__root";class mD{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,t?.classList.add("deck-widget-container"),this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){if(e.widgets&&!kn(e.widgets,this.widgets,1)){const t=e.widgets.filter(Boolean);this._setWidgets(t)}}finalize(){for(const e of this.getWidgets())this._removeWidget(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._addWidget(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}onRedraw({viewports:e,layers:t}){const r=e.reduce((o,c)=>(o[c.id]=c,o),{});for(const o of this.getWidgets()){const{viewId:c}=o;if(c){const d=r[c];d&&(o.onViewportChange&&o.onViewportChange(d),o.onRedraw?.({viewports:[d],layers:t}))}else{if(o.onViewportChange)for(const d of e)o.onViewportChange(d);o.onRedraw?.({viewports:e,layers:t})}}this.lastViewports=r,this._updateContainers()}onHover(e,t){for(const r of this.getWidgets()){const{viewId:o}=r;(!o||o===e.viewport?.id)&&r.onHover?.(e,t)}}onEvent(e,t){const r=Qm[t.type];if(r)for(const o of this.getWidgets()){const{viewId:c}=o;(!c||c===e.viewport?.id)&&o[r]?.(e,t)}}_setWidgets(e){const t={};for(const r of this.resolvedWidgets)t[r.id]=r;this.resolvedWidgets.length=0;for(const r of this.defaultWidgets)t[r.id]=null,this.resolvedWidgets.push(r);for(let r of e){const o=t[r.id];o?o.viewId!==r.viewId||o.placement!==r.placement?(this._removeWidget(o),this._addWidget(r)):r!==o&&(o.setProps(r.props),r=o):this._addWidget(r),t[r.id]=null,this.resolvedWidgets.push(r)}for(const r in t){const o=t[r];o&&this._removeWidget(o)}this.widgets=e}_addWidget(e){const{viewId:t=null,placement:r=gD}=e;e.widgetManager=this,e.deck=this.deck,e.rootElement=e._onAdd({deck:this.deck,viewId:t}),e.rootElement&&this._getContainer(t,r).append(e.rootElement),e.updateHTML()}_removeWidget(e){e.onRemove?.(),e.rootElement&&e.rootElement.remove(),e.rootElement=void 0,e.deck=void 0,e.widgetManager=void 0}_getContainer(e,t){const r=e||zb;let o=this.containers[r];o||(o=document.createElement("div"),o.style.pointerEvents="none",o.style.position="absolute",o.style.overflow="hidden",this.parentElement?.append(o),this.containers[r]=o);let c=o.querySelector(`.${t}`);return c||(c=globalThis.document.createElement("div"),c.className=t,c.style.position="absolute",c.style.zIndex="2",Object.assign(c.style,pD[t]),o.append(c)),c}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const r in this.containers){const o=this.lastViewports[r]||null,c=r===zb||o,d=this.containers[r];c?(d.style.display="block",d.style.left=`${o?o.x:0}px`,d.style.top=`${o?o.y:0}px`,d.style.width=`${o?o.width:e}px`,d.style.height=`${o?o.height:t}px`):d.style.display="none"}}}function Ub(i,e){e&&Object.entries(e).map(([t,r])=>{t.startsWith("--")?i.style.setProperty(t,r):i.style[t]=r})}function _D(i,e){e&&Object.keys(e).map(t=>{t.startsWith("--")?i.style.removeProperty(t):i.style[t]=""})}class iy{constructor(e){this.viewId=null,this.props={...this.constructor.defaultProps,...e},this.id=this.props.id}setProps(e){const t=this.props,r=this.rootElement;r&&t.className!==e.className&&(t.className&&r.classList.remove(t.className),e.className&&r.classList.add(e.className)),r&&!kn(t.style,e.style,1)&&(_D(r,t.style),Ub(r,e.style)),Object.assign(this.props,e),this.updateHTML()}updateHTML(){this.rootElement&&this.onRenderHTML(this.rootElement)}onCreateRootElement(){const e=["deck-widget",this.className,this.props.className],t=document.createElement("div");return e.filter(r=>typeof r=="string"&&r.length>0).forEach(r=>t.classList.add(r)),Ub(t,this.props.style),t}_onAdd(e){return this.onAdd(e)??this.onCreateRootElement()}onAdd(e){}onRemove(){}onViewportChange(e){}onRedraw(e){}onHover(e,t){}onClick(e,t){}onDrag(e,t){}onDragStart(e,t){}onDragEnd(e,t){}}iy.defaultProps={id:"widget",style:{},className:""};const yD={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class W1 extends iy{constructor(e={}){super(e),this.id="default-tooltip",this.placement="fill",this.className="deck-tooltip",this.isVisible=!1,this.setProps(e)}onCreateRootElement(){const e=document.createElement("div");return e.className=this.className,Object.assign(e.style,yD),e}onRenderHTML(e){}onViewportChange(e){this.isVisible&&e.id===this.lastViewport?.id&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,r=t&&t.props.getTooltip;if(!r)return;const o=r(e);this.lastViewport=e.viewport,this.setTooltip(o,e.x,e.y)}setTooltip(e,t,r){const o=this.rootElement;if(o){if(typeof e=="string")o.innerText=e;else if(e)e.text&&(o.innerText=e.text),e.html&&(o.innerHTML=e.html),e.className&&(o.className=e.className);else{this.isVisible=!1,o.style.display="none";return}this.isVisible=!0,o.style.display="block",o.style.transform=`translate(${t}px, ${r}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(o.style,e.style)}}}W1.defaultProps={...iy.defaultProps};const xD="modulepreload",vD=function(i){return"/"+i},Vb={},jb=function(e,t,r){let o=Promise.resolve();if(t&&t.length>0){let d=function(w){return Promise.all(w.map(E=>Promise.resolve(E).then(I=>({status:"fulfilled",value:I}),I=>({status:"rejected",reason:I}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),y=a?.nonce||a?.getAttribute("nonce");o=d(t.map(w=>{if(w=vD(w),w in Vb)return;Vb[w]=!0;const E=w.endsWith(".css"),I=E?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${w}"]${I}`))return;const D=document.createElement("link");if(D.rel=E?"stylesheet":xD,E||(D.as="script"),D.crossOrigin="",D.href=w,y&&D.setAttribute("nonce",y),document.head.appendChild(D),E)return new Promise((F,X)=>{D.addEventListener("load",F),D.addEventListener("error",()=>X(new Error(`Unable to preload CSS for ${w}`)))})}))}function c(d){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=d,window.dispatchEvent(a),!a.defaultPrevented)throw d}return o.then(d=>{for(const a of d||[])a.status==="rejected"&&c(a.reason);return e().catch(c)})};var sc;(function(i){i[i.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",i[i.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",i[i.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",i[i.POINTS=0]="POINTS",i[i.LINES=1]="LINES",i[i.LINE_LOOP=2]="LINE_LOOP",i[i.LINE_STRIP=3]="LINE_STRIP",i[i.TRIANGLES=4]="TRIANGLES",i[i.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",i[i.TRIANGLE_FAN=6]="TRIANGLE_FAN",i[i.ZERO=0]="ZERO",i[i.ONE=1]="ONE",i[i.SRC_COLOR=768]="SRC_COLOR",i[i.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.DST_ALPHA=772]="DST_ALPHA",i[i.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",i[i.DST_COLOR=774]="DST_COLOR",i[i.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",i[i.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",i[i.CONSTANT_COLOR=32769]="CONSTANT_COLOR",i[i.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",i[i.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",i[i.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",i[i.FUNC_ADD=32774]="FUNC_ADD",i[i.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",i[i.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",i[i.BLEND_EQUATION=32777]="BLEND_EQUATION",i[i.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",i[i.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",i[i.BLEND_DST_RGB=32968]="BLEND_DST_RGB",i[i.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",i[i.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",i[i.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",i[i.BLEND_COLOR=32773]="BLEND_COLOR",i[i.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",i[i.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",i[i.LINE_WIDTH=2849]="LINE_WIDTH",i[i.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",i[i.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",i[i.CULL_FACE_MODE=2885]="CULL_FACE_MODE",i[i.FRONT_FACE=2886]="FRONT_FACE",i[i.DEPTH_RANGE=2928]="DEPTH_RANGE",i[i.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",i[i.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",i[i.DEPTH_FUNC=2932]="DEPTH_FUNC",i[i.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",i[i.STENCIL_FUNC=2962]="STENCIL_FUNC",i[i.STENCIL_FAIL=2964]="STENCIL_FAIL",i[i.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",i[i.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",i[i.STENCIL_REF=2967]="STENCIL_REF",i[i.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",i[i.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",i[i.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",i[i.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",i[i.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",i[i.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",i[i.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",i[i.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",i[i.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",i[i.VIEWPORT=2978]="VIEWPORT",i[i.SCISSOR_BOX=3088]="SCISSOR_BOX",i[i.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",i[i.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",i[i.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",i[i.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",i[i.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",i[i.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",i[i.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",i[i.RED_BITS=3410]="RED_BITS",i[i.GREEN_BITS=3411]="GREEN_BITS",i[i.BLUE_BITS=3412]="BLUE_BITS",i[i.ALPHA_BITS=3413]="ALPHA_BITS",i[i.DEPTH_BITS=3414]="DEPTH_BITS",i[i.STENCIL_BITS=3415]="STENCIL_BITS",i[i.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",i[i.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",i[i.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",i[i.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",i[i.SAMPLES=32937]="SAMPLES",i[i.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",i[i.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",i[i.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",i[i.VENDOR=7936]="VENDOR",i[i.RENDERER=7937]="RENDERER",i[i.VERSION=7938]="VERSION",i[i.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",i[i.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",i[i.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",i[i.STATIC_DRAW=35044]="STATIC_DRAW",i[i.STREAM_DRAW=35040]="STREAM_DRAW",i[i.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",i[i.ARRAY_BUFFER=34962]="ARRAY_BUFFER",i[i.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",i[i.BUFFER_SIZE=34660]="BUFFER_SIZE",i[i.BUFFER_USAGE=34661]="BUFFER_USAGE",i[i.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",i[i.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",i[i.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",i[i.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",i[i.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",i[i.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",i[i.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",i[i.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",i[i.CULL_FACE=2884]="CULL_FACE",i[i.FRONT=1028]="FRONT",i[i.BACK=1029]="BACK",i[i.FRONT_AND_BACK=1032]="FRONT_AND_BACK",i[i.BLEND=3042]="BLEND",i[i.DEPTH_TEST=2929]="DEPTH_TEST",i[i.DITHER=3024]="DITHER",i[i.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",i[i.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",i[i.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",i[i.SCISSOR_TEST=3089]="SCISSOR_TEST",i[i.STENCIL_TEST=2960]="STENCIL_TEST",i[i.NO_ERROR=0]="NO_ERROR",i[i.INVALID_ENUM=1280]="INVALID_ENUM",i[i.INVALID_VALUE=1281]="INVALID_VALUE",i[i.INVALID_OPERATION=1282]="INVALID_OPERATION",i[i.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",i[i.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",i[i.CW=2304]="CW",i[i.CCW=2305]="CCW",i[i.DONT_CARE=4352]="DONT_CARE",i[i.FASTEST=4353]="FASTEST",i[i.NICEST=4354]="NICEST",i[i.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.INT=5124]="INT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT",i[i.DOUBLE=5130]="DOUBLE",i[i.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",i[i.ALPHA=6406]="ALPHA",i[i.RGB=6407]="RGB",i[i.RGBA=6408]="RGBA",i[i.LUMINANCE=6409]="LUMINANCE",i[i.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",i[i.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",i[i.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",i[i.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",i[i.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",i[i.VERTEX_SHADER=35633]="VERTEX_SHADER",i[i.COMPILE_STATUS=35713]="COMPILE_STATUS",i[i.DELETE_STATUS=35712]="DELETE_STATUS",i[i.LINK_STATUS=35714]="LINK_STATUS",i[i.VALIDATE_STATUS=35715]="VALIDATE_STATUS",i[i.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",i[i.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",i[i.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",i[i.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",i[i.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",i[i.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",i[i.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",i[i.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",i[i.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",i[i.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",i[i.SHADER_TYPE=35663]="SHADER_TYPE",i[i.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",i[i.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",i[i.NEVER=512]="NEVER",i[i.LESS=513]="LESS",i[i.EQUAL=514]="EQUAL",i[i.LEQUAL=515]="LEQUAL",i[i.GREATER=516]="GREATER",i[i.NOTEQUAL=517]="NOTEQUAL",i[i.GEQUAL=518]="GEQUAL",i[i.ALWAYS=519]="ALWAYS",i[i.KEEP=7680]="KEEP",i[i.REPLACE=7681]="REPLACE",i[i.INCR=7682]="INCR",i[i.DECR=7683]="DECR",i[i.INVERT=5386]="INVERT",i[i.INCR_WRAP=34055]="INCR_WRAP",i[i.DECR_WRAP=34056]="DECR_WRAP",i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9729]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",i[i.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",i[i.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",i[i.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",i[i.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",i[i.TEXTURE_2D=3553]="TEXTURE_2D",i[i.TEXTURE=5890]="TEXTURE",i[i.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",i[i.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",i[i.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",i[i.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",i[i.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",i[i.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",i[i.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",i[i.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",i[i.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",i[i.TEXTURE0=33984]="TEXTURE0",i[i.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",i[i.REPEAT=10497]="REPEAT",i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",i[i.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_CUBE=35680]="SAMPLER_CUBE",i[i.LOW_FLOAT=36336]="LOW_FLOAT",i[i.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",i[i.HIGH_FLOAT=36338]="HIGH_FLOAT",i[i.LOW_INT=36339]="LOW_INT",i[i.MEDIUM_INT=36340]="MEDIUM_INT",i[i.HIGH_INT=36341]="HIGH_INT",i[i.FRAMEBUFFER=36160]="FRAMEBUFFER",i[i.RENDERBUFFER=36161]="RENDERBUFFER",i[i.RGBA4=32854]="RGBA4",i[i.RGB5_A1=32855]="RGB5_A1",i[i.RGB565=36194]="RGB565",i[i.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",i[i.STENCIL_INDEX=6401]="STENCIL_INDEX",i[i.STENCIL_INDEX8=36168]="STENCIL_INDEX8",i[i.DEPTH_STENCIL=34041]="DEPTH_STENCIL",i[i.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",i[i.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",i[i.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",i[i.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",i[i.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",i[i.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",i[i.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",i[i.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",i[i.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",i[i.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",i[i.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",i[i.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",i[i.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",i[i.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",i[i.NONE=0]="NONE",i[i.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",i[i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",i[i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",i[i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",i[i.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",i[i.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",i[i.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",i[i.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",i[i.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",i[i.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",i[i.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",i[i.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",i[i.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",i[i.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",i[i.READ_BUFFER=3074]="READ_BUFFER",i[i.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",i[i.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",i[i.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",i[i.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",i[i.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",i[i.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",i[i.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",i[i.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",i[i.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",i[i.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",i[i.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",i[i.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",i[i.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",i[i.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",i[i.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",i[i.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",i[i.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",i[i.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",i[i.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",i[i.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",i[i.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",i[i.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",i[i.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",i[i.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",i[i.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",i[i.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",i[i.RED=6403]="RED",i[i.RGB8=32849]="RGB8",i[i.RGBA8=32856]="RGBA8",i[i.RGB10_A2=32857]="RGB10_A2",i[i.TEXTURE_3D=32879]="TEXTURE_3D",i[i.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",i[i.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",i[i.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",i[i.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",i[i.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",i[i.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",i[i.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",i[i.SRGB=35904]="SRGB",i[i.SRGB8=35905]="SRGB8",i[i.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",i[i.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",i[i.RGBA32F=34836]="RGBA32F",i[i.RGB32F=34837]="RGB32F",i[i.RGBA16F=34842]="RGBA16F",i[i.RGB16F=34843]="RGB16F",i[i.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",i[i.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",i[i.R11F_G11F_B10F=35898]="R11F_G11F_B10F",i[i.RGB9_E5=35901]="RGB9_E5",i[i.RGBA32UI=36208]="RGBA32UI",i[i.RGB32UI=36209]="RGB32UI",i[i.RGBA16UI=36214]="RGBA16UI",i[i.RGB16UI=36215]="RGB16UI",i[i.RGBA8UI=36220]="RGBA8UI",i[i.RGB8UI=36221]="RGB8UI",i[i.RGBA32I=36226]="RGBA32I",i[i.RGB32I=36227]="RGB32I",i[i.RGBA16I=36232]="RGBA16I",i[i.RGB16I=36233]="RGB16I",i[i.RGBA8I=36238]="RGBA8I",i[i.RGB8I=36239]="RGB8I",i[i.RED_INTEGER=36244]="RED_INTEGER",i[i.RGB_INTEGER=36248]="RGB_INTEGER",i[i.RGBA_INTEGER=36249]="RGBA_INTEGER",i[i.R8=33321]="R8",i[i.RG8=33323]="RG8",i[i.R16F=33325]="R16F",i[i.R32F=33326]="R32F",i[i.RG16F=33327]="RG16F",i[i.RG32F=33328]="RG32F",i[i.R8I=33329]="R8I",i[i.R8UI=33330]="R8UI",i[i.R16I=33331]="R16I",i[i.R16UI=33332]="R16UI",i[i.R32I=33333]="R32I",i[i.R32UI=33334]="R32UI",i[i.RG8I=33335]="RG8I",i[i.RG8UI=33336]="RG8UI",i[i.RG16I=33337]="RG16I",i[i.RG16UI=33338]="RG16UI",i[i.RG32I=33339]="RG32I",i[i.RG32UI=33340]="RG32UI",i[i.R8_SNORM=36756]="R8_SNORM",i[i.RG8_SNORM=36757]="RG8_SNORM",i[i.RGB8_SNORM=36758]="RGB8_SNORM",i[i.RGBA8_SNORM=36759]="RGBA8_SNORM",i[i.RGB10_A2UI=36975]="RGB10_A2UI",i[i.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",i[i.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",i[i.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",i[i.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",i[i.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",i[i.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",i[i.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",i[i.HALF_FLOAT=5131]="HALF_FLOAT",i[i.RG=33319]="RG",i[i.RG_INTEGER=33320]="RG_INTEGER",i[i.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",i[i.CURRENT_QUERY=34917]="CURRENT_QUERY",i[i.QUERY_RESULT=34918]="QUERY_RESULT",i[i.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",i[i.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",i[i.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",i[i.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",i[i.DRAW_BUFFER0=34853]="DRAW_BUFFER0",i[i.DRAW_BUFFER1=34854]="DRAW_BUFFER1",i[i.DRAW_BUFFER2=34855]="DRAW_BUFFER2",i[i.DRAW_BUFFER3=34856]="DRAW_BUFFER3",i[i.DRAW_BUFFER4=34857]="DRAW_BUFFER4",i[i.DRAW_BUFFER5=34858]="DRAW_BUFFER5",i[i.DRAW_BUFFER6=34859]="DRAW_BUFFER6",i[i.DRAW_BUFFER7=34860]="DRAW_BUFFER7",i[i.DRAW_BUFFER8=34861]="DRAW_BUFFER8",i[i.DRAW_BUFFER9=34862]="DRAW_BUFFER9",i[i.DRAW_BUFFER10=34863]="DRAW_BUFFER10",i[i.DRAW_BUFFER11=34864]="DRAW_BUFFER11",i[i.DRAW_BUFFER12=34865]="DRAW_BUFFER12",i[i.DRAW_BUFFER13=34866]="DRAW_BUFFER13",i[i.DRAW_BUFFER14=34867]="DRAW_BUFFER14",i[i.DRAW_BUFFER15=34868]="DRAW_BUFFER15",i[i.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",i[i.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",i[i.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",i[i.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",i[i.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",i[i.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",i[i.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",i[i.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",i[i.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",i[i.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",i[i.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",i[i.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",i[i.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",i[i.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",i[i.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",i[i.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",i[i.SAMPLER_3D=35679]="SAMPLER_3D",i[i.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",i[i.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",i[i.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",i[i.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",i[i.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",i[i.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",i[i.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",i[i.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",i[i.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",i[i.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",i[i.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",i[i.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",i[i.MAX_SAMPLES=36183]="MAX_SAMPLES",i[i.SAMPLER_BINDING=35097]="SAMPLER_BINDING",i[i.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",i[i.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",i[i.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",i[i.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",i[i.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",i[i.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",i[i.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",i[i.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",i[i.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",i[i.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",i[i.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",i[i.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",i[i.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",i[i.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",i[i.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",i[i.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",i[i.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",i[i.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",i[i.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",i[i.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",i[i.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",i[i.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",i[i.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",i[i.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",i[i.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",i[i.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",i[i.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",i[i.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",i[i.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",i[i.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",i[i.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",i[i.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",i[i.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",i[i.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",i[i.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",i[i.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",i[i.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",i[i.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",i[i.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",i[i.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",i[i.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",i[i.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",i[i.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",i[i.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",i[i.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",i[i.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",i[i.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",i[i.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",i[i.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",i[i.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",i[i.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",i[i.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",i[i.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",i[i.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",i[i.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",i[i.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",i[i.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",i[i.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",i[i.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",i[i.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",i[i.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",i[i.UNIFORM_TYPE=35383]="UNIFORM_TYPE",i[i.UNIFORM_SIZE=35384]="UNIFORM_SIZE",i[i.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",i[i.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",i[i.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",i[i.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",i[i.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",i[i.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",i[i.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",i[i.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",i[i.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",i[i.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",i[i.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",i[i.OBJECT_TYPE=37138]="OBJECT_TYPE",i[i.SYNC_CONDITION=37139]="SYNC_CONDITION",i[i.SYNC_STATUS=37140]="SYNC_STATUS",i[i.SYNC_FLAGS=37141]="SYNC_FLAGS",i[i.SYNC_FENCE=37142]="SYNC_FENCE",i[i.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",i[i.UNSIGNALED=37144]="UNSIGNALED",i[i.SIGNALED=37145]="SIGNALED",i[i.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",i[i.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",i[i.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",i[i.WAIT_FAILED=37149]="WAIT_FAILED",i[i.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",i[i.COLOR=6144]="COLOR",i[i.DEPTH=6145]="DEPTH",i[i.STENCIL=6146]="STENCIL",i[i.MIN=32775]="MIN",i[i.MAX=32776]="MAX",i[i.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",i[i.STREAM_READ=35041]="STREAM_READ",i[i.STREAM_COPY=35042]="STREAM_COPY",i[i.STATIC_READ=35045]="STATIC_READ",i[i.STATIC_COPY=35046]="STATIC_COPY",i[i.DYNAMIC_READ=35049]="DYNAMIC_READ",i[i.DYNAMIC_COPY=35050]="DYNAMIC_COPY",i[i.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",i[i.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",i[i.INVALID_INDEX=4294967295]="INVALID_INDEX",i[i.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",i[i.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",i[i.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",i[i.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",i[i.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",i[i.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",i[i.R16_EXT=33322]="R16_EXT",i[i.RG16_EXT=33324]="RG16_EXT",i[i.RGB16_EXT=32852]="RGB16_EXT",i[i.RGBA16_EXT=32859]="RGBA16_EXT",i[i.R16_SNORM_EXT=36760]="R16_SNORM_EXT",i[i.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",i[i.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",i[i.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",i[i.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",i[i.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",i[i.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",i[i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",i[i.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",i[i.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",i[i.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",i[i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",i[i.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",i[i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",i[i.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",i[i.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",i[i.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",i[i.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",i[i.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",i[i.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",i[i.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",i[i.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",i[i.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",i[i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",i[i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",i[i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",i[i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",i[i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",i[i.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",i[i.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",i[i.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",i[i.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",i[i.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",i[i.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",i[i.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",i[i.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",i[i.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",i[i.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",i[i.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",i[i.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",i[i.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",i[i.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",i[i.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",i[i.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",i[i.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",i[i.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",i[i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",i[i.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",i[i.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",i[i.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",i[i.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",i[i.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",i[i.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",i[i.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",i[i.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",i[i.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",i[i.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",i[i.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",i[i.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",i[i.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",i[i.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",i[i.LINE_WEBGL=6913]="LINE_WEBGL",i[i.FILL_WEBGL=6914]="FILL_WEBGL",i[i.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",i[i.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",i[i.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",i[i.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",i[i.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",i[i.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",i[i.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",i[i.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",i[i.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",i[i.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",i[i.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",i[i.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",i[i.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",i[i.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",i[i.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",i[i.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",i[i.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",i[i.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",i[i.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",i[i.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",i[i.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",i[i.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",i[i.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",i[i.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(sc||(sc={}));const bD={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},wD=i=>({drawBuffersWEBGL(e){return i.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),TD=i=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return i.createVertexArray()},deleteVertexArrayOES(e){return i.deleteVertexArray(e)},isVertexArrayOES(e){return i.isVertexArray(e)},bindVertexArrayOES(e){return i.bindVertexArray(e)}}),SD=i=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return i.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return i.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return i.vertexAttribDivisor(...e)}});function ED(i=!0){const e=HTMLCanvasElement.prototype;if(!i&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(t,r){if(t==="webgl"||t==="experimental-webgl"){const o=this.originalGetContext("webgl2",r);return o instanceof HTMLElement&&AD(o),o}return this.originalGetContext(t,r)}}function AD(i){i.getExtension("EXT_color_buffer_float");const e={...bD,WEBGL_disjoint_timer_query:i.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:wD(i),OES_vertex_array_object:TD(i),ANGLE_instanced_arrays:SD(i)},t=i.getExtension;i.getExtension=function(o){const c=t.call(i,o);return c||(o in e?e[o]:null)};const r=i.getSupportedExtensions;i.getSupportedExtensions=function(){return(r.apply(i)||[])?.concat(Object.keys(e))}}async function H1(i,e){const t=document.getElementsByTagName("head")[0];if(!t)throw new Error("loadScript");const r=document.createElement("script");return r.setAttribute("type","text/javascript"),r.setAttribute("src",i),new Promise((o,c)=>{r.onload=o,r.onerror=d=>c(new Error(`Unable to load script '${i}': ${d}`)),t.appendChild(r)})}const PD=1;let mn=null,$b=!1;const ry={debugSpectorJS:dt.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function CD(i){if(!globalThis.SPECTOR)try{await H1(i.debugSpectorJSUrl||ry.debugSpectorJSUrl)}catch(e){dt.warn(String(e))}}function ID(i){if(i={...ry,...i},!i.debugSpectorJS)return null;if(!mn&&globalThis.SPECTOR&&!globalThis.luma?.spector){dt.probe(PD,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:e}=globalThis.SPECTOR;mn=new e,globalThis.luma&&(globalThis.luma.spector=mn)}if(!mn)return null;if($b||($b=!0,mn.spyCanvases(),mn?.onCaptureStarted.add(e=>dt.info("Spector capture started:",e)()),mn?.onCapture.add(e=>{dt.info("Spector capture complete:",e)(),mn?.getResultUI(),mn?.resultView.display(),mn?.resultView.addCapture(e)})),i.gl){const e=i.gl,t=e.device;mn?.startCapture(i.gl,500),e.device=t,new Promise(r=>setTimeout(r,2e3)).then(r=>{dt.info("Spector capture stopped after 2 seconds")(),mn?.stopCapture()})}return mn}const MD="https://unpkg.com/webgl-debug@2.0.1/index.js";function Z1(i){return i.luma=i.luma||{},i.luma}async function RD(){ja()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await H1(MD))}function kD(i,e={}){return e.debugWebGL||e.traceWebGL?OD(i,e):DD(i)}function DD(i){const e=Z1(i);return e.realContext?e.realContext:i}function OD(i,e){if(!globalThis.WebGLDebugUtils)return dt.warn("webgl-debug not loaded")(),i;const t=Z1(i);if(t.debugContext)return t.debugContext;globalThis.WebGLDebugUtils.init({...sc,...i});const r=globalThis.WebGLDebugUtils.makeDebugContext(i,LD.bind(null,e),FD.bind(null,e));for(const d in sc)!(d in r)&&typeof sc[d]=="number"&&(r[d]=sc[d]);class o{}Object.setPrototypeOf(r,Object.getPrototypeOf(i)),Object.setPrototypeOf(o,r);const c=Object.create(o);return t.realContext=i,t.debugContext=c,c.debug=!0,c}function Wb(i,e){e=Array.from(e).map(r=>r===void 0?"undefined":r);let t=globalThis.WebGLDebugUtils.glFunctionArgsToString(i,e);return t=`${t.slice(0,100)}${t.length>100?"...":""}`,`gl.${i}(${t})`}function LD(i,e,t,r){r=Array.from(r).map(a=>a===void 0?"undefined":a);const o=globalThis.WebGLDebugUtils.glEnumToString(e),c=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,r),d=`${o} in gl.${t}(${c})`;dt.error(d)();debugger}function FD(i,e,t){let r="";dt.level>=1&&(r=Wb(e,t),i.traceWebGL&&dt.log(1,r)());for(const o of t)if(o===void 0){r=r||Wb(e,t);debugger}}const uf=1;class BD extends S3{type="webgl";constructor(){super(),La.defaultProps={...La.defaultProps,...ry}}enforceWebGL2(e){ED(e)}isSupported(){return typeof WebGL2RenderingContext<"u"}isDeviceHandle(e){return typeof WebGL2RenderingContext<"u"&&e instanceof WebGL2RenderingContext?!0:(typeof WebGLRenderingContext<"u"&&e instanceof WebGLRenderingContext&&dt.warn("WebGL1 is not supported",e)(),!1)}async attach(e,t={}){const{WebGLDevice:r}=await jb(async()=>{const{WebGLDevice:c}=await Promise.resolve().then(()=>o0);return{WebGLDevice:c}},void 0);if(e instanceof r)return e;if(e?.device instanceof r)return e.device;if(!ND(e))throw new Error("Invalid WebGL2RenderingContext");const o=t.createCanvasContext===!0?{}:t.createCanvasContext;return new r({...t,_handle:e,createCanvasContext:{canvas:e.canvas,autoResize:!1,...o}})}async create(e={}){const{WebGLDevice:t}=await jb(async()=>{const{WebGLDevice:r}=await Promise.resolve().then(()=>o0);return{WebGLDevice:r}},void 0);dt.groupCollapsed(uf,"WebGLDevice created")();try{const r=[];(e.debugWebGL||e.debug)&&r.push(RD()),e.debugSpectorJS&&r.push(CD(e));const o=await Promise.allSettled(r);for(const a of o)a.status==="rejected"&&dt.error(`Failed to initialize debug libraries ${a.reason}`)();const c=new t(e),d=`${c._reused?"Reusing":"Created"} device with WebGL2 ${c.props.debug?"debug ":""}context: ${c.info.vendor}, ${c.info.renderer} for canvas: ${c.canvasContext.id}`;return dt.probe(uf,d)(),dt.table(uf,c.info)(),c}finally{dt.groupEnd(uf)()}}}function ND(i){return typeof WebGL2RenderingContext<"u"&&i instanceof WebGL2RenderingContext?!0:!!(i&&Number.isFinite(i._version))}const pm=new BD,ny={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},lr=(i,e,t)=>e?i.enable(t):i.disable(t),Hb=(i,e,t)=>i.hint(t,e),_n=(i,e,t)=>i.pixelStorei(t,e),Zb=(i,e,t)=>{const r=t===36006?36009:36008;return i.bindFramebuffer(r,e)},Ku=(i,e,t)=>{const o={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[t];i.bindBuffer(o,e)};function gm(i){return Array.isArray(i)||ArrayBuffer.isView(i)&&!(i instanceof DataView)}const zD={3042:lr,32773:(i,e)=>i.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(i,e)=>i.clearColor(...e),3107:(i,e)=>i.colorMask(...e),2884:lr,2885:(i,e)=>i.cullFace(e),2929:lr,2931:(i,e)=>i.clearDepth(e),2932:(i,e)=>i.depthFunc(e),2928:(i,e)=>i.depthRange(...e),2930:(i,e)=>i.depthMask(e),3024:lr,35723:Hb,35725:(i,e)=>i.useProgram(e),36007:(i,e)=>i.bindRenderbuffer(36161,e),36389:(i,e)=>i.bindTransformFeedback?.(36386,e),34229:(i,e)=>i.bindVertexArray(e),36006:Zb,36010:Zb,34964:Ku,36662:Ku,36663:Ku,35053:Ku,35055:Ku,2886:(i,e)=>i.frontFace(e),33170:Hb,2849:(i,e)=>i.lineWidth(e),32823:lr,32824:"polygonOffset",10752:"polygonOffset",35977:lr,32926:lr,32928:lr,32938:"sampleCoverage",32939:"sampleCoverage",3089:lr,3088:(i,e)=>i.scissor(...e),2960:lr,2961:(i,e)=>i.clearStencil(e),2968:(i,e)=>i.stencilMaskSeparate(1028,e),36005:(i,e)=>i.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(i,e)=>i.viewport(...e),34383:lr,10754:lr,12288:lr,12289:lr,12290:lr,12291:lr,12292:lr,12293:lr,12294:lr,12295:lr,3333:_n,3317:_n,37440:_n,37441:_n,37443:_n,3330:_n,3332:_n,3331:_n,3314:_n,32878:_n,3316:_n,3315:_n,32877:_n,framebuffer:(i,e)=>{const t=e&&"handle"in e?e.handle:e;return i.bindFramebuffer(36160,t)},blend:(i,e)=>e?i.enable(3042):i.disable(3042),blendColor:(i,e)=>i.blendColor(...e),blendEquation:(i,e)=>{const t=typeof e=="number"?[e,e]:e;i.blendEquationSeparate(...t)},blendFunc:(i,e)=>{const t=e?.length===2?[...e,...e]:e;i.blendFuncSeparate(...t)},clearColor:(i,e)=>i.clearColor(...e),clearDepth:(i,e)=>i.clearDepth(e),clearStencil:(i,e)=>i.clearStencil(e),colorMask:(i,e)=>i.colorMask(...e),cull:(i,e)=>e?i.enable(2884):i.disable(2884),cullFace:(i,e)=>i.cullFace(e),depthTest:(i,e)=>e?i.enable(2929):i.disable(2929),depthFunc:(i,e)=>i.depthFunc(e),depthMask:(i,e)=>i.depthMask(e),depthRange:(i,e)=>i.depthRange(...e),dither:(i,e)=>e?i.enable(3024):i.disable(3024),derivativeHint:(i,e)=>{i.hint(35723,e)},frontFace:(i,e)=>i.frontFace(e),mipmapHint:(i,e)=>i.hint(33170,e),lineWidth:(i,e)=>i.lineWidth(e),polygonOffsetFill:(i,e)=>e?i.enable(32823):i.disable(32823),polygonOffset:(i,e)=>i.polygonOffset(...e),sampleCoverage:(i,e)=>i.sampleCoverage(e[0],e[1]||!1),scissorTest:(i,e)=>e?i.enable(3089):i.disable(3089),scissor:(i,e)=>i.scissor(...e),stencilTest:(i,e)=>e?i.enable(2960):i.disable(2960),stencilMask:(i,e)=>{e=gm(e)?e:[e,e];const[t,r]=e;i.stencilMaskSeparate(1028,t),i.stencilMaskSeparate(1029,r)},stencilFunc:(i,e)=>{e=gm(e)&&e.length===3?[...e,...e]:e;const[t,r,o,c,d,a]=e;i.stencilFuncSeparate(1028,t,r,o),i.stencilFuncSeparate(1029,c,d,a)},stencilOp:(i,e)=>{e=gm(e)&&e.length===3?[...e,...e]:e;const[t,r,o,c,d,a]=e;i.stencilOpSeparate(1028,t,r,o),i.stencilOpSeparate(1029,c,d,a)},viewport:(i,e)=>i.viewport(...e)};function Hi(i,e,t){return e[i]!==void 0?e[i]:t[i]}const UD={blendEquation:(i,e,t)=>i.blendEquationSeparate(Hi(32777,e,t),Hi(34877,e,t)),blendFunc:(i,e,t)=>i.blendFuncSeparate(Hi(32969,e,t),Hi(32968,e,t),Hi(32971,e,t),Hi(32970,e,t)),polygonOffset:(i,e,t)=>i.polygonOffset(Hi(32824,e,t),Hi(10752,e,t)),sampleCoverage:(i,e,t)=>i.sampleCoverage(Hi(32938,e,t),Hi(32939,e,t)),stencilFuncFront:(i,e,t)=>i.stencilFuncSeparate(1028,Hi(2962,e,t),Hi(2967,e,t),Hi(2963,e,t)),stencilFuncBack:(i,e,t)=>i.stencilFuncSeparate(1029,Hi(34816,e,t),Hi(36003,e,t),Hi(36004,e,t)),stencilOpFront:(i,e,t)=>i.stencilOpSeparate(1028,Hi(2964,e,t),Hi(2965,e,t),Hi(2966,e,t)),stencilOpBack:(i,e,t)=>i.stencilOpSeparate(1029,Hi(34817,e,t),Hi(34818,e,t),Hi(34819,e,t))},qb={enable:(i,e)=>i({[e]:!0}),disable:(i,e)=>i({[e]:!1}),pixelStorei:(i,e,t)=>i({[e]:t}),hint:(i,e,t)=>i({[e]:t}),useProgram:(i,e)=>i({35725:e}),bindRenderbuffer:(i,e,t)=>i({36007:t}),bindTransformFeedback:(i,e,t)=>i({36389:t}),bindVertexArray:(i,e)=>i({34229:e}),bindFramebuffer:(i,e,t)=>{switch(e){case 36160:return i({36006:t,36010:t});case 36009:return i({36006:t});case 36008:return i({36010:t});default:return null}},bindBuffer:(i,e,t)=>{const r={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return r?i({[r]:t}):{valueChanged:!0}},blendColor:(i,e,t,r,o)=>i({32773:new Float32Array([e,t,r,o])}),blendEquation:(i,e)=>i({32777:e,34877:e}),blendEquationSeparate:(i,e,t)=>i({32777:e,34877:t}),blendFunc:(i,e,t)=>i({32969:e,32968:t,32971:e,32970:t}),blendFuncSeparate:(i,e,t,r,o)=>i({32969:e,32968:t,32971:r,32970:o}),clearColor:(i,e,t,r,o)=>i({3106:new Float32Array([e,t,r,o])}),clearDepth:(i,e)=>i({2931:e}),clearStencil:(i,e)=>i({2961:e}),colorMask:(i,e,t,r,o)=>i({3107:[e,t,r,o]}),cullFace:(i,e)=>i({2885:e}),depthFunc:(i,e)=>i({2932:e}),depthRange:(i,e,t)=>i({2928:new Float32Array([e,t])}),depthMask:(i,e)=>i({2930:e}),frontFace:(i,e)=>i({2886:e}),lineWidth:(i,e)=>i({2849:e}),polygonOffset:(i,e,t)=>i({32824:e,10752:t}),sampleCoverage:(i,e,t)=>i({32938:e,32939:t}),scissor:(i,e,t,r,o)=>i({3088:new Int32Array([e,t,r,o])}),stencilMask:(i,e)=>i({2968:e,36005:e}),stencilMaskSeparate:(i,e,t)=>i({[e===1028?2968:36005]:t}),stencilFunc:(i,e,t,r)=>i({2962:e,2967:t,2963:r,34816:e,36003:t,36004:r}),stencilFuncSeparate:(i,e,t,r,o)=>i({[e===1028?2962:34816]:t,[e===1028?2967:36003]:r,[e===1028?2963:36004]:o}),stencilOp:(i,e,t,r)=>i({2964:e,2965:t,2966:r,34817:e,34818:t,34819:r}),stencilOpSeparate:(i,e,t,r,o)=>i({[e===1028?2964:34817]:t,[e===1028?2965:34818]:r,[e===1028?2966:34819]:o}),viewport:(i,e,t,r,o)=>i({2978:[e,t,r,o]})},ys=(i,e)=>i.isEnabled(e),Xb={3042:ys,2884:ys,2929:ys,3024:ys,32823:ys,32926:ys,32928:ys,3089:ys,2960:ys,35977:ys},VD=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function Ec(i,e){if($D(e))return;const t={};for(const o in e){const c=Number(o),d=zD[o];d&&(typeof d=="string"?t[d]=!0:d(i,e[o],c))}const r=i.state&&i.state.cache;if(r)for(const o in t){const c=UD[o];c(i,e,r)}}function q1(i,e=ny){if(typeof e=="number"){const o=e,c=Xb[o];return c?c(i,o):i.getParameter(o)}const t=Array.isArray(e)?e:Object.keys(e),r={};for(const o of t){const c=Xb[o];r[o]=c?c(i,Number(o)):i.getParameter(Number(o))}return r}function jD(i){Ec(i,ny)}function $D(i){for(const e in i)return!1;return!0}function WD(i,e){if(i===e)return!0;if(Gb(i)&&Gb(e)&&i.length===e.length){for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}return!1}function Gb(i){return Array.isArray(i)||ArrayBuffer.isView(i)}class Da{static get(e){return e.state}gl;program=null;stateStack=[];enable=!0;cache=null;log;initialized=!1;constructor(e,t){this.gl=e,this.log=t?.log||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];Ec(this.gl,e),this.stateStack.pop()}trackState(e,t){if(this.cache=t?.copyState?q1(e):Object.assign({},ny),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,ZD(e);for(const r in qb){const o=qb[r];HD(e,r,o)}Yb(e,"getParameter"),Yb(e,"isEnabled")}_updateCache(e){let t=!1,r;const o=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const c in e){const d=e[c],a=this.cache[c];WD(d,a)||(t=!0,r=a,o&&!(c in o)&&(o[c]=a),this.cache[c]=d)}return{valueChanged:t,oldValue:r}}}function Yb(i,e){const t=i[e].bind(i);i[e]=function(o){if(o===void 0||VD.has(o))return t(o);const c=Da.get(i);return o in c.cache||(c.cache[o]=t(o)),c.enable?c.cache[o]:t(o)},Object.defineProperty(i[e],"name",{value:`${e}-from-cache`,configurable:!1})}function HD(i,e,t){if(!i[e])return;const r=i[e].bind(i);i[e]=function(...c){const d=Da.get(i),{valueChanged:a,oldValue:y}=t(d._updateCache,...c);return a&&r(...c),y},Object.defineProperty(i[e],"name",{value:`${e}-to-cache`,configurable:!1})}function ZD(i){const e=i.useProgram.bind(i);i.useProgram=function(r){const o=Da.get(i);o.program!==r&&(e(r),o.program=r)}}function qD(i,e,t){let r="";const o={preserveDrawingBuffer:!0,...t};let c=null;if(c||=i.getContext("webgl2",o),o.failIfMajorPerformanceCaveat&&(r||="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow."),!c&&!t.failIfMajorPerformanceCaveat&&(o.failIfMajorPerformanceCaveat=!1,c=i.getContext("webgl2",o),c.luma||={},c.luma.softwareRenderer=!0),c||(c=i.getContext("webgl",{}),c&&(c=null,r||="Your browser only supports WebGL1")),!c)throw r||="Your browser does not support WebGL",new Error(`Failed to create WebGL context: ${r}`);const{onContextLost:d,onContextRestored:a}=e;return i.addEventListener("webglcontextlost",y=>d(y),!1),i.addEventListener("webglcontextrestored",y=>a(y),!1),c.luma||={},c}function wc(i,e,t){return t[e]===void 0&&(t[e]=i.getExtension(e)||null),t[e]}function XD(i,e){const t=i.getParameter(7936),r=i.getParameter(7937);wc(i,"WEBGL_debug_renderer_info",e);const o=e.WEBGL_debug_renderer_info,c=i.getParameter(o?o.UNMASKED_VENDOR_WEBGL:7936),d=i.getParameter(o?o.UNMASKED_RENDERER_WEBGL:7937),a=c||t,y=d||r,w=i.getParameter(7938),E=X1(a,y),I=GD(a,y),D=YD(a,y);return{type:"webgl",gpu:E,gpuType:D,gpuBackend:I,vendor:a,renderer:y,version:w,shadingLanguage:"glsl",shadingLanguageVersion:300}}function X1(i,e){return/NVIDIA/i.exec(i)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(i)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(i)||/Apple/i.exec(e)?"apple":/AMD/i.exec(i)||/AMD/i.exec(e)||/ATI/i.exec(i)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(i)||/SwiftShader/i.exec(e)?"software":"unknown"}function GD(i,e){return/Metal/i.exec(i)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(i)||/ANGLE/i.exec(e)?"opengl":"unknown"}function YD(i,e){if(/SwiftShader/i.exec(i)||/SwiftShader/i.exec(e))return"cpu";switch(X1(i,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function G1(i){switch(i){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(i))}const sh="WEBGL_compressed_texture_s3tc",oh="WEBGL_compressed_texture_s3tc_srgb",oc="EXT_texture_compression_rgtc",ac="EXT_texture_compression_bptc",KD="WEBGL_compressed_texture_etc",JD="WEBGL_compressed_texture_astc",QD="WEBGL_compressed_texture_etc1",eO="WEBGL_compressed_texture_pvrtc",tO="WEBGL_compressed_texture_atc",Kb="EXT_texture_norm16",Jb="EXT_render_snorm",iO="EXT_color_buffer_float",sy={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[Jb],"norm16-renderable-webgl":[Kb],"snorm16-renderable-webgl":[Kb,Jb],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[sh,oh,oc,ac],"texture-compression-bc5-webgl":[oc],"texture-compression-bc7-webgl":[ac],"texture-compression-etc2":[KD],"texture-compression-astc":[JD],"texture-compression-etc1-webgl":[QD],"texture-compression-pvrtc-webgl":[eO],"texture-compression-atc-webgl":[tO]};function rO(i){return i in sy}function nO(i,e,t){return(sy[e]||[]).every(o=>wc(i,o,t))}const oy={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},r16unorm:{gl:33322,rb:!0},r16snorm:{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},rg16unorm:{gl:33324},rg16snorm:{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},rgb10a2uint:{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},rgba16unorm:{gl:32859,rb:!0},rgba16snorm:{gl:36763},"rgb32float-webgl":{gl:34837,x:iO,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:sh},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:oh},"bc1-rgba-unorm":{gl:33777,x:sh},"bc1-rgba-unorm-srgb":{gl:35916,x:oh},"bc2-rgba-unorm":{gl:33778,x:sh},"bc2-rgba-unorm-srgb":{gl:35918,x:oh},"bc3-rgba-unorm":{gl:33779,x:sh},"bc3-rgba-unorm-srgb":{gl:35919,x:oh},"bc4-r-unorm":{gl:36283,x:oc},"bc4-r-snorm":{gl:36284,x:oc},"bc5-rg-unorm":{gl:36285,x:oc},"bc5-rg-snorm":{gl:36286,x:oc},"bc6h-rgb-ufloat":{gl:36495,x:ac},"bc6h-rgb-float":{gl:36494,x:ac},"bc7-rgba-unorm":{gl:36492,x:ac},"bc7-rgba-unorm-srgb":{gl:36493,x:ac},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function sO(i,e,t){let r=e.create;const o=oy[e.format];return o?.gl===void 0&&(r=!1),o?.x&&(r=r&&!!wc(i,o.x,t)),{format:e.format,create:r&&e.create,render:r&&e.render,filter:r&&e.filter,blend:r&&e.blend,store:r&&e.store}}function Y1(i){const e=oy[i],t=lO(i),r=uc.getInfo(i);return r.compressed&&(e.dataFormat=t),{internalFormat:t,format:e?.dataFormat||aO(r.channels,r.integer,r.normalized,t),type:r.dataType?G1(r.dataType):e?.types?.[0]||5121,compressed:r.compressed||!1}}function oO(i){switch(uc.getInfo(i).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${i}`)}}function aO(i,e,t,r){if(r===6408||r===6407)return r;switch(i){case"r":return e&&!t?36244:6403;case"rg":return e&&!t?33320:33319;case"rgb":return e&&!t?36248:6407;case"rgba":return e&&!t?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function lO(i){const t=oy[i]?.gl;if(t===void 0)throw new Error(`Unsupported texture format ${i}`);return t}const Qb={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class cO extends w3{gl;extensions;testedFeatures=new Set;constructor(e,t,r){super([],r),this.gl=e,this.extensions=t,wc(e,"EXT_color_buffer_float",t)}*[Symbol.iterator](){const e=this.getFeatures();for(const t of e)this.has(t)&&(yield t);return[]}has(e){return this.disabledFeatures?.[e]?!1:(this.testedFeatures.has(e)||(this.testedFeatures.add(e),rO(e)&&nO(this.gl,e,this.extensions)&&this.features.add(e),this.getWebGLFeature(e)&&this.features.add(e)),this.features.has(e))}initializeFeatures(){const e=this.getFeatures().filter(t=>t!=="polygon-mode-webgl");for(const t of e)this.has(t)}getFeatures(){return[...Object.keys(Qb),...Object.keys(sy)]}getWebGLFeature(e){const t=Qb[e];return typeof t=="string"?!!wc(this.gl,t,this.extensions):!!t}}class uO extends b3{get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderVariables(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}gl;limits={};constructor(e){super(),this.gl=e}getParameter(e){return this.limits[e]===void 0&&(this.limits[e]=this.gl.getParameter(e)),this.limits[e]||0}}class fh extends mp{device;gl;handle;colorAttachments=[];depthStencilAttachment=null;constructor(e,t){super(e,t);const r=t.handle===null;this.device=e,this.gl=e.gl,this.handle=this.props.handle||r?this.props.handle:this.gl.createFramebuffer(),r||(e._setWebGLDebugMetadata(this.handle,this,{spector:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const e=this.gl.bindFramebuffer(36160,this.handle);for(let t=0;t<this.colorAttachments.length;++t){const r=this.colorAttachments[t];if(r){const o=36064+t;this._attachTextureView(o,r)}}if(this.depthStencilAttachment){const t=oO(this.depthStencilAttachment.props.format);this._attachTextureView(t,this.depthStencilAttachment)}if(this.device.props.debug){const t=this.gl.checkFramebufferStatus(36160);if(t!==36053)throw new Error(`Framebuffer ${dO(t)}`)}this.gl.bindFramebuffer(36160,e)}_attachTextureView(e,t){const{gl:r}=this.device,{texture:o}=t,c=t.props.baseMipLevel,d=t.props.baseArrayLayer;switch(r.bindTexture(o.glTarget,o.handle),o.glTarget){case 35866:case 32879:r.framebufferTextureLayer(36160,e,o.handle,c,d);break;case 34067:const a=hO(d);r.framebufferTexture2D(36160,e,a,o.handle,c);break;case 3553:r.framebufferTexture2D(36160,e,3553,o.handle,c);break;default:throw new Error("Illegal texture type")}r.bindTexture(o.glTarget,null)}}function hO(i){return i<34069?i+34069:i}function dO(i){switch(i){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${i}`}}class fO extends Ca{device;handle=null;_framebuffer=null;get[Symbol.toStringTag](){return"WebGLCanvasContext"}constructor(e,t){super(t),this.device=e,this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this._updateDevice()}getCurrentFramebuffer(){return this._framebuffer=this._framebuffer||new fh(this.device,{handle:null}),this._framebuffer}_updateDevice(){}}const mm={};function pO(i="id"){mm[i]=mm[i]||1;const e=mm[i]++;return`${i}-${e}`}class ph extends Mi{device;gl;handle;glTarget;glUsage;glIndexType=5123;byteLength=0;bytesUsed=0;constructor(e,t={}){super(e,t),this.device=e,this.gl=this.device.gl;const r=typeof t=="object"?t.handle:void 0;this.handle=r||this.gl.createBuffer(),e._setWebGLDebugMetadata(this.handle,this,{spector:{...this.props,data:typeof this.props.data}}),this.glTarget=gO(this.props.usage),this.glUsage=mO(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,t.data?this._initWithData(t.data,t.byteOffset,t.byteLength):this._initWithByteLength(t.byteLength||0)}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}_initWithData(e,t=0,r=e.byteLength+t){const o=this.glTarget;this.gl.bindBuffer(o,this.handle),this.gl.bufferData(o,r,this.glUsage),this.gl.bufferSubData(o,t,e),this.gl.bindBuffer(o,null),this.bytesUsed=r,this.byteLength=r,this._setDebugData(e,t,r),this.trackAllocatedMemory(r)}_initWithByteLength(e){let t=e;e===0&&(t=new Float32Array(0));const r=this.glTarget;return this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,t,this.glUsage),this.gl.bindBuffer(r,null),this.bytesUsed=e,this.byteLength=e,this._setDebugData(null,0,e),this.trackAllocatedMemory(e),this}write(e,t=0){const r=ArrayBuffer.isView(e)?e:new Uint8Array(e),o=36663;this.gl.bindBuffer(o,this.handle),this.gl.bufferSubData(o,t,r),this.gl.bindBuffer(o,null),this._setDebugData(e,t,e.byteLength)}async mapAndWriteAsync(e,t=0,r=this.byteLength-t){const o=new ArrayBuffer(r);await e(o,"copied"),this.write(o,t)}async readAsync(e=0,t){return this.readSyncWebGL(e,t)}async mapAndReadAsync(e,t=0,r){const o=await this.readAsync(t,r);return await e(o.buffer,"copied")}readSyncWebGL(e=0,t){t=t??this.byteLength-e;const r=new Uint8Array(t),o=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,r,o,t),this.gl.bindBuffer(36662,null),this._setDebugData(r,e,t),r}}function gO(i){return i&Mi.INDEX?34963:i&Mi.VERTEX?34962:i&Mi.UNIFORM?35345:34962}function mO(i){return i&Mi.INDEX||i&Mi.VERTEX?35044:i&Mi.UNIFORM?35048:35044}function _O(i){const e=i.split(/\r?\n/),t=[];for(const r of e){if(r.length<=1)continue;const o=r.split(":");if(o.length===2){const[I,D]=o;t.push({message:D.trim(),type:e0(I),lineNum:0,linePos:0});continue}const[c,d,a,...y]=o;let w=parseInt(a,10);isNaN(w)&&(w=0);let E=parseInt(d,10);isNaN(E)&&(E=0),t.push({message:y.join(":").trim(),type:e0(c),lineNum:w,linePos:E})}return t}function e0(i){const e=["warning","error","info"],t=i.toLowerCase();return e.includes(t)?t:"info"}class yO extends gp{device;handle;constructor(e,t){switch(super(e,t),this.device=e,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}e._setWebGLDebugMetadata(this.handle,this,{spector:this.props}),this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0,this.handle.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>(this._getCompilationStatus(),this.compilationStatus))}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const e=this.device.gl.getShaderInfoLog(this.handle);return e?_O(e):[]}getTranslatedSource(){return this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders?.getTranslatedShaderSource(this.handle)||null}async _compile(e){e=e.startsWith("#version ")?e:`#version 300 es
${e}`;const{gl:t}=this.device;if(t.shaderSource(this.handle,e),t.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}dt.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),dt.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const e=async o=>await new Promise(c=>setTimeout(c,o));if(!this.device.features.has("compilation-status-async-webgl")){await e(10);return}const{gl:r}=this.device;for(;;){if(r.getShaderParameter(this.handle,37297))return;await e(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function xO(i,e,t,r){if(TO(e))return r(i);const o=i;o.pushState();try{return vO(i,e),Ec(o.gl,t),r(i)}finally{o.popState()}}function vO(i,e){const t=i,{gl:r}=t;if(e.cullMode)switch(e.cullMode){case"none":r.disable(2884);break;case"front":r.enable(2884),r.cullFace(1028);break;case"back":r.enable(2884),r.cullFace(1029);break}if(e.frontFace&&r.frontFace(Oa("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&i.features.has("depth-clip-control")&&r.enable(34383),e.depthBias!==void 0&&(r.enable(32823),r.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&i.features.has("provoking-vertex-webgl")){const c=t.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,d=Oa("provokingVertex",e.provokingVertex,{first:36429,last:36430});c?.provokingVertexWEBGL(d)}if((e.polygonMode||e.polygonOffsetLine)&&i.features.has("polygon-mode-webgl")){if(e.polygonMode){const c=t.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,d=Oa("polygonMode",e.polygonMode,{fill:6914,line:6913});c?.polygonModeWEBGL(1028,d),c?.polygonModeWEBGL(1029,d)}e.polygonOffsetLine&&r.enable(10754)}if(i.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&r.enable(12288),e.clipDistance1&&r.enable(12289),e.clipDistance2&&r.enable(12290),e.clipDistance3&&r.enable(12291),e.clipDistance4&&r.enable(12292),e.clipDistance5&&r.enable(12293),e.clipDistance6&&r.enable(12294),e.clipDistance7&&r.enable(12295)),e.depthWriteEnabled!==void 0&&r.depthMask(wO("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?r.enable(2929):r.disable(2929),r.depthFunc(a_("depthCompare",e.depthCompare))),e.stencilWriteMask){const o=e.stencilWriteMask;r.stencilMaskSeparate(1028,o),r.stencilMaskSeparate(1029,o)}if(e.stencilReadMask&&dt.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const o=e.stencilReadMask||4294967295,c=a_("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?r.enable(2960):r.disable(2960),r.stencilFuncSeparate(1028,c,0,o),r.stencilFuncSeparate(1029,c,0,o)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const o=_m("stencilPassOperation",e.stencilPassOperation),c=_m("stencilFailOperation",e.stencilFailOperation),d=_m("stencilDepthFailOperation",e.stencilDepthFailOperation);r.stencilOpSeparate(1028,c,d,o),r.stencilOpSeparate(1029,c,d,o)}switch(e.blend){case!0:r.enable(3042);break;case!1:r.disable(3042);break}if(e.blendColorOperation||e.blendAlphaOperation){const o=t0("blendColorOperation",e.blendColorOperation||"add"),c=t0("blendAlphaOperation",e.blendAlphaOperation||"add");r.blendEquationSeparate(o,c);const d=hf("blendColorSrcFactor",e.blendColorSrcFactor||"one"),a=hf("blendColorDstFactor",e.blendColorDstFactor||"zero"),y=hf("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),w=hf("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");r.blendFuncSeparate(d,a,y,w)}}function a_(i,e){return Oa(i,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function _m(i,e){return Oa(i,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function t0(i,e){return Oa(i,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function hf(i,e,t="color"){return Oa(i,e,{one:1,zero:0,src:768,"one-minus-src":769,dst:774,"one-minus-dst":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,constant:t==="color"?32769:32771,"one-minus-constant":t==="color"?32770:32772,src1:768,"one-minus-src1":769,"src1-alpha":770,"one-minus-src1-alpha":771})}function bO(i,e){return`Illegal parameter ${e} for ${i}`}function Oa(i,e,t){if(!(e in t))throw new Error(bO(i,e));return t[e]}function wO(i,e){return e}function TO(i){let e=!0;for(const t in i){e=!1;break}return e}function K1(i){const e={};return i.addressModeU&&(e[10242]=ym(i.addressModeU)),i.addressModeV&&(e[10243]=ym(i.addressModeV)),i.addressModeW&&(e[32882]=ym(i.addressModeW)),i.magFilter&&(e[10240]=l_(i.magFilter)),(i.minFilter||i.mipmapFilter)&&(e[10241]=SO(i.minFilter||"linear",i.mipmapFilter)),i.lodMinClamp!==void 0&&(e[33082]=i.lodMinClamp),i.lodMaxClamp!==void 0&&(e[33083]=i.lodMaxClamp),i.type==="comparison-sampler"&&(e[34892]=34894),i.compare&&(e[34893]=a_("compare",i.compare)),i.maxAnisotropy&&(e[34046]=i.maxAnisotropy),e}function ym(i){switch(i){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function l_(i){switch(i){case"nearest":return 9728;case"linear":return 9729}}function SO(i,e="none"){if(!e)return l_(i);switch(e){case"none":return l_(i);case"nearest":switch(i){case"nearest":return 9984;case"linear":return 9985}break;case"linear":switch(i){case"nearest":return 9986;case"linear":return 9987}}}class EO extends Fa{device;handle;parameters;constructor(e,t){super(e,t),this.device=e,this.parameters=K1(t),this.handle=t.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(e){for(const[t,r]of Object.entries(e)){const o=Number(t);switch(o){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,o,r);break;default:this.device.gl.samplerParameteri(this.handle,o,r);break}}}}function Th(i,e,t){if(AO(e))return t(i);const{nocatch:r=!0}=e,o=Da.get(i);o.push(),Ec(i,e);let c;if(r)c=t(i),o.pop();else try{c=t(i)}finally{o.pop()}return c}function AO(i){for(const e in i)return!1;return!0}class lc extends pp{device;gl;handle;texture;constructor(e,t){super(e,{...xr.defaultProps,...t}),this.device=e,this.gl=this.device.gl,this.handle=null,this.texture=t.texture}}class gh extends xr{device;gl;handle;sampler=void 0;view;glTarget;glFormat;glType;glInternalFormat;compressed;_textureUnit=0;constructor(e,t){super(e,t),this.device=e,this.gl=this.device.gl;const r=Y1(this.props.format);this.glTarget=PO(this.props.dimension),this.glInternalFormat=r.internalFormat,this.glFormat=r.format,this.glType=r.type,this.compressed=r.compressed,this.handle=this.props.handle||this.gl.createTexture(),this.device._setWebGLDebugMetadata(this.handle,this,{spector:this.props}),this.gl.bindTexture(this.glTarget,this.handle);const{dimension:o,width:c,height:d,depth:a,mipLevels:y,glTarget:w,glInternalFormat:E}=this;switch(o){case"2d":case"cube":this.gl.texStorage2D(w,y,E,c,d);break;case"2d-array":case"3d":this.gl.texStorage3D(w,y,E,c,d,a);break;default:throw new Error(o)}this.gl.bindTexture(this.glTarget,null),this._initializeData(t.data),this.setSampler(this.props.sampler),this.view=new lc(this.device,{...this.props,texture:this}),Object.seal(this)}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(e){return new lc(this.device,{...e,texture:this})}setSampler(e={}){super.setSampler(e);const t=K1(this.sampler.props);this._setSamplerParameters(t)}copyImageData(e){const t=this._normalizeCopyImageDataOptions(e),r=t.data,{width:o,height:c,depth:d}=this,{mipLevel:a=0,byteOffset:y=0,x:w=0,y:E=0,z:I=0}=t,{glFormat:D,glType:F,compressed:X}=this,oe=i0(this.glTarget,this.dimension,I);let _e;if(!this.compressed){const{bytesPerPixel:fe}=this.device.getTextureFormatInfo(this.format);if(fe){if(t.bytesPerRow%fe!==0)throw new Error(`bytesPerRow (${t.bytesPerRow}) must be a multiple of bytesPerPixel (${fe}) for ${this.format}`);_e=t.bytesPerRow/fe}}const ge=this.compressed?{}:{..._e!==void 0?{3314:_e}:{},32878:t.rowsPerImage};this.gl.bindTexture(oe,this.handle),Th(this.gl,ge,()=>{switch(this.dimension){case"2d":case"cube":X?this.gl.compressedTexSubImage2D(oe,a,w,E,o,c,D,r,y):this.gl.texSubImage2D(oe,a,w,E,o,c,D,F,r,y);break;case"2d-array":case"3d":X?this.gl.compressedTexSubImage3D(oe,a,w,E,I,o,c,d,D,r,y):this.gl.texSubImage3D(oe,a,w,E,I,o,c,d,D,F,r,y);break;default:}}),this.gl.bindTexture(oe,null)}copyExternalImage(e){const t=this._normalizeCopyExternalImageOptions(e);if(t.sourceX||t.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");const{glFormat:r,glType:o}=this,{image:c,depth:d,mipLevel:a,x:y,y:w,z:E,width:I,height:D}=t,F=i0(this.glTarget,this.dimension,d),X=t.flipY?{37440:!0}:{};return this.gl.bindTexture(this.glTarget,this.handle),Th(this.gl,X,()=>{switch(this.dimension){case"2d":case"cube":this.gl.texSubImage2D(F,a,y,w,I,D,r,o,c);break;case"2d-array":case"3d":this.gl.texSubImage3D(F,a,y,w,E,I,D,d,r,o,c);break;default:}}),this.gl.bindTexture(this.glTarget,null),{width:t.width,height:t.height}}generateMipmapsWebGL(e){if(!(!(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format))&&(dt.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),!e?.force)))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(r){dt.warn(`Error generating mipmap for ${this}: ${r.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}_setSamplerParameters(e){dt.log(2,`${this.id} sampler parameters`,this.device.getGLKeys(e))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[t,r]of Object.entries(e)){const o=Number(t),c=r;switch(o){case 33082:case 33083:this.gl.texParameterf(this.glTarget,o,c);break;case 10240:case 10241:this.gl.texParameteri(this.glTarget,o,c);break;case 10242:case 10243:case 32882:this.gl.texParameteri(this.glTarget,o,c);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,o,c);break;case 34892:case 34893:this.gl.texParameteri(this.glTarget,o,c);break}}this.gl.bindTexture(this.glTarget,null)}_getActiveUnit(){return this.gl.getParameter(34016)-33984}_bind(e){const{gl:t}=this;return e!==void 0&&(this._textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,this.handle),e}_unbind(e){const{gl:t}=this;return e!==void 0&&(this._textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,null),e}}function PO(i){switch(i){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(i)}function i0(i,e,t){return e==="cube"?34069+t:i}function CO(i){return kO[i]}function ay(i){return RO[i]}function IO(i){return!!J1[i]}function MO(i){return J1[i]}const RO={5126:"f32",35664:"vec2<f32>",35665:"vec3<f32>",35666:"vec4<f32>",5124:"i32",35667:"vec2<i32>",35668:"vec3<i32>",35669:"vec4<i32>",5125:"u32",36294:"vec2<u32>",36295:"vec3<u32>",36296:"vec4<u32>",35670:"f32",35671:"vec2<f32>",35672:"vec3<f32>",35673:"vec4<f32>",35674:"mat2x2<f32>",35685:"mat2x3<f32>",35686:"mat2x4<f32>",35687:"mat3x2<f32>",35675:"mat3x3<f32>",35688:"mat3x4<f32>",35689:"mat4x2<f32>",35690:"mat4x3<f32>",35676:"mat4x4<f32>"},J1={35678:{viewDimension:"2d",sampleType:"float"},35680:{viewDimension:"cube",sampleType:"float"},35679:{viewDimension:"3d",sampleType:"float"},35682:{viewDimension:"3d",sampleType:"depth"},36289:{viewDimension:"2d-array",sampleType:"float"},36292:{viewDimension:"2d-array",sampleType:"depth"},36293:{viewDimension:"cube",sampleType:"float"},36298:{viewDimension:"2d",sampleType:"sint"},36299:{viewDimension:"3d",sampleType:"sint"},36300:{viewDimension:"cube",sampleType:"sint"},36303:{viewDimension:"2d-array",sampleType:"uint"},36306:{viewDimension:"2d",sampleType:"uint"},36307:{viewDimension:"3d",sampleType:"uint"},36308:{viewDimension:"cube",sampleType:"uint"},36311:{viewDimension:"2d-array",sampleType:"uint"}},kO={uint8:5121,sint8:5120,unorm8:5121,snorm8:5120,uint16:5123,sint16:5122,unorm16:5123,snorm16:5122,uint32:5125,sint32:5124,float16:5131,float32:5126};function DO(i,e){const t={attributes:[],bindings:[]};t.attributes=OO(i,e);const r=BO(i,e);for(const a of r){const y=a.uniforms.map(w=>({name:w.name,format:w.format,byteOffset:w.byteOffset,byteStride:w.byteStride,arrayLength:w.arrayLength}));t.bindings.push({type:"uniform",name:a.name,group:0,location:a.location,visibility:(a.vertex?1:0)&(a.fragment?2:0),minBindingSize:a.byteLength,uniforms:y})}const o=FO(i,e);let c=0;for(const a of o)if(IO(a.type)){const{viewDimension:y,sampleType:w}=MO(a.type);t.bindings.push({type:"texture",name:a.name,group:0,location:c,viewDimension:y,sampleType:w}),a.textureUnit=c,c+=1}o.length&&(t.uniforms=o);const d=LO(i,e);return d?.length&&(t.varyings=d),t}function OO(i,e){const t=[],r=i.getProgramParameter(e,35721);for(let o=0;o<r;o++){const c=i.getActiveAttrib(e,o);if(!c)throw new Error("activeInfo");const{name:d,type:a}=c,y=i.getAttribLocation(e,d);if(y>=0){const w=ay(a),E=/instance/i.test(d)?"instance":"vertex";t.push({name:d,location:y,stepMode:E,type:w})}}return t.sort((o,c)=>o.location-c.location),t}function LO(i,e){const t=[],r=i.getProgramParameter(e,35971);for(let o=0;o<r;o++){const c=i.getTransformFeedbackVarying(e,o);if(!c)throw new Error("activeInfo");const{name:d,type:a,size:y}=c,w=ay(a),{type:E,components:I}=zw(w);t.push({location:o,name:d,type:E,size:y*I})}return t.sort((o,c)=>o.location-c.location),t}function FO(i,e){const t=[],r=i.getProgramParameter(e,35718);for(let o=0;o<r;o++){const c=i.getActiveUniform(e,o);if(!c)throw new Error("activeInfo");const{name:d,size:a,type:y}=c,{name:w,isArray:E}=NO(d);let I=i.getUniformLocation(e,w);const D={location:I,name:w,size:a,type:y,isArray:E};if(t.push(D),D.size>1)for(let F=0;F<D.size;F++){const X=`${w}[${F}]`;I=i.getUniformLocation(e,X);const oe={...D,name:X,location:I};t.push(oe)}}return t}function BO(i,e){const t=(c,d)=>i.getActiveUniformBlockParameter(e,c,d),r=[],o=i.getProgramParameter(e,35382);for(let c=0;c<o;c++){const d={name:i.getActiveUniformBlockName(e,c)||"",location:t(c,35391),byteLength:t(c,35392),vertex:t(c,35396),fragment:t(c,35398),uniformCount:t(c,35394),uniforms:[]},a=t(c,35395)||[],y=i.getActiveUniforms(e,a,35383),w=i.getActiveUniforms(e,a,35384),E=i.getActiveUniforms(e,a,35387),I=i.getActiveUniforms(e,a,35388);for(let D=0;D<d.uniformCount;++D){const F=i.getActiveUniform(e,a[D]);if(!F)throw new Error("activeInfo");const X=ay(y[D]);d.uniforms.push({name:F.name,format:X,type:y[D],arrayLength:w[D],byteOffset:E[D],byteStride:I[D]})}r.push(d)}return r.sort((c,d)=>c.location-d.location),r}function NO(i){if(i[i.length-1]!=="]")return{name:i,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(i);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${i}`);return{name:t[1],length:t[2]?1:0,isArray:!!t[2]}}function zO(i,e,t,r){const o=i;let c=r;c===!0&&(c=1),c===!1&&(c=0);const d=typeof c=="number"?[c]:c;switch(t){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof r!="number")throw new Error("samplers must be set to integers");return i.uniform1i(e,r);case 5126:return i.uniform1fv(e,d);case 35664:return i.uniform2fv(e,d);case 35665:return i.uniform3fv(e,d);case 35666:return i.uniform4fv(e,d);case 5124:return i.uniform1iv(e,d);case 35667:return i.uniform2iv(e,d);case 35668:return i.uniform3iv(e,d);case 35669:return i.uniform4iv(e,d);case 35670:return i.uniform1iv(e,d);case 35671:return i.uniform2iv(e,d);case 35672:return i.uniform3iv(e,d);case 35673:return i.uniform4iv(e,d);case 5125:return o.uniform1uiv(e,d,1);case 36294:return o.uniform2uiv(e,d,2);case 36295:return o.uniform3uiv(e,d,3);case 36296:return o.uniform4uiv(e,d,4);case 35674:return i.uniformMatrix2fv(e,!1,d);case 35675:return i.uniformMatrix3fv(e,!1,d);case 35676:return i.uniformMatrix4fv(e,!1,d);case 35685:return o.uniformMatrix2x3fv(e,!1,d);case 35686:return o.uniformMatrix2x4fv(e,!1,d);case 35687:return o.uniformMatrix3x2fv(e,!1,d);case 35688:return o.uniformMatrix3x4fv(e,!1,d);case 35689:return o.uniformMatrix4x2fv(e,!1,d);case 35690:return o.uniformMatrix4x3fv(e,!1,d)}throw new Error("Illegal uniform")}function UO(i){switch(i){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(i)}}function VO(i){switch(i){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(i)}}const r0=4;class jO extends Ra{device;handle;vs;fs;introspectedLayout;uniforms={};bindings={};varyings=null;_uniformCount=0;_uniformSetters={};get[Symbol.toStringTag](){return"WEBGLRenderPipeline"}constructor(e,t){super(e,t),this.device=e,this.handle=this.props.handle||this.device.gl.createProgram(),this.device._setWebGLDebugMetadata(this.handle,this,{spector:{id:this.props.id}}),this.vs=t.vs,this.fs=t.fs;const{varyings:r,bufferMode:o=35981}=t;r&&r.length>0&&(this.varyings=r,this.device.gl.transformFeedbackVaryings(this.handle,r,o)),this._linkShaders(),dt.time(3,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=DO(this.device.gl,this.handle),dt.timeEnd(3,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=t.shaderLayout?$O(this.introspectedLayout,t.shaderLayout):this.introspectedLayout}destroy(){this.handle&&(this.device.gl.useProgram(null),this.device.gl.deleteProgram(this.handle),this.destroyed=!0,this.handle.destroyed=!0,this.handle=null)}setBindings(e,t){for(const[r,o]of Object.entries(e)){const c=this.shaderLayout.bindings.find(d=>d.name===r)||this.shaderLayout.bindings.find(d=>d.name===`${r}Uniforms`);if(!c){const d=this.shaderLayout.bindings.map(a=>`"${a.name}"`).join(", ");t?.disableWarnings||dt.warn(`No binding "${r}" in render pipeline "${this.id}", expected one of ${d}`,o)();continue}switch(o||dt.warn(`Unsetting binding "${r}" in render pipeline "${this.id}"`)(),c.type){case"uniform":if(!(o instanceof ph)&&!(o.buffer instanceof ph))throw new Error("buffer value");break;case"texture":if(!(o instanceof lc||o instanceof gh||o instanceof fh))throw new Error(`${this} Bad texture binding for ${r}`);break;case"sampler":dt.warn(`Ignoring sampler ${r}`)();break;default:throw new Error(c.type)}this.bindings[r]=o}}draw(e){const{renderPass:t,parameters:r=this.props.parameters,topology:o=this.props.topology,vertexArray:c,vertexCount:d,instanceCount:a,isInstanced:y=!1,firstVertex:w=0,transformFeedback:E}=e,I=UO(o),D=!!c.indexBuffer,F=c.indexBuffer?.glIndexType;if(this.linkStatus!=="success")return dt.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return dt.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),c.bindBeforeRender(t),E&&E.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const X=t;return xO(this.device,r,X.glParameters,()=>{D&&y?this.device.gl.drawElementsInstanced(I,d||0,F,w,a||0):D?this.device.gl.drawElements(I,d||0,F,w):y?this.device.gl.drawArraysInstanced(I,w,d||0,a||0):this.device.gl.drawArrays(I,w,d||0),E&&E.end()}),c.unbindAfterRender(t),!0}async _linkShaders(){const{gl:e}=this.device;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),dt.time(r0,`linkProgram for ${this.id}`)(),e.linkProgram(this.handle),dt.timeEnd(r0,`linkProgram for ${this.id}`)(),dt.level,!this.device.features.has("compilation-status-async-webgl")){const r=this._getLinkStatus();this._reportLinkStatus(r);return}dt.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),dt.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const t=this._getLinkStatus();this._reportLinkStatus(t)}async _reportLinkStatus(e){switch(e){case"success":return;default:const t=e==="link-error"?"Link error":"Validation error";switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`${this} ${t} during compilation of ${this.vs}`);case"pending":await this.vs.asyncCompilationStatus,this.vs.debugShader();break}switch(this.fs?.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`${this} ${t} during compilation of ${this.fs}`);case"pending":await this.fs.asyncCompilationStatus,this.fs.debugShader();break}const r=this.device.gl.getProgramInfoLog(this.handle);this.device.reportError(new Error(`${t} during ${e}: ${r}`),this)(),this.device.debug()}}_getLinkStatus(){const{gl:e}=this.device;return e.getProgramParameter(this.handle,35714)?(e.validateProgram(this.handle),e.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation-error")):(this.linkStatus="error","link-error")}async _waitForLinkComplete(){const e=async o=>await new Promise(c=>setTimeout(c,o));if(!this.device.features.has("compilation-status-async-webgl")){await e(10);return}const{gl:r}=this.device;for(;;){if(r.getProgramParameter(this.handle,37297))return;await e(10)}}_areTexturesRenderable(){let e=!0;for(const t of this.shaderLayout.bindings)!this.bindings[t.name]&&!this.bindings[t.name.replace(/Uniforms$/,"")]&&(dt.warn(`Binding ${t.name} not found in ${this.id}`)(),e=!1);return e}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:e}=this.device;e.useProgram(this.handle);let t=0,r=0;for(const o of this.shaderLayout.bindings){const c=this.bindings[o.name]||this.bindings[o.name.replace(/Uniforms$/,"")];if(!c)throw new Error(`No value for binding ${o.name} in ${this.id}`);switch(o.type){case"uniform":const{name:d}=o,a=e.getUniformBlockIndex(this.handle,d);if(a===4294967295)throw new Error(`Invalid uniform block name ${d}`);e.uniformBlockBinding(this.handle,r,a),c instanceof ph?e.bindBufferBase(35345,r,c.handle):e.bindBufferRange(35345,r,c.buffer.handle,c.offset||0,c.size||c.buffer.byteLength-c.offset),r+=1;break;case"texture":if(!(c instanceof lc||c instanceof gh||c instanceof fh))throw new Error("texture");let y;if(c instanceof lc)y=c.texture;else if(c instanceof gh)y=c;else if(c instanceof fh&&c.colorAttachments[0]instanceof lc)dt.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),y=c.colorAttachments[0].texture;else throw new Error("No texture");e.activeTexture(33984+t),e.bindTexture(y.glTarget,y.handle),t+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${o.type}' not supported in WebGL`)}}}_applyUniforms(){for(const e of this.shaderLayout.uniforms||[]){const{name:t,location:r,type:o,textureUnit:c}=e,d=this.uniforms[t]??c;d!==void 0&&zO(this.device.gl,r,o,d)}}}function $O(i,e){const t={...i,attributes:i.attributes.map(r=>({...r}))};for(const r of e?.attributes||[]){const o=t.attributes.find(c=>c.name===r.name);o?(o.type=r.type||o.type,o.stepMode=r.stepMode||o.stepMode):dt.warn(`shader layout attribute ${r.name} not present in shader`)}return t}class WO extends k_{device;handle=null;commands=[];constructor(e){super(e,{}),this.device=e}_executeCommands(e=this.commands){for(const t of e)switch(t.name){case"copy-buffer-to-buffer":HO(this.device,t.options);break;case"copy-buffer-to-texture":ZO(this.device,t.options);break;case"copy-texture-to-buffer":qO(this.device,t.options);break;case"copy-texture-to-texture":XO(this.device,t.options);break;default:throw new Error(t.name)}}}function HO(i,e){const t=e.sourceBuffer,r=e.destinationBuffer;i.gl.bindBuffer(36662,t.handle),i.gl.bindBuffer(36663,r.handle),i.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),i.gl.bindBuffer(36662,null),i.gl.bindBuffer(36663,null)}function ZO(i,e){throw new Error("Not implemented")}function qO(i,e){const{sourceTexture:t,mipLevel:r=0,aspect:o="all",width:c=e.sourceTexture.width,height:d=e.sourceTexture.height,depthOrArrayLayers:a=0,origin:y=[0,0],destinationBuffer:w,byteOffset:E=0,bytesPerRow:I,rowsPerImage:D}=e;if(o!=="all")throw new Error("aspect not supported in WebGL");if(r!==0||a!==0||I||D)throw new Error("not implemented");const{framebuffer:F,destroyFramebuffer:X}=Q1(t);let oe;try{const _e=w,ge=c||F.width,fe=d||F.height,Te=Y1(F.colorAttachments[0].texture.props.format),ke=Te.format,Je=Te.type;i.gl.bindBuffer(35051,_e.handle),oe=i.gl.bindFramebuffer(36160,F.handle),i.gl.readPixels(y[0],y[1],ge,fe,ke,Je,E)}finally{i.gl.bindBuffer(35051,null),oe!==void 0&&i.gl.bindFramebuffer(36160,oe),X&&F.destroy()}}function XO(i,e){const{sourceTexture:t,destinationMipLevel:r=0,origin:o=[0,0],destinationOrigin:c=[0,0],destinationTexture:d}=e;let{width:a=e.destinationTexture.width,height:y=e.destinationTexture.height}=e;const{framebuffer:w,destroyFramebuffer:E}=Q1(t),[I,D]=o,[F,X,oe]=c,_e=i.gl.bindFramebuffer(36160,w.handle);let ge,fe;if(d instanceof gh)ge=d,a=Number.isFinite(a)?a:ge.width,y=Number.isFinite(y)?y:ge.height,ge._bind(0),fe=ge.glTarget;else throw new Error("invalid destination");switch(fe){case 3553:case 34067:i.gl.copyTexSubImage2D(fe,r,F,X,I,D,a,y);break;case 35866:case 32879:i.gl.copyTexSubImage3D(fe,r,F,X,oe,I,D,a,y);break}ge&&ge._unbind(),i.gl.bindFramebuffer(36160,_e),E&&w.destroy()}function Q1(i){if(i instanceof xr){const{width:e,height:t,id:r}=i;return{framebuffer:i.device.createFramebuffer({id:`framebuffer-for-${r}`,width:e,height:t,colorAttachments:[i]}),destroyFramebuffer:!0}}return{framebuffer:i,destroyFramebuffer:!1}}const GO=[1,2,4,8];class YO extends Aa{device;handle=null;glParameters={};constructor(e,t){super(e,t),this.device=e;let r;if(!t?.parameters?.viewport)if(t?.framebuffer){const{width:c,height:d}=t.framebuffer;r=[0,0,c,d]}else{const[c,d]=e.getDefaultCanvasContext().getDrawingBufferSize();r=[0,0,c,d]}this.device.pushState(),this.setParameters({viewport:r,...this.props.parameters});const o=this.props.framebuffer;if(this.props.framebuffer&&o?.handle){const c=this.props.framebuffer.colorAttachments.map((d,a)=>36064+a);this.device.gl.drawBuffers(c)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}setParameters(e={}){const t={...this.glParameters};t.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(t.depthMask=!this.props.depthReadOnly),t.stencilMask=this.props.stencilReadOnly?0:1,t[35977]=this.props.discard,e.viewport&&(e.viewport.length>=6?(t.viewport=e.viewport.slice(0,4),t.depthRange=[e.viewport[4],e.viewport[5]]):t.viewport=e.viewport),e.scissorRect&&(t.scissorTest=!0,t.scissor=e.scissorRect),e.blendConstant&&(t.blendColor=e.blendConstant),e.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),t[2967]=e.stencilReference),"colorMask"in e&&(t.colorMask=GO.map(r=>!!(r&e.colorMask))),this.glParameters=t,Ec(this.device.gl,t)}beginOcclusionQuery(e){this.props.occlusionQuerySet?.beginOcclusionQuery()}endOcclusionQuery(){this.props.occlusionQuerySet?.endOcclusionQuery()}clear(){const e={...this.glParameters};let t=0;this.props.clearColors&&this.props.clearColors.forEach((r,o)=>{r&&this.clearColorBuffer(o,r)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(t|=16384,e.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(t|=256,e.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(t|=1024,e.clearStencil=this.props.clearStencil),t!==0&&Th(this.device.gl,e,()=>{this.device.gl.clear(t)})}clearColorBuffer(e=0,t=[0,0,0,0]){Th(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(t.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,e,t);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,e,t);break;case Float32Array:this.device.gl.clearBufferfv(6144,e,t);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}class n0 extends R_{device;handle=null;commandBuffer;constructor(e,t){super(e,t),this.device=e,this.commandBuffer=new WO(e)}destroy(){}finish(){return this.commandBuffer}beginRenderPass(e){return new YO(this.device,e)}beginComputePass(e){throw new Error("ComputePass not supported in WebGL")}copyBufferToBuffer(e){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:e})}copyBufferToTexture(e){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:e})}copyTextureToBuffer(e){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:e})}copyTextureToTexture(e){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:e})}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}resolveQuerySet(e,t,r){}}function KO(i){const{target:e,source:t,start:r=0,count:o=1}=i,c=t.length,d=o*c;let a=0;for(let y=r;a<c;a++)e[y++]=t[a];for(;a<d;)a<d-a?(e.copyWithin(r+a,r,r+a),a*=2):(e.copyWithin(r+a,r,r+d-a),a=d);return i.target}class ly extends D_{get[Symbol.toStringTag](){return"VertexArray"}device;handle;buffer=null;bufferValue=null;static isConstantAttributeZeroSupported(e){return sE()==="Chrome"}constructor(e,t){super(e,t),this.device=e,this.handle=this.device.gl.createVertexArray()}destroy(){super.destroy(),this.buffer&&this.buffer?.destroy(),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(e){const t=e;if(t&&t.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,t?t.handle:null),this.indexBuffer=t,this.device.gl.bindVertexArray(null)}setBuffer(e,t){const r=t;if(r.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:o,type:c,stride:d,offset:a,normalized:y,integer:w,divisor:E}=this._getAccessor(e);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,r.handle),w?this.device.gl.vertexAttribIPointer(e,o,c,d,a):this.device.gl.vertexAttribPointer(e,o,c,y,d,a),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(e),this.device.gl.vertexAttribDivisor(e,E||0),this.attributes[e]=r,this.device.gl.bindVertexArray(null)}setConstantWebGL(e,t){this._enable(e,!1),this.attributes[e]=t}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let e=0;e<this.maxVertexAttributes;++e){const t=this.attributes[e];ArrayBuffer.isView(t)&&this.device.setConstantAttributeWebGL(e,t)}}_getAccessor(e){const t=this.attributeInfos[e];if(!t)throw new Error(`Unknown attribute location ${e}`);const r=G1(t.bufferDataType);return{size:t.bufferComponents,type:r,stride:t.byteStride,offset:t.byteOffset,normalized:t.normalized,integer:t.integer,divisor:t.stepMode==="instance"?1:0}}_enable(e,t=!0){const o=ly.isConstantAttributeZeroSupported(this.device)||e!==0;(t||o)&&(e=Number(e),this.device.gl.bindVertexArray(this.handle),t?this.device.gl.enableVertexAttribArray(e):this.device.gl.disableVertexAttribArray(e),this.device.gl.bindVertexArray(null))}getConstantBuffer(e,t){const r=JO(t),o=r.byteLength*e,c=r.length*e;if(this.buffer&&o!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${o} !== ${this.buffer.byteLength}.`);let d=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:o}),d||=!QO(r,this.bufferValue),d){const a=K3(t.constructor,c);KO({target:a,source:r,start:0,count:c}),this.buffer.write(a),this.bufferValue=t}return this.buffer}}function JO(i){return Array.isArray(i)?new Float32Array(i):i}function QO(i,e){if(!i||!e||i.length!==e.length||i.constructor!==e.constructor)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}class eL extends O_{device;gl;handle;layout;buffers={};unusedBuffers={};bindOnUse=!0;_bound=!1;constructor(e,t){super(e,t),this.device=e,this.gl=e.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,t.buffers&&this.setBuffers(t.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(e="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(VO(e))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(e){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const t in e)this.setBuffer(t,e[t])})}setBuffer(e,t){const r=this._getVaryingIndex(e),{buffer:o,byteLength:c,byteOffset:d}=this._getBufferRange(t);if(r<0){this.unusedBuffers[e]=o,dt.warn(`${this.id} unusedBuffers varying buffer ${e}`)();return}this.buffers[r]={buffer:o,byteLength:c,byteOffset:d},this.bindOnUse||this._bindBuffer(r,o,d,c)}getBuffer(e){if(s0(e))return this.buffers[e]||null;const t=this._getVaryingIndex(e);return t>=0?this.buffers[t]:null}bind(e=this.handle){if(typeof e!="function")return this.gl.bindTransformFeedback(36386,e),this;let t;return this._bound?t=e():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,t=e(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),t}unbind(){this.bind(null)}_getBufferRange(e){if(e instanceof ph)return{buffer:e,byteOffset:0,byteLength:e.byteLength};const{buffer:t,byteOffset:r=0,byteLength:o=e.buffer.byteLength}=e;return{buffer:t,byteOffset:r,byteLength:o}}_getVaryingIndex(e){if(s0(e))return Number(e);for(const t of this.layout.varyings||[])if(e===t.name)return t.location;return-1}_bindBuffers(){for(const e in this.buffers){const{buffer:t,byteLength:r,byteOffset:o}=this._getBufferRange(this.buffers[e]);this._bindBuffer(Number(e),t,o,r)}}_unbindBuffers(){for(const e in this.buffers)this.gl.bindBufferBase(35982,Number(e),null)}_bindBuffer(e,t,r=0,o){const c=t&&t.handle;!c||o===void 0?this.gl.bindBufferBase(35982,e,c):this.gl.bindBufferRange(35982,e,c,r,o)}}function s0(i){return typeof i=="number"?Number.isInteger(i):/^\d+$/.test(i)}class tL extends L_{device;handle;target=null;_queryPending=!1;_pollingPromise=null;get[Symbol.toStringTag](){return"Query"}constructor(e,t){if(super(e,t),this.device=e,t.count>1)throw new Error("WebGL QuerySet can only have one value");const r=this.device.gl.createQuery();if(!r)throw new Error("WebGL query not supported");this.handle=r,Object.seal(this)}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(e){return this._begin(e?.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(e){this._queryPending||(this.target=e,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const e=this.device.gl.getQueryParameter(this.handle,34919);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(e=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise((r,o)=>{const c=()=>{this.isResultAvailable()?(r(this.getResult()),this._pollingPromise=null):t++>e?(o("Timed out"),this._pollingPromise=null):requestAnimationFrame(c)};requestAnimationFrame(c)}),this._pollingPromise}}function eT(i){switch(i){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function iL(i){switch(i){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function rL(i){return nL[i]}const nL={5124:"sint32",5125:"uint32",5122:"sint16",5123:"uint16",5120:"sint8",5121:"uint8",5126:"float32",5131:"float16",33635:"uint16",32819:"uint16",32820:"uint16",33640:"uint32",35899:"uint32",35902:"uint32",34042:"uint32",36269:"uint32"};function sL(i,e){const{sourceX:t=0,sourceY:r=0,sourceAttachment:o=0}=e||{};let{target:c=null,sourceWidth:d,sourceHeight:a,sourceDepth:y,sourceFormat:w,sourceType:E}=e||{};const{framebuffer:I,deleteFramebuffer:D}=tT(i),{gl:F,handle:X}=I;d||=I.width,a||=I.height;const oe=I.colorAttachments[o]?.texture;if(!oe)throw new Error(`Invalid framebuffer attachment ${o}`);y=oe?.depth||1,w||=oe?.glFormat||6408,E||=oe?.glType||5121,c=lL(c,E,w,d,a);const _e=P_(c);E=E||CO(_e);const ge=F.bindFramebuffer(36160,X);return F.readBuffer(36064+o),F.readPixels(t,r,d,a,w,E,c),F.readBuffer(36064),F.bindFramebuffer(36160,ge||null),D&&I.destroy(),c}function oL(i,e){const{target:t,sourceX:r=0,sourceY:o=0,sourceFormat:c=6408,targetByteOffset:d=0}=e||{};let{sourceWidth:a,sourceHeight:y,sourceType:w}=e||{};const{framebuffer:E,deleteFramebuffer:I}=tT(i);a=a||E.width,y=y||E.height;const D=E;w=w||5121;let F=t;if(!F){const oe=eT(c),_e=iL(w),ge=d+a*y*oe*_e;F=D.device.createBuffer({byteLength:ge})}const X=i.device.createCommandEncoder();return X.copyTextureToBuffer({sourceTexture:i,width:a,height:y,origin:[r,o],destinationBuffer:F,byteOffset:d}),X.destroy(),I&&E.destroy(),F}function tT(i){return i instanceof mp?{framebuffer:i,deleteFramebuffer:!1}:{framebuffer:aL(i),deleteFramebuffer:!0}}function aL(i,e){const{device:t,width:r,height:o,id:c}=i;return t.createFramebuffer({...e,id:`framebuffer-for-${c}`,width:r,height:o,colorAttachments:[i]})}function lL(i,e,t,r,o,c){if(i)return i;e||=5121;const d=rL(e),a=C_(d),y=eT(t);return new a(r*o*y)}class c_ extends La{type="webgl";handle;features;limits;info;canvasContext;preferredColorFormat="rgba8unorm";preferredDepthFormat="depth24plus";commandEncoder;lost;_resolveContextLost;gl;_constants;_extensions={};_polyfilled=!1;spectorJS;get[Symbol.toStringTag](){return"WebGLDevice"}toString(){return`${this[Symbol.toStringTag]}(${this.id})`}isVertexFormatSupported(e){switch(e){case"unorm8x4-bgra":return!1;default:return!0}}constructor(e){super({...e,id:e.id||pO("webgl-device")});const t=La._getCanvasContextProps(e);if(!t)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let r=t.canvas?.gl?.device;if(r)throw new Error(`WebGL context already attached to device ${r.id}`);this.canvasContext=new fO(this,t),this.lost=new Promise(E=>{this._resolveContextLost=E});const o={...e.webgl};t.alphaMode==="premultiplied"&&(o.premultipliedAlpha=!0),e.powerPreference!==void 0&&(o.powerPreference=e.powerPreference);const d=this.props._handle||qD(this.canvasContext.canvas,{onContextLost:E=>this._resolveContextLost?.({reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."}),onContextRestored:E=>console.log("WebGL context restored")},o);if(!d)throw new Error("WebGL context creation failed");if(r=d.device,r){if(e._reuseDevices)return dt.log(1,`Not creating a new Device, instead returning a reference to Device ${r.id} already attached to WebGL context`,r)(),r._reused=!0,r;throw new Error(`WebGL context already attached to device ${r.id}`)}this.handle=d,this.gl=d,this.spectorJS=ID({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=XD(this.gl,this._extensions),this.limits=new uO(this.gl),this.features=new cO(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),new Da(this.gl,{log:(...E)=>dt.log(1,...E)()}).trackState(this.gl,{copyState:!1});const y=e.debugWebGL||e.debug,w=e.debugWebGL;y&&(this.gl=kD(this.gl,{debugWebGL:y,traceWebGL:w}),dt.warn("WebGL debug mode activated. Performance reduced.")(),e.debugWebGL&&(dt.level=Math.max(dt.level,1))),this.commandEncoder=new n0(this,{id:`${this}-command-encoder`})}destroy(){!this.props._reuseDevices&&!this._reused&&delete this.gl.device}get isLost(){return this.gl.isContextLost()}getTextureByteAlignment(){return 4}createCanvasContext(e){throw new Error("WebGL only supports a single canvas")}createBuffer(e){const t=this._normalizeBufferProps(e);return new ph(this,t)}createTexture(e){return new gh(this,e)}createExternalTexture(e){throw new Error("createExternalTexture() not implemented")}createSampler(e){return new EO(this,e)}createShader(e){return new yO(this,e)}createFramebuffer(e){return new fh(this,e)}createVertexArray(e){return new ly(this,e)}createTransformFeedback(e){return new eL(this,e)}createQuerySet(e){return new tL(this,e)}createRenderPipeline(e){return new jO(this,e)}createComputePipeline(e){throw new Error("ComputePipeline not supported in WebGL")}createCommandEncoder(e={}){return new n0(this,e)}submit(e){e||(e=this.commandEncoder.finish(),this.commandEncoder.destroy(),this.commandEncoder=this.createCommandEncoder({id:`${this.id}-default-encoder`})),e._executeCommands()}readPixelsToArrayWebGL(e,t){return sL(e,t)}readPixelsToBufferWebGL(e,t){return oL(e,t)}setParametersWebGL(e){Ec(this.gl,e)}getParametersWebGL(e){return q1(this.gl,e)}withParametersWebGL(e,t){return Th(this.gl,e,t)}resetWebGL(){dt.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),jD(this.gl)}_getDeviceSpecificTextureFormatCapabilities(e){return sO(this.gl,e,this._extensions)}loseDevice(){let e=!1;const r=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return r&&(e=!0,r.loseContext()),this._resolveContextLost?.({reason:"destroyed",message:"Application triggered context loss"}),e}pushState(){Da.get(this.gl).push()}popState(){Da.get(this.gl).pop()}getGLKey(e,t){const r=Number(e);for(const o in this.gl)if(this.gl[o]===r)return`GL.${o}`;return t?.emptyIfUnknown?"":String(e)}getGLKeys(e){const t={emptyIfUnknown:!0};return Object.entries(e).reduce((r,[o,c])=>(r[`${o}:${this.getGLKey(o,t)}`]=`${c}:${this.getGLKey(c,t)}`,r),{})}setConstantAttributeWebGL(e,t){const r=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(r).fill(null);const o=this._constants[e];switch(o&&dL(o,t)&&dt.info(1,`setConstantAttributeWebGL(${e}) could have been skipped, value unchanged`)(),this._constants[e]=t,t.constructor){case Float32Array:cL(this,e,t);break;case Int32Array:uL(this,e,t);break;case Uint32Array:hL(this,e,t);break;default:throw new Error("constant")}}getExtension(e){return wc(this.gl,e,this._extensions),this._extensions}_setWebGLDebugMetadata(e,t,r){e.luma=t;const o={props:r.spector,id:r.spector.id};e.__SPECTOR_Metadata=o}}function cL(i,e,t){switch(t.length){case 1:i.gl.vertexAttrib1fv(e,t);break;case 2:i.gl.vertexAttrib2fv(e,t);break;case 3:i.gl.vertexAttrib3fv(e,t);break;case 4:i.gl.vertexAttrib4fv(e,t);break}}function uL(i,e,t){i.gl.vertexAttribI4iv(e,t)}function hL(i,e,t){i.gl.vertexAttribI4uiv(e,t)}function dL(i,e){if(!i||!e||i.length!==e.length||i.constructor!==e.constructor)return!1;for(let t=0;t<i.length;++t)if(i[t]!==e[t])return!1;return!0}const o0=Object.freeze(Object.defineProperty({__proto__:null,WebGLDevice:c_},Symbol.toStringTag,{value:"Module"}));function Bo(){}const fL=({isDragging:i})=>i?"grabbing":"grab",iT={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:Bo,onWebGLInitialized:Bo,onResize:Bo,onViewStateChange:Bo,onInteractionStateChange:Bo,onBeforeRender:Bo,onAfterRender:Bo,onLoad:Bo,onError:i=>ii.error(i.message,i.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:fL,getTooltip:null,debug:!1,drawPickingColors:!1};class Sh{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new hp({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=r=>{const{_pickRequest:o}=this;if(r.type==="pointerleave")o.x=-1,o.y=-1,o.radius=0;else{if(r.leftButton||r.rightButton)return;{const c=r.offsetCenter;if(!c)return;o.x=c.x,o.y=c.y,o.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:o.x,y:o.y}),o.event=r},this._onEvent=r=>{const o=Qm[r.type],c=r.offsetCenter;if(!o||!c||!this.layerManager)return;const d=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:c.x,y:c.y,layers:d,viewports:this.getViewports(c)},this._lastPointerDownInfo),{layer:y}=a,w=y&&(y[o]||y.props[o]),E=this.props[o];let I=!1;w&&(I=w.call(y,a,r)),I||(E?.(a,r),this.widgetManager.onEvent(a,r))},this._onPointerDown=r=>{if(this.device?.type==="webgpu")return;const o=r.offsetCenter,c=this._pick("pickObject","pickObject Time",{x:o.x,y:o.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=c.result[0]||c.emptyInfo},this.props={...iT,...e},e=this.props,e.viewState&&e.initialViewState&&ii.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&ii.error("WebGL1 context not supported.")(),t=pm.attach(e.gl,this.props.deviceProps)),t||(t=this._createDevice(e)),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&xc.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&ii.removed("onLayerHover","onHover")(),"onLayerClick"in e&&ii.removed("onLayerClick","onClick")(),e.initialViewState&&!kn(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);if(Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),e.device&&e.device.id!==this.device?.id&&(this.animationLoop?.stop(),this.canvas!==e.device.canvasContext?.canvas&&(this.canvas?.remove(),this.eventManager?.destroy(),this.canvas=null),ii.log(`recreating animation loop for new device! id=${e.device.id}`)(),this.animationLoop=this._createAnimationLoop(e.device,e),this.animationLoop.start()),this.animationLoop?.setProps(t),e.useDevicePixels!==void 0&&this.device?.canvasContext?.canvas instanceof HTMLCanvasElement){this.device.canvasContext.props.useDevicePixels=e.useDevicePixels;const r=this.device.canvasContext.canvas,o={target:r,contentBoxSize:[{inlineSize:r.clientWidth,blockSize:r.clientHeight}],devicePixelContentBoxSize:[{inlineSize:r.clientWidth,blockSize:r.clientHeight}],borderBoxSize:[{inlineSize:r.clientWidth,blockSize:r.clientHeight}]};this.device.canvasContext._handleResize([o])}this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const r=this.viewManager.needsRedraw(e),o=this.layerManager.needsRedraw(e),c=this.effectManager.needsRedraw(e),d=this.deckRenderer.needsRedraw(e);return t=t||r||o||c||d,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return ur(this.viewManager),this.viewManager.views}getViewports(e){return ur(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const r in e)this.layerManager.resourceManager.add({resourceId:r,data:e[r],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){this.layerManager?.removeDefaultShaderModule(e)}_pick(e,t,r){ur(this.deckPicker);const{stats:o}=this;o.get("Pick Count").incrementCount(),o.get(t).timeStart();const c=this.deckPicker[e]({layers:this.layerManager.getLayers(r),views:this.viewManager.getViews(),viewports:this.getViewports(r),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...r});return o.get(t).timeEnd(),c}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),ur(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",e.width&&typeof e.width=="number"&&(t.width=e.width),e.height&&typeof e.height=="number"&&(t.height=e.height),(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;const{width:t,height:r}=e;if(t||t===0){const o=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=o}if(r||r===0){const o=Number.isFinite(r)?`${r}px`:r;this.canvas.style.position=e.style?.position||"absolute",this.canvas.style.height=o}}_updateCanvasSize(){const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,r=e.clientHeight??e.height;(t!==this.width||r!==this.height)&&(this.width=t,this.height=r,this.viewManager?.setProps({width:t,height:r}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:r}))}_createAnimationLoop(e,t){const{gl:r,onError:o}=t;return new K_({device:e,autoResizeDrawingBuffer:!r,autoResizeViewport:!1,onInitialize:c=>this._setDevice(c.device),onRender:this._onRenderFrame.bind(this),onError:o})}_createDevice(e){const t=this.props.deviceProps?.createCanvasContext,r=typeof t=="object"?t:void 0,o={adapters:[],...e.deviceProps};o.adapters.includes(pm)||o.adapters.push(pm);const c={alphaMode:this.props.deviceProps?.type==="webgpu"?"premultiplied":void 0};return $m.createDevice({_reuseDevices:!0,type:"webgl",...o,createCanvasContext:{...c,...r,canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!0}})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new ty({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;const{_pickRequest:e}=this;if(e.event){const{result:t,emptyInfo:r}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=t.length>0;let o=r,c=!1;for(const d of t)o=d,c=d.layer?.onHover(d,e.event)||c;c||(this.props.onHover?.(o,e.event),this.widgetManager.onHover(o,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas,!this.canvas.isConnected&&this.props.parent&&this.props.parent.insertBefore(this.canvas,this.props.parent.firstChild)),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const t=new B1;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new XM(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(vb).map(o=>{const[c,d,a,y]=vb[o],w=this.props.eventRecognizerOptions?.[o],E={...d,...w,event:o};return{recognizer:new c(E),recognizeWith:a,requestFailure:y}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const o in Qm)this.eventManager.on(o,this._onEvent);this.viewManager=new qk({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const r=this.viewManager.getViewports()[0];this.layerManager=new Zk(this.device,{deck:this,stats:this.stats,viewport:r,timeline:t}),this.effectManager=new aD({deck:this,device:this.device}),this.deckRenderer=new uD(this.device),this.deckPicker=new fD(this.device),this.widgetManager=new mD({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new W1),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){const{device:r,gl:o}=this.layerManager.context;this.props.onBeforeRender({device:r,gl:o});const c={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};this.deckRenderer?.renderLayers(c),c.pass==="screen"&&this.widgetManager.onRedraw({viewports:c.viewports,layers:c.layers}),this.props.onAfterRender({device:r,gl:o})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),ii.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const r=$m.stats.get("Memory Usage");e.bufferMemory=r.get("Buffer Memory").count,e.textureMemory=r.get("Texture Memory").count,e.renderbufferMemory=r.get("Renderbuffer Memory").count,e.gpuMemory=r.get("GPU Memory").count}}Sh.defaultProps=iT;Sh.VERSION=AP;function pL(i){switch(i){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return C_(i)}}const gL=P_;function df(i,e,t){const r=t==="webgpu"&&e.type==="uint8"?"unorm8":e.type;return{attribute:i,format:e.size>1?`${r}x${e.size}`:e.type,byteOffset:e.offset||0}}function Ia(i){return i.stride||i.size*i.bytesPerElement}function mL(i,e){return i.type===e.type&&i.size===e.size&&Ia(i)===Ia(e)&&(i.offset||0)===(e.offset||0)}function u_(i,e){e.offset&&ii.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const t=Ia(i),r=e.vertexOffset!==void 0?e.vertexOffset:i.vertexOffset||0,o=e.elementOffset||0,c=r*t+o*i.bytesPerElement+(i.offset||0);return{...e,offset:c,stride:t}}function _L(i,e){const t=u_(i,e);return{high:t,low:{...t,offset:t.offset+i.size*4}}}class yL{constructor(e,t,r){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const o=t.logicalType||t.type,c=o==="float64";let{defaultValue:d}=t;d=Number.isFinite(d)?[d]:d||new Array(this.size).fill(0);let a;c?a="float32":!o&&t.isIndexed?a="uint32":a=o||"float32";let y=pL(o||a);this.doublePrecision=c,c&&t.fp64===!1&&(y=Float32Array),this.value=null,this.settings={...t,defaultType:y,defaultValue:d,logicalType:o,type:a,normalized:a.includes("norm"),size:this.size,bytesPerElement:y.BYTES_PER_ELEMENT},this.state={...r,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*Ia(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),xc.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const r={};if(this.state.constant){const o=this.value;if(t){const c=u_(this.getAccessor(),t),d=c.offset/o.BYTES_PER_ELEMENT,a=c.size||this.size;r[e]=o.subarray(d,d+a)}else r[e]=o}else r[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?r[`${e}64Low`]=r[e]:r[`${e}64Low`]=new Float32Array(this.size)),r}_getBufferLayout(e=this.id,t=null){const r=this.getAccessor(),o=[],c={name:this.id,byteStride:Ia(r),attributes:o};if(this.doublePrecision){const d=_L(r,t||{});o.push(df(e,{...r,...d.high},this.device.type),df(`${e}64Low`,{...r,...d.low},this.device.type))}else if(t){const d=u_(r,t);o.push(df(e,{...r,...d},this.device.type))}else o.push(df(e,r,this.device.type));return c}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:r,size:o}=this,c=r*o;if(t&&c&&t.length>=c){const d=new Array(o).fill(1/0),a=new Array(o).fill(-1/0);for(let y=0;y<c;)for(let w=0;w<o;w++){const E=t[y++];E<d[w]&&(d[w]=E),E>a[w]&&(a[w]=E)}e=[d,a]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let r;ArrayBuffer.isView(e)?r={value:e}:e instanceof Mi?r={buffer:e}:r=e;const o={...this.settings,...r};if(ArrayBuffer.isView(r.value)){if(!r.type)if(this.doublePrecision&&r.value instanceof Float64Array)o.type="float32";else{const d=gL(r.value);o.type=o.normalized?d.replace("int","norm"):d}o.bytesPerElement=r.value.BYTES_PER_ELEMENT,o.stride=Ia(o)}if(t.bounds=null,r.constant){let c=r.value;if(c=this._normalizeValue(c,[],0),this.settings.normalized&&(c=this.normalizeConstant(c)),!(!t.constant||!this._areValuesEqual(c,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(c)?c:new Float32Array(c)}else if(r.buffer){const c=r.buffer;t.externalBuffer=c,t.constant=!1,this.value=r.value||null}else if(r.value){this._checkExternalBuffer(r);let c=r.value;t.externalBuffer=null,t.constant=!1,this.value=c;let{buffer:d}=this;const a=Ia(o),y=(o.vertexOffset||0)*a;if(this.doublePrecision&&c instanceof Float64Array&&(c=lm(c,o)),this.settings.isIndexed){const E=this.settings.defaultType;c.constructor!==E&&(c=new E(c))}const w=c.byteLength+y+a*2;(!d||d.byteLength<w)&&(d=this._createBuffer(w)),d.write(c,y)}return this.setAccessor(o),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:r=0,endOffset:o}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?lm(t,{size:this.size,startIndex:r,endIndex:o}):t.subarray(r,o),r*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:r}=this,o=r.allocatedValue,c=xc.allocate(o,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=c;const{byteOffset:d}=this;let{buffer:a}=this;return(!a||a.byteLength<c.byteLength+d)&&(a=this._createBuffer(c.byteLength+d),t&&o&&a.write(o instanceof Float64Array?lm(o,this):o,d)),r.allocatedValue=c,r.constant=!1,r.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const r=this.settings.defaultType;let o=!1;if(this.doublePrecision&&(o=t.BYTES_PER_ELEMENT<4),o)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);!(t instanceof r)&&this.settings.normalized&&!("normalized"in e)&&ii.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(t=>t/255);case"unorm16":return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,r){const{defaultValue:o,size:c}=this.settings;if(Number.isFinite(e))return t[r]=e,t;if(!e){let d=c;for(;--d>=0;)t[r+d]=o[d];return t}switch(c){case 4:t[r+3]=Number.isFinite(e[3])?e[3]:o[3];case 3:t[r+2]=Number.isFinite(e[2])?e[2]:o[2];case 2:t[r+1]=Number.isFinite(e[1])?e[1]:o[1];case 1:t[r+0]=Number.isFinite(e[0])?e[0]:o[0];break;default:let d=c;for(;--d>=0;)t[r+d]=Number.isFinite(e[d])?e[d]:o[d]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:r}=this;for(let o=0;o<r;o++)if(e[o]!==t[o])return!1;return!0}_createBuffer(e){this._buffer&&this._buffer.destroy();const{isIndexed:t,type:r}=this.settings;return this._buffer=this.device.createBuffer({...this._buffer?.props,id:this.id,usage:(t?Mi.INDEX:Mi.VERTEX)|Mi.COPY_DST,indexType:t?r:void 0,byteLength:e}),this._buffer}}const a0=[],l0=[];function xp(i,e=0,t=1/0){let r=a0;const o={index:-1,data:i,target:[]};return i?typeof i[Symbol.iterator]=="function"?r=i:i.length>0&&(l0.length=i.length,r=l0):r=a0,(e>0||Number.isFinite(t))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(e,t),o.index=e-1),{iterable:r,objectInfo:o}}function rT(i){return i&&i[Symbol.asyncIterator]}function nT(i,e){const{size:t,stride:r,offset:o,startIndices:c,nested:d}=e,a=i.BYTES_PER_ELEMENT,y=r?r/a:t,w=o?o/a:0,E=Math.floor((i.length-w)/y);return(I,{index:D,target:F})=>{if(!c){const ge=D*y+w;for(let fe=0;fe<t;fe++)F[fe]=i[ge+fe];return F}const X=c[D],oe=c[D+1]||E;let _e;if(d){_e=new Array(oe-X);for(let ge=X;ge<oe;ge++){const fe=ge*y+w;F=new Array(t);for(let Te=0;Te<t;Te++)F[Te]=i[fe+Te];_e[ge-X]=F}}else if(y===t)_e=i.subarray(X*t+w,oe*t+w);else{_e=new i.constructor((oe-X)*t);let ge=0;for(let fe=X;fe<oe;fe++){const Te=fe*y+w;for(let ke=0;ke<t;ke++)_e[ge++]=i[Te+ke]}}return _e}}const xL=[],Mf=[[0,1/0]];function vL(i,e){if(i===Mf||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return i;const t=[],r=i.length;let o=0;for(let c=0;c<r;c++){const d=i[c];d[1]<e[0]?(t.push(d),o=c+1):d[0]>e[1]?t.push(d):e=[Math.min(d[0],e[0]),Math.max(d[1],e[1])]}return t.splice(o,0,e),t}const bL={interpolation:{duration:0,easing:i=>i},spring:{stiffness:.05,damping:.5}};function sT(i,e){if(!i)return null;Number.isFinite(i)&&(i={type:"interpolation",duration:i});const t=i.type||"interpolation";return{...bL[t],...e,...i,type:t}}class oT extends yL{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Mf}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;(t=this.state).layoutChanged||(t.layoutChanged=!mL(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,r=this.settings.transition,o=Array.isArray(t)?e[t.find(c=>e[c])]:e[t];return sT(o,r)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:r=0,endRow:o=1/0}=t;this.state.updateRanges=vL(this.state.updateRanges,[r,o])}else this.state.updateRanges=Mf}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=xL}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:r}=this;return r.noAlloc?!1:r.update?(super.allocate(e,t.updateRanges!==Mf),!0):!1}updateBuffer({numInstances:e,data:t,props:r,context:o}){if(!this.needsUpdate())return!1;const{state:{updateRanges:c},settings:{update:d,noAlloc:a}}=this;let y=!0;if(d){for(const[w,E]of c)d.call(o,this,{data:t,startRow:w,endRow:E,props:r,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[w,E]of c){const I=Number.isFinite(w)?this.getVertexOffset(w):0,D=Number.isFinite(E)?this.getVertexOffset(E):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:I,endOffset:D})}this._checkAttributeArray()}else y=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),y}setConstantValue(e,t){const r=this.device.type==="webgpu";if(r||t===void 0||typeof t=="function"){if(r&&typeof t!="function"){const d=this._normalizeValue(t,[],0);this._areValuesEqual(d,this.value)||this.setNeedsUpdate("WebGPU constant updated")}return!1}const o=this.settings.transform&&e?this.settings.transform.call(e,t):t;return this.setData({constant:!0,value:o})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:r,settings:o}=this;if(!e)return r.binaryValue=null,r.binaryAccessor=null,!1;if(o.noAlloc)return!1;if(r.binaryValue===e)return this.clearNeedsUpdate(),!0;if(r.binaryValue=e,this.setNeedsRedraw(),o.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const d=e;ur(ArrayBuffer.isView(d.value),`invalid ${o.accessor}`);const a=!!d.size&&d.size!==this.size;return r.binaryAccessor=nT(d.value,{size:d.size||this.size,stride:d.stride,offset:d.offset,startIndices:t,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const r in e)Object.assign(t,super.getValue(r,e[r]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,r=super._getBufferLayout(),{stepMode:o}=this.settings;if(o==="dynamic"?r.stepMode=e?e.isInstanced?"instance":"vertex":"instance":r.stepMode=o??"vertex",!t)return r;for(const c in t){const d=super._getBufferLayout(c,t[c]);r.attributes.push(...d.attributes)}return r}_autoUpdater(e,{data:t,startRow:r,endRow:o,props:c,numInstances:d}){if(e.constant&&this.context.device.type!=="webgpu")return;const{settings:a,state:y,value:w,size:E,startIndices:I}=e,{accessor:D,transform:F}=a;let X=y.binaryAccessor||(typeof D=="function"?D:c[D]);typeof X!="function"&&typeof D=="string"&&(X=()=>c[D]),ur(typeof X=="function",`accessor "${D}" is not a function`);let oe=e.getVertexOffset(r);const{iterable:_e,objectInfo:ge}=xp(t,r,o);for(const fe of _e){ge.index++;let Te=X(fe,ge);if(F&&(Te=F.call(this,Te)),I){const ke=(ge.index<I.length-1?I[ge.index+1]:d)-I[ge.index];if(Te&&Array.isArray(Te[0])){let Je=oe;for(const Xe of Te)e._normalizeValue(Xe,w,Je),Je+=E}else Te&&Te.length>E?w.set(Te,oe):(e._normalizeValue(Te,ge.target,0),Vk({target:w,source:ge.target,start:oe,count:ke}));oe+=ke*E}else e._normalizeValue(Te,w,oe),oe+=E}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let r=!0;switch(t){case 4:r=r&&Number.isFinite(e[3]);case 3:r=r&&Number.isFinite(e[2]);case 2:r=r&&Number.isFinite(e[1]);case 1:r=r&&Number.isFinite(e[0]);break;default:r=!1}if(!r)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function xm(i){const{source:e,target:t,start:r=0,size:o,getData:c}=i,d=i.end||t.length,a=e.length,y=d-r;if(a>y){t.set(e.subarray(0,y),r);return}if(t.set(e,r),!c)return;let w=a;for(;w<y;){const E=c(w,e);for(let I=0;I<o;I++)t[r+w]=E[I]||0,w++}}function wL({source:i,target:e,size:t,getData:r,sourceStartIndices:o,targetStartIndices:c}){if(!o||!c)return xm({source:i,target:e,size:t,getData:r}),e;let d=0,a=0;const y=r&&((E,I)=>r(E+a,I)),w=Math.min(o.length,c.length);for(let E=1;E<w;E++){const I=o[E]*t,D=c[E]*t;xm({source:i.subarray(d,I),target:e,start:a,end:D,size:t,getData:y}),d=I,a=D}return a<e.length&&xm({source:[],target:e,start:a,size:t,getData:y}),e}function TL(i){const{device:e,settings:t,value:r}=i,o=new oT(e,t);return o.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:t.normalized}),o}function aT(i){switch(i){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${i}"`)}}function lT(i){switch(i){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function cT(i){i.push(i.shift())}function SL(i,e){const{doublePrecision:t,settings:r,value:o,size:c}=i,d=t&&o instanceof Float64Array?2:1;let a=0;const{shaderAttributes:y}=i.settings;if(y)for(const w of Object.values(y))a=Math.max(a,w.vertexOffset??0);return(r.noAlloc?o.length:(e+a)*c)*d}function uT({device:i,source:e,target:t}){return(!t||t.byteLength<e.byteLength)&&(t?.destroy(),t=i.createBuffer({byteLength:e.byteLength,usage:e.usage})),t}function hT({device:i,buffer:e,attribute:t,fromLength:r,toLength:o,fromStartIndices:c,getData:d=a=>a}){const a=t.doublePrecision&&t.value instanceof Float64Array?2:1,y=t.size*a,w=t.byteOffset,E=t.settings.bytesPerElement<4?w/t.settings.bytesPerElement*4:w,I=t.startIndices,D=c&&I,F=t.isConstant;if(!D&&e&&r>=o)return e;const X=t.value instanceof Float64Array?Float32Array:t.value.constructor,oe=F?t.value:new X(t.getBuffer().readSyncWebGL(w,o*X.BYTES_PER_ELEMENT).buffer);if(t.settings.normalized&&!F){const Te=d;d=(ke,Je)=>t.normalizeConstant(Te(ke,Je))}const _e=F?(Te,ke)=>d(oe,ke):(Te,ke)=>d(oe.subarray(Te+w,Te+w+y),ke),ge=e?new Float32Array(e.readSyncWebGL(E,r*4).buffer):new Float32Array(0),fe=new Float32Array(o);return wL({source:ge,target:fe,sourceStartIndices:c,targetStartIndices:I,size:y,getData:_e}),(!e||e.byteLength<fe.byteLength+E)&&(e?.destroy(),e=i.createBuffer({byteLength:fe.byteLength+E,usage:35050})),e.write(fe,E),e}class dT{constructor({device:e,attribute:t,timeline:r}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new yp(r),this.attribute=t,this.attributeInTransition=TL(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,r=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=SL(this.attribute,t),this.transition.start({...e,duration:r})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class EL extends dT{constructor({device:e,attribute:t,timeline:r}){super({device:e,attribute:t,timeline:r}),this.type="interpolation",this.transform=IL(e,t)}start(e,t){const r=this.currentLength,o=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:c,attribute:d}=this;cT(c),c[0]=hT({device:this.device,buffer:c[0],attribute:d,fromLength:r,toLength:this.currentLength,fromStartIndices:o,getData:e.enter}),c[1]=uT({device:this.device,source:c[0],target:c[1]}),this.setBuffer(c[1]);const{transform:a}=this,y=a.model;let w=Math.floor(this.currentLength/d.size);fT(d)&&(w/=2),y.setVertexCount(w),d.isConstant?(y.setAttributes({aFrom:c[0]}),y.setConstantAttributes({aTo:d.value})):y.setAttributes({aFrom:c[0],aTo:d.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:c[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:r}=this.transition;let o=r/e;t&&(o=t(o));const{model:c}=this.transform,d={time:o};c.shaderInputs.setProps({interpolation:d}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const AL=`uniform interpolationUniforms {
  float time;
} interpolation;
`,c0={name:"interpolation",vs:AL,uniformTypes:{time:"f32"}},PL=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,CL=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function fT(i){return i.doublePrecision&&i.value instanceof Float64Array}function IL(i,e){const t=e.size,r=aT(t),o=lT(t),c=e.getBufferLayout();return fT(e)?new vc(i,{vs:CL,bufferLayout:[{name:"aFrom",byteStride:8*t,attributes:[{attribute:"aFrom",format:o,byteOffset:0},{attribute:"aFrom64Low",format:o,byteOffset:4*t}]},{name:"aTo",byteStride:8*t,attributes:[{attribute:"aTo",format:o,byteOffset:0},{attribute:"aTo64Low",format:o,byteOffset:4*t}]}],modules:[LI,c0],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:t},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new vc(i,{vs:PL,bufferLayout:[{name:"aFrom",format:o},{name:"aTo",format:c.attributes[0].format}],modules:[c0],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}class ML extends dT{constructor({device:e,attribute:t,timeline:r}){super({device:e,attribute:t,timeline:r}),this.type="spring",this.texture=FL(e),this.framebuffer=BL(e,this.texture),this.transform=LL(e,t)}start(e,t){const r=this.currentLength,o=this.currentStartIndices;super.start(e,t);const{buffers:c,attribute:d}=this;for(let y=0;y<2;y++)c[y]=hT({device:this.device,buffer:c[y],attribute:d,fromLength:r,toLength:this.currentLength,fromStartIndices:o,getData:e.enter});c[2]=uT({device:this.device,source:c[0],target:c[2]}),this.setBuffer(c[1]);const{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/d.size)),d.isConstant?a.setConstantAttributes({aTo:d.value}):a.setAttributes({aTo:d.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:r,transition:o}=this,c=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});const d={stiffness:c.stiffness,damping:c.damping};t.model.shaderInputs.setProps({spring:d}),t.run({framebuffer:r,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),cT(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(r)[0]>0||o.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const RL=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,kL={name:"spring",vs:RL,uniformTypes:{damping:"f32",stiffness:"f32"}},DL=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,OL=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function LL(i,e){const t=aT(e.size),r=lT(e.size);return new vc(i,{vs:DL,fs:OL,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[kL],defines:{ATTRIBUTE_TYPE:t},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function FL(i){return i.createTexture({data:new Uint8Array(4),format:"rgba8unorm",width:1,height:1})}function BL(i,e){return i.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const NL={interpolation:EL,spring:ML};class zL{constructor(e,{id:t,timeline:r}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=r,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:r}){this.numInstances=r||1;for(const o in e){const c=e[o],d=c.getTransitionSetting(t);d&&this._updateAttribute(o,c,d)}for(const o in this.transitions){const c=e[o];(!c||!c.getTransitionSetting(t))&&this._removeTransition(o)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const r=this.transitions[t];r.inProgress&&(e[t]=r.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,r){const o=this.transitions[e];let c=!o||o.type!==r.type;if(c){o&&this._removeTransition(e);const d=NL[r.type];d?this.transitions[e]=new d({attribute:t,timeline:this.timeline,device:this.device}):(ii.error(`unsupported transition type '${r.type}'`)(),c=!1)}(c||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(r,this.numInstances))}}const u0="attributeManager.invalidate",UL="attributeManager.updateStart",VL="attributeManager.updateEnd",jL="attribute.updateStart",$L="attribute.allocate",WL="attribute.updateEnd";class HL{constructor(e,{id:t="attribute-manager",stats:r,timeline:o}={}){this.mergeBoundsMemoized=Dh(ok),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=r,this.attributeTransitionManager=new zL(e,{id:`${t}-transitions`,timeline:o}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const r=this._invalidateTrigger(e,t);Nr(u0,this,e,r)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);Nr(u0,this,"all")}update({data:e,numInstances:t,startIndices:r=null,transitions:o,props:c={},buffers:d={},context:a={}}){let y=!1;Nr(UL,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const w in this.attributes){const E=this.attributes[w],I=E.settings.accessor;E.startIndices=r,E.numInstances=t,c[w]&&ii.removed(`props.${w}`,`data.attributes.${w}`)(),E.setExternalBuffer(d[w])||E.setBinaryValue(typeof I=="string"?d[I]:void 0,e.startIndices)||typeof I=="string"&&!d[I]&&E.setConstantValue(a,c[I])||E.needsUpdate()&&(y=!0,this._updateAttribute({attribute:E,numInstances:t,data:e,props:c,context:a})),this.needsRedraw=this.needsRedraw||E.needsRedraw()}y&&Nr(VL,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:o})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map(r=>this.attributes[r]?.getBounds());return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:r}=this,o={...r.getAttributes()};for(const c in t){const d=t[c];d.needsRedraw(e)&&!r.hasAttribute(c)&&(o[c]=d)}return o}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(const r in e){const o=e[r],c={...o,id:r,size:o.isIndexed&&1||o.size||1,...t};this.attributes[r]=new oT(this.device,c)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(o=>{e[o]||(e[o]=[]),e[o].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:r,updateTriggers:o}=this,c=o[e];return c&&c.forEach(d=>{const a=r[d];a&&a.setNeedsUpdate(a.id,t)}),c}_updateAttribute(e){const{attribute:t,numInstances:r}=e;if(Nr(jL,t),t.constant){t.setConstantValue(e.context,t.value);return}t.allocate(r)&&Nr($L,t,r),t.updateBuffer(e)&&(this.needsRedraw=!0,Nr(WL,t,r))}}class ZL extends yp{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:r,duration:o,easing:c}}=this,d=c(e/o);this._value=tp(t,r,d)}}const h0=1e-5;function d0(i,e,t,r,o){const c=e-i,a=(t-e)*o,y=-c*r;return a+y+c+e}function qL(i,e,t,r,o){if(Array.isArray(t)){const c=[];for(let d=0;d<t.length;d++)c[d]=d0(i[d],e[d],t[d],r,o);return c}return d0(i,e,t,r,o)}function f0(i,e){if(Array.isArray(i)){let t=0;for(let r=0;r<i.length;r++){const o=i[r]-e[r];t+=o*o}return Math.sqrt(t)}return Math.abs(i-e)}class XL extends yp{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:r,stiffness:o}=this.settings,{_prevValue:c=e,_currValue:d=e}=this;let a=qL(c,d,t,r,o);const y=f0(a,t),w=f0(a,d);y<h0&&w<h0&&(a=t,this.end()),this._prevValue=d,this._currValue=a}}const GL={interpolation:ZL,spring:XL};class YL{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,r,o){const{transitions:c}=this;if(c.has(e)){const y=c.get(e),{value:w=y.settings.fromValue}=y;t=w,this.remove(e)}if(o=sT(o),!o)return;const d=GL[o.type];if(!d){ii.error(`unsupported transition type '${o.type}'`)();return}const a=new d(this.timeline);a.start({...o,fromValue:t,toValue:r}),c.set(e,a)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,r]of this.transitions)r.update(),e[t]=r.value,r.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function KL(i){const e=i[Ho];for(const t in e){const r=e[t],{validate:o}=r;if(o&&!o(i[t],r))throw new Error(`Invalid prop ${t}: ${i[t]}`)}}function JL(i,e){const t=pT({newProps:i,oldProps:e,propTypes:i[Ho],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=eF(i,e);let o=!1;return r||(o=tF(i,e)),{dataChanged:r,propsChanged:t,updateTriggersChanged:o,extensionsChanged:iF(i,e),transitionsChanged:QL(i,e)}}function QL(i,e){if(!i.transitions)return!1;const t={},r=i[Ho];let o=!1;for(const c in i.transitions){const d=r[c],a=d&&d.type;(a==="number"||a==="color"||a==="array")&&h_(i[c],e[c],d)&&(t[c]=!0,o=!0)}return o?t:!1}function pT({newProps:i,oldProps:e,ignoreProps:t={},propTypes:r={},triggerName:o="props"}){if(e===i)return!1;if(typeof i!="object"||i===null)return`${o} changed shallowly`;if(typeof e!="object"||e===null)return`${o} changed shallowly`;for(const c of Object.keys(i))if(!(c in t)){if(!(c in e))return`${o}.${c} added`;const d=h_(i[c],e[c],r[c]);if(d)return`${o}.${c} ${d}`}for(const c of Object.keys(e))if(!(c in t)){if(!(c in i))return`${o}.${c} dropped`;if(!Object.hasOwnProperty.call(i,c)){const d=h_(i[c],e[c],r[c]);if(d)return`${o}.${c} ${d}`}}return!1}function h_(i,e,t){let r=t&&t.equal;return r&&!r(i,e,t)||!r&&(r=i&&e&&i.equals,r&&!r.call(i,e))?"changed deeply":!r&&e!==i?"changed shallowly":null}function eF(i,e){if(e===null)return"oldProps is null, initial diff";let t=!1;const{dataComparator:r,_dataDiff:o}=i;return r?r(i.data,e.data)||(t="Data comparator detected a change"):i.data!==e.data&&(t="A new data container was supplied"),t&&o&&(t=o(i.data,e.data)||t),t}function tF(i,e){if(e===null)return{all:!0};if("all"in i.updateTriggers&&p0(i,e,"all"))return{all:!0};const t={};let r=!1;for(const o in i.updateTriggers)o!=="all"&&p0(i,e,o)&&(t[o]=!0,r=!0);return r?t:!1}function iF(i,e){if(e===null)return!0;const t=e.extensions,{extensions:r}=i;if(r===t)return!1;if(!t||!r||r.length!==t.length)return!0;for(let o=0;o<r.length;o++)if(!r[o].equals(t[o]))return!0;return!1}function p0(i,e,t){let r=i.updateTriggers[t];r=r??{};let o=e.updateTriggers[t];return o=o??{},pT({oldProps:o,newProps:r,triggerName:t})}const rF="count(): argument not an object",nF="count(): argument not a container";function sF(i){if(!aF(i))throw new Error(rF);if(typeof i.count=="function")return i.count();if(Number.isFinite(i.size))return i.size;if(Number.isFinite(i.length))return i.length;if(oF(i))return Object.keys(i).length;throw new Error(nF)}function oF(i){return i!==null&&typeof i=="object"&&i.constructor===Object}function aF(i){return i!==null&&typeof i=="object"}function g0(i,e){if(!e)return i;const t={...i,...e};if("defines"in e&&(t.defines={...i.defines,...e.defines}),"modules"in e&&(t.modules=(i.modules||[]).concat(e.modules),e.modules.some(r=>r.name==="project64"))){const r=t.modules.findIndex(o=>o.name==="project32");r>=0&&t.modules.splice(r,1)}if("inject"in e)if(!i.inject)t.inject=e.inject;else{const r={...i.inject};for(const o in e.inject)r[o]=(r[o]||"")+e.inject[o];t.inject=r}return t}const lF={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},d_={};function cF(i,e,t,r){if(t instanceof xr)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let o=null;t.compressed&&(o={minFilter:"linear",mipmapFilter:t.data.length>1?"nearest":"linear"});const{width:c,height:d}=t.data,a=e.createTexture({...t,sampler:{...lF,...o,...r},mipLevels:e.getMipLevelCount(c,d)});return a.generateMipmapsWebGL(),d_[a.id]=i,a}function uF(i,e){!e||!(e instanceof xr)||d_[e.id]===i&&(e.delete(),delete d_[e.id])}const hF={boolean:{validate(i,e){return!0},equal(i,e,t){return!!i==!!e}},number:{validate(i,e){return Number.isFinite(i)&&(!("max"in e)||i<=e.max)&&(!("min"in e)||i>=e.min)}},color:{validate(i,e){return e.optional&&!i||f_(i)&&(i.length===3||i.length===4)},equal(i,e,t){return kn(i,e,1)}},accessor:{validate(i,e){const t=op(i);return t==="function"||t===op(e.value)},equal(i,e,t){return typeof e=="function"?!0:kn(i,e,1)}},array:{validate(i,e){return e.optional&&!i||f_(i)},equal(i,e,t){const{compare:r}=t,o=Number.isInteger(r)?r:r?1:0;return r?kn(i,e,o):i===e}},object:{equal(i,e,t){if(t.ignore)return!0;const{compare:r}=t,o=Number.isInteger(r)?r:r?1:0;return r?kn(i,e,o):i===e}},function:{validate(i,e){return e.optional&&!i||typeof i=="function"},equal(i,e,t){return!t.compare&&t.ignore!==!1||i===e}},data:{transform:(i,e,t)=>{if(!i)return i;const{dataTransform:r}=t.props;return r?r(i):typeof i.shape=="string"&&i.shape.endsWith("-table")&&Array.isArray(i.data)?i.data:i}},image:{transform:(i,e,t)=>{const r=t.context;return!r||!r.device?null:cF(t.id,r.device,i,{...e.parameters,...t.props.textureParameters})},release:(i,e,t)=>{uF(t.id,i)}}};function dF(i){const e={},t={},r={};for(const[o,c]of Object.entries(i)){const d=c?.deprecatedFor;if(d)r[o]=Array.isArray(d)?d:[d];else{const a=fF(o,c);e[o]=a,t[o]=a.value}}return{propTypes:e,defaultProps:t,deprecatedProps:r}}function fF(i,e){switch(op(e)){case"object":return Ju(i,e);case"array":return Ju(i,{type:"array",value:e,compare:!1});case"boolean":return Ju(i,{type:"boolean",value:e});case"number":return Ju(i,{type:"number",value:e});case"function":return Ju(i,{type:"function",value:e,compare:!0});default:return{name:i,type:"unknown",value:e}}}function Ju(i,e){return"type"in e?{name:i,...hF[e.type],...e}:"value"in e?{name:i,type:op(e.value),...e}:{name:i,type:"object",value:e}}function f_(i){return Array.isArray(i)||ArrayBuffer.isView(i)}function op(i){return f_(i)?"array":i===null?"null":typeof i}function pF(i,e){let t;for(let c=e.length-1;c>=0;c--){const d=e[c];"extensions"in d&&(t=d.extensions)}const r=p_(i.constructor,t),o=Object.create(r);o[sp]=i,o[Ua]={},o[jo]={};for(let c=0;c<e.length;++c){const d=e[c];for(const a in d)o[a]=d[a]}return Object.freeze(o),o}const gF="_mergedDefaultProps";function p_(i,e){if(!(i instanceof vp.constructor))return{};let t=gF;if(e)for(const o of e){const c=o.constructor;c&&(t+=`:${c.extensionName||c.name}`)}const r=gT(i,t);return r||(i[t]=mF(i,e||[]))}function mF(i,e){if(!i.prototype)return null;const r=Object.getPrototypeOf(i),o=p_(r),c=gT(i,"defaultProps")||{},d=dF(c),a=Object.assign(Object.create(null),o,d.defaultProps),y=Object.assign(Object.create(null),o?.[Ho],d.propTypes),w=Object.assign(Object.create(null),o?.[fm],d.deprecatedProps);for(const E of e){const I=p_(E.constructor);I&&(Object.assign(a,I),Object.assign(y,I[Ho]),Object.assign(w,I[fm]))}return _F(a,i),xF(a,y),yF(a,w),a[Ho]=y,a[fm]=w,e.length===0&&!cy(i,"_propTypes")&&(i._propTypes=y),a}function _F(i,e){const t=bF(e);Object.defineProperties(i,{id:{writable:!0,value:t}})}function yF(i,e){for(const t in e)Object.defineProperty(i,t,{enumerable:!1,set(r){const o=`${this.id}: ${t}`;for(const c of e[t])cy(this,c)||(this[c]=r);ii.deprecated(o,e[t].join("/"))()}})}function xF(i,e){const t={},r={};for(const o in e){const c=e[o],{name:d,value:a}=c;c.async&&(t[d]=a,r[d]=vF(d))}i[dc]=t,i[Ua]={},Object.defineProperties(i,r)}function vF(i){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||rT(e)?this[Ua][i]=e:this[jo][i]=e},get(){if(this[jo]){if(i in this[jo])return this[jo][i]||this[dc][i];if(i in this[Ua]){const e=this[sp]&&this[sp].internalState;if(e&&e.hasAsyncProp(i))return e.getAsyncProp(i)||this[dc][i]}}return this[dc][i]}}}function cy(i,e){return Object.prototype.hasOwnProperty.call(i,e)}function gT(i,e){return cy(i,e)&&i[e]}function bF(i){const e=i.componentName;return e||ii.warn(`${i.name}.componentName not specified`)(),e||i.name}let wF=0;class vp{constructor(...e){this.props=pF(this,e),this.id=this.props.id,this.count=wF++}clone(e){const{props:t}=this,r={};for(const o in t[dc])o in t[jo]?r[o]=t[jo][o]:o in t[Ua]&&(r[o]=t[Ua][o]);return new this.constructor({...t,...r,...e})}}vp.componentName="Component";vp.defaultProps={};const TF=Object.freeze({});class SF{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||TF}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[sp]||this.component;const t=e[jo]||{},r=e[Ua]||e,o=e[dc]||{};for(const c in t){const d=t[c];this._createAsyncPropData(c,o[c]),this._updateAsyncProp(c,d),t[c]=this.getAsyncProp(c)}for(const c in r){const d=r[c];this._createAsyncPropData(c,o[c]),this._updateAsyncProp(c,d)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(rT(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const r=this.asyncProps[e];return t===r.resolvedValue||t===r.lastValue?!1:(r.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const r=this.asyncProps[e];r&&(t=this._postProcessValue(r,t),r.resolvedValue=t,r.pendingLoadCount++,r.resolvedLoadCount=r.pendingLoadCount)}_setAsyncPropValue(e,t,r){const o=this.asyncProps[e];o&&r>=o.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),o.resolvedValue=t,o.resolvedLoadCount=r,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const r=this.asyncProps[e];if(r){r.pendingLoadCount++;const o=r.pendingLoadCount;t.then(c=>{this.component&&(c=this._postProcessValue(r,c),this._setAsyncPropValue(e,c,o),this._onResolve(e,c))}).catch(c=>{this._onError(e,c)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}const r=this.asyncProps[e];if(!r)return;r.pendingLoadCount++;const o=r.pendingLoadCount;let c=[],d=0;for await(const a of t){if(!this.component)return;const{dataTransform:y}=this.component.props;y?c=y(a,c):c=c.concat(a),Object.defineProperty(c,"__diff",{enumerable:!1,value:[{startRow:d,endRow:c.length}]}),d=c.length,this._setAsyncPropValue(e,c,o)}this._onResolve(e,c)}_postProcessValue(e,t){const r=e.type;return r&&this.component&&(r.release&&r.release(e.resolvedValue,r,this.component),r.transform)?r.transform(t,r,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const o=this.component&&this.component.props[Ho];this.asyncProps[e]={type:o&&o[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class EF extends SF{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const r=this.layer,o=r?.props.fetch;return o?o(t,{propName:e,layer:r}):super._fetch(e,t)}_onResolve(e,t){const r=this.layer;if(r){const o=r.props.onDataLoad;e==="data"&&o&&o(t,{propName:e,layer:r})}}_onError(e,t){const r=this.layer;r&&r.raiseError(t,`loading ${e} of ${this.layer}`)}}const AF="layer.changeFlag",PF="layer.initialize",CF="layer.update",IF="layer.finalize",MF="layer.matched",m0=2**24-1,RF=Object.freeze([]),kF=Dh(({oldViewport:i,viewport:e})=>i.equals(e));let Gn=new Uint8ClampedArray(0);const DF={data:{type:"data",value:RF,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:i=>i&&i.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(i,{propName:e,layer:t,loaders:r,loadOptions:o,signal:c})=>{const{resourceManager:d}=t.context;o=o||t.getLoadOptions(),r=r||t.props.loaders,c&&(o={...o,fetch:{...o?.fetch,signal:c}});let a=d.contains(i);return!a&&!o&&(d.add({resourceId:i,data:Wf(i,r),persistent:!1}),a=!0),a?d.subscribe({resourceId:i,onChange:y=>t.internalState?.reloadAsyncProp(e,y),consumerId:t.id,requestId:e}):Wf(i,r,o)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:hi.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:i})=>[0,-i*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class qo extends vp{constructor(){super(...arguments),this.internalState=null,this.lifecycle=rc.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){ur(this.internalState);const t=this.internalState.viewport||this.context.viewport,r=F1(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[o,c,d]=k1(r,t.pixelProjectionMatrix);return e.length===2?[o,c]:[o,c,d]}unproject(e){return ur(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){ur(this.internalState);const r=this.internalState.viewport||this.context.viewport;return dk(e,{viewport:r,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===hi.DEFAULT||e===hi.LNGLAT||e===hi.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){ur(e instanceof Uint8Array);const[t,r,o]=e;return t+r*256+o*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:sF(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(e){e=g0(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=g0(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:r}=e.changeFlags;if(r&&t)if(Array.isArray(r))for(const o of r)t.invalidateAll(o);else t.invalidateAll();if(t){const{props:o}=e,c=this.internalState.hasPickingBuffer,d=Number.isInteger(o.highlightedObjectIndex)||o.pickable||o.extensions.some(a=>a.getNeedsPickingBuffer.call(this,a));if(c!==d){this.internalState.hasPickingBuffer=d;const{pickingColors:a,instancePickingColors:y}=t.attributes,w=a||y;w&&(d&&w.constant&&(w.constant=!1,t.invalidate(w.id)),!w.value&&!d&&(w.constant=!0,w.value=[0,0,0]))}}}finalizeState(e){for(const r of this.getModels())r.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:r}){const{index:o}=e;return o>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[o]),e}raiseError(e,t){t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),this.props.onError?.(e)||this.context?.onError?.(e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,(!t||!kF({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const r in e)e[r].layoutChanged()&&(t=!0);for(const r of this.getModels())this._setModelAttributes(r,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,r=this.getNumInstances(),o=this.getStartIndices();e.update({data:t.data,numInstances:r,startIndices:o,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const c=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(c)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),r=Object.create(this.props);for(const o in t)Object.defineProperty(r,o,{value:t[o]});return r}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const r=Math.floor(Gn.length/4);if(this.internalState.usesPickingColorCache=!0,r<t){t>m0&&ii.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Gn=xc.allocate(Gn,t,{size:4,copy:!0,maxCount:Math.max(t,m0)});const o=Math.floor(Gn.length/4),c=[0,0,0];for(let d=r;d<o;d++)this.encodePickingColor(d,c),Gn[d*4+0]=c[0],Gn[d*4+1]=c[1],Gn[d*4+2]=c[2],Gn[d*4+3]=0}e.value=Gn.subarray(0,t*4)}_setModelAttributes(e,t,r=!1){if(!Object.keys(t).length)return;if(r){const a=this.getAttributeManager();e.setBufferLayout(a.getBufferLayouts(e)),t=a.getAttributes()}const o=e.userData?.excludeAttributes||{},c={},d={};for(const a in t){if(o[a])continue;const y=t[a].getValue();for(const w in y){const E=y[w];E instanceof Mi?t[a].settings.isIndexed?e.setIndexBuffer(E):c[w]=E:E&&(d[w]=E)}}e.setAttributes(c),e.setConstantAttributes(d)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}const{pickingColors:r,instancePickingColors:o}=this.getAttributeManager().attributes,c=r||o,d=c&&t.attributes&&t.attributes[c.id];if(d&&d.value){const a=d.value,y=this.encodePickingColor(e);for(let w=0;w<t.length;w++){const E=c.getVertexOffset(w);a[E]===y[0]&&a[E+1]===y[1]&&a[E+2]===y[2]&&this._disablePickingIndex(w)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:r}=this.getAttributeManager().attributes,o=t||r;if(!o)return;const c=o.getVertexOffset(e),d=o.getVertexOffset(e+1);o.buffer.write(new Uint8Array(d-c),c)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,r=e||t;r&&(this.internalState.usesPickingColorCache&&r.value.buffer!==Gn.buffer&&(r.value=Gn.subarray(0,r.value.length)),r.updateSubBuffer({startOffset:0}))}_initialize(){ur(!this.internalState),ur(Number.isFinite(this.props.coordinateSystem)),Nr(PF,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new EF({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(ii.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new YL(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){Nr(MF,this,this===e);const{state:t,internalState:r}=e;this!==e&&(this.internalState=r,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(Nr(CF,this,e),!e)return;const t=this.props,r=this.context,o=this.internalState,c=r.viewport,d=this._updateUniformTransition();o.propsInTransition=d,r.viewport=o.viewport||c,this.props=d;try{const a=this._getUpdateParams(),y=this.getModels();if(r.device)this.updateState(a);else try{this.updateState(a)}catch{}for(const E of this.props.extensions)E.updateState.call(this,a,E);this.setNeedsRedraw(),this._updateAttributes();const w=this.getModels()[0]!==y[0];this._postUpdate(a,w)}finally{r.viewport=c,this.props=t,this._clearChangeFlags(),o.needsUpdate=!1,o.resetOldProps()}}_finalize(){Nr(IF,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:r={},parameters:o={}}){this._updateAttributeTransition();const c=this.props,d=this.context;this.props=this.internalState.propsInTransition||c;try{t&&this.setShaderModuleProps(t);const{getPolygonOffset:a}=this.props,y=a&&a(r)||[0,0];d.device instanceof c_&&d.device.setParametersWebGL({polygonOffset:y});for(const w of this.getModels())w.device.type==="webgpu"?w.setParameters({...w.parameters,...o}):w.setParameters(o);if(d.device instanceof c_)d.device.withParametersWebGL(o,()=>{const w={renderPass:e,shaderModuleProps:t,uniforms:r,parameters:o,context:d};for(const E of this.props.extensions)E.draw.call(this,w,E);this.draw(w)});else{const w={renderPass:e,shaderModuleProps:t,uniforms:r,parameters:o,context:d};for(const E of this.props.extensions)E.draw.call(this,w,E);this.draw(w)}}finally{this.props=c}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const o in e)if(e[o]){let c=!1;switch(o){case"dataChanged":const d=e[o],a=t[o];d&&Array.isArray(a)&&(t.dataChanged=Array.isArray(d)?a.concat(d):d,c=!0);default:t[o]||(t[o]=e[o],c=!0)}c&&Nr(AF,this,o,e)}const r=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=r,t.somethingChanged=r||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){const r=JL(e,t);if(r.updateTriggersChanged)for(const o in r.updateTriggersChanged)r.updateTriggersChanged[o]&&this.invalidateAttribute(o);if(r.transitionsChanged)for(const o in r.transitionsChanged)this.internalState.uniformTransitions.add(o,t[o],e[o],e.transitions?.[o]);return this.setChangeFlags(r)}validateProps(){KL(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:r}=this.props;e.picked&&typeof r=="function"&&(t.highlightColor=r(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new HL(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:r,oldProps:o}=e,c=this.state.model;c?.isInstanced&&c.setInstanceCount(this.getNumInstances());const{autoHighlight:d,highlightedObjectIndex:a,highlightColor:y}=r;if(t||o.autoHighlight!==d||o.highlightedObjectIndex!==a||o.highlightColor!==y){const w={};Array.isArray(y)&&(w.highlightColor=y),(t||o.autoHighlight!==d||a!==o.highlightedObjectIndex)&&(w.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:w})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const r=this.getAttributeManager(),o=r?r.getNeedsRedraw(e):!1;if(t=t||o,t)for(const c of this.props.extensions)c.onNeedsRedraw.call(this,c);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}qo.defaultProps=DF;qo.layerName="Layer";const OF="compositeLayer.renderLayers";class uy extends qo{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){const{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){const{_subLayerProps:r}=this.props;return r&&r[e]&&r[e].type||t}getSubLayerRow(e,t,r){return e.__source={parent:this,object:t,index:r},e}getSubLayerAccessor(e){if(typeof e=="function"){const t={index:-1,data:this.props.data,target:[]};return(r,o)=>r&&r.__source?(t.index=r.__source.index,e(r.__source.object,t)):e(r,o)}return e}getSubLayerProps(e={}){const{opacity:t,pickable:r,visible:o,parameters:c,getPolygonOffset:d,highlightedObjectIndex:a,autoHighlight:y,highlightColor:w,coordinateSystem:E,coordinateOrigin:I,wrapLongitude:D,positionFormat:F,modelMatrix:X,extensions:oe,fetch:_e,operation:ge,_subLayerProps:fe}=this.props,Te={id:"",updateTriggers:{},opacity:t,pickable:r,visible:o,parameters:c,getPolygonOffset:d,highlightedObjectIndex:a,autoHighlight:y,highlightColor:w,coordinateSystem:E,coordinateOrigin:I,wrapLongitude:D,positionFormat:F,modelMatrix:X,extensions:oe,fetch:_e,operation:ge},ke=fe&&e.id&&fe[e.id],Je=ke&&ke.updateTriggers,Xe=e.id||"sublayer";if(ke){const mt=this.props[Ho],G=e.type?e.type._propTypes:{};for(const J in ke){const ae=G[J]||mt[J];ae&&ae.type==="accessor"&&(ke[J]=this.getSubLayerAccessor(ke[J]))}}Object.assign(Te,e,ke),Te.id=`${this.props.id}-${Xe}`,Te.updateTriggers={all:this.props.updateTriggers?.all,...e.updateTriggers,...Je};for(const mt of oe){const G=mt.getSubLayerProps.call(this,mt);G&&Object.assign(Te,G,{updateTriggers:Object.assign(Te.updateTriggers,G.updateTriggers)})}return Te}_updateAutoHighlight(e){for(const t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let r=this.internalState.subLayers;const o=!r||this.needsUpdate();if(o){const c=this.renderLayers();r=Va(c,Boolean),this.internalState.subLayers=r}Nr(OF,this,o,r);for(const c of r)c.parent=this}}uy.layerName="CompositeLayer";const ff=Math.PI/180,_0=180/Math.PI,Rf=6370972,cc=256;function LF(){const i=cc/Rf,e=Math.PI/180*cc;return{unitsPerMeter:[i,i,i],unitsPerMeter2:[0,0,0],metersPerUnit:[1/i,1/i,1/i],unitsPerDegree:[e,e,i],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/i]}}class FF extends Sc{constructor(e={}){const{longitude:t=0,zoom:r=0,nearZMultiplier:o=.5,farZMultiplier:c=1,resolution:d=10}=e;let{latitude:a=0,height:y,altitude:w=1.5,fovy:E}=e;a=Math.max(Math.min(a,Vo),-Vo),y=y||1,E?w=X_(E):E=wh(w);const I=1/Math.PI/Math.cos(a*Math.PI/180),D=Math.pow(2,r)*I,F=e.nearZ??o,X=e.farZ??(w+cc*2*D/y)*c,oe=new ts().lookAt({eye:[0,-w,0],up:[0,0,1]});oe.rotateX(a*ff),oe.rotateZ(-t*ff),oe.scale(D/y),super({...e,height:y,viewMatrix:oe,longitude:t,latitude:a,zoom:r,distanceScales:LF(),fovy:E,focalDistance:w,near:F,far:X}),this.scale=D,this.latitude=a,this.longitude=t,this.resolution=d}get projectionMode(){return vn.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){const t={targetZ:e.z||0},r=this.unproject([0,this.height/2],t),o=this.unproject([this.width/2,0],t),c=this.unproject([this.width,this.height/2],t),d=this.unproject([this.width/2,this.height],t);return c[0]<this.longitude&&(c[0]+=360),r[0]>this.longitude&&(r[0]-=360),[Math.min(r[0],c[0],o[0],d[0]),Math.min(r[1],c[1],o[1],d[1]),Math.max(r[0],c[0],o[0],d[0]),Math.max(r[1],c[1],o[1],d[1])]}unproject(e,{topLeft:t=!0,targetZ:r}={}){const[o,c,d]=e,a=t?c:this.height-c,{pixelUnprojectionMatrix:y}=this;let w;if(Number.isFinite(d))w=vm(y,[o,a,d,1]);else{const F=vm(y,[o,a,-1,1]),X=vm(y,[o,a,1,1]),oe=((r||0)/Rf+1)*cc,_e=tm(f1([],F,X)),ge=tm(F),fe=tm(X),ke=4*((4*ge*fe-(_e-ge-fe)**2)/16)/_e,Je=Math.sqrt(ge-ke),Xe=Math.sqrt(Math.max(0,oe*oe-ke)),mt=(Je-Xe)/Math.sqrt(_e);w=tI([],F,X,mt)}const[E,I,D]=this.unprojectPosition(w);return Number.isFinite(d)?[E,I,D]:Number.isFinite(r)?[E,I,r]:[E,I]}projectPosition(e){const[t,r,o=0]=e,c=t*ff,d=r*ff,a=Math.cos(d),y=(o/Rf+1)*cc;return[Math.sin(c)*a*y,-Math.cos(c)*a*y,Math.sin(d)*y]}unprojectPosition(e){const[t,r,o]=e,c=lI(e),d=Math.asin(o/c),y=Math.atan2(t,-r)*_0,w=d*_0,E=(c/cc-1)*Rf;return[y,w,E]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,t){const r=this.unproject(t);return{longitude:e[0]-r[0]+this.longitude,latitude:e[1]-r[1]+this.latitude}}}function vm(i,e){const t=Tc([],e,i);return m1(t,t,1/t[3]),t}class BF extends $1{applyConstraints(e){const{maxZoom:t,minZoom:r,zoom:o}=e;e.zoom=Es(o,r,t);const{longitude:c,latitude:d}=e;return(c<-180||c>180)&&(e.longitude=ik(c+180,360)-180),e.latitude=Es(d,-Vo,Vo),e}}class NF extends j1{constructor(){super(...arguments),this.ControllerState=BF,this.transition={transitionDuration:300,transitionInterpolator:new ey(["longitude","latitude","zoom"])},this.dragMode="pan"}setProps(e){super.setProps(e),this.dragRotate=!1,this.touchRotate=!1}}class mT extends V1{constructor(e={}){super(e)}getViewportType(e){return e.zoom>12?za:FF}get ControllerType(){return NF}}mT.displayName="GlobeView";class _T{constructor(e){this.indexStarts=[0],this.vertexStarts=[0],this.vertexCount=0,this.instanceCount=0;const{attributes:t={}}=e;this.typedArrayManager=xc,this.attributes={},this._attributeDefs=t,this.opts=e,this.updateGeometry(e)}updateGeometry(e){Object.assign(this.opts,e);const{data:t,buffers:r={},getGeometry:o,geometryBuffer:c,positionFormat:d,dataChanged:a,normalize:y=!0}=this.opts;if(this.data=t,this.getGeometry=o,this.positionSize=c&&c.size||(d==="XY"?2:3),this.buffers=r,this.normalize=y,c&&(ur(t.startIndices),this.getGeometry=this.getGeometryFromBuffer(c),y||(r.vertexPositions=c)),this.geometryBuffer=r.vertexPositions,Array.isArray(a))for(const w of a)this._rebuildGeometry(w);else this._rebuildGeometry()}updatePartialGeometry({startRow:e,endRow:t}){this._rebuildGeometry({startRow:e,endRow:t})}getGeometryFromBuffer(e){const t=e.value||e;return ArrayBuffer.isView(t)?nT(t,{size:this.positionSize,offset:e.offset,stride:e.stride,startIndices:this.data.startIndices}):null}_allocate(e,t){const{attributes:r,buffers:o,_attributeDefs:c,typedArrayManager:d}=this;for(const a in c)if(a in o)d.release(r[a]),r[a]=null;else{const y=c[a];y.copy=t,r[a]=d.allocate(r[a],e,y)}}_forEachGeometry(e,t,r){const{data:o,getGeometry:c}=this,{iterable:d,objectInfo:a}=xp(o,t,r);for(const y of d){a.index++;const w=c?c(y,a):null;e(w,a.index)}}_rebuildGeometry(e){if(!this.data)return;let{indexStarts:t,vertexStarts:r,instanceCount:o}=this;const{data:c,geometryBuffer:d}=this,{startRow:a=0,endRow:y=1/0}=e||{},w={};if(e||(t=[0],r=[0]),this.normalize||!d)this._forEachGeometry((I,D)=>{const F=I&&this.normalizeGeometry(I);w[D]=F,r[D+1]=r[D]+(F?this.getGeometrySize(F):0)},a,y),o=r[r.length-1];else if(r=c.startIndices,o=r[c.length]||0,ArrayBuffer.isView(d))o=o||d.length/this.positionSize;else if(d instanceof Mi){const I=this.positionSize*4;o=o||d.byteLength/I}else if(d.buffer){const I=d.stride||this.positionSize*4;o=o||d.buffer.byteLength/I}else if(d.value){const I=d.value,D=d.stride/I.BYTES_PER_ELEMENT||this.positionSize;o=o||I.length/D}this._allocate(o,!!e),this.indexStarts=t,this.vertexStarts=r,this.instanceCount=o;const E={};this._forEachGeometry((I,D)=>{const F=w[D]||I;E.vertexStart=r[D],E.indexStart=t[D];const X=D<r.length-1?r[D+1]:o;E.geometrySize=X-r[D],E.geometryIndex=D,this.updateGeometryAttributes(F,E)},a,y),this.vertexCount=t[t.length-1]}}const y0=`uniform iconUniforms {
  float sizeScale;
  vec2 iconsTextureDim;
  float sizeBasis;
  float sizeMinPixels;
  float sizeMaxPixels;
  bool billboard;
  highp int sizeUnits;
  float alphaCutoff;
} icon;
`,zF={name:"icon",vs:y0,fs:y0,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeBasis:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},UF=`#version 300 es
#define SHADER_NAME icon-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;
out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = angle * PI / 180.0;
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vec2 iconSize = instanceIconFrames.zw;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),
icon.sizeMinPixels, icon.sizeMaxPixels
);
float iconConstraint = icon.sizeBasis == 0.0 ? iconSize.x : iconSize.y;
float instanceScale = iconConstraint == 0.0 ? 0.0 : sizePixels / iconConstraint;
vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
pixelOffset += instancePixelOffset;
pixelOffset.y *= -1.0;
if (icon.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vTextureCoords = mix(
instanceIconFrames.xy,
instanceIconFrames.xy + iconSize,
(positions.xy + 1.0) / 2.0
) / icon.iconsTextureDim;
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
vColorMode = instanceColorModes;
}
`,VF=`#version 300 es
#define SHADER_NAME icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec4 texColor = texture(iconsTexture, vTextureCoords);
vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
float a = texColor.a * layer.opacity * vColor.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color, a);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,jF=1024,$F=4,x0=()=>{},v0={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},WF={x:0,y:0,width:0,height:0};function HF(i){return Math.pow(2,Math.ceil(Math.log2(i)))}function ZF(i,e,t,r){const o=Math.min(t/e.width,r/e.height),c=Math.floor(e.width*o),d=Math.floor(e.height*o);return o===1?{image:e,width:c,height:d}:(i.canvas.height=d,i.canvas.width=c,i.clearRect(0,0,c,d),i.drawImage(e,0,0,e.width,e.height,0,0,c,d),{image:i.canvas,width:c,height:d})}function Eh(i){return i&&(i.id||i.url)}function qF(i,e,t,r){const{width:o,height:c,device:d}=i,a=d.createTexture({format:"rgba8unorm",width:e,height:t,sampler:r,mipLevels:d.getMipLevelCount(e,t)}),y=d.createCommandEncoder();return y.copyTextureToTexture({sourceTexture:i,destinationTexture:a,width:o,height:c}),y.finish(),a.generateMipmapsWebGL(),i.destroy(),a}function b0(i,e,t){for(let r=0;r<e.length;r++){const{icon:o,xOffset:c}=e[r],d=Eh(o);i[d]={...o,x:c,y:t}}}function XF({icons:i,buffer:e,mapping:t={},xOffset:r=0,yOffset:o=0,rowHeight:c=0,canvasWidth:d}){let a=[];for(let y=0;y<i.length;y++){const w=i[y],E=Eh(w);if(!t[E]){const{height:I,width:D}=w;r+D+e>d&&(b0(t,a,o),r=0,o=c+o+e,c=0,a=[]),a.push({icon:w,xOffset:r}),r=r+D+e,c=Math.max(c,I)}}return a.length>0&&b0(t,a,o),{mapping:t,rowHeight:c,xOffset:r,yOffset:o,canvasWidth:d,canvasHeight:HF(c+o+e)}}function GF(i,e,t){if(!i||!e)return null;t=t||{};const r={},{iterable:o,objectInfo:c}=xp(i);for(const d of o){c.index++;const a=e(d,c),y=Eh(a);if(!a)throw new Error("Icon is missing.");if(!a.url)throw new Error("Icon url is missing.");!r[y]&&(!t[y]||a.url!==t[y].url)&&(r[y]={...a,source:d,sourceIndex:c.index})}return r}class YF{constructor(e,{onUpdate:t=x0,onError:r=x0}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=$F,this._canvasWidth=jF,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=t,this.onError=r}finalize(){this._texture?.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){const t=this._autoPacking?Eh(e):e;return this._mapping[t]||WF}setProps({loadOptions:e,autoPacking:t,iconAtlas:r,iconMapping:o,textureParameters:c}){e&&(this._loadOptions=e),t!==void 0&&(this._autoPacking=t),o&&(this._mapping=o),r&&(this._texture?.delete(),this._texture=null,this._externalTexture=r),c&&(this._samplerParameters=c)}get isLoaded(){return this._pendingCount===0}packIcons(e,t){if(!this._autoPacking||typeof document>"u")return;const r=Object.values(GF(e,t,this._mapping)||{});if(r.length>0){const{mapping:o,xOffset:c,yOffset:d,rowHeight:a,canvasHeight:y}=XF({icons:r,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=a,this._mapping=o,this._xOffset=c,this._yOffset=d,this._canvasHeight=y,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",data:null,width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||v0,mipLevels:this.device.getMipLevelCount(this._canvasWidth,this._canvasHeight)})),this._texture.height!==this._canvasHeight&&(this._texture=qF(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||v0)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(r),this._texture?.generateMipmapsWebGL()}}_loadIcons(e){const t=this._canvas.getContext("2d",{willReadFrequently:!0});for(const r of e)this._pendingCount++,Wf(r.url,this._loadOptions).then(o=>{const c=Eh(r),d=this._mapping[c],{x:a,y,width:w,height:E}=d,{image:I,width:D,height:F}=ZF(t,o,w,E);this._texture?.copyExternalImage({image:I,x:a+(w-D)/2,y:y+(E-F)/2,width:D,height:F}),d.width=D,d.height=F,this._texture?.generateMipmapsWebGL(),this.onUpdate()}).catch(o=>{this.onError({url:r.url,source:r.source,sourceIndex:r.sourceIndex,loadOptions:this._loadOptions,error:o})}).finally(()=>{this._pendingCount--})}}const yT=[0,0,0,255],KF={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeBasis:"height",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:i=>i.position},getIcon:{type:"accessor",value:i=>i.icon},getColor:{type:"accessor",value:yT},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class bp extends qo{getShaders(){return super.getShaders({vs:UF,fs:VF,modules:[Oh,Lh,zF]})}initializeState(){this.state={iconManager:new YF(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:yT},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);const{props:t,oldProps:r,changeFlags:o}=e,c=this.getAttributeManager(),{iconAtlas:d,iconMapping:a,data:y,getIcon:w,textureParameters:E}=t,{iconManager:I}=this.state;if(typeof d=="string")return;const D=d||this.internalState.isAsyncPropLoading("iconAtlas");I.setProps({loadOptions:t.loadOptions,autoPacking:!D,iconAtlas:d,iconMapping:D?a:null,textureParameters:E}),D?r.iconMapping!==t.iconMapping&&c.invalidate("getIcon"):(o.dataChanged||o.updateTriggersChanged&&(o.updateTriggersChanged.all||o.updateTriggersChanged.getIcon))&&I.packIcons(y,w),o.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),c.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){const{sizeScale:t,sizeBasis:r,sizeMinPixels:o,sizeMaxPixels:c,sizeUnits:d,billboard:a,alphaCutoff:y}=this.props,{iconManager:w}=this.state,E=w.getTexture();if(E){const I=this.state.model,D={iconsTexture:E,iconsTextureDim:[E.width,E.height],sizeUnits:ro[d],sizeScale:t,sizeBasis:r==="height"?1:0,sizeMinPixels:o,sizeMaxPixels:c,billboard:a,alphaCutoff:y};I.shaderInputs.setProps({icon:D}),I.draw(this.context.renderPass)}}_getModel(){const e=[-1,-1,1,-1,-1,1,1,1];return new es(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new bc({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){const t=this.getCurrentLayer()?.props.onIconError;t?t(e):ii.error(e.error.message)()}getInstanceOffset(e){const{width:t,height:r,anchorX:o=t/2,anchorY:c=r/2}=this.state.iconManager.getIconMapping(e);return[t/2-o,r/2-c]}getInstanceColorMode(e){return this.state.iconManager.getIconMapping(e).mask?1:0}getInstanceIconFrame(e){const{x:t,y:r,width:o,height:c}=this.state.iconManager.getIconMapping(e);return[t,r,o,c]}}bp.defaultProps=KF;bp.layerName="IconLayer";const w0=`uniform scatterplotUniforms {
  float radiusScale;
  float radiusMinPixels;
  float radiusMaxPixels;
  float lineWidthScale;
  float lineWidthMinPixels;
  float lineWidthMaxPixels;
  float stroked;
  float filled;
  bool antialiasing;
  bool billboard;
  highp int radiusUnits;
  highp int lineWidthUnits;
} scatterplot;
`,JF={name:"scatterplot",vs:w0,fs:w0,source:"",uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},QF=`#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),
scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),
scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
);
outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
float edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;
if (scatterplot.billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,e4=`#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = scatterplot.antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (scatterplot.stroked > 0.5) {
float isLine = scatterplot.antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (scatterplot.filled > 0.5) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (scatterplot.filled < 0.5) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,t4=`// Main shaders

struct ScatterplotUniforms {
  radiusScale: f32,
  radiusMinPixels: f32,
  radiusMaxPixels: f32,
  lineWidthScale: f32,
  lineWidthMinPixels: f32,
  lineWidthMaxPixels: f32,
  stroked: f32,
  filled: i32,
  antialiasing: i32,
  billboard: i32,
  radiusUnits: i32,
  lineWidthUnits: i32,
};

struct ConstantAttributeUniforms {
 instancePositions: vec3<f32>,
 instancePositions64Low: vec3<f32>,
 instanceRadius: f32,
 instanceLineWidths: f32,
 instanceFillColors: vec4<f32>,
 instanceLineColors: vec4<f32>,
 instancePickingColors: vec3<f32>,

 instancePositionsConstant: i32,
 instancePositions64LowConstant: i32,
 instanceRadiusConstant: i32,
 instanceLineWidthsConstant: i32,
 instanceFillColorsConstant: i32,
 instanceLineColorsConstant: i32,
 instancePickingColorsConstant: i32
};

@group(0) @binding(2) var<uniform> scatterplot: ScatterplotUniforms;

struct ConstantAttributes {
  instancePositions: vec3<f32>,
  instancePositions64Low: vec3<f32>,
  instanceRadius: f32,
  instanceLineWidths: f32,
  instanceFillColors: vec4<f32>,
  instanceLineColors: vec4<f32>,
  instancePickingColors: vec3<f32>
};

const constants = ConstantAttributes(
  vec3<f32>(0.0),
  vec3<f32>(0.0),
  0.0,
  0.0,
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec3<f32>(0.0)
);

struct Attributes {
  @builtin(instance_index) instanceIndex : u32,
  @builtin(vertex_index) vertexIndex : u32,
  @location(0) positions: vec3<f32>,
  @location(1) instancePositions: vec3<f32>,
  @location(2) instancePositions64Low: vec3<f32>,
  @location(3) instanceRadius: f32,
  @location(4) instanceLineWidths: f32,
  @location(5) instanceFillColors: vec4<f32>,
  @location(6) instanceLineColors: vec4<f32>,
  @location(7) instancePickingColors: vec3<f32>
};

struct Varyings {
  @builtin(position) position: vec4<f32>,
  @location(0) vFillColor: vec4<f32>,
  @location(1) vLineColor: vec4<f32>,
  @location(2) unitPosition: vec2<f32>,
  @location(3) innerUnitRadius: f32,
  @location(4) outerRadiusPixels: f32,
};

@vertex
fn vertexMain(attributes: Attributes) -> Varyings {
  var varyings: Varyings;

  // Draw an inline geometry constant array clip space triangle to verify that rendering works.
  // var positions = array<vec2<f32>, 3>(vec2(0.0, 0.5), vec2(-0.5, -0.5), vec2(0.5, -0.5));
  // if (attributes.instanceIndex == 0) {
  //   varyings.position = vec4<f32>(positions[attributes.vertexIndex], 0.0, 1.0);
  //   return varyings;
  // }

  // var geometry: Geometry;
  // geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  varyings.outerRadiusPixels = clamp(
    project_unit_size_to_pixel(scatterplot.radiusScale * attributes.instanceRadius, scatterplot.radiusUnits),
    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
  );

  // Multiply out line width and clamp to limits
  let lineWidthPixels = clamp(
    project_unit_size_to_pixel(scatterplot.lineWidthScale * attributes.instanceLineWidths, scatterplot.lineWidthUnits),
    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  varyings.outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
  // Expand geometry to accommodate edge smoothing
  let edgePadding = select(
    (varyings.outerRadiusPixels + SMOOTH_EDGE_RADIUS) / varyings.outerRadiusPixels,
    1.0,
    scatterplot.antialiasing != 0
  );

  // position on the containing square in [-1, 1] space
  varyings.unitPosition = edgePadding * attributes.positions.xy;
  geometry.uv = varyings.unitPosition;
  geometry.pickingColor = attributes.instancePickingColors;

  varyings.innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / varyings.outerRadiusPixels;

  if (scatterplot.billboard != 0) {
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, vec3<f32>(0.0)); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
    let offset = attributes.positions; // * edgePadding * varyings.outerRadiusPixels;
    // DECKGL_FILTER_SIZE(offset, geometry);
    let clipPixels = project_pixel_size_to_clipspace(offset.xy);
    varyings.position.x = clipPixels.x;
    varyings.position.y = clipPixels.y;
  } else {
    let offset = edgePadding * attributes.positions * project_pixel_size_float(varyings.outerRadiusPixels);
    // DECKGL_FILTER_SIZE(offset, geometry);
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, offset); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  varyings.vFillColor = vec4<f32>(attributes.instanceFillColors.rgb, attributes.instanceFillColors.a * color.opacity);
  // DECKGL_FILTER_COLOR(varyings.vFillColor, geometry);
  varyings.vLineColor = vec4<f32>(attributes.instanceLineColors.rgb, attributes.instanceLineColors.a * color.opacity);
  // DECKGL_FILTER_COLOR(varyings.vLineColor, geometry);

  return varyings;
}

@fragment
fn fragmentMain(varyings: Varyings) -> @location(0) vec4<f32> {
  // var geometry: Geometry;
  // geometry.uv = unitPosition;

  let distToCenter = length(varyings.unitPosition) * varyings.outerRadiusPixels;
  let inCircle = select(
    smoothedge(distToCenter, varyings.outerRadiusPixels),
    step(distToCenter, varyings.outerRadiusPixels),
    scatterplot.antialiasing != 0
  );

  if (inCircle == 0.0) {
    discard;
  }

  var fragColor: vec4<f32>;

  if (scatterplot.stroked != 0) {
    let isLine = select(
      smoothedge(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      step(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      scatterplot.antialiasing != 0
    );

    if (scatterplot.filled != 0) {
      fragColor = mix(varyings.vFillColor, varyings.vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      fragColor = vec4<f32>(varyings.vLineColor.rgb, varyings.vLineColor.a * isLine);
    }
  } else if (scatterplot.filled == 0) {
    discard;
  } else {
    fragColor = varyings.vFillColor;
  }

  fragColor.a *= inCircle;
  // DECKGL_FILTER_COLOR(fragColor, geometry);

  // Apply premultiplied alpha as required by transparent canvas
  fragColor = deckgl_premultiplied_alpha(fragColor);

  return fragColor;
  // return vec4<f32>(0, 0, 1, 1);
}
`,T0=[0,0,0,255],i4={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:i=>i.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:T0},getLineColor:{type:"accessor",value:T0},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class hy extends qo{getShaders(){return super.getShaders({vs:QF,fs:e4,source:t4,modules:[Oh,KI,Lh,JF]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e),e.changeFlags.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{radiusUnits:t,radiusScale:r,radiusMinPixels:o,radiusMaxPixels:c,stroked:d,filled:a,billboard:y,antialiasing:w,lineWidthUnits:E,lineWidthScale:I,lineWidthMinPixels:D,lineWidthMaxPixels:F}=this.props,X={stroked:d,filled:a,billboard:y,antialiasing:w,radiusUnits:ro[t],radiusScale:r,radiusMinPixels:o,radiusMaxPixels:c,lineWidthUnits:ro[E],lineWidthScale:I,lineWidthMinPixels:D,lineWidthMaxPixels:F},oe=this.state.model;oe.shaderInputs.setProps({scatterplot:X}),this.context.device.type==="webgpu"&&(oe.instanceCount=this.props.data.length),oe.draw(this.context.renderPass)}_getModel(){const e=this.context.device.type==="webgpu"?{depthWriteEnabled:!0,depthCompare:"less-equal"}:void 0,t=[-1,-1,0,1,-1,0,-1,1,0,1,1,0];return new es(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new bc({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0,parameters:e})}}hy.defaultProps=i4;hy.layerName="ScatterplotLayer";const xT={CLOCKWISE:1,COUNTER_CLOCKWISE:-1};function vT(i,e,t={}){return r4(i,t)!==e?(s4(i,t),!0):!1}function r4(i,e={}){return Math.sign(n4(i,e))}const S0={x:0,y:1,z:2};function n4(i,e={}){const{start:t=0,end:r=i.length,plane:o="xy"}=e,c=e.size||2;let d=0;const a=S0[o[0]],y=S0[o[1]];for(let w=t,E=r-c;w<r;w+=c)d+=(i[w+a]-i[E+a])*(i[w+y]+i[E+y]),E=w;return d/2}function s4(i,e){const{start:t=0,end:r=i.length,size:o=2}=e,c=(r-t)/o,d=Math.floor(c/2);for(let a=0;a<d;++a){const y=t+a*o,w=t+(c-1-a)*o;for(let E=0;E<o;++E){const I=i[y+E];i[y+E]=i[w+E],i[w+E]=I}}}function Qn(i,e){const t=e.length,r=i.length;if(r>0){let o=!0;for(let c=0;c<t;c++)if(i[r-t+c]!==e[c]){o=!1;break}if(o)return!1}for(let o=0;o<t;o++)i[r+o]=e[o];return!0}function g_(i,e){const t=e.length;for(let r=0;r<t;r++)i[r]=e[r]}function Ah(i,e,t,r,o=[]){const c=r+e*t;for(let d=0;d<t;d++)o[d]=i[c+d];return o}function m_(i,e,t,r,o=[]){let c,d;if(t&8)c=(r[3]-i[1])/(e[1]-i[1]),d=3;else if(t&4)c=(r[1]-i[1])/(e[1]-i[1]),d=1;else if(t&2)c=(r[2]-i[0])/(e[0]-i[0]),d=2;else if(t&1)c=(r[0]-i[0])/(e[0]-i[0]),d=0;else return null;for(let a=0;a<i.length;a++)o[a]=(d&1)===a?r[d]:c*(e[a]-i[a])+i[a];return o}function kf(i,e){let t=0;return i[0]<e[0]?t|=1:i[0]>e[2]&&(t|=2),i[1]<e[1]?t|=4:i[1]>e[3]&&(t|=8),t}function bT(i,e){const{size:t=2,broken:r=!1,gridResolution:o=10,gridOffset:c=[0,0],startIndex:d=0,endIndex:a=i.length}=e||{},y=(a-d)/t;let w=[];const E=[w],I=Ah(i,0,t,d);let D,F;const X=TT(I,o,c,[]),oe=[];Qn(w,I);for(let _e=1;_e<y;_e++){for(D=Ah(i,_e,t,d,D),F=kf(D,X);F;){m_(I,D,F,X,oe);const ge=kf(oe,X);ge&&(m_(I,oe,ge,X,oe),F=ge),Qn(w,oe),g_(I,oe),a4(X,o,F),r&&w.length>t&&(w=[],E.push(w),Qn(w,I)),F=kf(D,X)}Qn(w,D),g_(I,D)}return r?E:E[0]}const E0=0,o4=1;function wT(i,e=null,t){if(!i.length)return[];const{size:r=2,gridResolution:o=10,gridOffset:c=[0,0],edgeTypes:d=!1}=t||{},a=[],y=[{pos:i,types:d?new Array(i.length/r).fill(o4):null,holes:e||[]}],w=[[],[]];let E=[];for(;y.length;){const{pos:I,types:D,holes:F}=y.shift();l4(I,r,F[0]||I.length,w),E=TT(w[0],o,c,E);const X=kf(w[1],E);if(X){let oe=A0(I,D,r,0,F[0]||I.length,E,X);const _e={pos:oe[0].pos,types:oe[0].types,holes:[]},ge={pos:oe[1].pos,types:oe[1].types,holes:[]};y.push(_e,ge);for(let fe=0;fe<F.length;fe++)oe=A0(I,D,r,F[fe],F[fe+1]||I.length,E,X),oe[0]&&(_e.holes.push(_e.pos.length),_e.pos=pf(_e.pos,oe[0].pos),d&&(_e.types=pf(_e.types,oe[0].types))),oe[1]&&(ge.holes.push(ge.pos.length),ge.pos=pf(ge.pos,oe[1].pos),d&&(ge.types=pf(ge.types,oe[1].types)))}else{const oe={positions:I};d&&(oe.edgeTypes=D),F.length&&(oe.holeIndices=F),a.push(oe)}}return a}function A0(i,e,t,r,o,c,d){const a=(o-r)/t,y=[],w=[],E=[],I=[],D=[];let F,X,oe;const _e=Ah(i,a-1,t,r);let ge=Math.sign(d&8?_e[1]-c[3]:_e[0]-c[2]),fe=e&&e[a-1],Te=0,ke=0;for(let Je=0;Je<a;Je++)F=Ah(i,Je,t,r,F),X=Math.sign(d&8?F[1]-c[3]:F[0]-c[2]),oe=e&&e[r/t+Je],X&&ge&&ge!==X&&(m_(_e,F,d,c,D),Qn(y,D)&&E.push(fe),Qn(w,D)&&I.push(fe)),X<=0?(Qn(y,F)&&E.push(oe),Te-=X):E.length&&(E[E.length-1]=E0),X>=0?(Qn(w,F)&&I.push(oe),ke+=X):I.length&&(I[I.length-1]=E0),g_(_e,F),ge=X,fe=oe;return[Te?{pos:y,types:e&&E}:null,ke?{pos:w,types:e&&I}:null]}function TT(i,e,t,r){const o=Math.floor((i[0]-t[0])/e)*e+t[0],c=Math.floor((i[1]-t[1])/e)*e+t[1];return r[0]=o,r[1]=c,r[2]=o+e,r[3]=c+e,r}function a4(i,e,t){t&8?(i[1]+=e,i[3]+=e):t&4?(i[1]-=e,i[3]-=e):t&2?(i[0]+=e,i[2]+=e):t&1&&(i[0]-=e,i[2]-=e)}function l4(i,e,t,r){let o=1/0,c=-1/0,d=1/0,a=-1/0;for(let y=0;y<t;y+=e){const w=i[y],E=i[y+1];o=w<o?w:o,c=w>c?w:c,d=E<d?E:d,a=E>a?E:a}return r[0][0]=o,r[0][1]=d,r[1][0]=c,r[1][1]=a,r}function pf(i,e){for(let t=0;t<e.length;t++)i.push(e[t]);return i}const c4=85.051129;function u4(i,e){const{size:t=2,startIndex:r=0,endIndex:o=i.length,normalize:c=!0}=e||{},d=i.slice(r,o);ST(d,t,0,o-r);const a=bT(d,{size:t,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(c)for(const y of a)ET(y,t);return a}function h4(i,e=null,t){const{size:r=2,normalize:o=!0,edgeTypes:c=!1}=t||{};e=e||[];const d=[],a=[];let y=0,w=0;for(let I=0;I<=e.length;I++){const D=e[I]||i.length,F=w,X=d4(i,r,y,D);for(let oe=X;oe<D;oe++)d[w++]=i[oe];for(let oe=y;oe<X;oe++)d[w++]=i[oe];ST(d,r,F,w),f4(d,r,F,w,t?.maxLatitude),y=D,a[I]=w}a.pop();const E=wT(d,a,{size:r,gridResolution:360,gridOffset:[-180,-180],edgeTypes:c});if(o)for(const I of E)ET(I.positions,r);return E}function d4(i,e,t,r){let o=-1,c=-1;for(let d=t+1;d<r;d+=e){const a=Math.abs(i[d]);a>o&&(o=a,c=d-1)}return c}function f4(i,e,t,r,o=c4){const c=i[t],d=i[r-e];if(Math.abs(c-d)>180){const a=Ah(i,0,e,t);a[0]+=Math.round((d-c)/360)*360,Qn(i,a),a[1]=Math.sign(a[1])*o,Qn(i,a),a[0]=c,Qn(i,a)}}function ST(i,e,t,r){let o=i[0],c;for(let d=t;d<r;d+=e){c=i[d];const a=c-o;(a>180||a<-180)&&(c-=Math.round(a/360)*360),i[d]=o=c}}function ET(i,e){let t;const r=i.length/e;for(let c=0;c<r&&(t=i[c*e],(t+180)%360===0);c++);const o=-Math.round(t/360)*360;if(o!==0)for(let c=0;c<r;c++)i[c*e]+=o}function p4(i,e,t,r){let o;if(Array.isArray(i[0])){const c=i.length*e;o=new Array(c);for(let d=0;d<i.length;d++)for(let a=0;a<e;a++)o[d*e+a]=i[d][a]||0}else o=i;return t?bT(o,{size:e,gridResolution:t}):r?u4(o,{size:e}):o}const g4=1,m4=2,bm=4;class _4 extends _T{constructor(e){super({...e,attributes:{positions:{size:3,padding:18,initialize:!0,type:e.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(e){return this.attributes[e]}getGeometryFromBuffer(e){return this.normalize?super.getGeometryFromBuffer(e):null}normalizeGeometry(e){return this.normalize?p4(e,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):e}getGeometrySize(e){if(P0(e)){let r=0;for(const o of e)r+=this.getGeometrySize(o);return r}const t=this.getPathLength(e);return t<2?0:this.isClosed(e)?t<3?0:t+2:t}updateGeometryAttributes(e,t){if(t.geometrySize!==0)if(e&&P0(e))for(const r of e){const o=this.getGeometrySize(r);t.geometrySize=o,this.updateGeometryAttributes(r,t),t.vertexStart+=o}else this._updateSegmentTypes(e,t),this._updatePositions(e,t)}_updateSegmentTypes(e,t){const r=this.attributes.segmentTypes,o=e?this.isClosed(e):!1,{vertexStart:c,geometrySize:d}=t;r.fill(0,c,c+d),o?(r[c]=bm,r[c+d-2]=bm):(r[c]+=g4,r[c+d-2]+=m4),r[c+d-1]=bm}_updatePositions(e,t){const{positions:r}=this.attributes;if(!r||!e)return;const{vertexStart:o,geometrySize:c}=t,d=new Array(3);for(let a=o,y=0;y<c;a++,y++)this.getPointOnPath(e,y,d),r[a*3]=d[0],r[a*3+1]=d[1],r[a*3+2]=d[2]}getPathLength(e){return e.length/this.positionSize}getPointOnPath(e,t,r=[]){const{positionSize:o}=this;t*o>=e.length&&(t+=1-e.length/o);const c=t*o;return r[0]=e[c],r[1]=e[c+1],r[2]=o===3&&e[c+2]||0,r}isClosed(e){if(!this.normalize)return!!this.opts.loop;const{positionSize:t}=this,r=e.length-t;return e[0]===e[r]&&e[1]===e[r+1]&&(t===2||e[2]===e[r+2])}}function P0(i){return Array.isArray(i[0])}const C0=`uniform pathUniforms {
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  float jointType;
  float capType;
  float miterLimit;
  bool billboard;
  highp int widthUnits;
} path;
`,y4={name:"path",vs:C0,fs:C0,uniformTypes:{widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",jointType:"f32",capType:"f32",miterLimit:"f32",billboard:"f32",widthUnits:"i32"}},x4=`#version 300 es
#define SHADER_NAME path-layer-vertex-shader
in vec2 positions;
in float instanceTypes;
in vec3 instanceStartPositions;
in vec3 instanceEndPositions;
in vec3 instanceLeftPositions;
in vec3 instanceRightPositions;
in vec3 instanceLeftPositions64Low;
in vec3 instanceStartPositions64Low;
in vec3 instanceEndPositions64Low;
in vec3 instanceRightPositions64Low;
in float instanceStrokeWidths;
in vec4 instanceColors;
in vec3 instancePickingColors;
uniform float opacity;
out vec4 vColor;
out vec2 vCornerOffset;
out float vMiterLength;
out vec2 vPathPosition;
out float vPathLength;
out float vJointType;
const float EPSILON = 0.001;
const vec3 ZERO_OFFSET = vec3(0.0);
float flipIfTrue(bool flag) {
return -(float(flag) * 2. - 1.);
}
vec3 getLineJoinOffset(
vec3 prevPoint, vec3 currPoint, vec3 nextPoint,
vec2 width
) {
bool isEnd = positions.x > 0.0;
float sideOfPath = positions.y;
float isJoint = float(sideOfPath == 0.0);
vec3 deltaA3 = (currPoint - prevPoint);
vec3 deltaB3 = (nextPoint - currPoint);
mat3 rotationMatrix;
bool needsRotation = !path.billboard && project_needs_rotation(currPoint, rotationMatrix);
if (needsRotation) {
deltaA3 = deltaA3 * rotationMatrix;
deltaB3 = deltaB3 * rotationMatrix;
}
vec2 deltaA = deltaA3.xy / width;
vec2 deltaB = deltaB3.xy / width;
float lenA = length(deltaA);
float lenB = length(deltaB);
vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);
vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);
vec2 perpA = vec2(-dirA.y, dirA.x);
vec2 perpB = vec2(-dirB.y, dirB.x);
vec2 tangent = dirA + dirB;
tangent = length(tangent) > 0. ? normalize(tangent) : perpA;
vec2 miterVec = vec2(-tangent.y, tangent.x);
vec2 dir = isEnd ? dirA : dirB;
vec2 perp = isEnd ? perpA : perpB;
float L = isEnd ? lenA : lenB;
float sinHalfA = abs(dot(miterVec, perp));
float cosHalfA = abs(dot(dirA, miterVec));
float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);
float cornerPosition = sideOfPath * turnDirection;
float miterSize = 1.0 / max(sinHalfA, EPSILON);
miterSize = mix(
min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),
miterSize,
step(0.0, cornerPosition)
);
vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))
* (sideOfPath + isJoint * turnDirection);
bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));
bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));
bool isCap = isStartCap || isEndCap;
if (isCap) {
offsetVec = mix(perp * sideOfPath, dir * path.capType * 4.0 * flipIfTrue(isStartCap), isJoint);
vJointType = path.capType;
} else {
vJointType = path.jointType;
}
vPathLength = L;
vCornerOffset = offsetVec;
vMiterLength = dot(vCornerOffset, miterVec * turnDirection);
vMiterLength = isCap ? isJoint : vMiterLength;
vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);
vPathPosition = vec2(
dot(offsetFromStartOfPath, perp),
dot(offsetFromStartOfPath, dir)
);
geometry.uv = vPathPosition;
float isValid = step(instanceTypes, 3.5);
vec3 offset = vec3(offsetVec * width * isValid, 0.0);
if (needsRotation) {
offset = rotationMatrix * offset;
}
return offset;
}
void clipLine(inout vec4 position, vec4 refPosition) {
if (position.w < EPSILON) {
float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);
position = refPosition + (position - refPosition) * r;
}
}
void main() {
geometry.pickingColor = instancePickingColors;
vColor = vec4(instanceColors.rgb, instanceColors.a * layer.opacity);
float isEnd = positions.x;
vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);
vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);
vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);
vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);
vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);
vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);
geometry.worldPosition = currPosition;
vec2 widthPixels = vec2(clamp(
project_size_to_pixel(instanceStrokeWidths * path.widthScale, path.widthUnits),
path.widthMinPixels, path.widthMaxPixels) / 2.0);
vec3 width;
if (path.billboard) {
vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);
vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);
vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);
clipLine(prevPositionScreen, currPositionScreen);
clipLine(nextPositionScreen, currPositionScreen);
clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));
width = vec3(widthPixels, 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(
prevPositionScreen.xyz / prevPositionScreen.w,
currPositionScreen.xyz / currPositionScreen.w,
nextPositionScreen.xyz / nextPositionScreen.w,
project_pixel_size_to_clipspace(width.xy)
);
DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);
gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);
} else {
prevPosition = project_position(prevPosition, prevPosition64Low);
currPosition = project_position(currPosition, currPosition64Low);
nextPosition = project_position(nextPosition, nextPosition64Low);
width = vec3(project_pixel_size(widthPixels), 0.0);
DECKGL_FILTER_SIZE(width, geometry);
vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);
geometry.position = vec4(currPosition + offset, 1.0);
gl_Position = project_common_position_to_clipspace(geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,v4=`#version 300 es
#define SHADER_NAME path-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 vCornerOffset;
in float vMiterLength;
in vec2 vPathPosition;
in float vPathLength;
in float vJointType;
out vec4 fragColor;
void main(void) {
geometry.uv = vPathPosition;
if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {
if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {
discard;
}
if (vJointType < 0.5 && vMiterLength > path.miterLimit + 1.0) {
discard;
}
}
fragColor = vColor;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,AT=[0,0,0,255],b4={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:i=>i.path},getColor:{type:"accessor",value:AT},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},wm={enter:(i,e)=>e.length?e.subarray(e.length-i.length):i};class dy extends qo{getShaders(){return super.getShaders({vs:x4,fs:v4,modules:[Oh,Lh,y4]})}get wrapLongitude(){return!1}getBounds(){return this.getAttributeManager()?.getBounds(["vertexPositions"])}initializeState(){this.getAttributeManager().addInstanced({vertexPositions:{size:3,vertexOffset:1,type:"float64",fp64:this.use64bitPositions(),transition:wm,accessor:"getPath",update:this.calculatePositions,noAlloc:!0,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:"uint8",update:this.calculateSegmentTypes,noAlloc:!0},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:wm,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",accessor:"getColor",transition:wm,defaultValue:AT},instancePickingColors:{size:4,type:"uint8",accessor:(r,{index:o,target:c})=>this.encodePickingColor(r&&r.__source?r.__source.index:o,c)}}),this.setState({pathTesselator:new _4({fp64:this.use64bitPositions()})})}updateState(e){super.updateState(e);const{props:t,changeFlags:r}=e,o=this.getAttributeManager();if(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPath)){const{pathTesselator:d}=this.state,a=t.data.attributes||{};d.updateGeometry({data:t.data,geometryBuffer:a.getPath,buffers:a,normalize:!t._pathType,loop:t._pathType==="loop",getGeometry:t.getPath,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:r.dataChanged}),this.setState({numInstances:d.instanceCount,startIndices:d.vertexStarts}),r.dataChanged||o.invalidateAll()}r.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),o.invalidateAll())}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r}=t,o=this.props.data;return o[0]&&o[0].__source&&(t.object=o.find(c=>c.__source.index===r)),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let r=0;r<t.length;r++)t[r].__source.index===e&&this._disablePickingIndex(r);else super.disablePickingIndex(e)}draw({uniforms:e}){const{jointRounded:t,capRounded:r,billboard:o,miterLimit:c,widthUnits:d,widthScale:a,widthMinPixels:y,widthMaxPixels:w}=this.props,E=this.state.model,I={jointType:Number(t),capType:Number(r),billboard:o,widthUnits:ro[d],widthScale:a,miterLimit:c,widthMinPixels:y,widthMaxPixels:w};E.shaderInputs.setProps({path:I}),E.draw(this.context.renderPass)}_getModel(){const e=[0,1,2,1,4,2,1,3,4,3,5,4],t=[0,0,0,-1,0,1,1,-1,1,1,1,0];return new es(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new bc({topology:"triangle-list",attributes:{indices:new Uint16Array(e),positions:{value:new Float32Array(t),size:2}}}),isInstanced:!0})}calculatePositions(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateSegmentTypes(e){const{pathTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("segmentTypes")}}dy.defaultProps=b4;dy.layerName="PathLayer";const gf=xT.CLOCKWISE,I0=xT.COUNTER_CLOCKWISE,$o={};function w4(i){if(i=i&&i.positions||i,!Array.isArray(i)&&!ArrayBuffer.isView(i))throw new Error("invalid polygon")}function ah(i){return"positions"in i?i.positions:i}function Df(i){return"holeIndices"in i?i.holeIndices:null}function T4(i){return Array.isArray(i[0])}function S4(i){return i.length>=1&&i[0].length>=2&&Number.isFinite(i[0][0])}function E4(i){const e=i[0],t=i[i.length-1];return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function A4(i,e,t,r){for(let o=0;o<e;o++)if(i[t+o]!==i[r-e+o])return!1;return!0}function M0(i,e,t,r,o){let c=e;const d=t.length;for(let a=0;a<d;a++)for(let y=0;y<r;y++)i[c++]=t[a][y]||0;if(!E4(t))for(let a=0;a<r;a++)i[c++]=t[0][a]||0;return $o.start=e,$o.end=c,$o.size=r,vT(i,o,$o),c}function R0(i,e,t,r,o=0,c,d){c=c||t.length;const a=c-o;if(a<=0)return e;let y=e;for(let w=0;w<a;w++)i[y++]=t[o+w];if(!A4(t,r,o,c))for(let w=0;w<r;w++)i[y++]=t[o+w];return $o.start=e,$o.end=y,$o.size=r,vT(i,d,$o),y}function P4(i,e){w4(i);const t=[],r=[];if("positions"in i){const{positions:o,holeIndices:c}=i;if(c){let d=0;for(let a=0;a<=c.length;a++)d=R0(t,d,o,e,c[a-1],c[a],a===0?gf:I0),r.push(d);return r.pop(),{positions:t,holeIndices:r}}i=o}if(!T4(i))return R0(t,0,i,e,0,t.length,gf),t;if(!S4(i)){let o=0;for(const[c,d]of i.entries())o=M0(t,o,d,e,c===0?gf:I0),r.push(o);return r.pop(),{positions:t,holeIndices:r}}return M0(t,0,i,e,gf),t}function Tm(i,e,t){const r=i.length/3;let o=0;for(let c=0;c<r;c++){const d=(c+1)%r;o+=i[c*3+e]*i[d*3+t],o-=i[d*3+e]*i[c*3+t]}return Math.abs(o/2)}function k0(i,e,t,r){const o=i.length/3;for(let c=0;c<o;c++){const d=c*3,a=i[d+0],y=i[d+1],w=i[d+2];i[d+e]=a,i[d+t]=y,i[d+r]=w}}function C4(i,e,t,r){let o=Df(i);o&&(o=o.map(a=>a/e));let c=ah(i);const d=r&&e===3;if(t){const a=c.length;c=c.slice();const y=[];for(let w=0;w<a;w+=e){y[0]=c[w],y[1]=c[w+1],d&&(y[2]=c[w+2]);const E=t(y);c[w]=E[0],c[w+1]=E[1],d&&(c[w+2]=E[2])}}if(d){const a=Tm(c,0,1),y=Tm(c,0,2),w=Tm(c,1,2);if(!a&&!y&&!w)return[];a>y&&a>w||(y>w?(t||(c=c.slice()),k0(c,0,2,1)):(t||(c=c.slice()),k0(c,2,0,1)))}return QS(c,o,e)}class I4 extends _T{constructor(e){const{fp64:t,IndexType:r=Uint32Array}=e;super({...e,attributes:{positions:{size:3,type:t?Float64Array:Float32Array},vertexValid:{type:Uint16Array,size:1},indices:{type:r,size:1}}})}get(e){const{attributes:t}=this;return e==="indices"?t.indices&&t.indices.subarray(0,this.vertexCount):t[e]}updateGeometry(e){super.updateGeometry(e);const t=this.buffers.indices;if(t)this.vertexCount=(t.value||t).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(e){if(this.normalize){const t=P4(e,this.positionSize);return this.opts.resolution?wT(ah(t),Df(t),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?h4(ah(t),Df(t),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):t}return e}getGeometrySize(e){if(D0(e)){let t=0;for(const r of e)t+=this.getGeometrySize(r);return t}return ah(e).length/this.positionSize}getGeometryFromBuffer(e){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(e):null}updateGeometryAttributes(e,t){if(e&&D0(e))for(const r of e){const o=this.getGeometrySize(r);t.geometrySize=o,this.updateGeometryAttributes(r,t),t.vertexStart+=o,t.indexStart=this.indexStarts[t.geometryIndex+1]}else{const r=e;this._updateIndices(r,t),this._updatePositions(r,t),this._updateVertexValid(r,t)}}_updateIndices(e,{geometryIndex:t,vertexStart:r,indexStart:o}){const{attributes:c,indexStarts:d,typedArrayManager:a}=this;let y=c.indices;if(!y||!e)return;let w=o;const E=C4(e,this.positionSize,this.opts.preproject,this.opts.full3d);y=a.allocate(y,o+E.length,{copy:!0});for(let I=0;I<E.length;I++)y[w++]=E[I]+r;d[t+1]=o+E.length,c.indices=y}_updatePositions(e,{vertexStart:t,geometrySize:r}){const{attributes:{positions:o},positionSize:c}=this;if(!o||!e)return;const d=ah(e);for(let a=t,y=0;y<r;a++,y++){const w=d[y*c],E=d[y*c+1],I=c>2?d[y*c+2]:0;o[a*3]=w,o[a*3+1]=E,o[a*3+2]=I}}_updateVertexValid(e,{vertexStart:t,geometrySize:r}){const{positionSize:o}=this,c=this.attributes.vertexValid,d=e&&Df(e);if(e&&e.edgeTypes?c.set(e.edgeTypes,t):c.fill(1,t,t+r),d)for(let a=0;a<d.length;a++)c[t+d[a]/o-1]=0;c[t+r-1]=0}}function D0(i){return Array.isArray(i)&&i.length>0&&!Number.isFinite(i[0])}const O0=`uniform solidPolygonUniforms {
  bool extruded;
  bool isWireframe;
  float elevationScale;
} solidPolygon;
`,M4={name:"solidPolygon",vs:O0,fs:O0,uniformTypes:{extruded:"f32",isWireframe:"f32",elevationScale:"f32"}},PT=`in vec4 fillColors;
in vec4 lineColors;
in vec3 pickingColors;
out vec4 vColor;
struct PolygonProps {
vec3 positions;
vec3 positions64Low;
vec3 normal;
float elevations;
};
vec3 project_offset_normal(vec3 vector) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {
return normalize(vector * project.commonUnitsPerWorldUnit);
}
return project_normal(vector);
}
void calculatePosition(PolygonProps props) {
vec3 pos = props.positions;
vec3 pos64Low = props.positions64Low;
vec3 normal = props.normal;
vec4 colors = solidPolygon.isWireframe ? lineColors : fillColors;
geometry.worldPosition = props.positions;
geometry.pickingColor = pickingColors;
if (solidPolygon.extruded) {
pos.z += props.elevations * solidPolygon.elevationScale;
}
gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
if (solidPolygon.extruded) {
#ifdef IS_SIDE_VERTEX
normal = project_offset_normal(normal);
#else
normal = project_normal(normal);
#endif
geometry.normal = normal;
vec3 lightColor = lighting_getLightColor(colors.rgb, project.cameraPosition, geometry.position.xyz, geometry.normal);
vColor = vec4(lightColor, colors.a * layer.opacity);
} else {
vColor = vec4(colors.rgb, colors.a * layer.opacity);
}
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,R4=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader
in vec3 vertexPositions;
in vec3 vertexPositions64Low;
in float elevations;
${PT}
void main(void) {
PolygonProps props;
props.positions = vertexPositions;
props.positions64Low = vertexPositions64Low;
props.elevations = elevations;
props.normal = vec3(0.0, 0.0, 1.0);
calculatePosition(props);
}
`,k4=`#version 300 es
#define SHADER_NAME solid-polygon-layer-vertex-shader-side
#define IS_SIDE_VERTEX
in vec2 positions;
in vec3 vertexPositions;
in vec3 nextVertexPositions;
in vec3 vertexPositions64Low;
in vec3 nextVertexPositions64Low;
in float elevations;
in float instanceVertexValid;
${PT}
void main(void) {
if(instanceVertexValid < 0.5){
gl_Position = vec4(0.);
return;
}
PolygonProps props;
vec3 pos;
vec3 pos64Low;
vec3 nextPos;
vec3 nextPos64Low;
#if RING_WINDING_ORDER_CW == 1
pos = vertexPositions;
pos64Low = vertexPositions64Low;
nextPos = nextVertexPositions;
nextPos64Low = nextVertexPositions64Low;
#else
pos = nextVertexPositions;
pos64Low = nextVertexPositions64Low;
nextPos = vertexPositions;
nextPos64Low = vertexPositions64Low;
#endif
props.positions = mix(pos, nextPos, positions.x);
props.positions64Low = mix(pos64Low, nextPos64Low, positions.x);
props.normal = vec3(
pos.y - nextPos.y + (pos64Low.y - nextPos64Low.y),
nextPos.x - pos.x + (nextPos64Low.x - pos64Low.x),
0.0);
props.elevations = elevations * positions.y;
calculatePosition(props);
}
`,D4=`#version 300 es
#define SHADER_NAME solid-polygon-layer-fragment-shader
precision highp float;
in vec4 vColor;
out vec4 fragColor;
void main(void) {
fragColor = vColor;
geometry.uv = vec2(0.);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,ap=[0,0,0,255],O4={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:i=>i.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:ap},getLineColor:{type:"accessor",value:ap},material:!0},mf={enter:(i,e)=>e.length?e.subarray(e.length-i.length):i};class fy extends qo{getShaders(e){return super.getShaders({vs:e==="top"?R4:k4,fs:D4,defines:{RING_WINDING_ORDER_CW:!this.props._normalize&&this.props._windingOrder==="CCW"?0:1},modules:[Oh,y1,Lh,M4]})}get wrapLongitude(){return!1}getBounds(){return this.getAttributeManager()?.getBounds(["vertexPositions"])}initializeState(){const{viewport:e}=this.context;let{coordinateSystem:t}=this.props;const{_full3d:r}=this.props;e.isGeospatial&&t===hi.DEFAULT&&(t=hi.LNGLAT);let o;t===hi.LNGLAT&&(r?o=e.projectPosition.bind(e):o=e.projectFlat.bind(e)),this.setState({numInstances:0,polygonTesselator:new I4({preproject:o,fp64:this.use64bitPositions(),IndexType:Uint32Array})});const c=this.getAttributeManager(),d=!0;c.remove(["instancePickingColors"]),c.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:d},vertexPositions:{size:3,type:"float64",stepMode:"dynamic",fp64:this.use64bitPositions(),transition:mf,accessor:"getPolygon",update:this.calculatePositions,noAlloc:d,shaderAttributes:{nextVertexPositions:{vertexOffset:1}}},instanceVertexValid:{size:1,type:"uint16",stepMode:"instance",update:this.calculateVertexValid,noAlloc:d},elevations:{size:1,stepMode:"dynamic",transition:mf,accessor:"getElevation"},fillColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:mf,accessor:"getFillColor",defaultValue:ap},lineColors:{size:this.props.colorFormat.length,type:"unorm8",stepMode:"dynamic",transition:mf,accessor:"getLineColor",defaultValue:ap},pickingColors:{size:4,type:"uint8",stepMode:"dynamic",accessor:(a,{index:y,target:w})=>this.encodePickingColor(a&&a.__source?a.__source.index:y,w)}})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r}=t,o=this.props.data;return o[0]&&o[0].__source&&(t.object=o.find(c=>c.__source.index===r)),t}disablePickingIndex(e){const t=this.props.data;if(t[0]&&t[0].__source)for(let r=0;r<t.length;r++)t[r].__source.index===e&&this._disablePickingIndex(r);else super.disablePickingIndex(e)}draw({uniforms:e}){const{extruded:t,filled:r,wireframe:o,elevationScale:c}=this.props,{topModel:d,sideModel:a,wireframeModel:y,polygonTesselator:w}=this.state,E={extruded:!!t,elevationScale:c,isWireframe:!1};y&&o&&(y.setInstanceCount(w.instanceCount-1),y.shaderInputs.setProps({solidPolygon:{...E,isWireframe:!0}}),y.draw(this.context.renderPass)),a&&r&&(a.setInstanceCount(w.instanceCount-1),a.shaderInputs.setProps({solidPolygon:E}),a.draw(this.context.renderPass)),d&&r&&(d.setVertexCount(w.vertexCount),d.shaderInputs.setProps({solidPolygon:E}),d.draw(this.context.renderPass))}updateState(e){super.updateState(e),this.updateGeometry(e);const{props:t,oldProps:r,changeFlags:o}=e,c=this.getAttributeManager();(o.extensionsChanged||t.filled!==r.filled||t.extruded!==r.extruded)&&(this.state.models?.forEach(a=>a.destroy()),this.setState(this._getModels()),c.invalidateAll())}updateGeometry({props:e,oldProps:t,changeFlags:r}){if(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getPolygon)){const{polygonTesselator:c}=this.state,d=e.data.attributes||{};c.updateGeometry({data:e.data,normalize:e._normalize,geometryBuffer:d.getPolygon,buffers:d,getGeometry:e.getPolygon,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:r.dataChanged,full3d:e._full3d}),this.setState({numInstances:c.instanceCount,startIndices:c.vertexStarts}),r.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(){const{id:e,filled:t,extruded:r}=this.props;let o,c,d;if(t){const a=this.getShaders("top");a.defines.NON_INSTANCED_MODEL=1;const y=this.getAttributeManager().getBufferLayouts({isInstanced:!1});o=new es(this.context.device,{...a,id:`${e}-top`,topology:"triangle-list",bufferLayout:y,isIndexed:!0,userData:{excludeAttributes:{instanceVertexValid:!0}}})}if(r){const a=this.getAttributeManager().getBufferLayouts({isInstanced:!0});c=new es(this.context.device,{...this.getShaders("side"),id:`${e}-side`,bufferLayout:a,geometry:new bc({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,1,1,0,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}}),d=new es(this.context.device,{...this.getShaders("side"),id:`${e}-wireframe`,bufferLayout:a,geometry:new bc({topology:"line-strip",attributes:{positions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),isInstanced:!0,userData:{excludeAttributes:{indices:!0}}})}return{models:[c,d,o].filter(Boolean),topModel:o,sideModel:c,wireframeModel:d}}calculateIndices(e){const{polygonTesselator:t}=this.state;e.startIndices=t.indexStarts,e.value=t.get("indices")}calculatePositions(e){const{polygonTesselator:t}=this.state;e.startIndices=t.vertexStarts,e.value=t.get("positions")}calculateVertexValid(e){e.value=this.state.polygonTesselator.get("vertexValid")}}fy.defaultProps=O4;fy.layerName="SolidPolygonLayer";function L4({data:i,getIndex:e,dataRange:t,replace:r}){const{startRow:o=0,endRow:c=1/0}=t,d=i.length;let a=d,y=d;for(let D=0;D<d;D++){const F=e(i[D]);if(a>D&&F>=o&&(a=D),F>=c){y=D;break}}let w=a;const I=y-a!==r.length?i.slice(y):void 0;for(let D=0;D<r.length;D++)i[w++]=r[D];if(I){for(let D=0;D<I.length;D++)i[w++]=I[D];i.length=w}return{startRow:a,endRow:a+r.length}}function F4(i,e){if(!i)return null;const t="startIndices"in i?i.startIndices[e]:e,r=i.featureIds.value[t];return t!==-1?B4(i,r,t):null}function B4(i,e,t){const r={properties:{...i.properties[e]}};for(const o in i.numericProps)r.properties[o]=i.numericProps[o].value[t];return r}function N4(i,e){const t={points:null,lines:null,polygons:null};for(const r in t){const o=i[r].globalFeatureIds.value;t[r]=new Uint8ClampedArray(o.length*4);const c=[];for(let d=0;d<o.length;d++)e(o[d],c),t[r][d*4+0]=c[0],t[r][d*4+1]=c[1],t[r][d*4+2]=c[2],t[r][d*4+3]=255}return t}const L0=`uniform sdfUniforms {
  float gamma;
  bool enabled;
  float buffer;
  float outlineBuffer;
  vec4 outlineColor;
} sdf;
`,z4={name:"sdf",vs:L0,fs:L0,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},U4=`#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
if (!bool(picking.isActive)) {
float alpha = texture(iconsTexture, vTextureCoords).a;
vec4 color = vColor;
if (sdf.enabled) {
float distance = alpha;
alpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);
if (sdf.outlineBuffer > 0.0) {
float inFill = alpha;
float inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);
color = mix(sdf.outlineColor, vColor, inFill);
alpha = inBorder;
}
}
float a = alpha * color.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color.rgb, a * layer.opacity);
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,Sm=192/256,F0=[],V4={getIconOffsets:{type:"accessor",value:i=>i.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}};class py extends bp{getShaders(){const e=super.getShaders();return{...e,modules:[...e.modules,z4],fs:U4}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(t,{index:r,target:o})=>this.encodePickingColor(r,o)}})}updateState(e){super.updateState(e);const{props:t,oldProps:r}=e;let{outlineColor:o}=t;o!==r.outlineColor&&(o=o.map(c=>c/255),o[3]=Number.isFinite(o[3])?o[3]:1,this.setState({outlineColor:o})),!t.sdf&&t.outlineWidth&&ii.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){const{sdf:t,smoothing:r,outlineWidth:o}=this.props,{outlineColor:c}=this.state,d=o?Math.max(r,Sm*(1-o)):-1,a=this.state.model,y={buffer:Sm,outlineBuffer:d,gamma:r,enabled:!!t,outlineColor:c};if(a.shaderInputs.setProps({sdf:y}),super.draw(e),t&&o){const{iconManager:w}=this.state;w.getTexture()&&(a.shaderInputs.setProps({sdf:{...y,outlineBuffer:Sm}}),a.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap(t=>super.getInstanceOffset(t)):F0}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(t=>super.getInstanceIconFrame(t)):F0}}py.defaultProps=V4;py.layerName="MultiIconLayer";const mh=1e20;class j4{constructor({fontSize:e=24,buffer:t=3,radius:r=8,cutoff:o=.25,fontFamily:c="sans-serif",fontWeight:d="normal",fontStyle:a="normal",lang:y=null}={}){this.buffer=t,this.cutoff=o,this.radius=r,this.lang=y;const w=this.size=e+t*4,E=this._createCanvas(w),I=this.ctx=E.getContext("2d",{willReadFrequently:!0});I.font=`${a} ${d} ${e}px ${c}`,I.textBaseline="alphabetic",I.textAlign="left",I.fillStyle="black",this.gridOuter=new Float64Array(w*w),this.gridInner=new Float64Array(w*w),this.f=new Float64Array(w),this.z=new Float64Array(w+1),this.v=new Uint16Array(w)}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){const{width:t,actualBoundingBoxAscent:r,actualBoundingBoxDescent:o,actualBoundingBoxLeft:c,actualBoundingBoxRight:d}=this.ctx.measureText(e),a=Math.ceil(r),y=0,w=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(d-c))),E=Math.min(this.size-this.buffer,a+Math.ceil(o)),I=w+2*this.buffer,D=E+2*this.buffer,F=Math.max(I*D,0),X=new Uint8ClampedArray(F),oe={data:X,width:I,height:D,glyphWidth:w,glyphHeight:E,glyphTop:a,glyphLeft:y,glyphAdvance:t};if(w===0||E===0)return oe;const{ctx:_e,buffer:ge,gridInner:fe,gridOuter:Te}=this;this.lang&&(_e.lang=this.lang),_e.clearRect(ge,ge,w,E),_e.fillText(e,ge,ge+a);const ke=_e.getImageData(ge,ge,w,E);Te.fill(mh,0,F),fe.fill(0,0,F);for(let Je=0;Je<E;Je++)for(let Xe=0;Xe<w;Xe++){const mt=ke.data[4*(Je*w+Xe)+3]/255;if(mt===0)continue;const G=(Je+ge)*I+Xe+ge;if(mt===1)Te[G]=0,fe[G]=mh;else{const J=.5-mt;Te[G]=J>0?J*J:0,fe[G]=J<0?J*J:0}}B0(Te,0,0,I,D,I,this.f,this.v,this.z),B0(fe,ge,ge,w,E,I,this.f,this.v,this.z);for(let Je=0;Je<F;Je++){const Xe=Math.sqrt(Te[Je])-Math.sqrt(fe[Je]);X[Je]=Math.round(255-255*(Xe/this.radius+this.cutoff))}return oe}}function B0(i,e,t,r,o,c,d,a,y){for(let w=e;w<e+r;w++)N0(i,t*c+w,c,o,d,a,y);for(let w=t;w<t+o;w++)N0(i,w*c+e,1,r,d,a,y)}function N0(i,e,t,r,o,c,d){c[0]=0,d[0]=-mh,d[1]=mh,o[0]=i[e];for(let a=1,y=0,w=0;a<r;a++){o[a]=i[e+a*t];const E=a*a;do{const I=c[y];w=(o[a]-o[I]+E-I*I)/(a-I)/2}while(w<=d[y]&&--y>-1);y++,c[y]=a,d[y]=w,d[y+1]=mh}for(let a=0,y=0;a<r;a++){for(;d[y+1]<a;)y++;const w=c[y],E=a-w;i[e+a*t]=o[w]+E*E}}const $4=32,W4=[];function H4(i){return Math.pow(2,Math.ceil(Math.log2(i)))}function Z4({characterSet:i,getFontWidth:e,fontHeight:t,buffer:r,maxCanvasWidth:o,mapping:c={},xOffset:d=0,yOffset:a=0}){let y=0,w=d;const E=t+r*2;for(const I of i)if(!c[I]){const D=e(I);w+D+r*2>o&&(w=0,y++),c[I]={x:w+r,y:a+y*E+r,width:D,height:E,layoutWidth:D,layoutHeight:t},w+=D+r*2}return{mapping:c,xOffset:w,yOffset:a+y*E,canvasHeight:H4(a+(y+1)*E)}}function CT(i,e,t,r){let o=0;for(let c=e;c<t;c++){const d=i[c];o+=r[d]?.layoutWidth||0}return o}function IT(i,e,t,r,o,c){let d=e,a=0;for(let y=e;y<t;y++){const w=CT(i,y,y+1,o);a+w>r&&(d<y&&c.push(y),d=y,a=0),a+=w}return a}function q4(i,e,t,r,o,c){let d=e,a=e,y=e,w=0;for(let E=e;E<t;E++)if((i[E]===" "||i[E+1]===" "||E+1===t)&&(y=E+1),y>a){let I=CT(i,a,y,o);w+I>r&&(d<a&&(c.push(a),d=a,w=0),I>r&&(I=IT(i,a,y,r,o,c),d=c[c.length-1])),a=y,w+=I}return w}function X4(i,e,t,r,o=0,c){c===void 0&&(c=i.length);const d=[];return e==="break-all"?IT(i,o,c,t,r,d):q4(i,o,c,t,r,d),d}function G4(i,e,t,r,o,c){let d=0,a=0;for(let y=e;y<t;y++){const w=i[y],E=r[w];E?(a||(a=E.layoutHeight),o[y]=d+E.layoutWidth/2,d+=E.layoutWidth):(ii.warn(`Missing character: ${w} (${w.codePointAt(0)})`)(),o[y]=d,d+=$4)}c[0]=d,c[1]=a}function Y4(i,e,t,r,o){const c=Array.from(i),d=c.length,a=new Array(d),y=new Array(d),w=new Array(d),E=(t==="break-word"||t==="break-all")&&isFinite(r)&&r>0,I=[0,0],D=[0,0];let F=0,X=0,oe=0;for(let _e=0;_e<=d;_e++){const ge=c[_e];if((ge===`
`||_e===d)&&(oe=_e),oe>X){const fe=E?X4(c,t,r,o,X,oe):W4;for(let Te=0;Te<=fe.length;Te++){const ke=Te===0?X:fe[Te-1],Je=Te<fe.length?fe[Te]:oe;G4(c,ke,Je,o,a,D);for(let Xe=ke;Xe<Je;Xe++){const mt=c[Xe],G=o[mt]?.layoutOffsetY||0;y[Xe]=F+D[1]/2+G,w[Xe]=D[0]}F=F+D[1]*e,I[0]=Math.max(I[0],D[0])}X=oe}ge===`
`&&(a[X]=0,y[X]=0,w[X]=0,X++)}return I[1]=F,{x:a,y,rowWidth:w,size:I}}function K4({value:i,length:e,stride:t,offset:r,startIndices:o,characterSet:c}){const d=i.BYTES_PER_ELEMENT,a=t?t/d:1,y=r?r/d:0,w=o[e]||Math.ceil((i.length-y)/a),E=c&&new Set,I=new Array(e);let D=i;if(a>1||y>0){const F=i.constructor;D=new F(w);for(let X=0;X<w;X++)D[X]=i[X*a+y]}for(let F=0;F<e;F++){const X=o[F],oe=o[F+1]||w,_e=D.subarray(X,oe);I[F]=String.fromCodePoint.apply(null,_e),E&&_e.forEach(E.add,E)}if(E)for(const F of E)c.add(String.fromCodePoint(F));return{texts:I,characterCount:w}}class MT{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){const t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?(this.delete(e),this._cache[e]=t,this._appendOrder(e)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e))}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){const t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}}function J4(){const i=[];for(let e=32;e<128;e++)i.push(String.fromCharCode(e));return i}const fc={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:J4(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},z0=1024,U0=.9,V0=1.2,RT=3;let lp=new MT(RT);function Q4(i,e){let t;typeof e=="string"?t=new Set(Array.from(e)):t=new Set(e);const r=lp.get(i);if(!r)return t;for(const o in r.mapping)t.has(o)&&t.delete(o);return t}function eB(i,e){for(let t=0;t<i.length;t++)e.data[4*t+3]=i[t]}function j0(i,e,t,r){i.font=`${r} ${t}px ${e}`,i.fillStyle="#000",i.textBaseline="alphabetic",i.textAlign="left"}function tB(i){ii.assert(Number.isFinite(i)&&i>=RT,"Invalid cache limit"),lp=new MT(i)}class iB{constructor(){this.props={...fc}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:e,buffer:t}=this.props;return(e*V0+t*2)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();const t=Q4(this._key,this.props.characterSet),r=lp.get(this._key);if(r&&t.size===0){this._atlas!==r&&(this._atlas=r);return}const o=this._generateFontAtlas(t,r);this._atlas=o,lp.set(this._key,o)}_generateFontAtlas(e,t){const{fontFamily:r,fontWeight:o,fontSize:c,buffer:d,sdf:a,radius:y,cutoff:w}=this.props;let E=t&&t.data;E||(E=document.createElement("canvas"),E.width=z0);const I=E.getContext("2d",{willReadFrequently:!0});j0(I,r,c,o);const{mapping:D,canvasHeight:F,xOffset:X,yOffset:oe}=Z4({getFontWidth:_e=>I.measureText(_e).width,fontHeight:c*V0,buffer:d,characterSet:e,maxCanvasWidth:z0,...t&&{mapping:t.mapping,xOffset:t.xOffset,yOffset:t.yOffset}});if(E.height!==F){const _e=I.getImageData(0,0,E.width,E.height);E.height=F,I.putImageData(_e,0,0)}if(j0(I,r,c,o),a){const _e=new j4({fontSize:c,buffer:d,radius:y,cutoff:w,fontFamily:r,fontWeight:`${o}`});for(const ge of e){const{data:fe,width:Te,height:ke,glyphTop:Je}=_e.draw(ge);D[ge].width=Te,D[ge].layoutOffsetY=c*U0-Je;const Xe=I.createImageData(Te,ke);eB(fe,Xe),I.putImageData(Xe,D[ge].x,D[ge].y)}}else for(const _e of e)I.fillText(_e,D[_e].x,D[_e].y+d+c*U0);return{xOffset:X,yOffset:oe,mapping:D,data:E,width:E.width,height:E.height}}_getKey(){const{fontFamily:e,fontWeight:t,fontSize:r,buffer:o,sdf:c,radius:d,cutoff:a}=this.props;return c?`${e} ${t} ${r} ${o} ${d} ${a}`:`${e} ${t} ${r} ${o}`}}const $0=`uniform textBackgroundUniforms {
  bool billboard;
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  vec4 borderRadius;
  vec4 padding;
  highp int sizeUnits;
  bool stroked;
} textBackground;
`,rB={name:"textBackground",vs:$0,fs:$0,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",borderRadius:"vec4<f32>",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},nB=`#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = radians(angle);
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vLineWidth = instanceLineWidths;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),
textBackground.sizeMinPixels, textBackground.sizeMaxPixels
);
dimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;
vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
pixelOffset += instancePixelOffsets;
pixelOffset.y *= -1.0;
if (textBackground.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,sB=`#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;
out vec4 fragColor;
float round_rect(vec2 p, vec2 size, vec4 radii) {
vec2 pixelPositionCB = (p - 0.5) * size;
vec2 sizeCB = size * 0.5;
float maxBorderRadius = min(size.x, size.y) * 0.5;
vec4 borderRadius = vec4(min(radii, maxBorderRadius));
borderRadius.xy =
(pixelPositionCB.x > 0.0) ? borderRadius.xy : borderRadius.zw;
borderRadius.x = (pixelPositionCB.y > 0.0) ? borderRadius.x : borderRadius.y;
vec2 q = abs(pixelPositionCB) - sizeCB + borderRadius.x;
return -(min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - borderRadius.x);
}
float rect(vec2 p, vec2 size) {
vec2 pixelPosition = p * size;
return min(min(pixelPosition.x, size.x - pixelPosition.x),
min(pixelPosition.y, size.y - pixelPosition.y));
}
vec4 get_stroked_fragColor(float dist) {
float isBorder = smoothedge(dist, vLineWidth);
return mix(vFillColor, vLineColor, isBorder);
}
void main(void) {
geometry.uv = uv;
if (textBackground.borderRadius != vec4(0.0)) {
float distToEdge = round_rect(uv, dimensions, textBackground.borderRadius);
if (textBackground.stroked) {
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
float shapeAlpha = smoothedge(-distToEdge, 0.0);
fragColor.a *= shapeAlpha;
} else {
if (textBackground.stroked) {
float distToEdge = rect(uv, dimensions);
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,oB={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,borderRadius:{type:"object",value:0},padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:i=>i.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class gy extends qo{getShaders(){return super.getShaders({vs:nB,fs:sB,modules:[Oh,Lh,rB]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);const{changeFlags:t}=e;t.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){const{billboard:t,sizeScale:r,sizeUnits:o,sizeMinPixels:c,sizeMaxPixels:d,getLineWidth:a}=this.props;let{padding:y,borderRadius:w}=this.props;y.length<4&&(y=[y[0],y[1],y[0],y[1]]),Array.isArray(w)||(w=[w,w,w,w]);const E=this.state.model,I={billboard:t,stroked:!!a,borderRadius:w,padding:y,sizeUnits:ro[o],sizeScale:r,sizeMinPixels:c,sizeMaxPixels:d};E.shaderInputs.setProps({textBackground:I}),E.draw(this.context.renderPass)}_getModel(){const e=[0,0,1,0,0,1,1,1];return new es(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new bc({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array(e)}}}),isInstanced:!0})}}gy.defaultProps=oB;gy.layerName="TextBackgroundLayer";const W0={start:1,middle:0,end:-1},H0={top:1,center:0,bottom:-1},Em=[0,0,0,255],aB=1,lB={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:Em},getBorderWidth:{type:"accessor",value:0},backgroundBorderRadius:{type:"object",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:fc.characterSet},fontFamily:fc.fontFamily,fontWeight:fc.fontWeight,lineHeight:aB,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:Em},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:i=>i.text},getPosition:{type:"accessor",value:i=>i.position},getColor:{type:"accessor",value:Em},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class my extends uy{constructor(){super(...arguments),this.getBoundingRect=(e,t)=>{let{size:[r,o]}=this.transformParagraph(e,t);const{fontSize:c}=this.state.fontAtlasManager.props;r/=c,o/=c;const{getTextAnchor:d,getAlignmentBaseline:a}=this.props,y=W0[typeof d=="function"?d(e,t):d],w=H0[typeof a=="function"?a(e,t):a];return[(y-1)*r/2,(w-1)*o/2,r,o]},this.getIconOffsets=(e,t)=>{const{getTextAnchor:r,getAlignmentBaseline:o}=this.props,{x:c,y:d,rowWidth:a,size:[y,w]}=this.transformParagraph(e,t),E=W0[typeof r=="function"?r(e,t):r],I=H0[typeof o=="function"?o(e,t):o],D=c.length,F=new Array(D*2);let X=0;for(let oe=0;oe<D;oe++){const _e=(1-E)*(y-a[oe])/2;F[X++]=(E-1)*y/2+_e+c[oe],F[X++]=(I-1)*w/2+d[oe]}return F}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new iB},this.props.maxWidth>0&&ii.once(1,"v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){const{props:t,oldProps:r,changeFlags:o}=e;(o.dataChanged||o.updateTriggersChanged&&(o.updateTriggersChanged.all||o.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==r.lineHeight||t.wordBreak!==r.wordBreak||t.maxWidth!==r.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){const{fontSettings:e,fontFamily:t,fontWeight:r}=this.props,{fontAtlasManager:o,characterSet:c}=this.state,d={...e,characterSet:c,fontFamily:t,fontWeight:r};if(!o.mapping)return o.setProps(d),!0;for(const a in d)if(d[a]!==o.props[a])return o.setProps(d),!0;return!1}_updateText(){const{data:e,characterSet:t}=this.props,r=e.attributes?.getText;let{getText:o}=this.props,c=e.startIndices,d;const a=t==="auto"&&new Set;if(r&&c){const{texts:y,characterCount:w}=K4({...ArrayBuffer.isView(r)?{value:r}:r,length:e.length,startIndices:c,characterSet:a});d=w,o=(E,{index:I})=>y[I]}else{const{iterable:y,objectInfo:w}=xp(e);c=[0],d=0;for(const E of y){w.index++;const I=Array.from(o(E,w)||"");a&&I.forEach(a.add,a),d+=I.length,c.push(d)}}this.setState({getText:o,startIndices:c,numInstances:d,characterSet:a||t})}transformParagraph(e,t){const{fontAtlasManager:r}=this.state,o=r.mapping,c=this.state.getText,{wordBreak:d,lineHeight:a,maxWidth:y}=this.props,w=c(e,t)||"";return Y4(w,a,d,y*r.props.fontSize,o)}renderLayers(){const{startIndices:e,numInstances:t,getText:r,fontAtlasManager:{scale:o,atlas:c,mapping:d},styleVersion:a}=this.state,{data:y,_dataDiff:w,getPosition:E,getColor:I,getSize:D,getAngle:F,getPixelOffset:X,getBackgroundColor:oe,getBorderColor:_e,getBorderWidth:ge,backgroundBorderRadius:fe,backgroundPadding:Te,background:ke,billboard:Je,fontSettings:Xe,outlineWidth:mt,outlineColor:G,sizeScale:J,sizeUnits:ae,sizeMinPixels:be,sizeMaxPixels:ye,transitions:we,updateTriggers:Se}=this.props,Ee=this.getSubLayerClass("characters",py),W=this.getSubLayerClass("background",gy);return[ke&&new W({getFillColor:oe,getLineColor:_e,getLineWidth:ge,borderRadius:fe,padding:Te,getPosition:E,getSize:D,getAngle:F,getPixelOffset:X,billboard:Je,sizeScale:J,sizeUnits:ae,sizeMinPixels:be,sizeMaxPixels:ye,transitions:we&&{getPosition:we.getPosition,getAngle:we.getAngle,getSize:we.getSize,getFillColor:we.getBackgroundColor,getLineColor:we.getBorderColor,getLineWidth:we.getBorderWidth,getPixelOffset:we.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:Se.getPosition,getAngle:Se.getAngle,getSize:Se.getSize,getFillColor:Se.getBackgroundColor,getLineColor:Se.getBorderColor,getLineWidth:Se.getBorderWidth,getPixelOffset:Se.getPixelOffset,getBoundingRect:{getText:Se.getText,getTextAnchor:Se.getTextAnchor,getAlignmentBaseline:Se.getAlignmentBaseline,styleVersion:a}}}),{data:y.attributes&&y.attributes.background?{length:y.length,attributes:y.attributes.background}:y,_dataDiff:w,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new Ee({sdf:Xe.sdf,smoothing:Number.isFinite(Xe.smoothing)?Xe.smoothing:fc.smoothing,outlineWidth:mt/(Xe.radius||fc.radius),outlineColor:G,iconAtlas:c,iconMapping:d,getPosition:E,getColor:I,getSize:D,getAngle:F,getPixelOffset:X,billboard:Je,sizeScale:J*o,sizeUnits:ae,sizeMinPixels:be*o,sizeMaxPixels:ye*o,transitions:we&&{getPosition:we.getPosition,getAngle:we.getAngle,getColor:we.getColor,getSize:we.getSize,getPixelOffset:we.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:Se.getText,getPosition:Se.getPosition,getAngle:Se.getAngle,getColor:Se.getColor,getSize:Se.getSize,getPixelOffset:Se.getPixelOffset,getIconOffsets:{getTextAnchor:Se.getTextAnchor,getAlignmentBaseline:Se.getAlignmentBaseline,styleVersion:a}}}),{data:y,_dataDiff:w,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:r})]}static set fontAtlasCacheLimit(e){tB(e)}}my.defaultProps=lB;my.layerName="TextLayer";const Of={circle:{type:hy,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:bp,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:my,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},Lf={type:dy,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},__={type:fy,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function Qu({type:i,props:e}){const t={};for(const r in e)t[r]=i.defaultProps[e[r]];return t}function Am(i,e){const{transitions:t,updateTriggers:r}=i.props,o={updateTriggers:{},transitions:t&&{getPosition:t.geometry}};for(const c in e){const d=e[c];let a=i.props[c];c.startsWith("get")&&(a=i.getSubLayerAccessor(a),o.updateTriggers[d]=r[c],t&&(o.transitions[d]=t[c])),o[d]=a}return o}function cB(i){if(Array.isArray(i))return i;switch(ii.assert(i.type,"GeoJSON does not have type"),i.type){case"Feature":return[i];case"FeatureCollection":return ii.assert(Array.isArray(i.features),"GeoJSON does not have features array"),i.features;default:return[{geometry:i}]}}function Z0(i,e,t={}){const r={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:o=0,endRow:c=i.length}=t;for(let d=o;d<c;d++){const a=i[d],{geometry:y}=a;if(y)if(y.type==="GeometryCollection"){ii.assert(Array.isArray(y.geometries),"GeoJSON does not have geometries array");const{geometries:w}=y;for(let E=0;E<w.length;E++){const I=w[E];q0(I,r,e,a,d)}}else q0(y,r,e,a,d)}return r}function q0(i,e,t,r,o){const{type:c,coordinates:d}=i,{pointFeatures:a,lineFeatures:y,polygonFeatures:w,polygonOutlineFeatures:E}=e;if(!hB(c,d)){ii.warn(`${c} coordinates are malformed`)();return}switch(c){case"Point":a.push(t({geometry:i},r,o));break;case"MultiPoint":d.forEach(I=>{a.push(t({geometry:{type:"Point",coordinates:I}},r,o))});break;case"LineString":y.push(t({geometry:i},r,o));break;case"MultiLineString":d.forEach(I=>{y.push(t({geometry:{type:"LineString",coordinates:I}},r,o))});break;case"Polygon":w.push(t({geometry:i},r,o)),d.forEach(I=>{E.push(t({geometry:{type:"LineString",coordinates:I}},r,o))});break;case"MultiPolygon":d.forEach(I=>{w.push(t({geometry:{type:"Polygon",coordinates:I}},r,o)),I.forEach(D=>{E.push(t({geometry:{type:"LineString",coordinates:D}},r,o))})});break}}const uB={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function hB(i,e){let t=uB[i];for(ii.assert(t,`Unknown GeoJSON type ${i}`);e&&--t>0;)e=e[0];return e&&Number.isFinite(e[0])}function kT(){return{points:{},lines:{},polygons:{},polygonsOutline:{}}}function _f(i){return i.geometry.coordinates}function dB(i,e){const t=kT(),{pointFeatures:r,lineFeatures:o,polygonFeatures:c,polygonOutlineFeatures:d}=i;return t.points.data=r,t.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),t.points.getPosition=_f,t.lines.data=o,t.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),t.lines.getPath=_f,t.polygons.data=c,t.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),t.polygons.getPolygon=_f,t.polygonsOutline.data=d,t.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),t.polygonsOutline.getPath=_f,t}function fB(i,e){const t=kT(),{points:r,lines:o,polygons:c}=i,d=N4(i,e);t.points.data={length:r.positions.value.length/r.positions.size,attributes:{...r.attributes,getPosition:r.positions,instancePickingColors:{size:4,value:d.points}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},t.lines.data={length:o.pathIndices.value.length-1,startIndices:o.pathIndices.value,attributes:{...o.attributes,getPath:o.positions,instancePickingColors:{size:4,value:d.lines}},properties:o.properties,numericProps:o.numericProps,featureIds:o.featureIds},t.lines._pathType="open";const a=c.positions.value.length/c.positions.size,y=Array(a).fill(1);for(const w of c.primitivePolygonIndices.value)y[w-1]=0;return t.polygons.data={length:c.polygonIndices.value.length-1,startIndices:c.polygonIndices.value,attributes:{...c.attributes,getPolygon:c.positions,instanceVertexValid:{size:1,value:new Uint16Array(y)},pickingColors:{size:4,value:d.polygons}},properties:c.properties,numericProps:c.numericProps,featureIds:c.featureIds},t.polygons._normalize=!1,c.triangles&&(t.polygons.data.attributes.indices=c.triangles.value),t.polygonsOutline.data={length:c.primitivePolygonIndices.value.length-1,startIndices:c.primitivePolygonIndices.value,attributes:{...c.attributes,getPath:c.positions,instancePickingColors:{size:4,value:d.polygons}},properties:c.properties,numericProps:c.numericProps,featureIds:c.featureIds},t.polygonsOutline._pathType="open",t}const pB=["points","linestrings","polygons"],gB={...Qu(Of.circle),...Qu(Of.icon),...Qu(Of.text),...Qu(Lf),...Qu(__),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:i=>i.properties.icon},getText:{type:"accessor",value:i=>i.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class cp extends uy{initializeState(){this.state={layerProps:{},features:{},featuresDiff:{}}}updateState({props:e,changeFlags:t}){if(!t.dataChanged)return;const{data:r}=this.props,o=r&&"points"in r&&"polygons"in r&&"lines"in r;this.setState({binary:o}),o?this._updateStateBinary({props:e,changeFlags:t}):this._updateStateJSON({props:e,changeFlags:t})}_updateStateBinary({props:e,changeFlags:t}){const r=fB(e.data,this.encodePickingColor);this.setState({layerProps:r})}_updateStateJSON({props:e,changeFlags:t}){const r=cB(e.data),o=this.getSubLayerRow.bind(this);let c={};const d={};if(Array.isArray(t.dataChanged)){const y=this.state.features;for(const w in y)c[w]=y[w].slice(),d[w]=[];for(const w of t.dataChanged){const E=Z0(r,o,w);for(const I in y)d[I].push(L4({data:c[I],getIndex:D=>D.__source.index,dataRange:w,replace:E[I]}))}}else c=Z0(r,o);const a=dB(c,d);this.setState({features:c,featuresDiff:d,layerProps:a})}getPickingInfo(e){const t=super.getPickingInfo(e),{index:r,sourceLayer:o}=t;return t.featureType=pB.find(c=>o.id.startsWith(`${this.id}-${c}-`)),r>=0&&o.id.startsWith(`${this.id}-points-text`)&&this.state.binary&&(t.index=this.props.data.points.globalFeatureIds.value[r]),t}_updateAutoHighlight(e){const t=`${this.id}-points-`,r=e.featureType==="points";for(const o of this.getSubLayers())o.id.startsWith(t)===r&&o.updateAutoHighlight(e)}_renderPolygonLayer(){const{extruded:e,wireframe:t}=this.props,{layerProps:r}=this.state,o="polygons-fill",c=this.shouldRenderSubLayer(o,r.polygons?.data)&&this.getSubLayerClass(o,__.type);if(c){const d=Am(this,__.props),a=e&&t;return a||delete d.getLineColor,d.updateTriggers.lineColors=a,new c(d,this.getSubLayerProps({id:o,updateTriggers:d.updateTriggers}),r.polygons)}return null}_renderLineLayers(){const{extruded:e,stroked:t}=this.props,{layerProps:r}=this.state,o="polygons-stroke",c="linestrings",d=!e&&t&&this.shouldRenderSubLayer(o,r.polygonsOutline?.data)&&this.getSubLayerClass(o,Lf.type),a=this.shouldRenderSubLayer(c,r.lines?.data)&&this.getSubLayerClass(c,Lf.type);if(d||a){const y=Am(this,Lf.props);return[d&&new d(y,this.getSubLayerProps({id:o,updateTriggers:y.updateTriggers}),r.polygonsOutline),a&&new a(y,this.getSubLayerProps({id:c,updateTriggers:y.updateTriggers}),r.lines)]}return null}_renderPointLayers(){const{pointType:e}=this.props,{layerProps:t,binary:r}=this.state;let{highlightedObjectIndex:o}=this.props;!r&&Number.isFinite(o)&&(o=t.points.data.findIndex(a=>a.__source.index===o));const c=new Set(e.split("+")),d=[];for(const a of c){const y=`points-${a}`,w=Of[a],E=w&&this.shouldRenderSubLayer(y,t.points?.data)&&this.getSubLayerClass(y,w.type);if(E){const I=Am(this,w.props);let D=t.points;if(a==="text"&&r){const{instancePickingColors:F,...X}=D.data.attributes;D={...D,data:{...D.data,attributes:X}}}d.push(new E(I,this.getSubLayerProps({id:y,updateTriggers:I.updateTriggers,highlightedObjectIndex:o}),D))}}return d}renderLayers(){const{extruded:e}=this.props,t=this._renderPolygonLayer(),r=this._renderLineLayers(),o=this._renderPointLayers();return[!e&&t,r,o,e&&t]}getSubLayerAccessor(e){const{binary:t}=this.state;return!t||typeof e!="function"?super.getSubLayerAccessor(e):(r,o)=>{const{data:c,index:d}=o,a=F4(c,d);return e(a,o)}}}cp.layerName="GeoJsonLayer";cp.defaultProps=gB;const Ph="mapbox",Pm=512,mB=Math.PI/180;function DT({map:i,gl:e,deck:t}){if(i.__deck)return i.__deck;const r=t?.props._customRender,o=t?.props.onLoad,c={...t?.props,_customRender:()=>{i.triggerRepaint(),r?.("")}};c.parameters={...Ff(i,!0),...c.parameters},c.views||(c.views=_h(i));let d;return(!t||t.props.gl===e)&&(Object.assign(c,{gl:e,width:null,height:null,touchAction:"unset",viewState:Ch(i)}),t?.isInitialized?X0(t,i):c.onLoad=()=>{o?.(),X0(d,i)}),t?(d=t,t.setProps(c),t.userData.isExternal=!0):(d=new Sh(c),i.on("remove",()=>{OT(i)})),d.userData.mapboxLayers=new Set,i.__deck=d,i.on("render",()=>{d.isInitialized&&wB(d,i)}),d}function X0(i,e){const t=()=>{i.isInitialized?TB(i,e):e.off("move",t)};e.on("move",t)}function OT(i){i.__deck?.finalize(),i.__deck=null}function Ff(i,e){const t=e?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return _y(i)==="globe"&&(t.cullMode="back"),t}function _B(i,e){i.userData.mapboxLayers.add(e),yy(i)}function yB(i,e){i.userData.mapboxLayers.delete(e),yy(i)}function xB(i,e){yy(i)}function vB(i,e,t,r){let{currentViewport:o}=i.userData,c=!1;o||(o=LT(i,e,r),i.userData.currentViewport=o,c=!0),i.isInitialized&&i._drawLayers("mapbox-repaint",{viewports:[o],layerFilter:d=>(!i.props.layerFilter||i.props.layerFilter(d))&&(t.id===d.layer.id||d.layer.props.operation.includes("terrain")),clearStack:c,clearCanvas:!1})}function _y(i){const e=i.getProjection?.(),t=e?.type||e?.name;if(t==="globe")return"globe";if(t&&t!=="mercator")throw new Error("Unsupported projection");return"mercator"}function _h(i){return _y(i)==="globe"?new mT({id:Ph}):new ty({id:Ph})}function Ch(i){const{lng:e,lat:t}=i.getCenter(),r={longitude:(e+540)%360-180,latitude:t,zoom:i.getZoom(),bearing:i.getBearing(),pitch:i.getPitch(),padding:i.getPadding(),repeat:i.getRenderWorldCopies()};return i.getTerrain?.()&&bB(i,r),r}function bB(i,e){if(i.getFreeCameraOptions){const{position:t}=i.getFreeCameraOptions();if(!t||t.z===void 0)return;const r=i.transform.height,{longitude:o,latitude:c,pitch:d}=e,a=t.x*Pm,y=(1-t.y)*Pm,w=t.z*Pm,E=bh([o,c]),I=a-E[0],D=y-E[1],F=Math.sqrt(I*I+D*D),X=d*mB,oe=1.5*r,_e=X<.001?oe*Math.cos(X)/w:oe*Math.sin(X)/F;e.zoom=Math.log2(_e);const ge=oe*Math.cos(X)/_e,fe=w-ge;e.position=[0,0,fe/If(c)]}else typeof i.transform.elevation=="number"&&(e.position=[0,0,i.transform.elevation])}function LT(i,e,t){const r=Ch(e),{views:o}=i.props,c=o&&Va(o).find(y=>y.id===Ph)||_h(e);t&&(c.props.nearZMultiplier=.2);const d=t?.nearZ??e.transform._nearZ,a=t?.farZ??e.transform._farZ;return Number.isFinite(d)&&(r.nearZ=d/e.transform.height,r.farZ=a/e.transform.height),c.makeViewport({width:i.width,height:i.height,viewState:r})}function wB(i,e){const{mapboxLayers:t,isExternal:r}=i.userData;if(r){const o=Array.from(t,E=>E.id),d=Va(i.props.layers,Boolean).some(E=>E&&!o.includes(E.id));let a=i.getViewports();const y=a.findIndex(E=>E.id===Ph),w=a.length>1||y<0;(d||w)&&(y>=0&&(a=a.slice(),a[y]=LT(i,e)),i._drawLayers("mapbox-repaint",{viewports:a,layerFilter:E=>(!i.props.layerFilter||i.props.layerFilter(E))&&(E.viewport.id!==Ph||!o.includes(E.layer.id)),clearCanvas:!1}))}i.userData.currentViewport=null}function TB(i,e){i.setProps({viewState:Ch(e)}),i.needsRedraw({clearRedrawFlags:!0})}function yy(i){if(i.userData.isExternal)return;const e=[];i.userData.mapboxLayers.forEach(t=>{const r=t.props.type,o=new r(t.props);e.push(o)}),i.setProps({layers:e})}class SB{constructor(e){if(!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.map=null,this.deck=null,this.props=e}onAdd(e,t){this.map=e,this.deck=DT({map:e,gl:t,deck:this.props.deck}),_B(this.deck,this)}onRemove(){this.deck&&yB(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&xB(this.deck)}render(e,t){vB(this.deck,this.map,this,t)}}const Cm="__UNDEFINED__";function yf(i,e,t,r){if(!i||!e||!i.style||!i.style._loaded)return;const o=Va(r,Boolean);if(t!==r){const a=Va(t,Boolean),y=new Set(a.map(w=>w.id));for(const w of o)y.delete(w.id);for(const w of y)i.getLayer(w)&&i.removeLayer(w)}for(const a of o){const y=i.getLayer(a.id);y?(y.implementation||y).setProps(a.props):i.addLayer(new SB({id:a.id,deck:e,slot:a.props.slot}),a.props.beforeId)}const c=i.style._order,d={};for(const a of o){let{beforeId:y}=a.props;(!y||!c.includes(y))&&(y=Cm),d[y]=d[y]||[],d[y].push(a.id)}for(const a in d){const y=d[a];let w=a===Cm?c.length:c.indexOf(a),E=a===Cm?void 0:a;for(let I=y.length-1;I>=0;I--){const D=y[I],F=c.indexOf(D);F!==w-1&&(i.moveLayer(D,E),F>w&&w++),w--,E=D}}}class EB{constructor(e){this._handleStyleChange=()=>{if(yf(this._map,this._deck,this._props.layers,this._props.layers),!this._map)return;_y(this._map)&&!this._props.views&&this._deck?.setProps({views:_h(this._map)})},this._updateContainerSize=()=>{if(this._map&&this._container){const{clientWidth:r,clientHeight:o}=this._map.getContainer();Object.assign(this._container.style,{width:`${r}px`,height:`${o}px`})}},this._updateViewState=()=>{const r=this._deck,o=this._map;r&&o&&(r.setProps({views:this._props.views||_h(o),viewState:Ch(o)}),r.isInitialized&&r.redraw())},this._handleMouseEvent=r=>{const o=this._deck;if(!o||!o.isInitialized)return;const c={type:r.type,offsetCenter:r.point,srcEvent:r},d=this._lastMouseDownPoint;switch(!r.point&&d&&(c.deltaX=r.originalEvent.clientX-d.clientX,c.deltaY=r.originalEvent.clientY-d.clientY,c.offsetCenter={x:d.x+c.deltaX,y:d.y+c.deltaY}),c.type){case"mousedown":o._onPointerDown(c),this._lastMouseDownPoint={...r.point,clientX:r.originalEvent.clientX,clientY:r.originalEvent.clientY};break;case"dragstart":c.type="panstart",o._onEvent(c);break;case"drag":c.type="panmove",o._onEvent(c);break;case"dragend":c.type="panend",o._onEvent(c);break;case"click":c.tapCount=1,o._onEvent(c);break;case"dblclick":c.type="click",c.tapCount=2,o._onEvent(c);break;case"mousemove":c.type="pointermove",o._onPointerMove(c);break;case"mouseout":c.type="pointerleave",o._onPointerMove(c);break;default:return}};const{interleaved:t=!1}=e;this._interleaved=t,this._props=this.filterProps(e)}filterProps(e){const{interleaved:t=!1,useDevicePixels:r,...o}=e;return!t&&r!==void 0&&(o.useDevicePixels=r),o}setProps(e){this._interleaved&&e.layers&&yf(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,this.filterProps(e)),this._deck&&this._map&&this._deck.setProps({...this._props,parameters:{...Ff(this._map,this._interleaved),...this._props.parameters}})}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){const t=document.createElement("div");return Object.assign(t.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=t,this._deck=new Sh({...this._props,parent:t,parameters:{...Ff(e,!1),...this._props.parameters},views:this._props.views||_h(e),viewState:Ch(e)}),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousedown",this._handleMouseEvent),e.on("dragstart",this._handleMouseEvent),e.on("drag",this._handleMouseEvent),e.on("dragend",this._handleMouseEvent),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),t}_onAddInterleaved(e){const t=e.painter.context.gl;return t instanceof WebGLRenderingContext&&ii.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=DT({map:e,gl:t,deck:new Sh({...this._props,gl:t,parameters:{...Ff(e,!1),...this._props.parameters},deviceProps:{createCanvasContext:{autoResize:!0}}})}),e.on("styledata",this._handleStyleChange),yf(e,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){const e=this._map;e&&(this._interleaved?this._onRemoveInterleaved(e):this._onRemoveOverlaid(e)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousedown",this._handleMouseEvent),e.off("dragstart",this._handleMouseEvent),e.off("drag",this._handleMouseEvent),e.off("dragend",this._handleMouseEvent),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent),this._deck?.finalize()}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),yf(e,this._deck,this._props.layers,[]),OT(e)}getDefaultPosition(){return"top-left"}pickObject(e){return ur(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return ur(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return ur(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}}var Bf={exports:{}};/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v5.2.0/LICENSE.txt
 */var AB=Bf.exports,G0;function PB(){return G0||(G0=1,(function(i,e){(function(t,r){i.exports=r()})(AB,(function(){var t={},r={};function o(d,a,y){if(r[d]=y,d==="index"){var w="var sharedModule = {}; ("+r.shared+")(sharedModule); ("+r.worker+")(sharedModule);",E={};return r.shared(E),r.index(t,E),typeof window<"u"&&t.setWorkerUrl(window.URL.createObjectURL(new Blob([w],{type:"text/javascript"}))),t}}o("shared",["exports"],(function(d){function a(u,s,h,f){return new(h||(h=Promise))((function(m,v){function b(M){try{P(f.next(M))}catch(k){v(k)}}function S(M){try{P(f.throw(M))}catch(k){v(k)}}function P(M){var k;M.done?m(M.value):(k=M.value,k instanceof h?k:new h((function(O){O(k)}))).then(b,S)}P((f=f.apply(u,s||[])).next())}))}function y(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var w,E;function I(){if(E)return w;function u(s,h){this.x=s,this.y=h}return E=1,w=u,u.prototype={clone:function(){return new u(this.x,this.y)},add:function(s){return this.clone()._add(s)},sub:function(s){return this.clone()._sub(s)},multByPoint:function(s){return this.clone()._multByPoint(s)},divByPoint:function(s){return this.clone()._divByPoint(s)},mult:function(s){return this.clone()._mult(s)},div:function(s){return this.clone()._div(s)},rotate:function(s){return this.clone()._rotate(s)},rotateAround:function(s,h){return this.clone()._rotateAround(s,h)},matMult:function(s){return this.clone()._matMult(s)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(s){return this.x===s.x&&this.y===s.y},dist:function(s){return Math.sqrt(this.distSqr(s))},distSqr:function(s){var h=s.x-this.x,f=s.y-this.y;return h*h+f*f},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(s){return Math.atan2(this.y-s.y,this.x-s.x)},angleWith:function(s){return this.angleWithSep(s.x,s.y)},angleWithSep:function(s,h){return Math.atan2(this.x*h-this.y*s,this.x*s+this.y*h)},_matMult:function(s){var h=s[2]*this.x+s[3]*this.y;return this.x=s[0]*this.x+s[1]*this.y,this.y=h,this},_add:function(s){return this.x+=s.x,this.y+=s.y,this},_sub:function(s){return this.x-=s.x,this.y-=s.y,this},_mult:function(s){return this.x*=s,this.y*=s,this},_div:function(s){return this.x/=s,this.y/=s,this},_multByPoint:function(s){return this.x*=s.x,this.y*=s.y,this},_divByPoint:function(s){return this.x/=s.x,this.y/=s.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var s=this.y;return this.y=this.x,this.x=-s,this},_rotate:function(s){var h=Math.cos(s),f=Math.sin(s),m=f*this.x+h*this.y;return this.x=h*this.x-f*this.y,this.y=m,this},_rotateAround:function(s,h){var f=Math.cos(s),m=Math.sin(s),v=h.y+m*(this.x-h.x)+f*(this.y-h.y);return this.x=h.x+f*(this.x-h.x)-m*(this.y-h.y),this.y=v,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},u.convert=function(s){return s instanceof u?s:Array.isArray(s)?new u(s[0],s[1]):s},w}typeof SuppressedError=="function"&&SuppressedError;var D,F,X=y(I()),oe=(function(){if(F)return D;function u(s,h,f,m){this.cx=3*s,this.bx=3*(f-s)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*h,this.by=3*(m-h)-this.cy,this.ay=1-this.cy-this.by,this.p1x=s,this.p1y=h,this.p2x=f,this.p2y=m}return F=1,D=u,u.prototype={sampleCurveX:function(s){return((this.ax*s+this.bx)*s+this.cx)*s},sampleCurveY:function(s){return((this.ay*s+this.by)*s+this.cy)*s},sampleCurveDerivativeX:function(s){return(3*this.ax*s+2*this.bx)*s+this.cx},solveCurveX:function(s,h){if(h===void 0&&(h=1e-6),s<0)return 0;if(s>1)return 1;for(var f=s,m=0;m<8;m++){var v=this.sampleCurveX(f)-s;if(Math.abs(v)<h)return f;var b=this.sampleCurveDerivativeX(f);if(Math.abs(b)<1e-6)break;f-=v/b}var S=0,P=1;for(f=s,m=0;m<20&&(v=this.sampleCurveX(f),!(Math.abs(v-s)<h));m++)s>v?S=f:P=f,f=.5*(P-S)+S;return f},solve:function(s,h){return this.sampleCurveY(this.solveCurveX(s,h))}},D})(),_e=y(oe);let ge,fe;function Te(){return ge==null&&(ge=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")&&typeof createImageBitmap=="function"),ge}function ke(){if(fe==null&&(fe=!1,Te())){const s=new OffscreenCanvas(5,5).getContext("2d",{willReadFrequently:!0});if(s){for(let f=0;f<25;f++){const m=4*f;s.fillStyle=`rgb(${m},${m+1},${m+2})`,s.fillRect(f%5,Math.floor(f/5),1,1)}const h=s.getImageData(0,0,5,5).data;for(let f=0;f<100;f++)if(f%4!=3&&h[f]!==f){fe=!0;break}}}return fe||!1}var Je,Xe=1e-6,mt=typeof Float32Array<"u"?Float32Array:Array;function G(){var u=new mt(9);return mt!=Float32Array&&(u[1]=0,u[2]=0,u[3]=0,u[5]=0,u[6]=0,u[7]=0),u[0]=1,u[4]=1,u[8]=1,u}function J(u){return u[0]=1,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=1,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=1,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u}function ae(){var u=new mt(3);return mt!=Float32Array&&(u[0]=0,u[1]=0,u[2]=0),u}function be(u,s,h){var f=new mt(3);return f[0]=u,f[1]=s,f[2]=h,f}function ye(u,s,h){var f=s[0],m=s[1],v=s[2],b=s[3];return u[0]=h[0]*f+h[4]*m+h[8]*v+h[12]*b,u[1]=h[1]*f+h[5]*m+h[9]*v+h[13]*b,u[2]=h[2]*f+h[6]*m+h[10]*v+h[14]*b,u[3]=h[3]*f+h[7]*m+h[11]*v+h[15]*b,u}function we(){var u=new mt(4);return mt!=Float32Array&&(u[0]=0,u[1]=0,u[2]=0),u[3]=1,u}function Se(){var u=new mt(2);return mt!=Float32Array&&(u[0]=0,u[1]=0),u}function Ee(u,s){var h=new mt(2);return h[0]=u,h[1]=s,h}Math.hypot||(Math.hypot=function(){for(var u=0,s=arguments.length;s--;)u+=arguments[s]*arguments[s];return Math.sqrt(u)}),ae(),Je=new mt(4),mt!=Float32Array&&(Je[0]=0,Je[1]=0,Je[2]=0,Je[3]=0),ae(),be(1,0,0),be(0,1,0),we(),we(),G(),Se();const W=8192;function ee(u,s,h){return s*(W/(u.tileSize*Math.pow(2,h-u.tileID.overscaledZ)))}function K(u,s){return(u%s+s)%s}function Ce(u,s,h){return u*(1-h)+s*h}function je(u){if(u<=0)return 0;if(u>=1)return 1;const s=u*u,h=s*u;return 4*(u<.5?h:3*(u-s)+h-.75)}function Ge(u,s,h,f){const m=new _e(u,s,h,f);return v=>m.solve(v)}const tt=Ge(.25,.1,.25,1);function pt(u,s,h){return Math.min(h,Math.max(s,u))}function bt(u,s,h){const f=h-s,m=((u-s)%f+f)%f+s;return m===s?h:m}function _t(u,...s){for(const h of s)for(const f in h)u[f]=h[f];return u}let Lt=1;function Ut(u,s,h){const f={};for(const m in u)f[m]=s.call(this,u[m],m,u);return f}function Wt(u,s,h){const f={};for(const m in u)s.call(this,u[m],m,u)&&(f[m]=u[m]);return f}function oi(u){return Array.isArray(u)?u.map(oi):typeof u=="object"&&u?Ut(u,oi):u}const ei={};function ci(u){ei[u]||(typeof console<"u"&&console.warn(u),ei[u]=!0)}function di(u,s,h){return(h.y-u.y)*(s.x-u.x)>(s.y-u.y)*(h.x-u.x)}function Ai(u){return typeof WorkerGlobalScope<"u"&&u!==void 0&&u instanceof WorkerGlobalScope}let Yt=null;function kt(u){return typeof ImageBitmap<"u"&&u instanceof ImageBitmap}const Jt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function sn(u,s,h,f,m){return a(this,void 0,void 0,(function*(){if(typeof VideoFrame>"u")throw new Error("VideoFrame not supported");const v=new VideoFrame(u,{timestamp:0});try{const b=v?.format;if(!b||!b.startsWith("BGR")&&!b.startsWith("RGB"))throw new Error(`Unrecognized format ${b}`);const S=b.startsWith("BGR"),P=new Uint8ClampedArray(f*m*4);if(yield v.copyTo(P,(function(M,k,O,U,j){const $=4*Math.max(1,0),Z=(Math.max(0,O)-O)*U*4+$,te=4*U,ce=Math.max(0,k),Me=Math.max(0,O);return{rect:{x:ce,y:Me,width:Math.min(M.width,k+U)-ce,height:Math.min(M.height,O+j)-Me},layout:[{offset:Z,stride:te}]}})(u,s,h,f,m)),S)for(let M=0;M<P.length;M+=4){const k=P[M];P[M]=P[M+2],P[M+2]=k}return P}finally{v.close()}}))}let rs,ns;function bn(u,s,h,f){return u.addEventListener(s,h,f),{unsubscribe:()=>{u.removeEventListener(s,h,f)}}}function on(u){return u/Math.PI*180}const so="AbortError";function Ps(){return new Error(so)}const Cs={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function oo(u){return Cs.REGISTERED_PROTOCOLS[u.substring(0,u.indexOf("://"))]}const Is="global-dispatcher";class Nn extends Error{constructor(s,h,f,m){super(`AJAXError: ${h} (${s}): ${f}`),this.status=s,this.statusText=h,this.url=f,this.body=m}}const zn=()=>Ai(self)?self.worker&&self.worker.referrer:(window.location.protocol==="blob:"?window.parent:window).location.href,ss=function(u,s){if(/:\/\//.test(u.url)&&!/^https?:|^file:/.test(u.url)){const f=oo(u.url);if(f)return f(u,s);if(Ai(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:u,targetMapId:Is},s)}if(!(/^file:/.test(h=u.url)||/^file:/.test(zn())&&!/^\w+:/.test(h))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return(function(f,m){return a(this,void 0,void 0,(function*(){const v=new Request(f.url,{method:f.method||"GET",body:f.body,credentials:f.credentials,headers:f.headers,cache:f.cache,referrer:zn(),signal:m.signal});let b,S;f.type!=="json"||v.headers.has("Accept")||v.headers.set("Accept","application/json");try{b=yield fetch(v)}catch(M){throw new Nn(0,M.message,f.url,new Blob)}if(!b.ok){const M=yield b.blob();throw new Nn(b.status,b.statusText,f.url,M)}S=f.type==="arrayBuffer"||f.type==="image"?b.arrayBuffer():f.type==="json"?b.json():b.text();const P=yield S;if(m.signal.aborted)throw Ps();return{data:P,cacheControl:b.headers.get("Cache-Control"),expires:b.headers.get("Expires")}}))})(u,s);if(Ai(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:u,mustQueue:!0,targetMapId:Is},s)}var h;return(function(f,m){return new Promise(((v,b)=>{var S;const P=new XMLHttpRequest;P.open(f.method||"GET",f.url,!0),f.type!=="arrayBuffer"&&f.type!=="image"||(P.responseType="arraybuffer");for(const M in f.headers)P.setRequestHeader(M,f.headers[M]);f.type==="json"&&(P.responseType="text",!((S=f.headers)===null||S===void 0)&&S.Accept||P.setRequestHeader("Accept","application/json")),P.withCredentials=f.credentials==="include",P.onerror=()=>{b(new Error(P.statusText))},P.onload=()=>{if(!m.signal.aborted)if((P.status>=200&&P.status<300||P.status===0)&&P.response!==null){let M=P.response;if(f.type==="json")try{M=JSON.parse(P.response)}catch(k){return void b(k)}v({data:M,cacheControl:P.getResponseHeader("Cache-Control"),expires:P.getResponseHeader("Expires")})}else{const M=new Blob([P.response],{type:P.getResponseHeader("Content-Type")});b(new Nn(P.status,P.statusText,f.url,M))}},m.signal.addEventListener("abort",(()=>{P.abort(),b(Ps())})),P.send(f.body)}))})(u,s)};function os(u){if(!u||u.indexOf("://")<=0||u.indexOf("data:image/")===0||u.indexOf("blob:")===0)return!0;const s=new URL(u),h=window.location;return s.protocol===h.protocol&&s.host===h.host}function Xo(u,s,h){h[u]&&h[u].indexOf(s)!==-1||(h[u]=h[u]||[],h[u].push(s))}function ao(u,s,h){if(h&&h[u]){const f=h[u].indexOf(s);f!==-1&&h[u].splice(f,1)}}class Go{constructor(s,h={}){_t(this,h),this.type=s}}class Un extends Go{constructor(s,h={}){super("error",_t({error:s},h))}}class Ne{on(s,h){return this._listeners=this._listeners||{},Xo(s,h,this._listeners),{unsubscribe:()=>{this.off(s,h)}}}off(s,h){return ao(s,h,this._listeners),ao(s,h,this._oneTimeListeners),this}once(s,h){return h?(this._oneTimeListeners=this._oneTimeListeners||{},Xo(s,h,this._oneTimeListeners),this):new Promise((f=>this.once(s,f)))}fire(s,h){typeof s=="string"&&(s=new Go(s,h||{}));const f=s.type;if(this.listens(f)){s.target=this;const m=this._listeners&&this._listeners[f]?this._listeners[f].slice():[];for(const S of m)S.call(this,s);const v=this._oneTimeListeners&&this._oneTimeListeners[f]?this._oneTimeListeners[f].slice():[];for(const S of v)ao(f,S,this._oneTimeListeners),S.call(this,s);const b=this._eventedParent;b&&(_t(s,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),b.fire(s))}else s instanceof Un&&console.error(s.error);return this}listens(s){return this._listeners&&this._listeners[s]&&this._listeners[s].length>0||this._oneTimeListeners&&this._oneTimeListeners[s]&&this._oneTimeListeners[s].length>0||this._eventedParent&&this._eventedParent.listens(s)}setEventedParent(s,h){return this._eventedParent=s,this._eventedParentData=h,this}}var B={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const Y=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function ie(u,s){const h={};for(const f in u)f!=="ref"&&(h[f]=u[f]);return Y.forEach((f=>{f in s&&(h[f]=s[f])})),h}function ue(u,s){if(Array.isArray(u)){if(!Array.isArray(s)||u.length!==s.length)return!1;for(let h=0;h<u.length;h++)if(!ue(u[h],s[h]))return!1;return!0}if(typeof u=="object"&&u!==null&&s!==null){if(typeof s!="object"||Object.keys(u).length!==Object.keys(s).length)return!1;for(const h in u)if(!ue(u[h],s[h]))return!1;return!0}return u===s}function Ae(u,s){u.push(s)}function Oe(u,s,h){Ae(h,{command:"addSource",args:[u,s[u]]})}function qe(u,s,h){Ae(s,{command:"removeSource",args:[u]}),h[u]=!0}function De(u,s,h,f){qe(u,h,f),Oe(u,s,h)}function rt(u,s,h){let f;for(f in u[h])if(Object.prototype.hasOwnProperty.call(u[h],f)&&f!=="data"&&!ue(u[h][f],s[h][f]))return!1;for(f in s[h])if(Object.prototype.hasOwnProperty.call(s[h],f)&&f!=="data"&&!ue(u[h][f],s[h][f]))return!1;return!0}function Ke(u,s,h,f,m,v){u=u||{},s=s||{};for(const b in u)Object.prototype.hasOwnProperty.call(u,b)&&(ue(u[b],s[b])||h.push({command:v,args:[f,b,s[b],m]}));for(const b in s)Object.prototype.hasOwnProperty.call(s,b)&&!Object.prototype.hasOwnProperty.call(u,b)&&(ue(u[b],s[b])||h.push({command:v,args:[f,b,s[b],m]}))}function ze(u){return u.id}function at(u,s){return u[s.id]=s,u}class Ue{constructor(s,h,f,m){this.message=(s?`${s}: `:"")+f,m&&(this.identifier=m),h!=null&&h.__line__&&(this.line=h.__line__)}}function vt(u,...s){for(const h of s)for(const f in h)u[f]=h[f];return u}class It extends Error{constructor(s,h){super(h),this.message=h,this.key=s}}class Vt{constructor(s,h=[]){this.parent=s,this.bindings={};for(const[f,m]of h)this.bindings[f]=m}concat(s){return new Vt(this,s)}get(s){if(this.bindings[s])return this.bindings[s];if(this.parent)return this.parent.get(s);throw new Error(`${s} not found in scope.`)}has(s){return!!this.bindings[s]||!!this.parent&&this.parent.has(s)}}const Nt={kind:"null"},ot={kind:"number"},At={kind:"string"},Et={kind:"boolean"},Ht={kind:"color"},zt={kind:"projectionDefinition"},Zt={kind:"object"},Dt={kind:"value"},Ms={kind:"collator"},ji={kind:"formatted"},qi={kind:"padding"},bi={kind:"resolvedImage"},Ha={kind:"variableAnchorOffsetCollection"};function Cr(u,s){return{kind:"array",itemType:u,N:s}}function mi(u){if(u.kind==="array"){const s=mi(u.itemType);return typeof u.N=="number"?`array<${s}, ${u.N}>`:u.itemType.kind==="value"?"array":`array<${s}>`}return u.kind}const Bh=[Nt,ot,At,Et,Ht,zt,ji,Zt,Cr(Dt),qi,bi,Ha];function Yo(u,s){if(s.kind==="error")return null;if(u.kind==="array"){if(s.kind==="array"&&(s.N===0&&s.itemType.kind==="value"||!Yo(u.itemType,s.itemType))&&(typeof u.N!="number"||u.N===s.N))return null}else{if(u.kind===s.kind)return null;if(u.kind==="value"){for(const h of Bh)if(!Yo(h,s))return null}}return`Expected ${mi(u)} but found ${mi(s)} instead.`}function Ac(u,s){return s.some((h=>h.kind===u.kind))}function as(u,s){return s.some((h=>h==="null"?u===null:h==="array"?Array.isArray(u):h==="object"?u&&!Array.isArray(u)&&typeof u=="object":h===typeof u))}function lo(u,s){return u.kind==="array"&&s.kind==="array"?u.itemType.kind===s.itemType.kind&&typeof u.N=="number":u.kind===s.kind}const Pc=.96422,Nh=.82521,zh=4/29,co=6/29,Uh=3*co*co,wp=co*co*co,Tp=Math.PI/180,Sp=180/Math.PI;function Cc(u){return(u%=360)<0&&(u+=360),u}function uo([u,s,h,f]){let m,v;const b=Mc((.2225045*(u=Ic(u))+.7168786*(s=Ic(s))+.0606169*(h=Ic(h)))/1);u===s&&s===h?m=v=b:(m=Mc((.4360747*u+.3850649*s+.1430804*h)/Pc),v=Mc((.0139322*u+.0971045*s+.7141733*h)/Nh));const S=116*b-16;return[S<0?0:S,500*(m-b),200*(b-v),f]}function Ic(u){return u<=.04045?u/12.92:Math.pow((u+.055)/1.055,2.4)}function Mc(u){return u>wp?Math.pow(u,1/3):u/Uh+zh}function ho([u,s,h,f]){let m=(u+16)/116,v=isNaN(s)?m:m+s/500,b=isNaN(h)?m:m-h/200;return m=1*kc(m),v=Pc*kc(v),b=Nh*kc(b),[Rc(3.1338561*v-1.6168667*m-.4906146*b),Rc(-.9787684*v+1.9161415*m+.033454*b),Rc(.0719453*v-.2289914*m+1.4052427*b),f]}function Rc(u){return(u=u<=.00304?12.92*u:1.055*Math.pow(u,1/2.4)-.055)<0?0:u>1?1:u}function kc(u){return u>co?u*u*u:Uh*(u-zh)}function Za(u){return parseInt(u.padEnd(2,u),16)/255}function Dc(u,s){return Rs(s?u/100:u,0,1)}function Rs(u,s,h){return Math.min(Math.max(s,u),h)}function an(u){return!u.some(Number.isNaN)}const ri={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function zr(u,s,h){return u+h*(s-u)}function qr(u,s,h){return u.map(((f,m)=>zr(f,s[m],h)))}class ni{constructor(s,h,f,m=1,v=!0){this.r=s,this.g=h,this.b=f,this.a=m,v||(this.r*=m,this.g*=m,this.b*=m,m||this.overwriteGetter("rgb",[s,h,f,m]))}static parse(s){if(s instanceof ni)return s;if(typeof s!="string")return;const h=(function(f){if((f=f.toLowerCase().trim())==="transparent")return[0,0,0,0];const m=ri[f];if(m){const[b,S,P]=m;return[b/255,S/255,P/255,1]}if(f.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(f)){const b=f.length<6?1:2;let S=1;return[Za(f.slice(S,S+=b)),Za(f.slice(S,S+=b)),Za(f.slice(S,S+=b)),Za(f.slice(S,S+b)||"ff")]}if(f.startsWith("rgb")){const b=f.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(b){const[S,P,M,k,O,U,j,$,Z,te,ce,Me]=b,pe=[k||" ",j||" ",te].join("");if(pe==="  "||pe==="  /"||pe===",,"||pe===",,,"){const V=[M,U,Z].join(""),Q=V==="%%%"?100:V===""?255:0;if(Q){const me=[Rs(+P/Q,0,1),Rs(+O/Q,0,1),Rs(+$/Q,0,1),ce?Dc(+ce,Me):1];if(an(me))return me}}return}}const v=f.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(v){const[b,S,P,M,k,O,U,j,$]=v,Z=[P||" ",k||" ",U].join("");if(Z==="  "||Z==="  /"||Z===",,"||Z===",,,"){const te=[+S,Rs(+M,0,100),Rs(+O,0,100),j?Dc(+j,$):1];if(an(te))return(function([ce,Me,pe,V]){function Q(me){const We=(me+ce/30)%12,lt=Me*Math.min(pe,1-pe);return pe-lt*Math.max(-1,Math.min(We-3,9-We,1))}return ce=Cc(ce),Me/=100,pe/=100,[Q(0),Q(8),Q(4),V]})(te)}}})(s);return h?new ni(...h,!1):void 0}get rgb(){const{r:s,g:h,b:f,a:m}=this,v=m||1/0;return this.overwriteGetter("rgb",[s/v,h/v,f/v,m])}get hcl(){return this.overwriteGetter("hcl",(function(s){const[h,f,m,v]=uo(s),b=Math.sqrt(f*f+m*m);return[Math.round(1e4*b)?Cc(Math.atan2(m,f)*Sp):NaN,b,h,v]})(this.rgb))}get lab(){return this.overwriteGetter("lab",uo(this.rgb))}overwriteGetter(s,h){return Object.defineProperty(this,s,{value:h}),h}toString(){const[s,h,f,m]=this.rgb;return`rgba(${[s,h,f].map((v=>Math.round(255*v))).join(",")},${m})`}static interpolate(s,h,f,m="rgb"){switch(m){case"rgb":{const[v,b,S,P]=qr(s.rgb,h.rgb,f);return new ni(v,b,S,P,!1)}case"hcl":{const[v,b,S,P]=s.hcl,[M,k,O,U]=h.hcl;let j,$;if(isNaN(v)||isNaN(M))isNaN(v)?isNaN(M)?j=NaN:(j=M,S!==1&&S!==0||($=k)):(j=v,O!==1&&O!==0||($=b));else{let pe=M-v;M>v&&pe>180?pe-=360:M<v&&v-M>180&&(pe+=360),j=v+f*pe}const[Z,te,ce,Me]=(function([pe,V,Q,me]){return pe=isNaN(pe)?0:pe*Tp,ho([Q,Math.cos(pe)*V,Math.sin(pe)*V,me])})([j,$??zr(b,k,f),zr(S,O,f),zr(P,U,f)]);return new ni(Z,te,ce,Me,!1)}case"lab":{const[v,b,S,P]=ho(qr(s.lab,h.lab,f));return new ni(v,b,S,P,!1)}}}}ni.black=new ni(0,0,0,1),ni.white=new ni(1,1,1,1),ni.transparent=new ni(0,0,0,0),ni.red=new ni(1,0,0,1);class qa{constructor(s,h,f){this.sensitivity=s?h?"variant":"case":h?"accent":"base",this.locale=f,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(s,h){return this.collator.compare(s,h)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const Oc=["bottom","center","top"];class Xr{constructor(s,h,f,m,v,b){this.text=s,this.image=h,this.scale=f,this.fontStack=m,this.textColor=v,this.verticalAlign=b}}class dr{constructor(s){this.sections=s}static fromString(s){return new dr([new Xr(s,null,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some((s=>s.text.length!==0||s.image&&s.image.name.length!==0))}static factory(s){return s instanceof dr?s:dr.fromString(s)}toString(){return this.sections.length===0?"":this.sections.map((s=>s.text)).join("")}}class er{constructor(s){this.values=s.slice()}static parse(s){if(s instanceof er)return s;if(typeof s=="number")return new er([s,s,s,s]);if(Array.isArray(s)&&!(s.length<1||s.length>4)){for(const h of s)if(typeof h!="number")return;switch(s.length){case 1:s=[s[0],s[0],s[0],s[0]];break;case 2:s=[s[0],s[1],s[0],s[1]];break;case 3:s=[s[0],s[1],s[2],s[1]]}return new er(s)}}toString(){return JSON.stringify(this.values)}static interpolate(s,h,f){return new er(qr(s.values,h.values,f))}}class ki{constructor(s){this.name="ExpressionEvaluationError",this.message=s}toJSON(){return this.message}}const Lc=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class tr{constructor(s){this.values=s.slice()}static parse(s){if(s instanceof tr)return s;if(Array.isArray(s)&&!(s.length<1)&&s.length%2==0){for(let h=0;h<s.length;h+=2){const f=s[h],m=s[h+1];if(typeof f!="string"||!Lc.has(f)||!Array.isArray(m)||m.length!==2||typeof m[0]!="number"||typeof m[1]!="number")return}return new tr(s)}}toString(){return JSON.stringify(this.values)}static interpolate(s,h,f){const m=s.values,v=h.values;if(m.length!==v.length)throw new ki(`Cannot interpolate values of different length. from: ${s.toString()}, to: ${h.toString()}`);const b=[];for(let S=0;S<m.length;S+=2){if(m[S]!==v[S])throw new ki(`Cannot interpolate values containing mismatched anchors. from[${S}]: ${m[S]}, to[${S}]: ${v[S]}`);b.push(m[S]);const[P,M]=m[S+1],[k,O]=v[S+1];b.push([zr(P,k,f),zr(M,O,f)])}return new tr(b)}}class Ar{constructor(s){this.name=s.name,this.available=s.available}toString(){return this.name}static fromString(s){return s?new Ar({name:s,available:!1}):null}}class Ir{constructor(s,h,f){this.from=s,this.to=h,this.transition=f}static interpolate(s,h,f){return new Ir(s,h,f)}static parse(s){return s instanceof Ir?s:Array.isArray(s)&&s.length===3&&typeof s[0]=="string"&&typeof s[1]=="string"&&typeof s[2]=="number"?new Ir(s[0],s[1],s[2]):typeof s=="object"&&typeof s.from=="string"&&typeof s.to=="string"&&typeof s.transition=="number"?new Ir(s.from,s.to,s.transition):typeof s=="string"?new Ir(s,s,1):void 0}}function Xa(u,s,h,f){return typeof u=="number"&&u>=0&&u<=255&&typeof s=="number"&&s>=0&&s<=255&&typeof h=="number"&&h>=0&&h<=255?f===void 0||typeof f=="number"&&f>=0&&f<=1?null:`Invalid rgba value [${[u,s,h,f].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof f=="number"?[u,s,h,f]:[u,s,h]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ln(u){if(u===null||typeof u=="string"||typeof u=="boolean"||typeof u=="number"||u instanceof Ir||u instanceof ni||u instanceof qa||u instanceof dr||u instanceof er||u instanceof tr||u instanceof Ar)return!0;if(Array.isArray(u)){for(const s of u)if(!ln(s))return!1;return!0}if(typeof u=="object"){for(const s in u)if(!ln(u[s]))return!1;return!0}return!1}function $i(u){if(u===null)return Nt;if(typeof u=="string")return At;if(typeof u=="boolean")return Et;if(typeof u=="number")return ot;if(u instanceof ni)return Ht;if(u instanceof Ir)return zt;if(u instanceof qa)return Ms;if(u instanceof dr)return ji;if(u instanceof er)return qi;if(u instanceof tr)return Ha;if(u instanceof Ar)return bi;if(Array.isArray(u)){const s=u.length;let h;for(const f of u){const m=$i(f);if(h){if(h===m)continue;h=Dt;break}h=m}return Cr(h||Dt,s)}return Zt}function ls(u){const s=typeof u;return u===null?"":s==="string"||s==="number"||s==="boolean"?String(u):u instanceof ni||u instanceof Ir||u instanceof dr||u instanceof er||u instanceof tr||u instanceof Ar?u.toString():JSON.stringify(u)}class Gr{constructor(s,h){this.type=s,this.value=h}static parse(s,h){if(s.length!==2)return h.error(`'literal' expression requires exactly one argument, but found ${s.length-1} instead.`);if(!ln(s[1]))return h.error("invalid value");const f=s[1];let m=$i(f);const v=h.expectedType;return m.kind!=="array"||m.N!==0||!v||v.kind!=="array"||typeof v.N=="number"&&v.N!==0||(m=v),new Gr(m,f)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const Ko={string:At,number:ot,boolean:Et,object:Zt};class Yr{constructor(s,h){this.type=s,this.args=h}static parse(s,h){if(s.length<2)return h.error("Expected at least one argument.");let f,m=1;const v=s[0];if(v==="array"){let S,P;if(s.length>2){const M=s[1];if(typeof M!="string"||!(M in Ko)||M==="object")return h.error('The item type argument of "array" must be one of string, number, boolean',1);S=Ko[M],m++}else S=Dt;if(s.length>3){if(s[2]!==null&&(typeof s[2]!="number"||s[2]<0||s[2]!==Math.floor(s[2])))return h.error('The length argument to "array" must be a positive integer literal',2);P=s[2],m++}f=Cr(S,P)}else{if(!Ko[v])throw new Error(`Types doesn't contain name = ${v}`);f=Ko[v]}const b=[];for(;m<s.length;m++){const S=h.parse(s[m],m,Dt);if(!S)return null;b.push(S)}return new Yr(f,b)}evaluate(s){for(let h=0;h<this.args.length;h++){const f=this.args[h].evaluate(s);if(!Yo(this.type,$i(f)))return f;if(h===this.args.length-1)throw new ki(`Expected value to be of type ${mi(this.type)}, but found ${mi($i(f))} instead.`)}throw new Error}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every((s=>s.outputDefined()))}}const Fc={"to-boolean":Et,"to-color":Ht,"to-number":ot,"to-string":At};class cn{constructor(s,h){this.type=s,this.args=h}static parse(s,h){if(s.length<2)return h.error("Expected at least one argument.");const f=s[0];if(!Fc[f])throw new Error(`Can't parse ${f} as it is not part of the known types`);if((f==="to-boolean"||f==="to-string")&&s.length!==2)return h.error("Expected one argument.");const m=Fc[f],v=[];for(let b=1;b<s.length;b++){const S=h.parse(s[b],b,Dt);if(!S)return null;v.push(S)}return new cn(m,v)}evaluate(s){switch(this.type.kind){case"boolean":return!!this.args[0].evaluate(s);case"color":{let h,f;for(const m of this.args){if(h=m.evaluate(s),f=null,h instanceof ni)return h;if(typeof h=="string"){const v=s.parseColor(h);if(v)return v}else if(Array.isArray(h)&&(f=h.length<3||h.length>4?`Invalid rgba value ${JSON.stringify(h)}: expected an array containing either three or four numeric values.`:Xa(h[0],h[1],h[2],h[3]),!f))return new ni(h[0]/255,h[1]/255,h[2]/255,h[3])}throw new ki(f||`Could not parse color from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"padding":{let h;for(const f of this.args){h=f.evaluate(s);const m=er.parse(h);if(m)return m}throw new ki(`Could not parse padding from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"variableAnchorOffsetCollection":{let h;for(const f of this.args){h=f.evaluate(s);const m=tr.parse(h);if(m)return m}throw new ki(`Could not parse variableAnchorOffsetCollection from value '${typeof h=="string"?h:JSON.stringify(h)}'`)}case"number":{let h=null;for(const f of this.args){if(h=f.evaluate(s),h===null)return 0;const m=Number(h);if(!isNaN(m))return m}throw new ki(`Could not convert ${JSON.stringify(h)} to number.`)}case"formatted":return dr.fromString(ls(this.args[0].evaluate(s)));case"resolvedImage":return Ar.fromString(ls(this.args[0].evaluate(s)));case"projectionDefinition":return this.args[0].evaluate(s);default:return ls(this.args[0].evaluate(s))}}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every((s=>s.outputDefined()))}}const Pi=["Unknown","Point","LineString","Polygon"];class Ga{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Pi[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(s){let h=this._parseColorCache[s];return h||(h=this._parseColorCache[s]=ni.parse(s)),h}}class Qt{constructor(s,h,f=[],m,v=new Vt,b=[]){this.registry=s,this.path=f,this.key=f.map((S=>`[${S}]`)).join(""),this.scope=v,this.errors=b,this.expectedType=m,this._isConstant=h}parse(s,h,f,m,v={}){return h?this.concat(h,f,m)._parse(s,v):this._parse(s,v)}_parse(s,h){function f(m,v,b){return b==="assert"?new Yr(v,[m]):b==="coerce"?new cn(v,[m]):m}if(s!==null&&typeof s!="string"&&typeof s!="boolean"&&typeof s!="number"||(s=["literal",s]),Array.isArray(s)){if(s.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const m=s[0];if(typeof m!="string")return this.error(`Expression name must be a string, but found ${typeof m} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const v=this.registry[m];if(v){let b=v.parse(s,this);if(!b)return null;if(this.expectedType){const S=this.expectedType,P=b.type;if(S.kind!=="string"&&S.kind!=="number"&&S.kind!=="boolean"&&S.kind!=="object"&&S.kind!=="array"||P.kind!=="value")if(S.kind!=="projectionDefinition"||P.kind!=="string"&&P.kind!=="array")if(S.kind!=="color"&&S.kind!=="formatted"&&S.kind!=="resolvedImage"||P.kind!=="value"&&P.kind!=="string")if(S.kind!=="padding"||P.kind!=="value"&&P.kind!=="number"&&P.kind!=="array")if(S.kind!=="variableAnchorOffsetCollection"||P.kind!=="value"&&P.kind!=="array"){if(this.checkSubtype(S,P))return null}else b=f(b,S,h.typeAnnotation||"coerce");else b=f(b,S,h.typeAnnotation||"coerce");else b=f(b,S,h.typeAnnotation||"coerce");else b=f(b,S,h.typeAnnotation||"coerce");else b=f(b,S,h.typeAnnotation||"assert")}if(!(b instanceof Gr)&&b.type.kind!=="resolvedImage"&&this._isConstant(b)){const S=new Ga;try{b=new Gr(b.type,b.evaluate(S))}catch(P){return this.error(P.message),null}}return b}return this.error(`Unknown expression "${m}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(s===void 0?"'undefined' value invalid. Use null instead.":typeof s=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof s} instead.`)}concat(s,h,f){const m=typeof s=="number"?this.path.concat(s):this.path,v=f?this.scope.concat(f):this.scope;return new Qt(this.registry,this._isConstant,m,h||null,v,this.errors)}error(s,...h){const f=`${this.key}${h.map((m=>`[${m}]`)).join("")}`;this.errors.push(new It(f,s))}checkSubtype(s,h){const f=Yo(s,h);return f&&this.error(f),f}}class $t{constructor(s,h){this.type=h.type,this.bindings=[].concat(s),this.result=h}evaluate(s){return this.result.evaluate(s)}eachChild(s){for(const h of this.bindings)s(h[1]);s(this.result)}static parse(s,h){if(s.length<4)return h.error(`Expected at least 3 arguments, but found ${s.length-1} instead.`);const f=[];for(let v=1;v<s.length-1;v+=2){const b=s[v];if(typeof b!="string")return h.error(`Expected string, but found ${typeof b} instead.`,v);if(/[^a-zA-Z0-9_]/.test(b))return h.error("Variable names must contain only alphanumeric characters or '_'.",v);const S=h.parse(s[v+1],v+1);if(!S)return null;f.push([b,S])}const m=h.parse(s[s.length-1],s.length-1,h.expectedType,f);return m?new $t(f,m):null}outputDefined(){return this.result.outputDefined()}}class fo{constructor(s,h){this.type=h.type,this.name=s,this.boundExpression=h}static parse(s,h){if(s.length!==2||typeof s[1]!="string")return h.error("'var' expression requires exactly one string literal argument.");const f=s[1];return h.scope.has(f)?new fo(f,h.scope.get(f)):h.error(`Unknown variable "${f}". Make sure "${f}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(s){return this.boundExpression.evaluate(s)}eachChild(){}outputDefined(){return!1}}class ti{constructor(s,h,f){this.type=s,this.index=h,this.input=f}static parse(s,h){if(s.length!==3)return h.error(`Expected 2 arguments, but found ${s.length-1} instead.`);const f=h.parse(s[1],1,ot),m=h.parse(s[2],2,Cr(h.expectedType||Dt));return f&&m?new ti(m.type.itemType,f,m):null}evaluate(s){const h=this.index.evaluate(s),f=this.input.evaluate(s);if(h<0)throw new ki(`Array index out of bounds: ${h} < 0.`);if(h>=f.length)throw new ki(`Array index out of bounds: ${h} > ${f.length-1}.`);if(h!==Math.floor(h))throw new ki(`Array index must be an integer, but found ${h} instead.`);return f[h]}eachChild(s){s(this.index),s(this.input)}outputDefined(){return!1}}class Jo{constructor(s,h){this.type=Et,this.needle=s,this.haystack=h}static parse(s,h){if(s.length!==3)return h.error(`Expected 2 arguments, but found ${s.length-1} instead.`);const f=h.parse(s[1],1,Dt),m=h.parse(s[2],2,Dt);return f&&m?Ac(f.type,[Et,At,ot,Nt,Dt])?new Jo(f,m):h.error(`Expected first argument to be of type boolean, string, number or null, but found ${mi(f.type)} instead`):null}evaluate(s){const h=this.needle.evaluate(s),f=this.haystack.evaluate(s);if(!f)return!1;if(!as(h,["boolean","string","number","null"]))throw new ki(`Expected first argument to be of type boolean, string, number or null, but found ${mi($i(h))} instead.`);if(!as(f,["string","array"]))throw new ki(`Expected second argument to be of type array or string, but found ${mi($i(f))} instead.`);return f.indexOf(h)>=0}eachChild(s){s(this.needle),s(this.haystack)}outputDefined(){return!0}}class Kr{constructor(s,h,f){this.type=ot,this.needle=s,this.haystack=h,this.fromIndex=f}static parse(s,h){if(s.length<=2||s.length>=5)return h.error(`Expected 3 or 4 arguments, but found ${s.length-1} instead.`);const f=h.parse(s[1],1,Dt),m=h.parse(s[2],2,Dt);if(!f||!m)return null;if(!Ac(f.type,[Et,At,ot,Nt,Dt]))return h.error(`Expected first argument to be of type boolean, string, number or null, but found ${mi(f.type)} instead`);if(s.length===4){const v=h.parse(s[3],3,ot);return v?new Kr(f,m,v):null}return new Kr(f,m)}evaluate(s){const h=this.needle.evaluate(s),f=this.haystack.evaluate(s);if(!as(h,["boolean","string","number","null"]))throw new ki(`Expected first argument to be of type boolean, string, number or null, but found ${mi($i(h))} instead.`);let m;if(this.fromIndex&&(m=this.fromIndex.evaluate(s)),as(f,["string"])){const v=f.indexOf(h,m);return v===-1?-1:[...f.slice(0,v)].length}if(as(f,["array"]))return f.indexOf(h,m);throw new ki(`Expected second argument to be of type array or string, but found ${mi($i(f))} instead.`)}eachChild(s){s(this.needle),s(this.haystack),this.fromIndex&&s(this.fromIndex)}outputDefined(){return!1}}class Qo{constructor(s,h,f,m,v,b){this.inputType=s,this.type=h,this.input=f,this.cases=m,this.outputs=v,this.otherwise=b}static parse(s,h){if(s.length<5)return h.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if(s.length%2!=1)return h.error("Expected an even number of arguments.");let f,m;h.expectedType&&h.expectedType.kind!=="value"&&(m=h.expectedType);const v={},b=[];for(let M=2;M<s.length-1;M+=2){let k=s[M];const O=s[M+1];Array.isArray(k)||(k=[k]);const U=h.concat(M);if(k.length===0)return U.error("Expected at least one branch label.");for(const $ of k){if(typeof $!="number"&&typeof $!="string")return U.error("Branch labels must be numbers or strings.");if(typeof $=="number"&&Math.abs($)>Number.MAX_SAFE_INTEGER)return U.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof $=="number"&&Math.floor($)!==$)return U.error("Numeric branch labels must be integer values.");if(f){if(U.checkSubtype(f,$i($)))return null}else f=$i($);if(v[String($)]!==void 0)return U.error("Branch labels must be unique.");v[String($)]=b.length}const j=h.parse(O,M,m);if(!j)return null;m=m||j.type,b.push(j)}const S=h.parse(s[1],1,Dt);if(!S)return null;const P=h.parse(s[s.length-1],s.length-1,m);return P?S.type.kind!=="value"&&h.concat(1).checkSubtype(f,S.type)?null:new Qo(f,m,S,v,b,P):null}evaluate(s){const h=this.input.evaluate(s);return($i(h)===this.inputType&&this.outputs[this.cases[h]]||this.otherwise).evaluate(s)}eachChild(s){s(this.input),this.outputs.forEach(s),s(this.otherwise)}outputDefined(){return this.outputs.every((s=>s.outputDefined()))&&this.otherwise.outputDefined()}}class Ya{constructor(s,h,f){this.type=s,this.branches=h,this.otherwise=f}static parse(s,h){if(s.length<4)return h.error(`Expected at least 3 arguments, but found only ${s.length-1}.`);if(s.length%2!=0)return h.error("Expected an odd number of arguments.");let f;h.expectedType&&h.expectedType.kind!=="value"&&(f=h.expectedType);const m=[];for(let b=1;b<s.length-1;b+=2){const S=h.parse(s[b],b,Et);if(!S)return null;const P=h.parse(s[b+1],b+1,f);if(!P)return null;m.push([S,P]),f=f||P.type}const v=h.parse(s[s.length-1],s.length-1,f);if(!v)return null;if(!f)throw new Error("Can't infer output type");return new Ya(f,m,v)}evaluate(s){for(const[h,f]of this.branches)if(h.evaluate(s))return f.evaluate(s);return this.otherwise.evaluate(s)}eachChild(s){for(const[h,f]of this.branches)s(h),s(f);s(this.otherwise)}outputDefined(){return this.branches.every((([s,h])=>h.outputDefined()))&&this.otherwise.outputDefined()}}class ea{constructor(s,h,f,m){this.type=s,this.input=h,this.beginIndex=f,this.endIndex=m}static parse(s,h){if(s.length<=2||s.length>=5)return h.error(`Expected 3 or 4 arguments, but found ${s.length-1} instead.`);const f=h.parse(s[1],1,Dt),m=h.parse(s[2],2,ot);if(!f||!m)return null;if(!Ac(f.type,[Cr(Dt),At,Dt]))return h.error(`Expected first argument to be of type array or string, but found ${mi(f.type)} instead`);if(s.length===4){const v=h.parse(s[3],3,ot);return v?new ea(f.type,f,m,v):null}return new ea(f.type,f,m)}evaluate(s){const h=this.input.evaluate(s),f=this.beginIndex.evaluate(s);let m;if(this.endIndex&&(m=this.endIndex.evaluate(s)),as(h,["string"]))return[...h].slice(f,m).join("");if(as(h,["array"]))return h.slice(f,m);throw new ki(`Expected first argument to be of type array or string, but found ${mi($i(h))} instead.`)}eachChild(s){s(this.input),s(this.beginIndex),this.endIndex&&s(this.endIndex)}outputDefined(){return!1}}function po(u,s){const h=u.length-1;let f,m,v=0,b=h,S=0;for(;v<=b;)if(S=Math.floor((v+b)/2),f=u[S],m=u[S+1],f<=s){if(S===h||s<m)return S;v=S+1}else{if(!(f>s))throw new ki("Input is not a number.");b=S-1}return 0}class go{constructor(s,h,f){this.type=s,this.input=h,this.labels=[],this.outputs=[];for(const[m,v]of f)this.labels.push(m),this.outputs.push(v)}static parse(s,h){if(s.length-1<4)return h.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if((s.length-1)%2!=0)return h.error("Expected an even number of arguments.");const f=h.parse(s[1],1,ot);if(!f)return null;const m=[];let v=null;h.expectedType&&h.expectedType.kind!=="value"&&(v=h.expectedType);for(let b=1;b<s.length;b+=2){const S=b===1?-1/0:s[b],P=s[b+1],M=b,k=b+1;if(typeof S!="number")return h.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',M);if(m.length&&m[m.length-1][0]>=S)return h.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',M);const O=h.parse(P,k,v);if(!O)return null;v=v||O.type,m.push([S,O])}return new go(v,f,m)}evaluate(s){const h=this.labels,f=this.outputs;if(h.length===1)return f[0].evaluate(s);const m=this.input.evaluate(s);if(m<=h[0])return f[0].evaluate(s);const v=h.length;return m>=h[v-1]?f[v-1].evaluate(s):f[po(h,m)].evaluate(s)}eachChild(s){s(this.input);for(const h of this.outputs)s(h)}outputDefined(){return this.outputs.every((s=>s.outputDefined()))}}function Ep(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var Ka,Bc,ta=(function(){if(Bc)return Ka;function u(s,h,f,m){this.cx=3*s,this.bx=3*(f-s)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*h,this.by=3*(m-h)-this.cy,this.ay=1-this.cy-this.by,this.p1x=s,this.p1y=h,this.p2x=f,this.p2y=m}return Bc=1,Ka=u,u.prototype={sampleCurveX:function(s){return((this.ax*s+this.bx)*s+this.cx)*s},sampleCurveY:function(s){return((this.ay*s+this.by)*s+this.cy)*s},sampleCurveDerivativeX:function(s){return(3*this.ax*s+2*this.bx)*s+this.cx},solveCurveX:function(s,h){if(h===void 0&&(h=1e-6),s<0)return 0;if(s>1)return 1;for(var f=s,m=0;m<8;m++){var v=this.sampleCurveX(f)-s;if(Math.abs(v)<h)return f;var b=this.sampleCurveDerivativeX(f);if(Math.abs(b)<1e-6)break;f-=v/b}var S=0,P=1;for(f=s,m=0;m<20&&(v=this.sampleCurveX(f),!(Math.abs(v-s)<h));m++)s>v?S=f:P=f,f=.5*(P-S)+S;return f},solve:function(s,h){return this.sampleCurveY(this.solveCurveX(s,h))}},Ka})(),vr=Ep(ta);class br{constructor(s,h,f,m,v){this.type=s,this.operator=h,this.interpolation=f,this.input=m,this.labels=[],this.outputs=[];for(const[b,S]of v)this.labels.push(b),this.outputs.push(S)}static interpolationFactor(s,h,f,m){let v=0;if(s.name==="exponential")v=Ja(h,s.base,f,m);else if(s.name==="linear")v=Ja(h,1,f,m);else if(s.name==="cubic-bezier"){const b=s.controlPoints;v=new vr(b[0],b[1],b[2],b[3]).solve(Ja(h,1,f,m))}return v}static parse(s,h){let[f,m,v,...b]=s;if(!Array.isArray(m)||m.length===0)return h.error("Expected an interpolation type expression.",1);if(m[0]==="linear")m={name:"linear"};else if(m[0]==="exponential"){const M=m[1];if(typeof M!="number")return h.error("Exponential interpolation requires a numeric base.",1,1);m={name:"exponential",base:M}}else{if(m[0]!=="cubic-bezier")return h.error(`Unknown interpolation type ${String(m[0])}`,1,0);{const M=m.slice(1);if(M.length!==4||M.some((k=>typeof k!="number"||k<0||k>1)))return h.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);m={name:"cubic-bezier",controlPoints:M}}}if(s.length-1<4)return h.error(`Expected at least 4 arguments, but found only ${s.length-1}.`);if((s.length-1)%2!=0)return h.error("Expected an even number of arguments.");if(v=h.parse(v,2,ot),!v)return null;const S=[];let P=null;f==="interpolate-hcl"||f==="interpolate-lab"?P=Ht:h.expectedType&&h.expectedType.kind!=="value"&&(P=h.expectedType);for(let M=0;M<b.length;M+=2){const k=b[M],O=b[M+1],U=M+3,j=M+4;if(typeof k!="number")return h.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',U);if(S.length&&S[S.length-1][0]>=k)return h.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',U);const $=h.parse(O,j,P);if(!$)return null;P=P||$.type,S.push([k,$])}return lo(P,ot)||lo(P,zt)||lo(P,Ht)||lo(P,qi)||lo(P,Ha)||lo(P,Cr(ot))?new br(P,f,m,v,S):h.error(`Type ${mi(P)} is not interpolatable.`)}evaluate(s){const h=this.labels,f=this.outputs;if(h.length===1)return f[0].evaluate(s);const m=this.input.evaluate(s);if(m<=h[0])return f[0].evaluate(s);const v=h.length;if(m>=h[v-1])return f[v-1].evaluate(s);const b=po(h,m),S=br.interpolationFactor(this.interpolation,m,h[b],h[b+1]),P=f[b].evaluate(s),M=f[b+1].evaluate(s);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return zr(P,M,S);case"color":return ni.interpolate(P,M,S);case"padding":return er.interpolate(P,M,S);case"variableAnchorOffsetCollection":return tr.interpolate(P,M,S);case"array":return qr(P,M,S);case"projectionDefinition":return Ir.interpolate(P,M,S)}case"interpolate-hcl":return ni.interpolate(P,M,S,"hcl");case"interpolate-lab":return ni.interpolate(P,M,S,"lab")}}eachChild(s){s(this.input);for(const h of this.outputs)s(h)}outputDefined(){return this.outputs.every((s=>s.outputDefined()))}}function Ja(u,s,h,f){const m=f-h,v=u-h;return m===0?0:s===1?v/m:(Math.pow(s,v)-1)/(Math.pow(s,m)-1)}const Ur={color:ni.interpolate,number:zr,padding:er.interpolate,variableAnchorOffsetCollection:tr.interpolate,array:qr};class Ni{constructor(s,h){this.type=s,this.args=h}static parse(s,h){if(s.length<2)return h.error("Expected at least one argument.");let f=null;const m=h.expectedType;m&&m.kind!=="value"&&(f=m);const v=[];for(const S of s.slice(1)){const P=h.parse(S,1+v.length,f,void 0,{typeAnnotation:"omit"});if(!P)return null;f=f||P.type,v.push(P)}if(!f)throw new Error("No output type");const b=m&&v.some((S=>Yo(m,S.type)));return new Ni(b?Dt:f,v)}evaluate(s){let h,f=null,m=0;for(const v of this.args)if(m++,f=v.evaluate(s),f&&f instanceof Ar&&!f.available&&(h||(h=f.name),f=null,m===this.args.length&&(f=h)),f!==null)break;return f}eachChild(s){this.args.forEach(s)}outputDefined(){return this.args.every((s=>s.outputDefined()))}}function Nc(u,s){return u==="=="||u==="!="?s.kind==="boolean"||s.kind==="string"||s.kind==="number"||s.kind==="null"||s.kind==="value":s.kind==="string"||s.kind==="number"||s.kind==="value"}function Qa(u,s,h,f){return f.compare(s,h)===0}function ks(u,s,h){const f=u!=="=="&&u!=="!=";return class FT{constructor(v,b,S){this.type=Et,this.lhs=v,this.rhs=b,this.collator=S,this.hasUntypedArgument=v.type.kind==="value"||b.type.kind==="value"}static parse(v,b){if(v.length!==3&&v.length!==4)return b.error("Expected two or three arguments.");const S=v[0];let P=b.parse(v[1],1,Dt);if(!P)return null;if(!Nc(S,P.type))return b.concat(1).error(`"${S}" comparisons are not supported for type '${mi(P.type)}'.`);let M=b.parse(v[2],2,Dt);if(!M)return null;if(!Nc(S,M.type))return b.concat(2).error(`"${S}" comparisons are not supported for type '${mi(M.type)}'.`);if(P.type.kind!==M.type.kind&&P.type.kind!=="value"&&M.type.kind!=="value")return b.error(`Cannot compare types '${mi(P.type)}' and '${mi(M.type)}'.`);f&&(P.type.kind==="value"&&M.type.kind!=="value"?P=new Yr(M.type,[P]):P.type.kind!=="value"&&M.type.kind==="value"&&(M=new Yr(P.type,[M])));let k=null;if(v.length===4){if(P.type.kind!=="string"&&M.type.kind!=="string"&&P.type.kind!=="value"&&M.type.kind!=="value")return b.error("Cannot use collator to compare non-string types.");if(k=b.parse(v[3],3,Ms),!k)return null}return new FT(P,M,k)}evaluate(v){const b=this.lhs.evaluate(v),S=this.rhs.evaluate(v);if(f&&this.hasUntypedArgument){const P=$i(b),M=$i(S);if(P.kind!==M.kind||P.kind!=="string"&&P.kind!=="number")throw new ki(`Expected arguments for "${u}" to be (string, string) or (number, number), but found (${P.kind}, ${M.kind}) instead.`)}if(this.collator&&!f&&this.hasUntypedArgument){const P=$i(b),M=$i(S);if(P.kind!=="string"||M.kind!=="string")return s(v,b,S)}return this.collator?h(v,b,S,this.collator.evaluate(v)):s(v,b,S)}eachChild(v){v(this.lhs),v(this.rhs),this.collator&&v(this.collator)}outputDefined(){return!0}}}const Ap=ks("==",(function(u,s,h){return s===h}),Qa),el=ks("!=",(function(u,s,h){return s!==h}),(function(u,s,h,f){return!Qa(0,s,h,f)})),zc=ks("<",(function(u,s,h){return s<h}),(function(u,s,h,f){return f.compare(s,h)<0})),Pp=ks(">",(function(u,s,h){return s>h}),(function(u,s,h,f){return f.compare(s,h)>0})),tl=ks("<=",(function(u,s,h){return s<=h}),(function(u,s,h,f){return f.compare(s,h)<=0})),il=ks(">=",(function(u,s,h){return s>=h}),(function(u,s,h,f){return f.compare(s,h)>=0}));class Mr{constructor(s,h,f){this.type=Ms,this.locale=f,this.caseSensitive=s,this.diacriticSensitive=h}static parse(s,h){if(s.length!==2)return h.error("Expected one argument.");const f=s[1];if(typeof f!="object"||Array.isArray(f))return h.error("Collator options argument must be an object.");const m=h.parse(f["case-sensitive"]!==void 0&&f["case-sensitive"],1,Et);if(!m)return null;const v=h.parse(f["diacritic-sensitive"]!==void 0&&f["diacritic-sensitive"],1,Et);if(!v)return null;let b=null;return f.locale&&(b=h.parse(f.locale,1,At),!b)?null:new Mr(m,v,b)}evaluate(s){return new qa(this.caseSensitive.evaluate(s),this.diacriticSensitive.evaluate(s),this.locale?this.locale.evaluate(s):null)}eachChild(s){s(this.caseSensitive),s(this.diacriticSensitive),this.locale&&s(this.locale)}outputDefined(){return!1}}class rl{constructor(s,h,f,m,v){this.type=At,this.number=s,this.locale=h,this.currency=f,this.minFractionDigits=m,this.maxFractionDigits=v}static parse(s,h){if(s.length!==3)return h.error("Expected two arguments.");const f=h.parse(s[1],1,ot);if(!f)return null;const m=s[2];if(typeof m!="object"||Array.isArray(m))return h.error("NumberFormat options argument must be an object.");let v=null;if(m.locale&&(v=h.parse(m.locale,1,At),!v))return null;let b=null;if(m.currency&&(b=h.parse(m.currency,1,At),!b))return null;let S=null;if(m["min-fraction-digits"]&&(S=h.parse(m["min-fraction-digits"],1,ot),!S))return null;let P=null;return m["max-fraction-digits"]&&(P=h.parse(m["max-fraction-digits"],1,ot),!P)?null:new rl(f,v,b,S,P)}evaluate(s){return new Intl.NumberFormat(this.locale?this.locale.evaluate(s):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(s):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(s):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(s):void 0}).format(this.number.evaluate(s))}eachChild(s){s(this.number),this.locale&&s(this.locale),this.currency&&s(this.currency),this.minFractionDigits&&s(this.minFractionDigits),this.maxFractionDigits&&s(this.maxFractionDigits)}outputDefined(){return!1}}class Ds{constructor(s){this.type=ji,this.sections=s}static parse(s,h){if(s.length<2)return h.error("Expected at least one argument.");const f=s[1];if(!Array.isArray(f)&&typeof f=="object")return h.error("First argument must be an image or text section.");const m=[];let v=!1;for(let b=1;b<=s.length-1;++b){const S=s[b];if(v&&typeof S=="object"&&!Array.isArray(S)){v=!1;let P=null;if(S["font-scale"]&&(P=h.parse(S["font-scale"],1,ot),!P))return null;let M=null;if(S["text-font"]&&(M=h.parse(S["text-font"],1,Cr(At)),!M))return null;let k=null;if(S["text-color"]&&(k=h.parse(S["text-color"],1,Ht),!k))return null;let O=null;if(S["vertical-align"]){if(typeof S["vertical-align"]=="string"&&!Oc.includes(S["vertical-align"]))return h.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${S["vertical-align"]}' instead.`);if(O=h.parse(S["vertical-align"],1,At),!O)return null}const U=m[m.length-1];U.scale=P,U.font=M,U.textColor=k,U.verticalAlign=O}else{const P=h.parse(s[b],1,Dt);if(!P)return null;const M=P.type.kind;if(M!=="string"&&M!=="value"&&M!=="null"&&M!=="resolvedImage")return h.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");v=!0,m.push({content:P,scale:null,font:null,textColor:null,verticalAlign:null})}}return new Ds(m)}evaluate(s){return new dr(this.sections.map((h=>{const f=h.content.evaluate(s);return $i(f)===bi?new Xr("",f,null,null,null,h.verticalAlign?h.verticalAlign.evaluate(s):null):new Xr(ls(f),null,h.scale?h.scale.evaluate(s):null,h.font?h.font.evaluate(s).join(","):null,h.textColor?h.textColor.evaluate(s):null,h.verticalAlign?h.verticalAlign.evaluate(s):null)})))}eachChild(s){for(const h of this.sections)s(h.content),h.scale&&s(h.scale),h.font&&s(h.font),h.textColor&&s(h.textColor),h.verticalAlign&&s(h.verticalAlign)}outputDefined(){return!1}}class Uc{constructor(s){this.type=bi,this.input=s}static parse(s,h){if(s.length!==2)return h.error("Expected two arguments.");const f=h.parse(s[1],1,At);return f?new Uc(f):h.error("No image name provided.")}evaluate(s){const h=this.input.evaluate(s),f=Ar.fromString(h);return f&&s.availableImages&&(f.available=s.availableImages.indexOf(h)>-1),f}eachChild(s){s(this.input)}outputDefined(){return!1}}class ia{constructor(s){this.type=ot,this.input=s}static parse(s,h){if(s.length!==2)return h.error(`Expected 1 argument, but found ${s.length-1} instead.`);const f=h.parse(s[1],1);return f?f.type.kind!=="array"&&f.type.kind!=="string"&&f.type.kind!=="value"?h.error(`Expected argument of type string or array, but found ${mi(f.type)} instead.`):new ia(f):null}evaluate(s){const h=this.input.evaluate(s);if(typeof h=="string")return[...h].length;if(Array.isArray(h))return h.length;throw new ki(`Expected value to be of type string or array, but found ${mi($i(h))} instead.`)}eachChild(s){s(this.input)}outputDefined(){return!1}}const wn=8192;function Cp(u,s){const h=(180+u[0])/360,f=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+u[1]*Math.PI/360)))/360,m=Math.pow(2,s.z);return[Math.round(h*m*wn),Math.round(f*m*wn)]}function Vc(u,s){const h=Math.pow(2,s.z);return[(m=(u[0]/wn+s.x)/h,360*m-180),(f=(u[1]/wn+s.y)/h,360/Math.PI*Math.atan(Math.exp((180-360*f)*Math.PI/180))-90)];var f,m}function ra(u,s){u[0]=Math.min(u[0],s[0]),u[1]=Math.min(u[1],s[1]),u[2]=Math.max(u[2],s[0]),u[3]=Math.max(u[3],s[1])}function cs(u,s){return!(u[0]<=s[0]||u[2]>=s[2]||u[1]<=s[1]||u[3]>=s[3])}function Ip(u,s,h){const f=u[0]-s[0],m=u[1]-s[1],v=u[0]-h[0],b=u[1]-h[1];return f*b-v*m==0&&f*v<=0&&m*b<=0}function na(u,s,h,f){return(m=[f[0]-h[0],f[1]-h[1]])[0]*(v=[s[0]-u[0],s[1]-u[1]])[1]-m[1]*v[0]!=0&&!(!Wh(u,s,h,f)||!Wh(h,f,u,s));var m,v}function Vh(u,s,h){for(const f of h)for(let m=0;m<f.length-1;++m)if(na(u,s,f[m],f[m+1]))return!0;return!1}function mo(u,s,h=!1){let f=!1;for(const S of s)for(let P=0;P<S.length-1;P++){if(Ip(u,S[P],S[P+1]))return h;(v=S[P])[1]>(m=u)[1]!=(b=S[P+1])[1]>m[1]&&m[0]<(b[0]-v[0])*(m[1]-v[1])/(b[1]-v[1])+v[0]&&(f=!f)}var m,v,b;return f}function jh(u,s){for(const h of s)if(mo(u,h))return!0;return!1}function $h(u,s){for(const h of u)if(!mo(h,s))return!1;for(let h=0;h<u.length-1;++h)if(Vh(u[h],u[h+1],s))return!1;return!0}function Mp(u,s){for(const h of s)if($h(u,h))return!0;return!1}function Wh(u,s,h,f){const m=f[0]-h[0],v=f[1]-h[1],b=(u[0]-h[0])*v-m*(u[1]-h[1]),S=(s[0]-h[0])*v-m*(s[1]-h[1]);return b>0&&S<0||b<0&&S>0}function jc(u,s,h){const f=[];for(let m=0;m<u.length;m++){const v=[];for(let b=0;b<u[m].length;b++){const S=Cp(u[m][b],h);ra(s,S),v.push(S)}f.push(v)}return f}function Hh(u,s,h){const f=[];for(let m=0;m<u.length;m++){const v=jc(u[m],s,h);f.push(v)}return f}function $c(u,s,h,f){if(u[0]<h[0]||u[0]>h[2]){const m=.5*f;let v=u[0]-h[0]>m?-f:h[0]-u[0]>m?f:0;v===0&&(v=u[0]-h[2]>m?-f:h[2]-u[0]>m?f:0),u[0]+=v}ra(s,u)}function Wc(u,s,h,f){const m=Math.pow(2,f.z)*wn,v=[f.x*wn,f.y*wn],b=[];for(const S of u)for(const P of S){const M=[P.x+v[0],P.y+v[1]];$c(M,s,h,m),b.push(M)}return b}function Hc(u,s,h,f){const m=Math.pow(2,f.z)*wn,v=[f.x*wn,f.y*wn],b=[];for(const P of u){const M=[];for(const k of P){const O=[k.x+v[0],k.y+v[1]];ra(s,O),M.push(O)}b.push(M)}if(s[2]-s[0]<=m/2){(S=s)[0]=S[1]=1/0,S[2]=S[3]=-1/0;for(const P of b)for(const M of P)$c(M,s,h,m)}var S;return b}class Os{constructor(s,h){this.type=Et,this.geojson=s,this.geometries=h}static parse(s,h){if(s.length!==2)return h.error(`'within' expression requires exactly one argument, but found ${s.length-1} instead.`);if(ln(s[1])){const f=s[1];if(f.type==="FeatureCollection"){const m=[];for(const v of f.features){const{type:b,coordinates:S}=v.geometry;b==="Polygon"&&m.push(S),b==="MultiPolygon"&&m.push(...S)}if(m.length)return new Os(f,{type:"MultiPolygon",coordinates:m})}else if(f.type==="Feature"){const m=f.geometry.type;if(m==="Polygon"||m==="MultiPolygon")return new Os(f,f.geometry)}else if(f.type==="Polygon"||f.type==="MultiPolygon")return new Os(f,f)}return h.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(s){if(s.geometry()!=null&&s.canonicalID()!=null){if(s.geometryType()==="Point")return(function(h,f){const m=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],b=h.canonicalID();if(f.type==="Polygon"){const S=jc(f.coordinates,v,b),P=Wc(h.geometry(),m,v,b);if(!cs(m,v))return!1;for(const M of P)if(!mo(M,S))return!1}if(f.type==="MultiPolygon"){const S=Hh(f.coordinates,v,b),P=Wc(h.geometry(),m,v,b);if(!cs(m,v))return!1;for(const M of P)if(!jh(M,S))return!1}return!0})(s,this.geometries);if(s.geometryType()==="LineString")return(function(h,f){const m=[1/0,1/0,-1/0,-1/0],v=[1/0,1/0,-1/0,-1/0],b=h.canonicalID();if(f.type==="Polygon"){const S=jc(f.coordinates,v,b),P=Hc(h.geometry(),m,v,b);if(!cs(m,v))return!1;for(const M of P)if(!$h(M,S))return!1}if(f.type==="MultiPolygon"){const S=Hh(f.coordinates,v,b),P=Hc(h.geometry(),m,v,b);if(!cs(m,v))return!1;for(const M of P)if(!Mp(M,S))return!1}return!0})(s,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let Zh=class{constructor(u=[],s=((h,f)=>h<f?-1:h>f?1:0)){if(this.data=u,this.length=this.data.length,this.compare=s,this.length>0)for(let h=(this.length>>1)-1;h>=0;h--)this._down(h)}push(u){this.data.push(u),this._up(this.length++)}pop(){if(this.length===0)return;const u=this.data[0],s=this.data.pop();return--this.length>0&&(this.data[0]=s,this._down(0)),u}peek(){return this.data[0]}_up(u){const{data:s,compare:h}=this,f=s[u];for(;u>0;){const m=u-1>>1,v=s[m];if(h(f,v)>=0)break;s[u]=v,u=m}s[u]=f}_down(u){const{data:s,compare:h}=this,f=this.length>>1,m=s[u];for(;u<f;){let v=1+(u<<1);const b=v+1;if(b<this.length&&h(s[b],s[v])<0&&(v=b),h(s[v],m)>=0)break;s[u]=s[v],u=v}s[u]=m}};function qh(u,s,h=0,f=u.length-1,m=Rp){for(;f>h;){if(f-h>600){const P=f-h+1,M=s-h+1,k=Math.log(P),O=.5*Math.exp(2*k/3),U=.5*Math.sqrt(k*O*(P-O)/P)*(M-P/2<0?-1:1);qh(u,s,Math.max(h,Math.floor(s-M*O/P+U)),Math.min(f,Math.floor(s+(P-M)*O/P+U)),m)}const v=u[s];let b=h,S=f;for(Ls(u,h,s),m(u[f],v)>0&&Ls(u,h,f);b<S;){for(Ls(u,b,S),b++,S--;m(u[b],v)<0;)b++;for(;m(u[S],v)>0;)S--}m(u[h],v)===0?Ls(u,h,S):(S++,Ls(u,S,f)),S<=s&&(h=S+1),s<=S&&(f=S-1)}}function Ls(u,s,h){const f=u[s];u[s]=u[h],u[h]=f}function Rp(u,s){return u<s?-1:u>s?1:0}function nl(u,s){if(u.length<=1)return[u];const h=[];let f,m;for(const v of u){const b=Xh(v);b!==0&&(v.area=Math.abs(b),m===void 0&&(m=b<0),m===b<0?(f&&h.push(f),f=[v]):f.push(v))}if(f&&h.push(f),s>1)for(let v=0;v<h.length;v++)h[v].length<=s||(qh(h[v],s,1,h[v].length-1,kp),h[v]=h[v].slice(0,s));return h}function kp(u,s){return s.area-u.area}function Xh(u){let s=0;for(let h,f,m=0,v=u.length,b=v-1;m<v;b=m++)h=u[m],f=u[b],s+=(f.x-h.x)*(h.y+f.y);return s}const Zc=1/298.257223563,Gh=Zc*(2-Zc),Yh=Math.PI/180;class sl{constructor(s){const h=6378.137*Yh*1e3,f=Math.cos(s*Yh),m=1/(1-Gh*(1-f*f)),v=Math.sqrt(m);this.kx=h*v*f,this.ky=h*v*m*(1-Gh)}distance(s,h){const f=this.wrap(s[0]-h[0])*this.kx,m=(s[1]-h[1])*this.ky;return Math.sqrt(f*f+m*m)}pointOnLine(s,h){let f,m,v,b,S=1/0;for(let P=0;P<s.length-1;P++){let M=s[P][0],k=s[P][1],O=this.wrap(s[P+1][0]-M)*this.kx,U=(s[P+1][1]-k)*this.ky,j=0;O===0&&U===0||(j=(this.wrap(h[0]-M)*this.kx*O+(h[1]-k)*this.ky*U)/(O*O+U*U),j>1?(M=s[P+1][0],k=s[P+1][1]):j>0&&(M+=O/this.kx*j,k+=U/this.ky*j)),O=this.wrap(h[0]-M)*this.kx,U=(h[1]-k)*this.ky;const $=O*O+U*U;$<S&&(S=$,f=M,m=k,v=P,b=j)}return{point:[f,m],index:v,t:Math.max(0,Math.min(1,b))}}wrap(s){for(;s<-180;)s+=360;for(;s>180;)s-=360;return s}}function qc(u,s){return s[0]-u[0]}function ol(u){return u[1]-u[0]+1}function Vn(u,s){return u[1]>=u[0]&&u[1]<s}function Xc(u,s){if(u[0]>u[1])return[null,null];const h=ol(u);if(s){if(h===2)return[u,null];const m=Math.floor(h/2);return[[u[0],u[0]+m],[u[0]+m,u[1]]]}if(h===1)return[u,null];const f=Math.floor(h/2)-1;return[[u[0],u[0]+f],[u[0]+f+1,u[1]]]}function al(u,s){if(!Vn(s,u.length))return[1/0,1/0,-1/0,-1/0];const h=[1/0,1/0,-1/0,-1/0];for(let f=s[0];f<=s[1];++f)ra(h,u[f]);return h}function Gc(u){const s=[1/0,1/0,-1/0,-1/0];for(const h of u)for(const f of h)ra(s,f);return s}function Kh(u){return u[0]!==-1/0&&u[1]!==-1/0&&u[2]!==1/0&&u[3]!==1/0}function Yc(u,s,h){if(!Kh(u)||!Kh(s))return NaN;let f=0,m=0;return u[2]<s[0]&&(f=s[0]-u[2]),u[0]>s[2]&&(f=u[0]-s[2]),u[1]>s[3]&&(m=u[1]-s[3]),u[3]<s[1]&&(m=s[1]-u[3]),h.distance([0,0],[f,m])}function Fs(u,s,h){const f=h.pointOnLine(s,u);return h.distance(u,f.point)}function ai(u,s,h,f,m){const v=Math.min(Fs(u,[h,f],m),Fs(s,[h,f],m)),b=Math.min(Fs(h,[u,s],m),Fs(f,[u,s],m));return Math.min(v,b)}function Dp(u,s,h,f,m){if(!Vn(s,u.length)||!Vn(f,h.length))return 1/0;let v=1/0;for(let b=s[0];b<s[1];++b){const S=u[b],P=u[b+1];for(let M=f[0];M<f[1];++M){const k=h[M],O=h[M+1];if(na(S,P,k,O))return 0;v=Math.min(v,ai(S,P,k,O,m))}}return v}function Op(u,s,h,f,m){if(!Vn(s,u.length)||!Vn(f,h.length))return NaN;let v=1/0;for(let b=s[0];b<=s[1];++b)for(let S=f[0];S<=f[1];++S)if(v=Math.min(v,m.distance(u[b],h[S])),v===0)return v;return v}function Lp(u,s,h){if(mo(u,s,!0))return 0;let f=1/0;for(const m of s){const v=m[0],b=m[m.length-1];if(v!==b&&(f=Math.min(f,Fs(u,[b,v],h)),f===0))return f;const S=h.pointOnLine(m,u);if(f=Math.min(f,h.distance(u,S.point)),f===0)return f}return f}function Fp(u,s,h,f){if(!Vn(s,u.length))return NaN;for(let v=s[0];v<=s[1];++v)if(mo(u[v],h,!0))return 0;let m=1/0;for(let v=s[0];v<s[1];++v){const b=u[v],S=u[v+1];for(const P of h)for(let M=0,k=P.length,O=k-1;M<k;O=M++){const U=P[O],j=P[M];if(na(b,S,U,j))return 0;m=Math.min(m,ai(b,S,U,j,f))}}return m}function Jh(u,s){for(const h of u)for(const f of h)if(mo(f,s,!0))return!0;return!1}function Bp(u,s,h,f=1/0){const m=Gc(u),v=Gc(s);if(f!==1/0&&Yc(m,v,h)>=f)return f;if(cs(m,v)){if(Jh(u,s))return 0}else if(Jh(s,u))return 0;let b=1/0;for(const S of u)for(let P=0,M=S.length,k=M-1;P<M;k=P++){const O=S[k],U=S[P];for(const j of s)for(let $=0,Z=j.length,te=Z-1;$<Z;te=$++){const ce=j[te],Me=j[$];if(na(O,U,ce,Me))return 0;b=Math.min(b,ai(O,U,ce,Me,h))}}return b}function Qh(u,s,h,f,m,v){if(!v)return;const b=Yc(al(f,v),m,h);b<s&&u.push([b,v,[0,0]])}function ll(u,s,h,f,m,v,b){if(!v||!b)return;const S=Yc(al(f,v),al(m,b),h);S<s&&u.push([S,v,b])}function cl(u,s,h,f,m=1/0){let v=Math.min(f.distance(u[0],h[0][0]),m);if(v===0)return v;const b=new Zh([[0,[0,u.length-1],[0,0]]],qc),S=Gc(h);for(;b.length>0;){const P=b.pop();if(P[0]>=v)continue;const M=P[1],k=s?50:100;if(ol(M)<=k){if(!Vn(M,u.length))return NaN;if(s){const O=Fp(u,M,h,f);if(isNaN(O)||O===0)return O;v=Math.min(v,O)}else for(let O=M[0];O<=M[1];++O){const U=Lp(u[O],h,f);if(v=Math.min(v,U),v===0)return 0}}else{const O=Xc(M,s);Qh(b,v,f,u,S,O[0]),Qh(b,v,f,u,S,O[1])}}return v}function ul(u,s,h,f,m,v=1/0){let b=Math.min(v,m.distance(u[0],h[0]));if(b===0)return b;const S=new Zh([[0,[0,u.length-1],[0,h.length-1]]],qc);for(;S.length>0;){const P=S.pop();if(P[0]>=b)continue;const M=P[1],k=P[2],O=s?50:100,U=f?50:100;if(ol(M)<=O&&ol(k)<=U){if(!Vn(M,u.length)&&Vn(k,h.length))return NaN;let j;if(s&&f)j=Dp(u,M,h,k,m),b=Math.min(b,j);else if(s&&!f){const $=u.slice(M[0],M[1]+1);for(let Z=k[0];Z<=k[1];++Z)if(j=Fs(h[Z],$,m),b=Math.min(b,j),b===0)return b}else if(!s&&f){const $=h.slice(k[0],k[1]+1);for(let Z=M[0];Z<=M[1];++Z)if(j=Fs(u[Z],$,m),b=Math.min(b,j),b===0)return b}else j=Op(u,M,h,k,m),b=Math.min(b,j)}else{const j=Xc(M,s),$=Xc(k,f);ll(S,b,m,u,h,j[0],$[0]),ll(S,b,m,u,h,j[0],$[1]),ll(S,b,m,u,h,j[1],$[0]),ll(S,b,m,u,h,j[1],$[1])}}return b}function Kc(u){return u.type==="MultiPolygon"?u.coordinates.map((s=>({type:"Polygon",coordinates:s}))):u.type==="MultiLineString"?u.coordinates.map((s=>({type:"LineString",coordinates:s}))):u.type==="MultiPoint"?u.coordinates.map((s=>({type:"Point",coordinates:s}))):[u]}class Bs{constructor(s,h){this.type=ot,this.geojson=s,this.geometries=h}static parse(s,h){if(s.length!==2)return h.error(`'distance' expression requires exactly one argument, but found ${s.length-1} instead.`);if(ln(s[1])){const f=s[1];if(f.type==="FeatureCollection")return new Bs(f,f.features.map((m=>Kc(m.geometry))).flat());if(f.type==="Feature")return new Bs(f,Kc(f.geometry));if("type"in f&&"coordinates"in f)return new Bs(f,Kc(f))}return h.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(s){if(s.geometry()!=null&&s.canonicalID()!=null){if(s.geometryType()==="Point")return(function(h,f){const m=h.geometry(),v=m.flat().map((P=>Vc([P.x,P.y],h.canonical)));if(m.length===0)return NaN;const b=new sl(v[0][1]);let S=1/0;for(const P of f){switch(P.type){case"Point":S=Math.min(S,ul(v,!1,[P.coordinates],!1,b,S));break;case"LineString":S=Math.min(S,ul(v,!1,P.coordinates,!0,b,S));break;case"Polygon":S=Math.min(S,cl(v,!1,P.coordinates,b,S))}if(S===0)return S}return S})(s,this.geometries);if(s.geometryType()==="LineString")return(function(h,f){const m=h.geometry(),v=m.flat().map((P=>Vc([P.x,P.y],h.canonical)));if(m.length===0)return NaN;const b=new sl(v[0][1]);let S=1/0;for(const P of f){switch(P.type){case"Point":S=Math.min(S,ul(v,!0,[P.coordinates],!1,b,S));break;case"LineString":S=Math.min(S,ul(v,!0,P.coordinates,!0,b,S));break;case"Polygon":S=Math.min(S,cl(v,!0,P.coordinates,b,S))}if(S===0)return S}return S})(s,this.geometries);if(s.geometryType()==="Polygon")return(function(h,f){const m=h.geometry();if(m.length===0||m[0].length===0)return NaN;const v=nl(m,0).map((P=>P.map((M=>M.map((k=>Vc([k.x,k.y],h.canonical))))))),b=new sl(v[0][0][0][1]);let S=1/0;for(const P of f)for(const M of v){switch(P.type){case"Point":S=Math.min(S,cl([P.coordinates],!1,M,b,S));break;case"LineString":S=Math.min(S,cl(P.coordinates,!0,M,b,S));break;case"Polygon":S=Math.min(S,Bp(M,P.coordinates,b,S))}if(S===0)return S}return S})(s,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const _o={"==":Ap,"!=":el,">":Pp,"<":zc,">=":il,"<=":tl,array:Yr,at:ti,boolean:Yr,case:Ya,coalesce:Ni,collator:Mr,format:Ds,image:Uc,in:Jo,"index-of":Kr,interpolate:br,"interpolate-hcl":br,"interpolate-lab":br,length:ia,let:$t,literal:Gr,match:Qo,number:Yr,"number-format":rl,object:Yr,slice:ea,step:go,string:Yr,"to-boolean":cn,"to-color":cn,"to-number":cn,"to-string":cn,var:fo,within:Os,distance:Bs};class Jr{constructor(s,h,f,m){this.name=s,this.type=h,this._evaluate=f,this.args=m}evaluate(s){return this._evaluate(s,this.args)}eachChild(s){this.args.forEach(s)}outputDefined(){return!1}static parse(s,h){const f=s[0],m=Jr.definitions[f];if(!m)return h.error(`Unknown expression "${f}". If you wanted a literal array, use ["literal", [...]].`,0);const v=Array.isArray(m)?m[0]:m.type,b=Array.isArray(m)?[[m[1],m[2]]]:m.overloads,S=b.filter((([M])=>!Array.isArray(M)||M.length===s.length-1));let P=null;for(const[M,k]of S){P=new Qt(h.registry,hl,h.path,null,h.scope);const O=[];let U=!1;for(let j=1;j<s.length;j++){const $=s[j],Z=Array.isArray(M)?M[j-1]:M.type,te=P.parse($,1+O.length,Z);if(!te){U=!0;break}O.push(te)}if(!U)if(Array.isArray(M)&&M.length!==O.length)P.error(`Expected ${M.length} arguments, but found ${O.length} instead.`);else{for(let j=0;j<O.length;j++){const $=Array.isArray(M)?M[j]:M.type,Z=O[j];P.concat(j+1).checkSubtype($,Z.type)}if(P.errors.length===0)return new Jr(f,v,k,O)}}if(S.length===1)h.errors.push(...P.errors);else{const M=(S.length?S:b).map((([O])=>{return U=O,Array.isArray(U)?`(${U.map(mi).join(", ")})`:`(${mi(U.type)}...)`;var U})).join(" | "),k=[];for(let O=1;O<s.length;O++){const U=h.parse(s[O],1+k.length);if(!U)return null;k.push(mi(U.type))}h.error(`Expected arguments of type ${M}, but found (${k.join(", ")}) instead.`)}return null}static register(s,h){Jr.definitions=h;for(const f in h)s[f]=Jr}}function ed(u,[s,h,f,m]){s=s.evaluate(u),h=h.evaluate(u),f=f.evaluate(u);const v=m?m.evaluate(u):1,b=Xa(s,h,f,v);if(b)throw new ki(b);return new ni(s/255,h/255,f/255,v,!1)}function td(u,s){return u in s}function Jc(u,s){const h=s[u];return h===void 0?null:h}function Ns(u){return{type:u}}function hl(u){if(u instanceof fo)return hl(u.boundExpression);if(u instanceof Jr&&u.name==="error"||u instanceof Mr||u instanceof Os||u instanceof Bs)return!1;const s=u instanceof cn||u instanceof Yr;let h=!0;return u.eachChild((f=>{h=s?h&&hl(f):h&&f instanceof Gr})),!!h&&dl(u)&&fl(u,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function dl(u){if(u instanceof Jr&&(u.name==="get"&&u.args.length===1||u.name==="feature-state"||u.name==="has"&&u.args.length===1||u.name==="properties"||u.name==="geometry-type"||u.name==="id"||/^filter-/.test(u.name))||u instanceof Os||u instanceof Bs)return!1;let s=!0;return u.eachChild((h=>{s&&!dl(h)&&(s=!1)})),s}function sa(u){if(u instanceof Jr&&u.name==="feature-state")return!1;let s=!0;return u.eachChild((h=>{s&&!sa(h)&&(s=!1)})),s}function fl(u,s){if(u instanceof Jr&&s.indexOf(u.name)>=0)return!1;let h=!0;return u.eachChild((f=>{h&&!fl(f,s)&&(h=!1)})),h}function id(u){return{result:"success",value:u}}function yo(u){return{result:"error",value:u}}function xo(u){return u["property-type"]==="data-driven"||u["property-type"]==="cross-faded-data-driven"}function rd(u){return!!u.expression&&u.expression.parameters.indexOf("zoom")>-1}function Qc(u){return!!u.expression&&u.expression.interpolated}function si(u){return u instanceof Number?"number":u instanceof String?"string":u instanceof Boolean?"boolean":Array.isArray(u)?"array":u===null?"null":typeof u}function pl(u){return typeof u=="object"&&u!==null&&!Array.isArray(u)}function Np(u){return u}function nd(u,s){const h=s.type==="color",f=u.stops&&typeof u.stops[0][0]=="object",m=f||!(f||u.property!==void 0),v=u.type||(Qc(s)?"exponential":"interval");if(h||s.type==="padding"){const k=h?ni.parse:er.parse;(u=vt({},u)).stops&&(u.stops=u.stops.map((O=>[O[0],k(O[1])]))),u.default=k(u.default?u.default:s.default)}if(u.colorSpace&&(b=u.colorSpace)!=="rgb"&&b!=="hcl"&&b!=="lab")throw new Error(`Unknown color space: "${u.colorSpace}"`);var b;let S,P,M;if(v==="exponential")S=sd;else if(v==="interval")S=Up;else if(v==="categorical"){S=zp,P=Object.create(null);for(const k of u.stops)P[k[0]]=k[1];M=typeof u.stops[0][0]}else{if(v!=="identity")throw new Error(`Unknown function type "${v}"`);S=od}if(f){const k={},O=[];for(let $=0;$<u.stops.length;$++){const Z=u.stops[$],te=Z[0].zoom;k[te]===void 0&&(k[te]={zoom:te,type:u.type,property:u.property,default:u.default,stops:[]},O.push(te)),k[te].stops.push([Z[0].value,Z[1]])}const U=[];for(const $ of O)U.push([k[$].zoom,nd(k[$],s)]);const j={name:"linear"};return{kind:"composite",interpolationType:j,interpolationFactor:br.interpolationFactor.bind(void 0,j),zoomStops:U.map(($=>$[0])),evaluate:({zoom:$},Z)=>sd({stops:U,base:u.base},s,$).evaluate($,Z)}}if(m){const k=v==="exponential"?{name:"exponential",base:u.base!==void 0?u.base:1}:null;return{kind:"camera",interpolationType:k,interpolationFactor:br.interpolationFactor.bind(void 0,k),zoomStops:u.stops.map((O=>O[0])),evaluate:({zoom:O})=>S(u,s,O,P,M)}}return{kind:"source",evaluate(k,O){const U=O&&O.properties?O.properties[u.property]:void 0;return U===void 0?zs(u.default,s.default):S(u,s,U,P,M)}}}function zs(u,s,h){return u!==void 0?u:s!==void 0?s:h!==void 0?h:void 0}function zp(u,s,h,f,m){return zs(typeof h===m?f[h]:void 0,u.default,s.default)}function Up(u,s,h){if(si(h)!=="number")return zs(u.default,s.default);const f=u.stops.length;if(f===1||h<=u.stops[0][0])return u.stops[0][1];if(h>=u.stops[f-1][0])return u.stops[f-1][1];const m=po(u.stops.map((v=>v[0])),h);return u.stops[m][1]}function sd(u,s,h){const f=u.base!==void 0?u.base:1;if(si(h)!=="number")return zs(u.default,s.default);const m=u.stops.length;if(m===1||h<=u.stops[0][0])return u.stops[0][1];if(h>=u.stops[m-1][0])return u.stops[m-1][1];const v=po(u.stops.map((k=>k[0])),h),b=(function(k,O,U,j){const $=j-U,Z=k-U;return $===0?0:O===1?Z/$:(Math.pow(O,Z)-1)/(Math.pow(O,$)-1)})(h,f,u.stops[v][0],u.stops[v+1][0]),S=u.stops[v][1],P=u.stops[v+1][1],M=Ur[s.type]||Np;return typeof S.evaluate=="function"?{evaluate(...k){const O=S.evaluate.apply(void 0,k),U=P.evaluate.apply(void 0,k);if(O!==void 0&&U!==void 0)return M(O,U,b,u.colorSpace)}}:M(S,P,b,u.colorSpace)}function od(u,s,h){switch(s.type){case"color":h=ni.parse(h);break;case"formatted":h=dr.fromString(h.toString());break;case"resolvedImage":h=Ar.fromString(h.toString());break;case"padding":h=er.parse(h);break;default:si(h)===s.type||s.type==="enum"&&s.values[h]||(h=void 0)}return zs(h,u.default,s.default)}Jr.register(_o,{error:[{kind:"error"},[At],(u,[s])=>{throw new ki(s.evaluate(u))}],typeof:[At,[Dt],(u,[s])=>mi($i(s.evaluate(u)))],"to-rgba":[Cr(ot,4),[Ht],(u,[s])=>{const[h,f,m,v]=s.evaluate(u).rgb;return[255*h,255*f,255*m,v]}],rgb:[Ht,[ot,ot,ot],ed],rgba:[Ht,[ot,ot,ot,ot],ed],has:{type:Et,overloads:[[[At],(u,[s])=>td(s.evaluate(u),u.properties())],[[At,Zt],(u,[s,h])=>td(s.evaluate(u),h.evaluate(u))]]},get:{type:Dt,overloads:[[[At],(u,[s])=>Jc(s.evaluate(u),u.properties())],[[At,Zt],(u,[s,h])=>Jc(s.evaluate(u),h.evaluate(u))]]},"feature-state":[Dt,[At],(u,[s])=>Jc(s.evaluate(u),u.featureState||{})],properties:[Zt,[],u=>u.properties()],"geometry-type":[At,[],u=>u.geometryType()],id:[Dt,[],u=>u.id()],zoom:[ot,[],u=>u.globals.zoom],"heatmap-density":[ot,[],u=>u.globals.heatmapDensity||0],"line-progress":[ot,[],u=>u.globals.lineProgress||0],accumulated:[Dt,[],u=>u.globals.accumulated===void 0?null:u.globals.accumulated],"+":[ot,Ns(ot),(u,s)=>{let h=0;for(const f of s)h+=f.evaluate(u);return h}],"*":[ot,Ns(ot),(u,s)=>{let h=1;for(const f of s)h*=f.evaluate(u);return h}],"-":{type:ot,overloads:[[[ot,ot],(u,[s,h])=>s.evaluate(u)-h.evaluate(u)],[[ot],(u,[s])=>-s.evaluate(u)]]},"/":[ot,[ot,ot],(u,[s,h])=>s.evaluate(u)/h.evaluate(u)],"%":[ot,[ot,ot],(u,[s,h])=>s.evaluate(u)%h.evaluate(u)],ln2:[ot,[],()=>Math.LN2],pi:[ot,[],()=>Math.PI],e:[ot,[],()=>Math.E],"^":[ot,[ot,ot],(u,[s,h])=>Math.pow(s.evaluate(u),h.evaluate(u))],sqrt:[ot,[ot],(u,[s])=>Math.sqrt(s.evaluate(u))],log10:[ot,[ot],(u,[s])=>Math.log(s.evaluate(u))/Math.LN10],ln:[ot,[ot],(u,[s])=>Math.log(s.evaluate(u))],log2:[ot,[ot],(u,[s])=>Math.log(s.evaluate(u))/Math.LN2],sin:[ot,[ot],(u,[s])=>Math.sin(s.evaluate(u))],cos:[ot,[ot],(u,[s])=>Math.cos(s.evaluate(u))],tan:[ot,[ot],(u,[s])=>Math.tan(s.evaluate(u))],asin:[ot,[ot],(u,[s])=>Math.asin(s.evaluate(u))],acos:[ot,[ot],(u,[s])=>Math.acos(s.evaluate(u))],atan:[ot,[ot],(u,[s])=>Math.atan(s.evaluate(u))],min:[ot,Ns(ot),(u,s)=>Math.min(...s.map((h=>h.evaluate(u))))],max:[ot,Ns(ot),(u,s)=>Math.max(...s.map((h=>h.evaluate(u))))],abs:[ot,[ot],(u,[s])=>Math.abs(s.evaluate(u))],round:[ot,[ot],(u,[s])=>{const h=s.evaluate(u);return h<0?-Math.round(-h):Math.round(h)}],floor:[ot,[ot],(u,[s])=>Math.floor(s.evaluate(u))],ceil:[ot,[ot],(u,[s])=>Math.ceil(s.evaluate(u))],"filter-==":[Et,[At,Dt],(u,[s,h])=>u.properties()[s.value]===h.value],"filter-id-==":[Et,[Dt],(u,[s])=>u.id()===s.value],"filter-type-==":[Et,[At],(u,[s])=>u.geometryType()===s.value],"filter-<":[Et,[At,Dt],(u,[s,h])=>{const f=u.properties()[s.value],m=h.value;return typeof f==typeof m&&f<m}],"filter-id-<":[Et,[Dt],(u,[s])=>{const h=u.id(),f=s.value;return typeof h==typeof f&&h<f}],"filter->":[Et,[At,Dt],(u,[s,h])=>{const f=u.properties()[s.value],m=h.value;return typeof f==typeof m&&f>m}],"filter-id->":[Et,[Dt],(u,[s])=>{const h=u.id(),f=s.value;return typeof h==typeof f&&h>f}],"filter-<=":[Et,[At,Dt],(u,[s,h])=>{const f=u.properties()[s.value],m=h.value;return typeof f==typeof m&&f<=m}],"filter-id-<=":[Et,[Dt],(u,[s])=>{const h=u.id(),f=s.value;return typeof h==typeof f&&h<=f}],"filter->=":[Et,[At,Dt],(u,[s,h])=>{const f=u.properties()[s.value],m=h.value;return typeof f==typeof m&&f>=m}],"filter-id->=":[Et,[Dt],(u,[s])=>{const h=u.id(),f=s.value;return typeof h==typeof f&&h>=f}],"filter-has":[Et,[Dt],(u,[s])=>s.value in u.properties()],"filter-has-id":[Et,[],u=>u.id()!==null&&u.id()!==void 0],"filter-type-in":[Et,[Cr(At)],(u,[s])=>s.value.indexOf(u.geometryType())>=0],"filter-id-in":[Et,[Cr(Dt)],(u,[s])=>s.value.indexOf(u.id())>=0],"filter-in-small":[Et,[At,Cr(Dt)],(u,[s,h])=>h.value.indexOf(u.properties()[s.value])>=0],"filter-in-large":[Et,[At,Cr(Dt)],(u,[s,h])=>(function(f,m,v,b){for(;v<=b;){const S=v+b>>1;if(m[S]===f)return!0;m[S]>f?b=S-1:v=S+1}return!1})(u.properties()[s.value],h.value,0,h.value.length-1)],all:{type:Et,overloads:[[[Et,Et],(u,[s,h])=>s.evaluate(u)&&h.evaluate(u)],[Ns(Et),(u,s)=>{for(const h of s)if(!h.evaluate(u))return!1;return!0}]]},any:{type:Et,overloads:[[[Et,Et],(u,[s,h])=>s.evaluate(u)||h.evaluate(u)],[Ns(Et),(u,s)=>{for(const h of s)if(h.evaluate(u))return!0;return!1}]]},"!":[Et,[Et],(u,[s])=>!s.evaluate(u)],"is-supported-script":[Et,[At],(u,[s])=>{const h=u.globals&&u.globals.isSupportedScript;return!h||h(s.evaluate(u))}],upcase:[At,[At],(u,[s])=>s.evaluate(u).toUpperCase()],downcase:[At,[At],(u,[s])=>s.evaluate(u).toLowerCase()],concat:[At,Ns(Dt),(u,s)=>s.map((h=>ls(h.evaluate(u)))).join("")],"resolved-locale":[At,[Ms],(u,[s])=>s.evaluate(u).resolvedLocale()]});class eu{constructor(s,h){var f;this.expression=s,this._warningHistory={},this._evaluator=new Ga,this._defaultValue=h?(f=h).type==="color"&&pl(f.default)?new ni(0,0,0,0):f.type==="color"?ni.parse(f.default)||null:f.type==="padding"?er.parse(f.default)||null:f.type==="variableAnchorOffsetCollection"?tr.parse(f.default)||null:f.type==="projectionDefinition"?Ir.parse(f.default)||null:f.default===void 0?null:f.default:null,this._enumValues=h&&h.type==="enum"?h.values:null}evaluateWithoutErrorHandling(s,h,f,m,v,b){return this._evaluator.globals=s,this._evaluator.feature=h,this._evaluator.featureState=f,this._evaluator.canonical=m,this._evaluator.availableImages=v||null,this._evaluator.formattedSection=b,this.expression.evaluate(this._evaluator)}evaluate(s,h,f,m,v,b){this._evaluator.globals=s,this._evaluator.feature=h||null,this._evaluator.featureState=f||null,this._evaluator.canonical=m,this._evaluator.availableImages=v||null,this._evaluator.formattedSection=b||null;try{const S=this.expression.evaluate(this._evaluator);if(S==null||typeof S=="number"&&S!=S)return this._defaultValue;if(this._enumValues&&!(S in this._enumValues))throw new ki(`Expected value to be one of ${Object.keys(this._enumValues).map((P=>JSON.stringify(P))).join(", ")}, but found ${JSON.stringify(S)} instead.`);return S}catch(S){return this._warningHistory[S.message]||(this._warningHistory[S.message]=!0,typeof console<"u"&&console.warn(S.message)),this._defaultValue}}}function gl(u){return Array.isArray(u)&&u.length>0&&typeof u[0]=="string"&&u[0]in _o}function Us(u,s){const h=new Qt(_o,hl,[],s?(function(m){const v={color:Ht,string:At,number:ot,enum:At,boolean:Et,formatted:ji,padding:qi,projectionDefinition:zt,resolvedImage:bi,variableAnchorOffsetCollection:Ha};return m.type==="array"?Cr(v[m.value]||Dt,m.length):v[m.type]})(s):void 0),f=h.parse(u,void 0,void 0,void 0,s&&s.type==="string"?{typeAnnotation:"coerce"}:void 0);return f?id(new eu(f,s)):yo(h.errors)}class ml{constructor(s,h){this.kind=s,this._styleExpression=h,this.isStateDependent=s!=="constant"&&!sa(h.expression)}evaluateWithoutErrorHandling(s,h,f,m,v,b){return this._styleExpression.evaluateWithoutErrorHandling(s,h,f,m,v,b)}evaluate(s,h,f,m,v,b){return this._styleExpression.evaluate(s,h,f,m,v,b)}}class tu{constructor(s,h,f,m){this.kind=s,this.zoomStops=f,this._styleExpression=h,this.isStateDependent=s!=="camera"&&!sa(h.expression),this.interpolationType=m}evaluateWithoutErrorHandling(s,h,f,m,v,b){return this._styleExpression.evaluateWithoutErrorHandling(s,h,f,m,v,b)}evaluate(s,h,f,m,v,b){return this._styleExpression.evaluate(s,h,f,m,v,b)}interpolationFactor(s,h,f){return this.interpolationType?br.interpolationFactor(this.interpolationType,s,h,f):0}}function ad(u,s){const h=Us(u,s);if(h.result==="error")return h;const f=h.value.expression,m=dl(f);if(!m&&!xo(s))return yo([new It("","data expressions not supported")]);const v=fl(f,["zoom"]);if(!v&&!rd(s))return yo([new It("","zoom expressions not supported")]);const b=yl(f);return b||v?b instanceof It?yo([b]):b instanceof br&&!Qc(s)?yo([new It("",'"interpolate" expressions cannot be used with this property')]):id(b?new tu(m?"camera":"composite",h.value,b.labels,b instanceof br?b.interpolation:void 0):new ml(m?"constant":"source",h.value)):yo([new It("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class _l{constructor(s,h){this._parameters=s,this._specification=h,vt(this,nd(this._parameters,this._specification))}static deserialize(s){return new _l(s._parameters,s._specification)}static serialize(s){return{_parameters:s._parameters,_specification:s._specification}}}function yl(u){let s=null;if(u instanceof $t)s=yl(u.result);else if(u instanceof Ni){for(const h of u.args)if(s=yl(h),s)break}else(u instanceof go||u instanceof br)&&u.input instanceof Jr&&u.input.name==="zoom"&&(s=u);return s instanceof It||u.eachChild((h=>{const f=yl(h);f instanceof It?s=f:!s&&f?s=new It("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):s&&f&&s!==f&&(s=new It("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),s}function iu(u){if(u===!0||u===!1)return!0;if(!Array.isArray(u)||u.length===0)return!1;switch(u[0]){case"has":return u.length>=2&&u[1]!=="$id"&&u[1]!=="$type";case"in":return u.length>=3&&(typeof u[1]!="string"||Array.isArray(u[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return u.length!==3||Array.isArray(u[1])||Array.isArray(u[2]);case"any":case"all":for(const s of u.slice(1))if(!iu(s)&&typeof s!="boolean")return!1;return!0;default:return!0}}const ld={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function xl(u){if(u==null)return{filter:()=>!0,needGeometry:!1};iu(u)||(u=oa(u));const s=Us(u,ld);if(s.result==="error")throw new Error(s.value.map((h=>`${h.key}: ${h.message}`)).join(", "));return{filter:(h,f,m)=>s.value.evaluate(h,f,{},m),needGeometry:cd(u)}}function Vp(u,s){return u<s?-1:u>s?1:0}function cd(u){if(!Array.isArray(u))return!1;if(u[0]==="within"||u[0]==="distance")return!0;for(let s=1;s<u.length;s++)if(cd(u[s]))return!0;return!1}function oa(u){if(!u)return!0;const s=u[0];return u.length<=1?s!=="any":s==="=="?vl(u[1],u[2],"=="):s==="!="?vo(vl(u[1],u[2],"==")):s==="<"||s===">"||s==="<="||s===">="?vl(u[1],u[2],s):s==="any"?(h=u.slice(1),["any"].concat(h.map(oa))):s==="all"?["all"].concat(u.slice(1).map(oa)):s==="none"?["all"].concat(u.slice(1).map(oa).map(vo)):s==="in"?ru(u[1],u.slice(2)):s==="!in"?vo(ru(u[1],u.slice(2))):s==="has"?nu(u[1]):s!=="!has"||vo(nu(u[1]));var h}function vl(u,s,h){switch(u){case"$type":return[`filter-type-${h}`,s];case"$id":return[`filter-id-${h}`,s];default:return[`filter-${h}`,u,s]}}function ru(u,s){if(s.length===0)return!1;switch(u){case"$type":return["filter-type-in",["literal",s]];case"$id":return["filter-id-in",["literal",s]];default:return s.length>200&&!s.some((h=>typeof h!=typeof s[0]))?["filter-in-large",u,["literal",s.sort(Vp)]]:["filter-in-small",u,["literal",s]]}}function nu(u){switch(u){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",u]}}function vo(u){return["!",u]}function aa(u){const s=typeof u;if(s==="number"||s==="boolean"||s==="string"||u==null)return JSON.stringify(u);if(Array.isArray(u)){let m="[";for(const v of u)m+=`${aa(v)},`;return`${m}]`}const h=Object.keys(u).sort();let f="{";for(let m=0;m<h.length;m++)f+=`${JSON.stringify(h[m])}:${aa(u[h[m]])},`;return`${f}}`}function su(u){let s="";for(const h of Y)s+=`/${aa(u[h])}`;return s}function la(u){const s=u.value;return s?[new Ue(u.key,s,"constants have been deprecated as of v8")]:[]}function Fi(u){return u instanceof Number||u instanceof String||u instanceof Boolean?u.valueOf():u}function Vs(u){if(Array.isArray(u))return u.map(Vs);if(u instanceof Object&&!(u instanceof Number||u instanceof String||u instanceof Boolean)){const s={};for(const h in u)s[h]=Vs(u[h]);return s}return Fi(u)}function Qr(u){const s=u.key,h=u.value,f=u.valueSpec||{},m=u.objectElementValidators||{},v=u.style,b=u.styleSpec,S=u.validateSpec;let P=[];const M=si(h);if(M!=="object")return[new Ue(s,h,`object expected, ${M} found`)];for(const k in h){const O=k.split(".")[0],U=f[O]||f["*"];let j;if(m[O])j=m[O];else if(f[O])j=S;else if(m["*"])j=m["*"];else{if(!f["*"]){P.push(new Ue(s,h[k],`unknown property "${k}"`));continue}j=S}P=P.concat(j({key:(s&&`${s}.`)+k,value:h[k],valueSpec:U,style:v,styleSpec:b,object:h,objectKey:k,validateSpec:S},h))}for(const k in f)m[k]||f[k].required&&f[k].default===void 0&&h[k]===void 0&&P.push(new Ue(s,h,`missing required property "${k}"`));return P}function ou(u){const s=u.value,h=u.valueSpec,f=u.style,m=u.styleSpec,v=u.key,b=u.arrayElementValidator||u.validateSpec;if(si(s)!=="array")return[new Ue(v,s,`array expected, ${si(s)} found`)];if(h.length&&s.length!==h.length)return[new Ue(v,s,`array length ${h.length} expected, length ${s.length} found`)];if(h["min-length"]&&s.length<h["min-length"])return[new Ue(v,s,`array length at least ${h["min-length"]} expected, length ${s.length} found`)];let S={type:h.value,values:h.values};m.$version<7&&(S.function=h.function),si(h.value)==="object"&&(S=h.value);let P=[];for(let M=0;M<s.length;M++)P=P.concat(b({array:s,arrayIndex:M,value:s[M],valueSpec:S,validateSpec:u.validateSpec,style:f,styleSpec:m,key:`${v}[${M}]`}));return P}function au(u){const s=u.key,h=u.value,f=u.valueSpec;let m=si(h);return m==="number"&&h!=h&&(m="NaN"),m!=="number"?[new Ue(s,h,`number expected, ${m} found`)]:"minimum"in f&&h<f.minimum?[new Ue(s,h,`${h} is less than the minimum value ${f.minimum}`)]:"maximum"in f&&h>f.maximum?[new Ue(s,h,`${h} is greater than the maximum value ${f.maximum}`)]:[]}function ud(u){const s=u.valueSpec,h=Fi(u.value.type);let f,m,v,b={};const S=h!=="categorical"&&u.value.property===void 0,P=!S,M=si(u.value.stops)==="array"&&si(u.value.stops[0])==="array"&&si(u.value.stops[0][0])==="object",k=Qr({key:u.key,value:u.value,valueSpec:u.styleSpec.function,validateSpec:u.validateSpec,style:u.style,styleSpec:u.styleSpec,objectElementValidators:{stops:function(j){if(h==="identity")return[new Ue(j.key,j.value,'identity function may not have a "stops" property')];let $=[];const Z=j.value;return $=$.concat(ou({key:j.key,value:Z,valueSpec:j.valueSpec,validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec,arrayElementValidator:O})),si(Z)==="array"&&Z.length===0&&$.push(new Ue(j.key,Z,"array must have at least one stop")),$},default:function(j){return j.validateSpec({key:j.key,value:j.value,valueSpec:s,validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec})}}});return h==="identity"&&S&&k.push(new Ue(u.key,u.value,'missing required property "property"')),h==="identity"||u.value.stops||k.push(new Ue(u.key,u.value,'missing required property "stops"')),h==="exponential"&&u.valueSpec.expression&&!Qc(u.valueSpec)&&k.push(new Ue(u.key,u.value,"exponential functions not supported")),u.styleSpec.$version>=8&&(P&&!xo(u.valueSpec)?k.push(new Ue(u.key,u.value,"property functions not supported")):S&&!rd(u.valueSpec)&&k.push(new Ue(u.key,u.value,"zoom functions not supported"))),h!=="categorical"&&!M||u.value.property!==void 0||k.push(new Ue(u.key,u.value,'"property" property is required')),k;function O(j){let $=[];const Z=j.value,te=j.key;if(si(Z)!=="array")return[new Ue(te,Z,`array expected, ${si(Z)} found`)];if(Z.length!==2)return[new Ue(te,Z,`array length 2 expected, length ${Z.length} found`)];if(M){if(si(Z[0])!=="object")return[new Ue(te,Z,`object expected, ${si(Z[0])} found`)];if(Z[0].zoom===void 0)return[new Ue(te,Z,"object stop key must have zoom")];if(Z[0].value===void 0)return[new Ue(te,Z,"object stop key must have value")];if(v&&v>Fi(Z[0].zoom))return[new Ue(te,Z[0].zoom,"stop zoom values must appear in ascending order")];Fi(Z[0].zoom)!==v&&(v=Fi(Z[0].zoom),m=void 0,b={}),$=$.concat(Qr({key:`${te}[0]`,value:Z[0],valueSpec:{zoom:{}},validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec,objectElementValidators:{zoom:au,value:U}}))}else $=$.concat(U({key:`${te}[0]`,value:Z[0],validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec},Z));return gl(Vs(Z[1]))?$.concat([new Ue(`${te}[1]`,Z[1],"expressions are not allowed in function stops.")]):$.concat(j.validateSpec({key:`${te}[1]`,value:Z[1],valueSpec:s,validateSpec:j.validateSpec,style:j.style,styleSpec:j.styleSpec}))}function U(j,$){const Z=si(j.value),te=Fi(j.value),ce=j.value!==null?j.value:$;if(f){if(Z!==f)return[new Ue(j.key,ce,`${Z} stop domain type must match previous stop domain type ${f}`)]}else f=Z;if(Z!=="number"&&Z!=="string"&&Z!=="boolean")return[new Ue(j.key,ce,"stop domain value must be a number, string, or boolean")];if(Z!=="number"&&h!=="categorical"){let Me=`number expected, ${Z} found`;return xo(s)&&h===void 0&&(Me+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Ue(j.key,ce,Me)]}return h!=="categorical"||Z!=="number"||isFinite(te)&&Math.floor(te)===te?h!=="categorical"&&Z==="number"&&m!==void 0&&te<m?[new Ue(j.key,ce,"stop domain values must appear in ascending order")]:(m=te,h==="categorical"&&te in b?[new Ue(j.key,ce,"stop domain values must be unique")]:(b[te]=!0,[])):[new Ue(j.key,ce,`integer expected, found ${te}`)]}}function js(u){const s=(u.expressionContext==="property"?ad:Us)(Vs(u.value),u.valueSpec);if(s.result==="error")return s.value.map((f=>new Ue(`${u.key}${f.key}`,u.value,f.message)));const h=s.value.expression||s.value._styleExpression.expression;if(u.expressionContext==="property"&&u.propertyKey==="text-font"&&!h.outputDefined())return[new Ue(u.key,u.value,`Invalid data expression for "${u.propertyKey}". Output values must be contained as literals within the expression.`)];if(u.expressionContext==="property"&&u.propertyType==="layout"&&!sa(h))return[new Ue(u.key,u.value,'"feature-state" data expressions are not supported with layout properties.')];if(u.expressionContext==="filter"&&!sa(h))return[new Ue(u.key,u.value,'"feature-state" data expressions are not supported with filters.')];if(u.expressionContext&&u.expressionContext.indexOf("cluster")===0){if(!fl(h,["zoom","feature-state"]))return[new Ue(u.key,u.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(u.expressionContext==="cluster-initial"&&!dl(h))return[new Ue(u.key,u.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function bo(u){const s=u.key,h=u.value,f=u.valueSpec,m=[];return Array.isArray(f.values)?f.values.indexOf(Fi(h))===-1&&m.push(new Ue(s,h,`expected one of [${f.values.join(", ")}], ${JSON.stringify(h)} found`)):Object.keys(f.values).indexOf(Fi(h))===-1&&m.push(new Ue(s,h,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(h)} found`)),m}function wo(u){return iu(Vs(u.value))?js(vt({},u,{expressionContext:"filter",valueSpec:{value:"boolean"}})):hd(u)}function hd(u){const s=u.value,h=u.key;if(si(s)!=="array")return[new Ue(h,s,`array expected, ${si(s)} found`)];const f=u.styleSpec;let m,v=[];if(s.length<1)return[new Ue(h,s,"filter array must have at least 1 element")];switch(v=v.concat(bo({key:`${h}[0]`,value:s[0],valueSpec:f.filter_operator,style:u.style,styleSpec:u.styleSpec})),Fi(s[0])){case"<":case"<=":case">":case">=":s.length>=2&&Fi(s[1])==="$type"&&v.push(new Ue(h,s,`"$type" cannot be use with operator "${s[0]}"`));case"==":case"!=":s.length!==3&&v.push(new Ue(h,s,`filter array for operator "${s[0]}" must have 3 elements`));case"in":case"!in":s.length>=2&&(m=si(s[1]),m!=="string"&&v.push(new Ue(`${h}[1]`,s[1],`string expected, ${m} found`)));for(let b=2;b<s.length;b++)m=si(s[b]),Fi(s[1])==="$type"?v=v.concat(bo({key:`${h}[${b}]`,value:s[b],valueSpec:f.geometry_type,style:u.style,styleSpec:u.styleSpec})):m!=="string"&&m!=="number"&&m!=="boolean"&&v.push(new Ue(`${h}[${b}]`,s[b],`string, number, or boolean expected, ${m} found`));break;case"any":case"all":case"none":for(let b=1;b<s.length;b++)v=v.concat(hd({key:`${h}[${b}]`,value:s[b],style:u.style,styleSpec:u.styleSpec}));break;case"has":case"!has":m=si(s[1]),s.length!==2?v.push(new Ue(h,s,`filter array for "${s[0]}" operator must have 2 elements`)):m!=="string"&&v.push(new Ue(`${h}[1]`,s[1],`string expected, ${m} found`))}return v}function lu(u,s){const h=u.key,f=u.validateSpec,m=u.style,v=u.styleSpec,b=u.value,S=u.objectKey,P=v[`${s}_${u.layerType}`];if(!P)return[];const M=S.match(/^(.*)-transition$/);if(s==="paint"&&M&&P[M[1]]&&P[M[1]].transition)return f({key:h,value:b,valueSpec:v.transition,style:m,styleSpec:v});const k=u.valueSpec||P[S];if(!k)return[new Ue(h,b,`unknown property "${S}"`)];let O;if(si(b)==="string"&&xo(k)&&!k.tokens&&(O=/^{([^}]+)}$/.exec(b)))return[new Ue(h,b,`"${S}" does not support interpolation syntax
Use an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(O[1])} }\`.`)];const U=[];return u.layerType==="symbol"&&(S==="text-field"&&m&&!m.glyphs&&U.push(new Ue(h,b,'use of "text-field" requires a style "glyphs" property')),S==="text-font"&&pl(Vs(b))&&Fi(b.type)==="identity"&&U.push(new Ue(h,b,'"text-font" does not support identity functions'))),U.concat(f({key:u.key,value:b,valueSpec:k,style:m,styleSpec:v,expressionContext:"property",propertyType:s,propertyKey:S}))}function cu(u){return lu(u,"paint")}function dd(u){return lu(u,"layout")}function uu(u){let s=[];const h=u.value,f=u.key,m=u.style,v=u.styleSpec;h.type||h.ref||s.push(new Ue(f,h,'either "type" or "ref" is required'));let b=Fi(h.type);const S=Fi(h.ref);if(h.id){const P=Fi(h.id);for(let M=0;M<u.arrayIndex;M++){const k=m.layers[M];Fi(k.id)===P&&s.push(new Ue(f,h.id,`duplicate layer id "${h.id}", previously used at line ${k.id.__line__}`))}}if("ref"in h){let P;["type","source","source-layer","filter","layout"].forEach((M=>{M in h&&s.push(new Ue(f,h[M],`"${M}" is prohibited for ref layers`))})),m.layers.forEach((M=>{Fi(M.id)===S&&(P=M)})),P?P.ref?s.push(new Ue(f,h.ref,"ref cannot reference another ref layer")):b=Fi(P.type):s.push(new Ue(f,h.ref,`ref layer "${S}" not found`))}else if(b!=="background")if(h.source){const P=m.sources&&m.sources[h.source],M=P&&Fi(P.type);P?M==="vector"&&b==="raster"?s.push(new Ue(f,h.source,`layer "${h.id}" requires a raster source`)):M!=="raster-dem"&&b==="hillshade"?s.push(new Ue(f,h.source,`layer "${h.id}" requires a raster-dem source`)):M==="raster"&&b!=="raster"?s.push(new Ue(f,h.source,`layer "${h.id}" requires a vector source`)):M!=="vector"||h["source-layer"]?M==="raster-dem"&&b!=="hillshade"?s.push(new Ue(f,h.source,"raster-dem source can only be used with layer type 'hillshade'.")):b!=="line"||!h.paint||!h.paint["line-gradient"]||M==="geojson"&&P.lineMetrics||s.push(new Ue(f,h,`layer "${h.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):s.push(new Ue(f,h,`layer "${h.id}" must specify a "source-layer"`)):s.push(new Ue(f,h.source,`source "${h.source}" not found`))}else s.push(new Ue(f,h,'missing required property "source"'));return s=s.concat(Qr({key:f,value:h,valueSpec:v.layer,style:u.style,styleSpec:u.styleSpec,validateSpec:u.validateSpec,objectElementValidators:{"*":()=>[],type:()=>u.validateSpec({key:`${f}.type`,value:h.type,valueSpec:v.layer.type,style:u.style,styleSpec:u.styleSpec,validateSpec:u.validateSpec,object:h,objectKey:"type"}),filter:wo,layout:P=>Qr({layer:h,key:P.key,value:P.value,style:P.style,styleSpec:P.styleSpec,validateSpec:P.validateSpec,objectElementValidators:{"*":M=>dd(vt({layerType:b},M))}}),paint:P=>Qr({layer:h,key:P.key,value:P.value,style:P.style,styleSpec:P.styleSpec,validateSpec:P.validateSpec,objectElementValidators:{"*":M=>cu(vt({layerType:b},M))}})}})),s}function us(u){const s=u.value,h=u.key,f=si(s);return f!=="string"?[new Ue(h,s,`string expected, ${f} found`)]:[]}const To={promoteId:function({key:u,value:s}){if(si(s)==="string")return us({key:u,value:s});{const h=[];for(const f in s)h.push(...us({key:`${u}.${f}`,value:s[f]}));return h}}};function fd(u){const s=u.value,h=u.key,f=u.styleSpec,m=u.style,v=u.validateSpec;if(!s.type)return[new Ue(h,s,'"type" is required')];const b=Fi(s.type);let S;switch(b){case"vector":case"raster":return S=Qr({key:h,value:s,valueSpec:f[`source_${b.replace("-","_")}`],style:u.style,styleSpec:f,objectElementValidators:To,validateSpec:v}),S;case"raster-dem":return S=(function(P){var M;const k=(M=P.sourceName)!==null&&M!==void 0?M:"",O=P.value,U=P.styleSpec,j=U.source_raster_dem,$=P.style;let Z=[];const te=si(O);if(O===void 0)return Z;if(te!=="object")return Z.push(new Ue("source_raster_dem",O,`object expected, ${te} found`)),Z;const ce=Fi(O.encoding)==="custom",Me=["redFactor","greenFactor","blueFactor","baseShift"],pe=P.value.encoding?`"${P.value.encoding}"`:"Default";for(const V in O)!ce&&Me.includes(V)?Z.push(new Ue(V,O[V],`In "${k}": "${V}" is only valid when "encoding" is set to "custom". ${pe} encoding found`)):j[V]?Z=Z.concat(P.validateSpec({key:V,value:O[V],valueSpec:j[V],validateSpec:P.validateSpec,style:$,styleSpec:U})):Z.push(new Ue(V,O[V],`unknown property "${V}"`));return Z})({sourceName:h,value:s,style:u.style,styleSpec:f,validateSpec:v}),S;case"geojson":if(S=Qr({key:h,value:s,valueSpec:f.source_geojson,style:m,styleSpec:f,validateSpec:v,objectElementValidators:To}),s.cluster)for(const P in s.clusterProperties){const[M,k]=s.clusterProperties[P],O=typeof M=="string"?[M,["accumulated"],["get",P]]:M;S.push(...js({key:`${h}.${P}.map`,value:k,expressionContext:"cluster-map"})),S.push(...js({key:`${h}.${P}.reduce`,value:O,expressionContext:"cluster-reduce"}))}return S;case"video":return Qr({key:h,value:s,valueSpec:f.source_video,style:m,validateSpec:v,styleSpec:f});case"image":return Qr({key:h,value:s,valueSpec:f.source_image,style:m,validateSpec:v,styleSpec:f});case"canvas":return[new Ue(h,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return bo({key:`${h}.type`,value:s.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function pd(u){const s=u.value,h=u.styleSpec,f=h.light,m=u.style;let v=[];const b=si(s);if(s===void 0)return v;if(b!=="object")return v=v.concat([new Ue("light",s,`object expected, ${b} found`)]),v;for(const S in s){const P=S.match(/^(.*)-transition$/);v=v.concat(P&&f[P[1]]&&f[P[1]].transition?u.validateSpec({key:S,value:s[S],valueSpec:h.transition,validateSpec:u.validateSpec,style:m,styleSpec:h}):f[S]?u.validateSpec({key:S,value:s[S],valueSpec:f[S],validateSpec:u.validateSpec,style:m,styleSpec:h}):[new Ue(S,s[S],`unknown property "${S}"`)])}return v}function gd(u){const s=u.value,h=u.styleSpec,f=h.sky,m=u.style,v=si(s);if(s===void 0)return[];if(v!=="object")return[new Ue("sky",s,`object expected, ${v} found`)];let b=[];for(const S in s)b=b.concat(f[S]?u.validateSpec({key:S,value:s[S],valueSpec:f[S],style:m,styleSpec:h}):[new Ue(S,s[S],`unknown property "${S}"`)]);return b}function md(u){const s=u.value,h=u.styleSpec,f=h.terrain,m=u.style;let v=[];const b=si(s);if(s===void 0)return v;if(b!=="object")return v=v.concat([new Ue("terrain",s,`object expected, ${b} found`)]),v;for(const S in s)v=v.concat(f[S]?u.validateSpec({key:S,value:s[S],valueSpec:f[S],validateSpec:u.validateSpec,style:m,styleSpec:h}):[new Ue(S,s[S],`unknown property "${S}"`)]);return v}function _d(u){let s=[];const h=u.value,f=u.key;if(Array.isArray(h)){const m=[],v=[];for(const b in h)h[b].id&&m.includes(h[b].id)&&s.push(new Ue(f,h,`all the sprites' ids must be unique, but ${h[b].id} is duplicated`)),m.push(h[b].id),h[b].url&&v.includes(h[b].url)&&s.push(new Ue(f,h,`all the sprites' URLs must be unique, but ${h[b].url} is duplicated`)),v.push(h[b].url),s=s.concat(Qr({key:`${f}[${b}]`,value:h[b],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:u.validateSpec}));return s}return us({key:f,value:h})}const yd={"*":()=>[],array:ou,boolean:function(u){const s=u.value,h=u.key,f=si(s);return f!=="boolean"?[new Ue(h,s,`boolean expected, ${f} found`)]:[]},number:au,color:function(u){const s=u.key,h=u.value,f=si(h);return f!=="string"?[new Ue(s,h,`color expected, ${f} found`)]:ni.parse(String(h))?[]:[new Ue(s,h,`color expected, "${h}" found`)]},constants:la,enum:bo,filter:wo,function:ud,layer:uu,object:Qr,source:fd,light:pd,sky:gd,terrain:md,projection:function(u){const s=u.value,h=u.styleSpec,f=h.projection,m=u.style,v=si(s);if(s===void 0)return[];if(v!=="object")return[new Ue("projection",s,`object expected, ${v} found`)];let b=[];for(const S in s)b=b.concat(f[S]?u.validateSpec({key:S,value:s[S],valueSpec:f[S],style:m,styleSpec:h}):[new Ue(S,s[S],`unknown property "${S}"`)]);return b},projectionDefinition:function(u){const s=u.key;let h=u.value;h=h instanceof String?h.valueOf():h;const f=si(h);return f!=="array"||(function(m){return Array.isArray(m)&&m.length===3&&typeof m[0]=="string"&&typeof m[1]=="string"&&typeof m[2]=="number"})(h)||(function(m){return!!["interpolate","step","literal"].includes(m[0])})(h)?["array","string"].includes(f)?[]:[new Ue(s,h,`projection expected, invalid type "${f}" found`)]:[new Ue(s,h,`projection expected, invalid array ${JSON.stringify(h)} found`)]},string:us,formatted:function(u){return us(u).length===0?[]:js(u)},resolvedImage:function(u){return us(u).length===0?[]:js(u)},padding:function(u){const s=u.key,h=u.value;if(si(h)==="array"){if(h.length<1||h.length>4)return[new Ue(s,h,`padding requires 1 to 4 values; ${h.length} values found`)];const f={type:"number"};let m=[];for(let v=0;v<h.length;v++)m=m.concat(u.validateSpec({key:`${s}[${v}]`,value:h[v],validateSpec:u.validateSpec,valueSpec:f}));return m}return au({key:s,value:h,valueSpec:{}})},variableAnchorOffsetCollection:function(u){const s=u.key,h=u.value,f=si(h),m=u.styleSpec;if(f!=="array"||h.length<1||h.length%2!=0)return[new Ue(s,h,"variableAnchorOffsetCollection requires a non-empty array of even length")];let v=[];for(let b=0;b<h.length;b+=2)v=v.concat(bo({key:`${s}[${b}]`,value:h[b],valueSpec:m.layout_symbol["text-anchor"]})),v=v.concat(ou({key:`${s}[${b+1}]`,value:h[b+1],valueSpec:{length:2,value:"number"},validateSpec:u.validateSpec,style:u.style,styleSpec:m}));return v},sprite:_d};function hs(u){const s=u.value,h=u.valueSpec,f=u.styleSpec;return u.validateSpec=hs,h.expression&&pl(Fi(s))?ud(u):h.expression&&gl(Vs(s))?js(u):h.type&&yd[h.type]?yd[h.type](u):Qr(vt({},u,{valueSpec:h.type?f[h.type]:h}))}function So(u){const s=u.value,h=u.key,f=us(u);return f.length||(s.indexOf("{fontstack}")===-1&&f.push(new Ue(h,s,'"glyphs" url must include a "{fontstack}" token')),s.indexOf("{range}")===-1&&f.push(new Ue(h,s,'"glyphs" url must include a "{range}" token'))),f}function Di(u,s=B){let h=[];return h=h.concat(hs({key:"",value:u,valueSpec:s.$root,styleSpec:s,style:u,validateSpec:hs,objectElementValidators:{glyphs:So,"*":()=>[]}})),u.constants&&(h=h.concat(la({key:"constants",value:u.constants}))),hu(h)}function Rr(u){return function(s){return u({...s,validateSpec:hs})}}function hu(u){return[].concat(u).sort(((s,h)=>s.line-h.line))}function Tn(u){return function(...s){return hu(u.apply(this,s))}}Di.source=Tn(Rr(fd)),Di.sprite=Tn(Rr(_d)),Di.glyphs=Tn(Rr(So)),Di.light=Tn(Rr(pd)),Di.sky=Tn(Rr(gd)),Di.terrain=Tn(Rr(md)),Di.layer=Tn(Rr(uu)),Di.filter=Tn(Rr(wo)),Di.paintProperty=Tn(Rr(cu)),Di.layoutProperty=Tn(Rr(dd));const Eo=Di,ca=Eo.light,xd=Eo.sky,du=Eo.paintProperty,jp=Eo.layoutProperty;function bl(u,s){let h=!1;if(s&&s.length)for(const f of s)u.fire(new Un(new Error(f.message))),h=!0;return h}class ua{constructor(s,h,f){const m=this.cells=[];if(s instanceof ArrayBuffer){this.arrayBuffer=s;const b=new Int32Array(this.arrayBuffer);s=b[0],this.d=(h=b[1])+2*(f=b[2]);for(let P=0;P<this.d*this.d;P++){const M=b[3+P],k=b[3+P+1];m.push(M===k?null:b.subarray(M,k))}const S=b[3+m.length+1];this.keys=b.subarray(b[3+m.length],S),this.bboxes=b.subarray(S),this.insert=this._insertReadonly}else{this.d=h+2*f;for(let b=0;b<this.d*this.d;b++)m.push([]);this.keys=[],this.bboxes=[]}this.n=h,this.extent=s,this.padding=f,this.scale=h/s,this.uid=0;const v=f/h*s;this.min=-v,this.max=s+v}insert(s,h,f,m,v){this._forEachCell(h,f,m,v,this._insertCell,this.uid++,void 0,void 0),this.keys.push(s),this.bboxes.push(h),this.bboxes.push(f),this.bboxes.push(m),this.bboxes.push(v)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(s,h,f,m,v,b){this.cells[v].push(b)}query(s,h,f,m,v){const b=this.min,S=this.max;if(s<=b&&h<=b&&S<=f&&S<=m&&!v)return Array.prototype.slice.call(this.keys);{const P=[];return this._forEachCell(s,h,f,m,this._queryCell,P,{},v),P}}_queryCell(s,h,f,m,v,b,S,P){const M=this.cells[v];if(M!==null){const k=this.keys,O=this.bboxes;for(let U=0;U<M.length;U++){const j=M[U];if(S[j]===void 0){const $=4*j;(P?P(O[$+0],O[$+1],O[$+2],O[$+3]):s<=O[$+2]&&h<=O[$+3]&&f>=O[$+0]&&m>=O[$+1])?(S[j]=!0,b.push(k[j])):S[j]=!1}}}}_forEachCell(s,h,f,m,v,b,S,P){const M=this._convertToCellCoord(s),k=this._convertToCellCoord(h),O=this._convertToCellCoord(f),U=this._convertToCellCoord(m);for(let j=M;j<=O;j++)for(let $=k;$<=U;$++){const Z=this.d*$+j;if((!P||P(this._convertFromCellCoord(j),this._convertFromCellCoord($),this._convertFromCellCoord(j+1),this._convertFromCellCoord($+1)))&&v.call(this,s,h,f,m,Z,b,S,P))return}}_convertFromCellCoord(s){return(s-this.padding)/this.scale}_convertToCellCoord(s){return Math.max(0,Math.min(this.d-1,Math.floor(s*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const s=this.cells,h=3+this.cells.length+1+1;let f=0;for(let b=0;b<this.cells.length;b++)f+=this.cells[b].length;const m=new Int32Array(h+f+this.keys.length+this.bboxes.length);m[0]=this.extent,m[1]=this.n,m[2]=this.padding;let v=h;for(let b=0;b<s.length;b++){const S=s[b];m[3+b]=v,m.set(S,v),v+=S.length}return m[3+s.length]=v,m.set(this.keys,v),v+=this.keys.length,m[3+s.length+1]=v,m.set(this.bboxes,v),v+=this.bboxes.length,m.buffer}static serialize(s,h){const f=s.toArrayBuffer();return h&&h.push(f),{buffer:f}}static deserialize(s){return new ua(s.buffer)}}const Vr={};function wt(u,s,h={}){if(Vr[u])throw new Error(`${u} is already registered.`);Object.defineProperty(s,"_classRegistryKey",{value:u,writeable:!1}),Vr[u]={klass:s,omit:h.omit||[],shallow:h.shallow||[]}}wt("Object",Object),wt("TransferableGridIndex",ua),wt("Color",ni),wt("Error",Error),wt("AJAXError",Nn),wt("ResolvedImage",Ar),wt("StylePropertyFunction",_l),wt("StyleExpression",eu,{omit:["_evaluator"]}),wt("ZoomDependentExpression",tu),wt("ZoomConstantExpression",ml),wt("CompoundExpression",Jr,{omit:["_evaluate"]});for(const u in _o)_o[u]._classRegistryKey||wt(`Expression_${u}`,_o[u]);function Ao(u){return u&&typeof ArrayBuffer<"u"&&(u instanceof ArrayBuffer||u.constructor&&u.constructor.name==="ArrayBuffer")}function fu(u){return u.$name||u.constructor._classRegistryKey}function vd(u){return!(function(s){if(s===null||typeof s!="object")return!1;const h=fu(s);return!(!h||h==="Object")})(u)&&(u==null||typeof u=="boolean"||typeof u=="number"||typeof u=="string"||u instanceof Boolean||u instanceof Number||u instanceof String||u instanceof Date||u instanceof RegExp||u instanceof Blob||u instanceof Error||Ao(u)||kt(u)||ArrayBuffer.isView(u)||u instanceof ImageData)}function ds(u,s){if(vd(u))return(Ao(u)||kt(u))&&s&&s.push(u),ArrayBuffer.isView(u)&&s&&s.push(u.buffer),u instanceof ImageData&&s&&s.push(u.data.buffer),u;if(Array.isArray(u)){const v=[];for(const b of u)v.push(ds(b,s));return v}if(typeof u!="object")throw new Error("can't serialize object of type "+typeof u);const h=fu(u);if(!h)throw new Error(`can't serialize object of unregistered class ${u.constructor.name}`);if(!Vr[h])throw new Error(`${h} is not registered.`);const{klass:f}=Vr[h],m=f.serialize?f.serialize(u,s):{};if(f.serialize){if(s&&m===s[s.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const v in u){if(!u.hasOwnProperty(v)||Vr[h].omit.indexOf(v)>=0)continue;const b=u[v];m[v]=Vr[h].shallow.indexOf(v)>=0?b:ds(b,s)}u instanceof Error&&(m.message=u.message)}if(m.$name)throw new Error("$name property is reserved for worker serialization logic.");return h!=="Object"&&(m.$name=h),m}function ha(u){if(vd(u))return u;if(Array.isArray(u))return u.map(ha);if(typeof u!="object")throw new Error("can't deserialize object of type "+typeof u);const s=fu(u)||"Object";if(!Vr[s])throw new Error(`can't deserialize unregistered class ${s}`);const{klass:h}=Vr[s];if(!h)throw new Error(`can't deserialize unregistered class ${s}`);if(h.deserialize)return h.deserialize(u);const f=Object.create(h.prototype);for(const m of Object.keys(u)){if(m==="$name")continue;const v=u[m];f[m]=Vr[s].shallow.indexOf(m)>=0?v:ha(v)}return f}class wl{constructor(){this.first=!0}update(s,h){const f=Math.floor(s);return this.first?(this.first=!1,this.lastIntegerZoom=f,this.lastIntegerZoomTime=0,this.lastZoom=s,this.lastFloorZoom=f,!0):(this.lastFloorZoom>f?(this.lastIntegerZoom=f+1,this.lastIntegerZoomTime=h):this.lastFloorZoom<f&&(this.lastIntegerZoom=f,this.lastIntegerZoomTime=h),s!==this.lastZoom&&(this.lastZoom=s,this.lastFloorZoom=f,!0))}}const qt={"Latin-1 Supplement":u=>u>=128&&u<=255,"Hangul Jamo":u=>u>=4352&&u<=4607,Khmer:u=>u>=6016&&u<=6143,"General Punctuation":u=>u>=8192&&u<=8303,"Letterlike Symbols":u=>u>=8448&&u<=8527,"Number Forms":u=>u>=8528&&u<=8591,"Miscellaneous Technical":u=>u>=8960&&u<=9215,"Control Pictures":u=>u>=9216&&u<=9279,"Optical Character Recognition":u=>u>=9280&&u<=9311,"Enclosed Alphanumerics":u=>u>=9312&&u<=9471,"Geometric Shapes":u=>u>=9632&&u<=9727,"Miscellaneous Symbols":u=>u>=9728&&u<=9983,"Miscellaneous Symbols and Arrows":u=>u>=11008&&u<=11263,"Ideographic Description Characters":u=>u>=12272&&u<=12287,"CJK Symbols and Punctuation":u=>u>=12288&&u<=12351,Hiragana:u=>u>=12352&&u<=12447,Katakana:u=>u>=12448&&u<=12543,Kanbun:u=>u>=12688&&u<=12703,"CJK Strokes":u=>u>=12736&&u<=12783,"Enclosed CJK Letters and Months":u=>u>=12800&&u<=13055,"CJK Compatibility":u=>u>=13056&&u<=13311,"Yijing Hexagram Symbols":u=>u>=19904&&u<=19967,"CJK Unified Ideographs":u=>u>=19968&&u<=40959,"Hangul Syllables":u=>u>=44032&&u<=55215,"Private Use Area":u=>u>=57344&&u<=63743,"Vertical Forms":u=>u>=65040&&u<=65055,"CJK Compatibility Forms":u=>u>=65072&&u<=65103,"Small Form Variants":u=>u>=65104&&u<=65135,"Halfwidth and Fullwidth Forms":u=>u>=65280&&u<=65519};function Tl(u){for(const s of u)if(mu(s.charCodeAt(0)))return!0;return!1}function bd(u){for(const s of u)if(!pu(s.charCodeAt(0)))return!1;return!0}function Sl(u){const s=u.map((h=>{try{return new RegExp(`\\p{sc=${h}}`,"u").source}catch{return null}})).filter((h=>h));return new RegExp(s.join("|"),"u")}const wd=Sl(["Arab","Dupl","Mong","Ougr","Syrc"]);function pu(u){return!wd.test(String.fromCodePoint(u))}const gu=Sl(["Bopo","Hani","Hira","Kana","Kits","Nshu","Tang","Yiii"]);function mu(u){return!(u!==746&&u!==747&&(u<4352||!(qt["CJK Compatibility Forms"](u)&&!(u>=65097&&u<=65103)||qt["CJK Compatibility"](u)||qt["CJK Strokes"](u)||!(!qt["CJK Symbols and Punctuation"](u)||u>=12296&&u<=12305||u>=12308&&u<=12319||u===12336)||qt["Enclosed CJK Letters and Months"](u)||qt["Ideographic Description Characters"](u)||qt.Kanbun(u)||qt.Katakana(u)&&u!==12540||!(!qt["Halfwidth and Fullwidth Forms"](u)||u===65288||u===65289||u===65293||u>=65306&&u<=65310||u===65339||u===65341||u===65343||u>=65371&&u<=65503||u===65507||u>=65512&&u<=65519)||!(!qt["Small Form Variants"](u)||u>=65112&&u<=65118||u>=65123&&u<=65126)||qt["Vertical Forms"](u)||qt["Yijing Hexagram Symbols"](u)||/\p{sc=Cans}/u.test(String.fromCodePoint(u))||/\p{sc=Hang}/u.test(String.fromCodePoint(u))||gu.test(String.fromCodePoint(u)))))}function _u(u){return!(mu(u)||(function(s){return!!(qt["Latin-1 Supplement"](s)&&(s===167||s===169||s===174||s===177||s===188||s===189||s===190||s===215||s===247)||qt["General Punctuation"](s)&&(s===8214||s===8224||s===8225||s===8240||s===8241||s===8251||s===8252||s===8258||s===8263||s===8264||s===8265||s===8273)||qt["Letterlike Symbols"](s)||qt["Number Forms"](s)||qt["Miscellaneous Technical"](s)&&(s>=8960&&s<=8967||s>=8972&&s<=8991||s>=8996&&s<=9e3||s===9003||s>=9085&&s<=9114||s>=9150&&s<=9165||s===9167||s>=9169&&s<=9179||s>=9186&&s<=9215)||qt["Control Pictures"](s)&&s!==9251||qt["Optical Character Recognition"](s)||qt["Enclosed Alphanumerics"](s)||qt["Geometric Shapes"](s)||qt["Miscellaneous Symbols"](s)&&!(s>=9754&&s<=9759)||qt["Miscellaneous Symbols and Arrows"](s)&&(s>=11026&&s<=11055||s>=11088&&s<=11097||s>=11192&&s<=11243)||qt["CJK Symbols and Punctuation"](s)||qt.Katakana(s)||qt["Private Use Area"](s)||qt["CJK Compatibility Forms"](s)||qt["Small Form Variants"](s)||qt["Halfwidth and Fullwidth Forms"](s)||s===8734||s===8756||s===8757||s>=9984&&s<=10087||s>=10102&&s<=10131||s===65532||s===65533)})(u))}const $p=Sl(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function yu(u){return $p.test(String.fromCodePoint(u))}function Td(u,s){return!(!s&&yu(u)||u>=2304&&u<=3583||u>=3840&&u<=4255||qt.Khmer(u))}function Sd(u){for(const s of u)if(yu(s.charCodeAt(0)))return!0;return!1}const fs=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(u){this.pluginStatus=u.pluginStatus,this.pluginURL=u.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(u){if(fs.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=u.applyArabicShaping,this.processBidirectionalText=u.processBidirectionalText,this.processStyledBidirectionalText=u.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return this.applyArabicShaping!=null&&this.processBidirectionalText!=null&&this.processStyledBidirectionalText!=null}getRTLTextPluginStatus(){return this.pluginStatus}syncState(u,s){return a(this,void 0,void 0,(function*(){if(this.isParsed())return this.getState();if(u.pluginStatus!=="loading")return this.setState(u),u;const h=u.pluginURL,f=new Promise((v=>{this.loadScriptResolve=v}));s(h);const m=new Promise((v=>setTimeout((()=>v()),this.TIMEOUT)));if(yield Promise.race([f,m]),this.isParsed()){const v={pluginStatus:"loaded",pluginURL:h};return this.setState(v),v}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${h}`)}))}};class Ci{constructor(s,h){this.zoom=s,h?(this.now=h.now,this.fadeDuration=h.fadeDuration,this.zoomHistory=h.zoomHistory,this.transition=h.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new wl,this.transition={})}isSupportedScript(s){return(function(h,f){for(const m of h)if(!Td(m.charCodeAt(0),f))return!1;return!0})(s,fs.getRTLTextPluginStatus()==="loaded")}crossFadingFactor(){return this.fadeDuration===0?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const s=this.zoom,h=s-Math.floor(s),f=this.crossFadingFactor();return s>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:h+(1-h)*f}:{fromScale:.5,toScale:1,t:1-(1-f)*h}}}class da{constructor(s,h){this.property=s,this.value=h,this.expression=(function(f,m){if(pl(f))return new _l(f,m);if(gl(f)){const v=ad(f,m);if(v.result==="error")throw new Error(v.value.map((b=>`${b.key}: ${b.message}`)).join(", "));return v.value}{let v=f;return m.type==="color"&&typeof f=="string"?v=ni.parse(f):m.type!=="padding"||typeof f!="number"&&!Array.isArray(f)?m.type==="variableAnchorOffsetCollection"&&Array.isArray(f)?v=tr.parse(f):m.type==="projectionDefinition"&&typeof f=="string"&&(v=Ir.parse(f)):v=er.parse(f),{kind:"constant",evaluate:()=>v}}})(h===void 0?s.specification.default:h,s.specification)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(s,h,f){return this.property.possiblyEvaluate(this,s,h,f)}}class El{constructor(s){this.property=s,this.value=new da(s,void 0)}transitioned(s,h){return new vu(this.property,this.value,h,_t({},s.transition,this.transition),s.now)}untransitioned(){return new vu(this.property,this.value,null,{},0)}}class xu{constructor(s){this._properties=s,this._values=Object.create(s.defaultTransitionablePropertyValues)}getValue(s){return oi(this._values[s].value.value)}setValue(s,h){Object.prototype.hasOwnProperty.call(this._values,s)||(this._values[s]=new El(this._values[s].property)),this._values[s].value=new da(this._values[s].property,h===null?void 0:oi(h))}getTransition(s){return oi(this._values[s].transition)}setTransition(s,h){Object.prototype.hasOwnProperty.call(this._values,s)||(this._values[s]=new El(this._values[s].property)),this._values[s].transition=oi(h)||void 0}serialize(){const s={};for(const h of Object.keys(this._values)){const f=this.getValue(h);f!==void 0&&(s[h]=f);const m=this.getTransition(h);m!==void 0&&(s[`${h}-transition`]=m)}return s}transitioned(s,h){const f=new fa(this._properties);for(const m of Object.keys(this._values))f._values[m]=this._values[m].transitioned(s,h._values[m]);return f}untransitioned(){const s=new fa(this._properties);for(const h of Object.keys(this._values))s._values[h]=this._values[h].untransitioned();return s}}class vu{constructor(s,h,f,m,v){this.property=s,this.value=h,this.begin=v+m.delay||0,this.end=this.begin+m.duration||0,s.specification.transition&&(m.delay||m.duration)&&(this.prior=f)}possiblyEvaluate(s,h,f){const m=s.now||0,v=this.value.possiblyEvaluate(s,h,f),b=this.prior;if(b){if(m>this.end)return this.prior=null,v;if(this.value.isDataDriven())return this.prior=null,v;if(m<this.begin)return b.possiblyEvaluate(s,h,f);{const S=(m-this.begin)/(this.end-this.begin);return this.property.interpolate(b.possiblyEvaluate(s,h,f),v,je(S))}}return v}}class fa{constructor(s){this._properties=s,this._values=Object.create(s.defaultTransitioningPropertyValues)}possiblyEvaluate(s,h,f){const m=new Al(this._properties);for(const v of Object.keys(this._values))m._values[v]=this._values[v].possiblyEvaluate(s,h,f);return m}hasTransition(){for(const s of Object.keys(this._values))if(this._values[s].prior)return!0;return!1}}class Wp{constructor(s){this._properties=s,this._values=Object.create(s.defaultPropertyValues)}hasValue(s){return this._values[s].value!==void 0}getValue(s){return oi(this._values[s].value)}setValue(s,h){this._values[s]=new da(this._values[s].property,h===null?void 0:oi(h))}serialize(){const s={};for(const h of Object.keys(this._values)){const f=this.getValue(h);f!==void 0&&(s[h]=f)}return s}possiblyEvaluate(s,h,f){const m=new Al(this._properties);for(const v of Object.keys(this._values))m._values[v]=this._values[v].possiblyEvaluate(s,h,f);return m}}class en{constructor(s,h,f){this.property=s,this.value=h,this.parameters=f}isConstant(){return this.value.kind==="constant"}constantOr(s){return this.value.kind==="constant"?this.value.value:s}evaluate(s,h,f,m){return this.property.evaluate(this.value,this.parameters,s,h,f,m)}}class Al{constructor(s){this._properties=s,this._values=Object.create(s.defaultPossiblyEvaluatedValues)}get(s){return this._values[s]}}class Mt{constructor(s){this.specification=s}possiblyEvaluate(s,h){if(s.isDataDriven())throw new Error("Value should not be data driven");return s.expression.evaluate(h)}interpolate(s,h,f){const m=Ur[this.specification.type];return m?m(s,h,f):s}}class Bt{constructor(s,h){this.specification=s,this.overrides=h}possiblyEvaluate(s,h,f,m){return new en(this,s.expression.kind==="constant"||s.expression.kind==="camera"?{kind:"constant",value:s.expression.evaluate(h,null,{},f,m)}:s.expression,h)}interpolate(s,h,f){if(s.value.kind!=="constant"||h.value.kind!=="constant")return s;if(s.value.value===void 0||h.value.value===void 0)return new en(this,{kind:"constant",value:void 0},s.parameters);const m=Ur[this.specification.type];if(m){const v=m(s.value.value,h.value.value,f);return new en(this,{kind:"constant",value:v},s.parameters)}return s}evaluate(s,h,f,m,v,b){return s.kind==="constant"?s.value:s.evaluate(h,f,m,v,b)}}class pa extends Bt{possiblyEvaluate(s,h,f,m){if(s.value===void 0)return new en(this,{kind:"constant",value:void 0},h);if(s.expression.kind==="constant"){const v=s.expression.evaluate(h,null,{},f,m),b=s.property.specification.type==="resolvedImage"&&typeof v!="string"?v.name:v,S=this._calculate(b,b,b,h);return new en(this,{kind:"constant",value:S},h)}if(s.expression.kind==="camera"){const v=this._calculate(s.expression.evaluate({zoom:h.zoom-1}),s.expression.evaluate({zoom:h.zoom}),s.expression.evaluate({zoom:h.zoom+1}),h);return new en(this,{kind:"constant",value:v},h)}return new en(this,s.expression,h)}evaluate(s,h,f,m,v,b){if(s.kind==="source"){const S=s.evaluate(h,f,m,v,b);return this._calculate(S,S,S,h)}return s.kind==="composite"?this._calculate(s.evaluate({zoom:Math.floor(h.zoom)-1},f,m),s.evaluate({zoom:Math.floor(h.zoom)},f,m),s.evaluate({zoom:Math.floor(h.zoom)+1},f,m),h):s.value}_calculate(s,h,f,m){return m.zoom>m.zoomHistory.lastIntegerZoom?{from:s,to:h}:{from:f,to:h}}interpolate(s){return s}}class Pl{constructor(s){this.specification=s}possiblyEvaluate(s,h,f,m){if(s.value!==void 0){if(s.expression.kind==="constant"){const v=s.expression.evaluate(h,null,{},f,m);return this._calculate(v,v,v,h)}return this._calculate(s.expression.evaluate(new Ci(Math.floor(h.zoom-1),h)),s.expression.evaluate(new Ci(Math.floor(h.zoom),h)),s.expression.evaluate(new Ci(Math.floor(h.zoom+1),h)),h)}}_calculate(s,h,f,m){return m.zoom>m.zoomHistory.lastIntegerZoom?{from:s,to:h}:{from:f,to:h}}interpolate(s){return s}}class bu{constructor(s){this.specification=s}possiblyEvaluate(s,h,f,m){return!!s.expression.evaluate(h,null,{},f,m)}interpolate(){return!1}}class kr{constructor(s){this.properties=s,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const h in s){const f=s[h];f.specification.overridable&&this.overridableProperties.push(h);const m=this.defaultPropertyValues[h]=new da(f,void 0),v=this.defaultTransitionablePropertyValues[h]=new El(f);this.defaultTransitioningPropertyValues[h]=v.untransitioned(),this.defaultPossiblyEvaluatedValues[h]=m.possiblyEvaluate({})}}}wt("DataDrivenProperty",Bt),wt("DataConstantProperty",Mt),wt("CrossFadedDataDrivenProperty",pa),wt("CrossFadedProperty",Pl),wt("ColorRampProperty",bu);const Ed="-transition";class Sn extends Ne{constructor(s,h){if(super(),this.id=s.id,this.type=s.type,this._featureFilter={filter:()=>!0,needGeometry:!1},s.type!=="custom"&&(this.metadata=s.metadata,this.minzoom=s.minzoom,this.maxzoom=s.maxzoom,s.type!=="background"&&(this.source=s.source,this.sourceLayer=s["source-layer"],this.filter=s.filter),h.layout&&(this._unevaluatedLayout=new Wp(h.layout)),h.paint)){this._transitionablePaint=new xu(h.paint);for(const f in s.paint)this.setPaintProperty(f,s.paint[f],{validate:!1});for(const f in s.layout)this.setLayoutProperty(f,s.layout[f],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Al(h.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(s){return s==="visibility"?this.visibility:this._unevaluatedLayout.getValue(s)}setLayoutProperty(s,h,f={}){h!=null&&this._validate(jp,`layers.${this.id}.layout.${s}`,s,h,f)||(s!=="visibility"?this._unevaluatedLayout.setValue(s,h):this.visibility=h)}getPaintProperty(s){return s.endsWith(Ed)?this._transitionablePaint.getTransition(s.slice(0,-11)):this._transitionablePaint.getValue(s)}setPaintProperty(s,h,f={}){if(h!=null&&this._validate(du,`layers.${this.id}.paint.${s}`,s,h,f))return!1;if(s.endsWith(Ed))return this._transitionablePaint.setTransition(s.slice(0,-11),h||void 0),!1;{const m=this._transitionablePaint._values[s],v=m.property.specification["property-type"]==="cross-faded-data-driven",b=m.value.isDataDriven(),S=m.value;this._transitionablePaint.setValue(s,h),this._handleSpecialPaintPropertyUpdate(s);const P=this._transitionablePaint._values[s].value;return P.isDataDriven()||b||v||this._handleOverridablePaintPropertyUpdate(s,S,P)}}_handleSpecialPaintPropertyUpdate(s){}_handleOverridablePaintPropertyUpdate(s,h,f){return!1}isHidden(s){return!!(this.minzoom&&s<this.minzoom)||!!(this.maxzoom&&s>=this.maxzoom)||this.visibility==="none"}updateTransitions(s){this._transitioningPaint=this._transitionablePaint.transitioned(s,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(s,h){s.getCrossfadeParameters&&(this._crossfadeParameters=s.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(s,void 0,h)),this.paint=this._transitioningPaint.possiblyEvaluate(s,void 0,h)}serialize(){const s={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(s.layout=s.layout||{},s.layout.visibility=this.visibility),Wt(s,((h,f)=>!(h===void 0||f==="layout"&&!Object.keys(h).length||f==="paint"&&!Object.keys(h).length)))}_validate(s,h,f,m,v={}){return(!v||v.validate!==!1)&&bl(this,s.call(Eo,{key:h,layerType:this.type,objectKey:f,value:m,styleSpec:B,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const s in this.paint._values){const h=this.paint.get(s);if(h instanceof en&&xo(h.property.specification)&&(h.value.kind==="source"||h.value.kind==="composite")&&h.value.isStateDependent)return!0}return!1}}const Hp={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class En{constructor(s,h){this._structArray=s,this._pos1=h*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Oi{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(s,h){return s._trim(),h&&(s.isTransferred=!0,h.push(s.arrayBuffer)),{length:s.length,arrayBuffer:s.arrayBuffer}}static deserialize(s){const h=Object.create(this.prototype);return h.arrayBuffer=s.arrayBuffer,h.length=s.length,h.capacity=s.arrayBuffer.byteLength/h.bytesPerElement,h._refreshViews(),h}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(s){this.reserve(s),this.length=s}reserve(s){if(s>this.capacity){this.capacity=Math.max(s,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const h=this.uint8;this._refreshViews(),h&&this.uint8.set(h)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function zi(u,s=1){let h=0,f=0;return{members:u.map((m=>{const v=Hp[m.type].BYTES_PER_ELEMENT,b=h=Ad(h,Math.max(s,v)),S=m.components||1;return f=Math.max(f,v),h+=v*S,{name:m.name,type:m.type,components:S,offset:b}})),size:Ad(h,Math.max(f,s)),alignment:s}}function Ad(u,s){return Math.ceil(u/s)*s}class Po extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h){const f=this.length;return this.resize(f+1),this.emplace(f,s,h)}emplace(s,h,f){const m=2*s;return this.int16[m+0]=h,this.int16[m+1]=f,s}}Po.prototype.bytesPerElement=4,wt("StructArrayLayout2i4",Po);class Cl extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,f)}emplace(s,h,f,m){const v=3*s;return this.int16[v+0]=h,this.int16[v+1]=f,this.int16[v+2]=m,s}}Cl.prototype.bytesPerElement=6,wt("StructArrayLayout3i6",Cl);class wu extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,f,m){const v=this.length;return this.resize(v+1),this.emplace(v,s,h,f,m)}emplace(s,h,f,m,v){const b=4*s;return this.int16[b+0]=h,this.int16[b+1]=f,this.int16[b+2]=m,this.int16[b+3]=v,s}}wu.prototype.bytesPerElement=8,wt("StructArrayLayout4i8",wu);class jn extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b){const S=this.length;return this.resize(S+1),this.emplace(S,s,h,f,m,v,b)}emplace(s,h,f,m,v,b,S){const P=6*s;return this.int16[P+0]=h,this.int16[P+1]=f,this.int16[P+2]=m,this.int16[P+3]=v,this.int16[P+4]=b,this.int16[P+5]=S,s}}jn.prototype.bytesPerElement=12,wt("StructArrayLayout2i4i12",jn);class Il extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b){const S=this.length;return this.resize(S+1),this.emplace(S,s,h,f,m,v,b)}emplace(s,h,f,m,v,b,S){const P=4*s,M=8*s;return this.int16[P+0]=h,this.int16[P+1]=f,this.uint8[M+4]=m,this.uint8[M+5]=v,this.uint8[M+6]=b,this.uint8[M+7]=S,s}}Il.prototype.bytesPerElement=8,wt("StructArrayLayout2i4ub8",Il);class $s extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h){const f=this.length;return this.resize(f+1),this.emplace(f,s,h)}emplace(s,h,f){const m=2*s;return this.float32[m+0]=h,this.float32[m+1]=f,s}}$s.prototype.bytesPerElement=8,wt("StructArrayLayout2f8",$s);class Ml extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b,S,P,M,k){const O=this.length;return this.resize(O+1),this.emplace(O,s,h,f,m,v,b,S,P,M,k)}emplace(s,h,f,m,v,b,S,P,M,k,O){const U=10*s;return this.uint16[U+0]=h,this.uint16[U+1]=f,this.uint16[U+2]=m,this.uint16[U+3]=v,this.uint16[U+4]=b,this.uint16[U+5]=S,this.uint16[U+6]=P,this.uint16[U+7]=M,this.uint16[U+8]=k,this.uint16[U+9]=O,s}}Ml.prototype.bytesPerElement=20,wt("StructArrayLayout10ui20",Ml);class ga extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b,S,P,M,k,O,U){const j=this.length;return this.resize(j+1),this.emplace(j,s,h,f,m,v,b,S,P,M,k,O,U)}emplace(s,h,f,m,v,b,S,P,M,k,O,U,j){const $=12*s;return this.int16[$+0]=h,this.int16[$+1]=f,this.int16[$+2]=m,this.int16[$+3]=v,this.uint16[$+4]=b,this.uint16[$+5]=S,this.uint16[$+6]=P,this.uint16[$+7]=M,this.int16[$+8]=k,this.int16[$+9]=O,this.int16[$+10]=U,this.int16[$+11]=j,s}}ga.prototype.bytesPerElement=24,wt("StructArrayLayout4i4ui4i24",ga);class Tu extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,f)}emplace(s,h,f,m){const v=3*s;return this.float32[v+0]=h,this.float32[v+1]=f,this.float32[v+2]=m,s}}Tu.prototype.bytesPerElement=12,wt("StructArrayLayout3f12",Tu);class Co extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(s){const h=this.length;return this.resize(h+1),this.emplace(h,s)}emplace(s,h){return this.uint32[1*s+0]=h,s}}Co.prototype.bytesPerElement=4,wt("StructArrayLayout1ul4",Co);class Ws extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b,S,P,M){const k=this.length;return this.resize(k+1),this.emplace(k,s,h,f,m,v,b,S,P,M)}emplace(s,h,f,m,v,b,S,P,M,k){const O=10*s,U=5*s;return this.int16[O+0]=h,this.int16[O+1]=f,this.int16[O+2]=m,this.int16[O+3]=v,this.int16[O+4]=b,this.int16[O+5]=S,this.uint32[U+3]=P,this.uint16[O+8]=M,this.uint16[O+9]=k,s}}Ws.prototype.bytesPerElement=20,wt("StructArrayLayout6i1ul2ui20",Ws);class Su extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b){const S=this.length;return this.resize(S+1),this.emplace(S,s,h,f,m,v,b)}emplace(s,h,f,m,v,b,S){const P=6*s;return this.int16[P+0]=h,this.int16[P+1]=f,this.int16[P+2]=m,this.int16[P+3]=v,this.int16[P+4]=b,this.int16[P+5]=S,s}}Su.prototype.bytesPerElement=12,wt("StructArrayLayout2i2i2i12",Su);class Rl extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v){const b=this.length;return this.resize(b+1),this.emplace(b,s,h,f,m,v)}emplace(s,h,f,m,v,b){const S=4*s,P=8*s;return this.float32[S+0]=h,this.float32[S+1]=f,this.float32[S+2]=m,this.int16[P+6]=v,this.int16[P+7]=b,s}}Rl.prototype.bytesPerElement=16,wt("StructArrayLayout2f1f2i16",Rl);class Hs extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b){const S=this.length;return this.resize(S+1),this.emplace(S,s,h,f,m,v,b)}emplace(s,h,f,m,v,b,S){const P=16*s,M=4*s,k=8*s;return this.uint8[P+0]=h,this.uint8[P+1]=f,this.float32[M+1]=m,this.float32[M+2]=v,this.int16[k+6]=b,this.int16[k+7]=S,s}}Hs.prototype.bytesPerElement=16,wt("StructArrayLayout2ub2f2i16",Hs);class kl extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,f)}emplace(s,h,f,m){const v=3*s;return this.uint16[v+0]=h,this.uint16[v+1]=f,this.uint16[v+2]=m,s}}kl.prototype.bytesPerElement=6,wt("StructArrayLayout3ui6",kl);class Eu extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b,S,P,M,k,O,U,j,$,Z,te,ce){const Me=this.length;return this.resize(Me+1),this.emplace(Me,s,h,f,m,v,b,S,P,M,k,O,U,j,$,Z,te,ce)}emplace(s,h,f,m,v,b,S,P,M,k,O,U,j,$,Z,te,ce,Me){const pe=24*s,V=12*s,Q=48*s;return this.int16[pe+0]=h,this.int16[pe+1]=f,this.uint16[pe+2]=m,this.uint16[pe+3]=v,this.uint32[V+2]=b,this.uint32[V+3]=S,this.uint32[V+4]=P,this.uint16[pe+10]=M,this.uint16[pe+11]=k,this.uint16[pe+12]=O,this.float32[V+7]=U,this.float32[V+8]=j,this.uint8[Q+36]=$,this.uint8[Q+37]=Z,this.uint8[Q+38]=te,this.uint32[V+10]=ce,this.int16[pe+22]=Me,s}}Eu.prototype.bytesPerElement=48,wt("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",Eu);class Dl extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,f,m,v,b,S,P,M,k,O,U,j,$,Z,te,ce,Me,pe,V,Q,me,We,lt,Ye,Qe,ft,ut){const gt=this.length;return this.resize(gt+1),this.emplace(gt,s,h,f,m,v,b,S,P,M,k,O,U,j,$,Z,te,ce,Me,pe,V,Q,me,We,lt,Ye,Qe,ft,ut)}emplace(s,h,f,m,v,b,S,P,M,k,O,U,j,$,Z,te,ce,Me,pe,V,Q,me,We,lt,Ye,Qe,ft,ut,gt){const st=32*s,St=16*s;return this.int16[st+0]=h,this.int16[st+1]=f,this.int16[st+2]=m,this.int16[st+3]=v,this.int16[st+4]=b,this.int16[st+5]=S,this.int16[st+6]=P,this.int16[st+7]=M,this.uint16[st+8]=k,this.uint16[st+9]=O,this.uint16[st+10]=U,this.uint16[st+11]=j,this.uint16[st+12]=$,this.uint16[st+13]=Z,this.uint16[st+14]=te,this.uint16[st+15]=ce,this.uint16[st+16]=Me,this.uint16[st+17]=pe,this.uint16[st+18]=V,this.uint16[st+19]=Q,this.uint16[st+20]=me,this.uint16[st+21]=We,this.uint16[st+22]=lt,this.uint32[St+12]=Ye,this.float32[St+13]=Qe,this.float32[St+14]=ft,this.uint16[st+30]=ut,this.uint16[st+31]=gt,s}}Dl.prototype.bytesPerElement=64,wt("StructArrayLayout8i15ui1ul2f2ui64",Dl);class Ol extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s){const h=this.length;return this.resize(h+1),this.emplace(h,s)}emplace(s,h){return this.float32[1*s+0]=h,s}}Ol.prototype.bytesPerElement=4,wt("StructArrayLayout1f4",Ol);class _ extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,f)}emplace(s,h,f,m){const v=3*s;return this.uint16[6*s+0]=h,this.float32[v+1]=f,this.float32[v+2]=m,s}}_.prototype.bytesPerElement=12,wt("StructArrayLayout1ui2f12",_);class n extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h,f){const m=this.length;return this.resize(m+1),this.emplace(m,s,h,f)}emplace(s,h,f,m){const v=4*s;return this.uint32[2*s+0]=h,this.uint16[v+2]=f,this.uint16[v+3]=m,s}}n.prototype.bytesPerElement=8,wt("StructArrayLayout1ul2ui8",n);class l extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s,h){const f=this.length;return this.resize(f+1),this.emplace(f,s,h)}emplace(s,h,f){const m=2*s;return this.uint16[m+0]=h,this.uint16[m+1]=f,s}}l.prototype.bytesPerElement=4,wt("StructArrayLayout2ui4",l);class p extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(s){const h=this.length;return this.resize(h+1),this.emplace(h,s)}emplace(s,h){return this.uint16[1*s+0]=h,s}}p.prototype.bytesPerElement=2,wt("StructArrayLayout1ui2",p);class g extends Oi{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(s,h,f,m){const v=this.length;return this.resize(v+1),this.emplace(v,s,h,f,m)}emplace(s,h,f,m,v){const b=4*s;return this.float32[b+0]=h,this.float32[b+1]=f,this.float32[b+2]=m,this.float32[b+3]=v,s}}g.prototype.bytesPerElement=16,wt("StructArrayLayout4f16",g);class x extends En{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new X(this.anchorPointX,this.anchorPointY)}}x.prototype.size=20;class T extends Ws{get(s){return new x(this,s)}}wt("CollisionBoxArray",T);class A extends En{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(s){this._structArray.uint8[this._pos1+37]=s}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(s){this._structArray.uint8[this._pos1+38]=s}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(s){this._structArray.uint32[this._pos4+10]=s}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}A.prototype.size=48;class C extends Eu{get(s){return new A(this,s)}}wt("PlacedSymbolArray",C);class R extends En{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(s){this._structArray.uint32[this._pos4+12]=s}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}R.prototype.size=64;class L extends Dl{get(s){return new R(this,s)}}wt("SymbolInstanceArray",L);class N extends Ol{getoffsetX(s){return this.float32[1*s+0]}}wt("GlyphOffsetArray",N);class z extends Cl{getx(s){return this.int16[3*s+0]}gety(s){return this.int16[3*s+1]}gettileUnitDistanceFromAnchor(s){return this.int16[3*s+2]}}wt("SymbolLineVertexArray",z);class H extends En{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}H.prototype.size=12;class q extends _{get(s){return new H(this,s)}}wt("TextAnchorOffsetArray",q);class se extends En{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}se.prototype.size=8;class ne extends n{get(s){return new se(this,s)}}wt("FeatureIndexArray",ne);class le extends Po{}class he extends Po{}class xe extends Po{}class ve extends jn{}class Pe extends Il{}class Re extends $s{}class Ie extends Ml{}class $e extends ga{}class He extends Tu{}class it extends Co{}class nt extends Su{}class et extends Hs{}class xt extends kl{}class yt extends l{}const ct=zi([{name:"a_pos",components:2,type:"Int16"}],4),{members:Pt}=ct;class Rt{constructor(s=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=s}prepareSegment(s,h,f,m){const v=this.segments[this.segments.length-1];return s>Rt.MAX_VERTEX_ARRAY_LENGTH&&ci(`Max vertices per segment is ${Rt.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${s}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${Rt.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!v||v.vertexLength+s>Rt.MAX_VERTEX_ARRAY_LENGTH||v.sortKey!==m?this.createNewSegment(h,f,m):v}createNewSegment(s,h,f){const m={vertexOffset:s.length,primitiveOffset:h.length,vertexLength:0,primitiveLength:0,vaos:{}};return f!==void 0&&(m.sortKey=f),this._forceNewSegmentOnNextPrepare=!1,this.segments.push(m),m}getOrCreateLatestSegment(s,h,f){return this.prepareSegment(0,s,h,f)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const s of this.segments)for(const h in s.vaos)s.vaos[h].destroy()}static simpleSegment(s,h,f,m){return new Rt([{vertexOffset:s,primitiveOffset:h,vertexLength:f,primitiveLength:m,vaos:{},sortKey:0}])}}function li(u,s){return 256*(u=pt(Math.floor(u),0,255))+pt(Math.floor(s),0,255)}Rt.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,wt("SegmentVector",Rt);const xi=zi([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var fi,Ii,wi,ui={exports:{}},pi={exports:{}},ir={exports:{}},rr=(function(){if(wi)return ui.exports;wi=1;var u=(fi||(fi=1,pi.exports=function(h,f){var m,v,b,S,P,M,k,O;for(v=h.length-(m=3&h.length),b=f,P=3432918353,M=461845907,O=0;O<v;)k=255&h.charCodeAt(O)|(255&h.charCodeAt(++O))<<8|(255&h.charCodeAt(++O))<<16|(255&h.charCodeAt(++O))<<24,++O,b=27492+(65535&(S=5*(65535&(b=(b^=k=(65535&(k=(k=(65535&k)*P+(((k>>>16)*P&65535)<<16)&4294967295)<<15|k>>>17))*M+(((k>>>16)*M&65535)<<16)&4294967295)<<13|b>>>19))+((5*(b>>>16)&65535)<<16)&4294967295))+((58964+(S>>>16)&65535)<<16);switch(k=0,m){case 3:k^=(255&h.charCodeAt(O+2))<<16;case 2:k^=(255&h.charCodeAt(O+1))<<8;case 1:b^=k=(65535&(k=(k=(65535&(k^=255&h.charCodeAt(O)))*P+(((k>>>16)*P&65535)<<16)&4294967295)<<15|k>>>17))*M+(((k>>>16)*M&65535)<<16)&4294967295}return b^=h.length,b=2246822507*(65535&(b^=b>>>16))+((2246822507*(b>>>16)&65535)<<16)&4294967295,b=3266489909*(65535&(b^=b>>>13))+((3266489909*(b>>>16)&65535)<<16)&4294967295,(b^=b>>>16)>>>0}),pi.exports),s=(Ii||(Ii=1,ir.exports=function(h,f){for(var m,v=h.length,b=f^v,S=0;v>=4;)m=1540483477*(65535&(m=255&h.charCodeAt(S)|(255&h.charCodeAt(++S))<<8|(255&h.charCodeAt(++S))<<16|(255&h.charCodeAt(++S))<<24))+((1540483477*(m>>>16)&65535)<<16),b=1540483477*(65535&b)+((1540483477*(b>>>16)&65535)<<16)^(m=1540483477*(65535&(m^=m>>>24))+((1540483477*(m>>>16)&65535)<<16)),v-=4,++S;switch(v){case 3:b^=(255&h.charCodeAt(S+2))<<16;case 2:b^=(255&h.charCodeAt(S+1))<<8;case 1:b=1540483477*(65535&(b^=255&h.charCodeAt(S)))+((1540483477*(b>>>16)&65535)<<16)}return b=1540483477*(65535&(b^=b>>>13))+((1540483477*(b>>>16)&65535)<<16),(b^=b>>>15)>>>0}),ir.exports);return ui.exports=u,ui.exports.murmur3=u,ui.exports.murmur2=s,ui.exports})(),Xi=y(rr);class fr{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(s,h,f,m){this.ids.push(ps(s)),this.positions.push(h,f,m)}getPositions(s){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const h=ps(s);let f=0,m=this.ids.length-1;for(;f<m;){const b=f+m>>1;this.ids[b]>=h?m=b:f=b+1}const v=[];for(;this.ids[f]===h;)v.push({index:this.positions[3*f],start:this.positions[3*f+1],end:this.positions[3*f+2]}),f++;return v}static serialize(s,h){const f=new Float64Array(s.ids),m=new Uint32Array(s.positions);return $n(f,m,0,f.length-1),h&&h.push(f.buffer,m.buffer),{ids:f,positions:m}}static deserialize(s){const h=new fr;return h.ids=s.ids,h.positions=s.positions,h.indexed=!0,h}}function ps(u){const s=+u;return!isNaN(s)&&s<=Number.MAX_SAFE_INTEGER?s:Xi(String(u))}function $n(u,s,h,f){for(;h<f;){const m=u[h+f>>1];let v=h-1,b=f+1;for(;;){do v++;while(u[v]<m);do b--;while(u[b]>m);if(v>=b)break;An(u,v,b),An(s,3*v,3*b),An(s,3*v+1,3*b+1),An(s,3*v+2,3*b+2)}b-h<f-b?($n(u,s,h,b),h=b+1):($n(u,s,b+1,f),f=b)}}function An(u,s,h){const f=u[s];u[s]=u[h],u[h]=f}wt("FeaturePositionMap",fr);class tn{constructor(s,h){this.gl=s.gl,this.location=h}}class Zs extends tn{constructor(s,h){super(s,h),this.current=0}set(s){this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class ma extends tn{constructor(s,h){super(s,h),this.current=[0,0,0,0]}set(s){s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3]))}}class qs extends tn{constructor(s,h){super(s,h),this.current=ni.transparent}set(s){s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a))}}const rn=new Float32Array(16);function Pn(u){return[li(255*u.r,255*u.g),li(255*u.b,255*u.a)]}class un{constructor(s,h,f){this.value=s,this.uniformNames=h.map((m=>`u_${m}`)),this.type=f}setUniform(s,h,f){s.set(f.constantOr(this.value))}getBinding(s,h,f){return this.type==="color"?new qs(s,h):new Zs(s,h)}}class Cn{constructor(s,h){this.uniformNames=h.map((f=>`u_${f}`)),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(s,h){this.pixelRatioFrom=h.pixelRatio,this.pixelRatioTo=s.pixelRatio,this.patternFrom=h.tlbr,this.patternTo=s.tlbr}setUniform(s,h,f,m){const v=m==="u_pattern_to"?this.patternTo:m==="u_pattern_from"?this.patternFrom:m==="u_pixel_ratio_to"?this.pixelRatioTo:m==="u_pixel_ratio_from"?this.pixelRatioFrom:null;v&&s.set(v)}getBinding(s,h,f){return f.substr(0,9)==="u_pattern"?new ma(s,h):new Zs(s,h)}}class vi{constructor(s,h,f,m){this.expression=s,this.type=f,this.maxValue=0,this.paintVertexAttributes=h.map((v=>({name:`a_${v}`,type:"Float32",components:f==="color"?2:1,offset:0}))),this.paintVertexArray=new m}populatePaintArray(s,h,f,m,v){const b=this.paintVertexArray.length,S=this.expression.evaluate(new Ci(0),h,{},m,[],v);this.paintVertexArray.resize(s),this._setPaintValue(b,s,S)}updatePaintArray(s,h,f,m){const v=this.expression.evaluate({zoom:0},f,m);this._setPaintValue(s,h,v)}_setPaintValue(s,h,f){if(this.type==="color"){const m=Pn(f);for(let v=s;v<h;v++)this.paintVertexArray.emplace(v,m[0],m[1])}else{for(let m=s;m<h;m++)this.paintVertexArray.emplace(m,f);this.maxValue=Math.max(this.maxValue,Math.abs(f))}}upload(s){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=s.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class _i{constructor(s,h,f,m,v,b){this.expression=s,this.uniformNames=h.map((S=>`u_${S}_t`)),this.type=f,this.useIntegerZoom=m,this.zoom=v,this.maxValue=0,this.paintVertexAttributes=h.map((S=>({name:`a_${S}`,type:"Float32",components:f==="color"?4:2,offset:0}))),this.paintVertexArray=new b}populatePaintArray(s,h,f,m,v){const b=this.expression.evaluate(new Ci(this.zoom),h,{},m,[],v),S=this.expression.evaluate(new Ci(this.zoom+1),h,{},m,[],v),P=this.paintVertexArray.length;this.paintVertexArray.resize(s),this._setPaintValue(P,s,b,S)}updatePaintArray(s,h,f,m){const v=this.expression.evaluate({zoom:this.zoom},f,m),b=this.expression.evaluate({zoom:this.zoom+1},f,m);this._setPaintValue(s,h,v,b)}_setPaintValue(s,h,f,m){if(this.type==="color"){const v=Pn(f),b=Pn(m);for(let S=s;S<h;S++)this.paintVertexArray.emplace(S,v[0],v[1],b[0],b[1])}else{for(let v=s;v<h;v++)this.paintVertexArray.emplace(v,f,m);this.maxValue=Math.max(this.maxValue,Math.abs(f),Math.abs(m))}}upload(s){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=s.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(s,h){const f=this.useIntegerZoom?Math.floor(h.zoom):h.zoom,m=pt(this.expression.interpolationFactor(f,this.zoom,this.zoom+1),0,1);s.set(m)}getBinding(s,h,f){return new Zs(s,h)}}class Gi{constructor(s,h,f,m,v,b){this.expression=s,this.type=h,this.useIntegerZoom=f,this.zoom=m,this.layerId=b,this.zoomInPaintVertexArray=new v,this.zoomOutPaintVertexArray=new v}populatePaintArray(s,h,f){const m=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(s),this.zoomOutPaintVertexArray.resize(s),this._setPaintValues(m,s,h.patterns&&h.patterns[this.layerId],f)}updatePaintArray(s,h,f,m,v){this._setPaintValues(s,h,f.patterns&&f.patterns[this.layerId],v)}_setPaintValues(s,h,f,m){if(!m||!f)return;const{min:v,mid:b,max:S}=f,P=m[v],M=m[b],k=m[S];if(P&&M&&k)for(let O=s;O<h;O++)this.zoomInPaintVertexArray.emplace(O,M.tl[0],M.tl[1],M.br[0],M.br[1],P.tl[0],P.tl[1],P.br[0],P.br[1],M.pixelRatio,P.pixelRatio),this.zoomOutPaintVertexArray.emplace(O,M.tl[0],M.tl[1],M.br[0],M.br[1],k.tl[0],k.tl[1],k.br[0],k.br[1],M.pixelRatio,k.pixelRatio)}upload(s){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=s.createVertexBuffer(this.zoomInPaintVertexArray,xi.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=s.createVertexBuffer(this.zoomOutPaintVertexArray,xi.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class Yi{constructor(s,h,f){this.binders={},this._buffers=[];const m=[];for(const v in s.paint._values){if(!f(v))continue;const b=s.paint.get(v);if(!(b instanceof en&&xo(b.property.specification)))continue;const S=Zp(v,s.type),P=b.value,M=b.property.specification.type,k=b.property.useIntegerZoom,O=b.property.specification["property-type"],U=O==="cross-faded"||O==="cross-faded-data-driven";if(P.kind==="constant")this.binders[v]=U?new Cn(P.value,S):new un(P.value,S,M),m.push(`/u_${v}`);else if(P.kind==="source"||U){const j=Pd(v,M,"source");this.binders[v]=U?new Gi(P,M,k,h,j,s.id):new vi(P,S,M,j),m.push(`/a_${v}`)}else{const j=Pd(v,M,"composite");this.binders[v]=new _i(P,S,M,k,h,j),m.push(`/z_${v}`)}}this.cacheKey=m.sort().join("")}getMaxValue(s){const h=this.binders[s];return h instanceof vi||h instanceof _i?h.maxValue:0}populatePaintArrays(s,h,f,m,v){for(const b in this.binders){const S=this.binders[b];(S instanceof vi||S instanceof _i||S instanceof Gi)&&S.populatePaintArray(s,h,f,m,v)}}setConstantPatternPositions(s,h){for(const f in this.binders){const m=this.binders[f];m instanceof Cn&&m.setConstantPatternPositions(s,h)}}updatePaintArrays(s,h,f,m,v){let b=!1;for(const S in s){const P=h.getPositions(S);for(const M of P){const k=f.feature(M.index);for(const O in this.binders){const U=this.binders[O];if((U instanceof vi||U instanceof _i||U instanceof Gi)&&U.expression.isStateDependent===!0){const j=m.paint.get(O);U.expression=j.value,U.updatePaintArray(M.start,M.end,k,s[S],v),b=!0}}}}return b}defines(){const s=[];for(const h in this.binders){const f=this.binders[h];(f instanceof un||f instanceof Cn)&&s.push(...f.uniformNames.map((m=>`#define HAS_UNIFORM_${m}`)))}return s}getBinderAttributes(){const s=[];for(const h in this.binders){const f=this.binders[h];if(f instanceof vi||f instanceof _i)for(let m=0;m<f.paintVertexAttributes.length;m++)s.push(f.paintVertexAttributes[m].name);else if(f instanceof Gi)for(let m=0;m<xi.members.length;m++)s.push(xi.members[m].name)}return s}getBinderUniforms(){const s=[];for(const h in this.binders){const f=this.binders[h];if(f instanceof un||f instanceof Cn||f instanceof _i)for(const m of f.uniformNames)s.push(m)}return s}getPaintVertexBuffers(){return this._buffers}getUniforms(s,h){const f=[];for(const m in this.binders){const v=this.binders[m];if(v instanceof un||v instanceof Cn||v instanceof _i){for(const b of v.uniformNames)if(h[b]){const S=v.getBinding(s,h[b],b);f.push({name:b,property:m,binding:S})}}}return f}setUniforms(s,h,f,m){for(const{name:v,property:b,binding:S}of h)this.binders[b].setUniform(S,m,f.get(b),v)}updatePaintBuffers(s){this._buffers=[];for(const h in this.binders){const f=this.binders[h];if(s&&f instanceof Gi){const m=s.fromScale===2?f.zoomInPaintVertexBuffer:f.zoomOutPaintVertexBuffer;m&&this._buffers.push(m)}else(f instanceof vi||f instanceof _i)&&f.paintVertexBuffer&&this._buffers.push(f.paintVertexBuffer)}}upload(s){for(const h in this.binders){const f=this.binders[h];(f instanceof vi||f instanceof _i||f instanceof Gi)&&f.upload(s)}this.updatePaintBuffers()}destroy(){for(const s in this.binders){const h=this.binders[s];(h instanceof vi||h instanceof _i||h instanceof Gi)&&h.destroy()}}}class Xs{constructor(s,h,f=(()=>!0)){this.programConfigurations={};for(const m of s)this.programConfigurations[m.id]=new Yi(m,h,f);this.needsUpload=!1,this._featureMap=new fr,this._bufferOffset=0}populatePaintArrays(s,h,f,m,v,b){for(const S in this.programConfigurations)this.programConfigurations[S].populatePaintArrays(s,h,m,v,b);h.id!==void 0&&this._featureMap.add(h.id,f,this._bufferOffset,s),this._bufferOffset=s,this.needsUpload=!0}updatePaintArrays(s,h,f,m){for(const v of f)this.needsUpload=this.programConfigurations[v.id].updatePaintArrays(s,this._featureMap,h,v,m)||this.needsUpload}get(s){return this.programConfigurations[s]}upload(s){if(this.needsUpload){for(const h in this.programConfigurations)this.programConfigurations[h].upload(s);this.needsUpload=!1}}destroy(){for(const s in this.programConfigurations)this.programConfigurations[s].destroy()}}function Zp(u,s){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[u]||[u.replace(`${s}-`,"").replace(/-/g,"_")]}function Pd(u,s,h){const f={color:{source:$s,composite:g},number:{source:Ol,composite:$s}},m=(function(v){return{"line-pattern":{source:Ie,composite:Ie},"fill-pattern":{source:Ie,composite:Ie},"fill-extrusion-pattern":{source:Ie,composite:Ie}}[v]})(u);return m&&m[h]||f[s][h]}wt("ConstantBinder",un),wt("CrossFadedConstantBinder",Cn),wt("SourceExpressionBinder",vi),wt("CrossFadedCompositeBinder",Gi),wt("CompositeExpressionBinder",_i),wt("ProgramConfiguration",Yi,{omit:["_buffers"]}),wt("ProgramConfigurationSet",Xs);const Au=Math.pow(2,14)-1,Cd=-Au-1;function Gs(u){const s=W/u.extent,h=u.loadGeometry();for(let f=0;f<h.length;f++){const m=h[f];for(let v=0;v<m.length;v++){const b=m[v],S=Math.round(b.x*s),P=Math.round(b.y*s);b.x=pt(S,Cd,Au),b.y=pt(P,Cd,Au),(S<b.x||S>b.x+1||P<b.y||P>b.y+1)&&ci("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return h}function jr(u,s){return{type:u.type,id:u.id,properties:u.properties,geometry:s?Gs(u):[]}}const Pu=-32768;function Id(u,s,h,f,m){u.emplaceBack(Pu+8*s+f,Pu+8*h+m)}class Ll{constructor(s){this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map((h=>h.id)),this.index=s.index,this.hasPattern=!1,this.layoutVertexArray=new he,this.indexArray=new xt,this.segments=new Rt,this.programConfigurations=new Xs(s.layers,s.zoom),this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id))}populate(s,h,f){const m=this.layers[0],v=[];let b=null,S=!1,P=m.type==="heatmap";if(m.type==="circle"){const k=m;b=k.layout.get("circle-sort-key"),S=!b.isConstant(),P=P||k.paint.get("circle-pitch-alignment")==="map"}const M=P?h.subdivisionGranularity.circle:1;for(const{feature:k,id:O,index:U,sourceLayerIndex:j}of s){const $=this.layers[0]._featureFilter.needGeometry,Z=jr(k,$);if(!this.layers[0]._featureFilter.filter(new Ci(this.zoom),Z,f))continue;const te=S?b.evaluate(Z,{},f):void 0,ce={id:O,properties:k.properties,type:k.type,sourceLayerIndex:j,index:U,geometry:$?Z.geometry:Gs(k),patterns:{},sortKey:te};v.push(ce)}S&&v.sort(((k,O)=>k.sortKey-O.sortKey));for(const k of v){const{geometry:O,index:U,sourceLayerIndex:j}=k,$=s[U].feature;this.addFeature(k,O,U,f,M),h.featureIndex.insert($,O,U,j,this.index)}}update(s,h,f){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,h,this.stateDependentLayers,f)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,Pt),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(s,h,f,m,v=1){let b;switch(v){case 1:b=[0,7];break;case 3:b=[0,2,5,7];break;case 5:b=[0,1,3,4,6,7];break;case 7:b=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${v}; valid values are 1, 3, 5, 7.`)}const S=b.length;for(const P of h)for(const M of P){const k=M.x,O=M.y;if(k<0||k>=W||O<0||O>=W)continue;const U=this.segments.prepareSegment(S*S,this.layoutVertexArray,this.indexArray,s.sortKey),j=U.vertexLength;for(let $=0;$<S;$++)for(let Z=0;Z<S;Z++)Id(this.layoutVertexArray,k,O,b[Z],b[$]);for(let $=0;$<S-1;$++)for(let Z=0;Z<S-1;Z++){const te=j+$*S+Z,ce=j+($+1)*S+Z;this.indexArray.emplaceBack(te,ce+1,te+1),this.indexArray.emplaceBack(te,ce,ce+1)}U.vertexLength+=S*S,U.primitiveLength+=(S-1)*(S-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,f,{},m)}}function Fl(u,s){for(let h=0;h<u.length;h++)if(Nl(s,u[h]))return!0;for(let h=0;h<s.length;h++)if(Nl(u,s[h]))return!0;return!!qp(u,s)}function Md(u,s,h){return!!Nl(u,s)||!!Xp(s,u,h)}function Bl(u,s){if(u.length===1)return vy(s,u[0]);for(let h=0;h<s.length;h++){const f=s[h];for(let m=0;m<f.length;m++)if(Nl(u,f[m]))return!0}for(let h=0;h<u.length;h++)if(vy(s,u[h]))return!0;for(let h=0;h<s.length;h++)if(qp(u,s[h]))return!0;return!1}function BT(u,s,h){if(u.length>1){if(qp(u,s))return!0;for(let f=0;f<s.length;f++)if(Xp(s[f],u,h))return!0}for(let f=0;f<u.length;f++)if(Xp(u[f],s,h))return!0;return!1}function qp(u,s){if(u.length===0||s.length===0)return!1;for(let h=0;h<u.length-1;h++){const f=u[h],m=u[h+1];for(let v=0;v<s.length-1;v++)if(NT(f,m,s[v],s[v+1]))return!0}return!1}function NT(u,s,h,f){return di(u,h,f)!==di(s,h,f)&&di(u,s,h)!==di(u,s,f)}function Xp(u,s,h){const f=h*h;if(s.length===1)return u.distSqr(s[0])<f;for(let m=1;m<s.length;m++)if(xy(u,s[m-1],s[m])<f)return!0;return!1}function xy(u,s,h){const f=s.distSqr(h);if(f===0)return u.distSqr(s);const m=((u.x-s.x)*(h.x-s.x)+(u.y-s.y)*(h.y-s.y))/f;return u.distSqr(m<0?s:m>1?h:h.sub(s)._mult(m)._add(s))}function vy(u,s){let h,f,m,v=!1;for(let b=0;b<u.length;b++){h=u[b];for(let S=0,P=h.length-1;S<h.length;P=S++)f=h[S],m=h[P],f.y>s.y!=m.y>s.y&&s.x<(m.x-f.x)*(s.y-f.y)/(m.y-f.y)+f.x&&(v=!v)}return v}function Nl(u,s){let h=!1;for(let f=0,m=u.length-1;f<u.length;m=f++){const v=u[f],b=u[m];v.y>s.y!=b.y>s.y&&s.x<(b.x-v.x)*(s.y-v.y)/(b.y-v.y)+v.x&&(h=!h)}return h}function zT(u,s,h){const f=h[0],m=h[2];if(u.x<f.x&&s.x<f.x||u.x>m.x&&s.x>m.x||u.y<f.y&&s.y<f.y||u.y>m.y&&s.y>m.y)return!1;const v=di(u,s,h[0]);return v!==di(u,s,h[1])||v!==di(u,s,h[2])||v!==di(u,s,h[3])}function Cu(u,s,h){const f=s.paint.get(u).value;return f.kind==="constant"?f.value:h.programConfigurations.get(s.id).getMaxValue(u)}function Rd(u){return Math.sqrt(u[0]*u[0]+u[1]*u[1])}function kd(u,s,h,f,m){if(!s[0]&&!s[1])return u;const v=X.convert(s)._mult(m);h==="viewport"&&v._rotate(-f);const b=[];for(let S=0;S<u.length;S++)b.push(u[S].sub(v));return b}let by,wy;wt("CircleBucket",Ll,{omit:["layers"]});var UT={get paint(){return wy=wy||new kr({"circle-radius":new Bt(B.paint_circle["circle-radius"]),"circle-color":new Bt(B.paint_circle["circle-color"]),"circle-blur":new Bt(B.paint_circle["circle-blur"]),"circle-opacity":new Bt(B.paint_circle["circle-opacity"]),"circle-translate":new Mt(B.paint_circle["circle-translate"]),"circle-translate-anchor":new Mt(B.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Mt(B.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Mt(B.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Bt(B.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Bt(B.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Bt(B.paint_circle["circle-stroke-opacity"])})},get layout(){return by=by||new kr({"circle-sort-key":new Bt(B.layout_circle["circle-sort-key"])})}};class VT extends Sn{constructor(s){super(s,UT)}createBucket(s){return new Ll(s)}queryRadius(s){const h=s;return Cu("circle-radius",this,h)+Cu("circle-stroke-width",this,h)+Rd(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:s,feature:h,featureState:f,geometry:m,transform:v,pixelsToTileUnits:b,pixelPosMatrix:S}){const P=kd(s,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-v.bearingInRadians,b),M=this.paint.get("circle-radius").evaluate(h,f)+this.paint.get("circle-stroke-width").evaluate(h,f),k=this.paint.get("circle-pitch-alignment")==="map",O=k?P:(function(j,$){return j.map((Z=>Ty(Z,$)))})(P,S),U=k?M*b:M;for(const j of m)for(const $ of j){const Z=k?$:Ty($,S);let te=U;const ce=ye([],[$.x,$.y,0,1],S);if(this.paint.get("circle-pitch-scale")==="viewport"&&this.paint.get("circle-pitch-alignment")==="map"?te*=ce[3]/v.cameraToCenterDistance:this.paint.get("circle-pitch-scale")==="map"&&this.paint.get("circle-pitch-alignment")==="viewport"&&(te*=v.cameraToCenterDistance/ce[3]),Md(O,Z,te))return!0}return!1}}function Ty(u,s){const h=ye([],[u.x,u.y,0,1],s);return new X(h[0]/h[3],h[1]/h[3])}class Sy extends Ll{}let Ey;wt("HeatmapBucket",Sy,{omit:["layers"]});var jT={get paint(){return Ey=Ey||new kr({"heatmap-radius":new Bt(B.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Bt(B.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Mt(B.paint_heatmap["heatmap-intensity"]),"heatmap-color":new bu(B.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Mt(B.paint_heatmap["heatmap-opacity"])})}};function Gp(u,{width:s,height:h},f,m){if(m){if(m instanceof Uint8ClampedArray)m=new Uint8Array(m.buffer);else if(m.length!==s*h*f)throw new RangeError(`mismatched image size. expected: ${m.length} but got: ${s*h*f}`)}else m=new Uint8Array(s*h*f);return u.width=s,u.height=h,u.data=m,u}function Ay(u,{width:s,height:h},f){if(s===u.width&&h===u.height)return;const m=Gp({},{width:s,height:h},f);Yp(u,m,{x:0,y:0},{x:0,y:0},{width:Math.min(u.width,s),height:Math.min(u.height,h)},f),u.width=s,u.height=h,u.data=m.data}function Yp(u,s,h,f,m,v){if(m.width===0||m.height===0)return s;if(m.width>u.width||m.height>u.height||h.x>u.width-m.width||h.y>u.height-m.height)throw new RangeError("out of range source coordinates for image copy");if(m.width>s.width||m.height>s.height||f.x>s.width-m.width||f.y>s.height-m.height)throw new RangeError("out of range destination coordinates for image copy");const b=u.data,S=s.data;if(b===S)throw new Error("srcData equals dstData, so image is already copied");for(let P=0;P<m.height;P++){const M=((h.y+P)*u.width+h.x)*v,k=((f.y+P)*s.width+f.x)*v;for(let O=0;O<m.width*v;O++)S[k+O]=b[M+O]}return s}class Iu{constructor(s,h){Gp(this,s,1,h)}resize(s){Ay(this,s,1)}clone(){return new Iu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(s,h,f,m,v){Yp(s,h,f,m,v,1)}}class hn{constructor(s,h){Gp(this,s,4,h)}resize(s){Ay(this,s,4)}replace(s,h){h?this.data.set(s):this.data=s instanceof Uint8ClampedArray?new Uint8Array(s.buffer):s}clone(){return new hn({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(s,h,f,m,v){Yp(s,h,f,m,v,4)}}function Py(u){const s={},h=u.resolution||256,f=u.clips?u.clips.length:1,m=u.image||new hn({width:h,height:f});if(Math.log(h)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${h}`);const v=(b,S,P)=>{s[u.evaluationKey]=P;const M=u.expression.evaluate(s);m.data[b+S+0]=Math.floor(255*M.r/M.a),m.data[b+S+1]=Math.floor(255*M.g/M.a),m.data[b+S+2]=Math.floor(255*M.b/M.a),m.data[b+S+3]=Math.floor(255*M.a)};if(u.clips)for(let b=0,S=0;b<f;++b,S+=4*h)for(let P=0,M=0;P<h;P++,M+=4){const k=P/(h-1),{start:O,end:U}=u.clips[b];v(S,M,O*(1-k)+U*k)}else for(let b=0,S=0;b<h;b++,S+=4)v(0,S,b/(h-1));return m}wt("AlphaImage",Iu),wt("RGBAImage",hn);const Kp="big-fb";class $T extends Sn{createBucket(s){return new Sy(s)}constructor(s){super(s,jT),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(s){s==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Py({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(Kp)&&this.heatmapFbos.delete(Kp)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}}let Cy;var WT={get paint(){return Cy=Cy||new kr({"hillshade-illumination-direction":new Mt(B.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Mt(B.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Mt(B.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Mt(B.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Mt(B.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Mt(B.paint_hillshade["hillshade-accent-color"])})}};class HT extends Sn{constructor(s){super(s,WT)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}}const ZT=zi([{name:"a_pos",components:2,type:"Int16"}],4),{members:qT}=ZT;function Jp(u,s,h){const f=h.patternDependencies;let m=!1;for(const v of s){const b=v.paint.get(`${u}-pattern`);b.isConstant()||(m=!0);const S=b.constantOr(null);S&&(m=!0,f[S.to]=!0,f[S.from]=!0)}return m}function Qp(u,s,h,f,m){const v=m.patternDependencies;for(const b of s){const S=b.paint.get(`${u}-pattern`).value;if(S.kind!=="constant"){let P=S.evaluate({zoom:f-1},h,{},m.availableImages),M=S.evaluate({zoom:f},h,{},m.availableImages),k=S.evaluate({zoom:f+1},h,{},m.availableImages);P=P&&P.name?P.name:P,M=M&&M.name?M.name:M,k=k&&k.name?k.name:k,v[P]=!0,v[M]=!0,v[k]=!0,h.patterns[b.id]={min:P,mid:M,max:k}}}return h}function Iy(u,s,h,f,m){let v;if(m===(function(b,S,P,M){let k=0;for(let O=S,U=P-M;O<P;O+=M)k+=(b[U]-b[O])*(b[O+1]+b[U+1]),U=O;return k})(u,s,h,f)>0)for(let b=s;b<h;b+=f)v=Dy(b/f|0,u[b],u[b+1],v);else for(let b=h-f;b>=s;b-=f)v=Dy(b/f|0,u[b],u[b+1],v);return v&&zl(v,v.next)&&(Du(v),v=v.next),v}function _a(u,s){if(!u)return u;s||(s=u);let h,f=u;do if(h=!1,f.steiner||!zl(f,f.next)&&Ui(f.prev,f,f.next)!==0)f=f.next;else{if(Du(f),f=s=f.prev,f===f.next)break;h=!0}while(h||f!==s);return s}function Mu(u,s,h,f,m,v,b){if(!u)return;!b&&v&&(function(P,M,k,O){let U=P;do U.z===0&&(U.z=eg(U.x,U.y,M,k,O)),U.prevZ=U.prev,U.nextZ=U.next,U=U.next;while(U!==P);U.prevZ.nextZ=null,U.prevZ=null,(function(j){let $,Z=1;do{let te,ce=j;j=null;let Me=null;for($=0;ce;){$++;let pe=ce,V=0;for(let me=0;me<Z&&(V++,pe=pe.nextZ,pe);me++);let Q=Z;for(;V>0||Q>0&&pe;)V!==0&&(Q===0||!pe||ce.z<=pe.z)?(te=ce,ce=ce.nextZ,V--):(te=pe,pe=pe.nextZ,Q--),Me?Me.nextZ=te:j=te,te.prevZ=Me,Me=te;ce=pe}Me.nextZ=null,Z*=2}while($>1)})(U)})(u,f,m,v);let S=u;for(;u.prev!==u.next;){const P=u.prev,M=u.next;if(v?GT(u,f,m,v):XT(u))s.push(P.i,u.i,M.i),Du(u),u=M.next,S=M.next;else if((u=M)===S){b?b===1?Mu(u=YT(_a(u),s),s,h,f,m,v,2):b===2&&KT(u,s,h,f,m,v):Mu(_a(u),s,h,f,m,v,1);break}}}function XT(u){const s=u.prev,h=u,f=u.next;if(Ui(s,h,f)>=0)return!1;const m=s.x,v=h.x,b=f.x,S=s.y,P=h.y,M=f.y,k=Math.min(m,v,b),O=Math.min(S,P,M),U=Math.max(m,v,b),j=Math.max(S,P,M);let $=f.next;for(;$!==s;){if($.x>=k&&$.x<=U&&$.y>=O&&$.y<=j&&Ru(m,S,v,P,b,M,$.x,$.y)&&Ui($.prev,$,$.next)>=0)return!1;$=$.next}return!0}function GT(u,s,h,f){const m=u.prev,v=u,b=u.next;if(Ui(m,v,b)>=0)return!1;const S=m.x,P=v.x,M=b.x,k=m.y,O=v.y,U=b.y,j=Math.min(S,P,M),$=Math.min(k,O,U),Z=Math.max(S,P,M),te=Math.max(k,O,U),ce=eg(j,$,s,h,f),Me=eg(Z,te,s,h,f);let pe=u.prevZ,V=u.nextZ;for(;pe&&pe.z>=ce&&V&&V.z<=Me;){if(pe.x>=j&&pe.x<=Z&&pe.y>=$&&pe.y<=te&&pe!==m&&pe!==b&&Ru(S,k,P,O,M,U,pe.x,pe.y)&&Ui(pe.prev,pe,pe.next)>=0||(pe=pe.prevZ,V.x>=j&&V.x<=Z&&V.y>=$&&V.y<=te&&V!==m&&V!==b&&Ru(S,k,P,O,M,U,V.x,V.y)&&Ui(V.prev,V,V.next)>=0))return!1;V=V.nextZ}for(;pe&&pe.z>=ce;){if(pe.x>=j&&pe.x<=Z&&pe.y>=$&&pe.y<=te&&pe!==m&&pe!==b&&Ru(S,k,P,O,M,U,pe.x,pe.y)&&Ui(pe.prev,pe,pe.next)>=0)return!1;pe=pe.prevZ}for(;V&&V.z<=Me;){if(V.x>=j&&V.x<=Z&&V.y>=$&&V.y<=te&&V!==m&&V!==b&&Ru(S,k,P,O,M,U,V.x,V.y)&&Ui(V.prev,V,V.next)>=0)return!1;V=V.nextZ}return!0}function YT(u,s){let h=u;do{const f=h.prev,m=h.next.next;!zl(f,m)&&Ry(f,h,h.next,m)&&ku(f,m)&&ku(m,f)&&(s.push(f.i,h.i,m.i),Du(h),Du(h.next),h=u=m),h=h.next}while(h!==u);return _a(h)}function KT(u,s,h,f,m,v){let b=u;do{let S=b.next.next;for(;S!==b.prev;){if(b.i!==S.i&&i2(b,S)){let P=ky(b,S);return b=_a(b,b.next),P=_a(P,P.next),Mu(b,s,h,f,m,v,0),void Mu(P,s,h,f,m,v,0)}S=S.next}b=b.next}while(b!==u)}function JT(u,s){let h=u.x-s.x;return h===0&&(h=u.y-s.y,h===0)&&(h=(u.next.y-u.y)/(u.next.x-u.x)-(s.next.y-s.y)/(s.next.x-s.x)),h}function QT(u,s){const h=(function(m,v){let b=v;const S=m.x,P=m.y;let M,k=-1/0;if(zl(m,b))return b;do{if(zl(m,b.next))return b.next;if(P<=b.y&&P>=b.next.y&&b.next.y!==b.y){const Z=b.x+(P-b.y)*(b.next.x-b.x)/(b.next.y-b.y);if(Z<=S&&Z>k&&(k=Z,M=b.x<b.next.x?b:b.next,Z===S))return M}b=b.next}while(b!==v);if(!M)return null;const O=M,U=M.x,j=M.y;let $=1/0;b=M;do{if(S>=b.x&&b.x>=U&&S!==b.x&&My(P<j?S:k,P,U,j,P<j?k:S,P,b.x,b.y)){const Z=Math.abs(P-b.y)/(S-b.x);ku(b,m)&&(Z<$||Z===$&&(b.x>M.x||b.x===M.x&&e2(M,b)))&&(M=b,$=Z)}b=b.next}while(b!==O);return M})(u,s);if(!h)return s;const f=ky(h,u);return _a(f,f.next),_a(h,h.next)}function e2(u,s){return Ui(u.prev,u,s.prev)<0&&Ui(s.next,u,u.next)<0}function eg(u,s,h,f,m){return(u=1431655765&((u=858993459&((u=252645135&((u=16711935&((u=(u-h)*m|0)|u<<8))|u<<4))|u<<2))|u<<1))|(s=1431655765&((s=858993459&((s=252645135&((s=16711935&((s=(s-f)*m|0)|s<<8))|s<<4))|s<<2))|s<<1))<<1}function t2(u){let s=u,h=u;do(s.x<h.x||s.x===h.x&&s.y<h.y)&&(h=s),s=s.next;while(s!==u);return h}function My(u,s,h,f,m,v,b,S){return(m-b)*(s-S)>=(u-b)*(v-S)&&(u-b)*(f-S)>=(h-b)*(s-S)&&(h-b)*(v-S)>=(m-b)*(f-S)}function Ru(u,s,h,f,m,v,b,S){return!(u===b&&s===S)&&My(u,s,h,f,m,v,b,S)}function i2(u,s){return u.next.i!==s.i&&u.prev.i!==s.i&&!(function(h,f){let m=h;do{if(m.i!==h.i&&m.next.i!==h.i&&m.i!==f.i&&m.next.i!==f.i&&Ry(m,m.next,h,f))return!0;m=m.next}while(m!==h);return!1})(u,s)&&(ku(u,s)&&ku(s,u)&&(function(h,f){let m=h,v=!1;const b=(h.x+f.x)/2,S=(h.y+f.y)/2;do m.y>S!=m.next.y>S&&m.next.y!==m.y&&b<(m.next.x-m.x)*(S-m.y)/(m.next.y-m.y)+m.x&&(v=!v),m=m.next;while(m!==h);return v})(u,s)&&(Ui(u.prev,u,s.prev)||Ui(u,s.prev,s))||zl(u,s)&&Ui(u.prev,u,u.next)>0&&Ui(s.prev,s,s.next)>0)}function Ui(u,s,h){return(s.y-u.y)*(h.x-s.x)-(s.x-u.x)*(h.y-s.y)}function zl(u,s){return u.x===s.x&&u.y===s.y}function Ry(u,s,h,f){const m=Od(Ui(u,s,h)),v=Od(Ui(u,s,f)),b=Od(Ui(h,f,u)),S=Od(Ui(h,f,s));return m!==v&&b!==S||!(m!==0||!Dd(u,h,s))||!(v!==0||!Dd(u,f,s))||!(b!==0||!Dd(h,u,f))||!(S!==0||!Dd(h,s,f))}function Dd(u,s,h){return s.x<=Math.max(u.x,h.x)&&s.x>=Math.min(u.x,h.x)&&s.y<=Math.max(u.y,h.y)&&s.y>=Math.min(u.y,h.y)}function Od(u){return u>0?1:u<0?-1:0}function ku(u,s){return Ui(u.prev,u,u.next)<0?Ui(u,s,u.next)>=0&&Ui(u,u.prev,s)>=0:Ui(u,s,u.prev)<0||Ui(u,u.next,s)<0}function ky(u,s){const h=tg(u.i,u.x,u.y),f=tg(s.i,s.x,s.y),m=u.next,v=s.prev;return u.next=s,s.prev=u,h.next=m,m.prev=h,f.next=h,h.prev=f,v.next=f,f.prev=v,f}function Dy(u,s,h,f){const m=tg(u,s,h);return f?(m.next=f.next,m.prev=f,f.next.prev=m,f.next=m):(m.prev=m,m.next=m),m}function Du(u){u.next.prev=u.prev,u.prev.next=u.next,u.prevZ&&(u.prevZ.nextZ=u.nextZ),u.nextZ&&(u.nextZ.prevZ=u.prevZ)}function tg(u,s,h){return{i:u,x:s,y:h,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Ul{constructor(s,h){if(h>s)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=s,this._minGranularity=h}getGranularityForZoomLevel(s){return Math.max(Math.floor(this._baseZoomGranularity/(1<<s)),this._minGranularity,1)}}class Ld{constructor(s){this.fill=s.fill,this.line=s.line,this.tile=s.tile,this.stencil=s.stencil,this.circle=s.circle}}Ld.noSubdivision=new Ld({fill:new Ul(0,0),line:new Ul(0,0),tile:new Ul(0,0),stencil:new Ul(0,0),circle:1}),wt("SubdivisionGranularityExpression",Ul),wt("SubdivisionGranularitySetting",Ld);const Vl=-32768,Ou=32767;class r2{constructor(s,h){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=s,this._granularityCellSize=W/s,this._canonical=h}_getKey(s,h){return(s+=32768)<<16|(h+=32768)<<0}_vertexToIndex(s,h){if(s<-32768||h<-32768||s>32767||h>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const f=0|Math.round(s),m=0|Math.round(h),v=this._getKey(f,m);if(this._vertexDictionary.has(v))return this._vertexDictionary.get(v);const b=this._vertexBuffer.length/2;return this._vertexDictionary.set(v,b),this._vertexBuffer.push(f,m),b}_subdivideTrianglesScanline(s){if(this._granularity<2)return(function(m,v){const b=[];for(let S=0;S<v.length;S+=3){const P=v[S],M=v[S+1],k=v[S+2],O=m[2*P],U=m[2*P+1];(m[2*M]-O)*(m[2*k+1]-U)-(m[2*M+1]-U)*(m[2*k]-O)>0?(b.push(P),b.push(k),b.push(M)):(b.push(P),b.push(M),b.push(k))}return b})(this._vertexBuffer,s);const h=[],f=s.length;for(let m=0;m<f;m+=3){const v=[s[m+0],s[m+1],s[m+2]],b=[this._vertexBuffer[2*s[m+0]+0],this._vertexBuffer[2*s[m+0]+1],this._vertexBuffer[2*s[m+1]+0],this._vertexBuffer[2*s[m+1]+1],this._vertexBuffer[2*s[m+2]+0],this._vertexBuffer[2*s[m+2]+1]];let S=1/0,P=1/0,M=-1/0,k=-1/0;for(let Z=0;Z<3;Z++){const te=b[2*Z],ce=b[2*Z+1];S=Math.min(S,te),M=Math.max(M,te),P=Math.min(P,ce),k=Math.max(k,ce)}if(S===M||P===k)continue;const O=Math.floor(S/this._granularityCellSize),U=Math.ceil(M/this._granularityCellSize),j=Math.floor(P/this._granularityCellSize),$=Math.ceil(k/this._granularityCellSize);if(O!==U||j!==$)for(let Z=j;Z<$;Z++){const te=this._scanlineGenerateVertexRingForCellRow(Z,b,v);n2(this._vertexBuffer,te,h)}else h.push(...v)}return h}_scanlineGenerateVertexRingForCellRow(s,h,f){const m=s*this._granularityCellSize,v=m+this._granularityCellSize,b=[];for(let S=0;S<3;S++){const P=h[2*S],M=h[2*S+1],k=h[2*(S+1)%6],O=h[(2*(S+1)+1)%6],U=h[2*(S+2)%6],j=h[(2*(S+2)+1)%6],$=k-P,Z=O-M,te=$===0,ce=Z===0,Me=(m-M)/Z,pe=(v-M)/Z,V=Math.min(Me,pe),Q=Math.max(Me,pe);if(!ce&&(V>=1||Q<=0)||ce&&(M<m||M>v)){O>=m&&O<=v&&b.push(f[(S+1)%3]);continue}!ce&&V>0&&b.push(this._vertexToIndex(P+$*V,M+Z*V));const me=P+$*Math.max(V,0),We=P+$*Math.min(Q,1);te||this._generateIntraEdgeVertices(b,P,M,k,O,me,We),!ce&&Q<1&&b.push(this._vertexToIndex(P+$*Q,M+Z*Q)),(ce||O>=m&&O<=v)&&b.push(f[(S+1)%3]),!ce&&(O<=m||O>=v)&&this._generateInterEdgeVertices(b,P,M,k,O,U,j,We,m,v)}return b}_generateIntraEdgeVertices(s,h,f,m,v,b,S){const P=m-h,M=v-f,k=M===0,O=k?Math.min(h,m):Math.min(b,S),U=k?Math.max(h,m):Math.max(b,S),j=Math.floor(O/this._granularityCellSize)+1,$=Math.ceil(U/this._granularityCellSize)-1;if(k?h<m:b<S)for(let Z=j;Z<=$;Z++){const te=Z*this._granularityCellSize;s.push(this._vertexToIndex(te,f+M*(te-h)/P))}else for(let Z=$;Z>=j;Z--){const te=Z*this._granularityCellSize;s.push(this._vertexToIndex(te,f+M*(te-h)/P))}}_generateInterEdgeVertices(s,h,f,m,v,b,S,P,M,k){const O=v-f,U=b-m,j=S-v,$=(M-v)/j,Z=(k-v)/j,te=Math.min($,Z),ce=Math.max($,Z),Me=m+U*te;let pe=Math.floor(Math.min(Me,P)/this._granularityCellSize)+1,V=Math.ceil(Math.max(Me,P)/this._granularityCellSize)-1,Q=P<Me;const me=j===0;if(me&&(S===M||S===k))return;if(me||te>=1||ce<=0){const lt=f-S,Ye=b+(h-b)*Math.min((M-S)/lt,(k-S)/lt);pe=Math.floor(Math.min(Ye,P)/this._granularityCellSize)+1,V=Math.ceil(Math.max(Ye,P)/this._granularityCellSize)-1,Q=P<Ye}const We=O>0?k:M;if(Q)for(let lt=pe;lt<=V;lt++)s.push(this._vertexToIndex(lt*this._granularityCellSize,We));else for(let lt=V;lt>=pe;lt--)s.push(this._vertexToIndex(lt*this._granularityCellSize,We))}_generateOutline(s){const h=[];for(const f of s){const m=ya(f,this._granularity,!0),v=this._pointArrayToIndices(m),b=[];for(let S=1;S<v.length;S++)b.push(v[S-1]),b.push(v[S]);h.push(b)}return h}_handlePoles(s){let h=!1,f=!1;this._canonical&&(this._canonical.y===0&&(h=!0),this._canonical.y===(1<<this._canonical.z)-1&&(f=!0)),(h||f)&&this._fillPoles(s,h,f)}_ensureNoPoleVertices(){const s=this._vertexBuffer;for(let h=0;h<s.length;h+=2){const f=s[h+1];f===Vl&&(s[h+1]=-32767),f===Ou&&(s[h+1]=32766)}}_generatePoleQuad(s,h,f,m,v,b){m>v!=(b===Vl)?(s.push(h),s.push(f),s.push(this._vertexToIndex(m,b)),s.push(f),s.push(this._vertexToIndex(v,b)),s.push(this._vertexToIndex(m,b))):(s.push(f),s.push(h),s.push(this._vertexToIndex(m,b)),s.push(this._vertexToIndex(v,b)),s.push(f),s.push(this._vertexToIndex(m,b)))}_fillPoles(s,h,f){const m=this._vertexBuffer,v=W,b=s.length;for(let S=2;S<b;S+=3){const P=s[S-2],M=s[S-1],k=s[S],O=m[2*P],U=m[2*P+1],j=m[2*M],$=m[2*M+1],Z=m[2*k],te=m[2*k+1];h&&(U===0&&$===0&&this._generatePoleQuad(s,P,M,O,j,Vl),$===0&&te===0&&this._generatePoleQuad(s,M,k,j,Z,Vl),te===0&&U===0&&this._generatePoleQuad(s,k,P,Z,O,Vl)),f&&(U===v&&$===v&&this._generatePoleQuad(s,P,M,O,j,Ou),$===v&&te===v&&this._generatePoleQuad(s,M,k,j,Z,Ou),te===v&&U===v&&this._generatePoleQuad(s,k,P,Z,O,Ou))}}_initializeVertices(s){for(let h=0;h<s.length;h+=2)this._vertexToIndex(s[h],s[h+1])}subdividePolygonInternal(s,h){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:f,holeIndices:m}=(function(S){const P=[],M=[];for(const k of S)if(k.length!==0){k!==S[0]&&P.push(M.length/2);for(let O=0;O<k.length;O++)M.push(k[O].x),M.push(k[O].y)}return{flattened:M,holeIndices:P}})(s);let v;this._initializeVertices(f);try{const S=(function(M,k,O=2){const U=k&&k.length,j=U?k[0]*O:M.length;let $=Iy(M,0,j,O,!0);const Z=[];if(!$||$.next===$.prev)return Z;let te,ce,Me;if(U&&($=(function(pe,V,Q,me){const We=[];for(let lt=0,Ye=V.length;lt<Ye;lt++){const Qe=Iy(pe,V[lt]*me,lt<Ye-1?V[lt+1]*me:pe.length,me,!1);Qe===Qe.next&&(Qe.steiner=!0),We.push(t2(Qe))}We.sort(JT);for(let lt=0;lt<We.length;lt++)Q=QT(We[lt],Q);return Q})(M,k,$,O)),M.length>80*O){te=1/0,ce=1/0;let pe=-1/0,V=-1/0;for(let Q=O;Q<j;Q+=O){const me=M[Q],We=M[Q+1];me<te&&(te=me),We<ce&&(ce=We),me>pe&&(pe=me),We>V&&(V=We)}Me=Math.max(pe-te,V-ce),Me=Me!==0?32767/Me:0}return Mu($,Z,O,te,ce,Me,0),Z})(f,m),P=this._convertIndices(f,S);v=this._subdivideTrianglesScanline(P)}catch(S){console.error(S)}let b=[];return h&&(b=this._generateOutline(s)),this._ensureNoPoleVertices(),this._handlePoles(v),{verticesFlattened:this._vertexBuffer,indicesTriangles:v,indicesLineList:b}}_convertIndices(s,h){const f=[];for(let m=0;m<h.length;m++)f.push(this._vertexToIndex(s[2*h[m]],s[2*h[m]+1]));return f}_pointArrayToIndices(s){const h=[];for(let f=0;f<s.length;f++){const m=s[f];h.push(this._vertexToIndex(m.x,m.y))}return h}}function Oy(u,s,h,f=!0){return new r2(h,s).subdividePolygonInternal(u,f)}function ya(u,s,h=!1){if(!u||u.length<1)return[];if(u.length<2)return[];const f=u[0],m=u[u.length-1],v=h&&(f.x!==m.x||f.y!==m.y);if(s<2)return v?[...u,u[0]]:[...u];const b=Math.floor(W/s),S=[];S.push(new X(u[0].x,u[0].y));const P=u.length,M=v?P:P-1;for(let k=0;k<M;k++){const O=u[k],U=k<P-1?u[k+1]:u[0],j=O.x,$=O.y,Z=U.x,te=U.y,ce=j!==Z,Me=$!==te;if(!ce&&!Me)continue;const pe=Z-j,V=te-$,Q=Math.abs(pe),me=Math.abs(V);let We=j,lt=$;for(;;){const Qe=pe>0?(Math.floor(We/b)+1)*b:(Math.ceil(We/b)-1)*b,ft=V>0?(Math.floor(lt/b)+1)*b:(Math.ceil(lt/b)-1)*b,ut=Math.abs(We-Qe),gt=Math.abs(lt-ft),st=Math.abs(We-Z),St=Math.abs(lt-te),Ft=ce?ut/Q:Number.POSITIVE_INFINITY,Ot=Me?gt/me:Number.POSITIVE_INFINITY;if((st<=ut||!ce)&&(St<=gt||!Me))break;if(Ft<Ot&&ce||!Me){We=Qe,lt+=V*Ft;const Ct=new X(We,Math.round(lt));S[S.length-1].x===Ct.x&&S[S.length-1].y===Ct.y||S.push(Ct)}else{We+=pe*Ot,lt=ft;const Ct=new X(Math.round(We),lt);S[S.length-1].x===Ct.x&&S[S.length-1].y===Ct.y||S.push(Ct)}}const Ye=new X(Z,te);S[S.length-1].x===Ye.x&&S[S.length-1].y===Ye.y||S.push(Ye)}return S}function n2(u,s,h){if(s.length===0)throw new Error("Subdivision vertex ring is empty.");let f=0,m=u[2*s[0]];for(let P=1;P<s.length;P++){const M=u[2*s[P]];M<m&&(m=M,f=P)}const v=s.length;let b=f,S=(b+1)%v;for(;;){const P=b-1>=0?b-1:v-1,M=(S+1)%v,k=u[2*s[P]],O=u[2*s[M]],U=u[2*s[b]],j=u[2*s[b]+1],$=u[2*s[S]+1];let Z=!1;if(k<O)Z=!0;else if(k>O)Z=!1;else{const te=$-j,ce=-(u[2*s[S]]-U),Me=j<$?1:-1;((k-U)*te+(u[2*s[P]+1]-j)*ce)*Me>((O-U)*te+(u[2*s[M]+1]-j)*ce)*Me&&(Z=!0)}if(Z){const te=s[P],ce=s[b],Me=s[S];te!==ce&&te!==Me&&ce!==Me&&h.push(Me,ce,te),b--,b<0&&(b=v-1)}else{const te=s[M],ce=s[b],Me=s[S];te!==ce&&te!==Me&&ce!==Me&&h.push(Me,ce,te),S++,S>=v&&(S=0)}if(P===M)break}}function Ly(u,s,h,f,m,v,b,S,P){const M=m.length/2,k=b&&S&&P;if(M<Rt.MAX_VERTEX_ARRAY_LENGTH){const O=s.prepareSegment(M,h,f),U=O.vertexLength;for(let Z=0;Z<v.length;Z+=3)f.emplaceBack(U+v[Z],U+v[Z+1],U+v[Z+2]);let j,$;O.vertexLength+=M,O.primitiveLength+=v.length/3,k&&($=b.prepareSegment(M,h,S),j=$.vertexLength,$.vertexLength+=M);for(let Z=0;Z<m.length;Z+=2)u(m[Z],m[Z+1]);if(k)for(let Z=0;Z<P.length;Z++){const te=P[Z];for(let ce=1;ce<te.length;ce+=2)S.emplaceBack(j+te[ce-1],j+te[ce]);$.primitiveLength+=te.length/2}}else(function(O,U,j,$,Z,te){const ce=[];for(let me=0;me<$.length/2;me++)ce.push(-1);const Me={count:0};let pe=0,V=O.getOrCreateLatestSegment(U,j),Q=V.vertexLength;for(let me=2;me<Z.length;me+=3){const We=Z[me-2],lt=Z[me-1],Ye=Z[me];let Qe=ce[We]<pe,ft=ce[lt]<pe,ut=ce[Ye]<pe;V.vertexLength+((Qe?1:0)+(ft?1:0)+(ut?1:0))>Rt.MAX_VERTEX_ARRAY_LENGTH&&(V=O.createNewSegment(U,j),pe=Me.count,Qe=!0,ft=!0,ut=!0,Q=0);const gt=Lu(ce,$,te,Me,We,Qe,V),st=Lu(ce,$,te,Me,lt,ft,V),St=Lu(ce,$,te,Me,Ye,ut,V);j.emplaceBack(Q+gt-pe,Q+st-pe,Q+St-pe),V.primitiveLength++}})(s,h,f,m,v,u),k&&(function(O,U,j,$,Z,te){const ce=[];for(let me=0;me<$.length/2;me++)ce.push(-1);const Me={count:0};let pe=0,V=O.getOrCreateLatestSegment(U,j),Q=V.vertexLength;for(let me=0;me<Z.length;me++){const We=Z[me];for(let lt=1;lt<Z[me].length;lt+=2){const Ye=We[lt-1],Qe=We[lt];let ft=ce[Ye]<pe,ut=ce[Qe]<pe;V.vertexLength+((ft?1:0)+(ut?1:0))>Rt.MAX_VERTEX_ARRAY_LENGTH&&(V=O.createNewSegment(U,j),pe=Me.count,ft=!0,ut=!0,Q=0);const gt=Lu(ce,$,te,Me,Ye,ft,V),st=Lu(ce,$,te,Me,Qe,ut,V);j.emplaceBack(Q+gt-pe,Q+st-pe),V.primitiveLength++}}})(b,h,S,m,P,u),s.forceNewSegmentOnNextPrepare(),b?.forceNewSegmentOnNextPrepare()}function Lu(u,s,h,f,m,v,b){if(v){const S=f.count;return h(s[2*m],s[2*m+1]),u[m]=f.count,f.count++,b.vertexLength++,S}return u[m]}class ig{constructor(s){this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map((h=>h.id)),this.index=s.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new xe,this.indexArray=new xt,this.indexArray2=new yt,this.programConfigurations=new Xs(s.layers,s.zoom),this.segments=new Rt,this.segments2=new Rt,this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id))}populate(s,h,f){this.hasPattern=Jp("fill",this.layers,h);const m=this.layers[0].layout.get("fill-sort-key"),v=!m.isConstant(),b=[];for(const{feature:S,id:P,index:M,sourceLayerIndex:k}of s){const O=this.layers[0]._featureFilter.needGeometry,U=jr(S,O);if(!this.layers[0]._featureFilter.filter(new Ci(this.zoom),U,f))continue;const j=v?m.evaluate(U,{},f,h.availableImages):void 0,$={id:P,properties:S.properties,type:S.type,sourceLayerIndex:k,index:M,geometry:O?U.geometry:Gs(S),patterns:{},sortKey:j};b.push($)}v&&b.sort(((S,P)=>S.sortKey-P.sortKey));for(const S of b){const{geometry:P,index:M,sourceLayerIndex:k}=S;if(this.hasPattern){const O=Qp("fill",this.layers,S,this.zoom,h);this.patternFeatures.push(O)}else this.addFeature(S,P,M,f,{},h.subdivisionGranularity);h.featureIndex.insert(s[M].feature,P,M,k,this.index)}}update(s,h,f){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,h,this.stateDependentLayers,f)}addFeatures(s,h,f){for(const m of this.patternFeatures)this.addFeature(m,m.geometry,m.index,h,f,s.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,qT),this.indexBuffer=s.createIndexBuffer(this.indexArray),this.indexBuffer2=s.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(s,h,f,m,v,b){for(const S of nl(h,500)){const P=Oy(S,m,b.fill.getGranularityForZoomLevel(m.z)),M=this.layoutVertexArray;Ly(((k,O)=>{M.emplaceBack(k,O)}),this.segments,this.layoutVertexArray,this.indexArray,P.verticesFlattened,P.indicesTriangles,this.segments2,this.indexArray2,P.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,f,v,m)}}let Fy,By;wt("FillBucket",ig,{omit:["layers","patternFeatures"]});var s2={get paint(){return By=By||new kr({"fill-antialias":new Mt(B.paint_fill["fill-antialias"]),"fill-opacity":new Bt(B.paint_fill["fill-opacity"]),"fill-color":new Bt(B.paint_fill["fill-color"]),"fill-outline-color":new Bt(B.paint_fill["fill-outline-color"]),"fill-translate":new Mt(B.paint_fill["fill-translate"]),"fill-translate-anchor":new Mt(B.paint_fill["fill-translate-anchor"]),"fill-pattern":new pa(B.paint_fill["fill-pattern"])})},get layout(){return Fy=Fy||new kr({"fill-sort-key":new Bt(B.layout_fill["fill-sort-key"])})}};class o2 extends Sn{constructor(s){super(s,s2)}recalculate(s,h){super.recalculate(s,h);const f=this.paint._values["fill-outline-color"];f.value.kind==="constant"&&f.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(s){return new ig(s)}queryRadius(){return Rd(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:s,geometry:h,transform:f,pixelsToTileUnits:m}){return Bl(kd(s,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-f.bearingInRadians,m),h)}isTileClipped(){return!0}}const a2=zi([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),l2=zi([{name:"a_centroid",components:2,type:"Int16"}],4),{members:c2}=a2;var rg,Ny,ng,zy,sg,Uy,Vy,Fd={};function jy(){if(Ny)return rg;Ny=1;var u=I();function s(m,v,b,S,P){this.properties={},this.extent=b,this.type=0,this._pbf=m,this._geometry=-1,this._keys=S,this._values=P,m.readFields(h,this,v)}function h(m,v,b){m==1?v.id=b.readVarint():m==2?(function(S,P){for(var M=S.readVarint()+S.pos;S.pos<M;){var k=P._keys[S.readVarint()],O=P._values[S.readVarint()];P.properties[k]=O}})(b,v):m==3?v.type=b.readVarint():m==4&&(v._geometry=b.pos)}function f(m){for(var v,b,S=0,P=0,M=m.length,k=M-1;P<M;k=P++)S+=((b=m[k]).x-(v=m[P]).x)*(v.y+b.y);return S}return rg=s,s.types=["Unknown","Point","LineString","Polygon"],s.prototype.loadGeometry=function(){var m=this._pbf;m.pos=this._geometry;for(var v,b=m.readVarint()+m.pos,S=1,P=0,M=0,k=0,O=[];m.pos<b;){if(P<=0){var U=m.readVarint();S=7&U,P=U>>3}if(P--,S===1||S===2)M+=m.readSVarint(),k+=m.readSVarint(),S===1&&(v&&O.push(v),v=[]),v.push(new u(M,k));else{if(S!==7)throw new Error("unknown command "+S);v&&v.push(v[0].clone())}}return v&&O.push(v),O},s.prototype.bbox=function(){var m=this._pbf;m.pos=this._geometry;for(var v=m.readVarint()+m.pos,b=1,S=0,P=0,M=0,k=1/0,O=-1/0,U=1/0,j=-1/0;m.pos<v;){if(S<=0){var $=m.readVarint();b=7&$,S=$>>3}if(S--,b===1||b===2)(P+=m.readSVarint())<k&&(k=P),P>O&&(O=P),(M+=m.readSVarint())<U&&(U=M),M>j&&(j=M);else if(b!==7)throw new Error("unknown command "+b)}return[k,U,O,j]},s.prototype.toGeoJSON=function(m,v,b){var S,P,M=this.extent*Math.pow(2,b),k=this.extent*m,O=this.extent*v,U=this.loadGeometry(),j=s.types[this.type];function $(ce){for(var Me=0;Me<ce.length;Me++){var pe=ce[Me];ce[Me]=[360*(pe.x+k)/M-180,360/Math.PI*Math.atan(Math.exp((180-360*(pe.y+O)/M)*Math.PI/180))-90]}}switch(this.type){case 1:var Z=[];for(S=0;S<U.length;S++)Z[S]=U[S][0];$(U=Z);break;case 2:for(S=0;S<U.length;S++)$(U[S]);break;case 3:for(U=(function(ce){var Me=ce.length;if(Me<=1)return[ce];for(var pe,V,Q=[],me=0;me<Me;me++){var We=f(ce[me]);We!==0&&(V===void 0&&(V=We<0),V===We<0?(pe&&Q.push(pe),pe=[ce[me]]):pe.push(ce[me]))}return pe&&Q.push(pe),Q})(U),S=0;S<U.length;S++)for(P=0;P<U[S].length;P++)$(U[S][P])}U.length===1?U=U[0]:j="Multi"+j;var te={type:"Feature",geometry:{type:j,coordinates:U},properties:this.properties};return"id"in this&&(te.id=this.id),te},rg}function $y(){if(zy)return ng;zy=1;var u=jy();function s(f,m){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=f,this._keys=[],this._values=[],this._features=[],f.readFields(h,this,m),this.length=this._features.length}function h(f,m,v){f===15?m.version=v.readVarint():f===1?m.name=v.readString():f===5?m.extent=v.readVarint():f===2?m._features.push(v.pos):f===3?m._keys.push(v.readString()):f===4&&m._values.push((function(b){for(var S=null,P=b.readVarint()+b.pos;b.pos<P;){var M=b.readVarint()>>3;S=M===1?b.readString():M===2?b.readFloat():M===3?b.readDouble():M===4?b.readVarint64():M===5?b.readVarint():M===6?b.readSVarint():M===7?b.readBoolean():null}return S})(v))}return ng=s,s.prototype.feature=function(f){if(f<0||f>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[f];var m=this._pbf.readVarint()+this._pbf.pos;return new u(this._pbf,m,this.extent,this._keys,this._values)},ng}function Wy(){return Vy||(Vy=1,Fd.VectorTile=(function(){if(Uy)return sg;Uy=1;var u=$y();function s(h,f,m){if(h===3){var v=new u(m,m.readVarint()+m.pos);v.length&&(f[v.name]=v)}}return sg=function(h,f){this.layers=h.readFields(s,{},f)},sg})(),Fd.VectorTileFeature=jy(),Fd.VectorTileLayer=$y()),Fd}var Fu=y(Wy());const u2=Fu.VectorTileFeature.types,og=Math.pow(2,13);function Bu(u,s,h,f,m,v,b,S){u.emplaceBack(s,h,2*Math.floor(f*og)+b,m*og*2,v*og*2,Math.round(S))}class ag{constructor(s){this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map((h=>h.id)),this.index=s.index,this.hasPattern=!1,this.layoutVertexArray=new ve,this.centroidVertexArray=new le,this.indexArray=new xt,this.programConfigurations=new Xs(s.layers,s.zoom),this.segments=new Rt,this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id))}populate(s,h,f){this.features=[],this.hasPattern=Jp("fill-extrusion",this.layers,h);for(const{feature:m,id:v,index:b,sourceLayerIndex:S}of s){const P=this.layers[0]._featureFilter.needGeometry,M=jr(m,P);if(!this.layers[0]._featureFilter.filter(new Ci(this.zoom),M,f))continue;const k={id:v,sourceLayerIndex:S,index:b,geometry:P?M.geometry:Gs(m),properties:m.properties,type:m.type,patterns:{}};this.hasPattern?this.features.push(Qp("fill-extrusion",this.layers,k,this.zoom,h)):this.addFeature(k,k.geometry,b,f,{},h.subdivisionGranularity),h.featureIndex.insert(m,k.geometry,b,S,this.index,!0)}}addFeatures(s,h,f){for(const m of this.features){const{geometry:v}=m;this.addFeature(m,v,m.index,h,f,s.subdivisionGranularity)}}update(s,h,f){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,h,this.stateDependentLayers,f)}isEmpty(){return this.layoutVertexArray.length===0&&this.centroidVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,c2),this.centroidVertexBuffer=s.createVertexBuffer(this.centroidVertexArray,l2.members,!0),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(s,h,f,m,v,b){for(const S of nl(h,500)){const P={x:0,y:0,sampleCount:0},M=this.layoutVertexArray.length;this.processPolygon(P,m,s,S,b);const k=this.layoutVertexArray.length-M,O=Math.floor(P.x/P.sampleCount),U=Math.floor(P.y/P.sampleCount);for(let j=0;j<k;j++)this.centroidVertexArray.emplaceBack(O,U)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,f,v,m)}processPolygon(s,h,f,m,v){if(m.length<1||Hy(m[0]))return;for(const O of m)O.length!==0&&h2(s,O);const b={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},S=v.fill.getGranularityForZoomLevel(h.z),P=u2[f.type]==="Polygon";for(const O of m){if(O.length===0||Hy(O))continue;const U=ya(O,S,P);this._generateSideFaces(U,b)}if(!P)return;const M=Oy(m,h,S,!1),k=this.layoutVertexArray;Ly(((O,U)=>{Bu(k,O,U,0,0,1,1,0)}),this.segments,this.layoutVertexArray,this.indexArray,M.verticesFlattened,M.indicesTriangles)}_generateSideFaces(s,h){let f=0;for(let m=1;m<s.length;m++){const v=s[m],b=s[m-1];if(d2(v,b))continue;h.segment.vertexLength+4>Rt.MAX_VERTEX_ARRAY_LENGTH&&(h.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const S=v.sub(b)._perp()._unit(),P=b.dist(v);f+P>32768&&(f=0),Bu(this.layoutVertexArray,v.x,v.y,S.x,S.y,0,0,f),Bu(this.layoutVertexArray,v.x,v.y,S.x,S.y,0,1,f),f+=P,Bu(this.layoutVertexArray,b.x,b.y,S.x,S.y,0,0,f),Bu(this.layoutVertexArray,b.x,b.y,S.x,S.y,0,1,f);const M=h.segment.vertexLength;this.indexArray.emplaceBack(M,M+2,M+1),this.indexArray.emplaceBack(M+1,M+2,M+3),h.segment.vertexLength+=4,h.segment.primitiveLength+=2}}}function h2(u,s){for(let h=0;h<s.length;h++){const f=s[h];h===s.length-1&&s[0].x===f.x&&s[0].y===f.y||(u.x+=f.x,u.y+=f.y,u.sampleCount++)}}function d2(u,s){return u.x===s.x&&(u.x<0||u.x>W)||u.y===s.y&&(u.y<0||u.y>W)}function Hy(u){return u.every((s=>s.x<0))||u.every((s=>s.x>W))||u.every((s=>s.y<0))||u.every((s=>s.y>W))}let Zy;wt("FillExtrusionBucket",ag,{omit:["layers","features"]});var f2={get paint(){return Zy=Zy||new kr({"fill-extrusion-opacity":new Mt(B["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Bt(B["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Mt(B["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Mt(B["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new pa(B["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Bt(B["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Bt(B["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Mt(B["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class p2 extends Sn{constructor(s){super(s,f2)}createBucket(s){return new ag(s)}queryRadius(){return Rd(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:s,feature:h,featureState:f,geometry:m,transform:v,pixelsToTileUnits:b,pixelPosMatrix:S}){const P=kd(s,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-v.bearingInRadians,b),M=this.paint.get("fill-extrusion-height").evaluate(h,f),k=this.paint.get("fill-extrusion-base").evaluate(h,f),O=(function(j,$,Z){const te=[];for(const ce of j){const Me=[ce.x,ce.y,0,1];ye(Me,Me,$),te.push(new X(Me[0]/Me[3],Me[1]/Me[3]))}return te})(P,S),U=(function(j,$,Z,te){const ce=[],Me=[],pe=te[8]*$,V=te[9]*$,Q=te[10]*$,me=te[11]*$,We=te[8]*Z,lt=te[9]*Z,Ye=te[10]*Z,Qe=te[11]*Z;for(const ft of j){const ut=[],gt=[];for(const st of ft){const St=st.x,Ft=st.y,Ot=te[0]*St+te[4]*Ft+te[12],Ct=te[1]*St+te[5]*Ft+te[13],Kt=te[2]*St+te[6]*Ft+te[14],Li=te[3]*St+te[7]*Ft+te[15],Ji=Kt+Q,Tr=Li+me,fn=Ot+We,Wr=Ct+lt,pr=Kt+Ye,Ri=Li+Qe,nr=new X((Ot+pe)/Tr,(Ct+V)/Tr);nr.z=Ji/Tr,ut.push(nr);const gr=new X(fn/Ri,Wr/Ri);gr.z=pr/Ri,gt.push(gr)}ce.push(ut),Me.push(gt)}return[ce,Me]})(m,k,M,S);return(function(j,$,Z){let te=1/0;Bl(Z,$)&&(te=qy(Z,$[0]));for(let ce=0;ce<$.length;ce++){const Me=$[ce],pe=j[ce];for(let V=0;V<Me.length-1;V++){const Q=Me[V],me=[Q,Me[V+1],pe[V+1],pe[V],Q];Fl(Z,me)&&(te=Math.min(te,qy(Z,me)))}}return te!==1/0&&te})(U[0],U[1],O)}}function Nu(u,s){return u.x*s.x+u.y*s.y}function qy(u,s){if(u.length===1){let h=0;const f=s[h++];let m;for(;!m||f.equals(m);)if(m=s[h++],!m)return 1/0;for(;h<s.length;h++){const v=s[h],b=u[0],S=m.sub(f),P=v.sub(f),M=b.sub(f),k=Nu(S,S),O=Nu(S,P),U=Nu(P,P),j=Nu(M,S),$=Nu(M,P),Z=k*U-O*O,te=(U*j-O*$)/Z,ce=(k*$-O*j)/Z,Me=f.z*(1-te-ce)+m.z*te+v.z*ce;if(isFinite(Me))return Me}return 1/0}{let h=1/0;for(const f of s)h=Math.min(h,f.z);return h}}const g2=zi([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:m2}=g2,_2=zi([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:y2}=_2,x2=Fu.VectorTileFeature.types,v2=Math.cos(Math.PI/180*37.5),Xy=Math.pow(2,14)/.5;class lg{constructor(s){this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map((h=>h.id)),this.index=s.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((h=>{this.gradients[h.id]={}})),this.layoutVertexArray=new Pe,this.layoutVertexArray2=new Re,this.indexArray=new xt,this.programConfigurations=new Xs(s.layers,s.zoom),this.segments=new Rt,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((h=>h.isStateDependent())).map((h=>h.id))}populate(s,h,f){this.hasPattern=Jp("line",this.layers,h);const m=this.layers[0].layout.get("line-sort-key"),v=!m.isConstant(),b=[];for(const{feature:S,id:P,index:M,sourceLayerIndex:k}of s){const O=this.layers[0]._featureFilter.needGeometry,U=jr(S,O);if(!this.layers[0]._featureFilter.filter(new Ci(this.zoom),U,f))continue;const j=v?m.evaluate(U,{},f):void 0,$={id:P,properties:S.properties,type:S.type,sourceLayerIndex:k,index:M,geometry:O?U.geometry:Gs(S),patterns:{},sortKey:j};b.push($)}v&&b.sort(((S,P)=>S.sortKey-P.sortKey));for(const S of b){const{geometry:P,index:M,sourceLayerIndex:k}=S;if(this.hasPattern){const O=Qp("line",this.layers,S,this.zoom,h);this.patternFeatures.push(O)}else this.addFeature(S,P,M,f,{},h.subdivisionGranularity);h.featureIndex.insert(s[M].feature,P,M,k,this.index)}}update(s,h,f){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(s,h,this.stateDependentLayers,f)}addFeatures(s,h,f){for(const m of this.patternFeatures)this.addFeature(m,m.geometry,m.index,h,f,s.subdivisionGranularity)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(s){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=s.createVertexBuffer(this.layoutVertexArray2,y2)),this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,m2),this.indexBuffer=s.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(s),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(s){if(s.properties&&Object.prototype.hasOwnProperty.call(s.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(s.properties,"mapbox_clip_end"))return{start:+s.properties.mapbox_clip_start,end:+s.properties.mapbox_clip_end}}addFeature(s,h,f,m,v,b){const S=this.layers[0].layout,P=S.get("line-join").evaluate(s,{}),M=S.get("line-cap"),k=S.get("line-miter-limit"),O=S.get("line-round-limit");this.lineClips=this.lineFeatureClips(s);for(const U of h)this.addLine(U,s,P,M,k,O,m,b);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,s,f,v,m)}addLine(s,h,f,m,v,b,S,P){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,s=ya(s,S?P.line.getGranularityForZoomLevel(S.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let pe=0;pe<s.length-1;pe++)this.totalDistance+=s[pe].dist(s[pe+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const M=x2[h.type]==="Polygon";let k=s.length;for(;k>=2&&s[k-1].equals(s[k-2]);)k--;let O=0;for(;O<k-1&&s[O].equals(s[O+1]);)O++;if(k<(M?3:2))return;f==="bevel"&&(v=1.05);const U=this.overscaling<=16?15*W/(512*this.overscaling):0,j=this.segments.prepareSegment(10*k,this.layoutVertexArray,this.indexArray);let $,Z,te,ce,Me;this.e1=this.e2=-1,M&&($=s[k-2],Me=s[O].sub($)._unit()._perp());for(let pe=O;pe<k;pe++){if(te=pe===k-1?M?s[O+1]:void 0:s[pe+1],te&&s[pe].equals(te))continue;Me&&(ce=Me),$&&(Z=$),$=s[pe],Me=te?te.sub($)._unit()._perp():ce,ce=ce||Me;let V=ce.add(Me);V.x===0&&V.y===0||V._unit();const Q=ce.x*Me.x+ce.y*Me.y,me=V.x*Me.x+V.y*Me.y,We=me!==0?1/me:1/0,lt=2*Math.sqrt(2-2*me),Ye=me<v2&&Z&&te,Qe=ce.x*Me.y-ce.y*Me.x>0;if(Ye&&pe>O){const gt=$.dist(Z);if(gt>2*U){const st=$.sub($.sub(Z)._mult(U/gt)._round());this.updateDistance(Z,st),this.addCurrentVertex(st,ce,0,0,j),Z=st}}const ft=Z&&te;let ut=ft?f:M?"butt":m;if(ft&&ut==="round"&&(We<b?ut="miter":We<=2&&(ut="fakeround")),ut==="miter"&&We>v&&(ut="bevel"),ut==="bevel"&&(We>2&&(ut="flipbevel"),We<v&&(ut="miter")),Z&&this.updateDistance(Z,$),ut==="miter")V._mult(We),this.addCurrentVertex($,V,0,0,j);else if(ut==="flipbevel"){if(We>100)V=Me.mult(-1);else{const gt=We*ce.add(Me).mag()/ce.sub(Me).mag();V._perp()._mult(gt*(Qe?-1:1))}this.addCurrentVertex($,V,0,0,j),this.addCurrentVertex($,V.mult(-1),0,0,j)}else if(ut==="bevel"||ut==="fakeround"){const gt=-Math.sqrt(We*We-1),st=Qe?gt:0,St=Qe?0:gt;if(Z&&this.addCurrentVertex($,ce,st,St,j),ut==="fakeround"){const Ft=Math.round(180*lt/Math.PI/20);for(let Ot=1;Ot<Ft;Ot++){let Ct=Ot/Ft;if(Ct!==.5){const Li=Ct-.5;Ct+=Ct*Li*(Ct-1)*((1.0904+Q*(Q*(3.55645-1.43519*Q)-3.2452))*Li*Li+(.848013+Q*(.215638*Q-1.06021)))}const Kt=Me.sub(ce)._mult(Ct)._add(ce)._unit()._mult(Qe?-1:1);this.addHalfVertex($,Kt.x,Kt.y,!1,Qe,0,j)}}te&&this.addCurrentVertex($,Me,-st,-St,j)}else if(ut==="butt")this.addCurrentVertex($,V,0,0,j);else if(ut==="square"){const gt=Z?1:-1;this.addCurrentVertex($,V,gt,gt,j)}else ut==="round"&&(Z&&(this.addCurrentVertex($,ce,0,0,j),this.addCurrentVertex($,ce,1,1,j,!0)),te&&(this.addCurrentVertex($,Me,-1,-1,j,!0),this.addCurrentVertex($,Me,0,0,j)));if(Ye&&pe<k-1){const gt=$.dist(te);if(gt>2*U){const st=$.add(te.sub($)._mult(U/gt)._round());this.updateDistance($,st),this.addCurrentVertex(st,Me,0,0,j),$=st}}}}addCurrentVertex(s,h,f,m,v,b=!1){const S=h.y*m-h.x,P=-h.y-h.x*m;this.addHalfVertex(s,h.x+h.y*f,h.y-h.x*f,b,!1,f,v),this.addHalfVertex(s,S,P,b,!0,-m,v),this.distance>Xy/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(s,h,f,m,v,b))}addHalfVertex({x:s,y:h},f,m,v,b,S,P){const M=.5*(this.lineClips?this.scaledDistance*(Xy-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((s<<1)+(v?1:0),(h<<1)+(b?1:0),Math.round(63*f)+128,Math.round(63*m)+128,1+(S===0?0:S<0?-1:1)|(63&M)<<2,M>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const k=P.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,k,this.e2),P.primitiveLength++),b?this.e2=k:this.e1=k}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(s,h){this.distance+=s.dist(h),this.updateScaledDistance()}}let Gy,Yy;wt("LineBucket",lg,{omit:["layers","patternFeatures"]});var Ky={get paint(){return Yy=Yy||new kr({"line-opacity":new Bt(B.paint_line["line-opacity"]),"line-color":new Bt(B.paint_line["line-color"]),"line-translate":new Mt(B.paint_line["line-translate"]),"line-translate-anchor":new Mt(B.paint_line["line-translate-anchor"]),"line-width":new Bt(B.paint_line["line-width"]),"line-gap-width":new Bt(B.paint_line["line-gap-width"]),"line-offset":new Bt(B.paint_line["line-offset"]),"line-blur":new Bt(B.paint_line["line-blur"]),"line-dasharray":new Pl(B.paint_line["line-dasharray"]),"line-pattern":new pa(B.paint_line["line-pattern"]),"line-gradient":new bu(B.paint_line["line-gradient"])})},get layout(){return Gy=Gy||new kr({"line-cap":new Mt(B.layout_line["line-cap"]),"line-join":new Bt(B.layout_line["line-join"]),"line-miter-limit":new Mt(B.layout_line["line-miter-limit"]),"line-round-limit":new Mt(B.layout_line["line-round-limit"]),"line-sort-key":new Bt(B.layout_line["line-sort-key"])})}};class b2 extends Bt{possiblyEvaluate(s,h){return h=new Ci(Math.floor(h.zoom),{now:h.now,fadeDuration:h.fadeDuration,zoomHistory:h.zoomHistory,transition:h.transition}),super.possiblyEvaluate(s,h)}evaluate(s,h,f,m){return h=_t({},h,{zoom:Math.floor(h.zoom)}),super.evaluate(s,h,f,m)}}let Bd;class w2 extends Sn{constructor(s){super(s,Ky),this.gradientVersion=0,Bd||(Bd=new b2(Ky.paint.properties["line-width"].specification),Bd.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(s){if(s==="line-gradient"){const h=this.gradientExpression();this.stepInterpolant=!!(function(f){return f._styleExpression!==void 0})(h)&&h._styleExpression.expression instanceof go,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(s,h){super.recalculate(s,h),this.paint._values["line-floorwidth"]=Bd.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,s)}createBucket(s){return new lg(s)}queryRadius(s){const h=s,f=Jy(Cu("line-width",this,h),Cu("line-gap-width",this,h)),m=Cu("line-offset",this,h);return f/2+Math.abs(m)+Rd(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:s,feature:h,featureState:f,geometry:m,transform:v,pixelsToTileUnits:b}){const S=kd(s,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-v.bearingInRadians,b),P=b/2*Jy(this.paint.get("line-width").evaluate(h,f),this.paint.get("line-gap-width").evaluate(h,f)),M=this.paint.get("line-offset").evaluate(h,f);return M&&(m=(function(k,O){const U=[];for(let j=0;j<k.length;j++){const $=k[j],Z=[];for(let te=0;te<$.length;te++){const ce=$[te-1],Me=$[te],pe=$[te+1],V=te===0?new X(0,0):Me.sub(ce)._unit()._perp(),Q=te===$.length-1?new X(0,0):pe.sub(Me)._unit()._perp(),me=V._add(Q)._unit(),We=me.x*Q.x+me.y*Q.y;We!==0&&me._mult(1/We),Z.push(me._mult(O)._add(Me))}U.push(Z)}return U})(m,M*b)),(function(k,O,U){for(let j=0;j<O.length;j++){const $=O[j];if(k.length>=3){for(let Z=0;Z<$.length;Z++)if(Nl(k,$[Z]))return!0}if(BT(k,$,U))return!0}return!1})(S,m,P)}isTileClipped(){return!0}}function Jy(u,s){return s>0?s+2*u:u}const T2=zi([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),S2=zi([{name:"a_projected_pos",components:3,type:"Float32"}],4);zi([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const E2=zi([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);zi([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Qy=zi([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),A2=zi([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function P2(u,s,h){return u.sections.forEach((f=>{f.text=(function(m,v,b){const S=v.layout.get("text-transform").evaluate(b,{});return S==="uppercase"?m=m.toLocaleUpperCase():S==="lowercase"&&(m=m.toLocaleLowerCase()),fs.applyArabicShaping&&(m=fs.applyArabicShaping(m)),m})(f.text,s,h)})),u}zi([{name:"triangle",components:3,type:"Uint16"}]),zi([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),zi([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),zi([{type:"Float32",name:"offsetX"}]),zi([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),zi([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const zu={"!":"ï¸","#":"ï¼",$:"ï¼","%":"ï¼","&":"ï¼","(":"ï¸µ",")":"ï¸¶","*":"ï¼","+":"ï¼",",":"ï¸","-":"ï¸²",".":"ã»","/":"ï¼",":":"ï¸",";":"ï¸","<":"ï¸¿","=":"ï¼",">":"ï¹","?":"ï¸","@":"ï¼ ","[":"ï¹","\\":"ï¼¼","]":"ï¹","^":"ï¼¾",_:"ï¸³","`":"ï½","{":"ï¸·","|":"â","}":"ï¸¸","~":"ï½","Â¢":"ï¿ ","Â£":"ï¿¡","Â¥":"ï¿¥","Â¦":"ï¿¤","Â¬":"ï¿¢","Â¯":"ï¿£","â":"ï¸²","â":"ï¸±","â":"ï¹","â":"ï¹","â":"ï¹","â":"ï¹","â¦":"ï¸","â§":"ã»","â©":"ï¿¦","ã":"ï¸","ã":"ï¸","ã":"ï¸¿","ã":"ï¹","ã":"ï¸½","ã":"ï¸¾","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¸»","ã":"ï¸¼","ã":"ï¸¹","ã":"ï¸º","ã":"ï¸","ã":"ï¸","ï¼":"ï¸","ï¼":"ï¸µ","ï¼":"ï¸¶","ï¼":"ï¸","ï¼":"ï¸²","ï¼":"ã»","ï¼":"ï¸","ï¼":"ï¸","ï¼":"ï¸¿","ï¼":"ï¹","ï¼":"ï¸","ï¼»":"ï¹","ï¼½":"ï¹","ï¼¿":"ï¸³","ï½":"ï¸·","ï½":"â","ï½":"ï¸¸","ï½":"ï¸µ","ï½ ":"ï¸¶","ï½¡":"ï¸","ï½¢":"ï¹","ï½£":"ï¹"};var ex,cg,tx,Ki=24,ug={};function C2(){return ex||(ex=1,ug.read=function(u,s,h,f,m){var v,b,S=8*m-f-1,P=(1<<S)-1,M=P>>1,k=-7,O=h?m-1:0,U=h?-1:1,j=u[s+O];for(O+=U,v=j&(1<<-k)-1,j>>=-k,k+=S;k>0;v=256*v+u[s+O],O+=U,k-=8);for(b=v&(1<<-k)-1,v>>=-k,k+=f;k>0;b=256*b+u[s+O],O+=U,k-=8);if(v===0)v=1-M;else{if(v===P)return b?NaN:1/0*(j?-1:1);b+=Math.pow(2,f),v-=M}return(j?-1:1)*b*Math.pow(2,v-f)},ug.write=function(u,s,h,f,m,v){var b,S,P,M=8*v-m-1,k=(1<<M)-1,O=k>>1,U=m===23?Math.pow(2,-24)-Math.pow(2,-77):0,j=f?0:v-1,$=f?1:-1,Z=s<0||s===0&&1/s<0?1:0;for(s=Math.abs(s),isNaN(s)||s===1/0?(S=isNaN(s)?1:0,b=k):(b=Math.floor(Math.log(s)/Math.LN2),s*(P=Math.pow(2,-b))<1&&(b--,P*=2),(s+=b+O>=1?U/P:U*Math.pow(2,1-O))*P>=2&&(b++,P/=2),b+O>=k?(S=0,b=k):b+O>=1?(S=(s*P-1)*Math.pow(2,m),b+=O):(S=s*Math.pow(2,O-1)*Math.pow(2,m),b=0));m>=8;u[h+j]=255&S,j+=$,S/=256,m-=8);for(b=b<<m|S,M+=m;M>0;u[h+j]=255&b,j+=$,b/=256,M-=8);u[h+j-$]|=128*Z}),ug}function ix(){if(tx)return cg;tx=1,cg=s;var u=C2();function s(V){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(V)?V:new Uint8Array(V||0),this.pos=0,this.type=0,this.length=this.buf.length}s.Varint=0,s.Fixed64=1,s.Bytes=2,s.Fixed32=5;var h=4294967296,f=1/h,m=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");function v(V){return V.type===s.Bytes?V.readVarint()+V.pos:V.pos+1}function b(V,Q,me){return me?4294967296*Q+(V>>>0):4294967296*(Q>>>0)+(V>>>0)}function S(V,Q,me){var We=Q<=16383?1:Q<=2097151?2:Q<=268435455?3:Math.floor(Math.log(Q)/(7*Math.LN2));me.realloc(We);for(var lt=me.pos-1;lt>=V;lt--)me.buf[lt+We]=me.buf[lt]}function P(V,Q){for(var me=0;me<V.length;me++)Q.writeVarint(V[me])}function M(V,Q){for(var me=0;me<V.length;me++)Q.writeSVarint(V[me])}function k(V,Q){for(var me=0;me<V.length;me++)Q.writeFloat(V[me])}function O(V,Q){for(var me=0;me<V.length;me++)Q.writeDouble(V[me])}function U(V,Q){for(var me=0;me<V.length;me++)Q.writeBoolean(V[me])}function j(V,Q){for(var me=0;me<V.length;me++)Q.writeFixed32(V[me])}function $(V,Q){for(var me=0;me<V.length;me++)Q.writeSFixed32(V[me])}function Z(V,Q){for(var me=0;me<V.length;me++)Q.writeFixed64(V[me])}function te(V,Q){for(var me=0;me<V.length;me++)Q.writeSFixed64(V[me])}function ce(V,Q){return(V[Q]|V[Q+1]<<8|V[Q+2]<<16)+16777216*V[Q+3]}function Me(V,Q,me){V[me]=Q,V[me+1]=Q>>>8,V[me+2]=Q>>>16,V[me+3]=Q>>>24}function pe(V,Q){return(V[Q]|V[Q+1]<<8|V[Q+2]<<16)+(V[Q+3]<<24)}return s.prototype={destroy:function(){this.buf=null},readFields:function(V,Q,me){for(me=me||this.length;this.pos<me;){var We=this.readVarint(),lt=We>>3,Ye=this.pos;this.type=7&We,V(lt,Q,this),this.pos===Ye&&this.skip(We)}return Q},readMessage:function(V,Q){return this.readFields(V,Q,this.readVarint()+this.pos)},readFixed32:function(){var V=ce(this.buf,this.pos);return this.pos+=4,V},readSFixed32:function(){var V=pe(this.buf,this.pos);return this.pos+=4,V},readFixed64:function(){var V=ce(this.buf,this.pos)+ce(this.buf,this.pos+4)*h;return this.pos+=8,V},readSFixed64:function(){var V=ce(this.buf,this.pos)+pe(this.buf,this.pos+4)*h;return this.pos+=8,V},readFloat:function(){var V=u.read(this.buf,this.pos,!0,23,4);return this.pos+=4,V},readDouble:function(){var V=u.read(this.buf,this.pos,!0,52,8);return this.pos+=8,V},readVarint:function(V){var Q,me,We=this.buf;return Q=127&(me=We[this.pos++]),me<128?Q:(Q|=(127&(me=We[this.pos++]))<<7,me<128?Q:(Q|=(127&(me=We[this.pos++]))<<14,me<128?Q:(Q|=(127&(me=We[this.pos++]))<<21,me<128?Q:(function(lt,Ye,Qe){var ft,ut,gt=Qe.buf;if(ft=(112&(ut=gt[Qe.pos++]))>>4,ut<128||(ft|=(127&(ut=gt[Qe.pos++]))<<3,ut<128)||(ft|=(127&(ut=gt[Qe.pos++]))<<10,ut<128)||(ft|=(127&(ut=gt[Qe.pos++]))<<17,ut<128)||(ft|=(127&(ut=gt[Qe.pos++]))<<24,ut<128)||(ft|=(1&(ut=gt[Qe.pos++]))<<31,ut<128))return b(lt,ft,Ye);throw new Error("Expected varint not more than 10 bytes")})(Q|=(15&(me=We[this.pos]))<<28,V,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var V=this.readVarint();return V%2==1?(V+1)/-2:V/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var V=this.readVarint()+this.pos,Q=this.pos;return this.pos=V,V-Q>=12&&m?(function(me,We,lt){return m.decode(me.subarray(We,lt))})(this.buf,Q,V):(function(me,We,lt){for(var Ye="",Qe=We;Qe<lt;){var ft,ut,gt,st=me[Qe],St=null,Ft=st>239?4:st>223?3:st>191?2:1;if(Qe+Ft>lt)break;Ft===1?st<128&&(St=st):Ft===2?(192&(ft=me[Qe+1]))==128&&(St=(31&st)<<6|63&ft)<=127&&(St=null):Ft===3?(ut=me[Qe+2],(192&(ft=me[Qe+1]))==128&&(192&ut)==128&&((St=(15&st)<<12|(63&ft)<<6|63&ut)<=2047||St>=55296&&St<=57343)&&(St=null)):Ft===4&&(ut=me[Qe+2],gt=me[Qe+3],(192&(ft=me[Qe+1]))==128&&(192&ut)==128&&(192&gt)==128&&((St=(15&st)<<18|(63&ft)<<12|(63&ut)<<6|63&gt)<=65535||St>=1114112)&&(St=null)),St===null?(St=65533,Ft=1):St>65535&&(St-=65536,Ye+=String.fromCharCode(St>>>10&1023|55296),St=56320|1023&St),Ye+=String.fromCharCode(St),Qe+=Ft}return Ye})(this.buf,Q,V)},readBytes:function(){var V=this.readVarint()+this.pos,Q=this.buf.subarray(this.pos,V);return this.pos=V,Q},readPackedVarint:function(V,Q){if(this.type!==s.Bytes)return V.push(this.readVarint(Q));var me=v(this);for(V=V||[];this.pos<me;)V.push(this.readVarint(Q));return V},readPackedSVarint:function(V){if(this.type!==s.Bytes)return V.push(this.readSVarint());var Q=v(this);for(V=V||[];this.pos<Q;)V.push(this.readSVarint());return V},readPackedBoolean:function(V){if(this.type!==s.Bytes)return V.push(this.readBoolean());var Q=v(this);for(V=V||[];this.pos<Q;)V.push(this.readBoolean());return V},readPackedFloat:function(V){if(this.type!==s.Bytes)return V.push(this.readFloat());var Q=v(this);for(V=V||[];this.pos<Q;)V.push(this.readFloat());return V},readPackedDouble:function(V){if(this.type!==s.Bytes)return V.push(this.readDouble());var Q=v(this);for(V=V||[];this.pos<Q;)V.push(this.readDouble());return V},readPackedFixed32:function(V){if(this.type!==s.Bytes)return V.push(this.readFixed32());var Q=v(this);for(V=V||[];this.pos<Q;)V.push(this.readFixed32());return V},readPackedSFixed32:function(V){if(this.type!==s.Bytes)return V.push(this.readSFixed32());var Q=v(this);for(V=V||[];this.pos<Q;)V.push(this.readSFixed32());return V},readPackedFixed64:function(V){if(this.type!==s.Bytes)return V.push(this.readFixed64());var Q=v(this);for(V=V||[];this.pos<Q;)V.push(this.readFixed64());return V},readPackedSFixed64:function(V){if(this.type!==s.Bytes)return V.push(this.readSFixed64());var Q=v(this);for(V=V||[];this.pos<Q;)V.push(this.readSFixed64());return V},skip:function(V){var Q=7&V;if(Q===s.Varint)for(;this.buf[this.pos++]>127;);else if(Q===s.Bytes)this.pos=this.readVarint()+this.pos;else if(Q===s.Fixed32)this.pos+=4;else{if(Q!==s.Fixed64)throw new Error("Unimplemented type: "+Q);this.pos+=8}},writeTag:function(V,Q){this.writeVarint(V<<3|Q)},realloc:function(V){for(var Q=this.length||16;Q<this.pos+V;)Q*=2;if(Q!==this.length){var me=new Uint8Array(Q);me.set(this.buf),this.buf=me,this.length=Q}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(V){this.realloc(4),Me(this.buf,V,this.pos),this.pos+=4},writeSFixed32:function(V){this.realloc(4),Me(this.buf,V,this.pos),this.pos+=4},writeFixed64:function(V){this.realloc(8),Me(this.buf,-1&V,this.pos),Me(this.buf,Math.floor(V*f),this.pos+4),this.pos+=8},writeSFixed64:function(V){this.realloc(8),Me(this.buf,-1&V,this.pos),Me(this.buf,Math.floor(V*f),this.pos+4),this.pos+=8},writeVarint:function(V){(V=+V||0)>268435455||V<0?(function(Q,me){var We,lt;if(Q>=0?(We=Q%4294967296|0,lt=Q/4294967296|0):(lt=~(-Q/4294967296),4294967295^(We=~(-Q%4294967296))?We=We+1|0:(We=0,lt=lt+1|0)),Q>=18446744073709552e3||Q<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");me.realloc(10),(function(Ye,Qe,ft){ft.buf[ft.pos++]=127&Ye|128,Ye>>>=7,ft.buf[ft.pos++]=127&Ye|128,Ye>>>=7,ft.buf[ft.pos++]=127&Ye|128,Ye>>>=7,ft.buf[ft.pos++]=127&Ye|128,ft.buf[ft.pos]=127&(Ye>>>=7)})(We,0,me),(function(Ye,Qe){var ft=(7&Ye)<<4;Qe.buf[Qe.pos++]|=ft|((Ye>>>=3)?128:0),Ye&&(Qe.buf[Qe.pos++]=127&Ye|((Ye>>>=7)?128:0),Ye&&(Qe.buf[Qe.pos++]=127&Ye|((Ye>>>=7)?128:0),Ye&&(Qe.buf[Qe.pos++]=127&Ye|((Ye>>>=7)?128:0),Ye&&(Qe.buf[Qe.pos++]=127&Ye|((Ye>>>=7)?128:0),Ye&&(Qe.buf[Qe.pos++]=127&Ye)))))})(lt,me)})(V,this):(this.realloc(4),this.buf[this.pos++]=127&V|(V>127?128:0),V<=127||(this.buf[this.pos++]=127&(V>>>=7)|(V>127?128:0),V<=127||(this.buf[this.pos++]=127&(V>>>=7)|(V>127?128:0),V<=127||(this.buf[this.pos++]=V>>>7&127))))},writeSVarint:function(V){this.writeVarint(V<0?2*-V-1:2*V)},writeBoolean:function(V){this.writeVarint(!!V)},writeString:function(V){V=String(V),this.realloc(4*V.length),this.pos++;var Q=this.pos;this.pos=(function(We,lt,Ye){for(var Qe,ft,ut=0;ut<lt.length;ut++){if((Qe=lt.charCodeAt(ut))>55295&&Qe<57344){if(!ft){Qe>56319||ut+1===lt.length?(We[Ye++]=239,We[Ye++]=191,We[Ye++]=189):ft=Qe;continue}if(Qe<56320){We[Ye++]=239,We[Ye++]=191,We[Ye++]=189,ft=Qe;continue}Qe=ft-55296<<10|Qe-56320|65536,ft=null}else ft&&(We[Ye++]=239,We[Ye++]=191,We[Ye++]=189,ft=null);Qe<128?We[Ye++]=Qe:(Qe<2048?We[Ye++]=Qe>>6|192:(Qe<65536?We[Ye++]=Qe>>12|224:(We[Ye++]=Qe>>18|240,We[Ye++]=Qe>>12&63|128),We[Ye++]=Qe>>6&63|128),We[Ye++]=63&Qe|128)}return Ye})(this.buf,V,this.pos);var me=this.pos-Q;me>=128&&S(Q,me,this),this.pos=Q-1,this.writeVarint(me),this.pos+=me},writeFloat:function(V){this.realloc(4),u.write(this.buf,V,this.pos,!0,23,4),this.pos+=4},writeDouble:function(V){this.realloc(8),u.write(this.buf,V,this.pos,!0,52,8),this.pos+=8},writeBytes:function(V){var Q=V.length;this.writeVarint(Q),this.realloc(Q);for(var me=0;me<Q;me++)this.buf[this.pos++]=V[me]},writeRawMessage:function(V,Q){this.pos++;var me=this.pos;V(Q,this);var We=this.pos-me;We>=128&&S(me,We,this),this.pos=me-1,this.writeVarint(We),this.pos+=We},writeMessage:function(V,Q,me){this.writeTag(V,s.Bytes),this.writeRawMessage(Q,me)},writePackedVarint:function(V,Q){Q.length&&this.writeMessage(V,P,Q)},writePackedSVarint:function(V,Q){Q.length&&this.writeMessage(V,M,Q)},writePackedBoolean:function(V,Q){Q.length&&this.writeMessage(V,U,Q)},writePackedFloat:function(V,Q){Q.length&&this.writeMessage(V,k,Q)},writePackedDouble:function(V,Q){Q.length&&this.writeMessage(V,O,Q)},writePackedFixed32:function(V,Q){Q.length&&this.writeMessage(V,j,Q)},writePackedSFixed32:function(V,Q){Q.length&&this.writeMessage(V,$,Q)},writePackedFixed64:function(V,Q){Q.length&&this.writeMessage(V,Z,Q)},writePackedSFixed64:function(V,Q){Q.length&&this.writeMessage(V,te,Q)},writeBytesField:function(V,Q){this.writeTag(V,s.Bytes),this.writeBytes(Q)},writeFixed32Field:function(V,Q){this.writeTag(V,s.Fixed32),this.writeFixed32(Q)},writeSFixed32Field:function(V,Q){this.writeTag(V,s.Fixed32),this.writeSFixed32(Q)},writeFixed64Field:function(V,Q){this.writeTag(V,s.Fixed64),this.writeFixed64(Q)},writeSFixed64Field:function(V,Q){this.writeTag(V,s.Fixed64),this.writeSFixed64(Q)},writeVarintField:function(V,Q){this.writeTag(V,s.Varint),this.writeVarint(Q)},writeSVarintField:function(V,Q){this.writeTag(V,s.Varint),this.writeSVarint(Q)},writeStringField:function(V,Q){this.writeTag(V,s.Bytes),this.writeString(Q)},writeFloatField:function(V,Q){this.writeTag(V,s.Fixed32),this.writeFloat(Q)},writeDoubleField:function(V,Q){this.writeTag(V,s.Fixed64),this.writeDouble(Q)},writeBooleanField:function(V,Q){this.writeVarintField(V,!!Q)}},cg}var hg=y(ix());const dg=3;function I2(u,s,h){u===1&&h.readMessage(M2,s)}function M2(u,s,h){if(u===3){const{id:f,bitmap:m,width:v,height:b,left:S,top:P,advance:M}=h.readMessage(R2,{});s.push({id:f,bitmap:new Iu({width:v+2*dg,height:b+2*dg},m),metrics:{width:v,height:b,left:S,top:P,advance:M}})}}function R2(u,s,h){u===1?s.id=h.readVarint():u===2?s.bitmap=h.readBytes():u===3?s.width=h.readVarint():u===4?s.height=h.readVarint():u===5?s.left=h.readSVarint():u===6?s.top=h.readSVarint():u===7&&(s.advance=h.readVarint())}const k2=dg;function rx(u){let s=0,h=0;for(const b of u)s+=b.w*b.h,h=Math.max(h,b.w);u.sort(((b,S)=>S.h-b.h));const f=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(s/.95)),h),h:1/0}];let m=0,v=0;for(const b of u)for(let S=f.length-1;S>=0;S--){const P=f[S];if(!(b.w>P.w||b.h>P.h)){if(b.x=P.x,b.y=P.y,v=Math.max(v,b.y+b.h),m=Math.max(m,b.x+b.w),b.w===P.w&&b.h===P.h){const M=f.pop();S<f.length&&(f[S]=M)}else b.h===P.h?(P.x+=b.w,P.w-=b.w):b.w===P.w?(P.y+=b.h,P.h-=b.h):(f.push({x:P.x+b.w,y:P.y,w:P.w-b.w,h:b.h}),P.y+=b.h,P.h-=b.h);break}}return{w:m,h:v,fill:s/(m*v)||0}}const $r=1;class fg{constructor(s,{pixelRatio:h,version:f,stretchX:m,stretchY:v,content:b,textFitWidth:S,textFitHeight:P}){this.paddedRect=s,this.pixelRatio=h,this.stretchX=m,this.stretchY=v,this.content=b,this.version=f,this.textFitWidth=S,this.textFitHeight=P}get tl(){return[this.paddedRect.x+$r,this.paddedRect.y+$r]}get br(){return[this.paddedRect.x+this.paddedRect.w-$r,this.paddedRect.y+this.paddedRect.h-$r]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*$r)/this.pixelRatio,(this.paddedRect.h-2*$r)/this.pixelRatio]}}class nx{constructor(s,h){const f={},m={};this.haveRenderCallbacks=[];const v=[];this.addImages(s,f,v),this.addImages(h,m,v);const{w:b,h:S}=rx(v),P=new hn({width:b||1,height:S||1});for(const M in s){const k=s[M],O=f[M].paddedRect;hn.copy(k.data,P,{x:0,y:0},{x:O.x+$r,y:O.y+$r},k.data)}for(const M in h){const k=h[M],O=m[M].paddedRect,U=O.x+$r,j=O.y+$r,$=k.data.width,Z=k.data.height;hn.copy(k.data,P,{x:0,y:0},{x:U,y:j},k.data),hn.copy(k.data,P,{x:0,y:Z-1},{x:U,y:j-1},{width:$,height:1}),hn.copy(k.data,P,{x:0,y:0},{x:U,y:j+Z},{width:$,height:1}),hn.copy(k.data,P,{x:$-1,y:0},{x:U-1,y:j},{width:1,height:Z}),hn.copy(k.data,P,{x:0,y:0},{x:U+$,y:j},{width:1,height:Z})}this.image=P,this.iconPositions=f,this.patternPositions=m}addImages(s,h,f){for(const m in s){const v=s[m],b={x:0,y:0,w:v.data.width+2*$r,h:v.data.height+2*$r};f.push(b),h[m]=new fg(b,v),v.hasRenderCallback&&this.haveRenderCallbacks.push(m)}}patchUpdatedImages(s,h){s.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const f in s.updatedImages)this.patchUpdatedImage(this.iconPositions[f],s.getImage(f),h),this.patchUpdatedImage(this.patternPositions[f],s.getImage(f),h)}patchUpdatedImage(s,h,f){if(!s||!h||s.version===h.version)return;s.version=h.version;const[m,v]=s.tl;f.update(h.data,void 0,{x:m,y:v})}}var Io;wt("ImagePosition",fg),wt("ImageAtlas",nx),d.ag=void 0,(Io=d.ag||(d.ag={}))[Io.none=0]="none",Io[Io.horizontal=1]="horizontal",Io[Io.vertical=2]="vertical",Io[Io.horizontalOnly=3]="horizontalOnly";const Nd=-17;class Uu{constructor(){this.scale=1,this.fontStack="",this.imageName=null,this.verticalAlign="bottom"}static forText(s,h,f){const m=new Uu;return m.scale=s||1,m.fontStack=h,m.verticalAlign=f||"bottom",m}static forImage(s,h){const f=new Uu;return f.imageName=s,f.verticalAlign=h||"bottom",f}}class jl{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(s,h){const f=new jl;for(let m=0;m<s.sections.length;m++){const v=s.sections[m];v.image?f.addImageSection(v):f.addTextSection(v,h)}return f}length(){return this.text.length}getSection(s){return this.sections[this.sectionIndex[s]]}getSectionIndex(s){return this.sectionIndex[s]}getCharCode(s){return this.text.charCodeAt(s)}verticalizePunctuation(){this.text=(function(s){let h="";for(let f=0;f<s.length;f++){const m=s.charCodeAt(f+1)||null,v=s.charCodeAt(f-1)||null;h+=m&&_u(m)&&!zu[s[f+1]]||v&&_u(v)&&!zu[s[f-1]]||!zu[s[f]]?s[f]:zu[s[f]]}return h})(this.text)}trim(){let s=0;for(let f=0;f<this.text.length&&Ud[this.text.charCodeAt(f)];f++)s++;let h=this.text.length;for(let f=this.text.length-1;f>=0&&f>=s&&Ud[this.text.charCodeAt(f)];f--)h--;this.text=this.text.substring(s,h),this.sectionIndex=this.sectionIndex.slice(s,h)}substring(s,h){const f=new jl;return f.text=this.text.substring(s,h),f.sectionIndex=this.sectionIndex.slice(s,h),f.sections=this.sections,f}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((s,h)=>Math.max(s,this.sections[h].scale)),0)}getMaxImageSize(s){let h=0,f=0;for(let m=0;m<this.length();m++){const v=this.getSection(m);if(v.imageName){const b=s[v.imageName];if(!b)continue;const S=b.displaySize;h=Math.max(h,S[0]),f=Math.max(f,S[1])}}return{maxImageWidth:h,maxImageHeight:f}}addTextSection(s,h){this.text+=s.text,this.sections.push(Uu.forText(s.scale,s.fontStack||h,s.verticalAlign));const f=this.sections.length-1;for(let m=0;m<s.text.length;++m)this.sectionIndex.push(f)}addImageSection(s){const h=s.image?s.image.name:"";if(h.length===0)return void ci("Can't add FormattedSection with an empty image.");const f=this.getNextImageSectionCharCode();f?(this.text+=String.fromCharCode(f),this.sections.push(Uu.forImage(h,s.verticalAlign)),this.sectionIndex.push(this.sections.length-1)):ci("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function zd(u,s,h,f,m,v,b,S,P,M,k,O,U,j,$){const Z=jl.fromFeature(u,m);let te;O===d.ag.vertical&&Z.verticalizePunctuation();const{processBidirectionalText:ce,processStyledBidirectionalText:Me}=fs;if(ce&&Z.sections.length===1){te=[];const Q=ce(Z.toString(),pg(Z,M,v,s,f,j));for(const me of Q){const We=new jl;We.text=me,We.sections=Z.sections;for(let lt=0;lt<me.length;lt++)We.sectionIndex.push(0);te.push(We)}}else if(Me){te=[];const Q=Me(Z.text,Z.sectionIndex,pg(Z,M,v,s,f,j));for(const me of Q){const We=new jl;We.text=me[0],We.sectionIndex=me[1],We.sections=Z.sections,te.push(We)}}else te=(function(Q,me){const We=[],lt=Q.text;let Ye=0;for(const Qe of me)We.push(Q.substring(Ye,Qe)),Ye=Qe;return Ye<lt.length&&We.push(Q.substring(Ye,lt.length)),We})(Z,pg(Z,M,v,s,f,j));const pe=[],V={positionedLines:pe,text:Z.toString(),top:k[1],bottom:k[1],left:k[0],right:k[0],writingMode:O,iconsInText:!1,verticalizable:!1};return(function(Q,me,We,lt,Ye,Qe,ft,ut,gt,st,St,Ft){let Ot=0,Ct=0,Kt=0,Li=0;const Ji=ut==="right"?1:ut==="left"?0:.5,Tr=Ki/Ft;let fn=0;for(const Ri of Ye){Ri.trim();const nr=Ri.getMaxScale(),gr={positionedGlyphs:[],lineOffset:0};Q.positionedLines[fn]=gr;const mr=gr.positionedGlyphs;let Dr=0;if(!Ri.length()){Ct+=Qe,++fn;continue}const pn=F2(lt,Ri,Tr);for(let Hr=0;Hr<Ri.length();Hr++){const Qi=Ri.getSection(Hr),or=Ri.getSectionIndex(Hr),ar=Ri.getCharCode(Hr),Wi=B2(gt,St,ar);let Ti;if(Qi.imageName){if(Q.iconsInText=!0,Qi.scale=Qi.scale*Tr,Ti=z2(Qi,Wi,nr,pn,lt),!Ti)continue;Dr=Math.max(Dr,Ti.imageOffset)}else if(Ti=N2(Qi,ar,Wi,pn,me,We),!Ti)continue;const{rect:Wn,metrics:Zl,baselineOffset:Hn}=Ti;mr.push({glyph:ar,imageName:Qi.imageName,x:Ot,y:Ct+Hn+Nd,vertical:Wi,scale:Qi.scale,fontStack:Qi.fontStack,sectionIndex:or,metrics:Zl,rect:Wn}),Wi?(Q.verticalizable=!0,Ot+=(Qi.imageName?Zl.advance:Ki)*Qi.scale+st):Ot+=Zl.advance*Qi.scale+st}mr.length!==0&&(Kt=Math.max(Ot-st,Kt),U2(mr,0,mr.length-1,Ji)),Ot=0,gr.lineOffset=Math.max(Dr,(nr-1)*Ki);const sr=Qe*nr+Dr;Ct+=sr,Li=Math.max(sr,Li),++fn}const{horizontalAlign:Wr,verticalAlign:pr}=gg(ft);(function(Ri,nr,gr,mr,Dr,pn,sr,Hr,Qi){const or=(nr-gr)*Dr;let ar=0;ar=pn!==sr?-Hr*mr-Nd:-mr*Qi*sr+.5*sr;for(const Wi of Ri)for(const Ti of Wi.positionedGlyphs)Ti.x+=or,Ti.y+=ar})(Q.positionedLines,Ji,Wr,pr,Kt,Li,Qe,Ct,Ye.length),Q.top+=-pr*Ct,Q.bottom=Q.top+Ct,Q.left+=-Wr*Kt,Q.right=Q.left+Kt})(V,s,h,f,te,b,S,P,O,M,U,$),!(function(Q){for(const me of Q)if(me.positionedGlyphs.length!==0)return!1;return!0})(pe)&&V}const Ud={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},D2={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},O2={40:!0};function sx(u,s,h,f,m,v){if(s.imageName){const b=f[s.imageName];return b?b.displaySize[0]*s.scale*Ki/v+m:0}{const b=h[s.fontStack],S=b&&b[u];return S?S.metrics.advance*s.scale+m:0}}function ox(u,s,h,f){const m=Math.pow(u-s,2);return f?u<s?m/2:2*m:m+Math.abs(h)*h}function L2(u,s,h){let f=0;return u===10&&(f-=1e4),h&&(f+=150),u!==40&&u!==65288||(f+=50),s!==41&&s!==65289||(f+=50),f}function ax(u,s,h,f,m,v){let b=null,S=ox(s,h,m,v);for(const P of f){const M=ox(s-P.x,h,m,v)+P.badness;M<=S&&(b=P,S=M)}return{index:u,x:s,priorBreak:b,badness:S}}function lx(u){return u?lx(u.priorBreak).concat(u.index):[]}function pg(u,s,h,f,m,v){if(!u)return[];const b=[],S=(function(O,U,j,$,Z,te){let ce=0;for(let Me=0;Me<O.length();Me++){const pe=O.getSection(Me);ce+=sx(O.getCharCode(Me),pe,$,Z,U,te)}return ce/Math.max(1,Math.ceil(ce/j))})(u,s,h,f,m,v),P=u.text.indexOf("â")>=0;let M=0;for(let O=0;O<u.length();O++){const U=u.getSection(O),j=u.getCharCode(O);if(Ud[j]||(M+=sx(j,U,f,m,s,v)),O<u.length()-1){const $=!((k=j)<11904)&&(!!qt["CJK Compatibility Forms"](k)||!!qt["CJK Compatibility"](k)||!!qt["CJK Strokes"](k)||!!qt["CJK Symbols and Punctuation"](k)||!!qt["Enclosed CJK Letters and Months"](k)||!!qt["Halfwidth and Fullwidth Forms"](k)||!!qt["Ideographic Description Characters"](k)||!!qt["Vertical Forms"](k)||gu.test(String.fromCodePoint(k)));(D2[j]||$||U.imageName||O!==u.length()-2&&O2[u.getCharCode(O+1)])&&b.push(ax(O+1,M,S,b,L2(j,u.getCharCode(O+1),$&&P),!1))}}var k;return lx(ax(u.length(),M,S,b,0,!0))}function gg(u){let s=.5,h=.5;switch(u){case"right":case"top-right":case"bottom-right":s=1;break;case"left":case"top-left":case"bottom-left":s=0}switch(u){case"bottom":case"bottom-right":case"bottom-left":h=1;break;case"top":case"top-right":case"top-left":h=0}return{horizontalAlign:s,verticalAlign:h}}function F2(u,s,h){const f=s.getMaxScale()*Ki,{maxImageWidth:m,maxImageHeight:v}=s.getMaxImageSize(u),b=Math.max(f,v*h);return{verticalLineContentWidth:Math.max(f,m*h),horizontalLineContentHeight:b}}function cx(u){switch(u){case"top":return 0;case"center":return .5;default:return 1}}function B2(u,s,h){return!(u===d.ag.horizontal||!s&&!mu(h)||s&&(Ud[h]||(f=h,/\p{sc=Arab}/u.test(String.fromCodePoint(f)))));var f}function N2(u,s,h,f,m,v){const b=v[u.fontStack],S=(function(M,k,O,U){if(M&&M.rect)return M;const j=k[O.fontStack],$=j&&j[U];return $?{rect:null,metrics:$.metrics}:null})(b&&b[s],m,u,s);if(S===null)return null;let P;if(h)P=f.verticalLineContentWidth-u.scale*Ki;else{const M=cx(u.verticalAlign);P=(f.horizontalLineContentHeight-u.scale*Ki)*M}return{rect:S.rect,metrics:S.metrics,baselineOffset:P}}function z2(u,s,h,f,m){const v=m[u.imageName];if(!v)return null;const b=v.paddedRect,S=v.displaySize,P={width:S[0],height:S[1],left:$r,top:-3,advance:s?S[1]:S[0]};let M;if(s)M=f.verticalLineContentWidth-S[1]*u.scale;else{const k=cx(u.verticalAlign);M=(f.horizontalLineContentHeight-S[1]*u.scale)*k}return{rect:b,metrics:P,baselineOffset:M,imageOffset:(s?S[0]:S[1])*u.scale-Ki*h}}function U2(u,s,h,f){if(f===0)return;const m=u[h],v=(u[h].x+m.metrics.advance*m.scale)*f;for(let b=s;b<=h;b++)u[b].x-=v}function V2(u,s,h){const{horizontalAlign:f,verticalAlign:m}=gg(h),v=s[0]-u.displaySize[0]*f,b=s[1]-u.displaySize[1]*m;return{image:u,top:b,bottom:b+u.displaySize[1],left:v,right:v+u.displaySize[0]}}function ux(u){var s,h;let f=u.left,m=u.top,v=u.right-f,b=u.bottom-m;const S=(s=u.image.textFitWidth)!==null&&s!==void 0?s:"stretchOrShrink",P=(h=u.image.textFitHeight)!==null&&h!==void 0?h:"stretchOrShrink",M=(u.image.content[2]-u.image.content[0])/(u.image.content[3]-u.image.content[1]);if(P==="proportional"){if(S==="stretchOnly"&&v/b<M||S==="proportional"){const k=Math.ceil(b*M);f*=k/v,v=k}}else if(S==="proportional"&&P==="stretchOnly"&&M!==0&&v/b>M){const k=Math.ceil(v/M);m*=k/b,b=k}return{x1:f,y1:m,x2:f+v,y2:m+b}}function hx(u,s,h,f,m,v){const b=u.image;let S;if(b.content){const te=b.content,ce=b.pixelRatio||1;S=[te[0]/ce,te[1]/ce,b.displaySize[0]-te[2]/ce,b.displaySize[1]-te[3]/ce]}const P=s.left*v,M=s.right*v;let k,O,U,j;h==="width"||h==="both"?(j=m[0]+P-f[3],O=m[0]+M+f[1]):(j=m[0]+(P+M-b.displaySize[0])/2,O=j+b.displaySize[0]);const $=s.top*v,Z=s.bottom*v;return h==="height"||h==="both"?(k=m[1]+$-f[0],U=m[1]+Z+f[2]):(k=m[1]+($+Z-b.displaySize[1])/2,U=k+b.displaySize[1]),{image:b,top:k,right:O,bottom:U,left:j,collisionPadding:S}}const Vu=255,gs=128,Mo=Vu*gs;function dx(u,s){const{expression:h}=s;if(h.kind==="constant")return{kind:"constant",layoutSize:h.evaluate(new Ci(u+1))};if(h.kind==="source")return{kind:"source"};{const{zoomStops:f,interpolationType:m}=h;let v=0;for(;v<f.length&&f[v]<=u;)v++;v=Math.max(0,v-1);let b=v;for(;b<f.length&&f[b]<u+1;)b++;b=Math.min(f.length-1,b);const S=f[v],P=f[b];return h.kind==="composite"?{kind:"composite",minZoom:S,maxZoom:P,interpolationType:m}:{kind:"camera",minZoom:S,maxZoom:P,minSize:h.evaluate(new Ci(S)),maxSize:h.evaluate(new Ci(P)),interpolationType:m}}}function mg(u,s,h){let f="never";const m=u.get(s);return m?f=m:u.get(h)&&(f="always"),f}const j2=Fu.VectorTileFeature.types,$2=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Vd(u,s,h,f,m,v,b,S,P,M,k,O,U){const j=S?Math.min(Mo,Math.round(S[0])):0,$=S?Math.min(Mo,Math.round(S[1])):0;u.emplaceBack(s,h,Math.round(32*f),Math.round(32*m),v,b,(j<<1)+(P?1:0),$,16*M,16*k,256*O,256*U)}function _g(u,s,h){u.emplaceBack(s.x,s.y,h),u.emplaceBack(s.x,s.y,h),u.emplaceBack(s.x,s.y,h),u.emplaceBack(s.x,s.y,h)}function W2(u){for(const s of u.sections)if(Sd(s.text))return!0;return!1}class yg{constructor(s){this.layoutVertexArray=new $e,this.indexArray=new xt,this.programConfigurations=s,this.segments=new Rt,this.dynamicLayoutVertexArray=new He,this.opacityVertexArray=new it,this.hasVisibleVertices=!1,this.placedSymbolArray=new C}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0}upload(s,h,f,m){this.isEmpty()||(f&&(this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,T2.members),this.indexBuffer=s.createIndexBuffer(this.indexArray,h),this.dynamicLayoutVertexBuffer=s.createVertexBuffer(this.dynamicLayoutVertexArray,S2.members,!0),this.opacityVertexBuffer=s.createVertexBuffer(this.opacityVertexArray,$2,!0),this.opacityVertexBuffer.itemSize=1),(f||m)&&this.programConfigurations.upload(s))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}wt("SymbolBuffers",yg);class xg{constructor(s,h,f){this.layoutVertexArray=new s,this.layoutAttributes=h,this.indexArray=new f,this.segments=new Rt,this.collisionVertexArray=new et}upload(s){this.layoutVertexBuffer=s.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=s.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=s.createVertexBuffer(this.collisionVertexArray,E2.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}wt("CollisionBuffers",xg);class $l{constructor(s){this.collisionBoxArray=s.collisionBoxArray,this.zoom=s.zoom,this.overscaling=s.overscaling,this.layers=s.layers,this.layerIds=this.layers.map((b=>b.id)),this.index=s.index,this.pixelRatio=s.pixelRatio,this.sourceLayerIndex=s.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const h=this.layers[0]._unevaluatedLayout._values;this.textSizeData=dx(this.zoom,h["text-size"]),this.iconSizeData=dx(this.zoom,h["icon-size"]);const f=this.layers[0].layout,m=f.get("symbol-sort-key"),v=f.get("symbol-z-order");this.canOverlap=mg(f,"text-overlap","text-allow-overlap")!=="never"||mg(f,"icon-overlap","icon-allow-overlap")!=="never"||f.get("text-ignore-placement")||f.get("icon-ignore-placement"),this.sortFeaturesByKey=v!=="viewport-y"&&!m.isConstant(),this.sortFeaturesByY=(v==="viewport-y"||v==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,f.get("symbol-placement")==="point"&&(this.writingModes=f.get("text-writing-mode").map((b=>d.ag[b]))),this.stateDependentLayerIds=this.layers.filter((b=>b.isStateDependent())).map((b=>b.id)),this.sourceID=s.sourceID}createArrays(){this.text=new yg(new Xs(this.layers,this.zoom,(s=>/^text/.test(s)))),this.icon=new yg(new Xs(this.layers,this.zoom,(s=>/^icon/.test(s)))),this.glyphOffsetArray=new N,this.lineVertexArray=new z,this.symbolInstances=new L,this.textAnchorOffsets=new q}calculateGlyphDependencies(s,h,f,m,v){for(let b=0;b<s.length;b++)if(h[s.charCodeAt(b)]=!0,(f||m)&&v){const S=zu[s.charAt(b)];S&&(h[S.charCodeAt(0)]=!0)}}populate(s,h,f){const m=this.layers[0],v=m.layout,b=v.get("text-font"),S=v.get("text-field"),P=v.get("icon-image"),M=(S.value.kind!=="constant"||S.value.value instanceof dr&&!S.value.value.isEmpty()||S.value.value.toString().length>0)&&(b.value.kind!=="constant"||b.value.value.length>0),k=P.value.kind!=="constant"||!!P.value.value||Object.keys(P.parameters).length>0,O=v.get("symbol-sort-key");if(this.features=[],!M&&!k)return;const U=h.iconDependencies,j=h.glyphDependencies,$=h.availableImages,Z=new Ci(this.zoom);for(const{feature:te,id:ce,index:Me,sourceLayerIndex:pe}of s){const V=m._featureFilter.needGeometry,Q=jr(te,V);if(!m._featureFilter.filter(Z,Q,f))continue;let me,We;if(V||(Q.geometry=Gs(te)),M){const Ye=m.getValueAndResolveTokens("text-field",Q,f,$),Qe=dr.factory(Ye),ft=this.hasRTLText=this.hasRTLText||W2(Qe);(!ft||fs.getRTLTextPluginStatus()==="unavailable"||ft&&fs.isParsed())&&(me=P2(Qe,m,Q))}if(k){const Ye=m.getValueAndResolveTokens("icon-image",Q,f,$);We=Ye instanceof Ar?Ye:Ar.fromString(Ye)}if(!me&&!We)continue;const lt=this.sortFeaturesByKey?O.evaluate(Q,{},f):void 0;if(this.features.push({id:ce,text:me,icon:We,index:Me,sourceLayerIndex:pe,geometry:Q.geometry,properties:te.properties,type:j2[te.type],sortKey:lt}),We&&(U[We.name]=!0),me){const Ye=b.evaluate(Q,{},f).join(","),Qe=v.get("text-rotation-alignment")!=="viewport"&&v.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(d.ag.vertical)>=0;for(const ft of me.sections)if(ft.image)U[ft.image.name]=!0;else{const ut=Tl(me.toString()),gt=ft.fontStack||Ye,st=j[gt]=j[gt]||{};this.calculateGlyphDependencies(ft.text,st,Qe,this.allowVerticalPlacement,ut)}}}v.get("symbol-placement")==="line"&&(this.features=(function(te){const ce={},Me={},pe=[];let V=0;function Q(Ye){pe.push(te[Ye]),V++}function me(Ye,Qe,ft){const ut=Me[Ye];return delete Me[Ye],Me[Qe]=ut,pe[ut].geometry[0].pop(),pe[ut].geometry[0]=pe[ut].geometry[0].concat(ft[0]),ut}function We(Ye,Qe,ft){const ut=ce[Qe];return delete ce[Qe],ce[Ye]=ut,pe[ut].geometry[0].shift(),pe[ut].geometry[0]=ft[0].concat(pe[ut].geometry[0]),ut}function lt(Ye,Qe,ft){const ut=ft?Qe[0][Qe[0].length-1]:Qe[0][0];return`${Ye}:${ut.x}:${ut.y}`}for(let Ye=0;Ye<te.length;Ye++){const Qe=te[Ye],ft=Qe.geometry,ut=Qe.text?Qe.text.toString():null;if(!ut){Q(Ye);continue}const gt=lt(ut,ft),st=lt(ut,ft,!0);if(gt in Me&&st in ce&&Me[gt]!==ce[st]){const St=We(gt,st,ft),Ft=me(gt,st,pe[St].geometry);delete ce[gt],delete Me[st],Me[lt(ut,pe[Ft].geometry,!0)]=Ft,pe[St].geometry=null}else gt in Me?me(gt,st,ft):st in ce?We(gt,st,ft):(Q(Ye),ce[gt]=V-1,Me[st]=V-1)}return pe.filter((Ye=>Ye.geometry))})(this.features)),this.sortFeaturesByKey&&this.features.sort(((te,ce)=>te.sortKey-ce.sortKey))}update(s,h,f){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(s,h,this.layers,f),this.icon.programConfigurations.updatePaintArrays(s,h,this.layers,f))}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(s){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(s),this.iconCollisionBox.upload(s)),this.text.upload(s,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(s,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(s,h){const f=this.lineVertexArray.length;if(s.segment!==void 0){let m=s.dist(h[s.segment+1]),v=s.dist(h[s.segment]);const b={};for(let S=s.segment+1;S<h.length;S++)b[S]={x:h[S].x,y:h[S].y,tileUnitDistanceFromAnchor:m},S<h.length-1&&(m+=h[S+1].dist(h[S]));for(let S=s.segment||0;S>=0;S--)b[S]={x:h[S].x,y:h[S].y,tileUnitDistanceFromAnchor:v},S>0&&(v+=h[S-1].dist(h[S]));for(let S=0;S<h.length;S++){const P=b[S];this.lineVertexArray.emplaceBack(P.x,P.y,P.tileUnitDistanceFromAnchor)}}return{lineStartIndex:f,lineLength:this.lineVertexArray.length-f}}addSymbols(s,h,f,m,v,b,S,P,M,k,O,U){const j=s.indexArray,$=s.layoutVertexArray,Z=s.segments.prepareSegment(4*h.length,$,j,this.canOverlap?b.sortKey:void 0),te=this.glyphOffsetArray.length,ce=Z.vertexLength,Me=this.allowVerticalPlacement&&S===d.ag.vertical?Math.PI/2:0,pe=b.text&&b.text.sections;for(let V=0;V<h.length;V++){const{tl:Q,tr:me,bl:We,br:lt,tex:Ye,pixelOffsetTL:Qe,pixelOffsetBR:ft,minFontScaleX:ut,minFontScaleY:gt,glyphOffset:st,isSDF:St,sectionIndex:Ft}=h[V],Ot=Z.vertexLength,Ct=st[1];Vd($,P.x,P.y,Q.x,Ct+Q.y,Ye.x,Ye.y,f,St,Qe.x,Qe.y,ut,gt),Vd($,P.x,P.y,me.x,Ct+me.y,Ye.x+Ye.w,Ye.y,f,St,ft.x,Qe.y,ut,gt),Vd($,P.x,P.y,We.x,Ct+We.y,Ye.x,Ye.y+Ye.h,f,St,Qe.x,ft.y,ut,gt),Vd($,P.x,P.y,lt.x,Ct+lt.y,Ye.x+Ye.w,Ye.y+Ye.h,f,St,ft.x,ft.y,ut,gt),_g(s.dynamicLayoutVertexArray,P,Me),j.emplaceBack(Ot,Ot+2,Ot+1),j.emplaceBack(Ot+1,Ot+2,Ot+3),Z.vertexLength+=4,Z.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(st[0]),V!==h.length-1&&Ft===h[V+1].sectionIndex||s.programConfigurations.populatePaintArrays($.length,b,b.index,{},U,pe&&pe[Ft])}s.placedSymbolArray.emplaceBack(P.x,P.y,te,this.glyphOffsetArray.length-te,ce,M,k,P.segment,f?f[0]:0,f?f[1]:0,m[0],m[1],S,0,!1,0,O)}_addCollisionDebugVertex(s,h,f,m,v,b){return h.emplaceBack(0,0),s.emplaceBack(f.x,f.y,m,v,Math.round(b.x),Math.round(b.y))}addCollisionDebugVertices(s,h,f,m,v,b,S){const P=v.segments.prepareSegment(4,v.layoutVertexArray,v.indexArray),M=P.vertexLength,k=v.layoutVertexArray,O=v.collisionVertexArray,U=S.anchorX,j=S.anchorY;this._addCollisionDebugVertex(k,O,b,U,j,new X(s,h)),this._addCollisionDebugVertex(k,O,b,U,j,new X(f,h)),this._addCollisionDebugVertex(k,O,b,U,j,new X(f,m)),this._addCollisionDebugVertex(k,O,b,U,j,new X(s,m)),P.vertexLength+=4;const $=v.indexArray;$.emplaceBack(M,M+1),$.emplaceBack(M+1,M+2),$.emplaceBack(M+2,M+3),$.emplaceBack(M+3,M),P.primitiveLength+=4}addDebugCollisionBoxes(s,h,f,m){for(let v=s;v<h;v++){const b=this.collisionBoxArray.get(v);this.addCollisionDebugVertices(b.x1,b.y1,b.x2,b.y2,m?this.textCollisionBox:this.iconCollisionBox,b.anchorPoint,f)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new xg(nt,Qy.members,yt),this.iconCollisionBox=new xg(nt,Qy.members,yt);for(let s=0;s<this.symbolInstances.length;s++){const h=this.symbolInstances.get(s);this.addDebugCollisionBoxes(h.textBoxStartIndex,h.textBoxEndIndex,h,!0),this.addDebugCollisionBoxes(h.verticalTextBoxStartIndex,h.verticalTextBoxEndIndex,h,!0),this.addDebugCollisionBoxes(h.iconBoxStartIndex,h.iconBoxEndIndex,h,!1),this.addDebugCollisionBoxes(h.verticalIconBoxStartIndex,h.verticalIconBoxEndIndex,h,!1)}}_deserializeCollisionBoxesForSymbol(s,h,f,m,v,b,S,P,M){const k={};for(let O=h;O<f;O++){const U=s.get(O);k.textBox={x1:U.x1,y1:U.y1,x2:U.x2,y2:U.y2,anchorPointX:U.anchorPointX,anchorPointY:U.anchorPointY},k.textFeatureIndex=U.featureIndex;break}for(let O=m;O<v;O++){const U=s.get(O);k.verticalTextBox={x1:U.x1,y1:U.y1,x2:U.x2,y2:U.y2,anchorPointX:U.anchorPointX,anchorPointY:U.anchorPointY},k.verticalTextFeatureIndex=U.featureIndex;break}for(let O=b;O<S;O++){const U=s.get(O);k.iconBox={x1:U.x1,y1:U.y1,x2:U.x2,y2:U.y2,anchorPointX:U.anchorPointX,anchorPointY:U.anchorPointY},k.iconFeatureIndex=U.featureIndex;break}for(let O=P;O<M;O++){const U=s.get(O);k.verticalIconBox={x1:U.x1,y1:U.y1,x2:U.x2,y2:U.y2,anchorPointX:U.anchorPointX,anchorPointY:U.anchorPointY},k.verticalIconFeatureIndex=U.featureIndex;break}return k}deserializeCollisionBoxes(s){this.collisionArrays=[];for(let h=0;h<this.symbolInstances.length;h++){const f=this.symbolInstances.get(h);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(s,f.textBoxStartIndex,f.textBoxEndIndex,f.verticalTextBoxStartIndex,f.verticalTextBoxEndIndex,f.iconBoxStartIndex,f.iconBoxEndIndex,f.verticalIconBoxStartIndex,f.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(s,h){const f=s.placedSymbolArray.get(h),m=f.vertexStartIndex+4*f.numGlyphs;for(let v=f.vertexStartIndex;v<m;v+=4)s.indexArray.emplaceBack(v,v+2,v+1),s.indexArray.emplaceBack(v+1,v+2,v+3)}getSortedSymbolIndexes(s){if(this.sortedAngle===s&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const h=Math.sin(s),f=Math.cos(s),m=[],v=[],b=[];for(let S=0;S<this.symbolInstances.length;++S){b.push(S);const P=this.symbolInstances.get(S);m.push(0|Math.round(h*P.anchorX+f*P.anchorY)),v.push(P.featureIndex)}return b.sort(((S,P)=>m[S]-m[P]||v[P]-v[S])),b}addToSortKeyRanges(s,h){const f=this.sortKeyRanges[this.sortKeyRanges.length-1];f&&f.sortKey===h?f.symbolInstanceEnd=s+1:this.sortKeyRanges.push({sortKey:h,symbolInstanceStart:s,symbolInstanceEnd:s+1})}sortFeatures(s){if(this.sortFeaturesByY&&this.sortedAngle!==s&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(s),this.sortedAngle=s,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const h of this.symbolInstanceIndexes){const f=this.symbolInstances.get(h);this.featureSortOrder.push(f.featureIndex),[f.rightJustifiedTextSymbolIndex,f.centerJustifiedTextSymbolIndex,f.leftJustifiedTextSymbolIndex].forEach(((m,v,b)=>{m>=0&&b.indexOf(m)===v&&this.addIndicesForPlacedSymbol(this.text,m)})),f.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,f.verticalPlacedTextSymbolIndex),f.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,f.placedIconSymbolIndex),f.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,f.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let fx,px;wt("SymbolBucket",$l,{omit:["layers","collisionBoxArray","features","compareText"]}),$l.MAX_GLYPHS=65535,$l.addDynamicAttributes=_g;var vg={get paint(){return px=px||new kr({"icon-opacity":new Bt(B.paint_symbol["icon-opacity"]),"icon-color":new Bt(B.paint_symbol["icon-color"]),"icon-halo-color":new Bt(B.paint_symbol["icon-halo-color"]),"icon-halo-width":new Bt(B.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Bt(B.paint_symbol["icon-halo-blur"]),"icon-translate":new Mt(B.paint_symbol["icon-translate"]),"icon-translate-anchor":new Mt(B.paint_symbol["icon-translate-anchor"]),"text-opacity":new Bt(B.paint_symbol["text-opacity"]),"text-color":new Bt(B.paint_symbol["text-color"],{runtimeType:Ht,getOverride:u=>u.textColor,hasOverride:u=>!!u.textColor}),"text-halo-color":new Bt(B.paint_symbol["text-halo-color"]),"text-halo-width":new Bt(B.paint_symbol["text-halo-width"]),"text-halo-blur":new Bt(B.paint_symbol["text-halo-blur"]),"text-translate":new Mt(B.paint_symbol["text-translate"]),"text-translate-anchor":new Mt(B.paint_symbol["text-translate-anchor"])})},get layout(){return fx=fx||new kr({"symbol-placement":new Mt(B.layout_symbol["symbol-placement"]),"symbol-spacing":new Mt(B.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Mt(B.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Bt(B.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Mt(B.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Mt(B.layout_symbol["icon-allow-overlap"]),"icon-overlap":new Mt(B.layout_symbol["icon-overlap"]),"icon-ignore-placement":new Mt(B.layout_symbol["icon-ignore-placement"]),"icon-optional":new Mt(B.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Mt(B.layout_symbol["icon-rotation-alignment"]),"icon-size":new Bt(B.layout_symbol["icon-size"]),"icon-text-fit":new Mt(B.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Mt(B.layout_symbol["icon-text-fit-padding"]),"icon-image":new Bt(B.layout_symbol["icon-image"]),"icon-rotate":new Bt(B.layout_symbol["icon-rotate"]),"icon-padding":new Bt(B.layout_symbol["icon-padding"]),"icon-keep-upright":new Mt(B.layout_symbol["icon-keep-upright"]),"icon-offset":new Bt(B.layout_symbol["icon-offset"]),"icon-anchor":new Bt(B.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Mt(B.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Mt(B.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Mt(B.layout_symbol["text-rotation-alignment"]),"text-field":new Bt(B.layout_symbol["text-field"]),"text-font":new Bt(B.layout_symbol["text-font"]),"text-size":new Bt(B.layout_symbol["text-size"]),"text-max-width":new Bt(B.layout_symbol["text-max-width"]),"text-line-height":new Mt(B.layout_symbol["text-line-height"]),"text-letter-spacing":new Bt(B.layout_symbol["text-letter-spacing"]),"text-justify":new Bt(B.layout_symbol["text-justify"]),"text-radial-offset":new Bt(B.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Mt(B.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new Bt(B.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new Bt(B.layout_symbol["text-anchor"]),"text-max-angle":new Mt(B.layout_symbol["text-max-angle"]),"text-writing-mode":new Mt(B.layout_symbol["text-writing-mode"]),"text-rotate":new Bt(B.layout_symbol["text-rotate"]),"text-padding":new Mt(B.layout_symbol["text-padding"]),"text-keep-upright":new Mt(B.layout_symbol["text-keep-upright"]),"text-transform":new Bt(B.layout_symbol["text-transform"]),"text-offset":new Bt(B.layout_symbol["text-offset"]),"text-allow-overlap":new Mt(B.layout_symbol["text-allow-overlap"]),"text-overlap":new Mt(B.layout_symbol["text-overlap"]),"text-ignore-placement":new Mt(B.layout_symbol["text-ignore-placement"]),"text-optional":new Mt(B.layout_symbol["text-optional"])})}};class gx{constructor(s){if(s.property.overrides===void 0)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=s.property.overrides?s.property.overrides.runtimeType:Nt,this.defaultValue=s}evaluate(s){if(s.formattedSection){const h=this.defaultValue.property.overrides;if(h&&h.hasOverride(s.formattedSection))return h.getOverride(s.formattedSection)}return s.feature&&s.featureState?this.defaultValue.evaluate(s.feature,s.featureState):this.defaultValue.property.specification.default}eachChild(s){this.defaultValue.isConstant()||s(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}wt("FormatSectionOverride",gx,{omit:["defaultValue"]});class jd extends Sn{constructor(s){super(s,vg)}recalculate(s,h){if(super.recalculate(s,h),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")==="map"?"map":"viewport"),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),this.layout.get("symbol-placement")==="point"){const f=this.layout.get("text-writing-mode");if(f){const m=[];for(const v of f)m.indexOf(v)<0&&m.push(v);this.layout._values["text-writing-mode"]=m}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(s,h,f,m){const v=this.layout.get(s).evaluate(h,{},f,m),b=this._unevaluatedLayout._values[s];return b.isDataDriven()||gl(b.value)||!v?v:(function(S,P){return P.replace(/{([^{}]+)}/g,((M,k)=>S&&k in S?String(S[k]):""))})(h.properties,v)}createBucket(s){return new $l(s)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const s of vg.paint.overridableProperties){if(!jd.hasPaintOverride(this.layout,s))continue;const h=this.paint.get(s),f=new gx(h),m=new eu(f,h.property.specification);let v=null;v=h.value.kind==="constant"||h.value.kind==="source"?new ml("source",m):new tu("composite",m,h.value.zoomStops),this.paint._values[s]=new en(h.property,v,h.parameters)}}_handleOverridablePaintPropertyUpdate(s,h,f){return!(!this.layout||h.isDataDriven()||f.isDataDriven())&&jd.hasPaintOverride(this.layout,s)}static hasPaintOverride(s,h){const f=s.get("text-field"),m=vg.paint.properties[h];let v=!1;const b=S=>{for(const P of S)if(m.overrides&&m.overrides.hasOverride(P))return void(v=!0)};if(f.value.kind==="constant"&&f.value.value instanceof dr)b(f.value.value.sections);else if(f.value.kind==="source"){const S=M=>{v||(M instanceof Gr&&$i(M.value)===ji?b(M.value.sections):M instanceof Ds?b(M.sections):M.eachChild(S))},P=f.value;P._styleExpression&&S(P._styleExpression.expression)}return v}}let mx;var H2={get paint(){return mx=mx||new kr({"background-color":new Mt(B.paint_background["background-color"]),"background-pattern":new Pl(B.paint_background["background-pattern"]),"background-opacity":new Mt(B.paint_background["background-opacity"])})}};class Z2 extends Sn{constructor(s){super(s,H2)}}let _x;var q2={get paint(){return _x=_x||new kr({"raster-opacity":new Mt(B.paint_raster["raster-opacity"]),"raster-hue-rotate":new Mt(B.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Mt(B.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Mt(B.paint_raster["raster-brightness-max"]),"raster-saturation":new Mt(B.paint_raster["raster-saturation"]),"raster-contrast":new Mt(B.paint_raster["raster-contrast"]),"raster-resampling":new Mt(B.paint_raster["raster-resampling"]),"raster-fade-duration":new Mt(B.paint_raster["raster-fade-duration"])})}};class X2 extends Sn{constructor(s){super(s,q2)}}class G2 extends Sn{constructor(s){super(s,{}),this.onAdd=h=>{this.implementation.onAdd&&this.implementation.onAdd(h,h.painter.context.gl)},this.onRemove=h=>{this.implementation.onRemove&&this.implementation.onRemove(h,h.painter.context.gl)},this.implementation=s}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class Y2{constructor(s){this._methodToThrottle=s,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._methodToThrottle()}),0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const K2={once:!0},bg=63710088e-1;class Ro{constructor(s,h){if(isNaN(s)||isNaN(h))throw new Error(`Invalid LngLat object: (${s}, ${h})`);if(this.lng=+s,this.lat=+h,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ro(bt(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(s){const h=Math.PI/180,f=this.lat*h,m=s.lat*h,v=Math.sin(f)*Math.sin(m)+Math.cos(f)*Math.cos(m)*Math.cos((s.lng-this.lng)*h);return bg*Math.acos(Math.min(v,1))}static convert(s){if(s instanceof Ro)return s;if(Array.isArray(s)&&(s.length===2||s.length===3))return new Ro(Number(s[0]),Number(s[1]));if(!Array.isArray(s)&&typeof s=="object"&&s!==null)return new Ro(Number("lng"in s?s.lng:s.lon),Number(s.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const yx=2*Math.PI*bg;function xx(u){return yx*Math.cos(u*Math.PI/180)}function vx(u){return(180+u)/360}function bx(u){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+u*Math.PI/360)))/360}function wx(u,s){return u/xx(s)}function wg(u){return 360/Math.PI*Math.atan(Math.exp((180-360*u)*Math.PI/180))-90}function Tx(u,s){return u*xx(wg(s))}class ju{constructor(s,h,f=0){this.x=+s,this.y=+h,this.z=+f}static fromLngLat(s,h=0){const f=Ro.convert(s);return new ju(vx(f.lng),bx(f.lat),wx(h,f.lat))}toLngLat(){return new Ro(360*this.x-180,wg(this.y))}toAltitude(){return Tx(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/yx*(s=wg(this.y),1/Math.cos(s*Math.PI/180));var s}}function Sx(u,s,h){var f=2*Math.PI*6378137/256/Math.pow(2,h);return[u*f-2*Math.PI*6378137/2,s*f-2*Math.PI*6378137/2]}class Tg{constructor(s,h,f){if(!(function(m,v,b){return!(m<0||m>25||b<0||b>=Math.pow(2,m)||v<0||v>=Math.pow(2,m))})(s,h,f))throw new Error(`x=${h}, y=${f}, z=${s} outside of bounds. 0<=x<${Math.pow(2,s)}, 0<=y<${Math.pow(2,s)} 0<=z<=25 `);this.z=s,this.x=h,this.y=f,this.key=Wl(0,s,s,h,f)}equals(s){return this.z===s.z&&this.x===s.x&&this.y===s.y}url(s,h,f){const m=(b=this.y,S=this.z,P=Sx(256*(v=this.x),256*(b=Math.pow(2,S)-b-1),S),M=Sx(256*(v+1),256*(b+1),S),P[0]+","+P[1]+","+M[0]+","+M[1]);var v,b,S,P,M;const k=(function(O,U,j){let $,Z="";for(let te=O;te>0;te--)$=1<<te-1,Z+=(U&$?1:0)+(j&$?2:0);return Z})(this.z,this.x,this.y);return s[(this.x+this.y)%s.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(f==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,h>1?"@2x":"").replace(/{quadkey}/g,k).replace(/{bbox-epsg-3857}/g,m)}isChildOf(s){const h=this.z-s.z;return h>0&&s.x===this.x>>h&&s.y===this.y>>h}getTilePoint(s){const h=Math.pow(2,this.z);return new X((s.x*h-this.x)*W,(s.y*h-this.y)*W)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Ex{constructor(s,h){this.wrap=s,this.canonical=h,this.key=Wl(s,h.z,h.z,h.x,h.y)}}class dn{constructor(s,h,f,m,v){if(this.terrainRttPosMatrix32f=null,s<f)throw new Error(`overscaledZ should be >= z; overscaledZ = ${s}; z = ${f}`);this.overscaledZ=s,this.wrap=h,this.canonical=new Tg(f,+m,+v),this.key=Wl(h,s,f,m,v)}clone(){return new dn(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(s){return this.overscaledZ===s.overscaledZ&&this.wrap===s.wrap&&this.canonical.equals(s.canonical)}scaledTo(s){if(s>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${s}; overscaledZ = ${this.overscaledZ}`);const h=this.canonical.z-s;return s>this.canonical.z?new dn(s,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new dn(s,this.wrap,s,this.canonical.x>>h,this.canonical.y>>h)}calculateScaledKey(s,h){if(s>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${s}; overscaledZ = ${this.overscaledZ}`);const f=this.canonical.z-s;return s>this.canonical.z?Wl(this.wrap*+h,s,this.canonical.z,this.canonical.x,this.canonical.y):Wl(this.wrap*+h,s,s,this.canonical.x>>f,this.canonical.y>>f)}isChildOf(s){if(s.wrap!==this.wrap)return!1;const h=this.canonical.z-s.canonical.z;return s.overscaledZ===0||s.overscaledZ<this.overscaledZ&&s.canonical.x===this.canonical.x>>h&&s.canonical.y===this.canonical.y>>h}children(s){if(this.overscaledZ>=s)return[new dn(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const h=this.canonical.z+1,f=2*this.canonical.x,m=2*this.canonical.y;return[new dn(h,this.wrap,h,f,m),new dn(h,this.wrap,h,f+1,m),new dn(h,this.wrap,h,f,m+1),new dn(h,this.wrap,h,f+1,m+1)]}isLessThan(s){return this.wrap<s.wrap||!(this.wrap>s.wrap)&&(this.overscaledZ<s.overscaledZ||!(this.overscaledZ>s.overscaledZ)&&(this.canonical.x<s.canonical.x||!(this.canonical.x>s.canonical.x)&&this.canonical.y<s.canonical.y))}wrapped(){return new dn(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(s){return new dn(this.overscaledZ,s,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Ex(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(s){return this.canonical.getTilePoint(new ju(s.x-this.wrap,s.y))}}function Wl(u,s,h,f,m){(u*=2)<0&&(u=-1*u-1);const v=1<<h;return(v*v*u+v*m+f).toString(36)+h.toString(36)+s.toString(36)}wt("CanonicalTileID",Tg),wt("OverscaledTileID",dn,{omit:["terrainRttPosMatrix32f"]});class Ax{constructor(s,h,f,m=1,v=1,b=1,S=0){if(this.uid=s,h.height!==h.width)throw new RangeError("DEM tiles must be square");if(f&&!["mapbox","terrarium","custom"].includes(f))return void ci(`"${f}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=h.height;const P=this.dim=h.height-2;switch(this.data=new Uint32Array(h.data.buffer),f){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=m,this.greenFactor=v,this.blueFactor=b,this.baseShift=S;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let M=0;M<P;M++)this.data[this._idx(-1,M)]=this.data[this._idx(0,M)],this.data[this._idx(P,M)]=this.data[this._idx(P-1,M)],this.data[this._idx(M,-1)]=this.data[this._idx(M,0)],this.data[this._idx(M,P)]=this.data[this._idx(M,P-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(P,-1)]=this.data[this._idx(P-1,0)],this.data[this._idx(-1,P)]=this.data[this._idx(0,P-1)],this.data[this._idx(P,P)]=this.data[this._idx(P-1,P-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let M=0;M<P;M++)for(let k=0;k<P;k++){const O=this.get(M,k);O>this.max&&(this.max=O),O<this.min&&(this.min=O)}}get(s,h){const f=new Uint8Array(this.data.buffer),m=4*this._idx(s,h);return this.unpack(f[m],f[m+1],f[m+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(s,h){if(s<-1||s>=this.dim+1||h<-1||h>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(h+1)*this.stride+(s+1)}unpack(s,h,f){return s*this.redFactor+h*this.greenFactor+f*this.blueFactor-this.baseShift}getPixels(){return new hn({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(s,h,f){if(this.dim!==s.dim)throw new Error("dem dimension mismatch");let m=h*this.dim,v=h*this.dim+this.dim,b=f*this.dim,S=f*this.dim+this.dim;switch(h){case-1:m=v-1;break;case 1:v=m+1}switch(f){case-1:b=S-1;break;case 1:S=b+1}const P=-h*this.dim,M=-f*this.dim;for(let k=b;k<S;k++)for(let O=m;O<v;O++)this.data[this._idx(O,k)]=s.data[this._idx(O+P,k+M)]}}wt("DEMData",Ax);class Px{constructor(s){this._stringToNumber={},this._numberToString=[];for(let h=0;h<s.length;h++){const f=s[h];this._stringToNumber[f]=h,this._numberToString[h]=f}}encode(s){return this._stringToNumber[s]}decode(s){if(s>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${s} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[s]}}class Cx{constructor(s,h,f,m,v){this.type="Feature",this._vectorTileFeature=s,s._z=h,s._x=f,s._y=m,this.properties=s.properties,this.id=v}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(s){this._geometry=s}toJSON(){const s={geometry:this.geometry};for(const h in this)h!=="_geometry"&&h!=="_vectorTileFeature"&&(s[h]=this[h]);return s}}class Ix{constructor(s,h){this.tileID=s,this.x=s.canonical.x,this.y=s.canonical.y,this.z=s.canonical.z,this.grid=new ua(W,16,0),this.grid3D=new ua(W,16,0),this.featureIndexArray=new ne,this.promoteId=h}insert(s,h,f,m,v,b){const S=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(f,m,v);const P=b?this.grid3D:this.grid;for(let M=0;M<h.length;M++){const k=h[M],O=[1/0,1/0,-1/0,-1/0];for(let U=0;U<k.length;U++){const j=k[U];O[0]=Math.min(O[0],j.x),O[1]=Math.min(O[1],j.y),O[2]=Math.max(O[2],j.x),O[3]=Math.max(O[3],j.y)}O[0]<W&&O[1]<W&&O[2]>=0&&O[3]>=0&&P.insert(S,O[0],O[1],O[2],O[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Fu.VectorTile(new hg(this.rawTileData)).layers,this.sourceLayerCoder=new Px(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(s,h,f,m){this.loadVTLayers();const v=s.params,b=W/s.tileSize/s.scale,S=xl(v.filter),P=s.queryGeometry,M=s.queryPadding*b,k=Rx(P),O=this.grid.query(k.minX-M,k.minY-M,k.maxX+M,k.maxY+M),U=Rx(s.cameraQueryGeometry),j=this.grid3D.query(U.minX-M,U.minY-M,U.maxX+M,U.maxY+M,((te,ce,Me,pe)=>(function(V,Q,me,We,lt){for(const Qe of V)if(Q<=Qe.x&&me<=Qe.y&&We>=Qe.x&&lt>=Qe.y)return!0;const Ye=[new X(Q,me),new X(Q,lt),new X(We,lt),new X(We,me)];if(V.length>2){for(const Qe of Ye)if(Nl(V,Qe))return!0}for(let Qe=0;Qe<V.length-1;Qe++)if(zT(V[Qe],V[Qe+1],Ye))return!0;return!1})(s.cameraQueryGeometry,te-M,ce-M,Me+M,pe+M)));for(const te of j)O.push(te);O.sort(J2);const $={};let Z;for(let te=0;te<O.length;te++){const ce=O[te];if(ce===Z)continue;Z=ce;const Me=this.featureIndexArray.get(ce);let pe=null;this.loadMatchingFeature($,Me.bucketIndex,Me.sourceLayerIndex,Me.featureIndex,S,v.layers,v.availableImages,h,f,m,((V,Q,me)=>(pe||(pe=Gs(V)),Q.queryIntersectsFeature({queryGeometry:P,feature:V,featureState:me,geometry:pe,zoom:this.z,transform:s.transform,pixelsToTileUnits:b,pixelPosMatrix:s.pixelPosMatrix}))))}return $}loadMatchingFeature(s,h,f,m,v,b,S,P,M,k,O){const U=this.bucketLayerIDs[h];if(b&&!U.some((te=>b.has(te))))return;const j=this.sourceLayerCoder.decode(f),$=this.vtLayers[j].feature(m);if(v.needGeometry){const te=jr($,!0);if(!v.filter(new Ci(this.tileID.overscaledZ),te,this.tileID.canonical))return}else if(!v.filter(new Ci(this.tileID.overscaledZ),$))return;const Z=this.getId($,j);for(let te=0;te<U.length;te++){const ce=U[te];if(b&&!b.has(ce))continue;const Me=P[ce];if(!Me)continue;let pe={};Z&&k&&(pe=k.getState(Me.sourceLayer||"_geojsonTileLayer",Z));const V=_t({},M[ce]);V.paint=Mx(V.paint,Me.paint,$,pe,S),V.layout=Mx(V.layout,Me.layout,$,pe,S);const Q=!O||O($,Me,pe);if(!Q)continue;const me=new Cx($,this.z,this.x,this.y,Z);me.layer=V;let We=s[ce];We===void 0&&(We=s[ce]=[]),We.push({featureIndex:m,feature:me,intersectionZ:Q})}}lookupSymbolFeatures(s,h,f,m,v,b,S,P){const M={};this.loadVTLayers();const k=xl(v);for(const O of s)this.loadMatchingFeature(M,f,m,O,k,b,S,P,h);return M}hasLayer(s){for(const h of this.bucketLayerIDs)for(const f of h)if(s===f)return!0;return!1}getId(s,h){var f;let m=s.id;return this.promoteId&&(m=s.properties[typeof this.promoteId=="string"?this.promoteId:this.promoteId[h]],typeof m=="boolean"&&(m=Number(m)),m===void 0&&(!((f=s.properties)===null||f===void 0)&&f.cluster)&&this.promoteId&&(m=Number(s.properties.cluster_id))),m}}function Mx(u,s,h,f,m){return Ut(u,((v,b)=>{const S=s instanceof Al?s.get(b):null;return S&&S.evaluate?S.evaluate(h,f,m):S}))}function Rx(u){let s=1/0,h=1/0,f=-1/0,m=-1/0;for(const v of u)s=Math.min(s,v.x),h=Math.min(h,v.y),f=Math.max(f,v.x),m=Math.max(m,v.y);return{minX:s,minY:h,maxX:f,maxY:m}}function J2(u,s){return s-u}function kx(u,s,h,f,m){const v=[];for(let b=0;b<u.length;b++){const S=u[b];let P;for(let M=0;M<S.length-1;M++){let k=S[M],O=S[M+1];k.x<s&&O.x<s||(k.x<s?k=new X(s,k.y+(s-k.x)/(O.x-k.x)*(O.y-k.y))._round():O.x<s&&(O=new X(s,k.y+(s-k.x)/(O.x-k.x)*(O.y-k.y))._round()),k.y<h&&O.y<h||(k.y<h?k=new X(k.x+(h-k.y)/(O.y-k.y)*(O.x-k.x),h)._round():O.y<h&&(O=new X(k.x+(h-k.y)/(O.y-k.y)*(O.x-k.x),h)._round()),k.x>=f&&O.x>=f||(k.x>=f?k=new X(f,k.y+(f-k.x)/(O.x-k.x)*(O.y-k.y))._round():O.x>=f&&(O=new X(f,k.y+(f-k.x)/(O.x-k.x)*(O.y-k.y))._round()),k.y>=m&&O.y>=m||(k.y>=m?k=new X(k.x+(m-k.y)/(O.y-k.y)*(O.x-k.x),m)._round():O.y>=m&&(O=new X(k.x+(m-k.y)/(O.y-k.y)*(O.x-k.x),m)._round()),P&&k.equals(P[P.length-1])||(P=[k],v.push(P)),P.push(O)))))}}return v}wt("FeatureIndex",Ix,{omit:["rawTileData","sourceLayerCoder"]});class ko extends X{constructor(s,h,f,m){super(s,h),this.angle=f,m!==void 0&&(this.segment=m)}clone(){return new ko(this.x,this.y,this.angle,this.segment)}}function Dx(u,s,h,f,m){if(s.segment===void 0||h===0)return!0;let v=s,b=s.segment+1,S=0;for(;S>-h/2;){if(b--,b<0)return!1;S-=u[b].dist(v),v=u[b]}S+=u[b].dist(u[b+1]),b++;const P=[];let M=0;for(;S<h/2;){const k=u[b],O=u[b+1];if(!O)return!1;let U=u[b-1].angleTo(k)-k.angleTo(O);for(U=Math.abs((U+3*Math.PI)%(2*Math.PI)-Math.PI),P.push({distance:S,angleDelta:U}),M+=U;S-P[0].distance>f;)M-=P.shift().angleDelta;if(M>m)return!1;b++,S+=k.dist(O)}return!0}function Ox(u){let s=0;for(let h=0;h<u.length-1;h++)s+=u[h].dist(u[h+1]);return s}function Lx(u,s,h){return u?.6*s*h:0}function Fx(u,s){return Math.max(u?u.right-u.left:0,s?s.right-s.left:0)}function Q2(u,s,h,f,m,v){const b=Lx(h,m,v),S=Fx(h,f)*v;let P=0;const M=Ox(u)/2;for(let k=0;k<u.length-1;k++){const O=u[k],U=u[k+1],j=O.dist(U);if(P+j>M){const $=(M-P)/j,Z=Ur.number(O.x,U.x,$),te=Ur.number(O.y,U.y,$),ce=new ko(Z,te,U.angleTo(O),k);return ce._round(),!b||Dx(u,ce,S,b,s)?ce:void 0}P+=j}}function eS(u,s,h,f,m,v,b,S,P){const M=Lx(f,v,b),k=Fx(f,m),O=k*b,U=u[0].x===0||u[0].x===P||u[0].y===0||u[0].y===P;return s-O<s/4&&(s=O+s/4),Bx(u,U?s/2*S%s:(k/2+2*v)*b*S%s,s,M,h,O,U,!1,P)}function Bx(u,s,h,f,m,v,b,S,P){const M=v/2,k=Ox(u);let O=0,U=s-h,j=[];for(let $=0;$<u.length-1;$++){const Z=u[$],te=u[$+1],ce=Z.dist(te),Me=te.angleTo(Z);for(;U+h<O+ce;){U+=h;const pe=(U-O)/ce,V=Ur.number(Z.x,te.x,pe),Q=Ur.number(Z.y,te.y,pe);if(V>=0&&V<P&&Q>=0&&Q<P&&U-M>=0&&U+M<=k){const me=new ko(V,Q,Me,$);me._round(),f&&!Dx(u,me,v,f,m)||j.push(me)}}O+=ce}return S||j.length||b||(j=Bx(u,O/2,h,f,m,v,b,!0,P)),j}wt("Anchor",ko);const $u=$r;function Nx(u,s,h,f){const m=[],v=u.image,b=v.pixelRatio,S=v.paddedRect.w-2*$u,P=v.paddedRect.h-2*$u;let M={x1:u.left,y1:u.top,x2:u.right,y2:u.bottom};const k=v.stretchX||[[0,S]],O=v.stretchY||[[0,P]],U=(st,St)=>st+St[1]-St[0],j=k.reduce(U,0),$=O.reduce(U,0),Z=S-j,te=P-$;let ce=0,Me=j,pe=0,V=$,Q=0,me=Z,We=0,lt=te;if(v.content&&f){const st=v.content,St=st[2]-st[0],Ft=st[3]-st[1];(v.textFitWidth||v.textFitHeight)&&(M=ux(u)),ce=$d(k,0,st[0]),pe=$d(O,0,st[1]),Me=$d(k,st[0],st[2]),V=$d(O,st[1],st[3]),Q=st[0]-ce,We=st[1]-pe,me=St-Me,lt=Ft-V}const Ye=M.x1,Qe=M.y1,ft=M.x2-Ye,ut=M.y2-Qe,gt=(st,St,Ft,Ot)=>{const Ct=Wd(st.stretch-ce,Me,ft,Ye),Kt=Hd(st.fixed-Q,me,st.stretch,j),Li=Wd(St.stretch-pe,V,ut,Qe),Ji=Hd(St.fixed-We,lt,St.stretch,$),Tr=Wd(Ft.stretch-ce,Me,ft,Ye),fn=Hd(Ft.fixed-Q,me,Ft.stretch,j),Wr=Wd(Ot.stretch-pe,V,ut,Qe),pr=Hd(Ot.fixed-We,lt,Ot.stretch,$),Ri=new X(Ct,Li),nr=new X(Tr,Li),gr=new X(Tr,Wr),mr=new X(Ct,Wr),Dr=new X(Kt/b,Ji/b),pn=new X(fn/b,pr/b),sr=s*Math.PI/180;if(sr){const or=Math.sin(sr),ar=Math.cos(sr),Wi=[ar,-or,or,ar];Ri._matMult(Wi),nr._matMult(Wi),mr._matMult(Wi),gr._matMult(Wi)}const Hr=st.stretch+st.fixed,Qi=St.stretch+St.fixed;return{tl:Ri,tr:nr,bl:mr,br:gr,tex:{x:v.paddedRect.x+$u+Hr,y:v.paddedRect.y+$u+Qi,w:Ft.stretch+Ft.fixed-Hr,h:Ot.stretch+Ot.fixed-Qi},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Dr,pixelOffsetBR:pn,minFontScaleX:me/b/ft,minFontScaleY:lt/b/ut,isSDF:h}};if(f&&(v.stretchX||v.stretchY)){const st=zx(k,Z,j),St=zx(O,te,$);for(let Ft=0;Ft<st.length-1;Ft++){const Ot=st[Ft],Ct=st[Ft+1];for(let Kt=0;Kt<St.length-1;Kt++)m.push(gt(Ot,St[Kt],Ct,St[Kt+1]))}}else m.push(gt({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:S+1},{fixed:0,stretch:P+1}));return m}function $d(u,s,h){let f=0;for(const m of u)f+=Math.max(s,Math.min(h,m[1]))-Math.max(s,Math.min(h,m[0]));return f}function zx(u,s,h){const f=[{fixed:-1,stretch:0}];for(const[m,v]of u){const b=f[f.length-1];f.push({fixed:m-b.stretch,stretch:b.stretch}),f.push({fixed:m-b.stretch,stretch:b.stretch+(v-m)})}return f.push({fixed:s+$u,stretch:h}),f}function Wd(u,s,h,f){return u/s*h+f}function Hd(u,s,h,f){return u-s*h/f}class Zd{constructor(s,h,f,m,v,b,S,P,M,k){var O;if(this.boxStartIndex=s.length,M){let U=b.top,j=b.bottom;const $=b.collisionPadding;$&&(U-=$[1],j+=$[3]);let Z=j-U;Z>0&&(Z=Math.max(10,Z),this.circleDiameter=Z)}else{const U=!((O=b.image)===null||O===void 0)&&O.content&&(b.image.textFitWidth||b.image.textFitHeight)?ux(b):{x1:b.left,y1:b.top,x2:b.right,y2:b.bottom};U.y1=U.y1*S-P[0],U.y2=U.y2*S+P[2],U.x1=U.x1*S-P[3],U.x2=U.x2*S+P[1];const j=b.collisionPadding;if(j&&(U.x1-=j[0]*S,U.y1-=j[1]*S,U.x2+=j[2]*S,U.y2+=j[3]*S),k){const $=new X(U.x1,U.y1),Z=new X(U.x2,U.y1),te=new X(U.x1,U.y2),ce=new X(U.x2,U.y2),Me=k*Math.PI/180;$._rotate(Me),Z._rotate(Me),te._rotate(Me),ce._rotate(Me),U.x1=Math.min($.x,Z.x,te.x,ce.x),U.x2=Math.max($.x,Z.x,te.x,ce.x),U.y1=Math.min($.y,Z.y,te.y,ce.y),U.y2=Math.max($.y,Z.y,te.y,ce.y)}s.emplaceBack(h.x,h.y,U.x1,U.y1,U.x2,U.y2,f,m,v)}this.boxEndIndex=s.length}}class tS{constructor(s=[],h=((f,m)=>f<m?-1:f>m?1:0)){if(this.data=s,this.length=this.data.length,this.compare=h,this.length>0)for(let f=(this.length>>1)-1;f>=0;f--)this._down(f)}push(s){this.data.push(s),this._up(this.length++)}pop(){if(this.length===0)return;const s=this.data[0],h=this.data.pop();return--this.length>0&&(this.data[0]=h,this._down(0)),s}peek(){return this.data[0]}_up(s){const{data:h,compare:f}=this,m=h[s];for(;s>0;){const v=s-1>>1,b=h[v];if(f(m,b)>=0)break;h[s]=b,s=v}h[s]=m}_down(s){const{data:h,compare:f}=this,m=this.length>>1,v=h[s];for(;s<m;){let b=1+(s<<1);const S=b+1;if(S<this.length&&f(h[S],h[b])<0&&(b=S),f(h[b],v)>=0)break;h[s]=h[b],s=b}h[s]=v}}function iS(u,s=1,h=!1){let f=1/0,m=1/0,v=-1/0,b=-1/0;const S=u[0];for(let j=0;j<S.length;j++){const $=S[j];(!j||$.x<f)&&(f=$.x),(!j||$.y<m)&&(m=$.y),(!j||$.x>v)&&(v=$.x),(!j||$.y>b)&&(b=$.y)}const P=Math.min(v-f,b-m);let M=P/2;const k=new tS([],rS);if(P===0)return new X(f,m);for(let j=f;j<v;j+=P)for(let $=m;$<b;$+=P)k.push(new Hl(j+M,$+M,M,u));let O=(function(j){let $=0,Z=0,te=0;const ce=j[0];for(let Me=0,pe=ce.length,V=pe-1;Me<pe;V=Me++){const Q=ce[Me],me=ce[V],We=Q.x*me.y-me.x*Q.y;Z+=(Q.x+me.x)*We,te+=(Q.y+me.y)*We,$+=3*We}return new Hl(Z/$,te/$,0,j)})(u),U=k.length;for(;k.length;){const j=k.pop();(j.d>O.d||!O.d)&&(O=j,h&&console.log("found best %d after %d probes",Math.round(1e4*j.d)/1e4,U)),j.max-O.d<=s||(M=j.h/2,k.push(new Hl(j.p.x-M,j.p.y-M,M,u)),k.push(new Hl(j.p.x+M,j.p.y-M,M,u)),k.push(new Hl(j.p.x-M,j.p.y+M,M,u)),k.push(new Hl(j.p.x+M,j.p.y+M,M,u)),U+=4)}return h&&(console.log(`num probes: ${U}`),console.log(`best distance: ${O.d}`)),O.p}function rS(u,s){return s.max-u.max}function Hl(u,s,h,f){this.p=new X(u,s),this.h=h,this.d=(function(m,v){let b=!1,S=1/0;for(let P=0;P<v.length;P++){const M=v[P];for(let k=0,O=M.length,U=O-1;k<O;U=k++){const j=M[k],$=M[U];j.y>m.y!=$.y>m.y&&m.x<($.x-j.x)*(m.y-j.y)/($.y-j.y)+j.x&&(b=!b),S=Math.min(S,xy(m,j,$))}}return(b?1:-1)*Math.sqrt(S)})(this.p,f),this.max=this.d+this.h*Math.SQRT2}var wr;d.ax=void 0,(wr=d.ax||(d.ax={}))[wr.center=1]="center",wr[wr.left=2]="left",wr[wr.right=3]="right",wr[wr.top=4]="top",wr[wr.bottom=5]="bottom",wr[wr["top-left"]=6]="top-left",wr[wr["top-right"]=7]="top-right",wr[wr["bottom-left"]=8]="bottom-left",wr[wr["bottom-right"]=9]="bottom-right";const Do=7,Sg=Number.POSITIVE_INFINITY;function Ux(u,s){return s[1]!==Sg?(function(h,f,m){let v=0,b=0;switch(f=Math.abs(f),m=Math.abs(m),h){case"top-right":case"top-left":case"top":b=m-Do;break;case"bottom-right":case"bottom-left":case"bottom":b=-m+Do}switch(h){case"top-right":case"bottom-right":case"right":v=-f;break;case"top-left":case"bottom-left":case"left":v=f}return[v,b]})(u,s[0],s[1]):(function(h,f){let m=0,v=0;f<0&&(f=0);const b=f/Math.SQRT2;switch(h){case"top-right":case"top-left":v=b-Do;break;case"bottom-right":case"bottom-left":v=-b+Do;break;case"bottom":v=-f+Do;break;case"top":v=f-Do}switch(h){case"top-right":case"bottom-right":m=-b;break;case"top-left":case"bottom-left":m=b;break;case"left":m=f;break;case"right":m=-f}return[m,v]})(u,s[0])}function Vx(u,s,h){var f;const m=u.layout,v=(f=m.get("text-variable-anchor-offset"))===null||f===void 0?void 0:f.evaluate(s,{},h);if(v){const S=v.values,P=[];for(let M=0;M<S.length;M+=2){const k=P[M]=S[M],O=S[M+1].map((U=>U*Ki));k.startsWith("top")?O[1]-=Do:k.startsWith("bottom")&&(O[1]+=Do),P[M+1]=O}return new tr(P)}const b=m.get("text-variable-anchor");if(b){let S;S=u._unevaluatedLayout.getValue("text-radial-offset")!==void 0?[m.get("text-radial-offset").evaluate(s,{},h)*Ki,Sg]:m.get("text-offset").evaluate(s,{},h).map((M=>M*Ki));const P=[];for(const M of b)P.push(M,Ux(M,S));return new tr(P)}return null}function Eg(u){switch(u){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function nS(u,s,h,f,m,v,b,S,P,M,k,O){let U=v.textMaxSize.evaluate(s,{});U===void 0&&(U=b);const j=u.layers[0].layout,$=j.get("icon-offset").evaluate(s,{},k),Z=$x(h.horizontal),te=b/24,ce=u.tilePixelRatio*te,Me=u.tilePixelRatio*U/24,pe=u.tilePixelRatio*S,V=u.tilePixelRatio*j.get("symbol-spacing"),Q=j.get("text-padding")*u.tilePixelRatio,me=(function(Ft,Ot,Ct,Kt=1){const Li=Ft.get("icon-padding").evaluate(Ot,{},Ct),Ji=Li&&Li.values;return[Ji[0]*Kt,Ji[1]*Kt,Ji[2]*Kt,Ji[3]*Kt]})(j,s,k,u.tilePixelRatio),We=j.get("text-max-angle")/180*Math.PI,lt=j.get("text-rotation-alignment")!=="viewport"&&j.get("symbol-placement")!=="point",Ye=j.get("icon-rotation-alignment")==="map"&&j.get("symbol-placement")!=="point",Qe=j.get("symbol-placement"),ft=V/2,ut=j.get("icon-text-fit");let gt;f&&ut!=="none"&&(u.allowVerticalPlacement&&h.vertical&&(gt=hx(f,h.vertical,ut,j.get("icon-text-fit-padding"),$,te)),Z&&(f=hx(f,Z,ut,j.get("icon-text-fit-padding"),$,te)));const st=k?O.line.getGranularityForZoomLevel(k.z):1,St=(Ft,Ot)=>{Ot.x<0||Ot.x>=W||Ot.y<0||Ot.y>=W||(function(Ct,Kt,Li,Ji,Tr,fn,Wr,pr,Ri,nr,gr,mr,Dr,pn,sr,Hr,Qi,or,ar,Wi,Ti,Wn,Zl,Hn,aS){const ql=Ct.addToLineVertexArray(Kt,Li);let xa,Xl,Gl,Yl,qx=0,Xx=0,Gx=0,Yx=0,Dg=-1,Og=-1;const Ys={};let Kx=Xi("");if(Ct.allowVerticalPlacement&&Ji.vertical){const Pr=pr.layout.get("text-rotate").evaluate(Ti,{},Hn)+90;Gl=new Zd(Ri,Kt,nr,gr,mr,Ji.vertical,Dr,pn,sr,Pr),Wr&&(Yl=new Zd(Ri,Kt,nr,gr,mr,Wr,Qi,or,sr,Pr))}if(Tr){const Pr=pr.layout.get("icon-rotate").evaluate(Ti,{}),gn=pr.layout.get("icon-text-fit")!=="none",va=Nx(Tr,Pr,Zl,gn),qn=Wr?Nx(Wr,Pr,Zl,gn):void 0;Xl=new Zd(Ri,Kt,nr,gr,mr,Tr,Qi,or,!1,Pr),qx=4*va.length;const ba=Ct.iconSizeData;let ms=null;ba.kind==="source"?(ms=[gs*pr.layout.get("icon-size").evaluate(Ti,{})],ms[0]>Mo&&ci(`${Ct.layerIds[0]}: Value for "icon-size" is >= ${Vu}. Reduce your "icon-size".`)):ba.kind==="composite"&&(ms=[gs*Wn.compositeIconSizes[0].evaluate(Ti,{},Hn),gs*Wn.compositeIconSizes[1].evaluate(Ti,{},Hn)],(ms[0]>Mo||ms[1]>Mo)&&ci(`${Ct.layerIds[0]}: Value for "icon-size" is >= ${Vu}. Reduce your "icon-size".`)),Ct.addSymbols(Ct.icon,va,ms,Wi,ar,Ti,d.ag.none,Kt,ql.lineStartIndex,ql.lineLength,-1,Hn),Dg=Ct.icon.placedSymbolArray.length-1,qn&&(Xx=4*qn.length,Ct.addSymbols(Ct.icon,qn,ms,Wi,ar,Ti,d.ag.vertical,Kt,ql.lineStartIndex,ql.lineLength,-1,Hn),Og=Ct.icon.placedSymbolArray.length-1)}const Jx=Object.keys(Ji.horizontal);for(const Pr of Jx){const gn=Ji.horizontal[Pr];if(!xa){Kx=Xi(gn.text);const qn=pr.layout.get("text-rotate").evaluate(Ti,{},Hn);xa=new Zd(Ri,Kt,nr,gr,mr,gn,Dr,pn,sr,qn)}const va=gn.positionedLines.length===1;if(Gx+=jx(Ct,Kt,gn,fn,pr,sr,Ti,Hr,ql,Ji.vertical?d.ag.horizontal:d.ag.horizontalOnly,va?Jx:[Pr],Ys,Dg,Wn,Hn),va)break}Ji.vertical&&(Yx+=jx(Ct,Kt,Ji.vertical,fn,pr,sr,Ti,Hr,ql,d.ag.vertical,["vertical"],Ys,Og,Wn,Hn));const lS=xa?xa.boxStartIndex:Ct.collisionBoxArray.length,cS=xa?xa.boxEndIndex:Ct.collisionBoxArray.length,uS=Gl?Gl.boxStartIndex:Ct.collisionBoxArray.length,hS=Gl?Gl.boxEndIndex:Ct.collisionBoxArray.length,dS=Xl?Xl.boxStartIndex:Ct.collisionBoxArray.length,fS=Xl?Xl.boxEndIndex:Ct.collisionBoxArray.length,pS=Yl?Yl.boxStartIndex:Ct.collisionBoxArray.length,gS=Yl?Yl.boxEndIndex:Ct.collisionBoxArray.length;let Zn=-1;const Xd=(Pr,gn)=>Pr&&Pr.circleDiameter?Math.max(Pr.circleDiameter,gn):gn;Zn=Xd(xa,Zn),Zn=Xd(Gl,Zn),Zn=Xd(Xl,Zn),Zn=Xd(Yl,Zn);const Qx=Zn>-1?1:0;Qx&&(Zn*=aS/Ki),Ct.glyphOffsetArray.length>=$l.MAX_GLYPHS&&ci("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),Ti.sortKey!==void 0&&Ct.addToSortKeyRanges(Ct.symbolInstances.length,Ti.sortKey);const mS=Vx(pr,Ti,Hn),[_S,yS]=(function(Pr,gn){const va=Pr.length,qn=gn?.values;if(qn?.length>0)for(let ba=0;ba<qn.length;ba+=2){const ms=qn[ba+1];Pr.emplaceBack(d.ax[qn[ba]],ms[0],ms[1])}return[va,Pr.length]})(Ct.textAnchorOffsets,mS);Ct.symbolInstances.emplaceBack(Kt.x,Kt.y,Ys.right>=0?Ys.right:-1,Ys.center>=0?Ys.center:-1,Ys.left>=0?Ys.left:-1,Ys.vertical||-1,Dg,Og,Kx,lS,cS,uS,hS,dS,fS,pS,gS,nr,Gx,Yx,qx,Xx,Qx,0,Dr,Zn,_S,yS)})(u,Ot,Ft,h,f,m,gt,u.layers[0],u.collisionBoxArray,s.index,s.sourceLayerIndex,u.index,ce,[Q,Q,Q,Q],lt,P,pe,me,Ye,$,s,v,M,k,b)};if(Qe==="line")for(const Ft of kx(s.geometry,0,0,W,W)){const Ot=ya(Ft,st),Ct=eS(Ot,V,We,h.vertical||Z,f,24,Me,u.overscaling,W);for(const Kt of Ct)Z&&sS(u,Z.text,ft,Kt)||St(Ot,Kt)}else if(Qe==="line-center"){for(const Ft of s.geometry)if(Ft.length>1){const Ot=ya(Ft,st),Ct=Q2(Ot,We,h.vertical||Z,f,24,Me);Ct&&St(Ot,Ct)}}else if(s.type==="Polygon")for(const Ft of nl(s.geometry,0)){const Ot=iS(Ft,16);St(ya(Ft[0],st,!0),new ko(Ot.x,Ot.y,0))}else if(s.type==="LineString")for(const Ft of s.geometry){const Ot=ya(Ft,st);St(Ot,new ko(Ot[0].x,Ot[0].y,0))}else if(s.type==="Point")for(const Ft of s.geometry)for(const Ot of Ft)St([Ot],new ko(Ot.x,Ot.y,0))}function jx(u,s,h,f,m,v,b,S,P,M,k,O,U,j,$){const Z=(function(Me,pe,V,Q,me,We,lt,Ye){const Qe=Q.layout.get("text-rotate").evaluate(We,{})*Math.PI/180,ft=[];for(const ut of pe.positionedLines)for(const gt of ut.positionedGlyphs){if(!gt.rect)continue;const st=gt.rect||{};let St=k2+1,Ft=!0,Ot=1,Ct=0;const Kt=(me||Ye)&&gt.vertical,Li=gt.metrics.advance*gt.scale/2;if(Ye&&pe.verticalizable&&(Ct=ut.lineOffset/2-(gt.imageName?-(Ki-gt.metrics.width*gt.scale)/2:(gt.scale-1)*Ki)),gt.imageName){const or=lt[gt.imageName];Ft=or.sdf,Ot=or.pixelRatio,St=$r/Ot}const Ji=me?[gt.x+Li,gt.y]:[0,0];let Tr=me?[0,0]:[gt.x+Li+V[0],gt.y+V[1]-Ct],fn=[0,0];Kt&&(fn=Tr,Tr=[0,0]);const Wr=gt.metrics.isDoubleResolution?2:1,pr=(gt.metrics.left-St)*gt.scale-Li+Tr[0],Ri=(-gt.metrics.top-St)*gt.scale+Tr[1],nr=pr+st.w/Wr*gt.scale/Ot,gr=Ri+st.h/Wr*gt.scale/Ot,mr=new X(pr,Ri),Dr=new X(nr,Ri),pn=new X(pr,gr),sr=new X(nr,gr);if(Kt){const or=new X(-Li,Li-Nd),ar=-Math.PI/2,Wi=Ki/2-Li,Ti=new X(5-Nd-Wi,-(gt.imageName?Wi:0)),Wn=new X(...fn);mr._rotateAround(ar,or)._add(Ti)._add(Wn),Dr._rotateAround(ar,or)._add(Ti)._add(Wn),pn._rotateAround(ar,or)._add(Ti)._add(Wn),sr._rotateAround(ar,or)._add(Ti)._add(Wn)}if(Qe){const or=Math.sin(Qe),ar=Math.cos(Qe),Wi=[ar,-or,or,ar];mr._matMult(Wi),Dr._matMult(Wi),pn._matMult(Wi),sr._matMult(Wi)}const Hr=new X(0,0),Qi=new X(0,0);ft.push({tl:mr,tr:Dr,bl:pn,br:sr,tex:st,writingMode:pe.writingMode,glyphOffset:Ji,sectionIndex:gt.sectionIndex,isSDF:Ft,pixelOffsetTL:Hr,pixelOffsetBR:Qi,minFontScaleX:0,minFontScaleY:0})}return ft})(0,h,S,m,v,b,f,u.allowVerticalPlacement),te=u.textSizeData;let ce=null;te.kind==="source"?(ce=[gs*m.layout.get("text-size").evaluate(b,{})],ce[0]>Mo&&ci(`${u.layerIds[0]}: Value for "text-size" is >= ${Vu}. Reduce your "text-size".`)):te.kind==="composite"&&(ce=[gs*j.compositeTextSizes[0].evaluate(b,{},$),gs*j.compositeTextSizes[1].evaluate(b,{},$)],(ce[0]>Mo||ce[1]>Mo)&&ci(`${u.layerIds[0]}: Value for "text-size" is >= ${Vu}. Reduce your "text-size".`)),u.addSymbols(u.text,Z,ce,S,v,b,M,s,P.lineStartIndex,P.lineLength,U,$);for(const Me of k)O[Me]=u.text.placedSymbolArray.length-1;return 4*Z.length}function $x(u){for(const s in u)return u[s];return null}function sS(u,s,h,f){const m=u.compareText;if(s in m){const v=m[s];for(let b=v.length-1;b>=0;b--)if(f.dist(v[b])<h)return!0}else m[s]=[];return m[s].push(f),!1}const Wx=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Ag{static from(s){if(!(s instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[h,f]=new Uint8Array(s,0,2);if(h!==219)throw new Error("Data does not appear to be in a KDBush format.");const m=f>>4;if(m!==1)throw new Error(`Got v${m} data when expected v1.`);const v=Wx[15&f];if(!v)throw new Error("Unrecognized array type.");const[b]=new Uint16Array(s,2,1),[S]=new Uint32Array(s,4,1);return new Ag(S,b,v,s)}constructor(s,h=64,f=Float64Array,m){if(isNaN(s)||s<0)throw new Error(`Unpexpected numItems value: ${s}.`);this.numItems=+s,this.nodeSize=Math.min(Math.max(+h,2),65535),this.ArrayType=f,this.IndexArrayType=s<65536?Uint16Array:Uint32Array;const v=Wx.indexOf(this.ArrayType),b=2*s*this.ArrayType.BYTES_PER_ELEMENT,S=s*this.IndexArrayType.BYTES_PER_ELEMENT,P=(8-S%8)%8;if(v<0)throw new Error(`Unexpected typed array class: ${f}.`);m&&m instanceof ArrayBuffer?(this.data=m,this.ids=new this.IndexArrayType(this.data,8,s),this.coords=new this.ArrayType(this.data,8+S+P,2*s),this._pos=2*s,this._finished=!0):(this.data=new ArrayBuffer(8+b+S+P),this.ids=new this.IndexArrayType(this.data,8,s),this.coords=new this.ArrayType(this.data,8+S+P,2*s),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+v]),new Uint16Array(this.data,2,1)[0]=h,new Uint32Array(this.data,4,1)[0]=s)}add(s,h){const f=this._pos>>1;return this.ids[f]=f,this.coords[this._pos++]=s,this.coords[this._pos++]=h,f}finish(){const s=this._pos>>1;if(s!==this.numItems)throw new Error(`Added ${s} items when expected ${this.numItems}.`);return Pg(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(s,h,f,m){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:v,coords:b,nodeSize:S}=this,P=[0,v.length-1,0],M=[];for(;P.length;){const k=P.pop()||0,O=P.pop()||0,U=P.pop()||0;if(O-U<=S){for(let te=U;te<=O;te++){const ce=b[2*te],Me=b[2*te+1];ce>=s&&ce<=f&&Me>=h&&Me<=m&&M.push(v[te])}continue}const j=U+O>>1,$=b[2*j],Z=b[2*j+1];$>=s&&$<=f&&Z>=h&&Z<=m&&M.push(v[j]),(k===0?s<=$:h<=Z)&&(P.push(U),P.push(j-1),P.push(1-k)),(k===0?f>=$:m>=Z)&&(P.push(j+1),P.push(O),P.push(1-k))}return M}within(s,h,f){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:m,coords:v,nodeSize:b}=this,S=[0,m.length-1,0],P=[],M=f*f;for(;S.length;){const k=S.pop()||0,O=S.pop()||0,U=S.pop()||0;if(O-U<=b){for(let te=U;te<=O;te++)Zx(v[2*te],v[2*te+1],s,h)<=M&&P.push(m[te]);continue}const j=U+O>>1,$=v[2*j],Z=v[2*j+1];Zx($,Z,s,h)<=M&&P.push(m[j]),(k===0?s-f<=$:h-f<=Z)&&(S.push(U),S.push(j-1),S.push(1-k)),(k===0?s+f>=$:h+f>=Z)&&(S.push(j+1),S.push(O),S.push(1-k))}return P}}function Pg(u,s,h,f,m,v){if(m-f<=h)return;const b=f+m>>1;Hx(u,s,b,f,m,v),Pg(u,s,h,f,b-1,1-v),Pg(u,s,h,b+1,m,1-v)}function Hx(u,s,h,f,m,v){for(;m>f;){if(m-f>600){const M=m-f+1,k=h-f+1,O=Math.log(M),U=.5*Math.exp(2*O/3),j=.5*Math.sqrt(O*U*(M-U)/M)*(k-M/2<0?-1:1);Hx(u,s,h,Math.max(f,Math.floor(h-k*U/M+j)),Math.min(m,Math.floor(h+(M-k)*U/M+j)),v)}const b=s[2*h+v];let S=f,P=m;for(Wu(u,s,f,h),s[2*m+v]>b&&Wu(u,s,f,m);S<P;){for(Wu(u,s,S,P),S++,P--;s[2*S+v]<b;)S++;for(;s[2*P+v]>b;)P--}s[2*f+v]===b?Wu(u,s,f,P):(P++,Wu(u,s,P,m)),P<=h&&(f=P+1),h<=P&&(m=P-1)}}function Wu(u,s,h,f){Cg(u,h,f),Cg(s,2*h,2*f),Cg(s,2*h+1,2*f+1)}function Cg(u,s,h){const f=u[s];u[s]=u[h],u[h]=f}function Zx(u,s,h,f){const m=u-h,v=s-f;return m*m+v*v}var Ig;d.cg=void 0,(Ig=d.cg||(d.cg={})).create="create",Ig.load="load",Ig.fullLoad="fullLoad";let qd=null,Hu=[];const Mg=1e3/60,Rg="loadTime",kg="fullLoadTime",oS={mark(u){performance.mark(u)},frame(u){const s=u;qd!=null&&Hu.push(s-qd),qd=s},clearMetrics(){qd=null,Hu=[],performance.clearMeasures(Rg),performance.clearMeasures(kg);for(const u in d.cg)performance.clearMarks(d.cg[u])},getPerformanceMetrics(){performance.measure(Rg,d.cg.create,d.cg.load),performance.measure(kg,d.cg.create,d.cg.fullLoad);const u=performance.getEntriesByName(Rg)[0].duration,s=performance.getEntriesByName(kg)[0].duration,h=Hu.length,f=1/(Hu.reduce(((v,b)=>v+b),0)/h/1e3),m=Hu.filter((v=>v>Mg)).reduce(((v,b)=>v+(b-Mg)/Mg),0);return{loadTime:u,fullLoadTime:s,fps:f,percentDroppedFrames:m/(h+m)*100,totalFrames:h}}};d.$=ju,d.A=mt,d.B=Ur,d.C=Ci,d.D=Mt,d.E=Ne,d.F=xd,d.G=function(u){if(Yt==null){const s=u.navigator?u.navigator.userAgent:null;Yt=!!u.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Yt},d.H=class{constructor(u,s){this.target=u,this.mapId=s,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new Y2((()=>this.process())),this.subscription=bn(this.target,"message",(h=>this.receive(h)),!1),this.globalScope=Ai(self)?u:window}registerMessageHandler(u,s){this.messageHandlers[u]=s}sendAsync(u,s){return new Promise(((h,f)=>{const m=Math.round(1e18*Math.random()).toString(36).substring(0,10),v=s?bn(s.signal,"abort",(()=>{v?.unsubscribe(),delete this.resolveRejects[m];const P={id:m,type:"<cancel>",origin:location.origin,targetMapId:u.targetMapId,sourceMapId:this.mapId};this.target.postMessage(P)}),K2):null;this.resolveRejects[m]={resolve:P=>{v?.unsubscribe(),h(P)},reject:P=>{v?.unsubscribe(),f(P)}};const b=[],S=Object.assign(Object.assign({},u),{id:m,sourceMapId:this.mapId,origin:location.origin,data:ds(u.data,b)});this.target.postMessage(S,{transfer:b})}))}receive(u){const s=u.data,h=s.id;if(!(s.origin!=="file://"&&location.origin!=="file://"&&s.origin!=="resource://android"&&location.origin!=="resource://android"&&s.origin!==location.origin||s.targetMapId&&this.mapId!==s.targetMapId)){if(s.type==="<cancel>"){delete this.tasks[h];const f=this.abortControllers[h];return delete this.abortControllers[h],void(f&&f.abort())}if(Ai(self)||s.mustQueue)return this.tasks[h]=s,this.taskQueue.push(h),void this.invoker.trigger();this.processTask(h,s)}}process(){if(this.taskQueue.length===0)return;const u=this.taskQueue.shift(),s=this.tasks[u];delete this.tasks[u],this.taskQueue.length>0&&this.invoker.trigger(),s&&this.processTask(u,s)}processTask(u,s){return a(this,void 0,void 0,(function*(){if(s.type==="<response>"){const m=this.resolveRejects[u];return delete this.resolveRejects[u],m?void(s.error?m.reject(ha(s.error)):m.resolve(ha(s.data))):void 0}if(!this.messageHandlers[s.type])return void this.completeTask(u,new Error(`Could not find a registered handler for ${s.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const h=ha(s.data),f=new AbortController;this.abortControllers[u]=f;try{const m=yield this.messageHandlers[s.type](s.sourceMapId,h,f);this.completeTask(u,null,m)}catch(m){this.completeTask(u,m)}}))}completeTask(u,s,h){const f=[];delete this.abortControllers[u];const m={id:u,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:s?ds(s):null,data:ds(h,f)};this.target.postMessage(m,{transfer:f})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},d.I=fg,d.J=Is,d.K=function(){var u=new mt(16);return mt!=Float32Array&&(u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[11]=0,u[12]=0,u[13]=0,u[14]=0),u[0]=1,u[5]=1,u[10]=1,u[15]=1,u},d.L=function(u,s,h){var f,m,v,b,S,P,M,k,O,U,j,$,Z=h[0],te=h[1],ce=h[2];return s===u?(u[12]=s[0]*Z+s[4]*te+s[8]*ce+s[12],u[13]=s[1]*Z+s[5]*te+s[9]*ce+s[13],u[14]=s[2]*Z+s[6]*te+s[10]*ce+s[14],u[15]=s[3]*Z+s[7]*te+s[11]*ce+s[15]):(m=s[1],v=s[2],b=s[3],S=s[4],P=s[5],M=s[6],k=s[7],O=s[8],U=s[9],j=s[10],$=s[11],u[0]=f=s[0],u[1]=m,u[2]=v,u[3]=b,u[4]=S,u[5]=P,u[6]=M,u[7]=k,u[8]=O,u[9]=U,u[10]=j,u[11]=$,u[12]=f*Z+S*te+O*ce+s[12],u[13]=m*Z+P*te+U*ce+s[13],u[14]=v*Z+M*te+j*ce+s[14],u[15]=b*Z+k*te+$*ce+s[15]),u},d.M=function(u,s,h){var f=h[0],m=h[1],v=h[2];return u[0]=s[0]*f,u[1]=s[1]*f,u[2]=s[2]*f,u[3]=s[3]*f,u[4]=s[4]*m,u[5]=s[5]*m,u[6]=s[6]*m,u[7]=s[7]*m,u[8]=s[8]*v,u[9]=s[9]*v,u[10]=s[10]*v,u[11]=s[11]*v,u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15],u},d.N=function(u,s,h){var f=s[0],m=s[1],v=s[2],b=s[3],S=s[4],P=s[5],M=s[6],k=s[7],O=s[8],U=s[9],j=s[10],$=s[11],Z=s[12],te=s[13],ce=s[14],Me=s[15],pe=h[0],V=h[1],Q=h[2],me=h[3];return u[0]=pe*f+V*S+Q*O+me*Z,u[1]=pe*m+V*P+Q*U+me*te,u[2]=pe*v+V*M+Q*j+me*ce,u[3]=pe*b+V*k+Q*$+me*Me,u[4]=(pe=h[4])*f+(V=h[5])*S+(Q=h[6])*O+(me=h[7])*Z,u[5]=pe*m+V*P+Q*U+me*te,u[6]=pe*v+V*M+Q*j+me*ce,u[7]=pe*b+V*k+Q*$+me*Me,u[8]=(pe=h[8])*f+(V=h[9])*S+(Q=h[10])*O+(me=h[11])*Z,u[9]=pe*m+V*P+Q*U+me*te,u[10]=pe*v+V*M+Q*j+me*ce,u[11]=pe*b+V*k+Q*$+me*Me,u[12]=(pe=h[12])*f+(V=h[13])*S+(Q=h[14])*O+(me=h[15])*Z,u[13]=pe*m+V*P+Q*U+me*te,u[14]=pe*v+V*M+Q*j+me*ce,u[15]=pe*b+V*k+Q*$+me*Me,u},d.O=function(u,s){const h={};for(let f=0;f<s.length;f++){const m=s[f];m in u&&(h[m]=u[m])}return h},d.P=X,d.Q=Ro,d.R=hn,d.S=bx,d.T=xu,d.U=vx,d.V=Te,d.W=ke,d.X=sn,d.Y=dn,d.Z=W,d._=a,d.a=Cs,d.a$=function(){const u=new Float32Array(16);return J(u),u},d.a0=Tg,d.a1=u=>{const s=window.document.createElement("video");return s.muted=!0,new Promise((h=>{s.onloadstart=()=>{h(s)};for(const f of u){const m=window.document.createElement("source");os(f)||(s.crossOrigin="Anonymous"),m.src=f,s.appendChild(m)}}))},d.a2=Ue,d.a3=function(){return Lt++},d.a4=T,d.a5=$l,d.a6=xl,d.a7=jr,d.a8=Cx,d.a9=function(u){const s={};if(u.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((h,f,m,v)=>{const b=m||v;return s[f]=!b||b.toLowerCase(),""})),s["max-age"]){const h=parseInt(s["max-age"],10);isNaN(h)?delete s["max-age"]:s["max-age"]=h}return s},d.aA=gg,d.aB=Ag,d.aC=zi,d.aD=Ld,d.aE=le,d.aF=Rt,d.aG=xt,d.aH=function(u){return Math.pow(2,u)},d.aI=85.051129,d.aJ=wx,d.aK=bt,d.aL=on,d.aM=Tx,d.aN=function(u,s,h){return u[0]=s[0]*h,u[1]=s[1]*h,u[2]=s[2]*h,u},d.aO=function(u,s,h){return u[0]=s[0]+h[0],u[1]=s[1]+h[1],u[2]=s[2]+h[2],u},d.aP=function(u){var s=new mt(3);return s[0]=u[0],s[1]=u[1],s[2]=u[2],s},d.aQ=function(u,s,h){return u[0]=s[0]*h[0],u[1]=s[1]*h[1],u[2]=s[2]*h[2],u[3]=s[3]*h[3],u},d.aR=function(u,s,h){return u[0]=s[0]-h[0],u[1]=s[1]-h[1],u[2]=s[2]-h[2],u},d.aS=function(u,s){var h=s[0],f=s[1],m=s[2],v=h*h+f*f+m*m;return v>0&&(v=1/Math.sqrt(v)),u[0]=s[0]*v,u[1]=s[1]*v,u[2]=s[2]*v,u},d.aT=function(u,s,h){var f=s[0],m=s[1],v=s[2],b=h[0],S=h[1],P=h[2];return u[0]=m*P-v*S,u[1]=v*b-f*P,u[2]=f*S-m*b,u},d.aU=function(u,s){return u[0]*s[0]+u[1]*s[1]+u[2]*s[2]},d.aV=Ex,d.aW=Wl,d.aX=function(u,s,h,f,m){var v,b=1/Math.tan(s/2);return u[0]=b/h,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=b,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[11]=-1,u[12]=0,u[13]=0,u[15]=0,m!=null&&m!==1/0?(u[10]=(m+f)*(v=1/(f-m)),u[14]=2*m*f*v):(u[10]=-1,u[14]=-2*f),u},d.aY=function(u){var s=new mt(16);return s[0]=u[0],s[1]=u[1],s[2]=u[2],s[3]=u[3],s[4]=u[4],s[5]=u[5],s[6]=u[6],s[7]=u[7],s[8]=u[8],s[9]=u[9],s[10]=u[10],s[11]=u[11],s[12]=u[12],s[13]=u[13],s[14]=u[14],s[15]=u[15],s},d.aZ=function(u,s,h){var f=Math.sin(h),m=Math.cos(h),v=s[0],b=s[1],S=s[2],P=s[3],M=s[4],k=s[5],O=s[6],U=s[7];return s!==u&&(u[8]=s[8],u[9]=s[9],u[10]=s[10],u[11]=s[11],u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15]),u[0]=v*m+M*f,u[1]=b*m+k*f,u[2]=S*m+O*f,u[3]=P*m+U*f,u[4]=M*m-v*f,u[5]=k*m-b*f,u[6]=O*m-S*f,u[7]=U*m-P*f,u},d.a_=function(u,s,h){var f=Math.sin(h),m=Math.cos(h),v=s[4],b=s[5],S=s[6],P=s[7],M=s[8],k=s[9],O=s[10],U=s[11];return s!==u&&(u[0]=s[0],u[1]=s[1],u[2]=s[2],u[3]=s[3],u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15]),u[4]=v*m+M*f,u[5]=b*m+k*f,u[6]=S*m+O*f,u[7]=P*m+U*f,u[8]=M*m-v*f,u[9]=k*m-b*f,u[10]=O*m-S*f,u[11]=U*m-P*f,u},d.aa=function(u){return Math.log(u)/Math.LN2},d.ab=function(u){var s=u[0],h=u[1];return s*s+h*h},d.ac=function(u){return u*Math.PI/180},d.ad=pt,d.ae=function(u,s){const h=[];for(const f in u)f in s||h.push(f);return h},d.af=function(u,s){let h=0,f=0;if(u.kind==="constant")f=u.layoutSize;else if(u.kind!=="source"){const{interpolationType:m,minZoom:v,maxZoom:b}=u,S=m?pt(br.interpolationFactor(m,s,v,b),0,1):0;u.kind==="camera"?f=Ur.number(u.minSize,u.maxSize,S):h=S}return{uSizeT:h,uSize:f}},d.ah=function(u,{uSize:s,uSizeT:h},{lowerSize:f,upperSize:m}){return u.kind==="source"?f/gs:u.kind==="composite"?Ur.number(f/gs,m/gs,h):s},d.ai=function(u,s){var h=s[0],f=s[1],m=s[2],v=s[3],b=s[4],S=s[5],P=s[6],M=s[7],k=s[8],O=s[9],U=s[10],j=s[11],$=s[12],Z=s[13],te=s[14],ce=s[15],Me=h*S-f*b,pe=h*P-m*b,V=h*M-v*b,Q=f*P-m*S,me=f*M-v*S,We=m*M-v*P,lt=k*Z-O*$,Ye=k*te-U*$,Qe=k*ce-j*$,ft=O*te-U*Z,ut=O*ce-j*Z,gt=U*ce-j*te,st=Me*gt-pe*ut+V*ft+Q*Qe-me*Ye+We*lt;return st?(u[0]=(S*gt-P*ut+M*ft)*(st=1/st),u[1]=(m*ut-f*gt-v*ft)*st,u[2]=(Z*We-te*me+ce*Q)*st,u[3]=(U*me-O*We-j*Q)*st,u[4]=(P*Qe-b*gt-M*Ye)*st,u[5]=(h*gt-m*Qe+v*Ye)*st,u[6]=(te*V-$*We-ce*pe)*st,u[7]=(k*We-U*V+j*pe)*st,u[8]=(b*ut-S*Qe+M*lt)*st,u[9]=(f*Qe-h*ut-v*lt)*st,u[10]=($*me-Z*V+ce*Me)*st,u[11]=(O*V-k*me-j*Me)*st,u[12]=(S*Ye-b*ft-P*lt)*st,u[13]=(h*ft-f*Ye+m*lt)*st,u[14]=(Z*pe-$*Q-te*Me)*st,u[15]=(k*Q-O*pe+U*Me)*st,u):null},d.aj=Se,d.ak=function(u){return Math.hypot(u[0],u[1])},d.al=function(u){return u[0]=0,u[1]=0,u},d.am=function(u,s,h){return u[0]=s[0]*h,u[1]=s[1]*h,u},d.an=_g,d.ao=ye,d.ap=function(u,s,h,f){const m=s.y-u.y,v=s.x-u.x,b=f.y-h.y,S=f.x-h.x,P=b*v-S*m;if(P===0)return null;const M=(S*(u.y-h.y)-b*(u.x-h.x))/P;return new X(u.x+M*v,u.y+M*m)},d.aq=kx,d.ar=Fl,d.as=J,d.at=function(u){let s=1/0,h=1/0,f=-1/0,m=-1/0;for(const v of u)s=Math.min(s,v.x),h=Math.min(h,v.y),f=Math.max(f,v.x),m=Math.max(m,v.y);return[s,h,f,m]},d.au=Ki,d.av=ee,d.aw=function(u,s,h,f,m=!1){if(!h[0]&&!h[1])return[0,0];const v=m?f==="map"?-u.bearingInRadians:0:f==="viewport"?u.bearingInRadians:0;if(v){const b=Math.sin(v),S=Math.cos(v);h=[h[0]*S-h[1]*b,h[0]*b+h[1]*S]}return[m?h[0]:ee(s,h[0],u.zoom),m?h[1]:ee(s,h[1],u.zoom)]},d.ay=mg,d.az=Eg,d.b=kt,d.b$=u=>u.type==="circle",d.b0=function(){const u=new Float64Array(16);return J(u),u},d.b1=function(){return new Float64Array(16)},d.b2=function(u,s,h){const f=new Float64Array(4);return(function(m,v,b,S){var P=.5*Math.PI/180;v*=P,b*=P,S*=P;var M=Math.sin(v),k=Math.cos(v),O=Math.sin(b),U=Math.cos(b),j=Math.sin(S),$=Math.cos(S);m[0]=M*U*$-k*O*j,m[1]=k*O*$+M*U*j,m[2]=k*U*j-M*O*$,m[3]=k*U*$+M*O*j})(f,u,s-90,h),f},d.b3=function(u,s,h,f){var m,v,b,S,P,M=s[0],k=s[1],O=s[2],U=s[3],j=h[0],$=h[1],Z=h[2],te=h[3];return(v=M*j+k*$+O*Z+U*te)<0&&(v=-v,j=-j,$=-$,Z=-Z,te=-te),1-v>Xe?(m=Math.acos(v),b=Math.sin(m),S=Math.sin((1-f)*m)/b,P=Math.sin(f*m)/b):(S=1-f,P=f),u[0]=S*M+P*j,u[1]=S*k+P*$,u[2]=S*O+P*Z,u[3]=S*U+P*te,u},d.b4=function(u){const s=new Float64Array(9);var h,f,m,v,b,S,P,M,k,O,U,j,$,Z,te,ce,Me,pe;O=(m=(f=u)[0])*(P=m+m),U=(v=f[1])*P,$=(b=f[2])*P,Z=b*(M=v+v),ce=(S=f[3])*P,Me=S*M,pe=S*(k=b+b),(h=s)[0]=1-(j=v*M)-(te=b*k),h[3]=U-pe,h[6]=$+Me,h[1]=U+pe,h[4]=1-O-te,h[7]=Z-ce,h[2]=$-Me,h[5]=Z+ce,h[8]=1-O-j;const V=on(-Math.asin(pt(s[2],-1,1)));let Q,me;return Math.hypot(s[5],s[8])<.001?(Q=0,me=-on(Math.atan2(s[3],s[4]))):(Q=on(s[5]===0&&s[8]===0?0:Math.atan2(s[5],s[8])),me=on(s[1]===0&&s[0]===0?0:Math.atan2(s[1],s[0]))),{roll:Q,pitch:V+90,bearing:me}},d.b5=function(u,s){return u.roll==s.roll&&u.pitch==s.pitch&&u.bearing==s.bearing},d.b6=ni,d.b7=Zs,d.b8=Vl,d.b9=Ou,d.bA=function(u){const s=[],h=u.id;return h===void 0&&s.push({message:`layers.${h}: missing required property "id"`}),u.render===void 0&&s.push({message:`layers.${h}: missing required method "render"`}),u.renderingMode&&u.renderingMode!=="2d"&&u.renderingMode!=="3d"&&s.push({message:`layers.${h}: property "renderingMode" must be either "2d" or "3d"`}),s},d.bB=function u(s,h){if(Array.isArray(s)){if(!Array.isArray(h)||s.length!==h.length)return!1;for(let f=0;f<s.length;f++)if(!u(s[f],h[f]))return!1;return!0}if(typeof s=="object"&&s!==null&&h!==null){if(typeof h!="object"||Object.keys(s).length!==Object.keys(h).length)return!1;for(const f in s)if(!u(s[f],h[f]))return!1;return!0}return s===h},d.bC=Ut,d.bD=Wt,d.bE=class extends tn{constructor(u,s){super(u,s),this.current=0}set(u){this.current!==u&&(this.current=u,this.gl.uniform1i(this.location,u))}},d.bF=qs,d.bG=class extends tn{constructor(u,s){super(u,s),this.current=rn}set(u){if(u[12]!==this.current[12]||u[0]!==this.current[0])return this.current=u,void this.gl.uniformMatrix4fv(this.location,!1,u);for(let s=1;s<16;s++)if(u[s]!==this.current[s]){this.current=u,this.gl.uniformMatrix4fv(this.location,!1,u);break}}},d.bH=ma,d.bI=class extends tn{constructor(u,s){super(u,s),this.current=[0,0,0]}set(u){u[0]===this.current[0]&&u[1]===this.current[1]&&u[2]===this.current[2]||(this.current=u,this.gl.uniform3f(this.location,u[0],u[1],u[2]))}},d.bJ=class extends tn{constructor(u,s){super(u,s),this.current=[0,0]}set(u){u[0]===this.current[0]&&u[1]===this.current[1]||(this.current=u,this.gl.uniform2f(this.location,u[0],u[1]))}},d.bK=G,d.bL=function(u,s){var h=Math.sin(s),f=Math.cos(s);return u[0]=f,u[1]=h,u[2]=0,u[3]=-h,u[4]=f,u[5]=0,u[6]=0,u[7]=0,u[8]=1,u},d.bM=function(u,s,h){var f=s[0],m=s[1],v=s[2];return u[0]=f*h[0]+m*h[3]+v*h[6],u[1]=f*h[1]+m*h[4]+v*h[7],u[2]=f*h[2]+m*h[5]+v*h[8],u},d.bN=function(u,s,h,f,m,v,b){var S=1/(s-h),P=1/(f-m),M=1/(v-b);return u[0]=-2*S,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*P,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*M,u[11]=0,u[12]=(s+h)*S,u[13]=(m+f)*P,u[14]=(b+v)*M,u[15]=1,u},d.bO=class extends Rl{},d.bP=A2,d.bQ=class extends kl{},d.bR=Kp,d.bS=function(u){return u<=1?1:Math.pow(2,Math.ceil(Math.log(u)/Math.LN2))},d.bT=Py,d.bU=function(u,s,h){var f=s[0],m=s[1],v=s[2],b=h[3]*f+h[7]*m+h[11]*v+h[15];return u[0]=(h[0]*f+h[4]*m+h[8]*v+h[12])/(b=b||1),u[1]=(h[1]*f+h[5]*m+h[9]*v+h[13])/b,u[2]=(h[2]*f+h[6]*m+h[10]*v+h[14])/b,u},d.bV=class extends wu{},d.bW=class extends p{},d.bX=function(u,s){return u[0]===s[0]&&u[1]===s[1]&&u[2]===s[2]&&u[3]===s[3]&&u[4]===s[4]&&u[5]===s[5]&&u[6]===s[6]&&u[7]===s[7]&&u[8]===s[8]&&u[9]===s[9]&&u[10]===s[10]&&u[11]===s[11]&&u[12]===s[12]&&u[13]===s[13]&&u[14]===s[14]&&u[15]===s[15]},d.bY=function(u,s){var h=u[0],f=u[1],m=u[2],v=u[3],b=u[4],S=u[5],P=u[6],M=u[7],k=u[8],O=u[9],U=u[10],j=u[11],$=u[12],Z=u[13],te=u[14],ce=u[15],Me=s[0],pe=s[1],V=s[2],Q=s[3],me=s[4],We=s[5],lt=s[6],Ye=s[7],Qe=s[8],ft=s[9],ut=s[10],gt=s[11],st=s[12],St=s[13],Ft=s[14],Ot=s[15];return Math.abs(h-Me)<=Xe*Math.max(1,Math.abs(h),Math.abs(Me))&&Math.abs(f-pe)<=Xe*Math.max(1,Math.abs(f),Math.abs(pe))&&Math.abs(m-V)<=Xe*Math.max(1,Math.abs(m),Math.abs(V))&&Math.abs(v-Q)<=Xe*Math.max(1,Math.abs(v),Math.abs(Q))&&Math.abs(b-me)<=Xe*Math.max(1,Math.abs(b),Math.abs(me))&&Math.abs(S-We)<=Xe*Math.max(1,Math.abs(S),Math.abs(We))&&Math.abs(P-lt)<=Xe*Math.max(1,Math.abs(P),Math.abs(lt))&&Math.abs(M-Ye)<=Xe*Math.max(1,Math.abs(M),Math.abs(Ye))&&Math.abs(k-Qe)<=Xe*Math.max(1,Math.abs(k),Math.abs(Qe))&&Math.abs(O-ft)<=Xe*Math.max(1,Math.abs(O),Math.abs(ft))&&Math.abs(U-ut)<=Xe*Math.max(1,Math.abs(U),Math.abs(ut))&&Math.abs(j-gt)<=Xe*Math.max(1,Math.abs(j),Math.abs(gt))&&Math.abs($-st)<=Xe*Math.max(1,Math.abs($),Math.abs(st))&&Math.abs(Z-St)<=Xe*Math.max(1,Math.abs(Z),Math.abs(St))&&Math.abs(te-Ft)<=Xe*Math.max(1,Math.abs(te),Math.abs(Ft))&&Math.abs(ce-Ot)<=Xe*Math.max(1,Math.abs(ce),Math.abs(Ot))},d.bZ=function(u,s){return u[0]=s[0],u[1]=s[1],u[2]=s[2],u[3]=s[3],u[4]=s[4],u[5]=s[5],u[6]=s[6],u[7]=s[7],u[8]=s[8],u[9]=s[9],u[10]=s[10],u[11]=s[11],u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15],u},d.b_=u=>u.type==="symbol",d.ba=Ul,d.bb=Ce,d.bc=je,d.bd=Ir,d.be=function(u,s,h,f,m){return Ce(f,m,pt((u-s)/(h-s),0,1))},d.bf=K,d.bg=function(){return new Float64Array(4)},d.bh=function(){return new Float64Array(3)},d.bi=function(u,s,h,f){var m=[],v=[];return m[0]=s[0]-h[0],m[1]=s[1]-h[1],m[2]=s[2]-h[2],v[0]=m[0]*Math.cos(f)-m[1]*Math.sin(f),v[1]=m[0]*Math.sin(f)+m[1]*Math.cos(f),v[2]=m[2],u[0]=v[0]+h[0],u[1]=v[1]+h[1],u[2]=v[2]+h[2],u},d.bj=function(u,s,h,f){var m=[],v=[];return m[0]=s[0]-h[0],m[1]=s[1]-h[1],m[2]=s[2]-h[2],v[0]=m[0],v[1]=m[1]*Math.cos(f)-m[2]*Math.sin(f),v[2]=m[1]*Math.sin(f)+m[2]*Math.cos(f),u[0]=v[0]+h[0],u[1]=v[1]+h[1],u[2]=v[2]+h[2],u},d.bk=function(u,s,h,f){var m=[],v=[];return m[0]=s[0]-h[0],m[1]=s[1]-h[1],m[2]=s[2]-h[2],v[0]=m[2]*Math.sin(f)+m[0]*Math.cos(f),v[1]=m[1],v[2]=m[2]*Math.cos(f)-m[0]*Math.sin(f),u[0]=v[0]+h[0],u[1]=v[1]+h[1],u[2]=v[2]+h[2],u},d.bl=function(u,s,h){var f=Math.sin(h),m=Math.cos(h),v=s[0],b=s[1],S=s[2],P=s[3],M=s[8],k=s[9],O=s[10],U=s[11];return s!==u&&(u[4]=s[4],u[5]=s[5],u[6]=s[6],u[7]=s[7],u[12]=s[12],u[13]=s[13],u[14]=s[14],u[15]=s[15]),u[0]=v*m-M*f,u[1]=b*m-k*f,u[2]=S*m-O*f,u[3]=P*m-U*f,u[8]=v*f+M*m,u[9]=b*f+k*m,u[10]=S*f+O*m,u[11]=P*f+U*m,u},d.bm=function(u,s){const h=K(u,360),f=K(s,360),m=f-h,v=f>h?m-360:m+360;return Math.abs(m)<Math.abs(v)?m:v},d.bn=function(u){return u[0]=0,u[1]=0,u[2]=0,u},d.bo=function(u,s,h,f){const m=Math.sqrt(u*u+s*s),v=Math.sqrt(h*h+f*f);u/=m,s/=m,h/=v,f/=v;const b=Math.acos(u*h+s*f);return-s*h+u*f>0?b:-b},d.bp=function(u,s){return u[0]*s[0]+u[1]*s[1]+u[2]*s[2]+u[3]},d.bq=bg,d.br=function(u,s){const h=K(u,2*Math.PI),f=K(s,2*Math.PI);return Math.min(Math.abs(h-f),Math.abs(h-f+2*Math.PI),Math.abs(h-f-2*Math.PI))},d.bs=function(u){return Math.hypot(u[0],u[1],u[2])},d.bt=function(){const u={},s=B.$version;for(const h in B.$root){const f=B.$root[h];if(f.required){let m=null;m=h==="version"?s:f.type==="array"?[]:{},m!=null&&(u[h]=m)}}return u},d.bu=wl,d.bv=zn,d.bw=function(u){u=u.slice();const s=Object.create(null);for(let h=0;h<u.length;h++)s[u[h].id]=u[h];for(let h=0;h<u.length;h++)"ref"in u[h]&&(u[h]=ie(u[h],s[u[h].ref]));return u},d.bx=function(u){if(u.type==="custom")return new G2(u);switch(u.type){case"background":return new Z2(u);case"circle":return new VT(u);case"fill":return new o2(u);case"fill-extrusion":return new p2(u);case"heatmap":return new $T(u);case"hillshade":return new HT(u);case"line":return new w2(u);case"raster":return new X2(u);case"symbol":return new jd(u)}},d.by=oi,d.bz=function(u,s){if(!u)return[{command:"setStyle",args:[s]}];let h=[];try{if(!ue(u.version,s.version))return[{command:"setStyle",args:[s]}];ue(u.center,s.center)||h.push({command:"setCenter",args:[s.center]}),ue(u.centerAltitude,s.centerAltitude)||h.push({command:"setCenterAltitude",args:[s.centerAltitude]}),ue(u.zoom,s.zoom)||h.push({command:"setZoom",args:[s.zoom]}),ue(u.bearing,s.bearing)||h.push({command:"setBearing",args:[s.bearing]}),ue(u.pitch,s.pitch)||h.push({command:"setPitch",args:[s.pitch]}),ue(u.roll,s.roll)||h.push({command:"setRoll",args:[s.roll]}),ue(u.sprite,s.sprite)||h.push({command:"setSprite",args:[s.sprite]}),ue(u.glyphs,s.glyphs)||h.push({command:"setGlyphs",args:[s.glyphs]}),ue(u.transition,s.transition)||h.push({command:"setTransition",args:[s.transition]}),ue(u.light,s.light)||h.push({command:"setLight",args:[s.light]}),ue(u.terrain,s.terrain)||h.push({command:"setTerrain",args:[s.terrain]}),ue(u.sky,s.sky)||h.push({command:"setSky",args:[s.sky]}),ue(u.projection,s.projection)||h.push({command:"setProjection",args:[s.projection]});const f={},m=[];(function(b,S,P,M){let k;for(k in S=S||{},b=b||{})Object.prototype.hasOwnProperty.call(b,k)&&(Object.prototype.hasOwnProperty.call(S,k)||qe(k,P,M));for(k in S)Object.prototype.hasOwnProperty.call(S,k)&&(Object.prototype.hasOwnProperty.call(b,k)?ue(b[k],S[k])||(b[k].type==="geojson"&&S[k].type==="geojson"&&rt(b,S,k)?Ae(P,{command:"setGeoJSONSourceData",args:[k,S[k].data]}):De(k,S,P,M)):Oe(k,S,P))})(u.sources,s.sources,m,f);const v=[];u.layers&&u.layers.forEach((b=>{"source"in b&&f[b.source]?h.push({command:"removeLayer",args:[b.id]}):v.push(b)})),h=h.concat(m),(function(b,S,P){S=S||[];const M=(b=b||[]).map(ze),k=S.map(ze),O=b.reduce(at,{}),U=S.reduce(at,{}),j=M.slice(),$=Object.create(null);let Z,te,ce,Me,pe;for(let V=0,Q=0;V<M.length;V++)Z=M[V],Object.prototype.hasOwnProperty.call(U,Z)?Q++:(Ae(P,{command:"removeLayer",args:[Z]}),j.splice(j.indexOf(Z,Q),1));for(let V=0,Q=0;V<k.length;V++)Z=k[k.length-1-V],j[j.length-1-V]!==Z&&(Object.prototype.hasOwnProperty.call(O,Z)?(Ae(P,{command:"removeLayer",args:[Z]}),j.splice(j.lastIndexOf(Z,j.length-Q),1)):Q++,Me=j[j.length-V],Ae(P,{command:"addLayer",args:[U[Z],Me]}),j.splice(j.length-V,0,Z),$[Z]=!0);for(let V=0;V<k.length;V++)if(Z=k[V],te=O[Z],ce=U[Z],!$[Z]&&!ue(te,ce))if(ue(te.source,ce.source)&&ue(te["source-layer"],ce["source-layer"])&&ue(te.type,ce.type)){for(pe in Ke(te.layout,ce.layout,P,Z,null,"setLayoutProperty"),Ke(te.paint,ce.paint,P,Z,null,"setPaintProperty"),ue(te.filter,ce.filter)||Ae(P,{command:"setFilter",args:[Z,ce.filter]}),ue(te.minzoom,ce.minzoom)&&ue(te.maxzoom,ce.maxzoom)||Ae(P,{command:"setLayerZoomRange",args:[Z,ce.minzoom,ce.maxzoom]}),te)Object.prototype.hasOwnProperty.call(te,pe)&&pe!=="layout"&&pe!=="paint"&&pe!=="filter"&&pe!=="metadata"&&pe!=="minzoom"&&pe!=="maxzoom"&&(pe.indexOf("paint.")===0?Ke(te[pe],ce[pe],P,Z,pe.slice(6),"setPaintProperty"):ue(te[pe],ce[pe])||Ae(P,{command:"setLayerProperty",args:[Z,pe,ce[pe]]}));for(pe in ce)Object.prototype.hasOwnProperty.call(ce,pe)&&!Object.prototype.hasOwnProperty.call(te,pe)&&pe!=="layout"&&pe!=="paint"&&pe!=="filter"&&pe!=="metadata"&&pe!=="minzoom"&&pe!=="maxzoom"&&(pe.indexOf("paint.")===0?Ke(te[pe],ce[pe],P,Z,pe.slice(6),"setPaintProperty"):ue(te[pe],ce[pe])||Ae(P,{command:"setLayerProperty",args:[Z,pe,ce[pe]]}))}else Ae(P,{command:"removeLayer",args:[Z]}),Me=j[j.lastIndexOf(Z)+1],Ae(P,{command:"addLayer",args:[ce,Me]})})(v,s.layers,h)}catch(f){console.warn("Unable to compute style diff:",f),h=[{command:"setStyle",args:[s]}]}return h},d.c=Ps,d.c0=u=>u.type==="heatmap",d.c1=u=>u.type==="line",d.c2=u=>u.type==="fill",d.c3=u=>u.type==="fill-extrusion",d.c4=u=>u.type==="hillshade",d.c5=u=>u.type==="raster",d.c6=u=>u.type==="background",d.c7=u=>u.type==="custom",d.c8=Ge,d.c9=function(u,s,h){const f=Ee(s.x-h.x,s.y-h.y),m=Ee(u.x-h.x,u.y-h.y);var v,b;return on(Math.atan2(f[0]*m[1]-f[1]*m[0],(v=f)[0]*(b=m)[0]+v[1]*b[1]))},d.cA=I,d.cB=Wy,d.cC=ix,d.cD=Us,d.cE=fs,d.ca=tt,d.cb=function(u,s,h){var f=s[0],m=s[1];return u[0]=h[0]*f+h[4]*m+h[12],u[1]=h[1]*f+h[5]*m+h[13],u},d.cc=function(u,s){const{x:h,y:f}=ju.fromLngLat(s);return!(u<0||u>25||f<0||f>=1||h<0||h>=1)},d.cd=function(u,s){return u[0]=s[0],u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=s[1],u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=s[2],u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u},d.ce=class extends Cl{},d.cf=oS,d.ch=function(u){return u.message===so},d.ci=Nn,d.cj=function(u,s){Cs.REGISTERED_PROTOCOLS[u]=s},d.ck=function(u){delete Cs.REGISTERED_PROTOCOLS[u]},d.cl=function(u,s){const h={};for(let m=0;m<u.length;m++){const v=s&&s[u[m].id]||su(u[m]);s&&(s[u[m].id]=v);let b=h[v];b||(b=h[v]=[]),b.push(u[m])}const f=[];for(const m in h)f.push(h[m]);return f},d.cm=wt,d.cn=Px,d.co=Ix,d.cp=nx,d.cq=function(u){u.bucket.createArrays(),u.bucket.tilePixelRatio=W/(512*u.bucket.overscaling),u.bucket.compareText={},u.bucket.iconsNeedLinear=!1;const s=u.bucket.layers[0],h=s.layout,f=s._unevaluatedLayout._values,m={layoutIconSize:f["icon-size"].possiblyEvaluate(new Ci(u.bucket.zoom+1),u.canonical),layoutTextSize:f["text-size"].possiblyEvaluate(new Ci(u.bucket.zoom+1),u.canonical),textMaxSize:f["text-size"].possiblyEvaluate(new Ci(18))};if(u.bucket.textSizeData.kind==="composite"){const{minZoom:M,maxZoom:k}=u.bucket.textSizeData;m.compositeTextSizes=[f["text-size"].possiblyEvaluate(new Ci(M),u.canonical),f["text-size"].possiblyEvaluate(new Ci(k),u.canonical)]}if(u.bucket.iconSizeData.kind==="composite"){const{minZoom:M,maxZoom:k}=u.bucket.iconSizeData;m.compositeIconSizes=[f["icon-size"].possiblyEvaluate(new Ci(M),u.canonical),f["icon-size"].possiblyEvaluate(new Ci(k),u.canonical)]}const v=h.get("text-line-height")*Ki,b=h.get("text-rotation-alignment")!=="viewport"&&h.get("symbol-placement")!=="point",S=h.get("text-keep-upright"),P=h.get("text-size");for(const M of u.bucket.features){const k=h.get("text-font").evaluate(M,{},u.canonical).join(","),O=P.evaluate(M,{},u.canonical),U=m.layoutTextSize.evaluate(M,{},u.canonical),j=m.layoutIconSize.evaluate(M,{},u.canonical),$={horizontal:{},vertical:void 0},Z=M.text;let te,ce=[0,0];if(Z){const V=Z.toString(),Q=h.get("text-letter-spacing").evaluate(M,{},u.canonical)*Ki,me=bd(V)?Q:0,We=h.get("text-anchor").evaluate(M,{},u.canonical),lt=Vx(s,M,u.canonical);if(!lt){const ut=h.get("text-radial-offset").evaluate(M,{},u.canonical);ce=ut?Ux(We,[ut*Ki,Sg]):h.get("text-offset").evaluate(M,{},u.canonical).map((gt=>gt*Ki))}let Ye=b?"center":h.get("text-justify").evaluate(M,{},u.canonical);const Qe=h.get("symbol-placement")==="point"?h.get("text-max-width").evaluate(M,{},u.canonical)*Ki:1/0,ft=()=>{u.bucket.allowVerticalPlacement&&Tl(V)&&($.vertical=zd(Z,u.glyphMap,u.glyphPositions,u.imagePositions,k,Qe,v,We,"left",me,ce,d.ag.vertical,!0,U,O))};if(!b&&lt){const ut=new Set;if(Ye==="auto")for(let st=0;st<lt.values.length;st+=2)ut.add(Eg(lt.values[st]));else ut.add(Ye);let gt=!1;for(const st of ut)if(!$.horizontal[st])if(gt)$.horizontal[st]=$.horizontal[0];else{const St=zd(Z,u.glyphMap,u.glyphPositions,u.imagePositions,k,Qe,v,"center",st,me,ce,d.ag.horizontal,!1,U,O);St&&($.horizontal[st]=St,gt=St.positionedLines.length===1)}ft()}else{Ye==="auto"&&(Ye=Eg(We));const ut=zd(Z,u.glyphMap,u.glyphPositions,u.imagePositions,k,Qe,v,We,Ye,me,ce,d.ag.horizontal,!1,U,O);ut&&($.horizontal[Ye]=ut),ft(),Tl(V)&&b&&S&&($.vertical=zd(Z,u.glyphMap,u.glyphPositions,u.imagePositions,k,Qe,v,We,Ye,me,ce,d.ag.vertical,!1,U,O))}}let Me=!1;if(M.icon&&M.icon.name){const V=u.imageMap[M.icon.name];V&&(te=V2(u.imagePositions[M.icon.name],h.get("icon-offset").evaluate(M,{},u.canonical),h.get("icon-anchor").evaluate(M,{},u.canonical)),Me=!!V.sdf,u.bucket.sdfIcons===void 0?u.bucket.sdfIcons=Me:u.bucket.sdfIcons!==Me&&ci("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(V.pixelRatio!==u.bucket.pixelRatio||h.get("icon-rotate").constantOr(1)!==0)&&(u.bucket.iconsNeedLinear=!0))}const pe=$x($.horizontal)||$.vertical;u.bucket.iconsInText=!!pe&&pe.iconsInText,(pe||te)&&nS(u.bucket,M,$,te,u.imageMap,m,U,j,ce,Me,u.canonical,u.subdivisionGranularity)}u.showCollisionBoxes&&u.bucket.generateCollisionDebugBuffers()},d.cr=lg,d.cs=ig,d.ct=ag,d.cu=Fu,d.cv=hg,d.cw=class{constructor(u){this._marks={start:[u.url,"start"].join("#"),end:[u.url,"end"].join("#"),measure:u.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let u=performance.getEntriesByName(this._marks.measure);return u.length===0&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),u=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),u}},d.cx=function(u,s,h,f,m){return a(this,void 0,void 0,(function*(){if(ke())try{return yield sn(u,s,h,f,m)}catch{}return(function(v,b,S,P,M){const k=v.width,O=v.height;rs&&ns||(rs=new OffscreenCanvas(k,O),ns=rs.getContext("2d",{willReadFrequently:!0})),rs.width=k,rs.height=O,ns.drawImage(v,0,0,k,O);const U=ns.getImageData(b,S,P,M);return ns.clearRect(0,0,k,O),U.data})(u,s,h,f,m)}))},d.cy=Ax,d.cz=y,d.d=os,d.e=_t,d.f=u=>a(void 0,void 0,void 0,(function*(){if(u.byteLength===0)return createImageBitmap(new ImageData(1,1));const s=new Blob([new Uint8Array(u)],{type:"image/png"});try{return createImageBitmap(s)}catch(h){throw new Error(`Could not load image because of ${h.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}})),d.g=oo,d.h=u=>new Promise(((s,h)=>{const f=new Image;f.onload=()=>{s(f),URL.revokeObjectURL(f.src),f.onload=null,window.requestAnimationFrame((()=>{f.src=Jt}))},f.onerror=()=>h(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const m=new Blob([new Uint8Array(u)],{type:"image/png"});f.src=u.byteLength?URL.createObjectURL(m):Jt})),d.i=Ai,d.j=(u,s)=>ss(_t(u,{type:"json"}),s),d.k=Un,d.l=Go,d.m=ss,d.n=(u,s)=>ss(_t(u,{type:"arrayBuffer"}),s),d.o=function(u){return new hg(u).readFields(I2,[])},d.p=rx,d.q=Iu,d.r=kr,d.s=bn,d.t=ca,d.u=qt,d.v=B,d.w=ci,d.x=bl,d.y=Eo,d.z=function([u,s,h]){return s+=90,s*=Math.PI/180,h*=Math.PI/180,{x:u*Math.cos(s)*Math.sin(h),y:u*Math.sin(s)*Math.sin(h),z:u*Math.cos(h)}}})),o("worker",["./shared"],(function(d){class a{constructor(B){this.keyCache={},B&&this.replace(B)}replace(B){this._layerConfigs={},this._layers={},this.update(B,[])}update(B,Y){for(const ue of B){this._layerConfigs[ue.id]=ue;const Ae=this._layers[ue.id]=d.bx(ue);Ae._featureFilter=d.a6(Ae.filter),this.keyCache[ue.id]&&delete this.keyCache[ue.id]}for(const ue of Y)delete this.keyCache[ue],delete this._layerConfigs[ue],delete this._layers[ue];this.familiesBySource={};const ie=d.cl(Object.values(this._layerConfigs),this.keyCache);for(const ue of ie){const Ae=ue.map((ze=>this._layers[ze.id])),Oe=Ae[0];if(Oe.visibility==="none")continue;const qe=Oe.source||"";let De=this.familiesBySource[qe];De||(De=this.familiesBySource[qe]={});const rt=Oe.sourceLayer||"_geojsonTileLayer";let Ke=De[rt];Ke||(Ke=De[rt]=[]),Ke.push(Ae)}}}class y{constructor(B){const Y={},ie=[];for(const qe in B){const De=B[qe],rt=Y[qe]={};for(const Ke in De){const ze=De[+Ke];if(!ze||ze.bitmap.width===0||ze.bitmap.height===0)continue;const at={x:0,y:0,w:ze.bitmap.width+2,h:ze.bitmap.height+2};ie.push(at),rt[Ke]={rect:at,metrics:ze.metrics}}}const{w:ue,h:Ae}=d.p(ie),Oe=new d.q({width:ue||1,height:Ae||1});for(const qe in B){const De=B[qe];for(const rt in De){const Ke=De[+rt];if(!Ke||Ke.bitmap.width===0||Ke.bitmap.height===0)continue;const ze=Y[qe][rt].rect;d.q.copy(Ke.bitmap,Oe,{x:0,y:0},{x:ze.x+1,y:ze.y+1},Ke.bitmap)}}this.image=Oe,this.positions=Y}}d.cm("GlyphAtlas",y);class w{constructor(B){this.tileID=new d.Y(B.tileID.overscaledZ,B.tileID.wrap,B.tileID.canonical.z,B.tileID.canonical.x,B.tileID.canonical.y),this.uid=B.uid,this.zoom=B.zoom,this.pixelRatio=B.pixelRatio,this.tileSize=B.tileSize,this.source=B.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=B.showCollisionBoxes,this.collectResourceTiming=!!B.collectResourceTiming,this.returnDependencies=!!B.returnDependencies,this.promoteId=B.promoteId,this.inFlightDependencies=[]}parse(B,Y,ie,ue,Ae){return d._(this,void 0,void 0,(function*(){this.status="parsing",this.data=B,this.collisionBoxArray=new d.a4;const Oe=new d.cn(Object.keys(B.layers).sort()),qe=new d.co(this.tileID,this.promoteId);qe.bucketLayerIDs=[];const De={},rt={featureIndex:qe,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:ie,subdivisionGranularity:Ae},Ke=Y.familiesBySource[this.source];for(const zt in Ke){const Zt=B.layers[zt];if(!Zt)continue;Zt.version===1&&d.w(`Vector tile source "${this.source}" layer "${zt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Dt=Oe.encode(zt),Ms=[];for(let ji=0;ji<Zt.length;ji++){const qi=Zt.feature(ji),bi=qe.getId(qi,zt);Ms.push({feature:qi,id:bi,index:ji,sourceLayerIndex:Dt})}for(const ji of Ke[zt]){const qi=ji[0];qi.source!==this.source&&d.w(`layer.source = ${qi.source} does not equal this.source = ${this.source}`),qi.minzoom&&this.zoom<Math.floor(qi.minzoom)||qi.maxzoom&&this.zoom>=qi.maxzoom||qi.visibility!=="none"&&(E(ji,this.zoom,ie),(De[qi.id]=qi.createBucket({index:qe.bucketLayerIDs.length,layers:ji,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Dt,sourceID:this.source})).populate(Ms,rt,this.tileID.canonical),qe.bucketLayerIDs.push(ji.map((bi=>bi.id))))}}const ze=d.bC(rt.glyphDependencies,(zt=>Object.keys(zt).map(Number)));this.inFlightDependencies.forEach((zt=>zt?.abort())),this.inFlightDependencies=[];let at=Promise.resolve({});if(Object.keys(ze).length){const zt=new AbortController;this.inFlightDependencies.push(zt),at=ue.sendAsync({type:"GG",data:{stacks:ze,source:this.source,tileID:this.tileID,type:"glyphs"}},zt)}const Ue=Object.keys(rt.iconDependencies);let vt=Promise.resolve({});if(Ue.length){const zt=new AbortController;this.inFlightDependencies.push(zt),vt=ue.sendAsync({type:"GI",data:{icons:Ue,source:this.source,tileID:this.tileID,type:"icons"}},zt)}const It=Object.keys(rt.patternDependencies);let Vt=Promise.resolve({});if(It.length){const zt=new AbortController;this.inFlightDependencies.push(zt),Vt=ue.sendAsync({type:"GI",data:{icons:It,source:this.source,tileID:this.tileID,type:"patterns"}},zt)}const[Nt,ot,At]=yield Promise.all([at,vt,Vt]),Et=new y(Nt),Ht=new d.cp(ot,At);for(const zt in De){const Zt=De[zt];Zt instanceof d.a5?(E(Zt.layers,this.zoom,ie),d.cq({bucket:Zt,glyphMap:Nt,glyphPositions:Et.positions,imageMap:ot,imagePositions:Ht.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:rt.subdivisionGranularity})):Zt.hasPattern&&(Zt instanceof d.cr||Zt instanceof d.cs||Zt instanceof d.ct)&&(E(Zt.layers,this.zoom,ie),Zt.addFeatures(rt,this.tileID.canonical,Ht.patternPositions))}return this.status="done",{buckets:Object.values(De).filter((zt=>!zt.isEmpty())),featureIndex:qe,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Et.image,imageAtlas:Ht,glyphMap:this.returnDependencies?Nt:null,iconMap:this.returnDependencies?ot:null,glyphPositions:this.returnDependencies?Et.positions:null}}))}}function E(Ne,B,Y){const ie=new d.C(B);for(const ue of Ne)ue.recalculate(ie,Y)}class I{constructor(B,Y,ie){this.actor=B,this.layerIndex=Y,this.availableImages=ie,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(B,Y){return d._(this,void 0,void 0,(function*(){const ie=yield d.n(B.request,Y);try{return{vectorTile:new d.cu.VectorTile(new d.cv(ie.data)),rawData:ie.data,cacheControl:ie.cacheControl,expires:ie.expires}}catch(ue){const Ae=new Uint8Array(ie.data);let Oe=`Unable to parse the tile at ${B.request.url}, `;throw Oe+=Ae[0]===31&&Ae[1]===139?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${ue.message}`,new Error(Oe)}}))}loadTile(B){return d._(this,void 0,void 0,(function*(){const Y=B.uid,ie=!!(B&&B.request&&B.request.collectResourceTiming)&&new d.cw(B.request),ue=new w(B);this.loading[Y]=ue;const Ae=new AbortController;ue.abort=Ae;try{const Oe=yield this.loadVectorTile(B,Ae);if(delete this.loading[Y],!Oe)return null;const qe=Oe.rawData,De={};Oe.expires&&(De.expires=Oe.expires),Oe.cacheControl&&(De.cacheControl=Oe.cacheControl);const rt={};if(ie){const ze=ie.finish();ze&&(rt.resourceTiming=JSON.parse(JSON.stringify(ze)))}ue.vectorTile=Oe.vectorTile;const Ke=ue.parse(Oe.vectorTile,this.layerIndex,this.availableImages,this.actor,B.subdivisionGranularity);this.loaded[Y]=ue,this.fetching[Y]={rawTileData:qe,cacheControl:De,resourceTiming:rt};try{const ze=yield Ke;return d.e({rawTileData:qe.slice(0)},ze,De,rt)}finally{delete this.fetching[Y]}}catch(Oe){throw delete this.loading[Y],ue.status="done",this.loaded[Y]=ue,Oe}}))}reloadTile(B){return d._(this,void 0,void 0,(function*(){const Y=B.uid;if(!this.loaded||!this.loaded[Y])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const ie=this.loaded[Y];if(ie.showCollisionBoxes=B.showCollisionBoxes,ie.status==="parsing"){const ue=yield ie.parse(ie.vectorTile,this.layerIndex,this.availableImages,this.actor,B.subdivisionGranularity);let Ae;if(this.fetching[Y]){const{rawTileData:Oe,cacheControl:qe,resourceTiming:De}=this.fetching[Y];delete this.fetching[Y],Ae=d.e({rawTileData:Oe.slice(0)},ue,qe,De)}else Ae=ue;return Ae}if(ie.status==="done"&&ie.vectorTile)return ie.parse(ie.vectorTile,this.layerIndex,this.availableImages,this.actor,B.subdivisionGranularity)}))}abortTile(B){return d._(this,void 0,void 0,(function*(){const Y=this.loading,ie=B.uid;Y&&Y[ie]&&Y[ie].abort&&(Y[ie].abort.abort(),delete Y[ie])}))}removeTile(B){return d._(this,void 0,void 0,(function*(){this.loaded&&this.loaded[B.uid]&&delete this.loaded[B.uid]}))}}class D{constructor(){this.loaded={}}loadTile(B){return d._(this,void 0,void 0,(function*(){const{uid:Y,encoding:ie,rawImageData:ue,redFactor:Ae,greenFactor:Oe,blueFactor:qe,baseShift:De}=B,rt=ue.width+2,Ke=ue.height+2,ze=d.b(ue)?new d.R({width:rt,height:Ke},yield d.cx(ue,-1,-1,rt,Ke)):ue,at=new d.cy(Y,ze,ie,Ae,Oe,qe,De);return this.loaded=this.loaded||{},this.loaded[Y]=at,at}))}removeTile(B){const Y=this.loaded,ie=B.uid;Y&&Y[ie]&&delete Y[ie]}}var F,X,oe=(function(){if(X)return F;function Ne(Y,ie){if(Y.length!==0){B(Y[0],ie);for(var ue=1;ue<Y.length;ue++)B(Y[ue],!ie)}}function B(Y,ie){for(var ue=0,Ae=0,Oe=0,qe=Y.length,De=qe-1;Oe<qe;De=Oe++){var rt=(Y[Oe][0]-Y[De][0])*(Y[De][1]+Y[Oe][1]),Ke=ue+rt;Ae+=Math.abs(ue)>=Math.abs(rt)?ue-Ke+rt:rt-Ke+ue,ue=Ke}ue+Ae>=0!=!!ie&&Y.reverse()}return X=1,F=function Y(ie,ue){var Ae,Oe=ie&&ie.type;if(Oe==="FeatureCollection")for(Ae=0;Ae<ie.features.length;Ae++)Y(ie.features[Ae],ue);else if(Oe==="GeometryCollection")for(Ae=0;Ae<ie.geometries.length;Ae++)Y(ie.geometries[Ae],ue);else if(Oe==="Feature")Y(ie.geometry,ue);else if(Oe==="Polygon")Ne(ie.coordinates,ue);else if(Oe==="MultiPolygon")for(Ae=0;Ae<ie.coordinates.length;Ae++)Ne(ie.coordinates[Ae],ue);return ie}})(),_e=d.cz(oe);const ge=d.cu.VectorTileFeature.prototype.toGeoJSON;class fe{constructor(B){this._feature=B,this.extent=d.Z,this.type=B.type,this.properties=B.tags,"id"in B&&!isNaN(B.id)&&(this.id=parseInt(B.id,10))}loadGeometry(){if(this._feature.type===1){const B=[];for(const Y of this._feature.geometry)B.push([new d.P(Y[0],Y[1])]);return B}{const B=[];for(const Y of this._feature.geometry){const ie=[];for(const ue of Y)ie.push(new d.P(ue[0],ue[1]));B.push(ie)}return B}}toGeoJSON(B,Y,ie){return ge.call(this,B,Y,ie)}}class Te{constructor(B){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=d.Z,this.length=B.length,this._features=B}feature(B){return new fe(this._features[B])}}var ke,Je,Xe,mt={exports:{}},G=(function(){if(Xe)return mt.exports;Xe=1;var Ne=d.cC(),B=(function(){if(Je)return ke;Je=1;var Ke=d.cA(),ze=d.cB().VectorTileFeature;function at(vt,It){this.options=It||{},this.features=vt,this.length=vt.length}function Ue(vt,It){this.id=typeof vt.id=="number"?vt.id:void 0,this.type=vt.type,this.rawGeometry=vt.type===1?[vt.geometry]:vt.geometry,this.properties=vt.tags,this.extent=It||4096}return ke=at,at.prototype.feature=function(vt){return new Ue(this.features[vt],this.options.extent)},Ue.prototype.loadGeometry=function(){var vt=this.rawGeometry;this.geometry=[];for(var It=0;It<vt.length;It++){for(var Vt=vt[It],Nt=[],ot=0;ot<Vt.length;ot++)Nt.push(new Ke(Vt[ot][0],Vt[ot][1]));this.geometry.push(Nt)}return this.geometry},Ue.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var vt=this.geometry,It=1/0,Vt=-1/0,Nt=1/0,ot=-1/0,At=0;At<vt.length;At++)for(var Et=vt[At],Ht=0;Ht<Et.length;Ht++){var zt=Et[Ht];It=Math.min(It,zt.x),Vt=Math.max(Vt,zt.x),Nt=Math.min(Nt,zt.y),ot=Math.max(ot,zt.y)}return[It,Nt,Vt,ot]},Ue.prototype.toGeoJSON=ze.prototype.toGeoJSON,ke})();function Y(Ke){var ze=new Ne;return(function(at,Ue){for(var vt in at.layers)Ue.writeMessage(3,ie,at.layers[vt])})(Ke,ze),ze.finish()}function ie(Ke,ze){var at;ze.writeVarintField(15,Ke.version||1),ze.writeStringField(1,Ke.name||""),ze.writeVarintField(5,Ke.extent||4096);var Ue={keys:[],values:[],keycache:{},valuecache:{}};for(at=0;at<Ke.length;at++)Ue.feature=Ke.feature(at),ze.writeMessage(2,ue,Ue);var vt=Ue.keys;for(at=0;at<vt.length;at++)ze.writeStringField(3,vt[at]);var It=Ue.values;for(at=0;at<It.length;at++)ze.writeMessage(4,rt,It[at])}function ue(Ke,ze){var at=Ke.feature;at.id!==void 0&&ze.writeVarintField(1,at.id),ze.writeMessage(2,Ae,Ke),ze.writeVarintField(3,at.type),ze.writeMessage(4,De,at)}function Ae(Ke,ze){var at=Ke.feature,Ue=Ke.keys,vt=Ke.values,It=Ke.keycache,Vt=Ke.valuecache;for(var Nt in at.properties){var ot=at.properties[Nt],At=It[Nt];if(ot!==null){At===void 0&&(Ue.push(Nt),It[Nt]=At=Ue.length-1),ze.writeVarint(At);var Et=typeof ot;Et!=="string"&&Et!=="boolean"&&Et!=="number"&&(ot=JSON.stringify(ot));var Ht=Et+":"+ot,zt=Vt[Ht];zt===void 0&&(vt.push(ot),Vt[Ht]=zt=vt.length-1),ze.writeVarint(zt)}}}function Oe(Ke,ze){return(ze<<3)+(7&Ke)}function qe(Ke){return Ke<<1^Ke>>31}function De(Ke,ze){for(var at=Ke.loadGeometry(),Ue=Ke.type,vt=0,It=0,Vt=at.length,Nt=0;Nt<Vt;Nt++){var ot=at[Nt],At=1;Ue===1&&(At=ot.length),ze.writeVarint(Oe(1,At));for(var Et=Ue===3?ot.length-1:ot.length,Ht=0;Ht<Et;Ht++){Ht===1&&Ue!==1&&ze.writeVarint(Oe(2,Et-1));var zt=ot[Ht].x-vt,Zt=ot[Ht].y-It;ze.writeVarint(qe(zt)),ze.writeVarint(qe(Zt)),vt+=zt,It+=Zt}Ue===3&&ze.writeVarint(Oe(7,1))}}function rt(Ke,ze){var at=typeof Ke;at==="string"?ze.writeStringField(1,Ke):at==="boolean"?ze.writeBooleanField(7,Ke):at==="number"&&(Ke%1!=0?ze.writeDoubleField(3,Ke):Ke<0?ze.writeSVarintField(6,Ke):ze.writeVarintField(5,Ke))}return mt.exports=Y,mt.exports.fromVectorTileJs=Y,mt.exports.fromGeojsonVt=function(Ke,ze){ze=ze||{};var at={};for(var Ue in Ke)at[Ue]=new B(Ke[Ue].features,ze),at[Ue].name=Ue,at[Ue].version=ze.version,at[Ue].extent=ze.extent;return Y({layers:at})},mt.exports.GeoJSONWrapper=B,mt.exports})(),J=d.cz(G);const ae={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ne=>Ne},be=Math.fround||(ye=new Float32Array(1),Ne=>(ye[0]=+Ne,ye[0]));var ye;const we=3,Se=5,Ee=6;class W{constructor(B){this.options=Object.assign(Object.create(ae),B),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(B){const{log:Y,minZoom:ie,maxZoom:ue}=this.options;Y&&console.time("total time");const Ae=`prepare ${B.length} points`;Y&&console.time(Ae),this.points=B;const Oe=[];for(let De=0;De<B.length;De++){const rt=B[De];if(!rt.geometry)continue;const[Ke,ze]=rt.geometry.coordinates,at=be(Ce(Ke)),Ue=be(je(ze));Oe.push(at,Ue,1/0,De,-1,1),this.options.reduce&&Oe.push(0)}let qe=this.trees[ue+1]=this._createTree(Oe);Y&&console.timeEnd(Ae);for(let De=ue;De>=ie;De--){const rt=+Date.now();qe=this.trees[De]=this._createTree(this._cluster(qe,De)),Y&&console.log("z%d: %d clusters in %dms",De,qe.numItems,+Date.now()-rt)}return Y&&console.timeEnd("total time"),this}getClusters(B,Y){let ie=((B[0]+180)%360+360)%360-180;const ue=Math.max(-90,Math.min(90,B[1]));let Ae=B[2]===180?180:((B[2]+180)%360+360)%360-180;const Oe=Math.max(-90,Math.min(90,B[3]));if(B[2]-B[0]>=360)ie=-180,Ae=180;else if(ie>Ae){const ze=this.getClusters([ie,ue,180,Oe],Y),at=this.getClusters([-180,ue,Ae,Oe],Y);return ze.concat(at)}const qe=this.trees[this._limitZoom(Y)],De=qe.range(Ce(ie),je(Oe),Ce(Ae),je(ue)),rt=qe.data,Ke=[];for(const ze of De){const at=this.stride*ze;Ke.push(rt[at+Se]>1?ee(rt,at,this.clusterProps):this.points[rt[at+we]])}return Ke}getChildren(B){const Y=this._getOriginId(B),ie=this._getOriginZoom(B),ue="No cluster with the specified id.",Ae=this.trees[ie];if(!Ae)throw new Error(ue);const Oe=Ae.data;if(Y*this.stride>=Oe.length)throw new Error(ue);const qe=this.options.radius/(this.options.extent*Math.pow(2,ie-1)),De=Ae.within(Oe[Y*this.stride],Oe[Y*this.stride+1],qe),rt=[];for(const Ke of De){const ze=Ke*this.stride;Oe[ze+4]===B&&rt.push(Oe[ze+Se]>1?ee(Oe,ze,this.clusterProps):this.points[Oe[ze+we]])}if(rt.length===0)throw new Error(ue);return rt}getLeaves(B,Y,ie){const ue=[];return this._appendLeaves(ue,B,Y=Y||10,ie=ie||0,0),ue}getTile(B,Y,ie){const ue=this.trees[this._limitZoom(B)],Ae=Math.pow(2,B),{extent:Oe,radius:qe}=this.options,De=qe/Oe,rt=(ie-De)/Ae,Ke=(ie+1+De)/Ae,ze={features:[]};return this._addTileFeatures(ue.range((Y-De)/Ae,rt,(Y+1+De)/Ae,Ke),ue.data,Y,ie,Ae,ze),Y===0&&this._addTileFeatures(ue.range(1-De/Ae,rt,1,Ke),ue.data,Ae,ie,Ae,ze),Y===Ae-1&&this._addTileFeatures(ue.range(0,rt,De/Ae,Ke),ue.data,-1,ie,Ae,ze),ze.features.length?ze:null}getClusterExpansionZoom(B){let Y=this._getOriginZoom(B)-1;for(;Y<=this.options.maxZoom;){const ie=this.getChildren(B);if(Y++,ie.length!==1)break;B=ie[0].properties.cluster_id}return Y}_appendLeaves(B,Y,ie,ue,Ae){const Oe=this.getChildren(Y);for(const qe of Oe){const De=qe.properties;if(De&&De.cluster?Ae+De.point_count<=ue?Ae+=De.point_count:Ae=this._appendLeaves(B,De.cluster_id,ie,ue,Ae):Ae<ue?Ae++:B.push(qe),B.length===ie)break}return Ae}_createTree(B){const Y=new d.aB(B.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ie=0;ie<B.length;ie+=this.stride)Y.add(B[ie],B[ie+1]);return Y.finish(),Y.data=B,Y}_addTileFeatures(B,Y,ie,ue,Ae,Oe){for(const qe of B){const De=qe*this.stride,rt=Y[De+Se]>1;let Ke,ze,at;if(rt)Ke=K(Y,De,this.clusterProps),ze=Y[De],at=Y[De+1];else{const It=this.points[Y[De+we]];Ke=It.properties;const[Vt,Nt]=It.geometry.coordinates;ze=Ce(Vt),at=je(Nt)}const Ue={type:1,geometry:[[Math.round(this.options.extent*(ze*Ae-ie)),Math.round(this.options.extent*(at*Ae-ue))]],tags:Ke};let vt;vt=rt||this.options.generateId?Y[De+we]:this.points[Y[De+we]].id,vt!==void 0&&(Ue.id=vt),Oe.features.push(Ue)}}_limitZoom(B){return Math.max(this.options.minZoom,Math.min(Math.floor(+B),this.options.maxZoom+1))}_cluster(B,Y){const{radius:ie,extent:ue,reduce:Ae,minPoints:Oe}=this.options,qe=ie/(ue*Math.pow(2,Y)),De=B.data,rt=[],Ke=this.stride;for(let ze=0;ze<De.length;ze+=Ke){if(De[ze+2]<=Y)continue;De[ze+2]=Y;const at=De[ze],Ue=De[ze+1],vt=B.within(De[ze],De[ze+1],qe),It=De[ze+Se];let Vt=It;for(const Nt of vt){const ot=Nt*Ke;De[ot+2]>Y&&(Vt+=De[ot+Se])}if(Vt>It&&Vt>=Oe){let Nt,ot=at*It,At=Ue*It,Et=-1;const Ht=((ze/Ke|0)<<5)+(Y+1)+this.points.length;for(const zt of vt){const Zt=zt*Ke;if(De[Zt+2]<=Y)continue;De[Zt+2]=Y;const Dt=De[Zt+Se];ot+=De[Zt]*Dt,At+=De[Zt+1]*Dt,De[Zt+4]=Ht,Ae&&(Nt||(Nt=this._map(De,ze,!0),Et=this.clusterProps.length,this.clusterProps.push(Nt)),Ae(Nt,this._map(De,Zt)))}De[ze+4]=Ht,rt.push(ot/Vt,At/Vt,1/0,Ht,-1,Vt),Ae&&rt.push(Et)}else{for(let Nt=0;Nt<Ke;Nt++)rt.push(De[ze+Nt]);if(Vt>1)for(const Nt of vt){const ot=Nt*Ke;if(!(De[ot+2]<=Y)){De[ot+2]=Y;for(let At=0;At<Ke;At++)rt.push(De[ot+At])}}}}return rt}_getOriginId(B){return B-this.points.length>>5}_getOriginZoom(B){return(B-this.points.length)%32}_map(B,Y,ie){if(B[Y+Se]>1){const Oe=this.clusterProps[B[Y+Ee]];return ie?Object.assign({},Oe):Oe}const ue=this.points[B[Y+we]].properties,Ae=this.options.map(ue);return ie&&Ae===ue?Object.assign({},Ae):Ae}}function ee(Ne,B,Y){return{type:"Feature",id:Ne[B+we],properties:K(Ne,B,Y),geometry:{type:"Point",coordinates:[(ie=Ne[B],360*(ie-.5)),Ge(Ne[B+1])]}};var ie}function K(Ne,B,Y){const ie=Ne[B+Se],ue=ie>=1e4?`${Math.round(ie/1e3)}k`:ie>=1e3?Math.round(ie/100)/10+"k":ie,Ae=Ne[B+Ee],Oe=Ae===-1?{}:Object.assign({},Y[Ae]);return Object.assign(Oe,{cluster:!0,cluster_id:Ne[B+we],point_count:ie,point_count_abbreviated:ue})}function Ce(Ne){return Ne/360+.5}function je(Ne){const B=Math.sin(Ne*Math.PI/180),Y=.5-.25*Math.log((1+B)/(1-B))/Math.PI;return Y<0?0:Y>1?1:Y}function Ge(Ne){const B=(180-360*Ne)*Math.PI/180;return 360*Math.atan(Math.exp(B))/Math.PI-90}function tt(Ne,B,Y,ie){let ue=ie;const Ae=B+(Y-B>>1);let Oe,qe=Y-B;const De=Ne[B],rt=Ne[B+1],Ke=Ne[Y],ze=Ne[Y+1];for(let at=B+3;at<Y;at+=3){const Ue=pt(Ne[at],Ne[at+1],De,rt,Ke,ze);if(Ue>ue)Oe=at,ue=Ue;else if(Ue===ue){const vt=Math.abs(at-Ae);vt<qe&&(Oe=at,qe=vt)}}ue>ie&&(Oe-B>3&&tt(Ne,B,Oe,ie),Ne[Oe+2]=ue,Y-Oe>3&&tt(Ne,Oe,Y,ie))}function pt(Ne,B,Y,ie,ue,Ae){let Oe=ue-Y,qe=Ae-ie;if(Oe!==0||qe!==0){const De=((Ne-Y)*Oe+(B-ie)*qe)/(Oe*Oe+qe*qe);De>1?(Y=ue,ie=Ae):De>0&&(Y+=Oe*De,ie+=qe*De)}return Oe=Ne-Y,qe=B-ie,Oe*Oe+qe*qe}function bt(Ne,B,Y,ie){const ue={id:Ne??null,type:B,geometry:Y,tags:ie,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(B==="Point"||B==="MultiPoint"||B==="LineString")_t(ue,Y);else if(B==="Polygon")_t(ue,Y[0]);else if(B==="MultiLineString")for(const Ae of Y)_t(ue,Ae);else if(B==="MultiPolygon")for(const Ae of Y)_t(ue,Ae[0]);return ue}function _t(Ne,B){for(let Y=0;Y<B.length;Y+=3)Ne.minX=Math.min(Ne.minX,B[Y]),Ne.minY=Math.min(Ne.minY,B[Y+1]),Ne.maxX=Math.max(Ne.maxX,B[Y]),Ne.maxY=Math.max(Ne.maxY,B[Y+1])}function Lt(Ne,B,Y,ie){if(!B.geometry)return;const ue=B.geometry.coordinates;if(ue&&ue.length===0)return;const Ae=B.geometry.type,Oe=Math.pow(Y.tolerance/((1<<Y.maxZoom)*Y.extent),2);let qe=[],De=B.id;if(Y.promoteId?De=B.properties[Y.promoteId]:Y.generateId&&(De=ie||0),Ae==="Point")Ut(ue,qe);else if(Ae==="MultiPoint")for(const rt of ue)Ut(rt,qe);else if(Ae==="LineString")Wt(ue,qe,Oe,!1);else if(Ae==="MultiLineString"){if(Y.lineMetrics){for(const rt of ue)qe=[],Wt(rt,qe,Oe,!1),Ne.push(bt(De,"LineString",qe,B.properties));return}oi(ue,qe,Oe,!1)}else if(Ae==="Polygon")oi(ue,qe,Oe,!0);else{if(Ae!=="MultiPolygon"){if(Ae==="GeometryCollection"){for(const rt of B.geometry.geometries)Lt(Ne,{id:De,geometry:rt,properties:B.properties},Y,ie);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const rt of ue){const Ke=[];oi(rt,Ke,Oe,!0),qe.push(Ke)}}Ne.push(bt(De,Ae,qe,B.properties))}function Ut(Ne,B){B.push(ei(Ne[0]),ci(Ne[1]),0)}function Wt(Ne,B,Y,ie){let ue,Ae,Oe=0;for(let De=0;De<Ne.length;De++){const rt=ei(Ne[De][0]),Ke=ci(Ne[De][1]);B.push(rt,Ke,0),De>0&&(Oe+=ie?(ue*Ke-rt*Ae)/2:Math.sqrt(Math.pow(rt-ue,2)+Math.pow(Ke-Ae,2))),ue=rt,Ae=Ke}const qe=B.length-3;B[2]=1,tt(B,0,qe,Y),B[qe+2]=1,B.size=Math.abs(Oe),B.start=0,B.end=B.size}function oi(Ne,B,Y,ie){for(let ue=0;ue<Ne.length;ue++){const Ae=[];Wt(Ne[ue],Ae,Y,ie),B.push(Ae)}}function ei(Ne){return Ne/360+.5}function ci(Ne){const B=Math.sin(Ne*Math.PI/180),Y=.5-.25*Math.log((1+B)/(1-B))/Math.PI;return Y<0?0:Y>1?1:Y}function di(Ne,B,Y,ie,ue,Ae,Oe,qe){if(ie/=B,Ae>=(Y/=B)&&Oe<ie)return Ne;if(Oe<Y||Ae>=ie)return null;const De=[];for(const rt of Ne){const Ke=rt.geometry;let ze=rt.type;const at=ue===0?rt.minX:rt.minY,Ue=ue===0?rt.maxX:rt.maxY;if(at>=Y&&Ue<ie){De.push(rt);continue}if(Ue<Y||at>=ie)continue;let vt=[];if(ze==="Point"||ze==="MultiPoint")Ai(Ke,vt,Y,ie,ue);else if(ze==="LineString")Yt(Ke,vt,Y,ie,ue,!1,qe.lineMetrics);else if(ze==="MultiLineString")Jt(Ke,vt,Y,ie,ue,!1);else if(ze==="Polygon")Jt(Ke,vt,Y,ie,ue,!0);else if(ze==="MultiPolygon")for(const It of Ke){const Vt=[];Jt(It,Vt,Y,ie,ue,!0),Vt.length&&vt.push(Vt)}if(vt.length){if(qe.lineMetrics&&ze==="LineString"){for(const It of vt)De.push(bt(rt.id,ze,It,rt.tags));continue}ze!=="LineString"&&ze!=="MultiLineString"||(vt.length===1?(ze="LineString",vt=vt[0]):ze="MultiLineString"),ze!=="Point"&&ze!=="MultiPoint"||(ze=vt.length===3?"Point":"MultiPoint"),De.push(bt(rt.id,ze,vt,rt.tags))}}return De.length?De:null}function Ai(Ne,B,Y,ie,ue){for(let Ae=0;Ae<Ne.length;Ae+=3){const Oe=Ne[Ae+ue];Oe>=Y&&Oe<=ie&&sn(B,Ne[Ae],Ne[Ae+1],Ne[Ae+2])}}function Yt(Ne,B,Y,ie,ue,Ae,Oe){let qe=kt(Ne);const De=ue===0?rs:ns;let rt,Ke,ze=Ne.start;for(let Vt=0;Vt<Ne.length-3;Vt+=3){const Nt=Ne[Vt],ot=Ne[Vt+1],At=Ne[Vt+2],Et=Ne[Vt+3],Ht=Ne[Vt+4],zt=ue===0?Nt:ot,Zt=ue===0?Et:Ht;let Dt=!1;Oe&&(rt=Math.sqrt(Math.pow(Nt-Et,2)+Math.pow(ot-Ht,2))),zt<Y?Zt>Y&&(Ke=De(qe,Nt,ot,Et,Ht,Y),Oe&&(qe.start=ze+rt*Ke)):zt>ie?Zt<ie&&(Ke=De(qe,Nt,ot,Et,Ht,ie),Oe&&(qe.start=ze+rt*Ke)):sn(qe,Nt,ot,At),Zt<Y&&zt>=Y&&(Ke=De(qe,Nt,ot,Et,Ht,Y),Dt=!0),Zt>ie&&zt<=ie&&(Ke=De(qe,Nt,ot,Et,Ht,ie),Dt=!0),!Ae&&Dt&&(Oe&&(qe.end=ze+rt*Ke),B.push(qe),qe=kt(Ne)),Oe&&(ze+=rt)}let at=Ne.length-3;const Ue=Ne[at],vt=Ne[at+1],It=ue===0?Ue:vt;It>=Y&&It<=ie&&sn(qe,Ue,vt,Ne[at+2]),at=qe.length-3,Ae&&at>=3&&(qe[at]!==qe[0]||qe[at+1]!==qe[1])&&sn(qe,qe[0],qe[1],qe[2]),qe.length&&B.push(qe)}function kt(Ne){const B=[];return B.size=Ne.size,B.start=Ne.start,B.end=Ne.end,B}function Jt(Ne,B,Y,ie,ue,Ae){for(const Oe of Ne)Yt(Oe,B,Y,ie,ue,Ae,!1)}function sn(Ne,B,Y,ie){Ne.push(B,Y,ie)}function rs(Ne,B,Y,ie,ue,Ae){const Oe=(Ae-B)/(ie-B);return sn(Ne,Ae,Y+(ue-Y)*Oe,1),Oe}function ns(Ne,B,Y,ie,ue,Ae){const Oe=(Ae-Y)/(ue-Y);return sn(Ne,B+(ie-B)*Oe,Ae,1),Oe}function bn(Ne,B){const Y=[];for(let ie=0;ie<Ne.length;ie++){const ue=Ne[ie],Ae=ue.type;let Oe;if(Ae==="Point"||Ae==="MultiPoint"||Ae==="LineString")Oe=on(ue.geometry,B);else if(Ae==="MultiLineString"||Ae==="Polygon"){Oe=[];for(const qe of ue.geometry)Oe.push(on(qe,B))}else if(Ae==="MultiPolygon"){Oe=[];for(const qe of ue.geometry){const De=[];for(const rt of qe)De.push(on(rt,B));Oe.push(De)}}Y.push(bt(ue.id,Ae,Oe,ue.tags))}return Y}function on(Ne,B){const Y=[];Y.size=Ne.size,Ne.start!==void 0&&(Y.start=Ne.start,Y.end=Ne.end);for(let ie=0;ie<Ne.length;ie+=3)Y.push(Ne[ie]+B,Ne[ie+1],Ne[ie+2]);return Y}function so(Ne,B){if(Ne.transformed)return Ne;const Y=1<<Ne.z,ie=Ne.x,ue=Ne.y;for(const Ae of Ne.features){const Oe=Ae.geometry,qe=Ae.type;if(Ae.geometry=[],qe===1)for(let De=0;De<Oe.length;De+=2)Ae.geometry.push(Ps(Oe[De],Oe[De+1],B,Y,ie,ue));else for(let De=0;De<Oe.length;De++){const rt=[];for(let Ke=0;Ke<Oe[De].length;Ke+=2)rt.push(Ps(Oe[De][Ke],Oe[De][Ke+1],B,Y,ie,ue));Ae.geometry.push(rt)}}return Ne.transformed=!0,Ne}function Ps(Ne,B,Y,ie,ue,Ae){return[Math.round(Y*(Ne*ie-ue)),Math.round(Y*(B*ie-Ae))]}function Cs(Ne,B,Y,ie,ue){const Ae=B===ue.maxZoom?0:ue.tolerance/((1<<B)*ue.extent),Oe={features:[],numPoints:0,numSimplified:0,numFeatures:Ne.length,source:null,x:Y,y:ie,z:B,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const qe of Ne)oo(Oe,qe,Ae,ue);return Oe}function oo(Ne,B,Y,ie){const ue=B.geometry,Ae=B.type,Oe=[];if(Ne.minX=Math.min(Ne.minX,B.minX),Ne.minY=Math.min(Ne.minY,B.minY),Ne.maxX=Math.max(Ne.maxX,B.maxX),Ne.maxY=Math.max(Ne.maxY,B.maxY),Ae==="Point"||Ae==="MultiPoint")for(let qe=0;qe<ue.length;qe+=3)Oe.push(ue[qe],ue[qe+1]),Ne.numPoints++,Ne.numSimplified++;else if(Ae==="LineString")Is(Oe,ue,Ne,Y,!1,!1);else if(Ae==="MultiLineString"||Ae==="Polygon")for(let qe=0;qe<ue.length;qe++)Is(Oe,ue[qe],Ne,Y,Ae==="Polygon",qe===0);else if(Ae==="MultiPolygon")for(let qe=0;qe<ue.length;qe++){const De=ue[qe];for(let rt=0;rt<De.length;rt++)Is(Oe,De[rt],Ne,Y,!0,rt===0)}if(Oe.length){let qe=B.tags||null;if(Ae==="LineString"&&ie.lineMetrics){qe={};for(const rt in B.tags)qe[rt]=B.tags[rt];qe.mapbox_clip_start=ue.start/ue.size,qe.mapbox_clip_end=ue.end/ue.size}const De={geometry:Oe,type:Ae==="Polygon"||Ae==="MultiPolygon"?3:Ae==="LineString"||Ae==="MultiLineString"?2:1,tags:qe};B.id!==null&&(De.id=B.id),Ne.features.push(De)}}function Is(Ne,B,Y,ie,ue,Ae){const Oe=ie*ie;if(ie>0&&B.size<(ue?Oe:ie))return void(Y.numPoints+=B.length/3);const qe=[];for(let De=0;De<B.length;De+=3)(ie===0||B[De+2]>Oe)&&(Y.numSimplified++,qe.push(B[De],B[De+1])),Y.numPoints++;ue&&(function(De,rt){let Ke=0;for(let ze=0,at=De.length,Ue=at-2;ze<at;Ue=ze,ze+=2)Ke+=(De[ze]-De[Ue])*(De[ze+1]+De[Ue+1]);if(Ke>0===rt)for(let ze=0,at=De.length;ze<at/2;ze+=2){const Ue=De[ze],vt=De[ze+1];De[ze]=De[at-2-ze],De[ze+1]=De[at-1-ze],De[at-2-ze]=Ue,De[at-1-ze]=vt}})(qe,Ae),Ne.push(qe)}const Nn={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class zn{constructor(B,Y){const ie=(Y=this.options=(function(Ae,Oe){for(const qe in Oe)Ae[qe]=Oe[qe];return Ae})(Object.create(Nn),Y)).debug;if(ie&&console.time("preprocess data"),Y.maxZoom<0||Y.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Y.promoteId&&Y.generateId)throw new Error("promoteId and generateId cannot be used together.");let ue=(function(Ae,Oe){const qe=[];if(Ae.type==="FeatureCollection")for(let De=0;De<Ae.features.length;De++)Lt(qe,Ae.features[De],Oe,De);else Lt(qe,Ae.type==="Feature"?Ae:{geometry:Ae},Oe);return qe})(B,Y);this.tiles={},this.tileCoords=[],ie&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Y.indexMaxZoom,Y.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),ue=(function(Ae,Oe){const qe=Oe.buffer/Oe.extent;let De=Ae;const rt=di(Ae,1,-1-qe,qe,0,-1,2,Oe),Ke=di(Ae,1,1-qe,2+qe,0,-1,2,Oe);return(rt||Ke)&&(De=di(Ae,1,-qe,1+qe,0,-1,2,Oe)||[],rt&&(De=bn(rt,1).concat(De)),Ke&&(De=De.concat(bn(Ke,-1)))),De})(ue,Y),ue.length&&this.splitTile(ue,0,0,0),ie&&(ue.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(B,Y,ie,ue,Ae,Oe,qe){const De=[B,Y,ie,ue],rt=this.options,Ke=rt.debug;for(;De.length;){ue=De.pop(),ie=De.pop(),Y=De.pop(),B=De.pop();const ze=1<<Y,at=ss(Y,ie,ue);let Ue=this.tiles[at];if(!Ue&&(Ke>1&&console.time("creation"),Ue=this.tiles[at]=Cs(B,Y,ie,ue,rt),this.tileCoords.push({z:Y,x:ie,y:ue}),Ke)){Ke>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Y,ie,ue,Ue.numFeatures,Ue.numPoints,Ue.numSimplified),console.timeEnd("creation"));const Dt=`z${Y}`;this.stats[Dt]=(this.stats[Dt]||0)+1,this.total++}if(Ue.source=B,Ae==null){if(Y===rt.indexMaxZoom||Ue.numPoints<=rt.indexMaxPoints)continue}else{if(Y===rt.maxZoom||Y===Ae)continue;if(Ae!=null){const Dt=Ae-Y;if(ie!==Oe>>Dt||ue!==qe>>Dt)continue}}if(Ue.source=null,B.length===0)continue;Ke>1&&console.time("clipping");const vt=.5*rt.buffer/rt.extent,It=.5-vt,Vt=.5+vt,Nt=1+vt;let ot=null,At=null,Et=null,Ht=null,zt=di(B,ze,ie-vt,ie+Vt,0,Ue.minX,Ue.maxX,rt),Zt=di(B,ze,ie+It,ie+Nt,0,Ue.minX,Ue.maxX,rt);B=null,zt&&(ot=di(zt,ze,ue-vt,ue+Vt,1,Ue.minY,Ue.maxY,rt),At=di(zt,ze,ue+It,ue+Nt,1,Ue.minY,Ue.maxY,rt),zt=null),Zt&&(Et=di(Zt,ze,ue-vt,ue+Vt,1,Ue.minY,Ue.maxY,rt),Ht=di(Zt,ze,ue+It,ue+Nt,1,Ue.minY,Ue.maxY,rt),Zt=null),Ke>1&&console.timeEnd("clipping"),De.push(ot||[],Y+1,2*ie,2*ue),De.push(At||[],Y+1,2*ie,2*ue+1),De.push(Et||[],Y+1,2*ie+1,2*ue),De.push(Ht||[],Y+1,2*ie+1,2*ue+1)}}getTile(B,Y,ie){B=+B,Y=+Y,ie=+ie;const ue=this.options,{extent:Ae,debug:Oe}=ue;if(B<0||B>24)return null;const qe=1<<B,De=ss(B,Y=Y+qe&qe-1,ie);if(this.tiles[De])return so(this.tiles[De],Ae);Oe>1&&console.log("drilling down to z%d-%d-%d",B,Y,ie);let rt,Ke=B,ze=Y,at=ie;for(;!rt&&Ke>0;)Ke--,ze>>=1,at>>=1,rt=this.tiles[ss(Ke,ze,at)];return rt&&rt.source?(Oe>1&&(console.log("found parent tile z%d-%d-%d",Ke,ze,at),console.time("drilling down")),this.splitTile(rt.source,Ke,ze,at,B,Y,ie),Oe>1&&console.timeEnd("drilling down"),this.tiles[De]?so(this.tiles[De],Ae):null):null}}function ss(Ne,B,Y){return 32*((1<<Ne)*Y+B)+Ne}function os(Ne,B){return B?Ne.properties[B]:Ne.id}function Xo(Ne,B){if(Ne==null)return!0;if(Ne.type==="Feature")return os(Ne,B)!=null;if(Ne.type==="FeatureCollection"){const Y=new Set;for(const ie of Ne.features){const ue=os(ie,B);if(ue==null||Y.has(ue))return!1;Y.add(ue)}return!0}return!1}function ao(Ne,B){const Y=new Map;if(Ne!=null)if(Ne.type==="Feature")Y.set(os(Ne,B),Ne);else for(const ie of Ne.features)Y.set(os(ie,B),ie);return Y}class Go extends I{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(B,Y){return d._(this,void 0,void 0,(function*(){const ie=B.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const ue=this._geoJSONIndex.getTile(ie.z,ie.x,ie.y);if(!ue)return null;const Ae=new Te(ue.features);let Oe=J(Ae);return Oe.byteOffset===0&&Oe.byteLength===Oe.buffer.byteLength||(Oe=new Uint8Array(Oe)),{vectorTile:Ae,rawData:Oe.buffer}}))}loadData(B){return d._(this,void 0,void 0,(function*(){var Y;(Y=this._pendingRequest)===null||Y===void 0||Y.abort();const ie=!!(B&&B.request&&B.request.collectResourceTiming)&&new d.cw(B.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(B,this._pendingRequest),this._geoJSONIndex=B.cluster?new W((function({superclusterOptions:Oe,clusterProperties:qe}){if(!qe||!Oe)return Oe;const De={},rt={},Ke={accumulated:null,zoom:0},ze={properties:null},at=Object.keys(qe);for(const Ue of at){const[vt,It]=qe[Ue],Vt=d.cD(It),Nt=d.cD(typeof vt=="string"?[vt,["accumulated"],["get",Ue]]:vt);De[Ue]=Vt.value,rt[Ue]=Nt.value}return Oe.map=Ue=>{ze.properties=Ue;const vt={};for(const It of at)vt[It]=De[It].evaluate(Ke,ze);return vt},Oe.reduce=(Ue,vt)=>{ze.properties=vt;for(const It of at)Ke.accumulated=Ue[It],Ue[It]=rt[It].evaluate(Ke,ze)},Oe})(B)).load((yield this._pendingData).features):(ue=yield this._pendingData,new zn(ue,B.geojsonVtOptions)),this.loaded={};const Ae={};if(ie){const Oe=ie.finish();Oe&&(Ae.resourceTiming={},Ae.resourceTiming[B.source]=JSON.parse(JSON.stringify(Oe)))}return Ae}catch(Ae){if(delete this._pendingRequest,d.ch(Ae))return{abandoned:!0};throw Ae}var ue}))}getData(){return d._(this,void 0,void 0,(function*(){return this._pendingData}))}reloadTile(B){const Y=this.loaded;return Y&&Y[B.uid]?super.reloadTile(B):this.loadTile(B)}loadAndProcessGeoJSON(B,Y){return d._(this,void 0,void 0,(function*(){let ie=yield this.loadGeoJSON(B,Y);if(delete this._pendingRequest,typeof ie!="object")throw new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`);if(_e(ie,!0),B.filter){const ue=d.cD(B.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(ue.result==="error")throw new Error(ue.value.map((Oe=>`${Oe.key}: ${Oe.message}`)).join(", "));ie={type:"FeatureCollection",features:ie.features.filter((Oe=>ue.value.evaluate({zoom:0},Oe)))}}return ie}))}loadGeoJSON(B,Y){return d._(this,void 0,void 0,(function*(){const{promoteId:ie}=B;if(B.request){const ue=yield d.j(B.request,Y);return this._dataUpdateable=Xo(ue.data,ie)?ao(ue.data,ie):void 0,ue.data}if(typeof B.data=="string")try{const ue=JSON.parse(B.data);return this._dataUpdateable=Xo(ue,ie)?ao(ue,ie):void 0,ue}catch{throw new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`)}if(!B.dataDiff)throw new Error(`Input data given to '${B.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${B.source}`);return(function(ue,Ae,Oe){var qe,De,rt,Ke;if(Ae.removeAll&&ue.clear(),Ae.remove)for(const ze of Ae.remove)ue.delete(ze);if(Ae.add)for(const ze of Ae.add){const at=os(ze,Oe);at!=null&&ue.set(at,ze)}if(Ae.update)for(const ze of Ae.update){let at=ue.get(ze.id);if(at==null)continue;const Ue=!ze.removeAllProperties&&(((qe=ze.removeProperties)===null||qe===void 0?void 0:qe.length)>0||((De=ze.addOrUpdateProperties)===null||De===void 0?void 0:De.length)>0);if((ze.newGeometry||ze.removeAllProperties||Ue)&&(at=Object.assign({},at),ue.set(ze.id,at),Ue&&(at.properties=Object.assign({},at.properties))),ze.newGeometry&&(at.geometry=ze.newGeometry),ze.removeAllProperties)at.properties={};else if(((rt=ze.removeProperties)===null||rt===void 0?void 0:rt.length)>0)for(const vt of ze.removeProperties)Object.prototype.hasOwnProperty.call(at.properties,vt)&&delete at.properties[vt];if(((Ke=ze.addOrUpdateProperties)===null||Ke===void 0?void 0:Ke.length)>0)for(const{key:vt,value:It}of ze.addOrUpdateProperties)at.properties[vt]=It}})(this._dataUpdateable,B.dataDiff,ie),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}}))}removeSource(B){return d._(this,void 0,void 0,(function*(){this._pendingRequest&&this._pendingRequest.abort()}))}getClusterExpansionZoom(B){return this._geoJSONIndex.getClusterExpansionZoom(B.clusterId)}getClusterChildren(B){return this._geoJSONIndex.getChildren(B.clusterId)}getClusterLeaves(B){return this._geoJSONIndex.getLeaves(B.clusterId,B.limit,B.offset)}}class Un{constructor(B){this.self=B,this.actor=new d.H(B),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(Y,ie)=>{if(this.externalWorkerSourceTypes[Y])throw new Error(`Worker source with name "${Y}" already registered.`);this.externalWorkerSourceTypes[Y]=ie},this.self.addProtocol=d.cj,this.self.removeProtocol=d.ck,this.self.registerRTLTextPlugin=Y=>{d.cE.setMethods(Y)},this.actor.registerMessageHandler("LDT",((Y,ie)=>this._getDEMWorkerSource(Y,ie.source).loadTile(ie))),this.actor.registerMessageHandler("RDT",((Y,ie)=>d._(this,void 0,void 0,(function*(){this._getDEMWorkerSource(Y,ie.source).removeTile(ie)})))),this.actor.registerMessageHandler("GCEZ",((Y,ie)=>d._(this,void 0,void 0,(function*(){return this._getWorkerSource(Y,ie.type,ie.source).getClusterExpansionZoom(ie)})))),this.actor.registerMessageHandler("GCC",((Y,ie)=>d._(this,void 0,void 0,(function*(){return this._getWorkerSource(Y,ie.type,ie.source).getClusterChildren(ie)})))),this.actor.registerMessageHandler("GCL",((Y,ie)=>d._(this,void 0,void 0,(function*(){return this._getWorkerSource(Y,ie.type,ie.source).getClusterLeaves(ie)})))),this.actor.registerMessageHandler("LD",((Y,ie)=>this._getWorkerSource(Y,ie.type,ie.source).loadData(ie))),this.actor.registerMessageHandler("GD",((Y,ie)=>this._getWorkerSource(Y,ie.type,ie.source).getData())),this.actor.registerMessageHandler("LT",((Y,ie)=>this._getWorkerSource(Y,ie.type,ie.source).loadTile(ie))),this.actor.registerMessageHandler("RT",((Y,ie)=>this._getWorkerSource(Y,ie.type,ie.source).reloadTile(ie))),this.actor.registerMessageHandler("AT",((Y,ie)=>this._getWorkerSource(Y,ie.type,ie.source).abortTile(ie))),this.actor.registerMessageHandler("RMT",((Y,ie)=>this._getWorkerSource(Y,ie.type,ie.source).removeTile(ie))),this.actor.registerMessageHandler("RS",((Y,ie)=>d._(this,void 0,void 0,(function*(){if(!this.workerSources[Y]||!this.workerSources[Y][ie.type]||!this.workerSources[Y][ie.type][ie.source])return;const ue=this.workerSources[Y][ie.type][ie.source];delete this.workerSources[Y][ie.type][ie.source],ue.removeSource!==void 0&&ue.removeSource(ie)})))),this.actor.registerMessageHandler("RM",(Y=>d._(this,void 0,void 0,(function*(){delete this.layerIndexes[Y],delete this.availableImages[Y],delete this.workerSources[Y],delete this.demWorkerSources[Y]})))),this.actor.registerMessageHandler("SR",((Y,ie)=>d._(this,void 0,void 0,(function*(){this.referrer=ie})))),this.actor.registerMessageHandler("SRPS",((Y,ie)=>this._syncRTLPluginState(Y,ie))),this.actor.registerMessageHandler("IS",((Y,ie)=>d._(this,void 0,void 0,(function*(){this.self.importScripts(ie)})))),this.actor.registerMessageHandler("SI",((Y,ie)=>this._setImages(Y,ie))),this.actor.registerMessageHandler("UL",((Y,ie)=>d._(this,void 0,void 0,(function*(){this._getLayerIndex(Y).update(ie.layers,ie.removedIds)})))),this.actor.registerMessageHandler("SL",((Y,ie)=>d._(this,void 0,void 0,(function*(){this._getLayerIndex(Y).replace(ie)}))))}_setImages(B,Y){return d._(this,void 0,void 0,(function*(){this.availableImages[B]=Y;for(const ie in this.workerSources[B]){const ue=this.workerSources[B][ie];for(const Ae in ue)ue[Ae].availableImages=Y}}))}_syncRTLPluginState(B,Y){return d._(this,void 0,void 0,(function*(){return yield d.cE.syncState(Y,this.self.importScripts)}))}_getAvailableImages(B){let Y=this.availableImages[B];return Y||(Y=[]),Y}_getLayerIndex(B){let Y=this.layerIndexes[B];return Y||(Y=this.layerIndexes[B]=new a),Y}_getWorkerSource(B,Y,ie){if(this.workerSources[B]||(this.workerSources[B]={}),this.workerSources[B][Y]||(this.workerSources[B][Y]={}),!this.workerSources[B][Y][ie]){const ue={sendAsync:(Ae,Oe)=>(Ae.targetMapId=B,this.actor.sendAsync(Ae,Oe))};switch(Y){case"vector":this.workerSources[B][Y][ie]=new I(ue,this._getLayerIndex(B),this._getAvailableImages(B));break;case"geojson":this.workerSources[B][Y][ie]=new Go(ue,this._getLayerIndex(B),this._getAvailableImages(B));break;default:this.workerSources[B][Y][ie]=new this.externalWorkerSourceTypes[Y](ue,this._getLayerIndex(B),this._getAvailableImages(B))}}return this.workerSources[B][Y][ie]}_getDEMWorkerSource(B,Y){return this.demWorkerSources[B]||(this.demWorkerSources[B]={}),this.demWorkerSources[B][Y]||(this.demWorkerSources[B][Y]=new D),this.demWorkerSources[B][Y]}}return d.i(self)&&(self.worker=new Un(self)),Un})),o("index",["exports","./shared"],(function(d,a){var y="5.2.0";function w(){var _=new a.A(4);return a.A!=Float32Array&&(_[1]=0,_[2]=0),_[0]=1,_[3]=1,_}let E,I;const D={now:typeof performance<"u"&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frame(_,n,l){const p=requestAnimationFrame((x=>{g(),n(x)})),{unsubscribe:g}=a.s(_.signal,"abort",(()=>{g(),cancelAnimationFrame(p),l(a.c())}),!1)},frameAsync(_){return new Promise(((n,l)=>{this.frame(_,n,l)}))},getImageData(_,n=0){return this.getImageCanvasContext(_).getImageData(-n,-n,_.width+2*n,_.height+2*n)},getImageCanvasContext(_){const n=window.document.createElement("canvas"),l=n.getContext("2d",{willReadFrequently:!0});if(!l)throw new Error("failed to create canvas 2d context");return n.width=_.width,n.height=_.height,l.drawImage(_,0,0,_.width,_.height),l},resolveURL:_=>(E||(E=document.createElement("a")),E.href=_,E.href),hardwareConcurrency:typeof navigator<"u"&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(I==null&&(I=matchMedia("(prefers-reduced-motion: reduce)")),I.matches)}};class F{static testProp(n){if(!F.docStyle)return n[0];for(let l=0;l<n.length;l++)if(n[l]in F.docStyle)return n[l];return n[0]}static create(n,l,p){const g=window.document.createElement(n);return l!==void 0&&(g.className=l),p&&p.appendChild(g),g}static createNS(n,l){return window.document.createElementNS(n,l)}static disableDrag(){F.docStyle&&F.selectProp&&(F.userSelect=F.docStyle[F.selectProp],F.docStyle[F.selectProp]="none")}static enableDrag(){F.docStyle&&F.selectProp&&(F.docStyle[F.selectProp]=F.userSelect)}static setTransform(n,l){n.style[F.transformProp]=l}static addEventListener(n,l,p,g={}){n.addEventListener(l,p,"passive"in g?g:g.capture)}static removeEventListener(n,l,p,g={}){n.removeEventListener(l,p,"passive"in g?g:g.capture)}static suppressClickInternal(n){n.preventDefault(),n.stopPropagation(),window.removeEventListener("click",F.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",F.suppressClickInternal,!0),window.setTimeout((()=>{window.removeEventListener("click",F.suppressClickInternal,!0)}),0)}static getScale(n){const l=n.getBoundingClientRect();return{x:l.width/n.offsetWidth||1,y:l.height/n.offsetHeight||1,boundingClientRect:l}}static getPoint(n,l,p){const g=l.boundingClientRect;return new a.P((p.clientX-g.left)/l.x-n.clientLeft,(p.clientY-g.top)/l.y-n.clientTop)}static mousePos(n,l){const p=F.getScale(n);return F.getPoint(n,p,l)}static touchPos(n,l){const p=[],g=F.getScale(n);for(let x=0;x<l.length;x++)p.push(F.getPoint(n,g,l[x]));return p}static mouseButton(n){return n.button}static remove(n){n.parentNode&&n.parentNode.removeChild(n)}static sanitize(n){const l=new DOMParser().parseFromString(n,"text/html").body||document.createElement("body"),p=l.querySelectorAll("script");for(const g of p)g.remove();return F.clean(l),l.innerHTML}static isPossiblyDangerous(n,l){const p=l.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(n)||!p.includes("javascript:")&&!p.includes("data:"))||!!n.startsWith("on")||void 0}static clean(n){const l=n.children;for(const p of l)F.removeAttributes(p),F.clean(p)}static removeAttributes(n){for(const{name:l,value:p}of n.attributes)F.isPossiblyDangerous(l,p)&&n.removeAttribute(l)}}F.docStyle=typeof window<"u"&&window.document&&window.document.documentElement.style,F.selectProp=F.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),F.transformProp=F.testProp(["transform","WebkitTransform"]);const X={supported:!1,testSupport:function(_){!ge&&_e&&(fe?Te(_):oe=_)}};let oe,_e,ge=!1,fe=!1;function Te(_){const n=_.createTexture();_.bindTexture(_.TEXTURE_2D,n);try{if(_.texImage2D(_.TEXTURE_2D,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,_e),_.isContextLost())return;X.supported=!0}catch{}_.deleteTexture(n),ge=!0}var ke;typeof document<"u"&&(_e=document.createElement("img"),_e.onload=()=>{oe&&Te(oe),oe=null,fe=!0},_e.onerror=()=>{ge=!0,oe=null},_e.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),(function(_){let n,l,p,g;_.resetRequestQueue=()=>{n=[],l=0,p=0,g={}},_.addThrottleControl=C=>{const R=p++;return g[R]=C,R},_.removeThrottleControl=C=>{delete g[C],T()},_.getImage=(C,R,L=!0)=>new Promise(((N,z)=>{X.supported&&(C.headers||(C.headers={}),C.headers.accept="image/webp,*/*"),a.e(C,{type:"image"}),n.push({abortController:R,requestParameters:C,supportImageRefresh:L,state:"queued",onError:H=>{z(H)},onSuccess:H=>{N(H)}}),T()}));const x=C=>a._(this,void 0,void 0,(function*(){C.state="running";const{requestParameters:R,supportImageRefresh:L,onError:N,onSuccess:z,abortController:H}=C,q=L===!1&&!a.i(self)&&!a.g(R.url)&&(!R.headers||Object.keys(R.headers).reduce(((le,he)=>le&&he==="accept"),!0));l++;const se=q?A(R,H):a.m(R,H);try{const le=yield se;delete C.abortController,C.state="completed",le.data instanceof HTMLImageElement||a.b(le.data)?z(le):le.data&&z({data:yield(ne=le.data,typeof createImageBitmap=="function"?a.f(ne):a.h(ne)),cacheControl:le.cacheControl,expires:le.expires})}catch(le){delete C.abortController,N(le)}finally{l--,T()}var ne})),T=()=>{const C=(()=>{for(const R of Object.keys(g))if(g[R]())return!0;return!1})()?a.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:a.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let R=l;R<C&&n.length>0;R++){const L=n.shift();L.abortController.signal.aborted?R--:x(L)}},A=(C,R)=>new Promise(((L,N)=>{const z=new Image,H=C.url,q=C.credentials;q&&q==="include"?z.crossOrigin="use-credentials":(q&&q==="same-origin"||!a.d(H))&&(z.crossOrigin="anonymous"),R.signal.addEventListener("abort",(()=>{z.src="",N(a.c())})),z.fetchPriority="high",z.onload=()=>{z.onerror=z.onload=null,L({data:z})},z.onerror=()=>{z.onerror=z.onload=null,R.signal.aborted||N(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},z.src=H}))})(ke||(ke={})),ke.resetRequestQueue();class Je{constructor(n){this._transformRequestFn=n}transformRequest(n,l){return this._transformRequestFn&&this._transformRequestFn(n,l)||{url:n}}setTransformRequest(n){this._transformRequestFn=n}}function Xe(_){const n=[];if(typeof _=="string")n.push({id:"default",url:_});else if(_&&_.length>0){const l=[];for(const{id:p,url:g}of _){const x=`${p}${g}`;l.indexOf(x)===-1&&(l.push(x),n.push({id:p,url:g}))}}return n}function mt(_,n,l){try{const p=new URL(_);return p.pathname+=`${n}${l}`,p.toString()}catch{throw new Error(`Invalid sprite URL "${_}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}class G{constructor(n,l,p,g){this.context=n,this.format=p,this.texture=n.gl.createTexture(),this.update(l,g)}update(n,l,p){const{width:g,height:x}=n,T=!(this.size&&this.size[0]===g&&this.size[1]===x||p),{context:A}=this,{gl:C}=A;if(this.useMipmap=!!(l&&l.useMipmap),C.bindTexture(C.TEXTURE_2D,this.texture),A.pixelStoreUnpackFlipY.set(!1),A.pixelStoreUnpack.set(1),A.pixelStoreUnpackPremultiplyAlpha.set(this.format===C.RGBA&&(!l||l.premultiply!==!1)),T)this.size=[g,x],n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||a.b(n)?C.texImage2D(C.TEXTURE_2D,0,this.format,this.format,C.UNSIGNED_BYTE,n):C.texImage2D(C.TEXTURE_2D,0,this.format,g,x,0,this.format,C.UNSIGNED_BYTE,n.data);else{const{x:R,y:L}=p||{x:0,y:0};n instanceof HTMLImageElement||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement||n instanceof ImageData||a.b(n)?C.texSubImage2D(C.TEXTURE_2D,0,R,L,C.RGBA,C.UNSIGNED_BYTE,n):C.texSubImage2D(C.TEXTURE_2D,0,R,L,g,x,C.RGBA,C.UNSIGNED_BYTE,n.data)}this.useMipmap&&this.isSizePowerOfTwo()&&C.generateMipmap(C.TEXTURE_2D)}bind(n,l,p){const{context:g}=this,{gl:x}=g;x.bindTexture(x.TEXTURE_2D,this.texture),p!==x.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(p=x.LINEAR),n!==this.filter&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,n),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,p||n),this.filter=n),l!==this.wrap&&(x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,l),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,l),this.wrap=l)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}}function J(_){const{userImage:n}=_;return!!(n&&n.render&&n.render())&&(_.data.replace(new Uint8Array(n.data.buffer)),!0)}class ae extends a.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new a.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(n){if(this.loaded!==n&&(this.loaded=n,n)){for(const{ids:l,promiseResolve:p}of this.requestors)p(this._getImagesForIds(l));this.requestors=[]}}getImage(n){const l=this.images[n];if(l&&!l.data&&l.spriteData){const p=l.spriteData;l.data=new a.R({width:p.width,height:p.height},p.context.getImageData(p.x,p.y,p.width,p.height).data),l.spriteData=null}return l}addImage(n,l){if(this.images[n])throw new Error(`Image id ${n} already exist, use updateImage instead`);this._validate(n,l)&&(this.images[n]=l)}_validate(n,l){let p=!0;const g=l.data||l.spriteData;return this._validateStretch(l.stretchX,g&&g.width)||(this.fire(new a.k(new Error(`Image "${n}" has invalid "stretchX" value`))),p=!1),this._validateStretch(l.stretchY,g&&g.height)||(this.fire(new a.k(new Error(`Image "${n}" has invalid "stretchY" value`))),p=!1),this._validateContent(l.content,l)||(this.fire(new a.k(new Error(`Image "${n}" has invalid "content" value`))),p=!1),p}_validateStretch(n,l){if(!n)return!0;let p=0;for(const g of n){if(g[0]<p||g[1]<g[0]||l<g[1])return!1;p=g[1]}return!0}_validateContent(n,l){if(!n)return!0;if(n.length!==4)return!1;const p=l.spriteData,g=p&&p.width||l.data.width,x=p&&p.height||l.data.height;return!(n[0]<0||g<n[0]||n[1]<0||x<n[1]||n[2]<0||g<n[2]||n[3]<0||x<n[3]||n[2]<n[0]||n[3]<n[1])}updateImage(n,l,p=!0){const g=this.getImage(n);if(p&&(g.data.width!==l.data.width||g.data.height!==l.data.height))throw new Error(`size mismatch between old image (${g.data.width}x${g.data.height}) and new image (${l.data.width}x${l.data.height}).`);l.version=g.version+1,this.images[n]=l,this.updatedImages[n]=!0}removeImage(n){const l=this.images[n];delete this.images[n],delete this.patterns[n],l.userImage&&l.userImage.onRemove&&l.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(n){return new Promise(((l,p)=>{let g=!0;if(!this.isLoaded())for(const x of n)this.images[x]||(g=!1);this.isLoaded()||g?l(this._getImagesForIds(n)):this.requestors.push({ids:n,promiseResolve:l})}))}_getImagesForIds(n){const l={};for(const p of n){let g=this.getImage(p);g||(this.fire(new a.l("styleimagemissing",{id:p})),g=this.getImage(p)),g?l[p]={data:g.data.clone(),pixelRatio:g.pixelRatio,sdf:g.sdf,version:g.version,stretchX:g.stretchX,stretchY:g.stretchY,content:g.content,textFitWidth:g.textFitWidth,textFitHeight:g.textFitHeight,hasRenderCallback:!!(g.userImage&&g.userImage.render)}:a.w(`Image "${p}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return l}getPixelSize(){const{width:n,height:l}=this.atlasImage;return{width:n,height:l}}getPattern(n){const l=this.patterns[n],p=this.getImage(n);if(!p)return null;if(l&&l.position.version===p.version)return l.position;if(l)l.position.version=p.version;else{const g={w:p.data.width+2,h:p.data.height+2,x:0,y:0},x=new a.I(g,p);this.patterns[n]={bin:g,position:x}}return this._updatePatternAtlas(),this.patterns[n].position}bind(n){const l=n.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new G(n,this.atlasImage,l.RGBA),this.atlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE)}_updatePatternAtlas(){const n=[];for(const x in this.patterns)n.push(this.patterns[x].bin);const{w:l,h:p}=a.p(n),g=this.atlasImage;g.resize({width:l||1,height:p||1});for(const x in this.patterns){const{bin:T}=this.patterns[x],A=T.x+1,C=T.y+1,R=this.getImage(x).data,L=R.width,N=R.height;a.R.copy(R,g,{x:0,y:0},{x:A,y:C},{width:L,height:N}),a.R.copy(R,g,{x:0,y:N-1},{x:A,y:C-1},{width:L,height:1}),a.R.copy(R,g,{x:0,y:0},{x:A,y:C+N},{width:L,height:1}),a.R.copy(R,g,{x:L-1,y:0},{x:A-1,y:C},{width:1,height:N}),a.R.copy(R,g,{x:0,y:0},{x:A+L,y:C},{width:1,height:N})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(n){for(const l of n){if(this.callbackDispatchedThisFrame[l])continue;this.callbackDispatchedThisFrame[l]=!0;const p=this.getImage(l);p||a.w(`Image with ID: "${l}" was not found`),J(p)&&this.updateImage(l,p)}}}const be=1e20;function ye(_,n,l,p,g,x,T,A,C){for(let R=n;R<n+p;R++)we(_,l*x+R,x,g,T,A,C);for(let R=l;R<l+g;R++)we(_,R*x+n,1,p,T,A,C)}function we(_,n,l,p,g,x,T){x[0]=0,T[0]=-1e20,T[1]=be,g[0]=_[n];for(let A=1,C=0,R=0;A<p;A++){g[A]=_[n+A*l];const L=A*A;do{const N=x[C];R=(g[A]-g[N]+L-N*N)/(A-N)/2}while(R<=T[C]&&--C>-1);C++,x[C]=A,T[C]=R,T[C+1]=be}for(let A=0,C=0;A<p;A++){for(;T[C+1]<A;)C++;const R=x[C],L=A-R;_[n+A*l]=g[R]+L*L}}class Se{constructor(n,l){this.requestManager=n,this.localIdeographFontFamily=l,this.entries={}}setURL(n){this.url=n}getGlyphs(n){return a._(this,void 0,void 0,(function*(){const l=[];for(const x in n)for(const T of n[x])l.push(this._getAndCacheGlyphsPromise(x,T));const p=yield Promise.all(l),g={};for(const{stack:x,id:T,glyph:A}of p)g[x]||(g[x]={}),g[x][T]=A&&{id:A.id,bitmap:A.bitmap.clone(),metrics:A.metrics};return g}))}_getAndCacheGlyphsPromise(n,l){return a._(this,void 0,void 0,(function*(){let p=this.entries[n];p||(p=this.entries[n]={glyphs:{},requests:{},ranges:{}});let g=p.glyphs[l];if(g!==void 0)return{stack:n,id:l,glyph:g};if(g=this._tinySDF(p,n,l),g)return p.glyphs[l]=g,{stack:n,id:l,glyph:g};const x=Math.floor(l/256);if(256*x>65535)throw new Error("glyphs > 65535 not supported");if(p.ranges[x])return{stack:n,id:l,glyph:g};if(!this.url)throw new Error("glyphsUrl is not set");if(!p.requests[x]){const A=Se.loadGlyphRange(n,x,this.url,this.requestManager);p.requests[x]=A}const T=yield p.requests[x];for(const A in T)this._doesCharSupportLocalGlyph(+A)||(p.glyphs[+A]=T[+A]);return p.ranges[x]=!0,{stack:n,id:l,glyph:T[l]||null}}))}_doesCharSupportLocalGlyph(n){return!!this.localIdeographFontFamily&&(/\p{Ideo}|\p{sc=Hang}|\p{sc=Hira}|\p{sc=Kana}/u.test(String.fromCodePoint(n))||a.u["CJK Unified Ideographs"](n)||a.u["Hangul Syllables"](n)||a.u.Hiragana(n)||a.u.Katakana(n)||a.u["CJK Symbols and Punctuation"](n)||a.u["Halfwidth and Fullwidth Forms"](n))}_tinySDF(n,l,p){const g=this.localIdeographFontFamily;if(!g||!this._doesCharSupportLocalGlyph(p))return;let x=n.tinySDF;if(!x){let A="400";/bold/i.test(l)?A="900":/medium/i.test(l)?A="500":/light/i.test(l)&&(A="200"),x=n.tinySDF=new Se.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:g,fontWeight:A})}const T=x.draw(String.fromCharCode(p));return{id:p,bitmap:new a.q({width:T.width||60,height:T.height||60},T.data),metrics:{width:T.glyphWidth/2||24,height:T.glyphHeight/2||24,left:T.glyphLeft/2+.5||0,top:T.glyphTop/2-27.5||-8,advance:T.glyphAdvance/2||24,isDoubleResolution:!0}}}}Se.loadGlyphRange=function(_,n,l,p){return a._(this,void 0,void 0,(function*(){const g=256*n,x=g+255,T=p.transformRequest(l.replace("{fontstack}",_).replace("{range}",`${g}-${x}`),"Glyphs"),A=yield a.n(T,new AbortController);if(!A||!A.data)throw new Error(`Could not load glyph range. range: ${n}, ${g}-${x}`);const C={};for(const R of a.o(A.data))C[R.id]=R;return C}))},Se.TinySDF=class{constructor({fontSize:_=24,buffer:n=3,radius:l=8,cutoff:p=.25,fontFamily:g="sans-serif",fontWeight:x="normal",fontStyle:T="normal"}={}){this.buffer=n,this.cutoff=p,this.radius=l;const A=this.size=_+4*n,C=this._createCanvas(A),R=this.ctx=C.getContext("2d",{willReadFrequently:!0});R.font=`${T} ${x} ${_}px ${g}`,R.textBaseline="alphabetic",R.textAlign="left",R.fillStyle="black",this.gridOuter=new Float64Array(A*A),this.gridInner=new Float64Array(A*A),this.f=new Float64Array(A),this.z=new Float64Array(A+1),this.v=new Uint16Array(A)}_createCanvas(_){const n=document.createElement("canvas");return n.width=n.height=_,n}draw(_){const{width:n,actualBoundingBoxAscent:l,actualBoundingBoxDescent:p,actualBoundingBoxLeft:g,actualBoundingBoxRight:x}=this.ctx.measureText(_),T=Math.ceil(l),A=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(x-g))),C=Math.min(this.size-this.buffer,T+Math.ceil(p)),R=A+2*this.buffer,L=C+2*this.buffer,N=Math.max(R*L,0),z=new Uint8ClampedArray(N),H={data:z,width:R,height:L,glyphWidth:A,glyphHeight:C,glyphTop:T,glyphLeft:0,glyphAdvance:n};if(A===0||C===0)return H;const{ctx:q,buffer:se,gridInner:ne,gridOuter:le}=this;q.clearRect(se,se,A,C),q.fillText(_,se,se+T);const he=q.getImageData(se,se,A,C);le.fill(be,0,N),ne.fill(0,0,N);for(let xe=0;xe<C;xe++)for(let ve=0;ve<A;ve++){const Pe=he.data[4*(xe*A+ve)+3]/255;if(Pe===0)continue;const Re=(xe+se)*R+ve+se;if(Pe===1)le[Re]=0,ne[Re]=be;else{const Ie=.5-Pe;le[Re]=Ie>0?Ie*Ie:0,ne[Re]=Ie<0?Ie*Ie:0}}ye(le,0,0,R,L,R,this.f,this.v,this.z),ye(ne,se,se,A,C,R,this.f,this.v,this.z);for(let xe=0;xe<N;xe++){const ve=Math.sqrt(le[xe])-Math.sqrt(ne[xe]);z[xe]=Math.round(255-255*(ve/this.radius+this.cutoff))}return H}};class Ee{constructor(){this.specification=a.v.light.position}possiblyEvaluate(n,l){return a.z(n.expression.evaluate(l))}interpolate(n,l,p){return{x:a.B.number(n.x,l.x,p),y:a.B.number(n.y,l.y,p),z:a.B.number(n.z,l.z,p)}}}let W;class ee extends a.E{constructor(n){super(),W=W||new a.r({anchor:new a.D(a.v.light.anchor),position:new Ee,color:new a.D(a.v.light.color),intensity:new a.D(a.v.light.intensity)}),this._transitionable=new a.T(W),this.setLight(n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(n,l={}){if(!this._validate(a.t,n,l))for(const p in n){const g=n[p];p.endsWith("-transition")?this._transitionable.setTransition(p.slice(0,-11),g):this._transitionable.setValue(p,g)}}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}_validate(n,l,p){return(!p||p.validate!==!1)&&a.x(this,n.call(a.y,{value:l,style:{glyphs:!0,sprite:!0},styleSpec:a.v}))}}const K=new a.r({"sky-color":new a.D(a.v.sky["sky-color"]),"horizon-color":new a.D(a.v.sky["horizon-color"]),"fog-color":new a.D(a.v.sky["fog-color"]),"fog-ground-blend":new a.D(a.v.sky["fog-ground-blend"]),"horizon-fog-blend":new a.D(a.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new a.D(a.v.sky["sky-horizon-blend"]),"atmosphere-blend":new a.D(a.v.sky["atmosphere-blend"])});class Ce extends a.E{constructor(n){super(),this._transitionable=new a.T(K),this.setSky(n),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new a.C(0))}setSky(n,l={}){if(!this._validate(a.F,n,l)){n||(n={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const p in n){const g=n[p];p.endsWith("-transition")?this._transitionable.setTransition(p.slice(0,-11),g):this._transitionable.setValue(p,g)}}}getSky(){return this._transitionable.serialize()}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}_validate(n,l,p={}){return p?.validate!==!1&&a.x(this,n.call(a.y,a.e({value:l,style:{glyphs:!0,sprite:!0},styleSpec:a.v})))}calculateFogBlendOpacity(n){return n<60?0:n<70?(n-60)/10:1}}class je{constructor(n,l){this.width=n,this.height=l,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(n,l){const p=n.join(",")+String(l);return this.dashEntry[p]||(this.dashEntry[p]=this.addDash(n,l)),this.dashEntry[p]}getDashRanges(n,l,p){const g=[];let x=n.length%2==1?-n[n.length-1]*p:0,T=n[0]*p,A=!0;g.push({left:x,right:T,isDash:A,zeroLength:n[0]===0});let C=n[0];for(let R=1;R<n.length;R++){A=!A;const L=n[R];x=C*p,C+=L,T=C*p,g.push({left:x,right:T,isDash:A,zeroLength:L===0})}return g}addRoundDash(n,l,p){const g=l/2;for(let x=-p;x<=p;x++){const T=this.width*(this.nextRow+p+x);let A=0,C=n[A];for(let R=0;R<this.width;R++){R/C.right>1&&(C=n[++A]);const L=Math.abs(R-C.left),N=Math.abs(R-C.right),z=Math.min(L,N);let H;const q=x/p*(g+1);if(C.isDash){const se=g-Math.abs(q);H=Math.sqrt(z*z+se*se)}else H=g-Math.sqrt(z*z+q*q);this.data[T+R]=Math.max(0,Math.min(255,H+128))}}}addRegularDash(n){for(let A=n.length-1;A>=0;--A){const C=n[A],R=n[A+1];C.zeroLength?n.splice(A,1):R&&R.isDash===C.isDash&&(R.left=C.left,n.splice(A,1))}const l=n[0],p=n[n.length-1];l.isDash===p.isDash&&(l.left=p.left-this.width,p.right=l.right+this.width);const g=this.width*this.nextRow;let x=0,T=n[x];for(let A=0;A<this.width;A++){A/T.right>1&&(T=n[++x]);const C=Math.abs(A-T.left),R=Math.abs(A-T.right),L=Math.min(C,R);this.data[g+A]=Math.max(0,Math.min(255,(T.isDash?L:-L)+128))}}addDash(n,l){const p=l?7:0,g=2*p+1;if(this.nextRow+g>this.height)return a.w("LineAtlas out of space"),null;let x=0;for(let A=0;A<n.length;A++)x+=n[A];if(x!==0){const A=this.width/x,C=this.getDashRanges(n,this.width,A);l?this.addRoundDash(C,A,p):this.addRegularDash(C)}const T={y:(this.nextRow+p+.5)/this.height,height:2*p/this.height,width:x};return this.nextRow+=g,this.dirty=!0,T}bind(n){const l=n.gl;this.texture?(l.bindTexture(l.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,l.texSubImage2D(l.TEXTURE_2D,0,0,0,this.width,this.height,l.ALPHA,l.UNSIGNED_BYTE,this.data))):(this.texture=l.createTexture(),l.bindTexture(l.TEXTURE_2D,this.texture),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.REPEAT),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.REPEAT),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.LINEAR),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.LINEAR),l.texImage2D(l.TEXTURE_2D,0,l.ALPHA,this.width,this.height,0,l.ALPHA,l.UNSIGNED_BYTE,this.data))}}const Ge="maplibre_preloaded_worker_pool";class tt{constructor(){this.active={}}acquire(n){if(!this.workers)for(this.workers=[];this.workers.length<tt.workerCount;)this.workers.push(new Worker(a.a.WORKER_URL));return this.active[n]=!0,this.workers.slice()}release(n){delete this.active[n],this.numActive()===0&&(this.workers.forEach((l=>{l.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Ge]}numActive(){return Object.keys(this.active).length}}const pt=Math.floor(D.hardwareConcurrency/2);let bt,_t;function Lt(){return bt||(bt=new tt),bt}tt.workerCount=a.G(globalThis)?Math.max(Math.min(pt,3),1):1;class Ut{constructor(n,l){this.workerPool=n,this.actors=[],this.currentActor=0,this.id=l;const p=this.workerPool.acquire(l);for(let g=0;g<p.length;g++){const x=new a.H(p[g],l);x.name=`Worker ${g}`,this.actors.push(x)}if(!this.actors.length)throw new Error("No actors found")}broadcast(n,l){const p=[];for(const g of this.actors)p.push(g.sendAsync({type:n,data:l}));return Promise.all(p)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(n=!0){this.actors.forEach((l=>{l.remove()})),this.actors=[],n&&this.workerPool.release(this.id)}registerMessageHandler(n,l){for(const p of this.actors)p.registerMessageHandler(n,l)}}function Wt(){return _t||(_t=new Ut(Lt(),a.J),_t.registerMessageHandler("GR",((_,n,l)=>a.m(n,l)))),_t}function oi(_,n){const l=a.K();return a.L(l,l,[1,1,0]),a.M(l,l,[.5*_.width,.5*_.height,1]),_.calculatePosMatrix?a.N(l,l,_.calculatePosMatrix(n.toUnwrapped())):l}function ei(_,n,l,p,g,x){var T;const A=(function(N,z,H){if(N)for(const q of N){const se=z[q];if(se&&se.source===H&&se.type==="fill-extrusion")return!0}else for(const q in z){const se=z[q];if(se.source===H&&se.type==="fill-extrusion")return!0}return!1})((T=g?.layers)!==null&&T!==void 0?T:null,n,_.id),C=x.maxPitchScaleFactor(),R=_.tilesIn(p,C,A);R.sort(ci);const L=[];for(const N of R)L.push({wrappedTileID:N.tileID.wrapped().key,queryResults:N.tile.queryRenderedFeatures(n,l,_._state,N.queryGeometry,N.cameraQueryGeometry,N.scale,g,x,C,oi(_.transform,N.tileID))});return(function(N,z){for(const H in N)for(const q of N[H])di(q,z);return N})((function(N){const z={},H={};for(const q of N){const se=q.queryResults,ne=q.wrappedTileID,le=H[ne]=H[ne]||{};for(const he in se){const xe=se[he],ve=le[he]=le[he]||{},Pe=z[he]=z[he]||[];for(const Re of xe)ve[Re.featureIndex]||(ve[Re.featureIndex]=!0,Pe.push(Re))}}return z})(L),_)}function ci(_,n){const l=_.tileID,p=n.tileID;return l.overscaledZ-p.overscaledZ||l.canonical.y-p.canonical.y||l.wrap-p.wrap||l.canonical.x-p.canonical.x}function di(_,n){const l=_.feature,p=n.getFeatureState(l.layer["source-layer"],l.id);l.source=l.layer.source,l.layer["source-layer"]&&(l.sourceLayer=l.layer["source-layer"]),l.state=p}function Ai(_,n,l){return a._(this,void 0,void 0,(function*(){let p=_;if(_.url?p=(yield a.j(n.transformRequest(_.url,"Source"),l)).data:yield D.frameAsync(l),!p)return null;const g=a.O(a.e(p,_),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in p&&p.vector_layers&&(g.vectorLayerIds=p.vector_layers.map((x=>x.id))),g}))}class Yt{constructor(n,l){n&&(l?this.setSouthWest(n).setNorthEast(l):Array.isArray(n)&&(n.length===4?this.setSouthWest([n[0],n[1]]).setNorthEast([n[2],n[3]]):this.setSouthWest(n[0]).setNorthEast(n[1])))}setNorthEast(n){return this._ne=n instanceof a.Q?new a.Q(n.lng,n.lat):a.Q.convert(n),this}setSouthWest(n){return this._sw=n instanceof a.Q?new a.Q(n.lng,n.lat):a.Q.convert(n),this}extend(n){const l=this._sw,p=this._ne;let g,x;if(n instanceof a.Q)g=n,x=n;else{if(!(n instanceof Yt))return Array.isArray(n)?n.length===4||n.every(Array.isArray)?this.extend(Yt.convert(n)):this.extend(a.Q.convert(n)):n&&("lng"in n||"lon"in n)&&"lat"in n?this.extend(a.Q.convert(n)):this;if(g=n._sw,x=n._ne,!g||!x)return this}return l||p?(l.lng=Math.min(g.lng,l.lng),l.lat=Math.min(g.lat,l.lat),p.lng=Math.max(x.lng,p.lng),p.lat=Math.max(x.lat,p.lat)):(this._sw=new a.Q(g.lng,g.lat),this._ne=new a.Q(x.lng,x.lat)),this}getCenter(){return new a.Q((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new a.Q(this.getWest(),this.getNorth())}getSouthEast(){return new a.Q(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(n){const{lng:l,lat:p}=a.Q.convert(n);let g=this._sw.lng<=l&&l<=this._ne.lng;return this._sw.lng>this._ne.lng&&(g=this._sw.lng>=l&&l>=this._ne.lng),this._sw.lat<=p&&p<=this._ne.lat&&g}static convert(n){return n instanceof Yt?n:n&&new Yt(n)}static fromLngLat(n,l=0){const p=360*l/40075017,g=p/Math.cos(Math.PI/180*n.lat);return new Yt(new a.Q(n.lng-g,n.lat-p),new a.Q(n.lng+g,n.lat+p))}adjustAntiMeridian(){const n=new a.Q(this._sw.lng,this._sw.lat),l=new a.Q(this._ne.lng,this._ne.lat);return new Yt(n,n.lng>l.lng?new a.Q(l.lng+360,l.lat):l)}}class kt{constructor(n,l,p){this.bounds=Yt.convert(this.validateBounds(n)),this.minzoom=l||0,this.maxzoom=p||24}validateBounds(n){return Array.isArray(n)&&n.length===4?[Math.max(-180,n[0]),Math.max(-90,n[1]),Math.min(180,n[2]),Math.min(90,n[3])]:[-180,-90,180,90]}contains(n){const l=Math.pow(2,n.z),p=Math.floor(a.U(this.bounds.getWest())*l),g=Math.floor(a.S(this.bounds.getNorth())*l),x=Math.ceil(a.U(this.bounds.getEast())*l),T=Math.ceil(a.S(this.bounds.getSouth())*l);return n.x>=p&&n.x<x&&n.y>=g&&n.y<T}}class Jt extends a.E{constructor(n,l,p,g){if(super(),this.id=n,this.dispatcher=p,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,a.e(this,a.O(l,["url","scheme","tileSize","promoteId"])),this._options=a.e({type:"vector"},l),this._collectResourceTiming=l.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(g)}load(){return a._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new a.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const n=yield Ai(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),n&&(a.e(this,n),n.bounds&&(this.tileBounds=new kt(n.bounds,this.minzoom,this.maxzoom)),this.fire(new a.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.l("data",{dataType:"source",sourceDataType:"content"})))}catch(n){this._tileJSONRequest=null,this.fire(new a.k(n))}}))}loaded(){return this._loaded}hasTile(n){return!this.tileBounds||this.tileBounds.contains(n.canonical)}onAdd(n){this.map=n,this.load()}setSourceProperty(n){this._tileJSONRequest&&this._tileJSONRequest.abort(),n(),this.load()}setTiles(n){return this.setSourceProperty((()=>{this._options.tiles=n})),this}setUrl(n){return this.setSourceProperty((()=>{this.url=n,this._options.url=n})),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return a.e({},this._options)}loadTile(n){return a._(this,void 0,void 0,(function*(){const l=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),p={request:this.map._requestManager.transformRequest(l,"Tile"),uid:n.uid,tileID:n.tileID,zoom:n.tileID.overscaledZ,tileSize:this.tileSize*n.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};p.request.collectResourceTiming=this._collectResourceTiming;let g="RT";if(n.actor&&n.state!=="expired"){if(n.state==="loading")return new Promise(((x,T)=>{n.reloadPromise={resolve:x,reject:T}}))}else n.actor=this.dispatcher.getActor(),g="LT";n.abortController=new AbortController;try{const x=yield n.actor.sendAsync({type:g,data:p},n.abortController);if(delete n.abortController,n.aborted)return;this._afterTileLoadWorkerResponse(n,x)}catch(x){if(delete n.abortController,n.aborted)return;if(x&&x.status!==404)throw x;this._afterTileLoadWorkerResponse(n,null)}}))}_afterTileLoadWorkerResponse(n,l){if(l&&l.resourceTiming&&(n.resourceTiming=l.resourceTiming),l&&this.map._refreshExpiredTiles&&n.setExpiryData(l),n.loadVectorData(l,this.map.painter),n.reloadPromise){const p=n.reloadPromise;n.reloadPromise=null,this.loadTile(n).then(p.resolve).catch(p.reject)}}abortTile(n){return a._(this,void 0,void 0,(function*(){n.abortController&&(n.abortController.abort(),delete n.abortController),n.actor&&(yield n.actor.sendAsync({type:"AT",data:{uid:n.uid,type:this.type,source:this.id}}))}))}unloadTile(n){return a._(this,void 0,void 0,(function*(){n.unloadVectorData(),n.actor&&(yield n.actor.sendAsync({type:"RMT",data:{uid:n.uid,type:this.type,source:this.id}}))}))}hasTransition(){return!1}}class sn extends a.E{constructor(n,l,p,g){super(),this.id=n,this.dispatcher=p,this.setEventedParent(g),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=a.e({type:"raster"},l),a.e(this,a.O(l,["url","scheme","tileSize"]))}load(){return a._(this,arguments,void 0,(function*(n=!1){this._loaded=!1,this.fire(new a.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const l=yield Ai(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,l&&(a.e(this,l),l.bounds&&(this.tileBounds=new kt(l.bounds,this.minzoom,this.maxzoom)),this.fire(new a.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new a.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:n})))}catch(l){this._tileJSONRequest=null,this.fire(new a.k(l))}}))}loaded(){return this._loaded}onAdd(n){this.map=n,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(n){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),n(),this.load(!0)}setTiles(n){return this.setSourceProperty((()=>{this._options.tiles=n})),this}setUrl(n){return this.setSourceProperty((()=>{this.url=n,this._options.url=n})),this}serialize(){return a.e({},this._options)}hasTile(n){return!this.tileBounds||this.tileBounds.contains(n.canonical)}loadTile(n){return a._(this,void 0,void 0,(function*(){const l=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);n.abortController=new AbortController;try{const p=yield ke.getImage(this.map._requestManager.transformRequest(l,"Tile"),n.abortController,this.map._refreshExpiredTiles);if(delete n.abortController,n.aborted)return void(n.state="unloaded");if(p&&p.data){this.map._refreshExpiredTiles&&p.cacheControl&&p.expires&&n.setExpiryData({cacheControl:p.cacheControl,expires:p.expires});const g=this.map.painter.context,x=g.gl,T=p.data;n.texture=this.map.painter.getTileTexture(T.width),n.texture?n.texture.update(T,{useMipmap:!0}):(n.texture=new G(g,T,x.RGBA,{useMipmap:!0}),n.texture.bind(x.LINEAR,x.CLAMP_TO_EDGE,x.LINEAR_MIPMAP_NEAREST)),n.state="loaded"}}catch(p){if(delete n.abortController,n.aborted)n.state="unloaded";else if(p)throw n.state="errored",p}}))}abortTile(n){return a._(this,void 0,void 0,(function*(){n.abortController&&(n.abortController.abort(),delete n.abortController)}))}unloadTile(n){return a._(this,void 0,void 0,(function*(){n.texture&&this.map.painter.saveTileTexture(n.texture)}))}hasTransition(){return!1}}class rs extends sn{constructor(n,l,p,g){super(n,l,p,g),this.type="raster-dem",this.maxzoom=22,this._options=a.e({type:"raster-dem"},l),this.encoding=l.encoding||"mapbox",this.redFactor=l.redFactor,this.greenFactor=l.greenFactor,this.blueFactor=l.blueFactor,this.baseShift=l.baseShift}loadTile(n){return a._(this,void 0,void 0,(function*(){const l=n.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),p=this.map._requestManager.transformRequest(l,"Tile");n.neighboringTiles=this._getNeighboringTiles(n.tileID),n.abortController=new AbortController;try{const g=yield ke.getImage(p,n.abortController,this.map._refreshExpiredTiles);if(delete n.abortController,n.aborted)return void(n.state="unloaded");if(g&&g.data){const x=g.data;this.map._refreshExpiredTiles&&g.cacheControl&&g.expires&&n.setExpiryData({cacheControl:g.cacheControl,expires:g.expires});const T=a.b(x)&&a.V()?x:yield this.readImageNow(x),A={type:this.type,uid:n.uid,source:this.id,rawImageData:T,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!n.actor||n.state==="expired"){n.actor=this.dispatcher.getActor();const C=yield n.actor.sendAsync({type:"LDT",data:A});n.dem=C,n.needsHillshadePrepare=!0,n.needsTerrainPrepare=!0,n.state="loaded"}}}catch(g){if(delete n.abortController,n.aborted)n.state="unloaded";else if(g)throw n.state="errored",g}}))}readImageNow(n){return a._(this,void 0,void 0,(function*(){if(typeof VideoFrame<"u"&&a.W()){const l=n.width+2,p=n.height+2;try{return new a.R({width:l,height:p},yield a.X(n,-1,-1,l,p))}catch{}}return D.getImageData(n,1)}))}_getNeighboringTiles(n){const l=n.canonical,p=Math.pow(2,l.z),g=(l.x-1+p)%p,x=l.x===0?n.wrap-1:n.wrap,T=(l.x+1+p)%p,A=l.x+1===p?n.wrap+1:n.wrap,C={};return C[new a.Y(n.overscaledZ,x,l.z,g,l.y).key]={backfilled:!1},C[new a.Y(n.overscaledZ,A,l.z,T,l.y).key]={backfilled:!1},l.y>0&&(C[new a.Y(n.overscaledZ,x,l.z,g,l.y-1).key]={backfilled:!1},C[new a.Y(n.overscaledZ,n.wrap,l.z,l.x,l.y-1).key]={backfilled:!1},C[new a.Y(n.overscaledZ,A,l.z,T,l.y-1).key]={backfilled:!1}),l.y+1<p&&(C[new a.Y(n.overscaledZ,x,l.z,g,l.y+1).key]={backfilled:!1},C[new a.Y(n.overscaledZ,n.wrap,l.z,l.x,l.y+1).key]={backfilled:!1},C[new a.Y(n.overscaledZ,A,l.z,T,l.y+1).key]={backfilled:!1}),C}unloadTile(n){return a._(this,void 0,void 0,(function*(){n.demTexture&&this.map.painter.saveTileTexture(n.demTexture),n.fbo&&(n.fbo.destroy(),delete n.fbo),n.dem&&delete n.dem,delete n.neighboringTiles,n.state="unloaded",n.actor&&(yield n.actor.sendAsync({type:"RDT",data:{type:this.type,uid:n.uid,source:this.id}}))}))}}class ns extends a.E{constructor(n,l,p,g){super(),this.id=n,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=p.getActor(),this.setEventedParent(g),this._data=l.data,this._options=a.e({},l),this._collectResourceTiming=l.collectResourceTiming,l.maxzoom!==void 0&&(this.maxzoom=l.maxzoom),l.type&&(this.type=l.type),l.attribution&&(this.attribution=l.attribution),this.promoteId=l.promoteId,l.clusterMaxZoom!==void 0&&this.maxzoom<=l.clusterMaxZoom&&a.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${l.clusterMaxZoom}".`),this.workerOptions=a.e({source:this.id,cluster:l.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(l.buffer!==void 0?l.buffer:128),tolerance:this._pixelsToTileUnits(l.tolerance!==void 0?l.tolerance:.375),extent:a.Z,maxZoom:this.maxzoom,lineMetrics:l.lineMetrics||!1,generateId:l.generateId||!1},superclusterOptions:{maxZoom:l.clusterMaxZoom!==void 0?l.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,l.clusterMinPoints||2),extent:a.Z,radius:this._pixelsToTileUnits(l.clusterRadius||50),log:!1,generateId:l.generateId||!1},clusterProperties:l.clusterProperties,filter:l.filter},l.workerOptions),typeof this.promoteId=="string"&&(this.workerOptions.promoteId=this.promoteId)}_pixelsToTileUnits(n){return n*(a.Z/this.tileSize)}load(){return a._(this,void 0,void 0,(function*(){yield this._updateWorkerData()}))}onAdd(n){this.map=n,this.load()}setData(n){return this._data=n,this._updateWorkerData(),this}updateData(n){return this._updateWorkerData(n),this}getData(){return a._(this,void 0,void 0,(function*(){const n=a.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:n})}))}setClusterOptions(n){return this.workerOptions.cluster=n.cluster,n&&(n.clusterRadius!==void 0&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(n.clusterRadius)),n.clusterMaxZoom!==void 0&&(this.workerOptions.superclusterOptions.maxZoom=n.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(n){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:n,source:this.id}})}getClusterChildren(n){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:n,source:this.id}})}getClusterLeaves(n,l,p){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:n,limit:l,offset:p}})}_updateWorkerData(n){return a._(this,void 0,void 0,(function*(){const l=a.e({type:this.type},this.workerOptions);n?l.dataDiff=n:typeof this._data=="string"?(l.request=this.map._requestManager.transformRequest(D.resolveURL(this._data),"Source"),l.request.collectResourceTiming=this._collectResourceTiming):l.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new a.l("dataloading",{dataType:"source"}));try{const p=yield this.actor.sendAsync({type:"LD",data:l});if(this._pendingLoads--,this._removed||p.abandoned)return void this.fire(new a.l("dataabort",{dataType:"source"}));let g=null;p.resourceTiming&&p.resourceTiming[this.id]&&(g=p.resourceTiming[this.id].slice(0));const x={dataType:"source"};this._collectResourceTiming&&g&&g.length>0&&a.e(x,{resourceTiming:g}),this.fire(new a.l("data",Object.assign(Object.assign({},x),{sourceDataType:"metadata"}))),this.fire(new a.l("data",Object.assign(Object.assign({},x),{sourceDataType:"content"})))}catch(p){if(this._pendingLoads--,this._removed)return void this.fire(new a.l("dataabort",{dataType:"source"}));this.fire(new a.k(p))}}))}loaded(){return this._pendingLoads===0}loadTile(n){return a._(this,void 0,void 0,(function*(){const l=n.actor?"RT":"LT";n.actor=this.actor;const p={type:this.type,uid:n.uid,tileID:n.tileID,zoom:n.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};n.abortController=new AbortController;const g=yield this.actor.sendAsync({type:l,data:p},n.abortController);delete n.abortController,n.unloadVectorData(),n.aborted||n.loadVectorData(g,this.map.painter,l==="RT")}))}abortTile(n){return a._(this,void 0,void 0,(function*(){n.abortController&&(n.abortController.abort(),delete n.abortController),n.aborted=!0}))}unloadTile(n){return a._(this,void 0,void 0,(function*(){n.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:n.uid,type:this.type,source:this.id}})}))}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return a.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}class bn extends a.E{constructor(n,l,p,g){super(),this.flippedWindingOrder=!1,this.id=n,this.dispatcher=p,this.coordinates=l.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(g),this.options=l}load(n){return a._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new a.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const l=yield ke.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,l&&l.data&&(this.image=l.data,n&&(this.coordinates=n),this._finishLoading())}catch(l){this._request=null,this._loaded=!0,this.fire(new a.k(l))}}))}loaded(){return this._loaded}updateImage(n){return n.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=n.url,this.load(n.coordinates).finally((()=>{this.texture=null})),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new a.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(n){this.map=n,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(n){this.coordinates=n;const l=n.map(a.$.fromLngLat);var p;return this.tileID=(function(g){let x=1/0,T=1/0,A=-1/0,C=-1/0;for(const z of g)x=Math.min(x,z.x),T=Math.min(T,z.y),A=Math.max(A,z.x),C=Math.max(C,z.y);const R=Math.max(A-x,C-T),L=Math.max(0,Math.floor(-Math.log(R)/Math.LN2)),N=Math.pow(2,L);return new a.a0(L,Math.floor((x+A)/2*N),Math.floor((T+C)/2*N))})(l),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=l.map((g=>this.tileID.getTilePoint(g)._round())),this.flippedWindingOrder=((p=this.tileCoords)[1].x-p[0].x)*(p[2].y-p[0].y)-(p[1].y-p[0].y)*(p[2].x-p[0].x)<0,this.fire(new a.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(Object.keys(this.tiles).length===0||!this.image)return;const n=this.map.painter.context,l=n.gl;this.texture||(this.texture=new G(n,this.image,l.RGBA),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE));let p=!1;for(const g in this.tiles){const x=this.tiles[g];x.state!=="loaded"&&(x.state="loaded",x.texture=this.texture,p=!0)}p&&this.fire(new a.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(n){return a._(this,void 0,void 0,(function*(){this.tileID&&this.tileID.equals(n.tileID.canonical)?(this.tiles[String(n.tileID.wrap)]=n,n.buckets={}):n.state="errored"}))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}class on extends bn{constructor(n,l,p,g){super(n,l,p,g),this.roundZoom=!0,this.type="video",this.options=l}load(){return a._(this,void 0,void 0,(function*(){this._loaded=!1;const n=this.options;this.urls=[];for(const l of n.urls)this.urls.push(this.map._requestManager.transformRequest(l,"Source").url);try{const l=yield a.a1(this.urls);if(this._loaded=!0,!l)return;this.video=l,this.video.loop=!0,this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading()}catch(l){this.fire(new a.k(l))}}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(n){if(this.video){const l=this.video.seekable;n<l.start(0)||n>l.end(0)?this.fire(new a.k(new a.a2(`sources.${this.id}`,null,`Playback for this video can be set only between the ${l.start(0)} and ${l.end(0)}-second mark.`))):this.video.currentTime=n}}getVideo(){return this.video}onAdd(n){this.map||(this.map=n,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const n=this.map.painter.context,l=n.gl;this.texture?this.video.paused||(this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE),l.texSubImage2D(l.TEXTURE_2D,0,0,0,l.RGBA,l.UNSIGNED_BYTE,this.video)):(this.texture=new G(n,this.video,l.RGBA),this.texture.bind(l.LINEAR,l.CLAMP_TO_EDGE));let p=!1;for(const g in this.tiles){const x=this.tiles[g];x.state!=="loaded"&&(x.state="loaded",x.texture=this.texture,p=!0)}p&&this.fire(new a.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class so extends bn{constructor(n,l,p,g){super(n,l,p,g),l.coordinates?Array.isArray(l.coordinates)&&l.coordinates.length===4&&!l.coordinates.some((x=>!Array.isArray(x)||x.length!==2||x.some((T=>typeof T!="number"))))||this.fire(new a.k(new a.a2(`sources.${n}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new a.k(new a.a2(`sources.${n}`,null,'missing required property "coordinates"'))),l.animate&&typeof l.animate!="boolean"&&this.fire(new a.k(new a.a2(`sources.${n}`,null,'optional "animate" property must be a boolean value'))),l.canvas?typeof l.canvas=="string"||l.canvas instanceof HTMLCanvasElement||this.fire(new a.k(new a.a2(`sources.${n}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new a.k(new a.a2(`sources.${n}`,null,'missing required property "canvas"'))),this.options=l,this.animate=l.animate===void 0||l.animate}load(){return a._(this,void 0,void 0,(function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new a.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}))}getCanvas(){return this.canvas}onAdd(n){this.map=n,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let n=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,n=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,n=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const l=this.map.painter.context,p=l.gl;this.texture?(n||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new G(l,this.canvas,p.RGBA,{premultiply:!0});let g=!1;for(const x in this.tiles){const T=this.tiles[x];T.state!=="loaded"&&(T.state="loaded",T.texture=this.texture,g=!0)}g&&this.fire(new a.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const n of[this.canvas.width,this.canvas.height])if(isNaN(n)||n<=0)return!0;return!1}}const Ps={},Cs=_=>{switch(_){case"geojson":return ns;case"image":return bn;case"raster":return sn;case"raster-dem":return rs;case"vector":return Jt;case"video":return on;case"canvas":return so}return Ps[_]},oo="RTLPluginLoaded";class Is extends a.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=Wt()}_syncState(n){return this.status=n,this.dispatcher.broadcast("SRPS",{pluginStatus:n,pluginURL:this.url}).catch((l=>{throw this.status="error",l}))}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(n){return a._(this,arguments,void 0,(function*(l,p=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=D.resolveURL(l),!this.url)throw new Error(`requested url ${l} is invalid`);if(this.status==="unavailable"){if(!p)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if(this.status==="requested")return this._requestImport()}))}_requestImport(){return a._(this,void 0,void 0,(function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new a.l(oo))}))}lazyLoad(){this.status==="unavailable"?this.status="requested":this.status==="deferred"&&this._requestImport()}}let Nn=null;function zn(){return Nn||(Nn=new Is),Nn}class ss{constructor(n,l){this.timeAdded=0,this.fadeEndTime=0,this.tileID=n,this.uid=a.a3(),this.uses=0,this.tileSize=l,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(n){const l=n+this.timeAdded;l<this.fadeEndTime||(this.fadeEndTime=l)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}clearTextures(n){this.demTexture&&n.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(n,l,p){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",n){n.featureIndex&&(this.latestFeatureIndex=n.featureIndex,n.rawTileData?(this.latestRawTileData=n.rawTileData,this.latestFeatureIndex.rawTileData=n.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=n.collisionBoxArray,this.buckets=(function(g,x){const T={};if(!x)return T;for(const A of g){const C=A.layerIds.map((R=>x.getLayer(R))).filter(Boolean);if(C.length!==0){A.layers=C,A.stateDependentLayerIds&&(A.stateDependentLayers=A.stateDependentLayerIds.map((R=>C.filter((L=>L.id===R))[0])));for(const R of C)T[R.id]=A}}return T})(n.buckets,l?.style),this.hasSymbolBuckets=!1;for(const g in this.buckets){const x=this.buckets[g];if(x instanceof a.a5){if(this.hasSymbolBuckets=!0,!p)break;x.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const g in this.buckets){const x=this.buckets[g];if(x instanceof a.a5&&x.hasRTLText){this.hasRTLText=!0,zn().lazyLoad();break}}this.queryPadding=0;for(const g in this.buckets){const x=this.buckets[g];this.queryPadding=Math.max(this.queryPadding,l.style.getLayer(g).queryRadius(x))}n.imageAtlas&&(this.imageAtlas=n.imageAtlas),n.glyphAtlasImage&&(this.glyphAtlasImage=n.glyphAtlasImage)}else this.collisionBoxArray=new a.a4}unloadVectorData(){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(n){return this.buckets[n.id]}upload(n){for(const p in this.buckets){const g=this.buckets[p];g.uploadPending()&&g.upload(n)}const l=n.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new G(n,this.imageAtlas.image,l.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new G(n,this.glyphAtlasImage,l.ALPHA),this.glyphAtlasImage=null)}prepare(n){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(n,this.imageAtlasTexture)}queryRenderedFeatures(n,l,p,g,x,T,A,C,R,L){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:g,cameraQueryGeometry:x,scale:T,tileSize:this.tileSize,pixelPosMatrix:L,transform:C,params:A,queryPadding:this.queryPadding*R},n,l,p):{}}querySourceFeatures(n,l){const p=this.latestFeatureIndex;if(!p||!p.rawTileData)return;const g=p.loadVTLayers(),x=l&&l.sourceLayer?l.sourceLayer:"",T=g._geojsonTileLayer||g[x];if(!T)return;const A=a.a6(l&&l.filter),{z:C,x:R,y:L}=this.tileID.canonical,N={z:C,x:R,y:L};for(let z=0;z<T.length;z++){const H=T.feature(z);if(A.needGeometry){const ne=a.a7(H,!0);if(!A.filter(new a.C(this.tileID.overscaledZ),ne,this.tileID.canonical))continue}else if(!A.filter(new a.C(this.tileID.overscaledZ),H))continue;const q=p.getId(H,x),se=new a.a8(H,C,R,L,q);se.tile=N,n.push(se)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(n){const l=this.expirationTime;if(n.cacheControl){const p=a.a9(n.cacheControl);p["max-age"]&&(this.expirationTime=Date.now()+1e3*p["max-age"])}else n.expires&&(this.expirationTime=new Date(n.expires).getTime());if(this.expirationTime){const p=Date.now();let g=!1;if(this.expirationTime>p)g=!1;else if(l)if(this.expirationTime<l)g=!0;else{const x=this.expirationTime-l;x?this.expirationTime=p+Math.max(x,3e4):g=!0}else g=!0;g?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(n,l){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||Object.keys(n).length===0)return;const p=this.latestFeatureIndex.loadVTLayers();for(const g in this.buckets){if(!l.style.hasLayer(g))continue;const x=this.buckets[g],T=x.layers[0].sourceLayer||"_geojsonTileLayer",A=p[T],C=n[T];if(!A||!C||Object.keys(C).length===0)continue;x.update(C,A,this.imageAtlas&&this.imageAtlas.patternPositions||{});const R=l&&l.style&&l.style.getLayer(g);R&&(this.queryPadding=Math.max(this.queryPadding,R.queryRadius(x)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<D.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(n){this.symbolFadeHoldUntil=D.now()+n}setDependencies(n,l){const p={};for(const g of l)p[g]=!0;this.dependencies[n]=p}hasDependency(n,l){for(const p of n){const g=this.dependencies[p];if(g){for(const x of l)if(g[x])return!0}}return!1}}class os{constructor(n,l){this.max=n,this.onRemove=l,this.reset()}reset(){for(const n in this.data)for(const l of this.data[n])l.timeout&&clearTimeout(l.timeout),this.onRemove(l.value);return this.data={},this.order=[],this}add(n,l,p){const g=n.wrapped().key;this.data[g]===void 0&&(this.data[g]=[]);const x={value:l,timeout:void 0};if(p!==void 0&&(x.timeout=setTimeout((()=>{this.remove(n,x)}),p)),this.data[g].push(x),this.order.push(g),this.order.length>this.max){const T=this._getAndRemoveByKey(this.order[0]);T&&this.onRemove(T)}return this}has(n){return n.wrapped().key in this.data}getAndRemove(n){return this.has(n)?this._getAndRemoveByKey(n.wrapped().key):null}_getAndRemoveByKey(n){const l=this.data[n].shift();return l.timeout&&clearTimeout(l.timeout),this.data[n].length===0&&delete this.data[n],this.order.splice(this.order.indexOf(n),1),l.value}getByKey(n){const l=this.data[n];return l?l[0].value:null}get(n){return this.has(n)?this.data[n.wrapped().key][0].value:null}remove(n,l){if(!this.has(n))return this;const p=n.wrapped().key,g=l===void 0?0:this.data[p].indexOf(l),x=this.data[p][g];return this.data[p].splice(g,1),x.timeout&&clearTimeout(x.timeout),this.data[p].length===0&&delete this.data[p],this.onRemove(x.value),this.order.splice(this.order.indexOf(p),1),this}setMaxSize(n){for(this.max=n;this.order.length>this.max;){const l=this._getAndRemoveByKey(this.order[0]);l&&this.onRemove(l)}return this}filter(n){const l=[];for(const p in this.data)for(const g of this.data[p])n(g.value)||l.push(g);for(const p of l)this.remove(p.value.tileID,p)}}class Xo{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(n,l,p){const g=String(l);if(this.stateChanges[n]=this.stateChanges[n]||{},this.stateChanges[n][g]=this.stateChanges[n][g]||{},a.e(this.stateChanges[n][g],p),this.deletedStates[n]===null){this.deletedStates[n]={};for(const x in this.state[n])x!==g&&(this.deletedStates[n][x]=null)}else if(this.deletedStates[n]&&this.deletedStates[n][g]===null){this.deletedStates[n][g]={};for(const x in this.state[n][g])p[x]||(this.deletedStates[n][g][x]=null)}else for(const x in p)this.deletedStates[n]&&this.deletedStates[n][g]&&this.deletedStates[n][g][x]===null&&delete this.deletedStates[n][g][x]}removeFeatureState(n,l,p){if(this.deletedStates[n]===null)return;const g=String(l);if(this.deletedStates[n]=this.deletedStates[n]||{},p&&l!==void 0)this.deletedStates[n][g]!==null&&(this.deletedStates[n][g]=this.deletedStates[n][g]||{},this.deletedStates[n][g][p]=null);else if(l!==void 0)if(this.stateChanges[n]&&this.stateChanges[n][g])for(p in this.deletedStates[n][g]={},this.stateChanges[n][g])this.deletedStates[n][g][p]=null;else this.deletedStates[n][g]=null;else this.deletedStates[n]=null}getState(n,l){const p=String(l),g=a.e({},(this.state[n]||{})[p],(this.stateChanges[n]||{})[p]);if(this.deletedStates[n]===null)return{};if(this.deletedStates[n]){const x=this.deletedStates[n][l];if(x===null)return{};for(const T in x)delete g[T]}return g}initializeTileState(n,l){n.setFeatureState(this.state,l)}coalesceChanges(n,l){const p={};for(const g in this.stateChanges){this.state[g]=this.state[g]||{};const x={};for(const T in this.stateChanges[g])this.state[g][T]||(this.state[g][T]={}),a.e(this.state[g][T],this.stateChanges[g][T]),x[T]=this.state[g][T];p[g]=x}for(const g in this.deletedStates){this.state[g]=this.state[g]||{};const x={};if(this.deletedStates[g]===null)for(const T in this.state[g])x[T]={},this.state[g][T]={};else for(const T in this.deletedStates[g]){if(this.deletedStates[g][T]===null)this.state[g][T]={};else for(const A of Object.keys(this.deletedStates[g][T]))delete this.state[g][T][A];x[T]=this.state[g][T]}p[g]=p[g]||{},a.e(p[g],x)}if(this.stateChanges={},this.deletedStates={},Object.keys(p).length!==0)for(const g in n)n[g].setFeatureState(p,l)}}function ao(_,n,l){const p=n.intersectsFrustum(_);if(!l)return p;const g=n.intersectsPlane(l);return p===0||g===0?0:p===2&&g===2?2:1}function Go(_,n,l,p,g){let x=_;const T=Math.atan(n/l),A=Math.hypot(n,l);return x=_+a.aa(p/A/Math.max(.5,Math.cos(a.ac(g/2)))),x+=1*a.aa(Math.cos(T))/2,x+=a.ad(_-x,-0,0),x}function Un(_,n){const l=(n.roundZoom?Math.round:Math.floor)(_.zoom+a.aa(_.tileSize/n.tileSize));return Math.max(0,l)}function Ne(_,n){const l=_.getCameraFrustum(),p=_.getClippingPlane(),g=_.screenPointToMercatorCoordinate(_.getCameraPoint()),x=a.$.fromLngLat(_.center,_.elevation);g.z=x.z+Math.cos(_.pitchInRadians)*_.cameraToCenterDistance/_.worldSize;const T=_.getCoveringTilesDetailsProvider(),A=T.allowVariableZoom(_,n),C=Un(_,n),R=n.minzoom||0,L=n.maxzoom!==void 0?n.maxzoom:_.maxZoom,N=Math.min(Math.max(0,C),L),z=Math.pow(2,N),H=[z*g.x,z*g.y,0],q=[z*x.x,z*x.y,0],se=Math.hypot(x.x-g.x,x.y-g.y),ne=Math.abs(x.z-g.z),le=Math.hypot(se,ne),he=Pe=>({zoom:0,x:0,y:0,wrap:Pe,fullyVisible:!1}),xe=[],ve=[];if(_.renderWorldCopies&&T.allowWorldCopies())for(let Pe=1;Pe<=3;Pe++)xe.push(he(-Pe)),xe.push(he(Pe));for(xe.push(he(0));xe.length>0;){const Pe=xe.pop(),Re=Pe.x,Ie=Pe.y;let $e=Pe.fullyVisible;const He={x:Re,y:Ie,z:Pe.zoom},it=T.getTileAABB(He,Pe.wrap,_.elevation,n);if(!$e){const yt=ao(l,it,p);if(yt===0)continue;$e=yt===2}const nt=T.distanceToTile2d(g.x,g.y,He,it);let et=C;A&&(et=(n.calculateTileZoom||Go)(_.zoom+a.aa(_.tileSize/n.tileSize),nt,ne,le,_.fov)),et=(n.roundZoom?Math.round:Math.floor)(et),et=Math.max(0,et);const xt=Math.min(et,L);if(Pe.wrap=T.getWrap(x,He,Pe.wrap),Pe.zoom>=xt){if(Pe.zoom<R)continue;const yt=N-Pe.zoom,ct=H[0]-.5-(Re<<yt),Pt=H[1]-.5-(Ie<<yt),Rt=n.reparseOverscaled?Math.max(Pe.zoom,et):Pe.zoom;ve.push({tileID:new a.Y(Pe.zoom===L?Rt:Pe.zoom,Pe.wrap,Pe.zoom,Re,Ie),distanceSq:a.ab([q[0]-.5-Re,q[1]-.5-Ie]),tileDistanceToCamera:Math.sqrt(ct*ct+Pt*Pt)})}else for(let yt=0;yt<4;yt++)xe.push({zoom:Pe.zoom+1,x:(Re<<1)+yt%2,y:(Ie<<1)+(yt>>1),wrap:Pe.wrap,fullyVisible:$e})}return ve.sort(((Pe,Re)=>Pe.distanceSq-Re.distanceSq)).map((Pe=>Pe.tileID))}class B extends a.E{constructor(n,l,p){super(),this.id=n,this.dispatcher=p,this.on("data",(g=>this._dataHandler(g))),this.on("dataloading",(()=>{this._sourceErrored=!1})),this.on("error",(()=>{this._sourceErrored=this._source.loaded()})),this._source=((g,x,T,A)=>{const C=new(Cs(x.type))(g,x,T,A);if(C.id!==g)throw new Error(`Expected Source id to be ${g} instead of ${C.id}`);return C})(n,l,p,this),this._tiles={},this._cache=new os(0,(g=>this._unloadTile(g))),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new Xo,this._didEmitContent=!1,this._updated=!1}onAdd(n){this.map=n,this._maxTileCacheSize=n?n._maxTileCacheSize:null,this._maxTileCacheZoomLevels=n?n._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(n)}onRemove(n){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(n)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;if(!(this.used===void 0&&this.usedForTerrain===void 0||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const n in this._tiles){const l=this._tiles[n];if(l.state!=="loaded"&&l.state!=="errored")return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const n=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,n&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(n,l,p){return a._(this,void 0,void 0,(function*(){try{yield this._source.loadTile(n),this._tileLoaded(n,l,p)}catch(g){n.state="errored",g.status!==404?this._source.fire(new a.k(g,{tile:n})):this.update(this.transform,this.terrain)}}))}_unloadTile(n){this._source.unloadTile&&this._source.unloadTile(n)}_abortTile(n){this._source.abortTile&&this._source.abortTile(n),this._source.fire(new a.l("dataabort",{tile:n,coord:n.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(n){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const l in this._tiles){const p=this._tiles[l];p.upload(n),p.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map((n=>n.tileID)).sort(Y).map((n=>n.key))}getRenderableIds(n){const l=[];for(const p in this._tiles)this._isIdRenderable(p,n)&&l.push(this._tiles[p]);return n?l.sort(((p,g)=>{const x=p.tileID,T=g.tileID,A=new a.P(x.canonical.x,x.canonical.y)._rotate(-this.transform.bearingInRadians),C=new a.P(T.canonical.x,T.canonical.y)._rotate(-this.transform.bearingInRadians);return x.overscaledZ-T.overscaledZ||C.y-A.y||C.x-A.x})).map((p=>p.tileID.key)):l.map((p=>p.tileID)).sort(Y).map((p=>p.key))}hasRenderableParent(n){const l=this.findLoadedParent(n,0);return!!l&&this._isIdRenderable(l.tileID.key)}_isIdRenderable(n,l){return this._tiles[n]&&this._tiles[n].hasData()&&!this._coveredTiles[n]&&(l||!this._tiles[n].holdingForFade())}reload(n){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const l in this._tiles)(n||this._tiles[l].state!=="errored")&&this._reloadTile(l,"reloading")}}_reloadTile(n,l){return a._(this,void 0,void 0,(function*(){const p=this._tiles[n];p&&(p.state!=="loading"&&(p.state=l),yield this._loadTile(p,n,l))}))}_tileLoaded(n,l,p){n.timeAdded=D.now(),p==="expired"&&(n.refreshedUponExpiration=!0),this._setTileReloadTimer(l,n),this.getSource().type==="raster-dem"&&n.dem&&this._backfillDEM(n),this._state.initializeTileState(n,this.map?this.map.painter:null),n.aborted||this._source.fire(new a.l("data",{dataType:"source",tile:n,coord:n.tileID}))}_backfillDEM(n){const l=this.getRenderableIds();for(let g=0;g<l.length;g++){const x=l[g];if(n.neighboringTiles&&n.neighboringTiles[x]){const T=this.getTileByID(x);p(n,T),p(T,n)}}function p(g,x){g.needsHillshadePrepare=!0,g.needsTerrainPrepare=!0;let T=x.tileID.canonical.x-g.tileID.canonical.x;const A=x.tileID.canonical.y-g.tileID.canonical.y,C=Math.pow(2,g.tileID.canonical.z),R=x.tileID.key;T===0&&A===0||Math.abs(A)>1||(Math.abs(T)>1&&(Math.abs(T+C)===1?T+=C:Math.abs(T-C)===1&&(T-=C)),x.dem&&g.dem&&(g.dem.backfillBorder(x.dem,T,A),g.neighboringTiles&&g.neighboringTiles[R]&&(g.neighboringTiles[R].backfilled=!0)))}}getTile(n){return this.getTileByID(n.key)}getTileByID(n){return this._tiles[n]}_retainLoadedChildren(n,l,p,g){for(const x in this._tiles){let T=this._tiles[x];if(g[x]||!T.hasData()||T.tileID.overscaledZ<=l||T.tileID.overscaledZ>p)continue;let A=T.tileID;for(;T&&T.tileID.overscaledZ>l+1;){const R=T.tileID.scaledTo(T.tileID.overscaledZ-1);T=this._tiles[R.key],T&&T.hasData()&&(A=R)}let C=A;for(;C.overscaledZ>l;)if(C=C.scaledTo(C.overscaledZ-1),n[C.key]||n[C.canonical.key]){g[A.key]=A;break}}}findLoadedParent(n,l){if(n.key in this._loadedParentTiles){const p=this._loadedParentTiles[n.key];return p&&p.tileID.overscaledZ>=l?p:null}for(let p=n.overscaledZ-1;p>=l;p--){const g=n.scaledTo(p),x=this._getLoadedTile(g);if(x)return x}}findLoadedSibling(n){return this._getLoadedTile(n)}_getLoadedTile(n){const l=this._tiles[n.key];return l&&l.hasData()?l:this._cache.getByKey(n.wrapped().key)}updateCacheSize(n){const l=Math.ceil(n.width/this._source.tileSize)+1,p=Math.ceil(n.height/this._source.tileSize)+1,g=Math.floor(l*p*(this._maxTileCacheZoomLevels===null?a.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),x=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,g):g;this._cache.setMaxSize(x)}handleWrapJump(n){const l=Math.round((n-(this._prevLng===void 0?n:this._prevLng))/360);if(this._prevLng=n,l){const p={};for(const g in this._tiles){const x=this._tiles[g];x.tileID=x.tileID.unwrapTo(x.tileID.wrap+l),p[x.tileID.key]=x}this._tiles=p;for(const g in this._timers)clearTimeout(this._timers[g]),delete this._timers[g];for(const g in this._tiles)this._setTileReloadTimer(g,this._tiles[g])}}_updateCoveredAndRetainedTiles(n,l,p,g,x,T){const A={},C={},R=Object.keys(n),L=D.now();for(const N of R){const z=n[N],H=this._tiles[N];if(!H||H.fadeEndTime!==0&&H.fadeEndTime<=L)continue;const q=this.findLoadedParent(z,l),se=this.findLoadedSibling(z),ne=q||se||null;ne&&(this._addTile(ne.tileID),A[ne.tileID.key]=ne.tileID),C[N]=z}this._retainLoadedChildren(C,g,p,n);for(const N in A)n[N]||(this._coveredTiles[N]=!0,n[N]=A[N]);if(T){const N={},z={};for(const H of x)this._tiles[H.key].hasData()?N[H.key]=H:z[H.key]=H;for(const H in z){const q=z[H].children(this._source.maxzoom);this._tiles[q[0].key]&&this._tiles[q[1].key]&&this._tiles[q[2].key]&&this._tiles[q[3].key]&&(N[q[0].key]=n[q[0].key]=q[0],N[q[1].key]=n[q[1].key]=q[1],N[q[2].key]=n[q[2].key]=q[2],N[q[3].key]=n[q[3].key]=q[3],delete z[H])}for(const H in z){const q=z[H],se=this.findLoadedParent(q,this._source.minzoom),ne=this.findLoadedSibling(q),le=se||ne||null;if(le){N[le.tileID.key]=n[le.tileID.key]=le.tileID;for(const he in N)N[he].isChildOf(le.tileID)&&delete N[he]}}for(const H in this._tiles)N[H]||(this._coveredTiles[H]=!0)}}update(n,l){if(!this._sourceLoaded||this._paused)return;let p;this.transform=n,this.terrain=l,this.updateCacheSize(n),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?p=n.getVisibleUnwrappedCoordinates(this._source.tileID).map((L=>new a.Y(L.canonical.z,L.wrap,L.canonical.z,L.canonical.x,L.canonical.y))):(p=Ne(n,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:l,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&(p=p.filter((L=>this._source.hasTile(L))))):p=[];const g=Un(n,this._source),x=Math.max(g-B.maxOverzooming,this._source.minzoom),T=Math.max(g+B.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const L={};for(const N of p)if(N.canonical.z>this._source.minzoom){const z=N.scaledTo(N.canonical.z-1);L[z.key]=z;const H=N.scaledTo(Math.max(this._source.minzoom,Math.min(N.canonical.z,5)));L[H.key]=H}p=p.concat(Object.values(L))}const A=p.length===0&&!this._updated&&this._didEmitContent;this._updated=!0,A&&this.fire(new a.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const C=this._updateRetainedTiles(p,g);ie(this._source.type)&&this._updateCoveredAndRetainedTiles(C,x,T,g,p,l);for(const L in C)this._tiles[L].clearFadeHold();const R=a.ae(this._tiles,C);for(const L of R){const N=this._tiles[L];N.hasSymbolBuckets&&!N.holdingForFade()?N.setHoldDuration(this.map._fadeDuration):N.hasSymbolBuckets&&!N.symbolFadeFinished()||this._removeTile(L)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const n in this._tiles)this._tiles[n].holdingForFade()&&this._removeTile(n)}_updateRetainedTiles(n,l){var p;const g={},x={},T=Math.max(l-B.maxOverzooming,this._source.minzoom),A=Math.max(l+B.maxUnderzooming,this._source.minzoom),C={};for(const R of n){const L=this._addTile(R);g[R.key]=R,L.hasData()||l<this._source.maxzoom&&(C[R.key]=R)}this._retainLoadedChildren(C,l,A,g);for(const R of n){let L=this._tiles[R.key];if(L.hasData())continue;if(l+1>this._source.maxzoom){const z=R.children(this._source.maxzoom)[0],H=this.getTile(z);if(H&&H.hasData()){g[z.key]=z;continue}}else{const z=R.children(this._source.maxzoom);if(g[z[0].key]&&g[z[1].key]&&g[z[2].key]&&g[z[3].key])continue}let N=L.wasRequested();for(let z=R.overscaledZ-1;z>=T;--z){const H=R.scaledTo(z);if(x[H.key])break;if(x[H.key]=!0,L=this.getTile(H),!L&&N&&(L=this._addTile(H)),L){const q=L.hasData();if((q||!(!((p=this.map)===null||p===void 0)&&p.cancelPendingTileRequestsWhileZooming)||N)&&(g[H.key]=H),N=L.wasRequested(),q)break}}}return g}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const n in this._tiles){const l=[];let p,g=this._tiles[n].tileID;for(;g.overscaledZ>0;){if(g.key in this._loadedParentTiles){p=this._loadedParentTiles[g.key];break}l.push(g.key);const x=g.scaledTo(g.overscaledZ-1);if(p=this._getLoadedTile(x),p)break;g=x}for(const x of l)this._loadedParentTiles[x]=p}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const n in this._tiles){const l=this._tiles[n].tileID,p=this._getLoadedTile(l);this._loadedSiblingTiles[l.key]=p}}_addTile(n){let l=this._tiles[n.key];if(l)return l;l=this._cache.getAndRemove(n),l&&(this._setTileReloadTimer(n.key,l),l.tileID=n,this._state.initializeTileState(l,this.map?this.map.painter:null),this._cacheTimers[n.key]&&(clearTimeout(this._cacheTimers[n.key]),delete this._cacheTimers[n.key],this._setTileReloadTimer(n.key,l)));const p=l;return l||(l=new ss(n,this._source.tileSize*n.overscaleFactor()),this._loadTile(l,n.key,l.state)),l.uses++,this._tiles[n.key]=l,p||this._source.fire(new a.l("dataloading",{tile:l,coord:l.tileID,dataType:"source"})),l}_setTileReloadTimer(n,l){n in this._timers&&(clearTimeout(this._timers[n]),delete this._timers[n]);const p=l.getExpiryTimeout();p&&(this._timers[n]=setTimeout((()=>{this._reloadTile(n,"expired"),delete this._timers[n]}),p))}_removeTile(n){const l=this._tiles[n];l&&(l.uses--,delete this._tiles[n],this._timers[n]&&(clearTimeout(this._timers[n]),delete this._timers[n]),l.uses>0||(l.hasData()&&l.state!=="reloading"?this._cache.add(l.tileID,l,l.getExpiryTimeout()):(l.aborted=!0,this._abortTile(l),this._unloadTile(l))))}_dataHandler(n){const l=n.sourceDataType;n.dataType==="source"&&l==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&n.dataType==="source"&&l==="content"&&(this.reload(n.sourceDataChanged),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const n in this._tiles)this._removeTile(n);this._cache.reset()}tilesIn(n,l,p){const g=[],x=this.transform;if(!x)return g;const T=p?x.getCameraQueryGeometry(n):n,A=n.map((q=>x.screenPointToMercatorCoordinate(q,this.terrain))),C=T.map((q=>x.screenPointToMercatorCoordinate(q,this.terrain))),R=this.getIds();let L=1/0,N=1/0,z=-1/0,H=-1/0;for(const q of C)L=Math.min(L,q.x),N=Math.min(N,q.y),z=Math.max(z,q.x),H=Math.max(H,q.y);for(let q=0;q<R.length;q++){const se=this._tiles[R[q]];if(se.holdingForFade())continue;const ne=se.tileID,le=Math.pow(2,x.zoom-se.tileID.overscaledZ),he=l*se.queryPadding*a.Z/se.tileSize/le,xe=[ne.getTilePoint(new a.$(L,N)),ne.getTilePoint(new a.$(z,H))];if(xe[0].x-he<a.Z&&xe[0].y-he<a.Z&&xe[1].x+he>=0&&xe[1].y+he>=0){const ve=A.map((Re=>ne.getTilePoint(Re))),Pe=C.map((Re=>ne.getTilePoint(Re)));g.push({tile:se,tileID:ne,queryGeometry:ve,cameraQueryGeometry:Pe,scale:le})}}return g}getVisibleCoordinates(n){const l=this.getRenderableIds(n).map((p=>this._tiles[p].tileID));return this.transform&&this.transform.populateCache(l),l}hasTransition(){if(this._source.hasTransition())return!0;if(ie(this._source.type)){const n=D.now();for(const l in this._tiles)if(this._tiles[l].fadeEndTime>=n)return!0}return!1}setFeatureState(n,l,p){this._state.updateState(n=n||"_geojsonTileLayer",l,p)}removeFeatureState(n,l,p){this._state.removeFeatureState(n=n||"_geojsonTileLayer",l,p)}getFeatureState(n,l){return this._state.getState(n=n||"_geojsonTileLayer",l)}setDependencies(n,l,p){const g=this._tiles[n];g&&g.setDependencies(l,p)}reloadTilesForDependencies(n,l){for(const p in this._tiles)this._tiles[p].hasDependency(n,l)&&this._reloadTile(p,"reloading");this._cache.filter((p=>!p.hasDependency(n,l)))}}function Y(_,n){const l=Math.abs(2*_.wrap)-+(_.wrap<0),p=Math.abs(2*n.wrap)-+(n.wrap<0);return _.overscaledZ-n.overscaledZ||p-l||n.canonical.y-_.canonical.y||n.canonical.x-_.canonical.x}function ie(_){return _==="raster"||_==="image"||_==="video"}B.maxOverzooming=10,B.maxUnderzooming=3;class ue{constructor(n,l){this.reset(n,l)}reset(n,l){this.points=n||[],this._distances=[0];for(let p=1;p<this.points.length;p++)this._distances[p]=this._distances[p-1]+this.points[p].dist(this.points[p-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(l||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(n){if(this.points.length===1)return this.points[0];n=a.ad(n,0,1);let l=1,p=this._distances[l];const g=n*this.paddedLength+this.padding;for(;p<g&&l<this._distances.length;)p=this._distances[++l];const x=l-1,T=this._distances[x],A=p-T,C=A>0?(g-T)/A:0;return this.points[x].mult(1-C).add(this.points[l].mult(C))}}function Ae(_,n){let l=!0;return _==="always"||_!=="never"&&n!=="never"||(l=!1),l}class Oe{constructor(n,l,p){const g=this.boxCells=[],x=this.circleCells=[];this.xCellCount=Math.ceil(n/p),this.yCellCount=Math.ceil(l/p);for(let T=0;T<this.xCellCount*this.yCellCount;T++)g.push([]),x.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=n,this.height=l,this.xScale=this.xCellCount/n,this.yScale=this.yCellCount/l,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(n,l,p,g,x){this._forEachCell(l,p,g,x,this._insertBoxCell,this.boxUid++),this.boxKeys.push(n),this.bboxes.push(l),this.bboxes.push(p),this.bboxes.push(g),this.bboxes.push(x)}insertCircle(n,l,p,g){this._forEachCell(l-g,p-g,l+g,p+g,this._insertCircleCell,this.circleUid++),this.circleKeys.push(n),this.circles.push(l),this.circles.push(p),this.circles.push(g)}_insertBoxCell(n,l,p,g,x,T){this.boxCells[x].push(T)}_insertCircleCell(n,l,p,g,x,T){this.circleCells[x].push(T)}_query(n,l,p,g,x,T,A){if(p<0||n>this.width||g<0||l>this.height)return[];const C=[];if(n<=0&&l<=0&&this.width<=p&&this.height<=g){if(x)return[{key:null,x1:n,y1:l,x2:p,y2:g}];for(let R=0;R<this.boxKeys.length;R++)C.push({key:this.boxKeys[R],x1:this.bboxes[4*R],y1:this.bboxes[4*R+1],x2:this.bboxes[4*R+2],y2:this.bboxes[4*R+3]});for(let R=0;R<this.circleKeys.length;R++){const L=this.circles[3*R],N=this.circles[3*R+1],z=this.circles[3*R+2];C.push({key:this.circleKeys[R],x1:L-z,y1:N-z,x2:L+z,y2:N+z})}}else this._forEachCell(n,l,p,g,this._queryCell,C,{hitTest:x,overlapMode:T,seenUids:{box:{},circle:{}}},A);return C}query(n,l,p,g){return this._query(n,l,p,g,!1,null)}hitTest(n,l,p,g,x,T){return this._query(n,l,p,g,!0,x,T).length>0}hitTestCircle(n,l,p,g,x){const T=n-p,A=n+p,C=l-p,R=l+p;if(A<0||T>this.width||R<0||C>this.height)return!1;const L=[];return this._forEachCell(T,C,A,R,this._queryCellCircle,L,{hitTest:!0,overlapMode:g,circle:{x:n,y:l,radius:p},seenUids:{box:{},circle:{}}},x),L.length>0}_queryCell(n,l,p,g,x,T,A,C){const{seenUids:R,hitTest:L,overlapMode:N}=A,z=this.boxCells[x];if(z!==null){const q=this.bboxes;for(const se of z)if(!R.box[se]){R.box[se]=!0;const ne=4*se,le=this.boxKeys[se];if(n<=q[ne+2]&&l<=q[ne+3]&&p>=q[ne+0]&&g>=q[ne+1]&&(!C||C(le))&&(!L||!Ae(N,le.overlapMode))&&(T.push({key:le,x1:q[ne],y1:q[ne+1],x2:q[ne+2],y2:q[ne+3]}),L))return!0}}const H=this.circleCells[x];if(H!==null){const q=this.circles;for(const se of H)if(!R.circle[se]){R.circle[se]=!0;const ne=3*se,le=this.circleKeys[se];if(this._circleAndRectCollide(q[ne],q[ne+1],q[ne+2],n,l,p,g)&&(!C||C(le))&&(!L||!Ae(N,le.overlapMode))){const he=q[ne],xe=q[ne+1],ve=q[ne+2];if(T.push({key:le,x1:he-ve,y1:xe-ve,x2:he+ve,y2:xe+ve}),L)return!0}}}return!1}_queryCellCircle(n,l,p,g,x,T,A,C){const{circle:R,seenUids:L,overlapMode:N}=A,z=this.boxCells[x];if(z!==null){const q=this.bboxes;for(const se of z)if(!L.box[se]){L.box[se]=!0;const ne=4*se,le=this.boxKeys[se];if(this._circleAndRectCollide(R.x,R.y,R.radius,q[ne+0],q[ne+1],q[ne+2],q[ne+3])&&(!C||C(le))&&!Ae(N,le.overlapMode))return T.push(!0),!0}}const H=this.circleCells[x];if(H!==null){const q=this.circles;for(const se of H)if(!L.circle[se]){L.circle[se]=!0;const ne=3*se,le=this.circleKeys[se];if(this._circlesCollide(q[ne],q[ne+1],q[ne+2],R.x,R.y,R.radius)&&(!C||C(le))&&!Ae(N,le.overlapMode))return T.push(!0),!0}}}_forEachCell(n,l,p,g,x,T,A,C){const R=this._convertToXCellCoord(n),L=this._convertToYCellCoord(l),N=this._convertToXCellCoord(p),z=this._convertToYCellCoord(g);for(let H=R;H<=N;H++)for(let q=L;q<=z;q++)if(x.call(this,n,l,p,g,this.xCellCount*q+H,T,A,C))return}_convertToXCellCoord(n){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(n*this.xScale)))}_convertToYCellCoord(n){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(n*this.yScale)))}_circlesCollide(n,l,p,g,x,T){const A=g-n,C=x-l,R=p+T;return R*R>A*A+C*C}_circleAndRectCollide(n,l,p,g,x,T,A){const C=(T-g)/2,R=Math.abs(n-(g+C));if(R>C+p)return!1;const L=(A-x)/2,N=Math.abs(l-(x+L));if(N>L+p)return!1;if(R<=C||N<=L)return!0;const z=R-C,H=N-L;return z*z+H*H<=p*p}}function qe(_,n,l){const p=a.K();if(!_){const{vecSouth:N,vecEast:z}=rt(n),H=w();H[0]=z[0],H[1]=z[1],H[2]=N[0],H[3]=N[1],g=H,(L=(T=(x=H)[0])*(R=x[3])-(C=x[2])*(A=x[1]))&&(g[0]=R*(L=1/L),g[1]=-A*L,g[2]=-C*L,g[3]=T*L),p[0]=H[0],p[1]=H[1],p[4]=H[2],p[5]=H[3]}var g,x,T,A,C,R,L;return a.M(p,p,[1/l,1/l,1]),p}function De(_,n,l,p){if(_){const g=a.K();if(!n){const{vecSouth:x,vecEast:T}=rt(l);g[0]=T[0],g[1]=T[1],g[4]=x[0],g[5]=x[1]}return a.M(g,g,[p,p,1]),g}return l.pixelsToClipSpaceMatrix}function rt(_){const n=Math.cos(_.rollInRadians),l=Math.sin(_.rollInRadians),p=Math.cos(_.pitchInRadians),g=Math.cos(_.bearingInRadians),x=Math.sin(_.bearingInRadians),T=a.aj();T[0]=-g*p*l-x*n,T[1]=-x*p*l+g*n;const A=a.ak(T);A<1e-9?a.al(T):a.am(T,T,1/A);const C=a.aj();C[0]=g*p*n-x*l,C[1]=x*p*n+g*l;const R=a.ak(C);return R<1e-9?a.al(C):a.am(C,C,1/R),{vecEast:C,vecSouth:T}}function Ke(_,n,l,p){let g;p?(g=[_,n,p(_,n),1],a.ao(g,g,l)):(g=[_,n,0,1],qi(g,g,l));const x=g[3];return{point:new a.P(g[0]/x,g[1]/x),signedDistanceFromCamera:x,isOccluded:!1}}function ze(_,n){return .5+_/n*.5}function at(_,n){return _.x>=-n[0]&&_.x<=n[0]&&_.y>=-n[1]&&_.y<=n[1]}function Ue(_,n,l,p,g,x,T,A,C,R,L,N,z){const H=l?_.textSizeData:_.iconSizeData,q=a.af(H,n.transform.zoom),se=[256/n.width*2+1,256/n.height*2+1],ne=l?_.text.dynamicLayoutVertexArray:_.icon.dynamicLayoutVertexArray;ne.clear();const le=_.lineVertexArray,he=l?_.text.placedSymbolArray:_.icon.placedSymbolArray,xe=n.transform.width/n.transform.height;let ve=!1;for(let Pe=0;Pe<he.length;Pe++){const Re=he.get(Pe);if(Re.hidden||Re.writingMode===a.ag.vertical&&!ve){ji(Re.numGlyphs,ne);continue}ve=!1;const Ie=new a.P(Re.anchorX,Re.anchorY),$e={getElevation:z,pitchedLabelPlaneMatrix:p,lineVertexArray:le,pitchWithMap:x,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:n.transform,tileAnchorPoint:Ie,unwrappedTileID:C,width:R,height:L,translation:N},He=Ht(Re.anchorX,Re.anchorY,$e);if(!at(He.point,se)){ji(Re.numGlyphs,ne);continue}const it=ze(n.transform.cameraToCenterDistance,He.signedDistanceFromCamera),nt=a.ah(H,q,Re),et=x?nt*n.transform.getPitchedTextCorrection(Re.anchorX,Re.anchorY,C)/it:nt*it,xt=Vt({projectionContext:$e,pitchedLabelPlaneMatrixInverse:g,symbol:Re,fontSize:et,flip:!1,keepUpright:T,glyphOffsetArray:_.glyphOffsetArray,dynamicLayoutVertexArray:ne,aspectRatio:xe,rotateToLine:A});ve=xt.useVertical,(xt.notEnoughRoom||ve||xt.needsFlipping&&Vt({projectionContext:$e,pitchedLabelPlaneMatrixInverse:g,symbol:Re,fontSize:et,flip:!0,keepUpright:T,glyphOffsetArray:_.glyphOffsetArray,dynamicLayoutVertexArray:ne,aspectRatio:xe,rotateToLine:A}).notEnoughRoom)&&ji(Re.numGlyphs,ne)}l?_.text.dynamicLayoutVertexBuffer.updateData(ne):_.icon.dynamicLayoutVertexBuffer.updateData(ne)}function vt(_,n,l,p,g,x,T,A){const C=x.glyphStartIndex+x.numGlyphs,R=x.lineStartIndex,L=x.lineStartIndex+x.lineLength,N=n.getoffsetX(x.glyphStartIndex),z=n.getoffsetX(C-1),H=Dt(_*N,l,p,g,x.segment,R,L,A,T);if(!H)return null;const q=Dt(_*z,l,p,g,x.segment,R,L,A,T);return q?A.projectionCache.anyProjectionOccluded?null:{first:H,last:q}:null}function It(_,n,l,p){return _===a.ag.horizontal&&Math.abs(l.y-n.y)>Math.abs(l.x-n.x)*p?{useVertical:!0}:(_===a.ag.vertical?n.y<l.y:n.x>l.x)?{needsFlipping:!0}:null}function Vt(_){const{projectionContext:n,pitchedLabelPlaneMatrixInverse:l,symbol:p,fontSize:g,flip:x,keepUpright:T,glyphOffsetArray:A,dynamicLayoutVertexArray:C,aspectRatio:R,rotateToLine:L}=_,N=g/24,z=p.lineOffsetX*N,H=p.lineOffsetY*N;let q;if(p.numGlyphs>1){const se=p.glyphStartIndex+p.numGlyphs,ne=p.lineStartIndex,le=p.lineStartIndex+p.lineLength,he=vt(N,A,z,H,x,p,L,n);if(!he)return{notEnoughRoom:!0};const xe=Et(he.first.point.x,he.first.point.y,n,l),ve=Et(he.last.point.x,he.last.point.y,n,l);if(T&&!x){const Pe=It(p.writingMode,xe,ve,R);if(Pe)return Pe}q=[he.first];for(let Pe=p.glyphStartIndex+1;Pe<se-1;Pe++)q.push(Dt(N*A.getoffsetX(Pe),z,H,x,p.segment,ne,le,n,L));q.push(he.last)}else{if(T&&!x){const ne=At(n.tileAnchorPoint.x,n.tileAnchorPoint.y,n).point,le=p.lineStartIndex+p.segment+1,he=new a.P(n.lineVertexArray.getx(le),n.lineVertexArray.gety(le)),xe=At(he.x,he.y,n),ve=xe.signedDistanceFromCamera>0?xe.point:Nt(n.tileAnchorPoint,he,ne,1,n),Pe=Et(ne.x,ne.y,n,l),Re=Et(ve.x,ve.y,n,l),Ie=It(p.writingMode,Pe,Re,R);if(Ie)return Ie}const se=Dt(N*A.getoffsetX(p.glyphStartIndex),z,H,x,p.segment,p.lineStartIndex,p.lineStartIndex+p.lineLength,n,L);if(!se||n.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};q=[se]}for(const se of q)a.an(C,se.point,se.angle);return{}}function Nt(_,n,l,p,g){const x=_.add(_.sub(n)._unit()),T=At(x.x,x.y,g).point,A=l.sub(T);return l.add(A._mult(p/A.mag()))}function ot(_,n,l){const p=n.projectionCache;if(p.projections[_])return p.projections[_];const g=new a.P(n.lineVertexArray.getx(_),n.lineVertexArray.gety(_)),x=At(g.x,g.y,n);if(x.signedDistanceFromCamera>0)return p.projections[_]=x.point,p.anyProjectionOccluded=p.anyProjectionOccluded||x.isOccluded,x.point;const T=_-l.direction;return Nt(l.distanceFromAnchor===0?n.tileAnchorPoint:new a.P(n.lineVertexArray.getx(T),n.lineVertexArray.gety(T)),g,l.previousVertex,l.absOffsetX-l.distanceFromAnchor+1,n)}function At(_,n,l){const p=_+l.translation[0],g=n+l.translation[1];let x;return l.pitchWithMap?(x=Ke(p,g,l.pitchedLabelPlaneMatrix,l.getElevation),x.isOccluded=!1):(x=l.transform.projectTileCoordinates(p,g,l.unwrappedTileID,l.getElevation),x.point.x=(.5*x.point.x+.5)*l.width,x.point.y=(.5*-x.point.y+.5)*l.height),x}function Et(_,n,l,p){if(l.pitchWithMap){const g=[_,n,0,1];return a.ao(g,g,p),l.transform.projectTileCoordinates(g[0]/g[3],g[1]/g[3],l.unwrappedTileID,l.getElevation).point}return{x:_/l.width*2-1,y:n/l.height*2-1}}function Ht(_,n,l){return l.transform.projectTileCoordinates(_,n,l.unwrappedTileID,l.getElevation)}function zt(_,n,l){return _._unit()._perp()._mult(n*l)}function Zt(_,n,l,p,g,x,T,A,C){if(A.projectionCache.offsets[_])return A.projectionCache.offsets[_];const R=l.add(n);if(_+C.direction<p||_+C.direction>=g)return A.projectionCache.offsets[_]=R,R;const L=ot(_+C.direction,A,C),N=zt(L.sub(l),T,C.direction),z=l.add(N),H=L.add(N);return A.projectionCache.offsets[_]=a.ap(x,R,z,H)||R,A.projectionCache.offsets[_]}function Dt(_,n,l,p,g,x,T,A,C){const R=p?_-n:_+n;let L=R>0?1:-1,N=0;p&&(L*=-1,N=Math.PI),L<0&&(N+=Math.PI);let z,H=L>0?x+g:x+g+1;A.projectionCache.cachedAnchorPoint?z=A.projectionCache.cachedAnchorPoint:(z=At(A.tileAnchorPoint.x,A.tileAnchorPoint.y,A).point,A.projectionCache.cachedAnchorPoint=z);let q,se,ne=z,le=z,he=0,xe=0;const ve=Math.abs(R),Pe=[];let Re;for(;he+xe<=ve;){if(H+=L,H<x||H>=T)return null;he+=xe,le=ne,se=q;const He={absOffsetX:ve,direction:L,distanceFromAnchor:he,previousVertex:le};if(ne=ot(H,A,He),l===0)Pe.push(le),Re=ne.sub(le);else{let it;const nt=ne.sub(le);it=nt.mag()===0?zt(ot(H+L,A,He).sub(ne),l,L):zt(nt,l,L),se||(se=le.add(it)),q=Zt(H,it,ne,x,T,se,l,A,He),Pe.push(se),Re=q.sub(se)}xe=Re.mag()}const Ie=Re._mult((ve-he)/xe)._add(se||le),$e=N+Math.atan2(ne.y-le.y,ne.x-le.x);return Pe.push(Ie),{point:Ie,angle:C?$e:0,path:Pe}}const Ms=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function ji(_,n){for(let l=0;l<_;l++){const p=n.length;n.resize(p+4),n.float32.set(Ms,3*p)}}function qi(_,n,l){const p=n[0],g=n[1];return _[0]=l[0]*p+l[4]*g+l[12],_[1]=l[1]*p+l[5]*g+l[13],_[3]=l[3]*p+l[7]*g+l[15],_}const bi=100;class Ha{constructor(n,l=new Oe(n.width+200,n.height+200,25),p=new Oe(n.width+200,n.height+200,25)){this.transform=n,this.grid=l,this.ignoredGrid=p,this.pitchFactor=Math.cos(n.pitch*Math.PI/180)*n.cameraToCenterDistance,this.screenRightBoundary=n.width+bi,this.screenBottomBoundary=n.height+bi,this.gridRightBoundary=n.width+200,this.gridBottomBoundary=n.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(n,l,p,g,x,T,A,C,R,L,N,z){const H=this.projectAndGetPerspectiveRatio(n.anchorPointX+C[0],n.anchorPointY+C[1],x,L,z),q=p*H.perspectiveRatio;let se;if(T||A)se=this._projectCollisionBox(n,q,g,x,T,A,C,H,L,N,z);else{const Re=H.x+(N?N.x*q:0),Ie=H.y+(N?N.y*q:0);se={allPointsOccluded:!1,box:[Re+n.x1*q,Ie+n.y1*q,Re+n.x2*q,Ie+n.y2*q]}}const[ne,le,he,xe]=se.box,ve=T?se.allPointsOccluded:H.isOccluded;let Pe=ve;return Pe||(Pe=H.perspectiveRatio<this.perspectiveRatioCutoff),Pe||(Pe=!this.isInsideGrid(ne,le,he,xe)),Pe||l!=="always"&&this.grid.hitTest(ne,le,he,xe,l,R)?{box:[ne,le,he,xe],placeable:!1,offscreen:!1,occluded:ve}:{box:[ne,le,he,xe],placeable:!0,offscreen:this.isOffscreen(ne,le,he,xe),occluded:ve}}placeCollisionCircles(n,l,p,g,x,T,A,C,R,L,N,z,H,q){const se=[],ne=new a.P(l.anchorX,l.anchorY),le=this.getPerspectiveRatio(ne.x,ne.y,T,q),he=(R?x*this.transform.getPitchedTextCorrection(l.anchorX,l.anchorY,T)/le:x*le)/a.au,xe={getElevation:q,pitchedLabelPlaneMatrix:A,lineVertexArray:p,pitchWithMap:R,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:ne,unwrappedTileID:T,width:this.transform.width,height:this.transform.height,translation:H},ve=vt(he,g,l.lineOffsetX*he,l.lineOffsetY*he,!1,l,!1,xe);let Pe=!1,Re=!1,Ie=!0;if(ve){const $e=.5*N*le+z,He=new a.P(-100,-100),it=new a.P(this.screenRightBoundary,this.screenBottomBoundary),nt=new ue,et=ve.first,xt=ve.last;let yt=[];for(let Rt=et.path.length-1;Rt>=1;Rt--)yt.push(et.path[Rt]);for(let Rt=1;Rt<xt.path.length;Rt++)yt.push(xt.path[Rt]);const ct=2.5*$e;if(R){const Rt=this.projectPathToScreenSpace(yt,xe);yt=Rt.some((li=>li.signedDistanceFromCamera<=0))?[]:Rt.map((li=>li.point))}let Pt=[];if(yt.length>0){const Rt=yt[0].clone(),li=yt[0].clone();for(let xi=1;xi<yt.length;xi++)Rt.x=Math.min(Rt.x,yt[xi].x),Rt.y=Math.min(Rt.y,yt[xi].y),li.x=Math.max(li.x,yt[xi].x),li.y=Math.max(li.y,yt[xi].y);Pt=Rt.x>=He.x&&li.x<=it.x&&Rt.y>=He.y&&li.y<=it.y?[yt]:li.x<He.x||Rt.x>it.x||li.y<He.y||Rt.y>it.y?[]:a.aq([yt],He.x,He.y,it.x,it.y)}for(const Rt of Pt){nt.reset(Rt,.25*$e);let li=0;li=nt.length<=.5*$e?1:Math.ceil(nt.paddedLength/ct)+1;for(let xi=0;xi<li;xi++){const fi=xi/Math.max(li-1,1),Ii=nt.lerp(fi),wi=Ii.x+bi,ui=Ii.y+bi;se.push(wi,ui,$e,0);const pi=wi-$e,ir=ui-$e,rr=wi+$e,Xi=ui+$e;if(Ie=Ie&&this.isOffscreen(pi,ir,rr,Xi),Re=Re||this.isInsideGrid(pi,ir,rr,Xi),n!=="always"&&this.grid.hitTestCircle(wi,ui,$e,n,L)&&(Pe=!0,!C))return{circles:[],offscreen:!1,collisionDetected:Pe}}}}return{circles:!C&&Pe||!Re||le<this.perspectiveRatioCutoff?[]:se,offscreen:Ie,collisionDetected:Pe}}projectPathToScreenSpace(n,l){const p=(function(g,x){const T=a.K();return a.ai(T,x.pitchedLabelPlaneMatrix),g.map((A=>{const C=Ke(A.x,A.y,T,x.getElevation),R=x.transform.projectTileCoordinates(C.point.x,C.point.y,x.unwrappedTileID,x.getElevation);return R.point.x=(.5*R.point.x+.5)*x.width,R.point.y=(.5*-R.point.y+.5)*x.height,R}))})(n,l);return(function(g){let x=0,T=0,A=0,C=0;for(let R=0;R<g.length;R++)g[R].isOccluded?(A=R+1,C=0):(C++,C>T&&(T=C,x=A));return g.slice(x,x+T)})(p)}queryRenderedSymbols(n){if(n.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const l=[];let p=1/0,g=1/0,x=-1/0,T=-1/0;for(const L of n){const N=new a.P(L.x+bi,L.y+bi);p=Math.min(p,N.x),g=Math.min(g,N.y),x=Math.max(x,N.x),T=Math.max(T,N.y),l.push(N)}const A=this.grid.query(p,g,x,T).concat(this.ignoredGrid.query(p,g,x,T)),C={},R={};for(const L of A){const N=L.key;if(C[N.bucketInstanceId]===void 0&&(C[N.bucketInstanceId]={}),C[N.bucketInstanceId][N.featureIndex])continue;const z=[new a.P(L.x1,L.y1),new a.P(L.x2,L.y1),new a.P(L.x2,L.y2),new a.P(L.x1,L.y2)];a.ar(l,z)&&(C[N.bucketInstanceId][N.featureIndex]=!0,R[N.bucketInstanceId]===void 0&&(R[N.bucketInstanceId]=[]),R[N.bucketInstanceId].push(N.featureIndex))}return R}insertCollisionBox(n,l,p,g,x,T){(p?this.ignoredGrid:this.grid).insert({bucketInstanceId:g,featureIndex:x,collisionGroupID:T,overlapMode:l},n[0],n[1],n[2],n[3])}insertCollisionCircles(n,l,p,g,x,T){const A=p?this.ignoredGrid:this.grid,C={bucketInstanceId:g,featureIndex:x,collisionGroupID:T,overlapMode:l};for(let R=0;R<n.length;R+=4)A.insertCircle(C,n[R],n[R+1],n[R+2])}projectAndGetPerspectiveRatio(n,l,p,g,x){if(x){let T;g?(T=[n,l,g(n,l),1],a.ao(T,T,x)):(T=[n,l,0,1],qi(T,T,x));const A=T[3];return{x:(T[0]/A+1)/2*this.transform.width+bi,y:(-T[1]/A+1)/2*this.transform.height+bi,perspectiveRatio:.5+this.transform.cameraToCenterDistance/A*.5,isOccluded:!1,signedDistanceFromCamera:A}}{const T=this.transform.projectTileCoordinates(n,l,p,g);return{x:(T.point.x+1)/2*this.transform.width+bi,y:(1-T.point.y)/2*this.transform.height+bi,perspectiveRatio:.5+this.transform.cameraToCenterDistance/T.signedDistanceFromCamera*.5,isOccluded:T.isOccluded,signedDistanceFromCamera:T.signedDistanceFromCamera}}}getPerspectiveRatio(n,l,p,g){const x=this.transform.projectTileCoordinates(n,l,p,g);return .5+this.transform.cameraToCenterDistance/x.signedDistanceFromCamera*.5}isOffscreen(n,l,p,g){return p<bi||n>=this.screenRightBoundary||g<bi||l>this.screenBottomBoundary}isInsideGrid(n,l,p,g){return p>=0&&n<this.gridRightBoundary&&g>=0&&l<this.gridBottomBoundary}getViewportMatrix(){const n=a.as([]);return a.L(n,n,[-100,-100,0]),n}_projectCollisionBox(n,l,p,g,x,T,A,C,R,L,N){let z=1,H=0,q=0,se=1;const ne=n.anchorPointX+A[0],le=n.anchorPointY+A[1];if(T&&!x){const yt=this.projectAndGetPerspectiveRatio(ne+1,le,g,R,N),ct=yt.x-C.x,Pt=Math.atan((yt.y-C.y)/ct)+(ct<0?Math.PI:0),Rt=Math.sin(Pt),li=Math.cos(Pt);z=li,H=Rt,q=-Rt,se=li}else if(!T&&x){const yt=rt(this.transform);z=yt.vecEast[0],H=yt.vecEast[1],q=yt.vecSouth[0],se=yt.vecSouth[1]}let he=C.x,xe=C.y,ve=l;x&&(he=ne,xe=le,ve=Math.pow(2,-(this.transform.zoom-p.overscaledZ)),ve*=this.transform.getPitchedTextCorrection(ne,le,g),L||(ve*=a.ad(.5+C.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),L&&(he+=z*L.x*ve+q*L.y*ve,xe+=H*L.x*ve+se*L.y*ve);const Pe=n.x1*ve,Re=n.x2*ve,Ie=(Pe+Re)/2,$e=n.y1*ve,He=n.y2*ve,it=($e+He)/2,nt=[{offsetX:Pe,offsetY:$e},{offsetX:Ie,offsetY:$e},{offsetX:Re,offsetY:$e},{offsetX:Re,offsetY:it},{offsetX:Re,offsetY:He},{offsetX:Ie,offsetY:He},{offsetX:Pe,offsetY:He},{offsetX:Pe,offsetY:it}];let et=[];for(const{offsetX:yt,offsetY:ct}of nt)et.push(new a.P(he+z*yt+q*ct,xe+H*yt+se*ct));let xt=!1;if(x){const yt=et.map((ct=>this.projectAndGetPerspectiveRatio(ct.x,ct.y,g,R,N)));xt=yt.some((ct=>!ct.isOccluded)),et=yt.map((ct=>new a.P(ct.x,ct.y)))}else xt=!0;return{box:a.at(et),allPointsOccluded:!xt}}}class Cr{constructor(n,l,p,g){this.opacity=n?Math.max(0,Math.min(1,n.opacity+(n.placed?l:-l))):g&&p?1:0,this.placed=p}isHidden(){return this.opacity===0&&!this.placed}}class mi{constructor(n,l,p,g,x){this.text=new Cr(n?n.text:null,l,p,x),this.icon=new Cr(n?n.icon:null,l,g,x)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Bh{constructor(n,l,p){this.text=n,this.icon=l,this.skipFade=p}}class Yo{constructor(n,l,p,g,x){this.bucketInstanceId=n,this.featureIndex=l,this.sourceLayerIndex=p,this.bucketIndex=g,this.tileID=x}}class Ac{constructor(n){this.crossSourceCollisions=n,this.maxGroupID=0,this.collisionGroups={}}get(n){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[n]){const l=++this.maxGroupID;this.collisionGroups[n]={ID:l,predicate:p=>p.collisionGroupID===l}}return this.collisionGroups[n]}}function as(_,n,l,p,g){const{horizontalAlign:x,verticalAlign:T}=a.aA(_);return new a.P(-(x-.5)*n+p[0]*g,-(T-.5)*l+p[1]*g)}class lo{constructor(n,l,p,g,x){this.transform=n.clone(),this.terrain=l,this.collisionIndex=new Ha(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=p,this.retainedQueryData={},this.collisionGroups=new Ac(g),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=x,x&&(x.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(n){const l=this.terrain;return l?(p,g)=>l.getElevation(n,p,g):null}getBucketParts(n,l,p,g){const x=p.getBucket(l),T=p.latestFeatureIndex;if(!x||!T||l.id!==x.layerIds[0])return;const A=p.collisionBoxArray,C=x.layers[0].layout,R=x.layers[0].paint,L=Math.pow(2,this.transform.zoom-p.tileID.overscaledZ),N=p.tileSize/a.Z,z=p.tileID.toUnwrapped(),H=C.get("text-rotation-alignment")==="map",q=a.av(p,1,this.transform.zoom),se=a.aw(this.collisionIndex.transform,p,R.get("text-translate"),R.get("text-translate-anchor")),ne=a.aw(this.collisionIndex.transform,p,R.get("icon-translate"),R.get("icon-translate-anchor")),le=qe(H,this.transform,q);this.retainedQueryData[x.bucketInstanceId]=new Yo(x.bucketInstanceId,T,x.sourceLayerIndex,x.index,p.tileID);const he={bucket:x,layout:C,translationText:se,translationIcon:ne,unwrappedTileID:z,pitchedLabelPlaneMatrix:le,scale:L,textPixelRatio:N,holdingForFade:p.holdingForFade(),collisionBoxArray:A,partiallyEvaluatedTextSize:a.af(x.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(x.sourceID)};if(g)for(const xe of x.sortKeyRanges){const{sortKey:ve,symbolInstanceStart:Pe,symbolInstanceEnd:Re}=xe;n.push({sortKey:ve,symbolInstanceStart:Pe,symbolInstanceEnd:Re,parameters:he})}else n.push({symbolInstanceStart:0,symbolInstanceEnd:x.symbolInstances.length,parameters:he})}attemptAnchorPlacement(n,l,p,g,x,T,A,C,R,L,N,z,H,q,se,ne,le,he,xe,ve){const Pe=a.ax[n.textAnchor],Re=[n.textOffset0,n.textOffset1],Ie=as(Pe,p,g,Re,x),$e=this.collisionIndex.placeCollisionBox(l,z,C,R,L,A,T,ne,N.predicate,xe,Ie,ve);if((!he||this.collisionIndex.placeCollisionBox(he,z,C,R,L,A,T,le,N.predicate,xe,Ie,ve).placeable)&&$e.placeable){let He;if(this.prevPlacement&&this.prevPlacement.variableOffsets[H.crossTileID]&&this.prevPlacement.placements[H.crossTileID]&&this.prevPlacement.placements[H.crossTileID].text&&(He=this.prevPlacement.variableOffsets[H.crossTileID].anchor),H.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[H.crossTileID]={textOffset:Re,width:p,height:g,anchor:Pe,textBoxScale:x,prevAnchor:He},this.markUsedJustification(q,Pe,H,se),q.allowVerticalPlacement&&(this.markUsedOrientation(q,se,H),this.placedOrientations[H.crossTileID]=se),{shift:Ie,placedGlyphBoxes:$e}}}placeLayerBucketPart(n,l,p){const{bucket:g,layout:x,translationText:T,translationIcon:A,unwrappedTileID:C,pitchedLabelPlaneMatrix:R,textPixelRatio:L,holdingForFade:N,collisionBoxArray:z,partiallyEvaluatedTextSize:H,collisionGroup:q}=n.parameters,se=x.get("text-optional"),ne=x.get("icon-optional"),le=a.ay(x,"text-overlap","text-allow-overlap"),he=le==="always",xe=a.ay(x,"icon-overlap","icon-allow-overlap"),ve=xe==="always",Pe=x.get("text-rotation-alignment")==="map",Re=x.get("text-pitch-alignment")==="map",Ie=x.get("icon-text-fit")!=="none",$e=x.get("symbol-z-order")==="viewport-y",He=he&&(ve||!g.hasIconData()||ne),it=ve&&(he||!g.hasTextData()||se);!g.collisionArrays&&z&&g.deserializeCollisionBoxes(z);const nt=this.retainedQueryData[g.bucketInstanceId].tileID,et=this._getTerrainElevationFunc(nt),xt=this.transform.getFastPathSimpleProjectionMatrix(nt),yt=(ct,Pt,Rt)=>{var li,xi;if(l[ct.crossTileID])return;if(N)return void(this.placements[ct.crossTileID]=new Bh(!1,!1,!1));let fi=!1,Ii=!1,wi=!0,ui=null,pi={box:null,placeable:!1,offscreen:null,occluded:!1},ir={placeable:!1},rr=null,Xi=null,fr=null,ps=0,$n=0,An=0;Pt.textFeatureIndex?ps=Pt.textFeatureIndex:ct.useRuntimeCollisionCircles&&(ps=ct.featureIndex),Pt.verticalTextFeatureIndex&&($n=Pt.verticalTextFeatureIndex);const tn=Pt.textBox;if(tn){const rn=vi=>{let _i=a.ag.horizontal;if(g.allowVerticalPlacement&&!vi&&this.prevPlacement){const Gi=this.prevPlacement.placedOrientations[ct.crossTileID];Gi&&(this.placedOrientations[ct.crossTileID]=Gi,_i=Gi,this.markUsedOrientation(g,_i,ct))}return _i},Pn=(vi,_i)=>{if(g.allowVerticalPlacement&&ct.numVerticalGlyphVertices>0&&Pt.verticalTextBox){for(const Gi of g.writingModes)if(Gi===a.ag.vertical?(pi=_i(),ir=pi):pi=vi(),pi&&pi.placeable)break}else pi=vi()},un=ct.textAnchorOffsetStartIndex,Cn=ct.textAnchorOffsetEndIndex;if(Cn===un){const vi=(_i,Gi)=>{const Yi=this.collisionIndex.placeCollisionBox(_i,le,L,nt,C,Re,Pe,T,q.predicate,et,void 0,xt);return Yi&&Yi.placeable&&(this.markUsedOrientation(g,Gi,ct),this.placedOrientations[ct.crossTileID]=Gi),Yi};Pn((()=>vi(tn,a.ag.horizontal)),(()=>{const _i=Pt.verticalTextBox;return g.allowVerticalPlacement&&ct.numVerticalGlyphVertices>0&&_i?vi(_i,a.ag.vertical):{box:null,offscreen:null}})),rn(pi&&pi.placeable)}else{let vi=a.ax[(xi=(li=this.prevPlacement)===null||li===void 0?void 0:li.variableOffsets[ct.crossTileID])===null||xi===void 0?void 0:xi.anchor];const _i=(Yi,Xs,Zp)=>{const Pd=Yi.x2-Yi.x1,Au=Yi.y2-Yi.y1,Cd=ct.textBoxScale,Gs=Ie&&xe==="never"?Xs:null;let jr=null,Pu=le==="never"?1:2,Id="never";vi&&Pu++;for(let Ll=0;Ll<Pu;Ll++){for(let Fl=un;Fl<Cn;Fl++){const Md=g.textAnchorOffsets.get(Fl);if(vi&&Md.textAnchor!==vi)continue;const Bl=this.attemptAnchorPlacement(Md,Yi,Pd,Au,Cd,Pe,Re,L,nt,C,q,Id,ct,g,Zp,T,A,Gs,et);if(Bl&&(jr=Bl.placedGlyphBoxes,jr&&jr.placeable))return fi=!0,ui=Bl.shift,jr}vi?vi=null:Id=le}return p&&!jr&&(jr={box:this.collisionIndex.placeCollisionBox(tn,"always",L,nt,C,Re,Pe,T,q.predicate,et,void 0,xt).box,offscreen:!1,placeable:!1,occluded:!1}),jr};Pn((()=>_i(tn,Pt.iconBox,a.ag.horizontal)),(()=>{const Yi=Pt.verticalTextBox;return g.allowVerticalPlacement&&(!pi||!pi.placeable)&&ct.numVerticalGlyphVertices>0&&Yi?_i(Yi,Pt.verticalIconBox,a.ag.vertical):{box:null,occluded:!0,offscreen:null}})),pi&&(fi=pi.placeable,wi=pi.offscreen);const Gi=rn(pi&&pi.placeable);if(!fi&&this.prevPlacement){const Yi=this.prevPlacement.variableOffsets[ct.crossTileID];Yi&&(this.variableOffsets[ct.crossTileID]=Yi,this.markUsedJustification(g,Yi.anchor,ct,Gi))}}}if(rr=pi,fi=rr&&rr.placeable,wi=rr&&rr.offscreen,ct.useRuntimeCollisionCircles){const rn=g.text.placedSymbolArray.get(ct.centerJustifiedTextSymbolIndex),Pn=a.ah(g.textSizeData,H,rn),un=x.get("text-padding");Xi=this.collisionIndex.placeCollisionCircles(le,rn,g.lineVertexArray,g.glyphOffsetArray,Pn,C,R,p,Re,q.predicate,ct.collisionCircleDiameter,un,T,et),Xi.circles.length&&Xi.collisionDetected&&!p&&a.w("Collisions detected, but collision boxes are not shown"),fi=he||Xi.circles.length>0&&!Xi.collisionDetected,wi=wi&&Xi.offscreen}if(Pt.iconFeatureIndex&&(An=Pt.iconFeatureIndex),Pt.iconBox){const rn=Pn=>this.collisionIndex.placeCollisionBox(Pn,xe,L,nt,C,Re,Pe,A,q.predicate,et,Ie&&ui?ui:void 0,xt);ir&&ir.placeable&&Pt.verticalIconBox?(fr=rn(Pt.verticalIconBox),Ii=fr.placeable):(fr=rn(Pt.iconBox),Ii=fr.placeable),wi=wi&&fr.offscreen}const Zs=se||ct.numHorizontalGlyphVertices===0&&ct.numVerticalGlyphVertices===0,ma=ne||ct.numIconVertices===0;Zs||ma?ma?Zs||(Ii=Ii&&fi):fi=Ii&&fi:Ii=fi=Ii&&fi;const qs=Ii&&fr.placeable;if(fi&&rr.placeable&&this.collisionIndex.insertCollisionBox(rr.box,le,x.get("text-ignore-placement"),g.bucketInstanceId,ir&&ir.placeable&&$n?$n:ps,q.ID),qs&&this.collisionIndex.insertCollisionBox(fr.box,xe,x.get("icon-ignore-placement"),g.bucketInstanceId,An,q.ID),Xi&&fi&&this.collisionIndex.insertCollisionCircles(Xi.circles,le,x.get("text-ignore-placement"),g.bucketInstanceId,ps,q.ID),p&&this.storeCollisionData(g.bucketInstanceId,Rt,Pt,rr,fr,Xi),ct.crossTileID===0)throw new Error("symbolInstance.crossTileID can't be 0");if(g.bucketInstanceId===0)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[ct.crossTileID]=new Bh((fi||He)&&!rr?.occluded,(Ii||it)&&!fr?.occluded,wi||g.justReloaded),l[ct.crossTileID]=!0};if($e){if(n.symbolInstanceStart!==0)throw new Error("bucket.bucketInstanceId should be 0");const ct=g.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let Pt=ct.length-1;Pt>=0;--Pt){const Rt=ct[Pt];yt(g.symbolInstances.get(Rt),g.collisionArrays[Rt],Rt)}}else for(let ct=n.symbolInstanceStart;ct<n.symbolInstanceEnd;ct++)yt(g.symbolInstances.get(ct),g.collisionArrays[ct],ct);g.justReloaded=!1}storeCollisionData(n,l,p,g,x,T){if(p.textBox||p.iconBox){let A,C;this.collisionBoxArrays.has(n)?A=this.collisionBoxArrays.get(n):(A=new Map,this.collisionBoxArrays.set(n,A)),A.has(l)?C=A.get(l):(C={text:null,icon:null},A.set(l,C)),p.textBox&&(C.text=g.box),p.iconBox&&(C.icon=x.box)}if(T){let A=this.collisionCircleArrays[n];A===void 0&&(A=this.collisionCircleArrays[n]=[]);for(let C=0;C<T.circles.length;C+=4)A.push(T.circles[C+0]-bi),A.push(T.circles[C+1]-bi),A.push(T.circles[C+2]),A.push(T.collisionDetected?1:0)}}markUsedJustification(n,l,p,g){let x;x=g===a.ag.vertical?p.verticalPlacedTextSymbolIndex:{left:p.leftJustifiedTextSymbolIndex,center:p.centerJustifiedTextSymbolIndex,right:p.rightJustifiedTextSymbolIndex}[a.az(l)];const T=[p.leftJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.rightJustifiedTextSymbolIndex,p.verticalPlacedTextSymbolIndex];for(const A of T)A>=0&&(n.text.placedSymbolArray.get(A).crossTileID=x>=0&&A!==x?0:p.crossTileID)}markUsedOrientation(n,l,p){const g=l===a.ag.horizontal||l===a.ag.horizontalOnly?l:0,x=l===a.ag.vertical?l:0,T=[p.leftJustifiedTextSymbolIndex,p.centerJustifiedTextSymbolIndex,p.rightJustifiedTextSymbolIndex];for(const A of T)n.text.placedSymbolArray.get(A).placedOrientation=g;p.verticalPlacedTextSymbolIndex&&(n.text.placedSymbolArray.get(p.verticalPlacedTextSymbolIndex).placedOrientation=x)}commit(n){this.commitTime=n,this.zoomAtLastRecencyCheck=this.transform.zoom;const l=this.prevPlacement;let p=!1;this.prevZoomAdjustment=l?l.zoomAdjustment(this.transform.zoom):0;const g=l?l.symbolFadeChange(n):1,x=l?l.opacities:{},T=l?l.variableOffsets:{},A=l?l.placedOrientations:{};for(const C in this.placements){const R=this.placements[C],L=x[C];L?(this.opacities[C]=new mi(L,g,R.text,R.icon),p=p||R.text!==L.text.placed||R.icon!==L.icon.placed):(this.opacities[C]=new mi(null,g,R.text,R.icon,R.skipFade),p=p||R.text||R.icon)}for(const C in x){const R=x[C];if(!this.opacities[C]){const L=new mi(R,g,!1,!1);L.isHidden()||(this.opacities[C]=L,p=p||R.text.placed||R.icon.placed)}}for(const C in T)this.variableOffsets[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.variableOffsets[C]=T[C]);for(const C in A)this.placedOrientations[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.placedOrientations[C]=A[C]);if(l&&l.lastPlacementChangeTime===void 0)throw new Error("Last placement time for previous placement is not defined");p?this.lastPlacementChangeTime=n:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=l?l.lastPlacementChangeTime:n)}updateLayerOpacities(n,l){const p={};for(const g of l){const x=g.getBucket(n);x&&g.latestFeatureIndex&&n.id===x.layerIds[0]&&this.updateBucketOpacities(x,g.tileID,p,g.collisionBoxArray)}}updateBucketOpacities(n,l,p,g){n.hasTextData()&&(n.text.opacityVertexArray.clear(),n.text.hasVisibleVertices=!1),n.hasIconData()&&(n.icon.opacityVertexArray.clear(),n.icon.hasVisibleVertices=!1),n.hasIconCollisionBoxData()&&n.iconCollisionBox.collisionVertexArray.clear(),n.hasTextCollisionBoxData()&&n.textCollisionBox.collisionVertexArray.clear();const x=n.layers[0],T=x.layout,A=new mi(null,0,!1,!1,!0),C=T.get("text-allow-overlap"),R=T.get("icon-allow-overlap"),L=x._unevaluatedLayout.hasValue("text-variable-anchor")||x._unevaluatedLayout.hasValue("text-variable-anchor-offset"),N=T.get("text-rotation-alignment")==="map",z=T.get("text-pitch-alignment")==="map",H=T.get("icon-text-fit")!=="none",q=new mi(null,0,C&&(R||!n.hasIconData()||T.get("icon-optional")),R&&(C||!n.hasTextData()||T.get("text-optional")),!0);!n.collisionArrays&&g&&(n.hasIconCollisionBoxData()||n.hasTextCollisionBoxData())&&n.deserializeCollisionBoxes(g);const se=(le,he,xe)=>{for(let ve=0;ve<he/4;ve++)le.opacityVertexArray.emplaceBack(xe);le.hasVisibleVertices=le.hasVisibleVertices||xe!==uo},ne=this.collisionBoxArrays.get(n.bucketInstanceId);for(let le=0;le<n.symbolInstances.length;le++){const he=n.symbolInstances.get(le),{numHorizontalGlyphVertices:xe,numVerticalGlyphVertices:ve,crossTileID:Pe}=he;let Re=this.opacities[Pe];p[Pe]?Re=A:Re||(Re=q,this.opacities[Pe]=Re),p[Pe]=!0;const Ie=he.numIconVertices>0,$e=this.placedOrientations[he.crossTileID],He=$e===a.ag.vertical,it=$e===a.ag.horizontal||$e===a.ag.horizontalOnly;if(xe>0||ve>0){const et=Cc(Re.text);se(n.text,xe,He?uo:et),se(n.text,ve,it?uo:et);const xt=Re.text.isHidden();[he.rightJustifiedTextSymbolIndex,he.centerJustifiedTextSymbolIndex,he.leftJustifiedTextSymbolIndex].forEach((Pt=>{Pt>=0&&(n.text.placedSymbolArray.get(Pt).hidden=xt||He?1:0)})),he.verticalPlacedTextSymbolIndex>=0&&(n.text.placedSymbolArray.get(he.verticalPlacedTextSymbolIndex).hidden=xt||it?1:0);const yt=this.variableOffsets[he.crossTileID];yt&&this.markUsedJustification(n,yt.anchor,he,$e);const ct=this.placedOrientations[he.crossTileID];ct&&(this.markUsedJustification(n,"left",he,ct),this.markUsedOrientation(n,ct,he))}if(Ie){const et=Cc(Re.icon),xt=!(H&&he.verticalPlacedIconSymbolIndex&&He);he.placedIconSymbolIndex>=0&&(se(n.icon,he.numIconVertices,xt?et:uo),n.icon.placedSymbolArray.get(he.placedIconSymbolIndex).hidden=Re.icon.isHidden()),he.verticalPlacedIconSymbolIndex>=0&&(se(n.icon,he.numVerticalIconVertices,xt?uo:et),n.icon.placedSymbolArray.get(he.verticalPlacedIconSymbolIndex).hidden=Re.icon.isHidden())}const nt=ne&&ne.has(le)?ne.get(le):{text:null,icon:null};if(n.hasIconCollisionBoxData()||n.hasTextCollisionBoxData()){const et=n.collisionArrays[le];if(et){let xt=new a.P(0,0);if(et.textBox||et.verticalTextBox){let yt=!0;if(L){const ct=this.variableOffsets[Pe];ct?(xt=as(ct.anchor,ct.width,ct.height,ct.textOffset,ct.textBoxScale),N&&xt._rotate(z?-this.transform.bearingInRadians:this.transform.bearingInRadians)):yt=!1}if(et.textBox||et.verticalTextBox){let ct;et.textBox&&(ct=He),et.verticalTextBox&&(ct=it),Pc(n.textCollisionBox.collisionVertexArray,Re.text.placed,!yt||ct,nt.text,xt.x,xt.y)}}if(et.iconBox||et.verticalIconBox){const yt=!!(!it&&et.verticalIconBox);let ct;et.iconBox&&(ct=yt),et.verticalIconBox&&(ct=!yt),Pc(n.iconCollisionBox.collisionVertexArray,Re.icon.placed,ct,nt.icon,H?xt.x:0,H?xt.y:0)}}}}if(n.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[n.bucketInstanceId]&&(this.retainedQueryData[n.bucketInstanceId].featureSortOrder=n.featureSortOrder),n.hasTextData()&&n.text.opacityVertexBuffer&&n.text.opacityVertexBuffer.updateData(n.text.opacityVertexArray),n.hasIconData()&&n.icon.opacityVertexBuffer&&n.icon.opacityVertexBuffer.updateData(n.icon.opacityVertexArray),n.hasIconCollisionBoxData()&&n.iconCollisionBox.collisionVertexBuffer&&n.iconCollisionBox.collisionVertexBuffer.updateData(n.iconCollisionBox.collisionVertexArray),n.hasTextCollisionBoxData()&&n.textCollisionBox.collisionVertexBuffer&&n.textCollisionBox.collisionVertexBuffer.updateData(n.textCollisionBox.collisionVertexArray),n.text.opacityVertexArray.length!==n.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${n.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${n.text.layoutVertexArray.length}) / 4`);if(n.icon.opacityVertexArray.length!==n.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${n.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${n.icon.layoutVertexArray.length}) / 4`);n.bucketInstanceId in this.collisionCircleArrays&&(n.collisionCircleArray=this.collisionCircleArrays[n.bucketInstanceId],delete this.collisionCircleArrays[n.bucketInstanceId])}symbolFadeChange(n){return this.fadeDuration===0?1:(n-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(n){return Math.max(0,(this.transform.zoom-n)/1.5)}hasTransitions(n){return this.stale||n-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(n,l){const p=this.zoomAtLastRecencyCheck===l?1-this.zoomAdjustment(l):1;return this.zoomAtLastRecencyCheck=l,this.commitTime+this.fadeDuration*p>n}setStale(){this.stale=!0}}function Pc(_,n,l,p,g,x){p&&p.length!==0||(p=[0,0,0,0]);const T=p[0]-bi,A=p[1]-bi,C=p[2]-bi,R=p[3]-bi;_.emplaceBack(n?1:0,l?1:0,g||0,x||0,T,A),_.emplaceBack(n?1:0,l?1:0,g||0,x||0,C,A),_.emplaceBack(n?1:0,l?1:0,g||0,x||0,C,R),_.emplaceBack(n?1:0,l?1:0,g||0,x||0,T,R)}const Nh=Math.pow(2,25),zh=Math.pow(2,24),co=Math.pow(2,17),Uh=Math.pow(2,16),wp=Math.pow(2,9),Tp=Math.pow(2,8),Sp=Math.pow(2,1);function Cc(_){if(_.opacity===0&&!_.placed)return 0;if(_.opacity===1&&_.placed)return 4294967295;const n=_.placed?1:0,l=Math.floor(127*_.opacity);return l*Nh+n*zh+l*co+n*Uh+l*wp+n*Tp+l*Sp+n}const uo=0;class Ic{constructor(n){this._sortAcrossTiles=n.layout.get("symbol-z-order")!=="viewport-y"&&!n.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(n,l,p,g,x){const T=this._bucketParts;for(;this._currentTileIndex<n.length;)if(l.getBucketParts(T,g,n[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,x())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,T.sort(((A,C)=>A.sortKey-C.sortKey)));this._currentPartIndex<T.length;)if(l.placeLayerBucketPart(T[this._currentPartIndex],this._seenCrossTileIDs,p),this._currentPartIndex++,x())return!0;return!1}}class Mc{constructor(n,l,p,g,x,T,A,C){this.placement=new lo(n,l,T,A,C),this._currentPlacementIndex=p.length-1,this._forceFullPlacement=g,this._showCollisionBoxes=x,this._done=!1}isDone(){return this._done}continuePlacement(n,l,p){const g=D.now(),x=()=>!this._forceFullPlacement&&D.now()-g>2;for(;this._currentPlacementIndex>=0;){const T=l[n[this._currentPlacementIndex]],A=this.placement.collisionIndex.transform.zoom;if(T.type==="symbol"&&(!T.minzoom||T.minzoom<=A)&&(!T.maxzoom||T.maxzoom>A)){if(this._inProgressLayer||(this._inProgressLayer=new Ic(T)),this._inProgressLayer.continuePlacement(p[T.source],this.placement,this._showCollisionBoxes,T,x))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(n){return this.placement.commit(n),this.placement}}const ho=512/a.Z/2;class Rc{constructor(n,l,p){this.tileID=n,this.bucketInstanceId=p,this._symbolsByKey={};const g=new Map;for(let x=0;x<l.length;x++){const T=l.get(x),A=T.key,C=g.get(A);C?C.push(T):g.set(A,[T])}for(const[x,T]of g){const A={positions:T.map((C=>({x:Math.floor(C.anchorX*ho),y:Math.floor(C.anchorY*ho)}))),crossTileIDs:T.map((C=>C.crossTileID))};if(A.positions.length>128){const C=new a.aB(A.positions.length,16,Uint16Array);for(const{x:R,y:L}of A.positions)C.add(R,L);C.finish(),delete A.positions,A.index=C}this._symbolsByKey[x]=A}}getScaledCoordinates(n,l){const{x:p,y:g,z:x}=this.tileID.canonical,{x:T,y:A,z:C}=l.canonical,R=ho/Math.pow(2,C-x),L=(A*a.Z+n.anchorY)*R,N=g*a.Z*ho;return{x:Math.floor((T*a.Z+n.anchorX)*R-p*a.Z*ho),y:Math.floor(L-N)}}findMatches(n,l,p){const g=this.tileID.canonical.z<l.canonical.z?1:Math.pow(2,this.tileID.canonical.z-l.canonical.z);for(let x=0;x<n.length;x++){const T=n.get(x);if(T.crossTileID)continue;const A=this._symbolsByKey[T.key];if(!A)continue;const C=this.getScaledCoordinates(T,l);if(A.index){const R=A.index.range(C.x-g,C.y-g,C.x+g,C.y+g).sort();for(const L of R){const N=A.crossTileIDs[L];if(!p[N]){p[N]=!0,T.crossTileID=N;break}}}else if(A.positions)for(let R=0;R<A.positions.length;R++){const L=A.positions[R],N=A.crossTileIDs[R];if(Math.abs(L.x-C.x)<=g&&Math.abs(L.y-C.y)<=g&&!p[N]){p[N]=!0,T.crossTileID=N;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map((({crossTileIDs:n})=>n))}}class kc{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Za{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(n){const l=Math.round((n-this.lng)/360);if(l!==0)for(const p in this.indexes){const g=this.indexes[p],x={};for(const T in g){const A=g[T];A.tileID=A.tileID.unwrapTo(A.tileID.wrap+l),x[A.tileID.key]=A}this.indexes[p]=x}this.lng=n}addBucket(n,l,p){if(this.indexes[n.overscaledZ]&&this.indexes[n.overscaledZ][n.key]){if(this.indexes[n.overscaledZ][n.key].bucketInstanceId===l.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(n.overscaledZ,this.indexes[n.overscaledZ][n.key])}for(let x=0;x<l.symbolInstances.length;x++)l.symbolInstances.get(x).crossTileID=0;this.usedCrossTileIDs[n.overscaledZ]||(this.usedCrossTileIDs[n.overscaledZ]={});const g=this.usedCrossTileIDs[n.overscaledZ];for(const x in this.indexes){const T=this.indexes[x];if(Number(x)>n.overscaledZ)for(const A in T){const C=T[A];C.tileID.isChildOf(n)&&C.findMatches(l.symbolInstances,n,g)}else{const A=T[n.scaledTo(Number(x)).key];A&&A.findMatches(l.symbolInstances,n,g)}}for(let x=0;x<l.symbolInstances.length;x++){const T=l.symbolInstances.get(x);T.crossTileID||(T.crossTileID=p.generate(),g[T.crossTileID]=!0)}return this.indexes[n.overscaledZ]===void 0&&(this.indexes[n.overscaledZ]={}),this.indexes[n.overscaledZ][n.key]=new Rc(n,l.symbolInstances,l.bucketInstanceId),!0}removeBucketCrossTileIDs(n,l){for(const p of l.getCrossTileIDsLists())for(const g of p)delete this.usedCrossTileIDs[n][g]}removeStaleBuckets(n){let l=!1;for(const p in this.indexes){const g=this.indexes[p];for(const x in g)n[g[x].bucketInstanceId]||(this.removeBucketCrossTileIDs(p,g[x]),delete g[x],l=!0)}return l}}class Dc{constructor(){this.layerIndexes={},this.crossTileIDs=new kc,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(n,l,p){let g=this.layerIndexes[n.id];g===void 0&&(g=this.layerIndexes[n.id]=new Za);let x=!1;const T={};g.handleWrapJump(p);for(const A of l){const C=A.getBucket(n);C&&n.id===C.layerIds[0]&&(C.bucketInstanceId||(C.bucketInstanceId=++this.maxBucketInstanceId),g.addBucket(A.tileID,C,this.crossTileIDs)&&(x=!0),T[C.bucketInstanceId]=!0)}return g.removeStaleBuckets(T)&&(x=!0),x}pruneUnusedLayers(n){const l={};n.forEach((p=>{l[p]=!0}));for(const p in this.layerIndexes)l[p]||delete this.layerIndexes[p]}}var Rs="void main() {fragColor=vec4(1.0);}";const an={prelude:ri(`#ifdef GL_ES
precision mediump float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
out highp vec4 fragColor;`,`#ifdef GL_ES
precision highp float;
#else
#if !defined(lowp)
#define lowp
#endif
#if !defined(mediump)
#define mediump
#endif
#if !defined(highp)
#define highp
#endif
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c
);}
#ifdef TERRAIN3D
uniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;
#endif
const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {
#ifdef TERRAIN3D
highp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));
#else
return 1.0;
#endif
}float calculate_visibility(vec4 pos) {
#ifdef TERRAIN3D
vec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;
#else
return 1.0;
#endif
}float ele(vec2 pos) {
#ifdef TERRAIN3D
vec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;
#else
return 0.0;
#endif
}float get_elevation(vec2 pos) {
#ifdef TERRAIN3D
#ifdef GLOBE
if ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}
#endif
vec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;
#else
return 0.0;
#endif
}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;`),projectionMercator:ri("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:ri("",`#define GLOBE_RADIUS 6371008.8
uniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos
);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); 
if (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len
);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}`),background:ri(`uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:ri(`uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:ri(`in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {
#ifdef GLOBE
vec3 center_vector=projectToSphere(circle_center);
#endif
float angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {
#ifdef GLOBE
vec4 projected_center=interpolateProjection(circle_center,center_vector,ele);
#else
vec4 projected_center=projectTileWithElevation(circle_center,ele);
#endif
corner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}
#ifdef GLOBE
vec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);
#else
gl_Position=projectTileWithElevation(corner_position,ele);
#endif
} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}`),clippingMask:ri(Rs,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:ri(`uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);
#ifdef GLOBE
vec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);
#else
gl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));
#endif
}`),heatmapTexture:ri(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(0.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:ri("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:ri("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:ri("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:ri(Rs,`in vec2 a_pos;void main() {
#ifdef GLOBE
gl_Position=projectTileFor3D(a_pos,0.0);
#else
gl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);
#endif
}`),fill:ri(`#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
fragColor=color*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_fill_translate;in vec2 a_pos;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);}`),fillOutline:ri(`in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillOutlinePattern:ri(`uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
}`),fillPattern:ri(`#ifdef GL_ES
precision highp float;
#endif
uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}`),fillExtrusion:ri(`in vec4 v_color;void main() {fragColor=v_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
out vec4 v_color;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
vec3 normal=a_normal_ed.xyz;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);
#ifdef GLOBE
mat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);
#endif
directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}`),fillExtrusionPattern:ri(`uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;
#ifdef TERRAIN3D
in vec2 a_centroid;
#endif
#ifdef GLOBE
out vec3 v_sphere_pos;
#endif
out vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;
#pragma mapbox: define lowp float base
#pragma mapbox: define lowp float height
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float base
#pragma mapbox: initialize lowp float height
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;
#ifdef TERRAIN3D
float height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);
#else
float height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;
#endif
base=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;
#ifdef GLOBE
vec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);
#else
gl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);
#endif
vec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0
? a_pos
: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}`),hillshadePrepare:ri(`#ifdef GL_ES
precision highp float;
#endif
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));fragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ri(`uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;
#define PI 3.141592653589793
void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,"uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:ri(`uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),lineGradient:ri(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_width2=vec2(outset,inset);}`),linePattern:ri(`#ifdef GL_ES
precision highp float;
#endif
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern_from
#pragma mapbox: define lowp vec4 pattern_to
#pragma mapbox: define lowp float pixel_ratio_from
#pragma mapbox: define lowp float pixel_ratio_to
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern_from
#pragma mapbox: initialize mediump vec4 pattern_to
#pragma mapbox: initialize lowp float pixel_ratio_from
#pragma mapbox: initialize lowp float pixel_ratio_to
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}`),lineSDF:ri(`uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;
#ifdef GLOBE
in float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);
#ifdef GLOBE
if (v_depth > 1.0) {discard;}
#endif
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`
#define scale 0.015873016
#define LINE_DISTANCE_SCALE 2.0
in vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;
#ifdef GLOBE
out float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;
#ifdef GLOBE
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef TERRAIN3D
v_gamma_scale=1.0;
#else
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#endif
v_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}`),raster:ri(`uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;
#ifdef GLOBE
if (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}
#endif
v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),symbolIcon:ri(`uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
lowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize lowp float opacity
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}`),symbolSDF:ri(`#define SDF_PX 8.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}`),symbolTextAndIcon:ri(`#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);
#ifdef OVERDRAW_INSPECTOR
fragColor=vec4(1.0);
#endif
}`,`in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;
#ifdef GLOBE
if(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}
#endif
vec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}`),terrain:ri("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:ri("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:ri("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:ri("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:ri(`in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758
);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}`,"in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:ri("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function ri(_,n){const l=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,p=n.match(/in ([\w]+) ([\w]+)/g),g=_.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),x=n.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),T=x?x.concat(g):g,A={};return{fragmentSource:_=_.replace(l,((C,R,L,N,z)=>(A[z]=!0,R==="define"?`
#ifndef HAS_UNIFORM_u_${z}
in ${L} ${N} ${z};
#else
uniform ${L} ${N} u_${z};
#endif
`:`
#ifdef HAS_UNIFORM_u_${z}
    ${L} ${N} ${z} = u_${z};
#endif
`))),vertexSource:n=n.replace(l,((C,R,L,N,z)=>{const H=N==="float"?"vec2":"vec4",q=z.match(/color/)?"color":H;return A[z]?R==="define"?`
#ifndef HAS_UNIFORM_u_${z}
uniform lowp float u_${z}_t;
in ${L} ${H} a_${z};
out ${L} ${N} ${z};
#else
uniform ${L} ${N} u_${z};
#endif
`:q==="vec4"?`
#ifndef HAS_UNIFORM_u_${z}
    ${z} = a_${z};
#else
    ${L} ${N} ${z} = u_${z};
#endif
`:`
#ifndef HAS_UNIFORM_u_${z}
    ${z} = unpack_mix_${q}(a_${z}, u_${z}_t);
#else
    ${L} ${N} ${z} = u_${z};
#endif
`:R==="define"?`
#ifndef HAS_UNIFORM_u_${z}
uniform lowp float u_${z}_t;
in ${L} ${H} a_${z};
#else
uniform ${L} ${N} u_${z};
#endif
`:q==="vec4"?`
#ifndef HAS_UNIFORM_u_${z}
    ${L} ${N} ${z} = a_${z};
#else
    ${L} ${N} ${z} = u_${z};
#endif
`:`
#ifndef HAS_UNIFORM_u_${z}
    ${L} ${N} ${z} = unpack_mix_${q}(a_${z}, u_${z}_t);
#else
    ${L} ${N} ${z} = u_${z};
#endif
`})),staticAttributes:p,staticUniforms:T}}class zr{constructor(n,l,p){this.vertexBuffer=n,this.indexBuffer=l,this.segments=p}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var qr=a.aC([{name:"a_pos",type:"Int16",components:2}]);const ni="#define PROJECTION_MERCATOR",qa="mercator";class Oc{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return qa}get shaderDefine(){return ni}get shaderPreludeCode(){return an.projectionMercator}get vertexShaderPreludeCode(){return an.projectionMercator.vertexSource}get subdivisionGranularity(){return a.aD.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(n){}getMeshFromTileID(n,l,p,g,x){if(this._cachedMesh)return this._cachedMesh;const T=new a.aE;T.emplaceBack(0,0),T.emplaceBack(a.Z,0),T.emplaceBack(0,a.Z),T.emplaceBack(a.Z,a.Z);const A=n.createVertexBuffer(T,qr.members),C=a.aF.simpleSegment(0,0,4,2),R=new a.aG;R.emplaceBack(1,0,2),R.emplaceBack(1,2,3);const L=n.createIndexBuffer(R);return this._cachedMesh=new zr(A,L,C),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(n){}}function Xr(_,n){const l=a.ad(n.lat,-85.051129,a.aI);return new a.P(a.U(n.lng)*_,a.S(l)*_)}function dr(_,n){return new a.$(n.x/_,n.y/_).toLngLat()}function er(_){return _.cameraToCenterDistance*Math.min(.85*Math.tan(a.ac(90-_.pitch)),Math.tan(a.ac(89.25-_.pitch)))}function ki(_,n){const l=_.canonical,p=n/a.aH(l.z),g=l.x+Math.pow(2,l.z)*_.wrap,x=a.as(new Float64Array(16));return a.L(x,x,[g*p,l.y*p,0]),a.M(x,x,[p/a.Z,p/a.Z,1]),x}function Lc(_,n,l,p,g){const x=a.$.fromLngLat(_,n),T=g*a.aJ(1,_.lat),A=T*Math.cos(a.ac(l)),C=Math.sqrt(T*T-A*A),R=C*Math.sin(a.ac(-p)),L=C*Math.cos(a.ac(-p));return new a.$(x.x+R,x.y+L,x.z+A)}class tr{constructor(n=0,l=0,p=0,g=0){if(isNaN(n)||n<0||isNaN(l)||l<0||isNaN(p)||p<0||isNaN(g)||g<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=n,this.bottom=l,this.left=p,this.right=g}interpolate(n,l,p){return l.top!=null&&n.top!=null&&(this.top=a.B.number(n.top,l.top,p)),l.bottom!=null&&n.bottom!=null&&(this.bottom=a.B.number(n.bottom,l.bottom,p)),l.left!=null&&n.left!=null&&(this.left=a.B.number(n.left,l.left,p)),l.right!=null&&n.right!=null&&(this.right=a.B.number(n.right,l.right,p)),this}getCenter(n,l){const p=a.ad((this.left+n-this.right)/2,0,n),g=a.ad((this.top+l-this.bottom)/2,0,l);return new a.P(p,g)}equals(n){return this.top===n.top&&this.bottom===n.bottom&&this.left===n.left&&this.right===n.right}clone(){return new tr(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Ar(_,n){if(!_.renderWorldCopies||_.lngRange)return;const l=n.lng-_.center.lng;n.lng+=l>180?-360:l<-180?360:0}function Ir(_){return Math.max(0,Math.floor(_))}class Xa{constructor(n,l,p,g,x,T){this._callbacks=n,this._tileSize=512,this._renderWorldCopies=T===void 0||!!T,this._minZoom=l||0,this._maxZoom=p||22,this._minPitch=g??0,this._maxPitch=x??60,this.setMaxBounds(),this._width=0,this._height=0,this._center=new a.Q(0,0),this._elevation=0,this._zoom=0,this._tileZoom=Ir(this._zoom),this._scale=a.aH(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new tr,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(n,l,p){this._latRange=n.latRange,this._lngRange=n.lngRange,this._width=n.width,this._height=n.height,this._center=n.center,this._elevation=n.elevation,this._minElevationForCurrentTile=n.minElevationForCurrentTile,this._zoom=n.zoom,this._tileZoom=Ir(this._zoom),this._scale=a.aH(this._zoom),this._bearingInRadians=n.bearingInRadians,this._fovInRadians=n.fovInRadians,this._pitchInRadians=n.pitchInRadians,this._rollInRadians=n.rollInRadians,this._unmodified=n.unmodified,this._edgeInsets=new tr(n.padding.top,n.padding.bottom,n.padding.left,n.padding.right),this._minZoom=n.minZoom,this._maxZoom=n.maxZoom,this._minPitch=n.minPitch,this._maxPitch=n.maxPitch,this._renderWorldCopies=n.renderWorldCopies,this._cameraToCenterDistance=n.cameraToCenterDistance,this._nearZ=n.nearZ,this._farZ=n.farZ,this._autoCalculateNearFarZ=!p&&n.autoCalculateNearFarZ,l&&this._constrain(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(n){this._minElevationForCurrentTile=n}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(n){this._minZoom!==n&&(this._minZoom=n,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(n){this._maxZoom!==n&&(this._maxZoom=n,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(n){this._minPitch!==n&&(this._minPitch=n,this.setPitch(Math.max(this.pitch,n)))}get maxPitch(){return this._maxPitch}setMaxPitch(n){this._maxPitch!==n&&(this._maxPitch=n,this.setPitch(Math.min(this.pitch,n)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(n){n===void 0?n=!0:n===null&&(n=!1),this._renderWorldCopies=n}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new a.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(n){const l=a.aK(n,-180,180)*Math.PI/180;var p,g,x,T,A,C,R,L,N;this._bearingInRadians!==l&&(this._unmodified=!1,this._bearingInRadians=l,this._calcMatrices(),this._rotationMatrix=w(),p=this._rotationMatrix,x=-this._bearingInRadians,T=(g=this._rotationMatrix)[0],A=g[1],C=g[2],R=g[3],L=Math.sin(x),N=Math.cos(x),p[0]=T*N+C*L,p[1]=A*N+R*L,p[2]=T*-L+C*N,p[3]=A*-L+R*N)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(n){const l=a.ad(n,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==l&&(this._unmodified=!1,this._pitchInRadians=l,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(n){const l=n/180*Math.PI;this._rollInRadians!==l&&(this._unmodified=!1,this._rollInRadians=l,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return a.aL(this._fovInRadians)}setFov(n){n=a.ad(n,.1,150),this.fov!==n&&(this._unmodified=!1,this._fovInRadians=a.ac(n),this._calcMatrices())}get zoom(){return this._zoom}setZoom(n){const l=this.getConstrained(this._center,n).zoom;this._zoom!==l&&(this._unmodified=!1,this._zoom=l,this._tileZoom=Math.max(0,Math.floor(l)),this._scale=a.aH(l),this._constrain(),this._calcMatrices())}get center(){return this._center}setCenter(n){n.lat===this._center.lat&&n.lng===this._center.lng||(this._unmodified=!1,this._center=n,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(n){n!==this._elevation&&(this._elevation=n,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(n){this._edgeInsets.equals(n)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,n,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(n,l){this._autoCalculateNearFarZ=!1,this._nearZ=n,this._farZ=l,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(n){return this._edgeInsets.equals(n)}interpolatePadding(n,l,p){this._unmodified=!1,this._edgeInsets.interpolate(n,l,p),this._constrain(),this._calcMatrices()}resize(n,l,p=!0){this._width=n,this._height=l,p&&this._constrain(),this._calcMatrices()}getMaxBounds(){return this._latRange&&this._latRange.length===2&&this._lngRange&&this._lngRange.length===2?new Yt([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(n){n?(this._lngRange=[n.getWest(),n.getEast()],this._latRange=[n.getSouth(),n.getNorth()],this._constrain()):(this._lngRange=null,this._latRange=[-85.051129,a.aI])}getConstrained(n,l){return this._callbacks.getConstrained(n,l)}getCameraQueryGeometry(n,l){if(l.length===1)return[l[0],n];{let p=n.x,g=n.y,x=n.x,T=n.y;for(const A of l)p=Math.min(p,A.x),g=Math.min(g,A.y),x=Math.max(x,A.x),T=Math.max(T,A.y);return[new a.P(p,g),new a.P(x,g),new a.P(x,T),new a.P(p,T),new a.P(p,g)]}}_constrain(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const n=this._unmodified,{center:l,zoom:p}=this.getConstrained(this.center,this.zoom);this.setCenter(l),this.setZoom(p),this._unmodified=n,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let n=a.as(new Float64Array(16));a.M(n,n,[this._width/2,-this._height/2,1]),a.L(n,n,[1,-1,0]),this._clipSpaceToPixelsMatrix=n,n=a.as(new Float64Array(16)),a.M(n,n,[1,-1,1]),a.L(n,n,[-1,-1,0]),a.M(n,n,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=n,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(n,l,p,g){const x=p!==void 0?p:this.bearing,T=g=g!==void 0?g:this.pitch,A=a.$.fromLngLat(n,l),C=-Math.cos(a.ac(T)),R=Math.sin(a.ac(T)),L=R*Math.sin(a.ac(x)),N=-R*Math.cos(a.ac(x));let z=this.elevation;const H=l-z;let q;C*H>=0||Math.abs(C)<.1?(q=1e4,z=l+q*C):q=-H/C;let se,ne,le=a.aM(1,A.y),he=0;do{if(he+=1,he>10)break;ne=q/le,se=new a.$(A.x+L*ne,A.y+N*ne),le=1/se.meterInMercatorCoordinateUnits()}while(Math.abs(q-ne*le)>1e-12);return{center:se.toLngLat(),elevation:z,zoom:a.aa(this.height/2/Math.tan(this.fovInRadians/2)/ne/this.tileSize)}}recalculateZoomAndCenter(n){if(this.elevation-n==0)return;const l=a.aJ(1,this.center.lat)*this.worldSize,p=this.cameraToCenterDistance/l,g=a.$.fromLngLat(this.center,this.elevation),x=Lc(this.center,this.elevation,this.pitch,this.bearing,p);this._elevation=n;const T=this.calculateCenterFromCameraLngLatAlt(x.toLngLat(),a.aM(x.z,g.y),this.bearing,this.pitch);this._elevation=T.elevation,this._center=T.center,this.setZoom(T.zoom)}getCameraPoint(){const n=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new a.P(n*Math.sin(this.rollInRadians),n*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const n=a.aJ(1,this.center.lat)*this.worldSize;return Lc(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/n).toLngLat()}getMercatorTileCoordinates(n){if(!n)return[0,0,1,1];const l=n.canonical.z>=0?1<<n.canonical.z:Math.pow(2,n.canonical.z);return[n.canonical.x/l,n.canonical.y/l,1/l/a.Z,1/l/a.Z]}}class ln{constructor(n,l){this.min=n,this.max=l,this.center=a.aN([],a.aO([],this.min,this.max),.5)}quadrant(n){const l=[n%2==0,n<2],p=a.aP(this.min),g=a.aP(this.max);for(let x=0;x<l.length;x++)p[x]=l[x]?this.min[x]:this.center[x],g[x]=l[x]?this.center[x]:this.max[x];return g[2]=this.max[2],new ln(p,g)}distanceX(n){return Math.max(Math.min(this.max[0],n[0]),this.min[0])-n[0]}distanceY(n){return Math.max(Math.min(this.max[1],n[1]),this.min[1])-n[1]}intersectsFrustum(n){let l=!0;for(let p=0;p<n.planes.length;p++){const g=this.intersectsPlane(n.planes[p]);if(g===0)return 0;g===1&&(l=!1)}return l?2:n.aabb.min[0]>this.max[0]||n.aabb.min[1]>this.max[1]||n.aabb.min[2]>this.max[2]||n.aabb.max[0]<this.min[0]||n.aabb.max[1]<this.min[1]||n.aabb.max[2]<this.min[2]?0:1}intersectsPlane(n){let l=n[3],p=n[3];for(let g=0;g<3;g++)n[g]>0?(l+=n[g]*this.min[g],p+=n[g]*this.max[g]):(p+=n[g]*this.min[g],l+=n[g]*this.max[g]);return l>=0?2:p<0?0:1}}class $i{distanceToTile2d(n,l,p,g){const x=g.distanceX([n,l]),T=g.distanceY([n,l]);return Math.hypot(x,T)}getWrap(n,l,p){return p}getTileAABB(n,l,p,g){var x,T;let A=p,C=p;if(g.terrain){const L=new a.Y(n.z,l,n.z,n.x,n.y),N=g.terrain.getMinMaxElevation(L);A=(x=N.minElevation)!==null&&x!==void 0?x:p,C=(T=N.maxElevation)!==null&&T!==void 0?T:p}const R=1<<n.z;return new ln([l+n.x/R,n.y/R,A],[l+(n.x+1)/R,(n.y+1)/R,C])}allowVariableZoom(n,l){const p=n.fov*(Math.abs(Math.cos(n.rollInRadians))*n.height+Math.abs(Math.sin(n.rollInRadians))*n.width)/n.height,g=a.ad(78.5-p/2,0,60);return!!l.terrain||n.pitch>g}allowWorldCopies(){return!0}recalculateCache(){}}class ls{constructor(n,l,p){this.points=n,this.planes=l,this.aabb=p}static fromInvProjectionMatrix(n,l=1,p=0){const g=Math.pow(2,p),x=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((R=>{const L=1/(R=a.ao([],R,n))[3]/l*g;return a.aQ(R,R,[L,L,1/R[3],L])})),T=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((R=>{const L=a.aR([],x[R[0]],x[R[1]]),N=a.aR([],x[R[2]],x[R[1]]),z=a.aS([],a.aT([],L,N)),H=-a.aU(z,x[R[1]]);return z.concat(H)})),A=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],C=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const R of x)for(let L=0;L<3;L++)A[L]=Math.min(A[L],R[L]),C[L]=Math.max(C[L],R[L]);return new ls(x,T,new ln(A,C))}}class Gr{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(n){this._helper.setMinZoom(n)}setMaxZoom(n){this._helper.setMaxZoom(n)}setMinPitch(n){this._helper.setMinPitch(n)}setMaxPitch(n){this._helper.setMaxPitch(n)}setRenderWorldCopies(n){this._helper.setRenderWorldCopies(n)}setBearing(n){this._helper.setBearing(n)}setPitch(n){this._helper.setPitch(n)}setRoll(n){this._helper.setRoll(n)}setFov(n){this._helper.setFov(n)}setZoom(n){this._helper.setZoom(n)}setCenter(n){this._helper.setCenter(n)}setElevation(n){this._helper.setElevation(n)}setMinElevationForCurrentTile(n){this._helper.setMinElevationForCurrentTile(n)}setPadding(n){this._helper.setPadding(n)}interpolatePadding(n,l,p){return this._helper.interpolatePadding(n,l,p)}isPaddingEqual(n){return this._helper.isPaddingEqual(n)}resize(n,l,p=!0){this._helper.resize(n,l,p)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(n){this._helper.setMaxBounds(n)}overrideNearFarZ(n,l){this._helper.overrideNearFarZ(n,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(n){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),n)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(n,l){}constructor(n,l,p,g,x){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this._helper=new Xa({calcMatrices:()=>{this._calcMatrices()},getConstrained:(T,A)=>this.getConstrained(T,A)},n,l,p,g,x),this._coveringTilesDetailsProvider=new $i}clone(){const n=new Gr;return n.apply(this),n}apply(n,l,p){this._helper.apply(n,l,p)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(n){const l=[new a.aV(0,n)];if(this._helper._renderWorldCopies){const p=this.screenPointToMercatorCoordinate(new a.P(0,0)),g=this.screenPointToMercatorCoordinate(new a.P(this._helper._width,0)),x=this.screenPointToMercatorCoordinate(new a.P(this._helper._width,this._helper._height)),T=this.screenPointToMercatorCoordinate(new a.P(0,this._helper._height)),A=Math.floor(Math.min(p.x,g.x,x.x,T.x)),C=Math.floor(Math.max(p.x,g.x,x.x,T.x)),R=1;for(let L=A-R;L<=C+R;L++)L!==0&&l.push(new a.aV(L,n))}return l}getCameraFrustum(){return ls.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(n){const l=this.screenPointToLocation(this.centerPoint,n),p=n?n.getElevationForLngLatZoom(l,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(p)}setLocationAtPoint(n,l){const p=a.aJ(this.elevation,this.center.lat),g=this.screenPointToMercatorCoordinateAtZ(l,p),x=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,p),T=a.$.fromLngLat(n),A=new a.$(T.x-(g.x-x.x),T.y-(g.y-x.y));this.setCenter(A?.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(n,l){return l?this.coordinatePoint(a.$.fromLngLat(n),l.getElevationForLngLatZoom(n,this._helper._tileZoom),this._pixelMatrix3D):this.coordinatePoint(a.$.fromLngLat(n))}screenPointToLocation(n,l){var p;return(p=this.screenPointToMercatorCoordinate(n,l))===null||p===void 0?void 0:p.toLngLat()}screenPointToMercatorCoordinate(n,l){if(l){const p=l.pointCoordinate(n);if(p!=null)return p}return this.screenPointToMercatorCoordinateAtZ(n)}screenPointToMercatorCoordinateAtZ(n,l){const p=l||0,g=[n.x,n.y,0,1],x=[n.x,n.y,1,1];a.ao(g,g,this._pixelMatrixInverse),a.ao(x,x,this._pixelMatrixInverse);const T=g[3],A=x[3],C=g[1]/T,R=x[1]/A,L=g[2]/T,N=x[2]/A,z=L===N?0:(p-L)/(N-L);return new a.$(a.B.number(g[0]/T,x[0]/A,z)/this.worldSize,a.B.number(C,R,z)/this.worldSize,p)}coordinatePoint(n,l=0,p=this._pixelMatrix){const g=[n.x*this.worldSize,n.y*this.worldSize,l,1];return a.ao(g,g,p),new a.P(g[0]/g[3],g[1]/g[3])}getBounds(){const n=Math.max(0,this._helper._height/2-er(this));return new Yt().extend(this.screenPointToLocation(new a.P(0,n))).extend(this.screenPointToLocation(new a.P(this._helper._width,n))).extend(this.screenPointToLocation(new a.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new a.P(0,this._helper._height)))}isPointOnMapSurface(n,l){return l?l.pointCoordinate(n)!=null:n.y>this.height/2-er(this)}calculatePosMatrix(n,l=!1,p){var g;const x=(g=n.key)!==null&&g!==void 0?g:a.aW(n.wrap,n.canonical.z,n.canonical.z,n.canonical.x,n.canonical.y),T=l?this._alignedPosMatrixCache:this._posMatrixCache;if(T.has(x)){const R=T.get(x);return p?R.f32:R.f64}const A=ki(n,this.worldSize);a.N(A,l?this._alignedProjMatrix:this._viewProjMatrix,A);const C={f64:A,f32:new Float32Array(A)};return T.set(x,C),p?C.f32:C.f64}calculateFogMatrix(n){const l=n.key,p=this._fogMatrixCacheF32;if(p.has(l))return p.get(l);const g=ki(n,this.worldSize);return a.N(g,this._fogMatrix,g),p.set(l,new Float32Array(g)),p.get(l)}getConstrained(n,l){l=a.ad(+l,this.minZoom,this.maxZoom);const p={center:new a.Q(n.lng,n.lat),zoom:l};let g=this._helper._lngRange;this._helper._renderWorldCopies||g!==null||(g=[-179.9999999999,180-1e-10]);const x=this.tileSize*a.aH(p.zoom);let T=0,A=x,C=0,R=x,L=0,N=0;const{x:z,y:H}=this.size;if(this._helper._latRange){const xe=this._helper._latRange;T=a.S(xe[1])*x,A=a.S(xe[0])*x,A-T<H&&(L=H/(A-T))}g&&(C=a.aK(a.U(g[0])*x,0,x),R=a.aK(a.U(g[1])*x,0,x),R<C&&(R+=x),R-C<z&&(N=z/(R-C)));const{x:q,y:se}=Xr(x,n);let ne,le;const he=Math.max(N||0,L||0);if(he){const xe=new a.P(N?(R+C)/2:q,L?(A+T)/2:se);return p.center=dr(x,xe).wrap(),p.zoom+=a.aa(he),p}if(this._helper._latRange){const xe=H/2;se-xe<T&&(le=T+xe),se+xe>A&&(le=A-xe)}if(g){const xe=(C+R)/2;let ve=q;this._helper._renderWorldCopies&&(ve=a.aK(q,xe-x/2,xe+x/2));const Pe=z/2;ve-Pe<C&&(ne=C+Pe),ve+Pe>R&&(ne=R-Pe)}if(ne!==void 0||le!==void 0){const xe=new a.P(ne??q,le??se);p.center=dr(x,xe).wrap()}return p}calculateCenterFromCameraLngLatAlt(n,l,p,g){return this._helper.calculateCenterFromCameraLngLatAlt(n,l,p,g)}_calculateNearFarZIfNeeded(n,l,p){if(!this._helper.autoCalculateNearFarZ)return;const g=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),x=n-g*this._helper._pixelPerMeter/Math.cos(l),T=g<0?x:n,A=Math.PI/2+this.pitchInRadians,C=a.ac(this.fov)*(Math.abs(Math.cos(a.ac(this.roll)))*this.height+Math.abs(Math.sin(a.ac(this.roll)))*this.width)/this.height*(.5+p.y/this.height),R=Math.sin(C)*T/Math.sin(a.ad(Math.PI-A-C,.01,Math.PI-.01)),L=er(this),N=Math.atan(L/this._helper.cameraToCenterDistance),z=a.ac(.75),H=N>z?2*N*(.5+p.y/(2*L)):z,q=Math.sin(H)*T/Math.sin(a.ad(Math.PI-A-H,.01,Math.PI-.01)),se=Math.min(R,q);this._helper._farZ=1.01*(Math.cos(Math.PI/2-l)*se+T),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const n=this.centerOffset,l=Xr(this.worldSize,this.center),p=l.x,g=l.y;this._helper._pixelPerMeter=a.aJ(1,this.center.lat)*this.worldSize;const x=a.ac(Math.min(this.pitch,89.25)),T=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(x));let A;this._calculateNearFarZIfNeeded(T,x,n),A=new Float64Array(16),a.aX(A,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),a.ai(this._invProjMatrix,A),A[8]=2*-n.x/this._helper._width,A[9]=2*n.y/this._helper._height,this._projectionMatrix=a.aY(A),a.M(A,A,[1,-1,1]),a.L(A,A,[0,0,-this._helper.cameraToCenterDistance]),a.aZ(A,A,-this.rollInRadians),a.a_(A,A,this.pitchInRadians),a.aZ(A,A,-this.bearingInRadians),a.L(A,A,[-p,-g,0]),this._mercatorMatrix=a.M([],A,[this.worldSize,this.worldSize,this.worldSize]),a.M(A,A,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=a.N(new Float64Array(16),this.clipSpaceToPixelsMatrix,A),a.L(A,A,[0,0,-this.elevation]),this._viewProjMatrix=A,this._invViewProjMatrix=a.ai([],A);const C=[0,0,-1,1];a.ao(C,C,this._invViewProjMatrix),this._cameraPosition=[C[0]/C[3],C[1]/C[3],C[2]/C[3]],this._fogMatrix=new Float64Array(16),a.aX(this._fogMatrix,this.fovInRadians,this.width/this.height,T,this._helper._farZ),this._fogMatrix[8]=2*-n.x/this.width,this._fogMatrix[9]=2*n.y/this.height,a.M(this._fogMatrix,this._fogMatrix,[1,-1,1]),a.L(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),a.aZ(this._fogMatrix,this._fogMatrix,-this.rollInRadians),a.a_(this._fogMatrix,this._fogMatrix,this.pitchInRadians),a.aZ(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),a.L(this._fogMatrix,this._fogMatrix,[-p,-g,0]),a.M(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),a.L(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=a.N(new Float64Array(16),this.clipSpaceToPixelsMatrix,A);const R=this._helper._width%2/2,L=this._helper._height%2/2,N=Math.cos(this.bearingInRadians),z=Math.sin(-this.bearingInRadians),H=p-Math.round(p)+N*R+z*L,q=g-Math.round(g)+N*L+z*R,se=new Float64Array(A);if(a.L(se,se,[H>.5?H-1:H,q>.5?q-1:q,0]),this._alignedProjMatrix=se,A=a.ai(new Float64Array(16),this._pixelMatrix),!A)throw new Error("failed to invert matrix");this._pixelMatrixInverse=A,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const n=this.screenPointToMercatorCoordinate(new a.P(0,0)),l=[n.x*this.worldSize,n.y*this.worldSize,0,1];return a.ao(l,l,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const n=a.aJ(1,this.center.lat)*this.worldSize;return Lc(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/n).toLngLat()}lngLatToCameraDepth(n,l){const p=a.$.fromLngLat(n),g=[p.x*this.worldSize,p.y*this.worldSize,l,1];return a.ao(g,g,this._viewProjMatrix),g[2]/g[3]}getProjectionData(n){const{overscaledTileID:l,aligned:p,applyTerrainMatrix:g}=n,x=this._helper.getMercatorTileCoordinates(l),T=l?this.calculatePosMatrix(l,p,!0):null;let A;return A=l&&l.terrainRttPosMatrix32f&&g?l.terrainRttPosMatrix32f:T||a.a$(),{mainMatrix:A,tileMercatorCoords:x,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:A}}isLocationOccluded(n){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(n,l,p){return 1}transformLightDirection(n){return a.aP(n)}getRayDirectionFromPixel(n){throw new Error("Not implemented.")}projectTileCoordinates(n,l,p,g){const x=this.calculatePosMatrix(p);let T;g?(T=[n,l,g(n,l),1],a.ao(T,T,x)):(T=[n,l,0,1],qi(T,T,x));const A=T[3];return{point:new a.P(T[0]/A,T[1]/A),signedDistanceFromCamera:A,isOccluded:!1}}populateCache(n){for(const l of n)this.calculatePosMatrix(l)}getMatrixForModel(n,l){const p=a.$.fromLngLat(n,l),g=p.meterInMercatorCoordinateUnits(),x=a.b0();return a.L(x,x,[p.x,p.y,p.z]),a.aZ(x,x,Math.PI),a.a_(x,x,Math.PI/2),a.M(x,x,[-g,g,g]),x}getProjectionDataForCustomLayer(n=!0){const l=new a.Y(0,0,0,0,0),p=this.getProjectionData({overscaledTileID:l,applyGlobeMatrix:n}),g=ki(l,this.worldSize);a.N(g,this._viewProjMatrix,g),p.tileMercatorCoords=[0,0,1,1];const x=[a.Z,a.Z,this.worldSize/this._helper.pixelsPerMeter],T=a.b1();return a.M(T,g,x),p.fallbackMatrix=T,p.mainMatrix=T,p}getFastPathSimpleProjectionMatrix(n){return this.calculatePosMatrix(n)}}function Ko(){a.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function Yr(_){if(_.useSlerp)if(_.k<1){const n=a.b2(_.startEulerAngles.roll,_.startEulerAngles.pitch,_.startEulerAngles.bearing),l=a.b2(_.endEulerAngles.roll,_.endEulerAngles.pitch,_.endEulerAngles.bearing),p=new Float64Array(4);a.b3(p,n,l,_.k);const g=a.b4(p);_.tr.setRoll(g.roll),_.tr.setPitch(g.pitch),_.tr.setBearing(g.bearing)}else _.tr.setRoll(_.endEulerAngles.roll),_.tr.setPitch(_.endEulerAngles.pitch),_.tr.setBearing(_.endEulerAngles.bearing);else _.tr.setRoll(a.B.number(_.startEulerAngles.roll,_.endEulerAngles.roll,_.k)),_.tr.setPitch(a.B.number(_.startEulerAngles.pitch,_.endEulerAngles.pitch,_.k)),_.tr.setBearing(a.B.number(_.startEulerAngles.bearing,_.endEulerAngles.bearing,_.k))}function Fc(_,n,l,p,g){const x=g.padding,T=Xr(g.worldSize,l.getNorthWest()),A=Xr(g.worldSize,l.getNorthEast()),C=Xr(g.worldSize,l.getSouthEast()),R=Xr(g.worldSize,l.getSouthWest()),L=a.ac(-p),N=T.rotate(L),z=A.rotate(L),H=C.rotate(L),q=R.rotate(L),se=new a.P(Math.max(N.x,z.x,q.x,H.x),Math.max(N.y,z.y,q.y,H.y)),ne=new a.P(Math.min(N.x,z.x,q.x,H.x),Math.min(N.y,z.y,q.y,H.y)),le=se.sub(ne),he=(g.width-(x.left+x.right+n.left+n.right))/le.x,xe=(g.height-(x.top+x.bottom+n.top+n.bottom))/le.y;if(xe<0||he<0)return void Ko();const ve=Math.min(a.aa(g.scale*Math.min(he,xe)),_.maxZoom),Pe=a.P.convert(_.offset),Re=new a.P((n.left-n.right)/2,(n.top-n.bottom)/2).rotate(a.ac(p)),Ie=Pe.add(Re).mult(g.scale/a.aH(ve));return{center:dr(g.worldSize,T.add(C).div(2).sub(Ie)),zoom:ve,bearing:p}}class cn{get useGlobeControls(){return!1}handlePanInertia(n,l){return{easingOffset:n,easingCenter:l.center}}handleMapControlsRollPitchBearingZoom(n,l){n.bearingDelta&&l.setBearing(l.bearing+n.bearingDelta),n.pitchDelta&&l.setPitch(l.pitch+n.pitchDelta),n.rollDelta&&l.setRoll(l.roll+n.rollDelta),n.zoomDelta&&l.setZoom(l.zoom+n.zoomDelta)}handleMapControlsPan(n,l,p){n.around.distSqr(l.centerPoint)<.01||l.setLocationAtPoint(p,n.around)}cameraForBoxAndBearing(n,l,p,g,x){return Fc(n,l,p,g,x)}handleJumpToCenterZoom(n,l){n.zoom!==(l.zoom!==void 0?+l.zoom:n.zoom)&&n.setZoom(+l.zoom),l.center!==void 0&&n.setCenter(a.Q.convert(l.center))}handleEaseTo(n,l){const p=n.zoom,g=n.padding,x={roll:n.roll,pitch:n.pitch,bearing:n.bearing},T={roll:l.roll===void 0?n.roll:l.roll,pitch:l.pitch===void 0?n.pitch:l.pitch,bearing:l.bearing===void 0?n.bearing:l.bearing},A=l.zoom!==void 0,C=!n.isPaddingEqual(l.padding);let R=!1;const L=A?+l.zoom:n.zoom;let N=n.centerPoint.add(l.offsetAsPoint);const z=n.screenPointToLocation(N),{center:H,zoom:q}=n.getConstrained(a.Q.convert(l.center||z),L??p);Ar(n,H);const se=Xr(n.worldSize,z),ne=Xr(n.worldSize,H).sub(se),le=a.aH(q-p);return R=q!==p,{easeFunc:he=>{if(R&&n.setZoom(a.B.number(p,q,he)),a.b5(x,T)||Yr({startEulerAngles:x,endEulerAngles:T,tr:n,k:he,useSlerp:x.roll!=T.roll}),C&&(n.interpolatePadding(g,l.padding,he),N=n.centerPoint.add(l.offsetAsPoint)),l.around)n.setLocationAtPoint(l.around,l.aroundPoint);else{const xe=a.aH(n.zoom-p),ve=q>p?Math.min(2,le):Math.max(.5,le),Pe=Math.pow(ve,1-he),Re=dr(n.worldSize,se.add(ne.mult(he*Pe)).mult(xe));n.setLocationAtPoint(n.renderWorldCopies?Re.wrap():Re,N)}},isZooming:R,elevationCenter:H}}handleFlyTo(n,l){const p=l.zoom!==void 0,g=n.zoom,x=n.getConstrained(a.Q.convert(l.center||l.locationAtOffset),p?+l.zoom:g),T=x.center,A=x.zoom;Ar(n,T);const C=Xr(n.worldSize,l.locationAtOffset),R=Xr(n.worldSize,T).sub(C),L=R.mag(),N=a.aH(A-g);let z;if(l.minZoom!==void 0){const H=Math.min(+l.minZoom,g,A),q=n.getConstrained(T,H).zoom;z=a.aH(q-g)}return{easeFunc:(H,q,se,ne)=>{n.setZoom(H===1?A:g+a.aa(q));const le=H===1?T:dr(n.worldSize,C.add(R.mult(se)).mult(q));n.setLocationAtPoint(n.renderWorldCopies?le.wrap():le,ne)},scaleOfZoom:N,targetCenter:T,scaleOfMinZoom:z,pixelPathLength:L}}}class Pi{constructor(n,l,p){this.blendFunction=n,this.blendColor=l,this.mask=p}}Pi.Replace=[1,0],Pi.disabled=new Pi(Pi.Replace,a.b6.transparent,[!1,!1,!1,!1]),Pi.unblended=new Pi(Pi.Replace,a.b6.transparent,[!0,!0,!0,!0]),Pi.alphaBlended=new Pi([1,771],a.b6.transparent,[!0,!0,!0,!0]);const Ga=2305;class Qt{constructor(n,l,p){this.enable=n,this.mode=l,this.frontFace=p}}Qt.disabled=new Qt(!1,1029,Ga),Qt.backCCW=new Qt(!0,1029,Ga),Qt.frontCCW=new Qt(!0,1028,Ga);class $t{constructor(n,l,p){this.func=n,this.mask=l,this.range=p}}$t.ReadOnly=!1,$t.ReadWrite=!0,$t.disabled=new $t(519,$t.ReadOnly,[0,1]);const fo=7680;class ti{constructor(n,l,p,g,x,T){this.test=n,this.ref=l,this.mask=p,this.fail=g,this.depthFail=x,this.pass=T}}ti.disabled=new ti({func:519,mask:0},0,0,fo,fo,fo);const Jo=new WeakMap;function Kr(_){var n;if(Jo.has(_))return Jo.get(_);{const l=(n=_.getParameter(_.VERSION))===null||n===void 0?void 0:n.startsWith("WebGL 2.0");return Jo.set(_,l),l}}class Qo{get awaitingQuery(){return!!this._readbackQueue}constructor(n){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=n;const l=n.context,p=l.gl;this._texFormat=p.RGBA,this._texType=p.UNSIGNED_BYTE;const g=new a.aE;g.emplaceBack(-1,-1),g.emplaceBack(2,-1),g.emplaceBack(-1,2);const x=new a.aG;x.emplaceBack(0,1,2),this._fullscreenTriangle=new zr(l.createVertexBuffer(g,qr.members),l.createIndexBuffer(x),a.aF.simpleSegment(0,0,g.length,x.length)),this._resultBuffer=new Uint8Array(4),l.activeTexture.set(p.TEXTURE1);const T=p.createTexture();p.bindTexture(p.TEXTURE_2D,T),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texImage2D(p.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=l.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(T),Kr(p)&&(this._pbo=p.createBuffer(),p.bindBuffer(p.PIXEL_PACK_BUFFER,this._pbo),p.bufferData(p.PIXEL_PACK_BUFFER,4,p.STREAM_READ),p.bindBuffer(p.PIXEL_PACK_BUFFER,null))}destroy(){const n=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),n.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(n,l){const p=this._updateCount;return this._readbackQueue?p>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():p>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(n,l),this._updateCount++,this._measuredError}_bindFramebuffer(){const n=this._cachedRenderContext.context,l=n.gl;n.activeTexture.set(l.TEXTURE1),l.bindTexture(l.TEXTURE_2D,this._fbo.colorAttachment.get()),n.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(n,l){const p=this._cachedRenderContext.context,g=p.gl;if(this._bindFramebuffer(),p.viewport.set([0,0,this._texWidth,this._texHeight]),p.clear({color:a.b6.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw(p,g.TRIANGLES,$t.disabled,ti.disabled,Pi.unblended,Qt.disabled,((x,T)=>({u_input:x,u_output_expected:T}))(n,l),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&Kr(g)){g.bindBuffer(g.PIXEL_PACK_BUFFER,this._pbo),g.readBuffer(g.COLOR_ATTACHMENT0),g.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),g.bindBuffer(g.PIXEL_PACK_BUFFER,null);const x=g.fenceSync(g.SYNC_GPU_COMMANDS_COMPLETE,0);g.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:x}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const n=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&Kr(n)){const l=n.clientWaitSync(this._readbackQueue.sync,0,0);if(l===n.WAIT_FAILED)return a.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(l===n.TIMEOUT_EXPIRED)return;n.bindBuffer(n.PIXEL_PACK_BUFFER,this._pbo),n.getBufferSubData(n.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),n.bindBuffer(n.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),n.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=Qo._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(n){let l=0;return l+=n[0]/256,l+=n[1]/65536,l+=n[2]/16777216,n[3]<127&&(l=-l),l/128}}const Ya=a.Z/128;function ea(_,n){const l=_.granularity!==void 0?Math.max(_.granularity,1):1,p=l+(_.generateBorders?2:0),g=l+(_.extendToNorthPole||_.generateBorders?1:0)+(_.extendToSouthPole||_.generateBorders?1:0),x=p+1,T=g+1,A=_.generateBorders?-1:0,C=_.generateBorders||_.extendToNorthPole?-1:0,R=l+(_.generateBorders?1:0),L=l+(_.generateBorders||_.extendToSouthPole?1:0),N=x*T,z=p*g*6,H=x*T>65536;if(H&&n==="16bit")throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const q=H||n==="32bit",se=new Int16Array(2*N);let ne=0;for(let xe=C;xe<=L;xe++)for(let ve=A;ve<=R;ve++){let Pe=ve/l*a.Z;ve===-1&&(Pe=-64),ve===l+1&&(Pe=a.Z+Ya);let Re=xe/l*a.Z;xe===-1&&(Re=_.extendToNorthPole?a.b8:-64),xe===l+1&&(Re=_.extendToSouthPole?a.b9:a.Z+Ya),se[ne++]=Pe,se[ne++]=Re}const le=q?new Uint32Array(z):new Uint16Array(z);let he=0;for(let xe=0;xe<g;xe++)for(let ve=0;ve<p;ve++){const Pe=ve+1+xe*x,Re=ve+(xe+1)*x,Ie=ve+1+(xe+1)*x;le[he++]=ve+xe*x,le[he++]=Re,le[he++]=Pe,le[he++]=Pe,le[he++]=Re,le[he++]=Ie}return{vertices:se.buffer.slice(0),indices:le.buffer.slice(0),uses32bitIndices:q}}const po=new a.aD({fill:new a.ba(128,2),line:new a.ba(512,0),tile:new a.ba(128,32),stencil:new a.ba(128,1),circle:3});class go{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return an.projectionGlobe}get vertexShaderPreludeCode(){return an.projectionMercator.vertexSource}get subdivisionGranularity(){return po}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(n){this._errorMeasurement||(this._errorMeasurement=new Qo(n));const l=a.S(this._errorQueryLatitudeDegrees),p=2*Math.atan(Math.exp(Math.PI-l*Math.PI*2))-.5*Math.PI,g=this._errorMeasurement.updateErrorLoop(l,p),x=D.now();g!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=g,this._errorMeasurementLastChangeTime=x);const T=Math.min(Math.max((x-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=a.bb(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,a.bc(T))}_getMeshKey(n){return`${n.granularity.toString(36)}_${n.generateBorders?"b":""}${n.extendToNorthPole?"n":""}${n.extendToSouthPole?"s":""}`}getMeshFromTileID(n,l,p,g,x){const T=(x==="stencil"?po.stencil:po.tile).getGranularityForZoomLevel(l.z);return this._getMesh(n,{granularity:T,generateBorders:p,extendToNorthPole:l.y===0&&g,extendToSouthPole:l.y===(1<<l.z)-1&&g})}_getMesh(n,l){const p=this._getMeshKey(l);if(p in this._tileMeshCache)return this._tileMeshCache[p];const g=(function(x,T){const A=ea(T,"16bit"),C=a.aE.deserialize({arrayBuffer:A.vertices,length:A.vertices.byteLength/2/2}),R=a.aG.deserialize({arrayBuffer:A.indices,length:A.indices.byteLength/2/3});return new zr(x.createVertexBuffer(C,qr.members),x.createIndexBuffer(R),a.aF.simpleSegment(0,0,C.length,R.length))})(n,l);return this._tileMeshCache[p]=g,g}recalculate(n){}hasTransition(){const n=D.now();let l=!1;return l=l||(n-this._errorMeasurementLastChangeTime)/1e3<.7,l=l||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,l}setErrorQueryLatitudeDegrees(n){this._errorQueryLatitudeDegrees=n}}const Ep=new a.r({type:new a.D(a.v.projection.type)});class Ka extends a.E{constructor(n){super(),this._transitionable=new a.T(Ep),this.setProjection(n),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new a.C(0)),this._mercatorProjection=new Oc,this._verticalPerspectiveProjection=new go}get transitionState(){const n=this.properties.get("type");if(typeof n=="string"&&n==="mercator")return 0;if(typeof n=="string"&&n==="vertical-perspective")return 1;if(n instanceof a.bd){if(n.from==="vertical-perspective"&&n.to==="mercator")return 1-n.transition;if(n.from==="mercator"&&n.to==="vertical-perspective")return n.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(n){this._mercatorProjection.updateGPUdependent(n),this._verticalPerspectiveProjection.updateGPUdependent(n)}getMeshFromTileID(n,l,p,g,x){return this.currentProjection.getMeshFromTileID(n,l,p,g,x)}setProjection(n){this._transitionable.setValue("type",n?.type||"mercator")}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}setErrorQueryLatitudeDegrees(n){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(n),this._mercatorProjection.setErrorQueryLatitudeDegrees(n)}}function Bc(_){const n=br(_.worldSize,_.center.lat);return 2*Math.PI*n}function ta(_,n,l,p,g){const x=1/(1<<g),T=n/a.Z*x+p*x,A=a.bf((_/a.Z*x+l*x)*Math.PI*2+Math.PI,2*Math.PI),C=2*Math.atan(Math.exp(Math.PI-T*Math.PI*2))-.5*Math.PI,R=Math.cos(C),L=new Float64Array(3);return L[0]=Math.sin(A)*R,L[1]=Math.sin(C),L[2]=Math.cos(A)*R,L}function vr(_){return(function(n,l){const p=Math.cos(l),g=new Float64Array(3);return g[0]=Math.sin(n)*p,g[1]=Math.sin(l),g[2]=Math.cos(n)*p,g})(_.lng*Math.PI/180,_.lat*Math.PI/180)}function br(_,n){return _/(2*Math.PI)/Math.cos(n*Math.PI/180)}function Ja(_){const n=Math.asin(_[1])/Math.PI*180,l=Math.sqrt(_[0]*_[0]+_[2]*_[2]);if(l>1e-6){const p=_[0]/l,g=Math.acos(_[2]/l),x=(p>0?g:-g)/Math.PI*180;return new a.Q(a.aK(x,-180,180),n)}return new a.Q(0,n)}function Ur(_){return Math.cos(_*Math.PI/180)}function Ni(_,n){const l=Ur(_),p=Ur(n);return a.aa(p/l)}function Nc(_,n){const l=_.rotate(n.bearingInRadians),p=n.zoom+Ni(n.center.lat,0),g=a.bb(1/Ur(n.center.lat),1/Ur(Math.min(Math.abs(n.center.lat),60)),a.be(p,7,3,0,1)),x=360/Bc({worldSize:n.worldSize,center:{lat:n.center.lat}});return new a.Q(n.center.lng-l.x*x*g,a.ad(n.center.lat+l.y*x,-85.051129,a.aI))}function Qa(_){const n=.5*_,l=Math.sin(n),p=Math.cos(n);return Math.log(l+p)-Math.log(p-l)}function ks(_,n,l,p){const g=_.lat+l*p;if(Math.abs(l)>1){const x=(Math.sign(_.lat+l)!==Math.sign(_.lat)?-Math.abs(_.lat):Math.abs(_.lat))*Math.PI/180,T=Math.abs(_.lat+l)*Math.PI/180,A=Qa(x+p*(T-x)),C=Qa(x),R=Qa(T);return new a.Q(_.lng+n*((A-C)/(R-C)),g)}return new a.Q(_.lng+n*p,g)}class Ap{constructor(n){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._aabbFactory=n}recalculateCache(){if(!this._hadAnyChanges)return;const n=this._cachePrevious;this._cachePrevious=this._cache,this._cache=n,this._cache.clear(),this._hadAnyChanges=!1}getTileAABB(n,l,p,g){const x=`${n.z}_${n.x}_${n.y}`,T=this._cache.get(x);if(T)return T;const A=this._cachePrevious.get(x);if(A)return this._cache.set(x,A),A;const C=this._aabbFactory(n,l,p,g);return this._cache.set(x,C),this._hadAnyChanges=!0,C}}function el(_,n,l){const p=_-n;return p<0?-p:Math.max(0,p-l)}function zc(_,n,l,p,g){const x=_-l;let T;return T=x<0?Math.min(-x,1+x-g):x>1?Math.min(Math.max(x-g,0),1-x):0,Math.max(T,el(n,p,g))}class Pp{constructor(){this._aabbCache=new Ap(this._computeTileAABB)}recalculateCache(){this._aabbCache.recalculateCache()}distanceToTile2d(n,l,p,g){const x=1<<p.z,T=1/x,A=p.x/x,C=p.y/x;let R=2;return R=Math.min(R,zc(n,l,A,C,T)),R=Math.min(R,zc(n,l,A+.5,-C-T,T)),R=Math.min(R,zc(n,l,A+.5,2-C-T,T)),R}getWrap(n,l,p){const g=1<<l.z,x=1/g,T=l.x/g,A=el(n.x,T,x),C=el(n.x,T-1,x),R=el(n.x,T+1,x),L=Math.min(A,C,R);return L===R?1:L===C?-1:0}allowVariableZoom(n,l){return Un(n,l)>4}allowWorldCopies(){return!1}getTileAABB(n,l,p,g){return this._aabbCache.getTileAABB(n,l,p,g)}_computeTileAABB(n,l,p,g){if(n.z<=0)return new ln([-1,-1,-1],[1,1,1]);if(n.z===1)return new ln([n.x===0?-1:0,n.y===0?0:-1,-1],[n.x===0?0:1,n.y===0?1:0,1]);{const x=[ta(0,0,n.x,n.y,n.z),ta(a.Z,0,n.x,n.y,n.z),ta(a.Z,a.Z,n.x,n.y,n.z),ta(0,a.Z,n.x,n.y,n.z)],T=[1,1,1],A=[-1,-1,-1];for(const C of x)for(let R=0;R<3;R++)T[R]=Math.min(T[R],C[R]),A[R]=Math.max(A[R],C[R]);if(n.y===0||n.y===(1<<n.z)-1){const C=[0,n.y===0?1:-1,0];for(let R=0;R<3;R++)T[R]=Math.min(T[R],C[R]),A[R]=Math.max(A[R],C[R])}return new ln(T,A)}}}class tl{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(n){this._helper.setMinZoom(n)}setMaxZoom(n){this._helper.setMaxZoom(n)}setMinPitch(n){this._helper.setMinPitch(n)}setMaxPitch(n){this._helper.setMaxPitch(n)}setRenderWorldCopies(n){this._helper.setRenderWorldCopies(n)}setBearing(n){this._helper.setBearing(n)}setPitch(n){this._helper.setPitch(n)}setRoll(n){this._helper.setRoll(n)}setFov(n){this._helper.setFov(n)}setZoom(n){this._helper.setZoom(n)}setCenter(n){this._helper.setCenter(n)}setElevation(n){this._helper.setElevation(n)}setMinElevationForCurrentTile(n){this._helper.setMinElevationForCurrentTile(n)}setPadding(n){this._helper.setPadding(n)}interpolatePadding(n,l,p){return this._helper.interpolatePadding(n,l,p)}isPaddingEqual(n){return this._helper.isPaddingEqual(n)}resize(n,l){this._helper.resize(n,l)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(n){this._helper.setMaxBounds(n)}overrideNearFarZ(n,l){this._helper.overrideNearFarZ(n,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(n){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),n)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(n){}constructor(){this._cachedClippingPlane=a.bg(),this._projectionMatrix=a.b0(),this._globeViewProjMatrix32f=a.a$(),this._globeViewProjMatrixNoCorrection=a.b0(),this._globeViewProjMatrixNoCorrectionInverted=a.b0(),this._globeProjMatrixInverted=a.b0(),this._cameraPosition=a.bh(),this._globeLatitudeErrorCorrectionRadians=0,this._helper=new Xa({calcMatrices:()=>{this._calcMatrices()},getConstrained:(n,l)=>this.getConstrained(n,l)}),this._coveringTilesDetailsProvider=new Pp}clone(){const n=new tl;return n.apply(this),n}apply(n,l){this._globeLatitudeErrorCorrectionRadians=l||0,this._helper.apply(n)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const n=a.bh();return n[0]=this._cameraPosition[0],n[1]=this._cameraPosition[1],n[2]=this._cameraPosition[2],n}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(n){const{overscaledTileID:l,applyGlobeMatrix:p}=n,g=this._helper.getMercatorTileCoordinates(l);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:g,clippingPlane:this._cachedClippingPlane,projectionTransition:p?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(n){const l=this.pitchInRadians,p=this.cameraToCenterDistance/n,g=Math.sin(l)*p,x=Math.cos(l)*p+1,T=1/Math.sqrt(g*g+x*x)*1;let A=-g,C=x;const R=Math.sqrt(A*A+C*C);A/=R,C/=R;const L=[0,A,C];return a.bi(L,L,[0,0,0],-this.bearingInRadians),a.bj(L,L,[0,0,0],-1*this.center.lat*Math.PI/180),a.bk(L,L,[0,0,0],this.center.lng*Math.PI/180),a.aN(L,L,.25),[...L,.25*-T]}isLocationOccluded(n){return!this.isSurfacePointVisible(vr(n))}transformLightDirection(n){const l=this._helper._center.lng*Math.PI/180,p=this._helper._center.lat*Math.PI/180,g=Math.cos(p),x=[Math.sin(l)*g,Math.sin(p),Math.cos(l)*g],T=[x[2],0,-x[0]],A=[0,0,0];a.aT(A,T,x),a.aS(T,T),a.aS(A,A);const C=[0,0,0];return a.aS(C,[T[0]*n[0]+A[0]*n[1]+x[0]*n[2],T[1]*n[0]+A[1]*n[1]+x[1]*n[2],T[2]*n[0]+A[2]*n[1]+x[2]*n[2]]),C}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(n,l,p){const g=(function(A,C,R){const L=1/(1<<R.z);return new a.$(A/a.Z*L+R.x*L,C/a.Z*L+R.y*L)})(n,l,p.canonical),x=(T=g.y,[a.bf(g.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-T*Math.PI*2))-.5*Math.PI]);var T;return this.getCircleRadiusCorrection()/Math.cos(x[1])}projectTileCoordinates(n,l,p,g){const x=p.canonical,T=ta(n,l,x.x,x.y,x.z),A=1+(g?g(n,l):0)/a.bq,C=[T[0]*A,T[1]*A,T[2]*A,1];a.ao(C,C,this._globeViewProjMatrixNoCorrection);const R=this._cachedClippingPlane,L=R[0]*T[0]+R[1]*T[1]+R[2]*T[2]+R[3]<0;return{point:new a.P(C[0]/C[3],C[1]/C[3]),signedDistanceFromCamera:C[3],isOccluded:L}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const n=br(this.worldSize,this.center.lat),l=a.b1(),p=a.b1();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*n),a.aX(l,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const g=this.centerOffset;l[8]=2*-g.x/this._helper._width,l[9]=2*g.y/this._helper._height,this._projectionMatrix=a.aY(l),this._globeProjMatrixInverted=a.b1(),a.ai(this._globeProjMatrixInverted,l),a.L(l,l,[0,0,-this.cameraToCenterDistance]),a.aZ(l,l,this.rollInRadians),a.a_(l,l,-this.pitchInRadians),a.aZ(l,l,this.bearingInRadians),a.L(l,l,[0,0,-n]);const x=a.bh();x[0]=n,x[1]=n,x[2]=n,a.a_(p,l,this.center.lat*Math.PI/180),a.bl(p,p,-this.center.lng*Math.PI/180),a.M(p,p,x),this._globeViewProjMatrixNoCorrection=p,a.a_(l,l,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),a.bl(l,l,-this.center.lng*Math.PI/180),a.M(l,l,x),this._globeViewProjMatrix32f=new Float32Array(l),this._globeViewProjMatrixNoCorrectionInverted=a.b1(),a.ai(this._globeViewProjMatrixNoCorrectionInverted,p);const T=a.bh();this._cameraPosition=a.bh(),this._cameraPosition[2]=this.cameraToCenterDistance/n,a.bi(this._cameraPosition,this._cameraPosition,T,-this.rollInRadians),a.bj(this._cameraPosition,this._cameraPosition,T,this.pitchInRadians),a.bi(this._cameraPosition,this._cameraPosition,T,-this.bearingInRadians),a.aO(this._cameraPosition,this._cameraPosition,[0,0,1]),a.bj(this._cameraPosition,this._cameraPosition,T,-this.center.lat*Math.PI/180),a.bk(this._cameraPosition,this._cameraPosition,T,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(n);const A=a.aY(this._globeViewProjMatrixNoCorrectionInverted);a.M(A,A,[1,1,-1]),this._cachedFrustum=ls.fromInvProjectionMatrix(A)}calculateFogMatrix(n){a.w("calculateFogMatrix is not supported on globe projection.");const l=a.b1();return a.as(l),l}getVisibleUnwrappedCoordinates(n){return[new a.aV(0,n)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(n){n&&a.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(n,l){if(!this._globeViewProjMatrixNoCorrection)return 1;const p=vr(n);a.aN(p,p,1+l/a.bq);const g=a.bg();return a.ao(g,[p[0],p[1],p[2],1],this._globeViewProjMatrixNoCorrection),g[2]/g[3]}populateCache(n){}getBounds(){const n=.5*this.width,l=.5*this.height,p=[new a.P(0,0),new a.P(n,0),new a.P(this.width,0),new a.P(this.width,l),new a.P(this.width,this.height),new a.P(n,this.height),new a.P(0,this.height),new a.P(0,l)],g=[];for(const N of p)g.push(this.unprojectScreenPoint(N));let x=0,T=0,A=0,C=0;const R=this.center;for(const N of g){const z=a.bm(R.lng,N.lng),H=a.bm(R.lat,N.lat);z<T&&(T=z),z>x&&(x=z),H<C&&(C=H),H>A&&(A=H)}const L=[R.lng+T,R.lat+C,R.lng+x,R.lat+A];return this.isSurfacePointOnScreen([0,1,0])&&(L[3]=90,L[0]=-180,L[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(L[1]=-90,L[0]=-180,L[2]=180),new Yt(L)}getConstrained(n,l){const p=a.ad(n.lat,-85.051129,a.aI),g=a.ad(+l,this.minZoom+Ni(0,p),this.maxZoom);return{center:new a.Q(n.lng,p),zoom:g}}calculateCenterFromCameraLngLatAlt(n,l,p,g){return this._helper.calculateCenterFromCameraLngLatAlt(n,l,p,g)}setLocationAtPoint(n,l){const p=vr(this.unprojectScreenPoint(l)),g=vr(n),x=a.bh();a.bn(x);const T=a.bh();a.bk(T,p,x,-this.center.lng*Math.PI/180),a.bj(T,T,x,this.center.lat*Math.PI/180);const A=g[0]*g[0]+g[2]*g[2],C=T[0]*T[0];if(A<C)return;const R=Math.sqrt(A-C),L=-R,N=a.bo(g[0],g[2],T[0],R),z=a.bo(g[0],g[2],T[0],L),H=a.bh();a.bk(H,g,x,-N);const q=a.bo(H[1],H[2],T[1],T[2]),se=a.bh();a.bk(se,g,x,-z);const ne=a.bo(se[1],se[2],T[1],T[2]),le=.5*Math.PI,he=q>=-le&&q<=le,xe=ne>=-le&&ne<=le;let ve,Pe;if(he&&xe){const He=this.center.lng*Math.PI/180,it=this.center.lat*Math.PI/180;a.br(N,He)+a.br(q,it)<a.br(z,He)+a.br(ne,it)?(ve=N,Pe=q):(ve=z,Pe=ne)}else if(he)ve=N,Pe=q;else{if(!xe)return;ve=z,Pe=ne}const Re=ve/Math.PI*180,Ie=Pe/Math.PI*180,$e=this.center.lat;this.setCenter(new a.Q(Re,a.ad(Ie,-90,90))),this.setZoom(this.zoom+Ni($e,this.center.lat))}locationToScreenPoint(n,l){const p=vr(n);if(l){const g=l.getElevationForLngLatZoom(n,this._helper._tileZoom);a.aN(p,p,1+g/a.bq)}return this._projectSurfacePointToScreen(p)}_projectSurfacePointToScreen(n){const l=a.bg();return a.ao(l,[...n,1],this._globeViewProjMatrixNoCorrection),l[0]/=l[3],l[1]/=l[3],new a.P((.5*l[0]+.5)*this.width,(.5*-l[1]+.5)*this.height)}screenPointToMercatorCoordinate(n,l){if(l){const p=l.pointCoordinate(n);if(p)return p}return a.$.fromLngLat(this.unprojectScreenPoint(n))}screenPointToLocation(n,l){var p;return(p=this.screenPointToMercatorCoordinate(n,l))===null||p===void 0?void 0:p.toLngLat()}isPointOnMapSurface(n,l){const p=this._cameraPosition,g=this.getRayDirectionFromPixel(n);return!!this.rayPlanetIntersection(p,g)}getRayDirectionFromPixel(n){const l=a.bg();l[0]=n.x/this.width*2-1,l[1]=-1*(n.y/this.height*2-1),l[2]=1,l[3]=1,a.ao(l,l,this._globeViewProjMatrixNoCorrectionInverted),l[0]/=l[3],l[1]/=l[3],l[2]/=l[3];const p=a.bh();p[0]=l[0]-this._cameraPosition[0],p[1]=l[1]-this._cameraPosition[1],p[2]=l[2]-this._cameraPosition[2];const g=a.bh();return a.aS(g,p),g}isSurfacePointVisible(n){const l=this._cachedClippingPlane;return l[0]*n[0]+l[1]*n[1]+l[2]*n[2]+l[3]>=0}isSurfacePointOnScreen(n){if(!this.isSurfacePointVisible(n))return!1;const l=a.bg();return a.ao(l,[...n,1],this._globeViewProjMatrixNoCorrection),l[0]/=l[3],l[1]/=l[3],l[2]/=l[3],l[0]>-1&&l[0]<1&&l[1]>-1&&l[1]<1&&l[2]>-1&&l[2]<1}rayPlanetIntersection(n,l){const p=a.aU(n,l),g=a.bh(),x=a.bh();a.aN(x,l,p),a.aR(g,n,x);const T=1-a.aU(g,g);if(T<0)return null;const A=a.aU(n,n)-1,C=-p+(p<0?1:-1)*Math.sqrt(T),R=A/C,L=C;return{tMin:Math.min(R,L),tMax:Math.max(R,L)}}unprojectScreenPoint(n){const l=this._cameraPosition,p=this.getRayDirectionFromPixel(n),g=this.rayPlanetIntersection(l,p);if(g){const R=a.bh();a.aO(R,l,[p[0]*g.tMin,p[1]*g.tMin,p[2]*g.tMin]);const L=a.bh();return a.aS(L,R),Ja(L)}const x=this._cachedClippingPlane[0]*p[0]+this._cachedClippingPlane[1]*p[1]+this._cachedClippingPlane[2]*p[2],T=-a.bp(this._cachedClippingPlane,l)/x,A=a.bh();if(T>0)a.aO(A,l,[p[0]*T,p[1]*T,p[2]*T]);else{const R=a.bh();a.aO(R,l,[2*p[0],2*p[1],2*p[2]]);const L=a.bp(this._cachedClippingPlane,R);a.aR(A,R,[this._cachedClippingPlane[0]*L,this._cachedClippingPlane[1]*L,this._cachedClippingPlane[2]*L])}const C=a.bh();return a.aS(C,A),Ja(C)}getMatrixForModel(n,l){const p=a.Q.convert(n),g=1/a.bq,x=a.b0();return a.bl(x,x,p.lng/180*Math.PI),a.a_(x,x,-p.lat/180*Math.PI),a.L(x,x,[0,0,1+l/a.bq]),a.a_(x,x,.5*Math.PI),a.M(x,x,[g,g,g]),x}getProjectionDataForCustomLayer(n=!0){const l=this.getProjectionData({overscaledTileID:new a.Y(0,0,0,0,0),applyGlobeMatrix:n});return l.tileMercatorCoords=[0,0,1,1],l}getFastPathSimpleProjectionMatrix(n){}}class il{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(n){this._helper.setMinZoom(n)}setMaxZoom(n){this._helper.setMaxZoom(n)}setMinPitch(n){this._helper.setMinPitch(n)}setMaxPitch(n){this._helper.setMaxPitch(n)}setRenderWorldCopies(n){this._helper.setRenderWorldCopies(n)}setBearing(n){this._helper.setBearing(n)}setPitch(n){this._helper.setPitch(n)}setRoll(n){this._helper.setRoll(n)}setFov(n){this._helper.setFov(n)}setZoom(n){this._helper.setZoom(n)}setCenter(n){this._helper.setCenter(n)}setElevation(n){this._helper.setElevation(n)}setMinElevationForCurrentTile(n){this._helper.setMinElevationForCurrentTile(n)}setPadding(n){this._helper.setPadding(n)}interpolatePadding(n,l,p){return this._helper.interpolatePadding(n,l,p)}isPaddingEqual(n){return this._helper.isPaddingEqual(n)}resize(n,l,p=!0){this._helper.resize(n,l,p)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(n){this._helper.setMaxBounds(n)}overrideNearFarZ(n,l){this._helper.overrideNearFarZ(n,l)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(n){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),n)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(n,l){this._globeness=n,this._globeLatitudeErrorCorrectionRadians=l,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().recalculateCache(),this._mercatorTransform.getCoveringTilesDetailsProvider().recalculateCache()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this._helper=new Xa({calcMatrices:()=>{this._calcMatrices()},getConstrained:(n,l)=>this.getConstrained(n,l)}),this._globeness=1,this._mercatorTransform=new Gr,this._verticalPerspectiveTransform=new tl}clone(){const n=new il;return n._globeness=this._globeness,n._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,n.apply(this),n}apply(n){this._helper.apply(n),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(n){const l=this._mercatorTransform.getProjectionData(n),p=this._verticalPerspectiveTransform.getProjectionData(n);return{mainMatrix:this.isGlobeRendering?p.mainMatrix:l.mainMatrix,clippingPlane:p.clippingPlane,tileMercatorCoords:p.tileMercatorCoords,projectionTransition:n.applyGlobeMatrix?this._globeness:0,fallbackMatrix:l.fallbackMatrix}}isLocationOccluded(n){return this.currentTransform.isLocationOccluded(n)}transformLightDirection(n){return this.currentTransform.transformLightDirection(n)}getPixelScale(){return a.bb(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return a.bb(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(n,l,p){const g=this._mercatorTransform.getPitchedTextCorrection(n,l,p),x=this._verticalPerspectiveTransform.getPitchedTextCorrection(n,l,p);return a.bb(g,x,this._globeness)}projectTileCoordinates(n,l,p,g){return this.currentTransform.projectTileCoordinates(n,l,p,g)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(n){return this.currentTransform.calculateFogMatrix(n)}getVisibleUnwrappedCoordinates(n){return this.currentTransform.getVisibleUnwrappedCoordinates(n)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(n){this._mercatorTransform.recalculateZoomAndCenter(n),this._verticalPerspectiveTransform.recalculateZoomAndCenter(n)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(n,l){return this.currentTransform.lngLatToCameraDepth(n,l)}populateCache(n){this._mercatorTransform.populateCache(n),this._verticalPerspectiveTransform.populateCache(n)}getBounds(){return this.currentTransform.getBounds()}getConstrained(n,l){return this.currentTransform.getConstrained(n,l)}calculateCenterFromCameraLngLatAlt(n,l,p,g){return this._helper.calculateCenterFromCameraLngLatAlt(n,l,p,g)}setLocationAtPoint(n,l){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(n,l),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(n,l),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(n,l){return this.currentTransform.locationToScreenPoint(n,l)}screenPointToMercatorCoordinate(n,l){return this.currentTransform.screenPointToMercatorCoordinate(n,l)}screenPointToLocation(n,l){return this.currentTransform.screenPointToLocation(n,l)}isPointOnMapSurface(n,l){return this.currentTransform.isPointOnMapSurface(n,l)}getRayDirectionFromPixel(n){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(n)}getMatrixForModel(n,l){return this.currentTransform.getMatrixForModel(n,l)}getProjectionDataForCustomLayer(n=!0){const l=this._mercatorTransform.getProjectionDataForCustomLayer(n);if(!this.isGlobeRendering)return l;const p=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(n);return p.fallbackMatrix=l.mainMatrix,p}getFastPathSimpleProjectionMatrix(n){return this.currentTransform.getFastPathSimpleProjectionMatrix(n)}}class Mr{get useGlobeControls(){return!0}handlePanInertia(n,l){const p=Nc(n,l);return Math.abs(p.lng-l.center.lng)>180&&(p.lng=l.center.lng+179.5*Math.sign(p.lng-l.center.lng)),{easingCenter:p,easingOffset:new a.P(0,0)}}handleMapControlsRollPitchBearingZoom(n,l){const p=n.around,g=l.screenPointToLocation(p);n.bearingDelta&&l.setBearing(l.bearing+n.bearingDelta),n.pitchDelta&&l.setPitch(l.pitch+n.pitchDelta),n.rollDelta&&l.setRoll(l.roll+n.rollDelta);const x=l.zoom;n.zoomDelta&&l.setZoom(l.zoom+n.zoomDelta);const T=l.zoom-x;if(T===0)return;const A=a.bm(l.center.lng,g.lng),C=A/(Math.abs(A/180)+1),R=a.bm(l.center.lat,g.lat),L=l.getRayDirectionFromPixel(p),N=l.cameraPosition,z=-1*a.aU(N,L),H=a.bh();a.aO(H,N,[L[0]*z,L[1]*z,L[2]*z]);const q=a.bs(H)-1,se=Math.exp(.5*-Math.max(q-.3,0)),ne=br(l.worldSize,l.center.lat)/Math.min(l.width,l.height),le=a.be(ne,.9,.5,1,.25),he=(1-a.aH(-T))*Math.min(se,le),xe=l.center.lat,ve=l.zoom,Pe=new a.Q(l.center.lng+C*he,a.ad(l.center.lat+R*he,-85.051129,a.aI));l.setLocationAtPoint(g,p);const Re=l.center,Ie=a.be(Math.abs(A),45,85,0,1),$e=a.be(ne,.75,.35,0,1),He=Math.pow(Math.max(Ie,$e),.25),it=a.bm(Re.lng,Pe.lng),nt=a.bm(Re.lat,Pe.lat);l.setCenter(new a.Q(Re.lng+it*He,Re.lat+nt*He).wrap()),l.setZoom(ve+Ni(xe,l.center.lat))}handleMapControlsPan(n,l,p){if(!n.panDelta)return;const g=l.center.lat,x=l.zoom;l.setCenter(Nc(n.panDelta,l).wrap()),l.setZoom(x+Ni(g,l.center.lat))}cameraForBoxAndBearing(n,l,p,g,x){const T=Fc(n,l,p,g,x),A=l.left/x.width*2-1,C=(x.width-l.right)/x.width*2-1,R=l.top/x.height*-2+1,L=(x.height-l.bottom)/x.height*-2+1,N=a.bm(p.getWest(),p.getEast())<0,z=N?p.getEast():p.getWest(),H=N?p.getWest():p.getEast(),q=Math.max(p.getNorth(),p.getSouth()),se=Math.min(p.getNorth(),p.getSouth()),ne=z+.5*a.bm(z,H),le=q+.5*a.bm(q,se),he=x.clone();he.setCenter(T.center),he.setBearing(T.bearing),he.setPitch(0),he.setRoll(0),he.setZoom(T.zoom);const xe=he.modelViewProjectionMatrix,ve=[vr(p.getNorthWest()),vr(p.getNorthEast()),vr(p.getSouthWest()),vr(p.getSouthEast()),vr(new a.Q(H,le)),vr(new a.Q(z,le)),vr(new a.Q(ne,q)),vr(new a.Q(ne,se))],Pe=vr(T.center);let Re=Number.POSITIVE_INFINITY;for(const Ie of ve)A<0&&(Re=Mr.getLesserNonNegativeNonNull(Re,Mr.solveVectorScale(Ie,Pe,xe,"x",A))),C>0&&(Re=Mr.getLesserNonNegativeNonNull(Re,Mr.solveVectorScale(Ie,Pe,xe,"x",C))),R>0&&(Re=Mr.getLesserNonNegativeNonNull(Re,Mr.solveVectorScale(Ie,Pe,xe,"y",R))),L<0&&(Re=Mr.getLesserNonNegativeNonNull(Re,Mr.solveVectorScale(Ie,Pe,xe,"y",L)));if(Number.isFinite(Re)&&Re!==0)return T.zoom=he.zoom+a.aa(Re),T;Ko()}handleJumpToCenterZoom(n,l){const p=n.center.lat,g=n.getConstrained(l.center?a.Q.convert(l.center):n.center,n.zoom).center;n.setCenter(g.wrap());const x=l.zoom!==void 0?+l.zoom:n.zoom+Ni(p,g.lat);n.zoom!==x&&n.setZoom(x)}handleEaseTo(n,l){const p=n.zoom,g=n.center,x=n.padding,T={roll:n.roll,pitch:n.pitch,bearing:n.bearing},A={roll:l.roll===void 0?n.roll:l.roll,pitch:l.pitch===void 0?n.pitch:l.pitch,bearing:l.bearing===void 0?n.bearing:l.bearing},C=l.zoom!==void 0,R=!n.isPaddingEqual(l.padding);let L=!1;const N=l.center?a.Q.convert(l.center):g,z=n.getConstrained(N,p).center;Ar(n,z);const H=n.clone();H.setCenter(z),H.setZoom(C?+l.zoom:p+Ni(g.lat,N.lat)),H.setBearing(l.bearing);const q=new a.P(a.ad(n.centerPoint.x+l.offsetAsPoint.x,0,n.width),a.ad(n.centerPoint.y+l.offsetAsPoint.y,0,n.height));H.setLocationAtPoint(z,q);const se=(l.offset&&l.offsetAsPoint.mag())>0?H.center:z,ne=C?+l.zoom:p+Ni(g.lat,se.lat),le=p+Ni(g.lat,0),he=ne+Ni(se.lat,0),xe=a.bm(g.lng,se.lng),ve=a.bm(g.lat,se.lat),Pe=a.aH(he-le);return L=ne!==p,{easeFunc:Re=>{if(a.b5(T,A)||Yr({startEulerAngles:T,endEulerAngles:A,tr:n,k:Re,useSlerp:T.roll!=A.roll}),R&&n.interpolatePadding(x,l.padding,Re),l.around)a.w("Easing around a point is not supported under globe projection."),n.setLocationAtPoint(l.around,l.aroundPoint);else{const Ie=he>le?Math.min(2,Pe):Math.max(.5,Pe),$e=Math.pow(Ie,1-Re),He=ks(g,xe,ve,Re*$e);n.setCenter(He.wrap())}if(L){const Ie=a.B.number(le,he,Re)+Ni(0,n.center.lat);n.setZoom(Ie)}},isZooming:L,elevationCenter:se}}handleFlyTo(n,l){const p=l.zoom!==void 0,g=n.center,x=n.zoom,T=n.padding,A=!n.isPaddingEqual(l.padding),C=n.getConstrained(a.Q.convert(l.center||l.locationAtOffset),x).center,R=p?+l.zoom:n.zoom+Ni(n.center.lat,C.lat),L=n.clone();L.setCenter(C),L.setZoom(R),L.setBearing(l.bearing);const N=new a.P(a.ad(n.centerPoint.x+l.offsetAsPoint.x,0,n.width),a.ad(n.centerPoint.y+l.offsetAsPoint.y,0,n.height));L.setLocationAtPoint(C,N);const z=L.center;Ar(n,z);const H=(function(ve,Pe,Re){const Ie=vr(Pe),$e=vr(Re),He=a.aU(Ie,$e),it=Math.acos(He),nt=Bc(ve);return it/(2*Math.PI)*nt})(n,g,z),q=x+Ni(g.lat,0),se=R+Ni(z.lat,0),ne=a.aH(se-q);let le;if(typeof l.minZoom=="number"){const ve=+l.minZoom+Ni(z.lat,0),Pe=Math.min(ve,q,se)+Ni(0,z.lat),Re=n.getConstrained(z,Pe).zoom+Ni(z.lat,0);le=a.aH(Re-q)}const he=a.bm(g.lng,z.lng),xe=a.bm(g.lat,z.lat);return{easeFunc:(ve,Pe,Re,Ie)=>{const $e=ks(g,he,xe,Re);A&&n.interpolatePadding(T,l.padding,ve);const He=ve===1?z:$e;n.setCenter(He.wrap());const it=q+a.aa(Pe);n.setZoom(ve===1?R:it+Ni(0,He.lat))},scaleOfZoom:ne,targetCenter:z,scaleOfMinZoom:le,pixelPathLength:H}}static solveVectorScale(n,l,p,g,x){const T=g==="x"?[p[0],p[4],p[8],p[12]]:[p[1],p[5],p[9],p[13]],A=[p[3],p[7],p[11],p[15]],C=n[0]*T[0]+n[1]*T[1]+n[2]*T[2],R=n[0]*A[0]+n[1]*A[1]+n[2]*A[2],L=l[0]*T[0]+l[1]*T[1]+l[2]*T[2],N=l[0]*A[0]+l[1]*A[1]+l[2]*A[2];return L+x*R===C+x*N||A[3]*(C-L)+T[3]*(N-R)+C*N==L*R?null:(L+T[3]-x*N-x*A[3])/(L-C-x*N+x*R)}static getLesserNonNegativeNonNull(n,l){return l!==null&&l>=0&&l<n?l:n}}class rl{constructor(n){this._globe=n,this._mercatorCameraHelper=new cn,this._verticalPerspectiveCameraHelper=new Mr}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(n,l){return this.currentHelper.handlePanInertia(n,l)}handleMapControlsRollPitchBearingZoom(n,l){return this.currentHelper.handleMapControlsRollPitchBearingZoom(n,l)}handleMapControlsPan(n,l,p){this.currentHelper.handleMapControlsPan(n,l,p)}cameraForBoxAndBearing(n,l,p,g,x){return this.currentHelper.cameraForBoxAndBearing(n,l,p,g,x)}handleJumpToCenterZoom(n,l){this.currentHelper.handleJumpToCenterZoom(n,l)}handleEaseTo(n,l){return this.currentHelper.handleEaseTo(n,l)}handleFlyTo(n,l){return this.currentHelper.handleFlyTo(n,l)}}const Ds=(_,n)=>a.x(_,n&&n.filter((l=>l.identifier!=="source.canvas"))),Uc=a.bt();class ia extends a.E{constructor(n,l={}){super(),this._rtlPluginLoaded=()=>{for(const p in this.sourceCaches){const g=this.sourceCaches[p].getSource().type;g!=="vector"&&g!=="geojson"||this.sourceCaches[p].reload()}},this.map=n,this.dispatcher=new Ut(Lt(),n._getMapId()),this.dispatcher.registerMessageHandler("GG",((p,g)=>this.getGlyphs(p,g))),this.dispatcher.registerMessageHandler("GI",((p,g)=>this.getImages(p,g))),this.imageManager=new ae,this.imageManager.setEventedParent(this),this.glyphManager=new Se(n._requestManager,l.localIdeographFontFamily),this.lineAtlas=new je(256,512),this.crossTileSymbolIndex=new Dc,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new a.bu,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",a.bv()),zn().on(oo,this._rtlPluginLoaded),this.on("data",(p=>{if(p.dataType!=="source"||p.sourceDataType!=="metadata")return;const g=this.sourceCaches[p.sourceId];if(!g)return;const x=g.getSource();if(x&&x.vectorLayerIds)for(const T in this._layers){const A=this._layers[T];A.source===x.id&&this._validateLayer(A)}}))}loadURL(n,l={},p){this.fire(new a.l("dataloading",{dataType:"style"})),l.validate=typeof l.validate!="boolean"||l.validate;const g=this.map._requestManager.transformRequest(n,"Style");this._loadStyleRequest=new AbortController;const x=this._loadStyleRequest;a.j(g,this._loadStyleRequest).then((T=>{this._loadStyleRequest=null,this._load(T.data,l,p)})).catch((T=>{this._loadStyleRequest=null,T&&!x.signal.aborted&&this.fire(new a.k(T))}))}loadJSON(n,l={},p){this.fire(new a.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,D.frameAsync(this._frameRequest).then((()=>{this._frameRequest=null,l.validate=l.validate!==!1,this._load(n,l,p)})).catch((()=>{}))}loadEmpty(){this.fire(new a.l("dataloading",{dataType:"style"})),this._load(Uc,{validate:!1})}_load(n,l,p){var g,x;const T=l.transformStyle?l.transformStyle(p,n):n;if(!l.validate||!Ds(this,a.y(T))){this._loaded=!0,this.stylesheet=T;for(const A in T.sources)this.addSource(A,T.sources[A],{validate:!1});T.sprite?this._loadSprite(T.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(T.glyphs),this._createLayers(),this.light=new ee(this.stylesheet.light),this._setProjectionInternal(((g=this.stylesheet.projection)===null||g===void 0?void 0:g.type)||"mercator"),this.sky=new Ce(this.stylesheet.sky),this.map.setTerrain((x=this.stylesheet.terrain)!==null&&x!==void 0?x:null),this.fire(new a.l("data",{dataType:"style"})),this.fire(new a.l("style.load"))}}_createLayers(){const n=a.bw(this.stylesheet.layers);this.dispatcher.broadcast("SL",n),this._order=n.map((l=>l.id)),this._layers={},this._serializedLayers=null;for(const l of n){const p=a.bx(l);p.setEventedParent(this,{layer:{id:l.id}}),this._layers[l.id]=p}}_loadSprite(n,l=!1,p=void 0){let g;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,(function(x,T,A,C){return a._(this,void 0,void 0,(function*(){const R=Xe(x),L=A>1?"@2x":"",N={},z={};for(const{id:H,url:q}of R){const se=T.transformRequest(mt(q,L,".json"),"SpriteJSON");N[H]=a.j(se,C);const ne=T.transformRequest(mt(q,L,".png"),"SpriteImage");z[H]=ke.getImage(ne,C)}return yield Promise.all([...Object.values(N),...Object.values(z)]),(function(H,q){return a._(this,void 0,void 0,(function*(){const se={};for(const ne in H){se[ne]={};const le=D.getImageCanvasContext((yield q[ne]).data),he=(yield H[ne]).data;for(const xe in he){const{width:ve,height:Pe,x:Re,y:Ie,sdf:$e,pixelRatio:He,stretchX:it,stretchY:nt,content:et,textFitWidth:xt,textFitHeight:yt}=he[xe];se[ne][xe]={data:null,pixelRatio:He,sdf:$e,stretchX:it,stretchY:nt,content:et,textFitWidth:xt,textFitHeight:yt,spriteData:{width:ve,height:Pe,x:Re,y:Ie,context:le}}}}return se}))})(N,z)}))})(n,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then((x=>{if(this._spriteRequest=null,x)for(const T in x){this._spritesImagesIds[T]=[];const A=this._spritesImagesIds[T]?this._spritesImagesIds[T].filter((C=>!(C in x))):[];for(const C of A)this.imageManager.removeImage(C),this._changedImages[C]=!0;for(const C in x[T]){const R=T==="default"?C:`${T}:${C}`;this._spritesImagesIds[T].push(R),R in this.imageManager.images?this.imageManager.updateImage(R,x[T][C],!1):this.imageManager.addImage(R,x[T][C]),l&&(this._changedImages[R]=!0)}}})).catch((x=>{this._spriteRequest=null,g=x,this.fire(new a.k(g))})).finally((()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),l&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new a.l("data",{dataType:"style"})),p&&p(g)}))}_unloadSprite(){for(const n of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(n),this._changedImages[n]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new a.l("data",{dataType:"style"}))}_validateLayer(n){const l=this.sourceCaches[n.source];if(!l)return;const p=n.sourceLayer;if(!p)return;const g=l.getSource();(g.type==="geojson"||g.vectorLayerIds&&g.vectorLayerIds.indexOf(p)===-1)&&this.fire(new a.k(new Error(`Source layer "${p}" does not exist on source "${g.id}" as specified by style layer "${n.id}".`)))}loaded(){if(!this._loaded||Object.keys(this._updatedSources).length)return!1;for(const n in this.sourceCaches)if(!this.sourceCaches[n].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(n,l=!1){const p=this._serializedAllLayers();if(!n||n.length===0)return Object.values(l?a.by(p):p);const g=[];for(const x of n)if(p[x]){const T=l?a.by(p[x]):p[x];g.push(T)}return g}_serializedAllLayers(){let n=this._serializedLayers;if(n)return n;n=this._serializedLayers={};const l=Object.keys(this._layers);for(const p of l){const g=this._layers[p];g.type!=="custom"&&(n[p]=g.serialize())}return n}hasTransitions(){var n,l,p;if(!((n=this.light)===null||n===void 0)&&n.hasTransition()||!((l=this.sky)===null||l===void 0)&&l.hasTransition()||!((p=this.projection)===null||p===void 0)&&p.hasTransition())return!0;for(const g in this.sourceCaches)if(this.sourceCaches[g].hasTransition())return!0;for(const g in this._layers)if(this._layers[g].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(n){if(!this._loaded)return;const l=this._changed;if(l){const g=Object.keys(this._updatedLayers),x=Object.keys(this._removedLayers);(g.length||x.length)&&this._updateWorkerLayers(g,x);for(const T in this._updatedSources){const A=this._updatedSources[T];if(A==="reload")this._reloadSource(T);else{if(A!=="clear")throw new Error(`Invalid action ${A}`);this._clearSource(T)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const T in this._updatedPaintProps)this._layers[T].updateTransitions(n);this.light.updateTransitions(n),this.sky.updateTransitions(n),this._resetUpdates()}const p={};for(const g in this.sourceCaches){const x=this.sourceCaches[g];p[g]=x.used,x.used=!1}for(const g of this._order){const x=this._layers[g];x.recalculate(n,this._availableImages),!x.isHidden(n.zoom)&&x.source&&(this.sourceCaches[x.source].used=!0)}for(const g in p){const x=this.sourceCaches[g];!!p[g]!=!!x.used&&x.fire(new a.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:g}))}this.light.recalculate(n),this.sky.recalculate(n),this.projection.recalculate(n),this.z=n.zoom,l&&this.fire(new a.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const n=Object.keys(this._changedImages);if(n.length){for(const l in this.sourceCaches)this.sourceCaches[l].reloadTilesForDependencies(["icons","patterns"],n);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const n in this.sourceCaches)this.sourceCaches[n].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(n,l){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(n,!1),removedIds:l})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(n,l={}){var p;this._checkLoaded();const g=this.serialize();if(n=l.transformStyle?l.transformStyle(g,n):n,((p=l.validate)===null||p===void 0||p)&&Ds(this,a.y(n)))return!1;(n=a.by(n)).layers=a.bw(n.layers);const x=a.bz(g,n),T=this._getOperationsToPerform(x);if(T.unimplemented.length>0)throw new Error(`Unimplemented: ${T.unimplemented.join(", ")}.`);if(T.operations.length===0)return!1;for(const A of T.operations)A();return this.stylesheet=n,this._serializedLayers=null,!0}_getOperationsToPerform(n){const l=[],p=[];for(const g of n)switch(g.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":l.push((()=>this.addLayer.apply(this,g.args)));break;case"removeLayer":l.push((()=>this.removeLayer.apply(this,g.args)));break;case"setPaintProperty":l.push((()=>this.setPaintProperty.apply(this,g.args)));break;case"setLayoutProperty":l.push((()=>this.setLayoutProperty.apply(this,g.args)));break;case"setFilter":l.push((()=>this.setFilter.apply(this,g.args)));break;case"addSource":l.push((()=>this.addSource.apply(this,g.args)));break;case"removeSource":l.push((()=>this.removeSource.apply(this,g.args)));break;case"setLayerZoomRange":l.push((()=>this.setLayerZoomRange.apply(this,g.args)));break;case"setLight":l.push((()=>this.setLight.apply(this,g.args)));break;case"setGeoJSONSourceData":l.push((()=>this.setGeoJSONSourceData.apply(this,g.args)));break;case"setGlyphs":l.push((()=>this.setGlyphs.apply(this,g.args)));break;case"setSprite":l.push((()=>this.setSprite.apply(this,g.args)));break;case"setTerrain":l.push((()=>this.map.setTerrain.apply(this,g.args)));break;case"setSky":l.push((()=>this.setSky.apply(this,g.args)));break;case"setProjection":this.setProjection.apply(this,g.args);break;case"setTransition":l.push((()=>{}));break;default:p.push(g.command)}return{operations:l,unimplemented:p}}addImage(n,l){if(this.getImage(n))return this.fire(new a.k(new Error(`An image named "${n}" already exists.`)));this.imageManager.addImage(n,l),this._afterImageUpdated(n)}updateImage(n,l){this.imageManager.updateImage(n,l)}getImage(n){return this.imageManager.getImage(n)}removeImage(n){if(!this.getImage(n))return this.fire(new a.k(new Error(`An image named "${n}" does not exist.`)));this.imageManager.removeImage(n),this._afterImageUpdated(n)}_afterImageUpdated(n){this._availableImages=this.imageManager.listImages(),this._changedImages[n]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new a.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(n,l,p={}){if(this._checkLoaded(),this.sourceCaches[n]!==void 0)throw new Error(`Source "${n}" already exists.`);if(!l.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(l).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(l.type)>=0&&this._validate(a.y.source,`sources.${n}`,l,null,p))return;this.map&&this.map._collectResourceTiming&&(l.collectResourceTiming=!0);const g=this.sourceCaches[n]=new B(n,l,this.dispatcher);g.style=this,g.setEventedParent(this,(()=>({isSourceLoaded:g.loaded(),source:g.serialize(),sourceId:n}))),g.onAdd(this.map),this._changed=!0}removeSource(n){if(this._checkLoaded(),this.sourceCaches[n]===void 0)throw new Error("There is no source with this ID");for(const p in this._layers)if(this._layers[p].source===n)return this.fire(new a.k(new Error(`Source "${n}" cannot be removed while layer "${p}" is using it.`)));const l=this.sourceCaches[n];delete this.sourceCaches[n],delete this._updatedSources[n],l.fire(new a.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:n})),l.setEventedParent(null),l.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(n,l){if(this._checkLoaded(),this.sourceCaches[n]===void 0)throw new Error(`There is no source with this ID=${n}`);const p=this.sourceCaches[n].getSource();if(p.type!=="geojson")throw new Error(`geojsonSource.type is ${p.type}, which is !== 'geojson`);p.setData(l),this._changed=!0}getSource(n){return this.sourceCaches[n]&&this.sourceCaches[n].getSource()}addLayer(n,l,p={}){this._checkLoaded();const g=n.id;if(this.getLayer(g))return void this.fire(new a.k(new Error(`Layer "${g}" already exists on this map.`)));let x;if(n.type==="custom"){if(Ds(this,a.bA(n)))return;x=a.bx(n)}else{if("source"in n&&typeof n.source=="object"&&(this.addSource(g,n.source),n=a.by(n),n=a.e(n,{source:g})),this._validate(a.y.layer,`layers.${g}`,n,{arrayIndex:-1},p))return;x=a.bx(n),this._validateLayer(x),x.setEventedParent(this,{layer:{id:g}})}const T=l?this._order.indexOf(l):this._order.length;if(l&&T===-1)this.fire(new a.k(new Error(`Cannot add layer "${g}" before non-existing layer "${l}".`)));else{if(this._order.splice(T,0,g),this._layerOrderChanged=!0,this._layers[g]=x,this._removedLayers[g]&&x.source&&x.type!=="custom"){const A=this._removedLayers[g];delete this._removedLayers[g],A.type!==x.type?this._updatedSources[x.source]="clear":(this._updatedSources[x.source]="reload",this.sourceCaches[x.source].pause())}this._updateLayer(x),x.onAdd&&x.onAdd(this.map)}}moveLayer(n,l){if(this._checkLoaded(),this._changed=!0,!this._layers[n])return void this.fire(new a.k(new Error(`The layer '${n}' does not exist in the map's style and cannot be moved.`)));if(n===l)return;const p=this._order.indexOf(n);this._order.splice(p,1);const g=l?this._order.indexOf(l):this._order.length;l&&g===-1?this.fire(new a.k(new Error(`Cannot move layer "${n}" before non-existing layer "${l}".`))):(this._order.splice(g,0,n),this._layerOrderChanged=!0)}removeLayer(n){this._checkLoaded();const l=this._layers[n];if(!l)return void this.fire(new a.k(new Error(`Cannot remove non-existing layer "${n}".`)));l.setEventedParent(null);const p=this._order.indexOf(n);this._order.splice(p,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[n]=l,delete this._layers[n],this._serializedLayers&&delete this._serializedLayers[n],delete this._updatedLayers[n],delete this._updatedPaintProps[n],l.onRemove&&l.onRemove(this.map)}getLayer(n){return this._layers[n]}getLayersOrder(){return[...this._order]}hasLayer(n){return n in this._layers}setLayerZoomRange(n,l,p){this._checkLoaded();const g=this.getLayer(n);g?g.minzoom===l&&g.maxzoom===p||(l!=null&&(g.minzoom=l),p!=null&&(g.maxzoom=p),this._updateLayer(g)):this.fire(new a.k(new Error(`Cannot set the zoom range of non-existing layer "${n}".`)))}setFilter(n,l,p={}){this._checkLoaded();const g=this.getLayer(n);if(g){if(!a.bB(g.filter,l))return l==null?(g.filter=void 0,void this._updateLayer(g)):void(this._validate(a.y.filter,`layers.${g.id}.filter`,l,null,p)||(g.filter=a.by(l),this._updateLayer(g)))}else this.fire(new a.k(new Error(`Cannot filter non-existing layer "${n}".`)))}getFilter(n){return a.by(this.getLayer(n).filter)}setLayoutProperty(n,l,p,g={}){this._checkLoaded();const x=this.getLayer(n);x?a.bB(x.getLayoutProperty(l),p)||(x.setLayoutProperty(l,p,g),this._updateLayer(x)):this.fire(new a.k(new Error(`Cannot style non-existing layer "${n}".`)))}getLayoutProperty(n,l){const p=this.getLayer(n);if(p)return p.getLayoutProperty(l);this.fire(new a.k(new Error(`Cannot get style of non-existing layer "${n}".`)))}setPaintProperty(n,l,p,g={}){this._checkLoaded();const x=this.getLayer(n);x?a.bB(x.getPaintProperty(l),p)||(x.setPaintProperty(l,p,g)&&this._updateLayer(x),this._changed=!0,this._updatedPaintProps[n]=!0,this._serializedLayers=null):this.fire(new a.k(new Error(`Cannot style non-existing layer "${n}".`)))}getPaintProperty(n,l){return this.getLayer(n).getPaintProperty(l)}setFeatureState(n,l){this._checkLoaded();const p=n.source,g=n.sourceLayer,x=this.sourceCaches[p];if(x===void 0)return void this.fire(new a.k(new Error(`The source '${p}' does not exist in the map's style.`)));const T=x.getSource().type;T==="geojson"&&g?this.fire(new a.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):T!=="vector"||g?(n.id===void 0&&this.fire(new a.k(new Error("The feature id parameter must be provided."))),x.setFeatureState(g,n.id,l)):this.fire(new a.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(n,l){this._checkLoaded();const p=n.source,g=this.sourceCaches[p];if(g===void 0)return void this.fire(new a.k(new Error(`The source '${p}' does not exist in the map's style.`)));const x=g.getSource().type,T=x==="vector"?n.sourceLayer:void 0;x!=="vector"||T?l&&typeof n.id!="string"&&typeof n.id!="number"?this.fire(new a.k(new Error("A feature id is required to remove its specific state property."))):g.removeFeatureState(T,n.id,l):this.fire(new a.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(n){this._checkLoaded();const l=n.source,p=n.sourceLayer,g=this.sourceCaches[l];if(g!==void 0)return g.getSource().type!=="vector"||p?(n.id===void 0&&this.fire(new a.k(new Error("The feature id parameter must be provided."))),g.getFeatureState(p,n.id)):void this.fire(new a.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new a.k(new Error(`The source '${l}' does not exist in the map's style.`)))}getTransition(){return a.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const n=a.bC(this.sourceCaches,(x=>x.serialize())),l=this._serializeByIds(this._order,!0),p=this.map.getTerrain()||void 0,g=this.stylesheet;return a.bD({version:g.version,name:g.name,metadata:g.metadata,light:g.light,sky:g.sky,center:g.center,zoom:g.zoom,bearing:g.bearing,pitch:g.pitch,sprite:g.sprite,glyphs:g.glyphs,transition:g.transition,projection:g.projection,sources:n,layers:l,terrain:p},(x=>x!==void 0))}_updateLayer(n){this._updatedLayers[n.id]=!0,n.source&&!this._updatedSources[n.source]&&this.sourceCaches[n.source].getSource().type!=="raster"&&(this._updatedSources[n.source]="reload",this.sourceCaches[n.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(n){const l=T=>this._layers[T].type==="fill-extrusion",p={},g=[];for(let T=this._order.length-1;T>=0;T--){const A=this._order[T];if(l(A)){p[A]=T;for(const C of n){const R=C[A];if(R)for(const L of R)g.push(L)}}}g.sort(((T,A)=>A.intersectionZ-T.intersectionZ));const x=[];for(let T=this._order.length-1;T>=0;T--){const A=this._order[T];if(l(A))for(let C=g.length-1;C>=0;C--){const R=g[C].feature;if(p[R.layer.id]<T)break;x.push(R),g.pop()}else for(const C of n){const R=C[A];if(R)for(const L of R)x.push(L.feature)}}return x}queryRenderedFeatures(n,l,p){l&&l.filter&&this._validate(a.y.filter,"queryRenderedFeatures.filter",l.filter,null,l);const g={};if(l&&l.layers){if(!(Array.isArray(l.layers)||l.layers instanceof Set))return this.fire(new a.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const R of l.layers){const L=this._layers[R];if(!L)return this.fire(new a.k(new Error(`The layer '${R}' does not exist in the map's style and cannot be queried for features.`))),[];g[L.source]=!0}}const x=[];l.availableImages=this._availableImages;const T=this._serializedAllLayers(),A=l.layers instanceof Set?l.layers:Array.isArray(l.layers)?new Set(l.layers):null,C=Object.assign(Object.assign({},l),{layers:A});for(const R in this.sourceCaches)l.layers&&!g[R]||x.push(ei(this.sourceCaches[R],this._layers,T,n,C,p));return this.placement&&x.push((function(R,L,N,z,H,q,se){const ne={},le=q.queryRenderedSymbols(z),he=[];for(const xe of Object.keys(le).map(Number))he.push(se[xe]);he.sort(ci);for(const xe of he){const ve=xe.featureIndex.lookupSymbolFeatures(le[xe.bucketInstanceId],L,xe.bucketIndex,xe.sourceLayerIndex,H.filter,H.layers,H.availableImages,R);for(const Pe in ve){const Re=ne[Pe]=ne[Pe]||[],Ie=ve[Pe];Ie.sort((($e,He)=>{const it=xe.featureSortOrder;if(it){const nt=it.indexOf($e.featureIndex);return it.indexOf(He.featureIndex)-nt}return He.featureIndex-$e.featureIndex}));for(const $e of Ie)Re.push($e)}}return(function(xe,ve,Pe){for(const Re in xe)for(const Ie of xe[Re])di(Ie,Pe[ve[Re].source]);return xe})(ne,R,N)})(this._layers,T,this.sourceCaches,n,C,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(x)}querySourceFeatures(n,l){l&&l.filter&&this._validate(a.y.filter,"querySourceFeatures.filter",l.filter,null,l);const p=this.sourceCaches[n];return p?(function(g,x){const T=g.getRenderableIds().map((R=>g.getTileByID(R))),A=[],C={};for(let R=0;R<T.length;R++){const L=T[R],N=L.tileID.canonical.key;C[N]||(C[N]=!0,L.querySourceFeatures(A,x))}return A})(p,l):[]}getLight(){return this.light.getLight()}setLight(n,l={}){this._checkLoaded();const p=this.light.getLight();let g=!1;for(const T in n)if(!a.bB(n[T],p[T])){g=!0;break}if(!g)return;const x={now:D.now(),transition:a.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(n,l),this.light.updateTransitions(x)}getProjection(){var n;return(n=this.stylesheet)===null||n===void 0?void 0:n.projection}setProjection(n){if(this._checkLoaded(),this.projection){if(this.projection.name===n.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=n,this._setProjectionInternal(n.type)}getSky(){var n;return(n=this.stylesheet)===null||n===void 0?void 0:n.sky}setSky(n,l={}){this._checkLoaded();const p=this.getSky();let g=!1;if(!n&&!p)return;if(n&&!p)g=!0;else if(!n&&p)g=!0;else for(const T in n)if(!a.bB(n[T],p[T])){g=!0;break}if(!g)return;const x={now:D.now(),transition:a.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=n,this.sky.setSky(n,l),this.sky.updateTransitions(x)}_setProjectionInternal(n){const l=(function(p){if(Array.isArray(p)){const g=new Ka({type:p});return{projection:g,transform:new il,cameraHelper:new rl(g)}}switch(p){case"mercator":return{projection:new Oc,transform:new Gr,cameraHelper:new cn};case"globe":{const g=new Ka({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:g,transform:new il,cameraHelper:new rl(g)}}case"vertical-perspective":return{projection:new go,transform:new tl,cameraHelper:new Mr};default:return a.w(`Unknown projection name: ${p}. Falling back to mercator projection.`),{projection:new Oc,transform:new Gr,cameraHelper:new cn}}})(n);this.projection=l.projection,this.map.migrateProjection(l.transform,l.cameraHelper);for(const p in this.sourceCaches)this.sourceCaches[p].reload()}_validate(n,l,p,g,x={}){return(!x||x.validate!==!1)&&Ds(this,n.call(a.y,a.e({key:l,style:this.serialize(),value:p,styleSpec:a.v},g)))}_remove(n=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),zn().off(oo,this._rtlPluginLoaded);for(const l in this._layers)this._layers[l].setEventedParent(null);for(const l in this.sourceCaches){const p=this.sourceCaches[l];p.setEventedParent(null),p.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),n&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(n)}_clearSource(n){this.sourceCaches[n].clearTiles()}_reloadSource(n){this.sourceCaches[n].resume(),this.sourceCaches[n].reload()}_updateSources(n){for(const l in this.sourceCaches)this.sourceCaches[l].update(n,this.map.terrain)}_generateCollisionBoxes(){for(const n in this.sourceCaches)this._reloadSource(n)}_updatePlacement(n,l,p,g,x=!1){let T=!1,A=!1;const C={};for(const R of this._order){const L=this._layers[R];if(L.type!=="symbol")continue;if(!C[L.source]){const z=this.sourceCaches[L.source];C[L.source]=z.getRenderableIds(!0).map((H=>z.getTileByID(H))).sort(((H,q)=>q.tileID.overscaledZ-H.tileID.overscaledZ||(H.tileID.isLessThan(q.tileID)?-1:1)))}const N=this.crossTileSymbolIndex.addLayer(L,C[L.source],n.center.lng);T=T||N}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((x=x||this._layerOrderChanged||p===0)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(D.now(),n.zoom))&&(this.pauseablePlacement=new Mc(n,this.map.terrain,this._order,x,l,p,g,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,C),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(D.now()),A=!0),T&&this.pauseablePlacement.placement.setStale()),A||T)for(const R of this._order){const L=this._layers[R];L.type==="symbol"&&this.placement.updateLayerOpacities(L,C[L.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(D.now())}_releaseSymbolFadeTiles(){for(const n in this.sourceCaches)this.sourceCaches[n].releaseSymbolFadeTiles()}getImages(n,l){return a._(this,void 0,void 0,(function*(){const p=yield this.imageManager.getImages(l.icons);this._updateTilesForChangedImages();const g=this.sourceCaches[l.source];return g&&g.setDependencies(l.tileID.key,l.type,l.icons),p}))}getGlyphs(n,l){return a._(this,void 0,void 0,(function*(){const p=yield this.glyphManager.getGlyphs(l.stacks),g=this.sourceCaches[l.source];return g&&g.setDependencies(l.tileID.key,l.type,[""]),p}))}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(n,l={}){this._checkLoaded(),n&&this._validate(a.y.glyphs,"glyphs",n,null,l)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=n,this.glyphManager.entries={},this.glyphManager.setURL(n))}addSprite(n,l,p={},g){this._checkLoaded();const x=[{id:n,url:l}],T=[...Xe(this.stylesheet.sprite),...x];this._validate(a.y.sprite,"sprite",T,null,p)||(this.stylesheet.sprite=T,this._loadSprite(x,!0,g))}removeSprite(n){this._checkLoaded();const l=Xe(this.stylesheet.sprite);if(l.find((p=>p.id===n))){if(this._spritesImagesIds[n])for(const p of this._spritesImagesIds[n])this.imageManager.removeImage(p),this._changedImages[p]=!0;l.splice(l.findIndex((p=>p.id===n)),1),this.stylesheet.sprite=l.length>0?l:void 0,delete this._spritesImagesIds[n],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new a.l("data",{dataType:"style"}))}else this.fire(new a.k(new Error(`Sprite "${n}" doesn't exists on this map.`)))}getSprite(){return Xe(this.stylesheet.sprite)}setSprite(n,l={},p){this._checkLoaded(),n&&this._validate(a.y.sprite,"sprite",n,null,l)||(this.stylesheet.sprite=n,n?this._loadSprite(n,!0,p):(this._unloadSprite(),p&&p(null)))}}var wn=a.aC([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Cp{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(n,l,p,g,x,T,A,C,R){this.context=n;let L=this.boundPaintVertexBuffers.length!==g.length;for(let N=0;!L&&N<g.length;N++)this.boundPaintVertexBuffers[N]!==g[N]&&(L=!0);!this.vao||this.boundProgram!==l||this.boundLayoutVertexBuffer!==p||L||this.boundIndexBuffer!==x||this.boundVertexOffset!==T||this.boundDynamicVertexBuffer!==A||this.boundDynamicVertexBuffer2!==C||this.boundDynamicVertexBuffer3!==R?this.freshBind(l,p,g,x,T,A,C,R):(n.bindVertexArray.set(this.vao),A&&A.bind(),x&&x.dynamicDraw&&x.bind(),C&&C.bind(),R&&R.bind())}freshBind(n,l,p,g,x,T,A,C){const R=n.numAttributes,L=this.context,N=L.gl;this.vao&&this.destroy(),this.vao=L.createVertexArray(),L.bindVertexArray.set(this.vao),this.boundProgram=n,this.boundLayoutVertexBuffer=l,this.boundPaintVertexBuffers=p,this.boundIndexBuffer=g,this.boundVertexOffset=x,this.boundDynamicVertexBuffer=T,this.boundDynamicVertexBuffer2=A,this.boundDynamicVertexBuffer3=C,l.enableAttributes(N,n);for(const z of p)z.enableAttributes(N,n);T&&T.enableAttributes(N,n),A&&A.enableAttributes(N,n),C&&C.enableAttributes(N,n),l.bind(),l.setVertexAttribPointers(N,n,x);for(const z of p)z.bind(),z.setVertexAttribPointers(N,n,x);T&&(T.bind(),T.setVertexAttribPointers(N,n,x)),g&&g.bind(),A&&(A.bind(),A.setVertexAttribPointers(N,n,x)),C&&(C.bind(),C.setVertexAttribPointers(N,n,x)),L.currentNumAttributes=R}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Vc=(_,n,l,p,g)=>({u_texture:0,u_ele_delta:_,u_fog_matrix:n,u_fog_color:l?l.properties.get("fog-color"):a.b6.white,u_fog_ground_blend:l?l.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:g?0:l?l.calculateFogBlendOpacity(p):0,u_horizon_color:l?l.properties.get("horizon-color"):a.b6.white,u_horizon_fog_blend:l?l.properties.get("horizon-fog-blend"):1,u_is_globe_mode:g?1:0}),ra={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function cs(_){const n=[];for(let l=0;l<_.length;l++){if(_[l]===null)continue;const p=_[l].split(" ");n.push(p.pop())}return n}class Ip{constructor(n,l,p,g,x,T,A,C){const R=n.gl;this.program=R.createProgram();const L=cs(l.staticAttributes),N=p?p.getBinderAttributes():[],z=L.concat(N),H=an.prelude.staticUniforms?cs(an.prelude.staticUniforms):[],q=A.staticUniforms?cs(A.staticUniforms):[],se=l.staticUniforms?cs(l.staticUniforms):[],ne=p?p.getBinderUniforms():[],le=H.concat(q).concat(se).concat(ne),he=[];for(const He of le)he.indexOf(He)<0&&he.push(He);const xe=p?p.defines():[];Kr(R)&&xe.unshift("#version 300 es"),x&&xe.push("#define OVERDRAW_INSPECTOR;"),T&&xe.push("#define TERRAIN3D;"),C&&xe.push(C);let ve=xe.concat(an.prelude.fragmentSource,A.fragmentSource,l.fragmentSource).join(`
`),Pe=xe.concat(an.prelude.vertexSource,A.vertexSource,l.vertexSource).join(`
`);Kr(R)||(ve=(function(He){return He.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")})(ve),Pe=(function(He){return He.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")})(Pe));const Re=R.createShader(R.FRAGMENT_SHADER);if(R.isContextLost())return void(this.failedToCreate=!0);if(R.shaderSource(Re,ve),R.compileShader(Re),!R.getShaderParameter(Re,R.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${R.getShaderInfoLog(Re)}`);R.attachShader(this.program,Re);const Ie=R.createShader(R.VERTEX_SHADER);if(R.isContextLost())return void(this.failedToCreate=!0);if(R.shaderSource(Ie,Pe),R.compileShader(Ie),!R.getShaderParameter(Ie,R.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${R.getShaderInfoLog(Ie)}`);R.attachShader(this.program,Ie),this.attributes={};const $e={};this.numAttributes=z.length;for(let He=0;He<this.numAttributes;He++)z[He]&&(R.bindAttribLocation(this.program,He,z[He]),this.attributes[z[He]]=He);if(R.linkProgram(this.program),!R.getProgramParameter(this.program,R.LINK_STATUS))throw new Error(`Program failed to link: ${R.getProgramInfoLog(this.program)}`);R.deleteShader(Ie),R.deleteShader(Re);for(let He=0;He<he.length;He++){const it=he[He];if(it&&!$e[it]){const nt=R.getUniformLocation(this.program,it);nt&&($e[it]=nt)}}this.fixedUniforms=g(n,$e),this.terrainUniforms=((He,it)=>({u_depth:new a.bE(He,it.u_depth),u_terrain:new a.bE(He,it.u_terrain),u_terrain_dim:new a.b7(He,it.u_terrain_dim),u_terrain_matrix:new a.bG(He,it.u_terrain_matrix),u_terrain_unpack:new a.bH(He,it.u_terrain_unpack),u_terrain_exaggeration:new a.b7(He,it.u_terrain_exaggeration)}))(n,$e),this.projectionUniforms=((He,it)=>({u_projection_matrix:new a.bG(He,it.u_projection_matrix),u_projection_tile_mercator_coords:new a.bH(He,it.u_projection_tile_mercator_coords),u_projection_clipping_plane:new a.bH(He,it.u_projection_clipping_plane),u_projection_transition:new a.b7(He,it.u_projection_transition),u_projection_fallback_matrix:new a.bG(He,it.u_projection_fallback_matrix)}))(n,$e),this.binderUniforms=p?p.getUniforms(n,$e):[]}draw(n,l,p,g,x,T,A,C,R,L,N,z,H,q,se,ne,le,he,xe){const ve=n.gl;if(this.failedToCreate)return;if(n.program.set(this.program),n.setDepthMode(p),n.setStencilMode(g),n.setColorMode(x),n.setCullFace(T),C){n.activeTexture.set(ve.TEXTURE2),ve.bindTexture(ve.TEXTURE_2D,C.depthTexture),n.activeTexture.set(ve.TEXTURE3),ve.bindTexture(ve.TEXTURE_2D,C.texture);for(const Re in this.terrainUniforms)this.terrainUniforms[Re].set(C[Re])}if(R)for(const Re in R)this.projectionUniforms[ra[Re]].set(R[Re]);if(A)for(const Re in this.fixedUniforms)this.fixedUniforms[Re].set(A[Re]);ne&&ne.setUniforms(n,this.binderUniforms,q,{zoom:se});let Pe=0;switch(l){case ve.LINES:Pe=2;break;case ve.TRIANGLES:Pe=3;break;case ve.LINE_STRIP:Pe=1}for(const Re of H.get()){const Ie=Re.vaos||(Re.vaos={});(Ie[L]||(Ie[L]=new Cp)).bind(n,this,N,ne?ne.getPaintVertexBuffers():[],z,Re.vertexOffset,le,he,xe),ve.drawElements(l,Re.primitiveLength*Pe,ve.UNSIGNED_SHORT,Re.primitiveOffset*Pe*2)}}}function na(_,n,l){const p=1/a.av(l,1,n.transform.tileZoom),g=Math.pow(2,l.tileID.overscaledZ),x=l.tileSize*Math.pow(2,n.transform.tileZoom)/g,T=x*(l.tileID.canonical.x+l.tileID.wrap*g),A=x*l.tileID.canonical.y;return{u_image:0,u_texsize:l.imageAtlasTexture.size,u_scale:[p,_.fromScale,_.toScale],u_fade:_.t,u_pixel_coord_upper:[T>>16,A>>16],u_pixel_coord_lower:[65535&T,65535&A]}}const Vh=(_,n,l,p)=>{const g=_.style.light,x=g.properties.get("position"),T=[x.x,x.y,x.z],A=a.bK();g.properties.get("anchor")==="viewport"&&a.bL(A,_.transform.bearingInRadians),a.bM(T,T,A);const C=_.transform.transformLightDirection(T),R=g.properties.get("color");return{u_lightpos:T,u_lightpos_globe:C,u_lightintensity:g.properties.get("intensity"),u_lightcolor:[R.r,R.g,R.b],u_vertical_gradient:+n,u_opacity:l,u_fill_translate:p}},mo=(_,n,l,p,g,x,T)=>a.e(Vh(_,n,l,p),na(x,_,T),{u_height_factor:-Math.pow(2,g.overscaledZ)/T.tileSize/8}),jh=(_,n,l,p)=>a.e(na(n,_,l),{u_fill_translate:p}),$h=(_,n)=>({u_world:_,u_fill_translate:n}),Mp=(_,n,l,p,g)=>a.e(jh(_,n,l,g),{u_world:p}),Wh=(_,n,l,p,g)=>{const x=_.transform;let T,A,C=0;if(l.paint.get("circle-pitch-alignment")==="map"){const R=a.av(n,1,x.zoom);T=!0,A=[R,R],C=R/(a.Z*Math.pow(2,n.tileID.overscaledZ))*2*Math.PI*g}else T=!1,A=x.pixelsToGLUnits;return{u_camera_to_center_distance:x.cameraToCenterDistance,u_scale_with_map:+(l.paint.get("circle-pitch-scale")==="map"),u_pitch_with_map:+T,u_device_pixel_ratio:_.pixelRatio,u_extrude_scale:A,u_globe_extrude_scale:C,u_translate:p}},jc=_=>({u_pixel_extrude_scale:[1/_.width,1/_.height]}),Hh=_=>({u_viewport_size:[_.width,_.height]}),$c=(_,n=1)=>({u_color:_,u_overlay:0,u_overlay_scale:n}),Wc=(_,n,l,p)=>{const g=a.av(_,1,n)/(a.Z*Math.pow(2,_.tileID.overscaledZ))*2*Math.PI*p;return{u_extrude_scale:a.av(_,1,n),u_intensity:l,u_globe_extrude_scale:g}},Hc=(_,n,l,p)=>{const g=a.K();a.bN(g,0,_.width,_.height,0,0,1);const x=_.context.gl;return{u_matrix:g,u_world:[x.drawingBufferWidth,x.drawingBufferHeight],u_image:l,u_color_ramp:p,u_opacity:n.paint.get("heatmap-opacity")}},Os=(_,n,l)=>{const p=l.paint.get("hillshade-shadow-color"),g=l.paint.get("hillshade-highlight-color"),x=l.paint.get("hillshade-accent-color");let T=l.paint.get("hillshade-illumination-direction")*(Math.PI/180);return l.paint.get("hillshade-illumination-anchor")==="viewport"&&(T+=_.transform.bearingInRadians),{u_image:0,u_latrange:qh(0,n.tileID),u_light:[l.paint.get("hillshade-exaggeration"),T],u_shadow:p,u_highlight:g,u_accent:x}},Zh=(_,n)=>{const l=n.stride,p=a.K();return a.bN(p,0,a.Z,-8192,0,0,1),a.L(p,p,[0,-8192,0]),{u_matrix:p,u_image:1,u_dimension:[l,l],u_zoom:_.overscaledZ,u_unpack:n.getUnpackVector()}};function qh(_,n){const l=Math.pow(2,n.canonical.z),p=n.canonical.y;return[new a.$(0,p/l).toLngLat().lat,new a.$(0,(p+1)/l).toLngLat().lat]}const Ls=(_,n,l,p)=>{const g=_.transform;return{u_translation:Zc(_,n,l),u_ratio:p/a.av(n,1,g.zoom),u_device_pixel_ratio:_.pixelRatio,u_units_to_pixels:[1/g.pixelsToGLUnits[0],1/g.pixelsToGLUnits[1]]}},Rp=(_,n,l,p,g)=>a.e(Ls(_,n,l,p),{u_image:0,u_image_height:g}),nl=(_,n,l,p,g)=>{const x=_.transform,T=Xh(n,x);return{u_translation:Zc(_,n,l),u_texsize:n.imageAtlasTexture.size,u_ratio:p/a.av(n,1,x.zoom),u_device_pixel_ratio:_.pixelRatio,u_image:0,u_scale:[T,g.fromScale,g.toScale],u_fade:g.t,u_units_to_pixels:[1/x.pixelsToGLUnits[0],1/x.pixelsToGLUnits[1]]}},kp=(_,n,l,p,g,x)=>{const T=_.lineAtlas,A=Xh(n,_.transform),C=l.layout.get("line-cap")==="round",R=T.getDash(g.from,C),L=T.getDash(g.to,C),N=R.width*x.fromScale,z=L.width*x.toScale;return a.e(Ls(_,n,l,p),{u_patternscale_a:[A/N,-R.height/2],u_patternscale_b:[A/z,-L.height/2],u_sdfgamma:T.width/(256*Math.min(N,z)*_.pixelRatio)/2,u_image:0,u_tex_y_a:R.y,u_tex_y_b:L.y,u_mix:x.t})};function Xh(_,n){return 1/a.av(_,1,n.tileZoom)}function Zc(_,n,l){return a.aw(_.transform,n,l.paint.get("line-translate"),l.paint.get("line-translate-anchor"))}const Gh=(_,n,l,p,g)=>{return{u_tl_parent:_,u_scale_parent:n,u_buffer_scale:1,u_fade_t:l.mix,u_opacity:l.opacity*p.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:p.paint.get("raster-brightness-min"),u_brightness_high:p.paint.get("raster-brightness-max"),u_saturation_factor:(T=p.paint.get("raster-saturation"),T>0?1-1/(1.001-T):-T),u_contrast_factor:(x=p.paint.get("raster-contrast"),x>0?1/(1-x):1+x),u_spin_weights:Yh(p.paint.get("raster-hue-rotate")),u_coords_top:[g[0].x,g[0].y,g[1].x,g[1].y],u_coords_bottom:[g[3].x,g[3].y,g[2].x,g[2].y]};var x,T};function Yh(_){_*=Math.PI/180;const n=Math.sin(_),l=Math.cos(_);return[(2*l+1)/3,(-Math.sqrt(3)*n-l+1)/3,(Math.sqrt(3)*n-l+1)/3]}const sl=(_,n,l,p,g,x,T,A,C,R,L,N,z)=>{const H=T.transform;return{u_is_size_zoom_constant:+(_==="constant"||_==="source"),u_is_size_feature_constant:+(_==="constant"||_==="camera"),u_size_t:n?n.uSizeT:0,u_size:n?n.uSize:0,u_camera_to_center_distance:H.cameraToCenterDistance,u_pitch:H.pitch/360*2*Math.PI,u_rotate_symbol:+l,u_aspect_ratio:H.width/H.height,u_fade_change:T.options.fadeDuration?T.symbolFadeChange:1,u_label_plane_matrix:A,u_coord_matrix:C,u_is_text:+L,u_pitch_with_map:+p,u_is_along_line:g,u_is_variable_anchor:x,u_texsize:N,u_texture:0,u_translation:R,u_pitched_scale:z}},qc=(_,n,l,p,g,x,T,A,C,R,L,N,z,H)=>{const q=T.transform;return a.e(sl(_,n,l,p,g,x,T,A,C,R,L,N,H),{u_gamma_scale:p?Math.cos(q.pitch*Math.PI/180)*q.cameraToCenterDistance:1,u_device_pixel_ratio:T.pixelRatio,u_is_halo:1})},ol=(_,n,l,p,g,x,T,A,C,R,L,N,z)=>a.e(qc(_,n,l,p,g,x,T,A,C,R,!0,L,0,z),{u_texsize_icon:N,u_texture_icon:1}),Vn=(_,n)=>({u_opacity:_,u_color:n}),Xc=(_,n,l,p,g)=>a.e((function(x,T,A,C){const R=A.imageManager.getPattern(x.from.toString()),L=A.imageManager.getPattern(x.to.toString()),{width:N,height:z}=A.imageManager.getPixelSize(),H=Math.pow(2,C.tileID.overscaledZ),q=C.tileSize*Math.pow(2,A.transform.tileZoom)/H,se=q*(C.tileID.canonical.x+C.tileID.wrap*H),ne=q*C.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:R.tl,u_pattern_br_a:R.br,u_pattern_tl_b:L.tl,u_pattern_br_b:L.br,u_texsize:[N,z],u_mix:T.t,u_pattern_size_a:R.displaySize,u_pattern_size_b:L.displaySize,u_scale_a:T.fromScale,u_scale_b:T.toScale,u_tile_units_to_pixels:1/a.av(C,1,A.transform.tileZoom),u_pixel_coord_upper:[se>>16,ne>>16],u_pixel_coord_lower:[65535&se,65535&ne]}})(l,g,n,p),{u_opacity:_}),al=(_,n)=>{},Gc={fillExtrusion:(_,n)=>({u_lightpos:new a.bI(_,n.u_lightpos),u_lightpos_globe:new a.bI(_,n.u_lightpos_globe),u_lightintensity:new a.b7(_,n.u_lightintensity),u_lightcolor:new a.bI(_,n.u_lightcolor),u_vertical_gradient:new a.b7(_,n.u_vertical_gradient),u_opacity:new a.b7(_,n.u_opacity),u_fill_translate:new a.bJ(_,n.u_fill_translate)}),fillExtrusionPattern:(_,n)=>({u_lightpos:new a.bI(_,n.u_lightpos),u_lightpos_globe:new a.bI(_,n.u_lightpos_globe),u_lightintensity:new a.b7(_,n.u_lightintensity),u_lightcolor:new a.bI(_,n.u_lightcolor),u_vertical_gradient:new a.b7(_,n.u_vertical_gradient),u_height_factor:new a.b7(_,n.u_height_factor),u_opacity:new a.b7(_,n.u_opacity),u_fill_translate:new a.bJ(_,n.u_fill_translate),u_image:new a.bE(_,n.u_image),u_texsize:new a.bJ(_,n.u_texsize),u_pixel_coord_upper:new a.bJ(_,n.u_pixel_coord_upper),u_pixel_coord_lower:new a.bJ(_,n.u_pixel_coord_lower),u_scale:new a.bI(_,n.u_scale),u_fade:new a.b7(_,n.u_fade)}),fill:(_,n)=>({u_fill_translate:new a.bJ(_,n.u_fill_translate)}),fillPattern:(_,n)=>({u_image:new a.bE(_,n.u_image),u_texsize:new a.bJ(_,n.u_texsize),u_pixel_coord_upper:new a.bJ(_,n.u_pixel_coord_upper),u_pixel_coord_lower:new a.bJ(_,n.u_pixel_coord_lower),u_scale:new a.bI(_,n.u_scale),u_fade:new a.b7(_,n.u_fade),u_fill_translate:new a.bJ(_,n.u_fill_translate)}),fillOutline:(_,n)=>({u_world:new a.bJ(_,n.u_world),u_fill_translate:new a.bJ(_,n.u_fill_translate)}),fillOutlinePattern:(_,n)=>({u_world:new a.bJ(_,n.u_world),u_image:new a.bE(_,n.u_image),u_texsize:new a.bJ(_,n.u_texsize),u_pixel_coord_upper:new a.bJ(_,n.u_pixel_coord_upper),u_pixel_coord_lower:new a.bJ(_,n.u_pixel_coord_lower),u_scale:new a.bI(_,n.u_scale),u_fade:new a.b7(_,n.u_fade),u_fill_translate:new a.bJ(_,n.u_fill_translate)}),circle:(_,n)=>({u_camera_to_center_distance:new a.b7(_,n.u_camera_to_center_distance),u_scale_with_map:new a.bE(_,n.u_scale_with_map),u_pitch_with_map:new a.bE(_,n.u_pitch_with_map),u_extrude_scale:new a.bJ(_,n.u_extrude_scale),u_device_pixel_ratio:new a.b7(_,n.u_device_pixel_ratio),u_globe_extrude_scale:new a.b7(_,n.u_globe_extrude_scale),u_translate:new a.bJ(_,n.u_translate)}),collisionBox:(_,n)=>({u_pixel_extrude_scale:new a.bJ(_,n.u_pixel_extrude_scale)}),collisionCircle:(_,n)=>({u_viewport_size:new a.bJ(_,n.u_viewport_size)}),debug:(_,n)=>({u_color:new a.bF(_,n.u_color),u_overlay:new a.bE(_,n.u_overlay),u_overlay_scale:new a.b7(_,n.u_overlay_scale)}),depth:al,clippingMask:al,heatmap:(_,n)=>({u_extrude_scale:new a.b7(_,n.u_extrude_scale),u_intensity:new a.b7(_,n.u_intensity),u_globe_extrude_scale:new a.b7(_,n.u_globe_extrude_scale)}),heatmapTexture:(_,n)=>({u_matrix:new a.bG(_,n.u_matrix),u_world:new a.bJ(_,n.u_world),u_image:new a.bE(_,n.u_image),u_color_ramp:new a.bE(_,n.u_color_ramp),u_opacity:new a.b7(_,n.u_opacity)}),hillshade:(_,n)=>({u_image:new a.bE(_,n.u_image),u_latrange:new a.bJ(_,n.u_latrange),u_light:new a.bJ(_,n.u_light),u_shadow:new a.bF(_,n.u_shadow),u_highlight:new a.bF(_,n.u_highlight),u_accent:new a.bF(_,n.u_accent)}),hillshadePrepare:(_,n)=>({u_matrix:new a.bG(_,n.u_matrix),u_image:new a.bE(_,n.u_image),u_dimension:new a.bJ(_,n.u_dimension),u_zoom:new a.b7(_,n.u_zoom),u_unpack:new a.bH(_,n.u_unpack)}),line:(_,n)=>({u_translation:new a.bJ(_,n.u_translation),u_ratio:new a.b7(_,n.u_ratio),u_device_pixel_ratio:new a.b7(_,n.u_device_pixel_ratio),u_units_to_pixels:new a.bJ(_,n.u_units_to_pixels)}),lineGradient:(_,n)=>({u_translation:new a.bJ(_,n.u_translation),u_ratio:new a.b7(_,n.u_ratio),u_device_pixel_ratio:new a.b7(_,n.u_device_pixel_ratio),u_units_to_pixels:new a.bJ(_,n.u_units_to_pixels),u_image:new a.bE(_,n.u_image),u_image_height:new a.b7(_,n.u_image_height)}),linePattern:(_,n)=>({u_translation:new a.bJ(_,n.u_translation),u_texsize:new a.bJ(_,n.u_texsize),u_ratio:new a.b7(_,n.u_ratio),u_device_pixel_ratio:new a.b7(_,n.u_device_pixel_ratio),u_image:new a.bE(_,n.u_image),u_units_to_pixels:new a.bJ(_,n.u_units_to_pixels),u_scale:new a.bI(_,n.u_scale),u_fade:new a.b7(_,n.u_fade)}),lineSDF:(_,n)=>({u_translation:new a.bJ(_,n.u_translation),u_ratio:new a.b7(_,n.u_ratio),u_device_pixel_ratio:new a.b7(_,n.u_device_pixel_ratio),u_units_to_pixels:new a.bJ(_,n.u_units_to_pixels),u_patternscale_a:new a.bJ(_,n.u_patternscale_a),u_patternscale_b:new a.bJ(_,n.u_patternscale_b),u_sdfgamma:new a.b7(_,n.u_sdfgamma),u_image:new a.bE(_,n.u_image),u_tex_y_a:new a.b7(_,n.u_tex_y_a),u_tex_y_b:new a.b7(_,n.u_tex_y_b),u_mix:new a.b7(_,n.u_mix)}),raster:(_,n)=>({u_tl_parent:new a.bJ(_,n.u_tl_parent),u_scale_parent:new a.b7(_,n.u_scale_parent),u_buffer_scale:new a.b7(_,n.u_buffer_scale),u_fade_t:new a.b7(_,n.u_fade_t),u_opacity:new a.b7(_,n.u_opacity),u_image0:new a.bE(_,n.u_image0),u_image1:new a.bE(_,n.u_image1),u_brightness_low:new a.b7(_,n.u_brightness_low),u_brightness_high:new a.b7(_,n.u_brightness_high),u_saturation_factor:new a.b7(_,n.u_saturation_factor),u_contrast_factor:new a.b7(_,n.u_contrast_factor),u_spin_weights:new a.bI(_,n.u_spin_weights),u_coords_top:new a.bH(_,n.u_coords_top),u_coords_bottom:new a.bH(_,n.u_coords_bottom)}),symbolIcon:(_,n)=>({u_is_size_zoom_constant:new a.bE(_,n.u_is_size_zoom_constant),u_is_size_feature_constant:new a.bE(_,n.u_is_size_feature_constant),u_size_t:new a.b7(_,n.u_size_t),u_size:new a.b7(_,n.u_size),u_camera_to_center_distance:new a.b7(_,n.u_camera_to_center_distance),u_pitch:new a.b7(_,n.u_pitch),u_rotate_symbol:new a.bE(_,n.u_rotate_symbol),u_aspect_ratio:new a.b7(_,n.u_aspect_ratio),u_fade_change:new a.b7(_,n.u_fade_change),u_label_plane_matrix:new a.bG(_,n.u_label_plane_matrix),u_coord_matrix:new a.bG(_,n.u_coord_matrix),u_is_text:new a.bE(_,n.u_is_text),u_pitch_with_map:new a.bE(_,n.u_pitch_with_map),u_is_along_line:new a.bE(_,n.u_is_along_line),u_is_variable_anchor:new a.bE(_,n.u_is_variable_anchor),u_texsize:new a.bJ(_,n.u_texsize),u_texture:new a.bE(_,n.u_texture),u_translation:new a.bJ(_,n.u_translation),u_pitched_scale:new a.b7(_,n.u_pitched_scale)}),symbolSDF:(_,n)=>({u_is_size_zoom_constant:new a.bE(_,n.u_is_size_zoom_constant),u_is_size_feature_constant:new a.bE(_,n.u_is_size_feature_constant),u_size_t:new a.b7(_,n.u_size_t),u_size:new a.b7(_,n.u_size),u_camera_to_center_distance:new a.b7(_,n.u_camera_to_center_distance),u_pitch:new a.b7(_,n.u_pitch),u_rotate_symbol:new a.bE(_,n.u_rotate_symbol),u_aspect_ratio:new a.b7(_,n.u_aspect_ratio),u_fade_change:new a.b7(_,n.u_fade_change),u_label_plane_matrix:new a.bG(_,n.u_label_plane_matrix),u_coord_matrix:new a.bG(_,n.u_coord_matrix),u_is_text:new a.bE(_,n.u_is_text),u_pitch_with_map:new a.bE(_,n.u_pitch_with_map),u_is_along_line:new a.bE(_,n.u_is_along_line),u_is_variable_anchor:new a.bE(_,n.u_is_variable_anchor),u_texsize:new a.bJ(_,n.u_texsize),u_texture:new a.bE(_,n.u_texture),u_gamma_scale:new a.b7(_,n.u_gamma_scale),u_device_pixel_ratio:new a.b7(_,n.u_device_pixel_ratio),u_is_halo:new a.bE(_,n.u_is_halo),u_translation:new a.bJ(_,n.u_translation),u_pitched_scale:new a.b7(_,n.u_pitched_scale)}),symbolTextAndIcon:(_,n)=>({u_is_size_zoom_constant:new a.bE(_,n.u_is_size_zoom_constant),u_is_size_feature_constant:new a.bE(_,n.u_is_size_feature_constant),u_size_t:new a.b7(_,n.u_size_t),u_size:new a.b7(_,n.u_size),u_camera_to_center_distance:new a.b7(_,n.u_camera_to_center_distance),u_pitch:new a.b7(_,n.u_pitch),u_rotate_symbol:new a.bE(_,n.u_rotate_symbol),u_aspect_ratio:new a.b7(_,n.u_aspect_ratio),u_fade_change:new a.b7(_,n.u_fade_change),u_label_plane_matrix:new a.bG(_,n.u_label_plane_matrix),u_coord_matrix:new a.bG(_,n.u_coord_matrix),u_is_text:new a.bE(_,n.u_is_text),u_pitch_with_map:new a.bE(_,n.u_pitch_with_map),u_is_along_line:new a.bE(_,n.u_is_along_line),u_is_variable_anchor:new a.bE(_,n.u_is_variable_anchor),u_texsize:new a.bJ(_,n.u_texsize),u_texsize_icon:new a.bJ(_,n.u_texsize_icon),u_texture:new a.bE(_,n.u_texture),u_texture_icon:new a.bE(_,n.u_texture_icon),u_gamma_scale:new a.b7(_,n.u_gamma_scale),u_device_pixel_ratio:new a.b7(_,n.u_device_pixel_ratio),u_is_halo:new a.bE(_,n.u_is_halo),u_translation:new a.bJ(_,n.u_translation),u_pitched_scale:new a.b7(_,n.u_pitched_scale)}),background:(_,n)=>({u_opacity:new a.b7(_,n.u_opacity),u_color:new a.bF(_,n.u_color)}),backgroundPattern:(_,n)=>({u_opacity:new a.b7(_,n.u_opacity),u_image:new a.bE(_,n.u_image),u_pattern_tl_a:new a.bJ(_,n.u_pattern_tl_a),u_pattern_br_a:new a.bJ(_,n.u_pattern_br_a),u_pattern_tl_b:new a.bJ(_,n.u_pattern_tl_b),u_pattern_br_b:new a.bJ(_,n.u_pattern_br_b),u_texsize:new a.bJ(_,n.u_texsize),u_mix:new a.b7(_,n.u_mix),u_pattern_size_a:new a.bJ(_,n.u_pattern_size_a),u_pattern_size_b:new a.bJ(_,n.u_pattern_size_b),u_scale_a:new a.b7(_,n.u_scale_a),u_scale_b:new a.b7(_,n.u_scale_b),u_pixel_coord_upper:new a.bJ(_,n.u_pixel_coord_upper),u_pixel_coord_lower:new a.bJ(_,n.u_pixel_coord_lower),u_tile_units_to_pixels:new a.b7(_,n.u_tile_units_to_pixels)}),terrain:(_,n)=>({u_texture:new a.bE(_,n.u_texture),u_ele_delta:new a.b7(_,n.u_ele_delta),u_fog_matrix:new a.bG(_,n.u_fog_matrix),u_fog_color:new a.bF(_,n.u_fog_color),u_fog_ground_blend:new a.b7(_,n.u_fog_ground_blend),u_fog_ground_blend_opacity:new a.b7(_,n.u_fog_ground_blend_opacity),u_horizon_color:new a.bF(_,n.u_horizon_color),u_horizon_fog_blend:new a.b7(_,n.u_horizon_fog_blend),u_is_globe_mode:new a.b7(_,n.u_is_globe_mode)}),terrainDepth:(_,n)=>({u_ele_delta:new a.b7(_,n.u_ele_delta)}),terrainCoords:(_,n)=>({u_texture:new a.bE(_,n.u_texture),u_terrain_coords_id:new a.b7(_,n.u_terrain_coords_id),u_ele_delta:new a.b7(_,n.u_ele_delta)}),projectionErrorMeasurement:(_,n)=>({u_input:new a.b7(_,n.u_input),u_output_expected:new a.b7(_,n.u_output_expected)}),atmosphere:(_,n)=>({u_sun_pos:new a.bI(_,n.u_sun_pos),u_atmosphere_blend:new a.b7(_,n.u_atmosphere_blend),u_globe_position:new a.bI(_,n.u_globe_position),u_globe_radius:new a.b7(_,n.u_globe_radius),u_inv_proj_matrix:new a.bG(_,n.u_inv_proj_matrix)}),sky:(_,n)=>({u_sky_color:new a.bF(_,n.u_sky_color),u_horizon_color:new a.bF(_,n.u_horizon_color),u_horizon:new a.bJ(_,n.u_horizon),u_horizon_normal:new a.bJ(_,n.u_horizon_normal),u_sky_horizon_blend:new a.b7(_,n.u_sky_horizon_blend),u_sky_blend:new a.b7(_,n.u_sky_blend)})};class Kh{constructor(n,l,p){this.context=n;const g=n.gl;this.buffer=g.createBuffer(),this.dynamicDraw=!!p,this.context.unbindVAO(),n.bindElementBuffer.set(this.buffer),g.bufferData(g.ELEMENT_ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?g.DYNAMIC_DRAW:g.STATIC_DRAW),this.dynamicDraw||delete l.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(n){const l=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),l.bufferSubData(l.ELEMENT_ARRAY_BUFFER,0,n.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Yc={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Fs{constructor(n,l,p,g){this.length=l.length,this.attributes=p,this.itemSize=l.bytesPerElement,this.dynamicDraw=g,this.context=n;const x=n.gl;this.buffer=x.createBuffer(),n.bindVertexBuffer.set(this.buffer),x.bufferData(x.ARRAY_BUFFER,l.arrayBuffer,this.dynamicDraw?x.DYNAMIC_DRAW:x.STATIC_DRAW),this.dynamicDraw||delete l.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(n){if(n.length!==this.length)throw new Error(`Length of new data is ${n.length}, which doesn't match current length of ${this.length}`);const l=this.context.gl;this.bind(),l.bufferSubData(l.ARRAY_BUFFER,0,n.arrayBuffer)}enableAttributes(n,l){for(let p=0;p<this.attributes.length;p++){const g=l.attributes[this.attributes[p].name];g!==void 0&&n.enableVertexAttribArray(g)}}setVertexAttribPointers(n,l,p){for(let g=0;g<this.attributes.length;g++){const x=this.attributes[g],T=l.attributes[x.name];T!==void 0&&n.vertexAttribPointer(T,x.components,n[Yc[x.type]],!1,this.itemSize,x.offset+this.itemSize*(p||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class ai{constructor(n){this.gl=n.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(n){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Dp extends ai{getDefault(){return a.b6.transparent}set(n){const l=this.current;(n.r!==l.r||n.g!==l.g||n.b!==l.b||n.a!==l.a||this.dirty)&&(this.gl.clearColor(n.r,n.g,n.b,n.a),this.current=n,this.dirty=!1)}}class Op extends ai{getDefault(){return 1}set(n){(n!==this.current||this.dirty)&&(this.gl.clearDepth(n),this.current=n,this.dirty=!1)}}class Lp extends ai{getDefault(){return 0}set(n){(n!==this.current||this.dirty)&&(this.gl.clearStencil(n),this.current=n,this.dirty=!1)}}class Fp extends ai{getDefault(){return[!0,!0,!0,!0]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||n[2]!==l[2]||n[3]!==l[3]||this.dirty)&&(this.gl.colorMask(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class Jh extends ai{getDefault(){return!0}set(n){(n!==this.current||this.dirty)&&(this.gl.depthMask(n),this.current=n,this.dirty=!1)}}class Bp extends ai{getDefault(){return 255}set(n){(n!==this.current||this.dirty)&&(this.gl.stencilMask(n),this.current=n,this.dirty=!1)}}class Qh extends ai{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(n){const l=this.current;(n.func!==l.func||n.ref!==l.ref||n.mask!==l.mask||this.dirty)&&(this.gl.stencilFunc(n.func,n.ref,n.mask),this.current=n,this.dirty=!1)}}class ll extends ai{getDefault(){const n=this.gl;return[n.KEEP,n.KEEP,n.KEEP]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||n[2]!==l[2]||this.dirty)&&(this.gl.stencilOp(n[0],n[1],n[2]),this.current=n,this.dirty=!1)}}class cl extends ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;n?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),this.current=n,this.dirty=!1}}class ul extends ai{getDefault(){return[0,1]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||this.dirty)&&(this.gl.depthRange(n[0],n[1]),this.current=n,this.dirty=!1)}}class Kc extends ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;n?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),this.current=n,this.dirty=!1}}class Bs extends ai{getDefault(){return this.gl.LESS}set(n){(n!==this.current||this.dirty)&&(this.gl.depthFunc(n),this.current=n,this.dirty=!1)}}class _o extends ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;n?l.enable(l.BLEND):l.disable(l.BLEND),this.current=n,this.dirty=!1}}class Jr extends ai{getDefault(){const n=this.gl;return[n.ONE,n.ZERO]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||this.dirty)&&(this.gl.blendFunc(n[0],n[1]),this.current=n,this.dirty=!1)}}class ed extends ai{getDefault(){return a.b6.transparent}set(n){const l=this.current;(n.r!==l.r||n.g!==l.g||n.b!==l.b||n.a!==l.a||this.dirty)&&(this.gl.blendColor(n.r,n.g,n.b,n.a),this.current=n,this.dirty=!1)}}class td extends ai{getDefault(){return this.gl.FUNC_ADD}set(n){(n!==this.current||this.dirty)&&(this.gl.blendEquation(n),this.current=n,this.dirty=!1)}}class Jc extends ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;n?l.enable(l.CULL_FACE):l.disable(l.CULL_FACE),this.current=n,this.dirty=!1}}class Ns extends ai{getDefault(){return this.gl.BACK}set(n){(n!==this.current||this.dirty)&&(this.gl.cullFace(n),this.current=n,this.dirty=!1)}}class hl extends ai{getDefault(){return this.gl.CCW}set(n){(n!==this.current||this.dirty)&&(this.gl.frontFace(n),this.current=n,this.dirty=!1)}}class dl extends ai{getDefault(){return null}set(n){(n!==this.current||this.dirty)&&(this.gl.useProgram(n),this.current=n,this.dirty=!1)}}class sa extends ai{getDefault(){return this.gl.TEXTURE0}set(n){(n!==this.current||this.dirty)&&(this.gl.activeTexture(n),this.current=n,this.dirty=!1)}}class fl extends ai{getDefault(){const n=this.gl;return[0,0,n.drawingBufferWidth,n.drawingBufferHeight]}set(n){const l=this.current;(n[0]!==l[0]||n[1]!==l[1]||n[2]!==l[2]||n[3]!==l[3]||this.dirty)&&(this.gl.viewport(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class id extends ai{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.bindFramebuffer(l.FRAMEBUFFER,n),this.current=n,this.dirty=!1}}class yo extends ai{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.bindRenderbuffer(l.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class xo extends ai{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.bindTexture(l.TEXTURE_2D,n),this.current=n,this.dirty=!1}}class rd extends ai{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.bindBuffer(l.ARRAY_BUFFER,n),this.current=n,this.dirty=!1}}class Qc extends ai{getDefault(){return null}set(n){const l=this.gl;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,n),this.current=n,this.dirty=!1}}class si extends ai{getDefault(){return null}set(n){var l;if(n===this.current&&!this.dirty)return;const p=this.gl;Kr(p)?p.bindVertexArray(n):(l=p.getExtension("OES_vertex_array_object"))===null||l===void 0||l.bindVertexArrayOES(n),this.current=n,this.dirty=!1}}class pl extends ai{getDefault(){return 4}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_ALIGNMENT,n),this.current=n,this.dirty=!1}}class Np extends ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n),this.current=n,this.dirty=!1}}class nd extends ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const l=this.gl;l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,n),this.current=n,this.dirty=!1}}class zs extends ai{constructor(n,l){super(n),this.context=n,this.parent=l}getDefault(){return null}}class zp extends zs{setDirty(){this.dirty=!0}set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,n,0),this.current=n,this.dirty=!1}}class Up extends zs{set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,l.DEPTH_ATTACHMENT,l.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class sd extends zs{set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const l=this.gl;l.framebufferRenderbuffer(l.FRAMEBUFFER,l.DEPTH_STENCIL_ATTACHMENT,l.RENDERBUFFER,n),this.current=n,this.dirty=!1}}const od="Framebuffer is not complete";class eu{constructor(n,l,p,g,x){this.context=n,this.width=l,this.height=p;const T=n.gl,A=this.framebuffer=T.createFramebuffer();if(this.colorAttachment=new zp(n,A),g)this.depthAttachment=x?new sd(n,A):new Up(n,A);else if(x)throw new Error("Stencil cannot be set without depth");if(T.checkFramebufferStatus(T.FRAMEBUFFER)!==T.FRAMEBUFFER_COMPLETE)throw new Error(od)}destroy(){const n=this.context.gl,l=this.colorAttachment.get();if(l&&n.deleteTexture(l),this.depthAttachment){const p=this.depthAttachment.get();p&&n.deleteRenderbuffer(p)}n.deleteFramebuffer(this.framebuffer)}}class gl{constructor(n){var l,p;if(this.gl=n,this.clearColor=new Dp(this),this.clearDepth=new Op(this),this.clearStencil=new Lp(this),this.colorMask=new Fp(this),this.depthMask=new Jh(this),this.stencilMask=new Bp(this),this.stencilFunc=new Qh(this),this.stencilOp=new ll(this),this.stencilTest=new cl(this),this.depthRange=new ul(this),this.depthTest=new Kc(this),this.depthFunc=new Bs(this),this.blend=new _o(this),this.blendFunc=new Jr(this),this.blendColor=new ed(this),this.blendEquation=new td(this),this.cullFace=new Jc(this),this.cullFaceSide=new Ns(this),this.frontFace=new hl(this),this.program=new dl(this),this.activeTexture=new sa(this),this.viewport=new fl(this),this.bindFramebuffer=new id(this),this.bindRenderbuffer=new yo(this),this.bindTexture=new xo(this),this.bindVertexBuffer=new rd(this),this.bindElementBuffer=new Qc(this),this.bindVertexArray=new si(this),this.pixelStoreUnpack=new pl(this),this.pixelStoreUnpackPremultiplyAlpha=new Np(this),this.pixelStoreUnpackFlipY=new nd(this),this.extTextureFilterAnisotropic=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=n.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=n.getParameter(n.MAX_TEXTURE_SIZE),Kr(n)){this.HALF_FLOAT=n.HALF_FLOAT;const g=n.getExtension("EXT_color_buffer_half_float");this.RGBA16F=(l=n.RGBA16F)!==null&&l!==void 0?l:g?.RGBA16F_EXT,this.RGB16F=(p=n.RGB16F)!==null&&p!==void 0?p:g?.RGB16F_EXT,n.getExtension("EXT_color_buffer_float")}else{n.getExtension("EXT_color_buffer_half_float"),n.getExtension("OES_texture_half_float_linear");const g=n.getExtension("OES_texture_half_float");this.HALF_FLOAT=g?.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(n,l){return new Kh(this,n,l)}createVertexBuffer(n,l,p){return new Fs(this,n,l,p)}createRenderbuffer(n,l,p){const g=this.gl,x=g.createRenderbuffer();return this.bindRenderbuffer.set(x),g.renderbufferStorage(g.RENDERBUFFER,n,l,p),this.bindRenderbuffer.set(null),x}createFramebuffer(n,l,p,g){return new eu(this,n,l,p,g)}clear({color:n,depth:l,stencil:p}){const g=this.gl;let x=0;n&&(x|=g.COLOR_BUFFER_BIT,this.clearColor.set(n),this.colorMask.set([!0,!0,!0,!0])),l!==void 0&&(x|=g.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(l),this.depthMask.set(!0)),p!==void 0&&(x|=g.STENCIL_BUFFER_BIT,this.clearStencil.set(p),this.stencilMask.set(255)),g.clear(x)}setCullFace(n){n.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(n.mode),this.frontFace.set(n.frontFace))}setDepthMode(n){n.func!==this.gl.ALWAYS||n.mask?(this.depthTest.set(!0),this.depthFunc.set(n.func),this.depthMask.set(n.mask),this.depthRange.set(n.range)):this.depthTest.set(!1)}setStencilMode(n){n.test.func!==this.gl.ALWAYS||n.mask?(this.stencilTest.set(!0),this.stencilMask.set(n.mask),this.stencilOp.set([n.fail,n.depthFail,n.pass]),this.stencilFunc.set({func:n.test.func,ref:n.ref,mask:n.test.mask})):this.stencilTest.set(!1)}setColorMode(n){a.bB(n.blendFunction,Pi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(n.blendFunction),this.blendColor.set(n.blendColor)),this.colorMask.set(n.mask)}createVertexArray(){var n;return Kr(this.gl)?this.gl.createVertexArray():(n=this.gl.getExtension("OES_vertex_array_object"))===null||n===void 0?void 0:n.createVertexArrayOES()}deleteVertexArray(n){var l;return Kr(this.gl)?this.gl.deleteVertexArray(n):(l=this.gl.getExtension("OES_vertex_array_object"))===null||l===void 0?void 0:l.deleteVertexArrayOES(n)}unbindVAO(){this.bindVertexArray.set(null)}}let Us;function ml(_,n,l,p,g){const x=_.context,T=_.transform,A=x.gl,C=_.useProgram("collisionBox"),R=[];let L=0,N=0;for(let le=0;le<p.length;le++){const he=p[le],xe=n.getTile(he).getBucket(l);if(!xe)continue;const ve=g?xe.textCollisionBox:xe.iconCollisionBox,Pe=xe.collisionCircleArray;Pe.length>0&&(R.push({circleArray:Pe,circleOffset:N,coord:he}),L+=Pe.length/4,N=L),ve&&C.draw(x,A.LINES,$t.disabled,ti.disabled,_.colorModeForRenderPass(),Qt.disabled,jc(_.transform),_.style.map.terrain&&_.style.map.terrain.getTerrainData(he),T.getProjectionData({overscaledTileID:he,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),l.id,ve.layoutVertexBuffer,ve.indexBuffer,ve.segments,null,_.transform.zoom,null,null,ve.collisionVertexBuffer)}if(!g||!R.length)return;const z=_.useProgram("collisionCircle"),H=new a.bO;H.resize(4*L),H._trim();let q=0;for(const le of R)for(let he=0;he<le.circleArray.length/4;he++){const xe=4*he,ve=le.circleArray[xe+0],Pe=le.circleArray[xe+1],Re=le.circleArray[xe+2],Ie=le.circleArray[xe+3];H.emplace(q++,ve,Pe,Re,Ie,0),H.emplace(q++,ve,Pe,Re,Ie,1),H.emplace(q++,ve,Pe,Re,Ie,2),H.emplace(q++,ve,Pe,Re,Ie,3)}(!Us||Us.length<2*L)&&(Us=(function(le){const he=2*le,xe=new a.bQ;xe.resize(he),xe._trim();for(let ve=0;ve<he;ve++){const Pe=6*ve;xe.uint16[Pe+0]=4*ve+0,xe.uint16[Pe+1]=4*ve+1,xe.uint16[Pe+2]=4*ve+2,xe.uint16[Pe+3]=4*ve+2,xe.uint16[Pe+4]=4*ve+3,xe.uint16[Pe+5]=4*ve+0}return xe})(L));const se=x.createIndexBuffer(Us,!0),ne=x.createVertexBuffer(H,a.bP.members,!0);for(const le of R){const he=Hh(_.transform);z.draw(x,A.TRIANGLES,$t.disabled,ti.disabled,_.colorModeForRenderPass(),Qt.disabled,he,_.style.map.terrain&&_.style.map.terrain.getTerrainData(le.coord),null,l.id,ne,se,a.aF.simpleSegment(0,2*le.circleOffset,le.circleArray.length,le.circleArray.length/2),null,_.transform.zoom,null,null,null)}ne.destroy(),se.destroy()}const tu=a.as(new Float32Array(16));function ad(_,n,l,p,g,x){const{horizontalAlign:T,verticalAlign:A}=a.aA(_);return new a.P((-(T-.5)*n/g+p[0])*x,(-(A-.5)*l/g+p[1])*x)}function _l(_,n,l,p,g,x){const T=n.tileAnchorPoint.add(new a.P(n.translation[0],n.translation[1]));if(n.pitchWithMap){let A=p.mult(x);l||(A=A.rotate(-g));const C=T.add(A);return Ke(C.x,C.y,n.pitchedLabelPlaneMatrix,n.getElevation).point}if(l){const A=At(n.tileAnchorPoint.x+1,n.tileAnchorPoint.y,n).point.sub(_),C=Math.atan(A.y/A.x)+(A.x<0?Math.PI:0);return _.add(p.rotate(C))}return _.add(p)}function yl(_,n,l,p,g,x,T,A,C,R,L,N){const z=_.text.placedSymbolArray,H=_.text.dynamicLayoutVertexArray,q=_.icon.dynamicLayoutVertexArray,se={};H.clear();for(let ne=0;ne<z.length;ne++){const le=z.get(ne),he=le.hidden||!le.crossTileID||_.allowVerticalPlacement&&!le.placedOrientation?null:p[le.crossTileID];if(he){const xe=new a.P(le.anchorX,le.anchorY),ve={getElevation:N,width:g.width,height:g.height,pitchedLabelPlaneMatrix:x,pitchWithMap:l,transform:g,tileAnchorPoint:xe,translation:R,unwrappedTileID:L},Pe=l?Ht(xe.x,xe.y,ve):At(xe.x,xe.y,ve),Re=ze(g.cameraToCenterDistance,Pe.signedDistanceFromCamera);let Ie=a.ah(_.textSizeData,A,le)*Re/a.au;l&&(Ie*=_.tilePixelRatio/T);const{width:$e,height:He,anchor:it,textOffset:nt,textBoxScale:et}=he,xt=ad(it,$e,He,nt,et,Ie),yt=g.getPitchedTextCorrection(xe.x+R[0],xe.y+R[1],L),ct=_l(Pe.point,ve,n,xt,-g.bearingInRadians,yt),Pt=_.allowVerticalPlacement&&le.placedOrientation===a.ag.vertical?Math.PI/2:0;for(let Rt=0;Rt<le.numGlyphs;Rt++)a.an(H,ct,Pt);C&&le.associatedIconIndex>=0&&(se[le.associatedIconIndex]={shiftedAnchor:ct,angle:Pt})}else ji(le.numGlyphs,H)}if(C){q.clear();const ne=_.icon.placedSymbolArray;for(let le=0;le<ne.length;le++){const he=ne.get(le);if(he.hidden)ji(he.numGlyphs,q);else{const xe=se[le];if(xe)for(let ve=0;ve<he.numGlyphs;ve++)a.an(q,xe.shiftedAnchor,xe.angle);else ji(he.numGlyphs,q)}}_.icon.dynamicLayoutVertexBuffer.updateData(q)}_.text.dynamicLayoutVertexBuffer.updateData(H)}function iu(_,n,l){return l.iconsInText&&n?"symbolTextAndIcon":_?"symbolSDF":"symbolIcon"}function ld(_,n,l,p,g,x,T,A,C,R,L,N,z){const H=_.context,q=H.gl,se=_.transform,ne=A==="map",le=C==="map",he=A!=="viewport"&&l.layout.get("symbol-placement")!=="point",xe=ne&&!le&&!he,ve=!l.layout.get("symbol-sort-key").isConstant();let Pe=!1;const Re=_.getDepthModeForSublayer(0,$t.ReadOnly),Ie=l._unevaluatedLayout.hasValue("text-variable-anchor")||l._unevaluatedLayout.hasValue("text-variable-anchor-offset"),$e=[],He=se.getCircleRadiusCorrection();for(const it of p){const nt=n.getTile(it),et=nt.getBucket(l);if(!et)continue;const xt=g?et.text:et.icon;if(!xt||!xt.segments.get().length||!xt.hasVisibleVertices)continue;const yt=xt.programConfigurations.get(l.id),ct=g||et.sdfIcons,Pt=g?et.textSizeData:et.iconSizeData,Rt=le||se.pitch!==0,li=_.useProgram(iu(ct,g,et),yt),xi=a.af(Pt,se.zoom),fi=_.style.map.terrain&&_.style.map.terrain.getTerrainData(it);let Ii,wi,ui,pi,ir=[0,0],rr=null;if(g)wi=nt.glyphAtlasTexture,ui=q.LINEAR,Ii=nt.glyphAtlasTexture.size,et.iconsInText&&(ir=nt.imageAtlasTexture.size,rr=nt.imageAtlasTexture,pi=Rt||_.options.rotating||_.options.zooming||Pt.kind==="composite"||Pt.kind==="camera"?q.LINEAR:q.NEAREST);else{const vi=l.layout.get("icon-size").constantOr(0)!==1||et.iconsNeedLinear;wi=nt.imageAtlasTexture,ui=ct||_.options.rotating||_.options.zooming||vi||Rt?q.LINEAR:q.NEAREST,Ii=nt.imageAtlasTexture.size}const Xi=a.av(nt,1,_.transform.zoom),fr=qe(ne,_.transform,Xi),ps=a.K();a.ai(ps,fr);const $n=De(le,ne,_.transform,Xi),An=a.aw(se,nt,x,T),tn=se.getProjectionData({overscaledTileID:it,applyGlobeMatrix:!z,applyTerrainMatrix:!0}),Zs=Ie&&et.hasTextData(),ma=l.layout.get("icon-text-fit")!=="none"&&Zs&&et.hasIconData();if(he){const vi=_.style.map.terrain?(Gi,Yi)=>_.style.map.terrain.getElevation(it,Gi,Yi):null,_i=l.layout.get("text-rotation-alignment")==="map";Ue(et,_,g,fr,ps,le,R,_i,it.toUnwrapped(),se.width,se.height,An,vi)}const qs=g&&Ie||ma,rn=he||qs?tu:le?fr:_.transform.clipSpaceToPixelsMatrix,Pn=ct&&l.paint.get(g?"text-halo-width":"icon-halo-width").constantOr(1)!==0;let un;un=ct?et.iconsInText?ol(Pt.kind,xi,xe,le,he,qs,_,rn,$n,An,Ii,ir,He):qc(Pt.kind,xi,xe,le,he,qs,_,rn,$n,An,g,Ii,0,He):sl(Pt.kind,xi,xe,le,he,qs,_,rn,$n,An,g,Ii,He);const Cn={program:li,buffers:xt,uniformValues:un,projectionData:tn,atlasTexture:wi,atlasTextureIcon:rr,atlasInterpolation:ui,atlasInterpolationIcon:pi,isSDF:ct,hasHalo:Pn};if(ve&&et.canOverlap){Pe=!0;const vi=xt.segments.get();for(const _i of vi)$e.push({segments:new a.aF([_i]),sortKey:_i.sortKey,state:Cn,terrainData:fi})}else $e.push({segments:xt.segments,sortKey:0,state:Cn,terrainData:fi})}Pe&&$e.sort(((it,nt)=>it.sortKey-nt.sortKey));for(const it of $e){const nt=it.state;if(H.activeTexture.set(q.TEXTURE0),nt.atlasTexture.bind(nt.atlasInterpolation,q.CLAMP_TO_EDGE),nt.atlasTextureIcon&&(H.activeTexture.set(q.TEXTURE1),nt.atlasTextureIcon&&nt.atlasTextureIcon.bind(nt.atlasInterpolationIcon,q.CLAMP_TO_EDGE)),nt.isSDF){const et=nt.uniformValues;nt.hasHalo&&(et.u_is_halo=1,xl(nt.buffers,it.segments,l,_,nt.program,Re,L,N,et,nt.projectionData,it.terrainData)),et.u_is_halo=0}xl(nt.buffers,it.segments,l,_,nt.program,Re,L,N,nt.uniformValues,nt.projectionData,it.terrainData)}}function xl(_,n,l,p,g,x,T,A,C,R,L){const N=p.context;g.draw(N,N.gl.TRIANGLES,x,T,A,Qt.backCCW,C,L,R,l.id,_.layoutVertexBuffer,_.indexBuffer,n,l.paint,p.transform.zoom,_.programConfigurations.get(l.id),_.dynamicLayoutVertexBuffer,_.opacityVertexBuffer)}function Vp(_,n,l,p,g){const x=_.context,T=x.gl,A=ti.disabled,C=new Pi([T.ONE,T.ONE],a.b6.transparent,[!0,!0,!0,!0]),R=n.getBucket(l);if(!R)return;const L=p.key;let N=l.heatmapFbos.get(L);N||(N=oa(x,n.tileSize,n.tileSize),l.heatmapFbos.set(L,N)),x.bindFramebuffer.set(N.framebuffer),x.viewport.set([0,0,n.tileSize,n.tileSize]),x.clear({color:a.b6.transparent});const z=R.programConfigurations.get(l.id),H=_.useProgram("heatmap",z,!g),q=_.transform.getProjectionData({overscaledTileID:n.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),se=_.style.map.terrain.getTerrainData(p);H.draw(x,T.TRIANGLES,$t.disabled,A,C,Qt.disabled,Wc(n,_.transform.zoom,l.paint.get("heatmap-intensity"),1),se,q,l.id,R.layoutVertexBuffer,R.indexBuffer,R.segments,l.paint,_.transform.zoom,z)}function cd(_,n,l,p,g){const x=_.context,T=x.gl,A=_.transform;x.setColorMode(_.colorModeForRenderPass());const C=vl(x,n),R=l.key,L=n.heatmapFbos.get(R);if(!L)return;x.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,L.colorAttachment.get()),x.activeTexture.set(T.TEXTURE1),C.bind(T.LINEAR,T.CLAMP_TO_EDGE);const N=A.getProjectionData({overscaledTileID:l,applyTerrainMatrix:g,applyGlobeMatrix:!p});_.useProgram("heatmapTexture").draw(x,T.TRIANGLES,$t.disabled,ti.disabled,_.colorModeForRenderPass(),Qt.disabled,Hc(_,n,0,1),null,N,n.id,_.rasterBoundsBuffer,_.quadTriangleIndexBuffer,_.rasterBoundsSegments,n.paint,A.zoom),L.destroy(),n.heatmapFbos.delete(R)}function oa(_,n,l){var p,g;const x=_.gl,T=x.createTexture();x.bindTexture(x.TEXTURE_2D,T),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.LINEAR),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.LINEAR);const A=(p=_.HALF_FLOAT)!==null&&p!==void 0?p:x.UNSIGNED_BYTE,C=(g=_.RGBA16F)!==null&&g!==void 0?g:x.RGBA;x.texImage2D(x.TEXTURE_2D,0,C,n,l,0,x.RGBA,A,null);const R=_.createFramebuffer(n,l,!1,!1);return R.colorAttachment.set(T),R}function vl(_,n){return n.colorRampTexture||(n.colorRampTexture=new G(_,n.colorRamp,_.gl.RGBA)),n.colorRampTexture}function ru(_,n,l,p,g){if(!l||!p||!p.imageAtlas)return;const x=p.imageAtlas.patternPositions;let T=x[l.to.toString()],A=x[l.from.toString()];if(!T&&A&&(T=A),!A&&T&&(A=T),!T||!A){const C=g.getPaintProperty(n);T=x[C],A=x[C]}T&&A&&_.setConstantPatternPositions(T,A)}function nu(_,n,l,p,g,x,T,A){const C=_.context.gl,R="fill-pattern",L=l.paint.get(R),N=L&&L.constantOr(1),z=l.getCrossfadeParameters();let H,q,se,ne,le;const he=_.transform,xe=l.paint.get("fill-translate"),ve=l.paint.get("fill-translate-anchor");T?(q=N&&!l.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",H=C.LINES):(q=N?"fillPattern":"fill",H=C.TRIANGLES);const Pe=L.constantOr(null);for(const Re of p){const Ie=n.getTile(Re);if(N&&!Ie.patternsLoaded())continue;const $e=Ie.getBucket(l);if(!$e)continue;const He=$e.programConfigurations.get(l.id),it=_.useProgram(q,He),nt=_.style.map.terrain&&_.style.map.terrain.getTerrainData(Re);N&&(_.context.activeTexture.set(C.TEXTURE0),Ie.imageAtlasTexture.bind(C.LINEAR,C.CLAMP_TO_EDGE),He.updatePaintBuffers(z)),ru(He,R,Pe,Ie,l);const et=he.getProjectionData({overscaledTileID:Re,applyGlobeMatrix:!A,applyTerrainMatrix:!0}),xt=a.aw(he,Ie,xe,ve);if(T){ne=$e.indexBuffer2,le=$e.segments2;const ct=[C.drawingBufferWidth,C.drawingBufferHeight];se=q==="fillOutlinePattern"&&N?Mp(_,z,Ie,ct,xt):$h(ct,xt)}else ne=$e.indexBuffer,le=$e.segments,se=N?jh(_,z,Ie,xt):{u_fill_translate:xt};let yt;if(_.renderPass==="translucent"&&A){const[ct]=_.getStencilConfigForOverlapAndUpdateStencilID(p);yt=ct[Re.overscaledZ]}else yt=_.stencilModeForClipping(Re);it.draw(_.context,H,g,yt,x,Qt.backCCW,se,nt,et,l.id,$e.layoutVertexBuffer,ne,le,l.paint,_.transform.zoom,He)}}function vo(_,n,l,p,g,x,T,A){const C=_.context,R=C.gl,L="fill-extrusion-pattern",N=l.paint.get(L),z=N.constantOr(1),H=l.getCrossfadeParameters(),q=l.paint.get("fill-extrusion-opacity"),se=N.constantOr(null),ne=_.transform;for(const le of p){const he=n.getTile(le),xe=he.getBucket(l);if(!xe)continue;const ve=_.style.map.terrain&&_.style.map.terrain.getTerrainData(le),Pe=xe.programConfigurations.get(l.id),Re=_.useProgram(z?"fillExtrusionPattern":"fillExtrusion",Pe);z&&(_.context.activeTexture.set(R.TEXTURE0),he.imageAtlasTexture.bind(R.LINEAR,R.CLAMP_TO_EDGE),Pe.updatePaintBuffers(H));const Ie=ne.getProjectionData({overscaledTileID:le,applyGlobeMatrix:!A,applyTerrainMatrix:!0});ru(Pe,L,se,he,l);const $e=a.aw(ne,he,l.paint.get("fill-extrusion-translate"),l.paint.get("fill-extrusion-translate-anchor")),He=l.paint.get("fill-extrusion-vertical-gradient"),it=z?mo(_,He,q,$e,le,H,he):Vh(_,He,q,$e);Re.draw(C,C.gl.TRIANGLES,g,x,T,Qt.backCCW,it,ve,Ie,l.id,xe.layoutVertexBuffer,xe.indexBuffer,xe.segments,l.paint,_.transform.zoom,Pe,_.style.map.terrain&&xe.centroidVertexBuffer)}}function aa(_,n,l,p,g,x,T,A,C){var R;const L=_.style.projection,N=_.context,z=_.transform,H=N.gl,q=_.useProgram("hillshade"),se=!_.options.moving;for(const ne of p){const le=n.getTile(ne),he=le.fbo;if(!he)continue;const xe=L.getMeshFromTileID(N,ne.canonical,A,!0,"raster"),ve=(R=_.style.map.terrain)===null||R===void 0?void 0:R.getTerrainData(ne);N.activeTexture.set(H.TEXTURE0),H.bindTexture(H.TEXTURE_2D,he.colorAttachment.get());const Pe=z.getProjectionData({overscaledTileID:ne,aligned:se,applyGlobeMatrix:!C,applyTerrainMatrix:!0});q.draw(N,H.TRIANGLES,x,g[ne.overscaledZ],T,Qt.backCCW,Os(_,le,l),ve,Pe,l.id,xe.vertexBuffer,xe.indexBuffer,xe.segments)}}const su=[new a.P(0,0),new a.P(a.Z,0),new a.P(a.Z,a.Z),new a.P(0,a.Z)];function la(_,n,l,p,g,x,T,A,C=!1,R=!1){const L=p[p.length-1].overscaledZ,N=_.context,z=N.gl,H=_.useProgram("raster"),q=_.transform,se=_.style.projection,ne=_.colorModeForRenderPass(),le=!_.options.moving;for(const he of p){const xe=_.getDepthModeForSublayer(he.overscaledZ-L,l.paint.get("raster-opacity")===1?$t.ReadWrite:$t.ReadOnly,z.LESS),ve=n.getTile(he);ve.registerFadeDuration(l.paint.get("raster-fade-duration"));const Pe=n.findLoadedParent(he,0),Re=n.findLoadedSibling(he),Ie=Fi(ve,Pe||Re||null,n,l,_.transform,_.style.map.terrain);let $e,He;const it=l.paint.get("raster-resampling")==="nearest"?z.NEAREST:z.LINEAR;N.activeTexture.set(z.TEXTURE0),ve.texture.bind(it,z.CLAMP_TO_EDGE,z.LINEAR_MIPMAP_NEAREST),N.activeTexture.set(z.TEXTURE1),Pe?(Pe.texture.bind(it,z.CLAMP_TO_EDGE,z.LINEAR_MIPMAP_NEAREST),$e=Math.pow(2,Pe.tileID.overscaledZ-ve.tileID.overscaledZ),He=[ve.tileID.canonical.x*$e%1,ve.tileID.canonical.y*$e%1]):ve.texture.bind(it,z.CLAMP_TO_EDGE,z.LINEAR_MIPMAP_NEAREST),ve.texture.useMipmap&&N.extTextureFilterAnisotropic&&_.transform.pitch>20&&z.texParameterf(z.TEXTURE_2D,N.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,N.extTextureFilterAnisotropicMax);const nt=_.style.map.terrain&&_.style.map.terrain.getTerrainData(he),et=q.getProjectionData({overscaledTileID:he,aligned:le,applyGlobeMatrix:!R,applyTerrainMatrix:!0}),xt=Gh(He||[0,0],$e||1,Ie,l,A),yt=se.getMeshFromTileID(N,he.canonical,x,T,"raster");H.draw(N,z.TRIANGLES,xe,g?g[he.overscaledZ]:ti.disabled,ne,C?Qt.frontCCW:Qt.backCCW,xt,nt,et,l.id,yt.vertexBuffer,yt.indexBuffer,yt.segments)}}function Fi(_,n,l,p,g,x){const T=p.paint.get("raster-fade-duration");if(!x&&T>0){const A=D.now(),C=(A-_.timeAdded)/T,R=n?(A-n.timeAdded)/T:-1,L=l.getSource(),N=Un(g,{tileSize:L.tileSize,roundZoom:L.roundZoom}),z=!n||Math.abs(n.tileID.overscaledZ-N)>Math.abs(_.tileID.overscaledZ-N),H=z&&_.refreshedUponExpiration?1:a.ad(z?C:1-R,0,1);return _.refreshedUponExpiration&&C>=1&&(_.refreshedUponExpiration=!1),n?{opacity:1,mix:1-H}:{opacity:H,mix:0}}return{opacity:1,mix:0}}const Vs=new a.b6(1,0,0,1),Qr=new a.b6(0,1,0,1),ou=new a.b6(0,0,1,1),au=new a.b6(1,0,1,1),ud=new a.b6(0,1,1,1);function js(_,n,l,p){wo(_,0,n+l/2,_.transform.width,l,p)}function bo(_,n,l,p){wo(_,n-l/2,0,l,_.transform.height,p)}function wo(_,n,l,p,g,x){const T=_.context,A=T.gl;A.enable(A.SCISSOR_TEST),A.scissor(n*_.pixelRatio,l*_.pixelRatio,p*_.pixelRatio,g*_.pixelRatio),T.clear({color:x}),A.disable(A.SCISSOR_TEST)}function hd(_,n,l){const p=_.context,g=p.gl,x=_.useProgram("debug"),T=$t.disabled,A=ti.disabled,C=_.colorModeForRenderPass(),R="$debug",L=_.style.map.terrain&&_.style.map.terrain.getTerrainData(l);p.activeTexture.set(g.TEXTURE0);const N=n.getTileByID(l.key).latestRawTileData,z=Math.floor((N&&N.byteLength||0)/1024),H=n.getTile(l).tileSize,q=512/Math.min(H,512)*(l.overscaledZ/_.transform.zoom)*.5;let se=l.canonical.toString();l.overscaledZ!==l.canonical.z&&(se+=` => ${l.overscaledZ}`),(function(le,he){le.initDebugOverlayCanvas();const xe=le.debugOverlayCanvas,ve=le.context.gl,Pe=le.debugOverlayCanvas.getContext("2d");Pe.clearRect(0,0,xe.width,xe.height),Pe.shadowColor="white",Pe.shadowBlur=2,Pe.lineWidth=1.5,Pe.strokeStyle="white",Pe.textBaseline="top",Pe.font="bold 36px Open Sans, sans-serif",Pe.fillText(he,5,5),Pe.strokeText(he,5,5),le.debugOverlayTexture.update(xe),le.debugOverlayTexture.bind(ve.LINEAR,ve.CLAMP_TO_EDGE)})(_,`${se} ${z}kB`);const ne=_.transform.getProjectionData({overscaledTileID:l,applyGlobeMatrix:!0,applyTerrainMatrix:!0});x.draw(p,g.TRIANGLES,T,A,Pi.alphaBlended,Qt.disabled,$c(a.b6.transparent,q),null,ne,R,_.debugBuffer,_.quadTriangleIndexBuffer,_.debugSegments),x.draw(p,g.LINE_STRIP,T,A,C,Qt.disabled,$c(a.b6.red),L,ne,R,_.debugBuffer,_.tileBorderIndexBuffer,_.debugSegments)}function lu(_,n,l,p){const{isRenderingGlobe:g}=p,x=_.context,T=x.gl,A=_.transform,C=_.colorModeForRenderPass(),R=_.getDepthModeFor3D(),L=_.useProgram("terrain");x.bindFramebuffer.set(null),x.viewport.set([0,0,_.width,_.height]);for(const N of l){const z=n.getTerrainMesh(N.tileID),H=_.renderToTexture.getTexture(N),q=n.getTerrainData(N.tileID);x.activeTexture.set(T.TEXTURE0),T.bindTexture(T.TEXTURE_2D,H.texture);const se=n.getMeshFrameDelta(A.zoom),ne=A.calculateFogMatrix(N.tileID.toUnwrapped()),le=Vc(se,ne,_.style.sky,A.pitch,g),he=A.getProjectionData({overscaledTileID:N.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});L.draw(x,T.TRIANGLES,R,ti.disabled,C,Qt.backCCW,le,q,he,"terrain",z.vertexBuffer,z.indexBuffer,z.segments)}}function cu(_,n){if(!n.mesh){const l=new a.aE;l.emplaceBack(-1,-1),l.emplaceBack(1,-1),l.emplaceBack(1,1),l.emplaceBack(-1,1);const p=new a.aG;p.emplaceBack(0,1,2),p.emplaceBack(0,2,3),n.mesh=new zr(_.createVertexBuffer(l,qr.members),_.createIndexBuffer(p),a.aF.simpleSegment(0,0,l.length,p.length))}return n.mesh}class dd{constructor(n,l){this.context=new gl(n),this.transform=l,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:a.as(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=B.maxUnderzooming+B.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new Dc}resize(n,l,p){if(this.width=Math.floor(n*p),this.height=Math.floor(l*p),this.pixelRatio=p,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const g of this.style._order)this.style._layers[g].resize()}setup(){const n=this.context,l=new a.aE;l.emplaceBack(0,0),l.emplaceBack(a.Z,0),l.emplaceBack(0,a.Z),l.emplaceBack(a.Z,a.Z),this.tileExtentBuffer=n.createVertexBuffer(l,qr.members),this.tileExtentSegments=a.aF.simpleSegment(0,0,4,2);const p=new a.aE;p.emplaceBack(0,0),p.emplaceBack(a.Z,0),p.emplaceBack(0,a.Z),p.emplaceBack(a.Z,a.Z),this.debugBuffer=n.createVertexBuffer(p,qr.members),this.debugSegments=a.aF.simpleSegment(0,0,4,5);const g=new a.bV;g.emplaceBack(0,0,0,0),g.emplaceBack(a.Z,0,a.Z,0),g.emplaceBack(0,a.Z,0,a.Z),g.emplaceBack(a.Z,a.Z,a.Z,a.Z),this.rasterBoundsBuffer=n.createVertexBuffer(g,wn.members),this.rasterBoundsSegments=a.aF.simpleSegment(0,0,4,2);const x=new a.aE;x.emplaceBack(0,0),x.emplaceBack(a.Z,0),x.emplaceBack(0,a.Z),x.emplaceBack(a.Z,a.Z),this.rasterBoundsBufferPosOnly=n.createVertexBuffer(x,qr.members),this.rasterBoundsSegmentsPosOnly=a.aF.simpleSegment(0,0,4,5);const T=new a.aE;T.emplaceBack(0,0),T.emplaceBack(1,0),T.emplaceBack(0,1),T.emplaceBack(1,1),this.viewportBuffer=n.createVertexBuffer(T,qr.members),this.viewportSegments=a.aF.simpleSegment(0,0,4,2);const A=new a.bW;A.emplaceBack(0),A.emplaceBack(1),A.emplaceBack(3),A.emplaceBack(2),A.emplaceBack(0),this.tileBorderIndexBuffer=n.createIndexBuffer(A);const C=new a.aG;C.emplaceBack(1,0,2),C.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=n.createIndexBuffer(C);const R=this.context.gl;this.stencilClearMode=new ti({func:R.ALWAYS,mask:0},0,255,R.ZERO,R.ZERO,R.ZERO),this.tileExtentMesh=new zr(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const n=this.context,l=n.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const p=a.K();a.bN(p,0,this.width,this.height,0,0,1),a.M(p,p,[l.drawingBufferWidth,l.drawingBufferHeight,0]);const g={mainMatrix:p,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:p};this.useProgram("clippingMask",null,!0).draw(n,l.TRIANGLES,$t.disabled,this.stencilClearMode,Pi.disabled,Qt.disabled,null,null,g,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(n,l,p){if(this.currentStencilSource===n.source||!n.isTileClipped()||!l||!l.length)return;this.currentStencilSource=n.source,this.nextStencilID+l.length>256&&this.clearStencil();const g=this.context;g.setColorMode(Pi.disabled),g.setDepthMode($t.disabled);const x={};for(const T of l)x[T.key]=this.nextStencilID++;this._renderTileMasks(x,l,p,!0),this._renderTileMasks(x,l,p,!1),this._tileClippingMaskIDs=x}_renderTileMasks(n,l,p,g){const x=this.context,T=x.gl,A=this.style.projection,C=this.transform,R=this.useProgram("clippingMask");for(const L of l){const N=n[L.key],z=this.style.map.terrain&&this.style.map.terrain.getTerrainData(L),H=A.getMeshFromTileID(this.context,L.canonical,g,!0,"stencil"),q=C.getProjectionData({overscaledTileID:L,applyGlobeMatrix:!0,applyTerrainMatrix:!0});R.draw(x,T.TRIANGLES,$t.disabled,new ti({func:T.ALWAYS,mask:0},N,255,T.KEEP,T.KEEP,T.REPLACE),Pi.disabled,p?Qt.disabled:Qt.backCCW,null,z,q,"$clipping",H.vertexBuffer,H.indexBuffer,H.segments)}}_renderTilesDepthBuffer(){const n=this.context,l=n.gl,p=this.style.projection,g=this.transform,x=this.useProgram("depth"),T=this.getDepthModeFor3D(),A=Ne(g,{tileSize:g.tileSize});for(const C of A){const R=this.style.map.terrain&&this.style.map.terrain.getTerrainData(C),L=p.getMeshFromTileID(this.context,C.canonical,!0,!0,"raster"),N=g.getProjectionData({overscaledTileID:C,applyGlobeMatrix:!0,applyTerrainMatrix:!0});x.draw(n,l.TRIANGLES,T,ti.disabled,Pi.disabled,Qt.backCCW,null,R,N,"$clipping",L.vertexBuffer,L.indexBuffer,L.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const n=this.nextStencilID++,l=this.context.gl;return new ti({func:l.NOTEQUAL,mask:255},n,255,l.KEEP,l.KEEP,l.REPLACE)}stencilModeForClipping(n){const l=this.context.gl;return new ti({func:l.EQUAL,mask:255},this._tileClippingMaskIDs[n.key],0,l.KEEP,l.KEEP,l.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(n){const l=this.context.gl,p=n.sort(((T,A)=>A.overscaledZ-T.overscaledZ)),g=p[p.length-1].overscaledZ,x=p[0].overscaledZ-g+1;if(x>1){this.currentStencilSource=void 0,this.nextStencilID+x>256&&this.clearStencil();const T={};for(let A=0;A<x;A++)T[A+g]=new ti({func:l.GEQUAL,mask:255},A+this.nextStencilID,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID+=x,[T,p]}return[{[g]:ti.disabled},p]}stencilConfigForOverlapTwoPass(n){const l=this.context.gl,p=n.sort(((T,A)=>A.overscaledZ-T.overscaledZ)),g=p[p.length-1].overscaledZ,x=p[0].overscaledZ-g+1;if(this.clearStencil(),x>1){const T={},A={};for(let C=0;C<x;C++)T[C+g]=new ti({func:l.GREATER,mask:255},x+1+C,255,l.KEEP,l.KEEP,l.REPLACE),A[C+g]=new ti({func:l.GREATER,mask:255},1+C,255,l.KEEP,l.KEEP,l.REPLACE);return this.nextStencilID=2*x+1,[T,A,p]}return this.nextStencilID=3,[{[g]:new ti({func:l.GREATER,mask:255},2,255,l.KEEP,l.KEEP,l.REPLACE)},{[g]:new ti({func:l.GREATER,mask:255},1,255,l.KEEP,l.KEEP,l.REPLACE)},p]}colorModeForRenderPass(){const n=this.context.gl;return this._showOverdrawInspector?new Pi([n.CONSTANT_COLOR,n.ONE],new a.b6(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?Pi.unblended:Pi.alphaBlended}getDepthModeForSublayer(n,l,p){if(!this.opaquePassEnabledForLayer())return $t.disabled;const g=1-((1+this.currentLayer)*this.numSublayers+n)*this.depthEpsilon;return new $t(p||this.context.gl.LEQUAL,l,[g,g])}getDepthModeFor3D(){return new $t(this.context.gl.LEQUAL,$t.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(n,l){var p,g;this.style=n,this.options=l,this.lineAtlas=n.lineAtlas,this.imageManager=n.imageManager,this.glyphManager=n.glyphManager,this.symbolFadeChange=n.placement.symbolFadeChange(D.now()),this.imageManager.beginFrame();const x=this.style._order,T=this.style.sourceCaches,A={},C={},R={},L={isRenderingToTexture:!1,isRenderingGlobe:((p=n.projection)===null||p===void 0?void 0:p.transitionState)>0};for(const z in T){const H=T[z];H.used&&H.prepare(this.context),A[z]=H.getVisibleCoordinates(!1),C[z]=A[z].slice().reverse(),R[z]=H.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let z=0;z<x.length;z++)if(this.style._layers[x[z]].is3D()){this.opaquePassCutoff=z;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const z of x){const H=this.style._layers[z];if(!H.hasOffscreenPass()||H.isHidden(this.transform.zoom))continue;const q=C[H.source];(H.type==="custom"||q.length)&&this.renderLayer(this,T[H.source],H,q,L)}if((g=this.style.projection)===null||g===void 0||g.updateGPUdependent({context:this.context,useProgram:z=>this.useProgram(z)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:l.showOverdrawInspector?a.b6.black:a.b6.transparent,depth:1}),this.clearStencil(),this.style.sky&&(function(z,H){const q=z.context,se=q.gl,ne=((Re,Ie,$e)=>{const He=Math.cos(Ie.rollInRadians),it=Math.sin(Ie.rollInRadians),nt=er(Ie),et=Ie.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:Re.properties.get("sky-color"),u_horizon_color:Re.properties.get("horizon-color"),u_horizon:[(Ie.width/2-nt*it)*$e,(Ie.height/2+nt*He)*$e],u_horizon_normal:[-it,He],u_sky_horizon_blend:Re.properties.get("sky-horizon-blend")*Ie.height/2*$e,u_sky_blend:et}})(H,z.style.map.transform,z.pixelRatio),le=new $t(se.LEQUAL,$t.ReadWrite,[0,1]),he=ti.disabled,xe=z.colorModeForRenderPass(),ve=z.useProgram("sky"),Pe=cu(q,H);ve.draw(q,se.TRIANGLES,le,he,xe,Qt.disabled,ne,null,void 0,"sky",Pe.vertexBuffer,Pe.indexBuffer,Pe.segments)})(this,this.style.sky),this._showOverdrawInspector=l.showOverdrawInspector,this.depthRangeFor3D=[0,1-(n._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=x.length-1;this.currentLayer>=0;this.currentLayer--){const z=this.style._layers[x[this.currentLayer]],H=T[z.source],q=A[z.source];this._renderTileClippingMasks(z,q,!1),this.renderLayer(this,H,z,q,L)}this.renderPass="translucent";let N=!1;for(this.currentLayer=0;this.currentLayer<x.length;this.currentLayer++){const z=this.style._layers[x[this.currentLayer]],H=T[z.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(z,L))continue;this.opaquePassEnabledForLayer()||N||(N=!0,L.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const q=(z.type==="symbol"?R:C)[z.source];this._renderTileClippingMasks(z,A[z.source],!1),this.renderLayer(this,H,z,q,L)}if(L.isRenderingGlobe&&(function(z,H,q){const se=z.context,ne=se.gl,le=z.useProgram("atmosphere"),he=new $t(ne.LEQUAL,$t.ReadOnly,[0,1]),xe=z.transform,ve=(function(et,xt){const yt=et.properties.get("position"),ct=[-yt.x,-yt.y,-yt.z],Pt=a.as(new Float64Array(16));return et.properties.get("anchor")==="map"&&(a.aZ(Pt,Pt,xt.rollInRadians),a.a_(Pt,Pt,-xt.pitchInRadians),a.aZ(Pt,Pt,xt.bearingInRadians),a.a_(Pt,Pt,xt.center.lat*Math.PI/180),a.bl(Pt,Pt,-xt.center.lng*Math.PI/180)),a.bU(ct,ct,Pt),ct})(q,z.transform),Pe=xe.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),Re=H.properties.get("atmosphere-blend")*Pe.projectionTransition;if(Re===0)return;const Ie=br(xe.worldSize,xe.center.lat),$e=xe.inverseProjectionMatrix,He=new Float64Array(4);He[3]=1,a.ao(He,He,xe.modelViewProjectionMatrix),He[0]/=He[3],He[1]/=He[3],He[2]/=He[3],He[3]=1,a.ao(He,He,$e),He[0]/=He[3],He[1]/=He[3],He[2]/=He[3],He[3]=1;const it=((et,xt,yt,ct,Pt)=>({u_sun_pos:et,u_atmosphere_blend:xt,u_globe_position:yt,u_globe_radius:ct,u_inv_proj_matrix:Pt}))(ve,Re,[He[0],He[1],He[2]],Ie,$e),nt=cu(se,H);le.draw(se,ne.TRIANGLES,he,ti.disabled,Pi.alphaBlended,Qt.disabled,it,null,null,"atmosphere",nt.vertexBuffer,nt.indexBuffer,nt.segments)})(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const z=(function(H,q){let se=null;const ne=Object.values(H._layers).flatMap((ve=>ve.source&&!ve.isHidden(q)?[H.sourceCaches[ve.source]]:[])),le=ne.filter((ve=>ve.getSource().type==="vector")),he=ne.filter((ve=>ve.getSource().type!=="vector")),xe=ve=>{(!se||se.getSource().maxzoom<ve.getSource().maxzoom)&&(se=ve)};return le.forEach((ve=>xe(ve))),se||he.forEach((ve=>xe(ve))),se})(this.style,this.transform.zoom);z&&(function(H,q,se){for(let ne=0;ne<se.length;ne++)hd(H,q,se[ne])})(this,z,z.getVisibleCoordinates())}this.options.showPadding&&(function(z){const H=z.transform.padding;js(z,z.transform.height-(H.top||0),3,Vs),js(z,H.bottom||0,3,Qr),bo(z,H.left||0,3,ou),bo(z,z.transform.width-(H.right||0),3,au);const q=z.transform.centerPoint;(function(se,ne,le,he){wo(se,ne-1,le-10,2,20,he),wo(se,ne-10,le-1,20,2,he)})(z,q.x,z.transform.height-q.y,ud)})(this),this.context.setDefault()}maybeDrawDepthAndCoords(n){if(!this.style||!this.style.map||!this.style.map.terrain)return;const l=this.terrainFacilitator.matrix,p=this.transform.modelViewProjectionMatrix;let g=this.terrainFacilitator.dirty;g||(g=n?!a.bX(l,p):!a.bY(l,p)),g||(g=this.style.map.terrain.sourceCache.anyTilesAfterTime(this.terrainFacilitator.renderTime)),g&&(a.bZ(l,p),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,(function(x,T){const A=x.context,C=A.gl,R=x.transform,L=Pi.unblended,N=new $t(C.LEQUAL,$t.ReadWrite,[0,1]),z=T.sourceCache.getRenderableTiles(),H=x.useProgram("terrainDepth");A.bindFramebuffer.set(T.getFramebuffer("depth").framebuffer),A.viewport.set([0,0,x.width/devicePixelRatio,x.height/devicePixelRatio]),A.clear({color:a.b6.transparent,depth:1});for(const q of z){const se=T.getTerrainMesh(q.tileID),ne=T.getTerrainData(q.tileID),le=R.getProjectionData({overscaledTileID:q.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),he={u_ele_delta:T.getMeshFrameDelta(R.zoom)};H.draw(A,C.TRIANGLES,N,ti.disabled,L,Qt.backCCW,he,ne,le,"terrain",se.vertexBuffer,se.indexBuffer,se.segments)}A.bindFramebuffer.set(null),A.viewport.set([0,0,x.width,x.height])})(this,this.style.map.terrain),(function(x,T){const A=x.context,C=A.gl,R=x.transform,L=Pi.unblended,N=new $t(C.LEQUAL,$t.ReadWrite,[0,1]),z=T.getCoordsTexture(),H=T.sourceCache.getRenderableTiles(),q=x.useProgram("terrainCoords");A.bindFramebuffer.set(T.getFramebuffer("coords").framebuffer),A.viewport.set([0,0,x.width/devicePixelRatio,x.height/devicePixelRatio]),A.clear({color:a.b6.transparent,depth:1}),T.coordsIndex=[];for(const se of H){const ne=T.getTerrainMesh(se.tileID),le=T.getTerrainData(se.tileID);A.activeTexture.set(C.TEXTURE0),C.bindTexture(C.TEXTURE_2D,z.texture);const he={u_terrain_coords_id:(255-T.coordsIndex.length)/255,u_texture:0,u_ele_delta:T.getMeshFrameDelta(R.zoom)},xe=R.getProjectionData({overscaledTileID:se.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});q.draw(A,C.TRIANGLES,N,ti.disabled,L,Qt.backCCW,he,le,xe,"terrain",ne.vertexBuffer,ne.indexBuffer,ne.segments),T.coordsIndex.push(se.tileID.key)}A.bindFramebuffer.set(null),A.viewport.set([0,0,x.width,x.height])})(this,this.style.map.terrain))}renderLayer(n,l,p,g,x){p.isHidden(this.transform.zoom)||(p.type==="background"||p.type==="custom"||(g||[]).length)&&(this.id=p.id,a.b_(p)?(function(T,A,C,R,L,N){if(T.renderPass!=="translucent")return;const{isRenderingToTexture:z}=N,H=ti.disabled,q=T.colorModeForRenderPass();(C._unevaluatedLayout.hasValue("text-variable-anchor")||C._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&(function(se,ne,le,he,xe,ve,Pe,Re,Ie){const $e=ne.transform,He=ne.style.map.terrain,it=xe==="map",nt=ve==="map";for(const et of se){const xt=he.getTile(et),yt=xt.getBucket(le);if(!yt||!yt.text||!yt.text.segments.get().length)continue;const ct=a.af(yt.textSizeData,$e.zoom),Pt=a.av(xt,1,ne.transform.zoom),Rt=qe(it,ne.transform,Pt),li=le.layout.get("icon-text-fit")!=="none"&&yt.hasIconData();if(ct){const xi=Math.pow(2,$e.zoom-xt.tileID.overscaledZ),fi=He?(Ii,wi)=>He.getElevation(et,Ii,wi):null;yl(yt,it,nt,Ie,$e,Rt,xi,ct,li,a.aw($e,xt,Pe,Re),et.toUnwrapped(),fi)}}})(R,T,C,A,C.layout.get("text-rotation-alignment"),C.layout.get("text-pitch-alignment"),C.paint.get("text-translate"),C.paint.get("text-translate-anchor"),L),C.paint.get("icon-opacity").constantOr(1)!==0&&ld(T,A,C,R,!1,C.paint.get("icon-translate"),C.paint.get("icon-translate-anchor"),C.layout.get("icon-rotation-alignment"),C.layout.get("icon-pitch-alignment"),C.layout.get("icon-keep-upright"),H,q,z),C.paint.get("text-opacity").constantOr(1)!==0&&ld(T,A,C,R,!0,C.paint.get("text-translate"),C.paint.get("text-translate-anchor"),C.layout.get("text-rotation-alignment"),C.layout.get("text-pitch-alignment"),C.layout.get("text-keep-upright"),H,q,z),A.map.showCollisionBoxes&&(ml(T,A,C,R,!0),ml(T,A,C,R,!1))})(n,l,p,g,this.style.placement.variableOffsets,x):a.b$(p)?(function(T,A,C,R,L){if(T.renderPass!=="translucent")return;const{isRenderingToTexture:N}=L,z=C.paint.get("circle-opacity"),H=C.paint.get("circle-stroke-width"),q=C.paint.get("circle-stroke-opacity"),se=!C.layout.get("circle-sort-key").isConstant();if(z.constantOr(1)===0&&(H.constantOr(1)===0||q.constantOr(1)===0))return;const ne=T.context,le=ne.gl,he=T.transform,xe=T.getDepthModeForSublayer(0,$t.ReadOnly),ve=ti.disabled,Pe=T.colorModeForRenderPass(),Re=[],Ie=he.getCircleRadiusCorrection();for(let $e=0;$e<R.length;$e++){const He=R[$e],it=A.getTile(He),nt=it.getBucket(C);if(!nt)continue;const et=C.paint.get("circle-translate"),xt=C.paint.get("circle-translate-anchor"),yt=a.aw(he,it,et,xt),ct=nt.programConfigurations.get(C.id),Pt=T.useProgram("circle",ct),Rt=nt.layoutVertexBuffer,li=nt.indexBuffer,xi=T.style.map.terrain&&T.style.map.terrain.getTerrainData(He),fi={programConfiguration:ct,program:Pt,layoutVertexBuffer:Rt,indexBuffer:li,uniformValues:Wh(T,it,C,yt,Ie),terrainData:xi,projectionData:he.getProjectionData({overscaledTileID:He,applyGlobeMatrix:!N,applyTerrainMatrix:!0})};if(se){const Ii=nt.segments.get();for(const wi of Ii)Re.push({segments:new a.aF([wi]),sortKey:wi.sortKey,state:fi})}else Re.push({segments:nt.segments,sortKey:0,state:fi})}se&&Re.sort((($e,He)=>$e.sortKey-He.sortKey));for(const $e of Re){const{programConfiguration:He,program:it,layoutVertexBuffer:nt,indexBuffer:et,uniformValues:xt,terrainData:yt,projectionData:ct}=$e.state;it.draw(ne,le.TRIANGLES,xe,ve,Pe,Qt.backCCW,xt,yt,ct,C.id,nt,et,$e.segments,C.paint,T.transform.zoom,He)}})(n,l,p,g,x):a.c0(p)?(function(T,A,C,R,L){if(C.paint.get("heatmap-opacity")===0)return;const N=T.context,{isRenderingToTexture:z,isRenderingGlobe:H}=L;if(T.style.map.terrain){for(const q of R){const se=A.getTile(q);A.hasRenderableParent(q)||(T.renderPass==="offscreen"?Vp(T,se,C,q,H):T.renderPass==="translucent"&&cd(T,C,q,z,H))}N.viewport.set([0,0,T.width,T.height])}else T.renderPass==="offscreen"?(function(q,se,ne,le){const he=q.context,xe=he.gl,ve=q.transform,Pe=ti.disabled,Re=new Pi([xe.ONE,xe.ONE],a.b6.transparent,[!0,!0,!0,!0]);(function(Ie,$e,He){const it=Ie.gl;Ie.activeTexture.set(it.TEXTURE1),Ie.viewport.set([0,0,$e.width/4,$e.height/4]);let nt=He.heatmapFbos.get(a.bR);nt?(it.bindTexture(it.TEXTURE_2D,nt.colorAttachment.get()),Ie.bindFramebuffer.set(nt.framebuffer)):(nt=oa(Ie,$e.width/4,$e.height/4),He.heatmapFbos.set(a.bR,nt))})(he,q,ne),he.clear({color:a.b6.transparent});for(let Ie=0;Ie<le.length;Ie++){const $e=le[Ie];if(se.hasRenderableParent($e))continue;const He=se.getTile($e),it=He.getBucket(ne);if(!it)continue;const nt=it.programConfigurations.get(ne.id),et=q.useProgram("heatmap",nt),xt=ve.getProjectionData({overscaledTileID:$e,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),yt=ve.getCircleRadiusCorrection();et.draw(he,xe.TRIANGLES,$t.disabled,Pe,Re,Qt.backCCW,Wc(He,ve.zoom,ne.paint.get("heatmap-intensity"),yt),null,xt,ne.id,it.layoutVertexBuffer,it.indexBuffer,it.segments,ne.paint,ve.zoom,nt)}he.viewport.set([0,0,q.width,q.height])})(T,A,C,R):T.renderPass==="translucent"&&(function(q,se){const ne=q.context,le=ne.gl;ne.setColorMode(q.colorModeForRenderPass());const he=se.heatmapFbos.get(a.bR);he&&(ne.activeTexture.set(le.TEXTURE0),le.bindTexture(le.TEXTURE_2D,he.colorAttachment.get()),ne.activeTexture.set(le.TEXTURE1),vl(ne,se).bind(le.LINEAR,le.CLAMP_TO_EDGE),q.useProgram("heatmapTexture").draw(ne,le.TRIANGLES,$t.disabled,ti.disabled,q.colorModeForRenderPass(),Qt.disabled,Hc(q,se,0,1),null,null,se.id,q.viewportBuffer,q.quadTriangleIndexBuffer,q.viewportSegments,se.paint,q.transform.zoom))})(T,C)})(n,l,p,g,x):a.c1(p)?(function(T,A,C,R,L){if(T.renderPass!=="translucent")return;const{isRenderingToTexture:N}=L,z=C.paint.get("line-opacity"),H=C.paint.get("line-width");if(z.constantOr(1)===0||H.constantOr(1)===0)return;const q=T.getDepthModeForSublayer(0,$t.ReadOnly),se=T.colorModeForRenderPass(),ne=C.paint.get("line-dasharray"),le=C.paint.get("line-pattern"),he=le.constantOr(1),xe=C.paint.get("line-gradient"),ve=C.getCrossfadeParameters(),Pe=he?"linePattern":ne?"lineSDF":xe?"lineGradient":"line",Re=T.context,Ie=Re.gl,$e=T.transform;let He=!0;for(const it of R){const nt=A.getTile(it);if(he&&!nt.patternsLoaded())continue;const et=nt.getBucket(C);if(!et)continue;const xt=et.programConfigurations.get(C.id),yt=T.context.program.get(),ct=T.useProgram(Pe,xt),Pt=He||ct.program!==yt,Rt=T.style.map.terrain&&T.style.map.terrain.getTerrainData(it),li=le.constantOr(null);if(li&&nt.imageAtlas){const ui=nt.imageAtlas,pi=ui.patternPositions[li.to.toString()],ir=ui.patternPositions[li.from.toString()];pi&&ir&&xt.setConstantPatternPositions(pi,ir)}const xi=$e.getProjectionData({overscaledTileID:it,applyGlobeMatrix:!N,applyTerrainMatrix:!0}),fi=$e.getPixelScale(),Ii=he?nl(T,nt,C,fi,ve):ne?kp(T,nt,C,fi,ne,ve):xe?Rp(T,nt,C,fi,et.lineClipsArray.length):Ls(T,nt,C,fi);if(he)Re.activeTexture.set(Ie.TEXTURE0),nt.imageAtlasTexture.bind(Ie.LINEAR,Ie.CLAMP_TO_EDGE),xt.updatePaintBuffers(ve);else if(ne&&(Pt||T.lineAtlas.dirty))Re.activeTexture.set(Ie.TEXTURE0),T.lineAtlas.bind(Re);else if(xe){const ui=et.gradients[C.id];let pi=ui.texture;if(C.gradientVersion!==ui.version){let ir=256;if(C.stepInterpolant){const rr=A.getSource().maxzoom,Xi=it.canonical.z===rr?Math.ceil(1<<T.transform.maxZoom-it.canonical.z):1;ir=a.ad(a.bS(et.maxLineLength/a.Z*1024*Xi),256,Re.maxTextureSize)}ui.gradient=a.bT({expression:C.gradientExpression(),evaluationKey:"lineProgress",resolution:ir,image:ui.gradient||void 0,clips:et.lineClipsArray}),ui.texture?ui.texture.update(ui.gradient):ui.texture=new G(Re,ui.gradient,Ie.RGBA),ui.version=C.gradientVersion,pi=ui.texture}Re.activeTexture.set(Ie.TEXTURE0),pi.bind(C.stepInterpolant?Ie.NEAREST:Ie.LINEAR,Ie.CLAMP_TO_EDGE)}let wi;if(N){const[ui]=T.getStencilConfigForOverlapAndUpdateStencilID(R);wi=ui[it.overscaledZ]}else wi=T.stencilModeForClipping(it);ct.draw(Re,Ie.TRIANGLES,q,wi,se,Qt.disabled,Ii,Rt,xi,C.id,et.layoutVertexBuffer,et.indexBuffer,et.segments,C.paint,T.transform.zoom,xt,et.layoutVertexBuffer2),He=!1}})(n,l,p,g,x):a.c2(p)?(function(T,A,C,R,L){const N=C.paint.get("fill-color"),z=C.paint.get("fill-opacity");if(z.constantOr(1)===0)return;const{isRenderingToTexture:H}=L,q=T.colorModeForRenderPass(),se=C.paint.get("fill-pattern"),ne=T.opaquePassEnabledForLayer()&&!se.constantOr(1)&&N.constantOr(a.b6.transparent).a===1&&z.constantOr(0)===1?"opaque":"translucent";if(T.renderPass===ne){const le=T.getDepthModeForSublayer(1,T.renderPass==="opaque"?$t.ReadWrite:$t.ReadOnly);nu(T,A,C,R,le,q,!1,H)}if(T.renderPass==="translucent"&&C.paint.get("fill-antialias")){const le=T.getDepthModeForSublayer(C.getPaintProperty("fill-outline-color")?2:0,$t.ReadOnly);nu(T,A,C,R,le,q,!0,H)}})(n,l,p,g,x):a.c3(p)?(function(T,A,C,R,L){const N=C.paint.get("fill-extrusion-opacity");if(N===0)return;const{isRenderingToTexture:z}=L;if(T.renderPass==="translucent"){const H=new $t(T.context.gl.LEQUAL,$t.ReadWrite,T.depthRangeFor3D);if(N!==1||C.paint.get("fill-extrusion-pattern").constantOr(1))vo(T,A,C,R,H,ti.disabled,Pi.disabled,z),vo(T,A,C,R,H,T.stencilModeFor3D(),T.colorModeForRenderPass(),z);else{const q=T.colorModeForRenderPass();vo(T,A,C,R,H,ti.disabled,q,z)}}})(n,l,p,g,x):a.c4(p)?(function(T,A,C,R,L){if(T.renderPass!=="offscreen"&&T.renderPass!=="translucent")return;const{isRenderingToTexture:N}=L,z=T.context,H=T.style.projection.useSubdivision,q=T.getDepthModeForSublayer(0,$t.ReadOnly),se=T.colorModeForRenderPass();if(T.renderPass==="offscreen")(function(ne,le,he,xe,ve,Pe,Re){const Ie=ne.context,$e=Ie.gl;for(const He of he){const it=le.getTile(He),nt=it.dem;if(!nt||!nt.data||!it.needsHillshadePrepare)continue;const et=nt.dim,xt=nt.stride,yt=nt.getPixels();if(Ie.activeTexture.set($e.TEXTURE1),Ie.pixelStoreUnpackPremultiplyAlpha.set(!1),it.demTexture=it.demTexture||ne.getTileTexture(xt),it.demTexture){const Pt=it.demTexture;Pt.update(yt,{premultiply:!1}),Pt.bind($e.NEAREST,$e.CLAMP_TO_EDGE)}else it.demTexture=new G(Ie,yt,$e.RGBA,{premultiply:!1}),it.demTexture.bind($e.NEAREST,$e.CLAMP_TO_EDGE);Ie.activeTexture.set($e.TEXTURE0);let ct=it.fbo;if(!ct){const Pt=new G(Ie,{width:et,height:et,data:null},$e.RGBA);Pt.bind($e.LINEAR,$e.CLAMP_TO_EDGE),ct=it.fbo=Ie.createFramebuffer(et,et,!0,!1),ct.colorAttachment.set(Pt.texture)}Ie.bindFramebuffer.set(ct.framebuffer),Ie.viewport.set([0,0,et,et]),ne.useProgram("hillshadePrepare").draw(Ie,$e.TRIANGLES,ve,Pe,Re,Qt.disabled,Zh(it.tileID,nt),null,null,xe.id,ne.rasterBoundsBuffer,ne.quadTriangleIndexBuffer,ne.rasterBoundsSegments),it.needsHillshadePrepare=!1}})(T,A,R,C,q,ti.disabled,se),z.viewport.set([0,0,T.width,T.height]);else if(T.renderPass==="translucent")if(H){const[ne,le,he]=T.stencilConfigForOverlapTwoPass(R);aa(T,A,C,he,ne,q,se,!1,N),aa(T,A,C,he,le,q,se,!0,N)}else{const[ne,le]=T.getStencilConfigForOverlapAndUpdateStencilID(R);aa(T,A,C,le,ne,q,se,!1,N)}})(n,l,p,g,x):a.c5(p)?(function(T,A,C,R,L){if(T.renderPass!=="translucent"||C.paint.get("raster-opacity")===0||!R.length)return;const{isRenderingToTexture:N}=L,z=A.getSource(),H=T.style.projection.useSubdivision;if(z instanceof bn)la(T,A,C,R,null,!1,!1,z.tileCoords,z.flippedWindingOrder,N);else if(H){const[q,se,ne]=T.stencilConfigForOverlapTwoPass(R);la(T,A,C,ne,q,!1,!0,su,!1,N),la(T,A,C,ne,se,!0,!0,su,!1,N)}else{const[q,se]=T.getStencilConfigForOverlapAndUpdateStencilID(R);la(T,A,C,se,q,!1,!0,su,!1,N)}})(n,l,p,g,x):a.c6(p)?(function(T,A,C,R,L){const N=C.paint.get("background-color"),z=C.paint.get("background-opacity");if(z===0)return;const{isRenderingToTexture:H}=L,q=T.context,se=q.gl,ne=T.style.projection,le=T.transform,he=le.tileSize,xe=C.paint.get("background-pattern");if(T.isPatternMissing(xe))return;const ve=!xe&&N.a===1&&z===1&&T.opaquePassEnabledForLayer()?"opaque":"translucent";if(T.renderPass!==ve)return;const Pe=ti.disabled,Re=T.getDepthModeForSublayer(0,ve==="opaque"?$t.ReadWrite:$t.ReadOnly),Ie=T.colorModeForRenderPass(),$e=T.useProgram(xe?"backgroundPattern":"background"),He=R||Ne(le,{tileSize:he,terrain:T.style.map.terrain});xe&&(q.activeTexture.set(se.TEXTURE0),T.imageManager.bind(T.context));const it=C.getCrossfadeParameters();for(const nt of He){const et=le.getProjectionData({overscaledTileID:nt,applyGlobeMatrix:!H,applyTerrainMatrix:!0}),xt=xe?Xc(z,T,xe,{tileID:nt,tileSize:he},it):Vn(z,N),yt=T.style.map.terrain&&T.style.map.terrain.getTerrainData(nt),ct=ne.getMeshFromTileID(q,nt.canonical,!1,!0,"raster");$e.draw(q,se.TRIANGLES,Re,Pe,Ie,Qt.backCCW,xt,yt,et,C.id,ct.vertexBuffer,ct.indexBuffer,ct.segments)}})(n,0,p,g,x):a.c7(p)&&(function(T,A,C,R){const{isRenderingGlobe:L}=R,N=T.context,z=C.implementation,H=T.style.projection,q=T.transform,se=q.getProjectionDataForCustomLayer(L),ne={farZ:q.farZ,nearZ:q.nearZ,fov:q.fov*Math.PI/180,modelViewProjectionMatrix:q.modelViewProjectionMatrix,projectionMatrix:q.projectionMatrix,shaderData:{variantName:H.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;
uniform mat4 u_projection_matrix;
${H.shaderPreludeCode.vertexSource}`,define:H.shaderDefine},defaultProjectionData:se},le=z.renderingMode?z.renderingMode:"2d";if(T.renderPass==="offscreen"){const he=z.prerender;he&&(T.setCustomLayerDefaults(),N.setColorMode(T.colorModeForRenderPass()),he.call(z,N.gl,ne),N.setDirty(),T.setBaseState())}else if(T.renderPass==="translucent"){T.setCustomLayerDefaults(),N.setColorMode(T.colorModeForRenderPass()),N.setStencilMode(ti.disabled);const he=le==="3d"?T.getDepthModeFor3D():T.getDepthModeForSublayer(0,$t.ReadOnly);N.setDepthMode(he),z.render(N.gl,ne),N.setDirty(),T.setBaseState(),N.bindFramebuffer.set(null)}})(n,0,p,x))}saveTileTexture(n){const l=this._tileTextures[n.size[0]];l?l.push(n):this._tileTextures[n.size[0]]=[n]}getTileTexture(n){const l=this._tileTextures[n];return l&&l.length>0?l.pop():null}isPatternMissing(n){if(!n)return!1;if(!n.from||!n.to)return!0;const l=this.imageManager.getPattern(n.from.toString()),p=this.imageManager.getPattern(n.to.toString());return!l||!p}useProgram(n,l,p=!1){this.cache=this.cache||{};const g=!!this.style.map.terrain,x=this.style.projection,T=n+(l?l.cacheKey:"")+`/${p?qa:x.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+(g?"/terrain":"");return this.cache[T]||(this.cache[T]=new Ip(this.context,an[n],l,Gc[n],this._showOverdrawInspector,g,p?an.projectionMercator:x.shaderPreludeCode,p?ni:x.shaderDefine)),this.cache[T]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const n=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(n.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new G(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:n,drawingBufferHeight:l}=this.context.gl;return this.width!==n||this.height!==l}}function uu(_,n){let l,p=!1,g=null,x=null;const T=()=>{g=null,p&&(_.apply(x,l),g=setTimeout(T,n),p=!1)};return(...A)=>(p=!0,x=this,l=A,g||T(),g)}class us{constructor(n){this._getCurrentHash=()=>{const l=window.location.hash.replace("#","");if(this._hashName){let p;return l.split("&").map((g=>g.split("="))).forEach((g=>{g[0]===this._hashName&&(p=g)})),(p&&p[1]||"").split("/")}return l.split("/")},this._onHashChange=()=>{const l=this._getCurrentHash();if(!this._isValidHash(l))return!1;const p=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(l[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+l[2],+l[1]],zoom:+l[0],bearing:p,pitch:+(l[4]||0)}),!0},this._updateHashUnthrottled=()=>{const l=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,l)},this._removeHash=()=>{const l=this._getCurrentHash();if(l.length===0)return;const p=l.join("/");let g=p;g.split("&").length>0&&(g=g.split("&")[0]),this._hashName&&(g=`${this._hashName}=${p}`);let x=window.location.hash.replace(g,"");x.startsWith("#&")?x=x.slice(0,1)+x.slice(2):x==="#"&&(x="");let T=window.location.href.replace(/(#.+)?$/,x);T=T.replace("&&","&"),window.history.replaceState(window.history.state,null,T)},this._updateHash=uu(this._updateHashUnthrottled,300),this._hashName=n&&encodeURIComponent(n)}addTo(n){return this._map=n,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(n){const l=this._map.getCenter(),p=Math.round(100*this._map.getZoom())/100,g=Math.ceil((p*Math.LN2+Math.log(512/360/.5))/Math.LN10),x=Math.pow(10,g),T=Math.round(l.lng*x)/x,A=Math.round(l.lat*x)/x,C=this._map.getBearing(),R=this._map.getPitch();let L="";if(L+=n?`/${T}/${A}/${p}`:`${p}/${A}/${T}`,(C||R)&&(L+="/"+Math.round(10*C)/10),R&&(L+=`/${Math.round(R)}`),this._hashName){const N=this._hashName;let z=!1;const H=window.location.hash.slice(1).split("&").map((q=>{const se=q.split("=")[0];return se===N?(z=!0,`${se}=${L}`):q})).filter((q=>q));return z||H.push(`${N}=${L}`),`#${H.join("&")}`}return`#${L}`}_isValidHash(n){if(n.length<3||n.some(isNaN))return!1;try{new a.Q(+n[2],+n[1])}catch{return!1}const l=+n[0],p=+(n[3]||0),g=+(n[4]||0);return l>=this._map.getMinZoom()&&l<=this._map.getMaxZoom()&&p>=-180&&p<=180&&g>=this._map.getMinPitch()&&g<=this._map.getMaxPitch()}}const To={linearity:.3,easing:a.c8(0,0,.3,1)},fd=a.e({deceleration:2500,maxSpeed:1400},To),pd=a.e({deceleration:20,maxSpeed:1400},To),gd=a.e({deceleration:1e3,maxSpeed:360},To),md=a.e({deceleration:1e3,maxSpeed:90},To),_d=a.e({deceleration:1e3,maxSpeed:360},To);class yd{constructor(n){this._map=n,this.clear()}clear(){this._inertiaBuffer=[]}record(n){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:D.now(),settings:n})}_drainInertiaBuffer(){const n=this._inertiaBuffer,l=D.now();for(;n.length>0&&l-n[0].time>160;)n.shift()}_onMoveEnd(n){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const l={zoom:0,bearing:0,pitch:0,roll:0,pan:new a.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:x}of this._inertiaBuffer)l.zoom+=x.zoomDelta||0,l.bearing+=x.bearingDelta||0,l.pitch+=x.pitchDelta||0,l.roll+=x.rollDelta||0,x.panDelta&&l.pan._add(x.panDelta),x.around&&(l.around=x.around),x.pinchAround&&(l.pinchAround=x.pinchAround);const p=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,g={};if(l.pan.mag()){const x=So(l.pan.mag(),p,a.e({},fd,n||{})),T=l.pan.mult(x.amount/l.pan.mag()),A=this._map.cameraHelper.handlePanInertia(T,this._map.transform);g.center=A.easingCenter,g.offset=A.easingOffset,hs(g,x)}if(l.zoom){const x=So(l.zoom,p,pd);g.zoom=this._map.transform.zoom+x.amount,hs(g,x)}if(l.bearing){const x=So(l.bearing,p,gd);g.bearing=this._map.transform.bearing+a.ad(x.amount,-179,179),hs(g,x)}if(l.pitch){const x=So(l.pitch,p,md);g.pitch=this._map.transform.pitch+x.amount,hs(g,x)}if(l.roll){const x=So(l.roll,p,_d);g.roll=this._map.transform.roll+a.ad(x.amount,-179,179),hs(g,x)}if(g.zoom||g.bearing){const x=l.pinchAround===void 0?l.around:l.pinchAround;g.around=x?this._map.unproject(x):this._map.getCenter()}return this.clear(),a.e(g,{noMoveStart:!0})}}function hs(_,n){(!_.duration||_.duration<n.duration)&&(_.duration=n.duration,_.easing=n.easing)}function So(_,n,l){const{maxSpeed:p,linearity:g,deceleration:x}=l,T=a.ad(_*g/(n/1e3),-p,p),A=Math.abs(T)/(x*g);return{easing:l.easing,duration:1e3*A,amount:T*(A/2)}}class Di extends a.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,l,p,g={}){const x=F.mousePos(l.getCanvas(),p),T=l.unproject(x);super(n,a.e({point:x,lngLat:T,originalEvent:p},g)),this._defaultPrevented=!1,this.target=l}}class Rr extends a.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,l,p){const g=n==="touchend"?p.changedTouches:p.touches,x=F.touchPos(l.getCanvasContainer(),g),T=x.map((C=>l.unproject(C))),A=x.reduce(((C,R,L,N)=>C.add(R.div(N.length))),new a.P(0,0));super(n,{points:x,point:A,lngLats:T,lngLat:l.unproject(A),originalEvent:p}),this._defaultPrevented=!1}}class hu extends a.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,l,p){super(n,{originalEvent:p}),this._defaultPrevented=!1}}class Tn{constructor(n,l){this._map=n,this._clickTolerance=l.clickTolerance}reset(){delete this._mousedownPos}wheel(n){return this._firePreventable(new hu(n.type,this._map,n))}mousedown(n,l){return this._mousedownPos=l,this._firePreventable(new Di(n.type,this._map,n))}mouseup(n){this._map.fire(new Di(n.type,this._map,n))}click(n,l){this._mousedownPos&&this._mousedownPos.dist(l)>=this._clickTolerance||this._map.fire(new Di(n.type,this._map,n))}dblclick(n){return this._firePreventable(new Di(n.type,this._map,n))}mouseover(n){this._map.fire(new Di(n.type,this._map,n))}mouseout(n){this._map.fire(new Di(n.type,this._map,n))}touchstart(n){return this._firePreventable(new Rr(n.type,this._map,n))}touchmove(n){this._map.fire(new Rr(n.type,this._map,n))}touchend(n){this._map.fire(new Rr(n.type,this._map,n))}touchcancel(n){this._map.fire(new Rr(n.type,this._map,n))}_firePreventable(n){if(this._map.fire(n),n.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Eo{constructor(n){this._map=n}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(n){this._map.fire(new Di(n.type,this._map,n))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Di("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(n){this._delayContextMenu?this._contextMenuEvent=n:this._ignoreContextMenu||this._map.fire(new Di(n.type,this._map,n)),this._map.listens("contextmenu")&&n.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ca{constructor(n){this._map=n}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(n){return this.transform.screenPointToLocation(a.P.convert(n),this._map.terrain)}}class xd{constructor(n,l){this._map=n,this._tr=new ca(n),this._el=n.getCanvasContainer(),this._container=n.getContainer(),this._clickTolerance=l.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(n,l){this.isEnabled()&&n.shiftKey&&n.button===0&&(F.disableDrag(),this._startPos=this._lastPos=l,this._active=!0)}mousemoveWindow(n,l){if(!this._active)return;const p=l;if(this._lastPos.equals(p)||!this._box&&p.dist(this._startPos)<this._clickTolerance)return;const g=this._startPos;this._lastPos=p,this._box||(this._box=F.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",n));const x=Math.min(g.x,p.x),T=Math.max(g.x,p.x),A=Math.min(g.y,p.y),C=Math.max(g.y,p.y);F.setTransform(this._box,`translate(${x}px,${A}px)`),this._box.style.width=T-x+"px",this._box.style.height=C-A+"px"}mouseupWindow(n,l){if(!this._active||n.button!==0)return;const p=this._startPos,g=l;if(this.reset(),F.suppressClick(),p.x!==g.x||p.y!==g.y)return this._map.fire(new a.l("boxzoomend",{originalEvent:n})),{cameraAnimation:x=>x.fitScreenCoordinates(p,g,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",n)}keydown(n){this._active&&n.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",n))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(F.remove(this._box),this._box=null),F.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(n,l){return this._map.fire(new a.l(n,{originalEvent:l}))}}function du(_,n){if(_.length!==n.length)throw new Error(`The number of touches and points are not equal - touches ${_.length}, points ${n.length}`);const l={};for(let p=0;p<_.length;p++)l[_[p].identifier]=n[p];return l}class jp{constructor(n){this.reset(),this.numTouches=n.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(n,l,p){(this.centroid||p.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===void 0&&(this.startTime=n.timeStamp),p.length===this.numTouches&&(this.centroid=(function(g){const x=new a.P(0,0);for(const T of g)x._add(T);return x.div(g.length)})(l),this.touches=du(p,l)))}touchmove(n,l,p){if(this.aborted||!this.centroid)return;const g=du(p,l);for(const x in this.touches){const T=g[x];(!T||T.dist(this.touches[x])>30)&&(this.aborted=!0)}}touchend(n,l,p){if((!this.centroid||n.timeStamp-this.startTime>500)&&(this.aborted=!0),p.length===0){const g=!this.aborted&&this.centroid;if(this.reset(),g)return g}}}class bl{constructor(n){this.singleTap=new jp(n),this.numTaps=n.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(n,l,p){this.singleTap.touchstart(n,l,p)}touchmove(n,l,p){this.singleTap.touchmove(n,l,p)}touchend(n,l,p){const g=this.singleTap.touchend(n,l,p);if(g){const x=n.timeStamp-this.lastTime<500,T=!this.lastTap||this.lastTap.dist(g)<30;if(x&&T||this.reset(),this.count++,this.lastTime=n.timeStamp,this.lastTap=g,this.count===this.numTaps)return this.reset(),g}}}class ua{constructor(n){this._tr=new ca(n),this._zoomIn=new bl({numTouches:1,numTaps:2}),this._zoomOut=new bl({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(n,l,p){this._zoomIn.touchstart(n,l,p),this._zoomOut.touchstart(n,l,p)}touchmove(n,l,p){this._zoomIn.touchmove(n,l,p),this._zoomOut.touchmove(n,l,p)}touchend(n,l,p){const g=this._zoomIn.touchend(n,l,p),x=this._zoomOut.touchend(n,l,p),T=this._tr;return g?(this._active=!0,n.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:A=>A.easeTo({duration:300,zoom:T.zoom+1,around:T.unproject(g)},{originalEvent:n})}):x?(this._active=!0,n.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:A=>A.easeTo({duration:300,zoom:T.zoom-1,around:T.unproject(x)},{originalEvent:n})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Vr{constructor(n){this._enabled=!!n.enable,this._moveStateManager=n.moveStateManager,this._clickTolerance=n.clickTolerance||1,this._moveFunction=n.move,this._activateOnStart=!!n.activateOnStart,n.assignEvents(this),this.reset()}reset(n){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(n)}_move(...n){const l=this._moveFunction(...n);if(l.bearingDelta||l.pitchDelta||l.rollDelta||l.around||l.panDelta)return this._active=!0,l}dragStart(n,l){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(n)&&(this._moveStateManager.startMove(n),this._lastPoint=Array.isArray(l)?l[0]:l,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(n,l){if(!this.isEnabled())return;const p=this._lastPoint;if(!p)return;if(n.preventDefault(),!this._moveStateManager.isValidMoveEvent(n))return void this.reset(n);const g=Array.isArray(l)?l[0]:l;return!this._moved&&g.dist(p)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=g,this._move(p,g))}dragEnd(n){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(n)&&(this._moved&&F.suppressClick(),this.reset(n))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const wt={0:1,2:2};class Ao{constructor(n){this._correctEvent=n.checkCorrectEvent}startMove(n){const l=F.mouseButton(n);this._eventButton=l}endMove(n){delete this._eventButton}isValidStartEvent(n){return this._correctEvent(n)}isValidMoveEvent(n){return!(function(l,p){const g=wt[p];return l.buttons===void 0||(l.buttons&g)!==g})(n,this._eventButton)}isValidEndEvent(n){return F.mouseButton(n)===this._eventButton}}class fu{constructor(){this._firstTouch=void 0}_isOneFingerTouch(n){return n.targetTouches.length===1}_isSameTouchEvent(n){return n.targetTouches[0].identifier===this._firstTouch}startMove(n){this._firstTouch=n.targetTouches[0].identifier}endMove(n){delete this._firstTouch}isValidStartEvent(n){return this._isOneFingerTouch(n)}isValidMoveEvent(n){return this._isOneFingerTouch(n)&&this._isSameTouchEvent(n)}isValidEndEvent(n){return this._isOneFingerTouch(n)&&this._isSameTouchEvent(n)}}class vd{constructor(n=new Ao({checkCorrectEvent:()=>!0}),l=new fu){this.mouseMoveStateManager=n,this.oneFingerTouchMoveStateManager=l}_executeRelevantHandler(n,l,p){return n instanceof MouseEvent?l(n):typeof TouchEvent<"u"&&n instanceof TouchEvent?p(n):void 0}startMove(n){this._executeRelevantHandler(n,(l=>this.mouseMoveStateManager.startMove(l)),(l=>this.oneFingerTouchMoveStateManager.startMove(l)))}endMove(n){this._executeRelevantHandler(n,(l=>this.mouseMoveStateManager.endMove(l)),(l=>this.oneFingerTouchMoveStateManager.endMove(l)))}isValidStartEvent(n){return this._executeRelevantHandler(n,(l=>this.mouseMoveStateManager.isValidStartEvent(l)),(l=>this.oneFingerTouchMoveStateManager.isValidStartEvent(l)))}isValidMoveEvent(n){return this._executeRelevantHandler(n,(l=>this.mouseMoveStateManager.isValidMoveEvent(l)),(l=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(l)))}isValidEndEvent(n){return this._executeRelevantHandler(n,(l=>this.mouseMoveStateManager.isValidEndEvent(l)),(l=>this.oneFingerTouchMoveStateManager.isValidEndEvent(l)))}}const ds=_=>{_.mousedown=_.dragStart,_.mousemoveWindow=_.dragMove,_.mouseup=_.dragEnd,_.contextmenu=n=>{n.preventDefault()}};class ha{constructor(n,l){this._clickTolerance=n.clickTolerance||1,this._map=l,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new a.P(0,0)}_shouldBePrevented(n){return n<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(n,l,p){return this._calculateTransform(n,l,p)}touchmove(n,l,p){if(this._active){if(!this._shouldBePrevented(p.length))return n.preventDefault(),this._calculateTransform(n,l,p);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",n)}}touchend(n,l,p){this._calculateTransform(n,l,p),this._active&&this._shouldBePrevented(p.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(n,l,p){p.length>0&&(this._active=!0);const g=du(p,l),x=new a.P(0,0),T=new a.P(0,0);let A=0;for(const R in g){const L=g[R],N=this._touches[R];N&&(x._add(L),T._add(L.sub(N)),A++,g[R]=L)}if(this._touches=g,this._shouldBePrevented(A)||!T.mag())return;const C=T.div(A);return this._sum._add(C),this._sum.mag()<this._clickTolerance?void 0:{around:x.div(A),panDelta:C}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class wl{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(n,l,p){this._firstTwoTouches||p.length<2||(this._firstTwoTouches=[p[0].identifier,p[1].identifier],this._start([l[0],l[1]]))}touchmove(n,l,p){if(!this._firstTwoTouches)return;n.preventDefault();const[g,x]=this._firstTwoTouches,T=qt(p,l,g),A=qt(p,l,x);if(!T||!A)return;const C=this._aroundCenter?null:T.add(A).div(2);return this._move([T,A],C,n)}touchend(n,l,p){if(!this._firstTwoTouches)return;const[g,x]=this._firstTwoTouches,T=qt(p,l,g),A=qt(p,l,x);T&&A||(this._active&&F.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(n){this._enabled=!0,this._aroundCenter=!!n&&n.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function qt(_,n,l){for(let p=0;p<_.length;p++)if(_[p].identifier===l)return n[p]}function Tl(_,n){return Math.log(_/n)/Math.LN2}class bd extends wl{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(n){this._startDistance=this._distance=n[0].dist(n[1])}_move(n,l){const p=this._distance;if(this._distance=n[0].dist(n[1]),this._active||!(Math.abs(Tl(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Tl(this._distance,p),pinchAround:l}}}function Sl(_,n){return 180*_.angleWith(n)/Math.PI}class wd extends wl{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(n){this._startVector=this._vector=n[0].sub(n[1]),this._minDiameter=n[0].dist(n[1])}_move(n,l,p){const g=this._vector;if(this._vector=n[0].sub(n[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:Sl(this._vector,g),pinchAround:l}}_isBelowThreshold(n){this._minDiameter=Math.min(this._minDiameter,n.mag());const l=25/(Math.PI*this._minDiameter)*360,p=Sl(n,this._startVector);return Math.abs(p)<l}}function pu(_){return Math.abs(_.y)>Math.abs(_.x)}class gu extends wl{constructor(n){super(),this._currentTouchCount=0,this._map=n}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(n,l,p){super.touchstart(n,l,p),this._currentTouchCount=p.length}_start(n){this._lastPoints=n,pu(n[0].sub(n[1]))&&(this._valid=!1)}_move(n,l,p){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const g=n[0].sub(this._lastPoints[0]),x=n[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically(g,x,p.timeStamp),this._valid?(this._lastPoints=n,this._active=!0,{pitchDelta:(g.y+x.y)/2*-.5}):void 0}gestureBeginsVertically(n,l,p){if(this._valid!==void 0)return this._valid;const g=n.mag()>=2,x=l.mag()>=2;if(!g&&!x)return;if(!g||!x)return this._firstMove===void 0&&(this._firstMove=p),p-this._firstMove<100&&void 0;const T=n.y>0==l.y>0;return pu(n)&&pu(l)&&T}}const mu={panStep:100,bearingStep:15,pitchStep:10};class _u{constructor(n){this._tr=new ca(n);const l=mu;this._panStep=l.panStep,this._bearingStep=l.bearingStep,this._pitchStep=l.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(n){if(n.altKey||n.ctrlKey||n.metaKey)return;let l=0,p=0,g=0,x=0,T=0;switch(n.keyCode){case 61:case 107:case 171:case 187:l=1;break;case 189:case 109:case 173:l=-1;break;case 37:n.shiftKey?p=-1:(n.preventDefault(),x=-1);break;case 39:n.shiftKey?p=1:(n.preventDefault(),x=1);break;case 38:n.shiftKey?g=1:(n.preventDefault(),T=-1);break;case 40:n.shiftKey?g=-1:(n.preventDefault(),T=1);break;default:return}return this._rotationDisabled&&(p=0,g=0),{cameraAnimation:A=>{const C=this._tr;A.easeTo({duration:300,easeId:"keyboardHandler",easing:$p,zoom:l?Math.round(C.zoom)+l*(n.shiftKey?2:1):C.zoom,bearing:C.bearing+p*this._bearingStep,pitch:C.pitch+g*this._pitchStep,offset:[-x*this._panStep,-T*this._panStep],center:C.center},{originalEvent:n})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function $p(_){return _*(2-_)}const yu=4.000244140625;class Td{constructor(n,l){this._onTimeout=p=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(p)},this._map=n,this._tr=new ca(n),this._triggerRenderFrame=l,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(n){this._defaultZoomRate=n}setWheelZoomRate(n){this._wheelZoomRate=n}isEnabled(){return!!this._enabled}isActive(){return!!this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(n){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!n&&n.around==="center")}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(n){return!!this._map.cooperativeGestures.isEnabled()&&!(n.ctrlKey||this._map.cooperativeGestures.isBypassed(n))}wheel(n){if(!this.isEnabled())return;if(this._shouldBePrevented(n))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",n);let l=n.deltaMode===WheelEvent.DOM_DELTA_LINE?40*n.deltaY:n.deltaY;const p=D.now(),g=p-(this._lastWheelEventTime||0);this._lastWheelEventTime=p,l!==0&&l%yu==0?this._type="wheel":l!==0&&Math.abs(l)<4?this._type="trackpad":g>400?(this._type=null,this._lastValue=l,this._timeout=setTimeout(this._onTimeout,40,n)):this._type||(this._type=Math.abs(g*l)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,l+=this._lastValue)),n.shiftKey&&l&&(l/=4),this._type&&(this._lastWheelEvent=n,this._delta-=l,this._active||this._start(n)),n.preventDefault()}_start(n){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const l=F.mousePos(this._map.getCanvas(),n),p=this._tr;this._aroundPoint=this._aroundCenter?p.transform.locationToScreenPoint(a.Q.convert(p.center)):l,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const n=this._tr.transform;if(typeof this._lastExpectedZoom=="number"){const A=n.zoom-this._lastExpectedZoom;typeof this._startZoom=="number"&&(this._startZoom+=A),typeof this._targetZoom=="number"&&(this._targetZoom+=A)}if(this._delta!==0){const A=this._type==="wheel"&&Math.abs(this._delta)>yu?this._wheelZoomRate:this._defaultZoomRate;let C=2/(1+Math.exp(-Math.abs(this._delta*A)));this._delta<0&&C!==0&&(C=1/C);const R=typeof this._targetZoom!="number"?n.scale:a.aH(this._targetZoom);this._targetZoom=Math.min(n.maxZoom,Math.max(n.minZoom,a.aa(R*C))),this._type==="wheel"&&(this._startZoom=n.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const l=typeof this._targetZoom!="number"?n.zoom:this._targetZoom,p=this._startZoom,g=this._easing;let x,T=!1;if(this._type==="wheel"&&p&&g){const A=D.now()-this._lastWheelEventTime,C=Math.min((A+5)/200,1),R=g(C);x=a.B.number(p,l,R),C<1?this._frameId||(this._frameId=!0):T=!0}else x=l,T=!0;return this._active=!0,T&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout}),200)),this._lastExpectedZoom=x,{noInertia:!0,needsRenderFrame:!T,zoomDelta:x-n.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(n){let l=a.ca;if(this._prevEase){const p=this._prevEase,g=(D.now()-p.start)/p.duration,x=p.easing(g+.01)-p.easing(g),T=.27/Math.sqrt(x*x+1e-4)*.01,A=Math.sqrt(.0729-T*T);l=a.c8(T,A,.25,1)}return this._prevEase={start:D.now(),duration:n,easing:l},l}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class Sd{constructor(n,l){this._clickZoom=n,this._tapZoom=l}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class fs{constructor(n){this._tr=new ca(n),this.reset()}reset(){this._active=!1}dblclick(n,l){return n.preventDefault(),{cameraAnimation:p=>{p.easeTo({duration:300,zoom:this._tr.zoom+(n.shiftKey?-1:1),around:this._tr.unproject(l)},{originalEvent:n})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ci{constructor(){this._tap=new bl({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(n,l,p){if(!this._swipePoint)if(this._tapTime){const g=l[0],x=n.timeStamp-this._tapTime<500,T=this._tapPoint.dist(g)<30;x&&T?p.length>0&&(this._swipePoint=g,this._swipeTouch=p[0].identifier):this.reset()}else this._tap.touchstart(n,l,p)}touchmove(n,l,p){if(this._tapTime){if(this._swipePoint){if(p[0].identifier!==this._swipeTouch)return;const g=l[0],x=g.y-this._swipePoint.y;return this._swipePoint=g,n.preventDefault(),this._active=!0,{zoomDelta:x/128}}}else this._tap.touchmove(n,l,p)}touchend(n,l,p){if(this._tapTime)this._swipePoint&&p.length===0&&this.reset();else{const g=this._tap.touchend(n,l,p);g&&(this._tapTime=n.timeStamp,this._tapPoint=g)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class da{constructor(n,l,p){this._el=n,this._mousePan=l,this._touchPan=p}enable(n){this._inertiaOptions=n||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class El{constructor(n,l,p,g){this._pitchWithRotate=n.pitchWithRotate,this._rollEnabled=n.rollEnabled,this._mouseRotate=l,this._mousePitch=p,this._mouseRoll=g}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class xu{constructor(n,l,p,g){this._el=n,this._touchZoom=l,this._touchRotate=p,this._tapDragZoom=g,this._rotationDisabled=!1,this._enabled=!0}enable(n){this._touchZoom.enable(n),this._rotationDisabled||this._touchRotate.enable(n),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class vu{constructor(n,l){this._bypassKey=navigator.userAgent.indexOf("Mac")!==-1?"metaKey":"ctrlKey",this._map=n,this._options=l,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const n=this._map.getCanvasContainer();n.classList.add("maplibregl-cooperative-gestures"),this._container=F.create("div","maplibregl-cooperative-gesture-screen",n);let l=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");this._bypassKey==="metaKey"&&(l=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const p=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),g=document.createElement("div");g.className="maplibregl-desktop-message",g.textContent=l,this._container.appendChild(g);const x=document.createElement("div");x.className="maplibregl-mobile-message",x.textContent=p,this._container.appendChild(x),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(F.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(n){return n[this._bypassKey]}notifyGestureBlocked(n,l){this._enabled&&(this._map.fire(new a.l("cooperativegestureprevented",{gestureType:n,originalEvent:l})),this._container.classList.add("maplibregl-show"),setTimeout((()=>{this._container.classList.remove("maplibregl-show")}),100))}}const fa=_=>_.zoom||_.drag||_.roll||_.pitch||_.rotate;class Wp extends a.l{}function en(_){return _.panDelta&&_.panDelta.mag()||_.zoomDelta||_.bearingDelta||_.pitchDelta||_.rollDelta}class Al{constructor(n,l){this.handleWindowEvent=g=>{this.handleEvent(g,`${g.type}Window`)},this.handleEvent=(g,x)=>{if(g.type==="blur")return void this.stop(!0);this._updatingCamera=!0;const T=g.type==="renderFrame"?void 0:g,A={needsRenderFrame:!1},C={},R={},L=g.touches,N=L?this._getMapTouches(L):void 0,z=N?F.touchPos(this._map.getCanvas(),N):F.mousePos(this._map.getCanvas(),g);for(const{handlerName:se,handler:ne,allowed:le}of this._handlers){if(!ne.isEnabled())continue;let he;this._blockedByActive(R,le,se)?ne.reset():ne[x||g.type]&&(he=ne[x||g.type](g,z,N),this.mergeHandlerResult(A,C,he,se,T),he&&he.needsRenderFrame&&this._triggerRenderFrame()),(he||ne.isActive())&&(R[se]=ne)}const H={};for(const se in this._previousActiveHandlers)R[se]||(H[se]=T);this._previousActiveHandlers=R,(Object.keys(H).length||en(A))&&(this._changes.push([A,C,H]),this._triggerRenderFrame()),(Object.keys(R).length||en(A))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:q}=A;q&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],q(this._map))},this._map=n,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new yd(n),this._bearingSnap=l.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(l);const p=this._el;this._listeners=[[p,"touchstart",{passive:!0}],[p,"touchmove",{passive:!1}],[p,"touchend",void 0],[p,"touchcancel",void 0],[p,"mousedown",void 0],[p,"mousemove",void 0],[p,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[p,"mouseover",void 0],[p,"mouseout",void 0],[p,"dblclick",void 0],[p,"click",void 0],[p,"keydown",{capture:!1}],[p,"keyup",void 0],[p,"wheel",{passive:!1}],[p,"contextmenu",void 0],[window,"blur",void 0]];for(const[g,x,T]of this._listeners)F.addEventListener(g,x,g===document?this.handleWindowEvent:this.handleEvent,T)}destroy(){for(const[n,l,p]of this._listeners)F.removeEventListener(n,l,n===document?this.handleWindowEvent:this.handleEvent,p)}_addDefaultHandlers(n){const l=this._map,p=l.getCanvasContainer();this._add("mapEvent",new Tn(l,n));const g=l.boxZoom=new xd(l,n);this._add("boxZoom",g),n.interactive&&n.boxZoom&&g.enable();const x=l.cooperativeGestures=new vu(l,n.cooperativeGestures);this._add("cooperativeGestures",x),n.cooperativeGestures&&x.enable();const T=new ua(l),A=new fs(l);l.doubleClickZoom=new Sd(A,T),this._add("tapZoom",T),this._add("clickZoom",A),n.interactive&&n.doubleClickZoom&&l.doubleClickZoom.enable();const C=new Ci;this._add("tapDragZoom",C);const R=l.touchPitch=new gu(l);this._add("touchPitch",R),n.interactive&&n.touchPitch&&l.touchPitch.enable(n.touchPitch);const L=()=>l.project(l.getCenter()),N=(function({enable:ve,clickTolerance:Pe,aroundCenter:Re=!0,minPixelCenterThreshold:Ie=100,rotateDegreesPerPixelMoved:$e=.8},He){const it=new Ao({checkCorrectEvent:nt=>F.mouseButton(nt)===0&&nt.ctrlKey||F.mouseButton(nt)===2&&!nt.ctrlKey});return new Vr({clickTolerance:Pe,move:(nt,et)=>{const xt=He();if(Re&&Math.abs(xt.y-nt.y)>Ie)return{bearingDelta:a.c9(new a.P(nt.x,et.y),et,xt)};let yt=(et.x-nt.x)*$e;return Re&&et.y<xt.y&&(yt=-yt),{bearingDelta:yt}},moveStateManager:it,enable:ve,assignEvents:ds})})(n,L),z=(function({enable:ve,clickTolerance:Pe,pitchDegreesPerPixelMoved:Re=-.5}){const Ie=new Ao({checkCorrectEvent:$e=>F.mouseButton($e)===0&&$e.ctrlKey||F.mouseButton($e)===2});return new Vr({clickTolerance:Pe,move:($e,He)=>({pitchDelta:(He.y-$e.y)*Re}),moveStateManager:Ie,enable:ve,assignEvents:ds})})(n),H=(function({enable:ve,clickTolerance:Pe,rollDegreesPerPixelMoved:Re=.3},Ie){const $e=new Ao({checkCorrectEvent:He=>F.mouseButton(He)===2&&He.ctrlKey});return new Vr({clickTolerance:Pe,move:(He,it)=>{const nt=Ie();let et=(it.x-He.x)*Re;return it.y<nt.y&&(et=-et),{rollDelta:et}},moveStateManager:$e,enable:ve,assignEvents:ds})})(n,L);l.dragRotate=new El(n,N,z,H),this._add("mouseRotate",N,["mousePitch"]),this._add("mousePitch",z,["mouseRotate","mouseRoll"]),this._add("mouseRoll",H,["mousePitch"]),n.interactive&&n.dragRotate&&l.dragRotate.enable();const q=(function({enable:ve,clickTolerance:Pe}){const Re=new Ao({checkCorrectEvent:Ie=>F.mouseButton(Ie)===0&&!Ie.ctrlKey});return new Vr({clickTolerance:Pe,move:(Ie,$e)=>({around:$e,panDelta:$e.sub(Ie)}),activateOnStart:!0,moveStateManager:Re,enable:ve,assignEvents:ds})})(n),se=new ha(n,l);l.dragPan=new da(p,q,se),this._add("mousePan",q),this._add("touchPan",se,["touchZoom","touchRotate"]),n.interactive&&n.dragPan&&l.dragPan.enable(n.dragPan);const ne=new wd,le=new bd;l.touchZoomRotate=new xu(p,le,ne,C),this._add("touchRotate",ne,["touchPan","touchZoom"]),this._add("touchZoom",le,["touchPan","touchRotate"]),n.interactive&&n.touchZoomRotate&&l.touchZoomRotate.enable(n.touchZoomRotate);const he=l.scrollZoom=new Td(l,(()=>this._triggerRenderFrame()));this._add("scrollZoom",he,["mousePan"]),n.interactive&&n.scrollZoom&&l.scrollZoom.enable(n.scrollZoom);const xe=l.keyboard=new _u(l);this._add("keyboard",xe),n.interactive&&n.keyboard&&l.keyboard.enable(),this._add("blockableMapEvent",new Eo(l))}_add(n,l,p){this._handlers.push({handlerName:n,handler:l,allowed:p}),this._handlersById[n]=l}stop(n){if(!this._updatingCamera){for(const{handler:l}of this._handlers)l.reset();this._inertia.clear(),this._fireEvents({},{},n),this._changes=[]}}isActive(){for(const{handler:n}of this._handlers)if(n.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!fa(this._eventsInProgress)||this.isZooming()}_blockedByActive(n,l,p){for(const g in n)if(g!==p&&(!l||l.indexOf(g)<0))return!0;return!1}_getMapTouches(n){const l=[];for(const p of n)this._el.contains(p.target)&&l.push(p);return l}mergeHandlerResult(n,l,p,g,x){if(!p)return;a.e(n,p);const T={handlerName:g,originalEvent:p.originalEvent||x};p.zoomDelta!==void 0&&(l.zoom=T),p.panDelta!==void 0&&(l.drag=T),p.rollDelta!==void 0&&(l.roll=T),p.pitchDelta!==void 0&&(l.pitch=T),p.bearingDelta!==void 0&&(l.rotate=T)}_applyChanges(){const n={},l={},p={};for(const[g,x,T]of this._changes)g.panDelta&&(n.panDelta=(n.panDelta||new a.P(0,0))._add(g.panDelta)),g.zoomDelta&&(n.zoomDelta=(n.zoomDelta||0)+g.zoomDelta),g.bearingDelta&&(n.bearingDelta=(n.bearingDelta||0)+g.bearingDelta),g.pitchDelta&&(n.pitchDelta=(n.pitchDelta||0)+g.pitchDelta),g.rollDelta&&(n.rollDelta=(n.rollDelta||0)+g.rollDelta),g.around!==void 0&&(n.around=g.around),g.pinchAround!==void 0&&(n.pinchAround=g.pinchAround),g.noInertia&&(n.noInertia=g.noInertia),a.e(l,x),a.e(p,T);this._updateMapTransform(n,l,p),this._changes=[]}_updateMapTransform(n,l,p){const g=this._map,x=g._getTransformForUpdate(),T=g.terrain;if(!(en(n)||T&&this._terrainMovement))return this._fireEvents(l,p,!0);g._stop(!0);let{panDelta:A,zoomDelta:C,bearingDelta:R,pitchDelta:L,rollDelta:N,around:z,pinchAround:H}=n;H!==void 0&&(z=H),z=z||g.transform.centerPoint,T&&!x.isPointOnMapSurface(z)&&(z=x.centerPoint);const q={panDelta:A,zoomDelta:C,rollDelta:N,pitchDelta:L,bearingDelta:R,around:z};this._map.cameraHelper.useGlobeControls&&!x.isPointOnMapSurface(z)&&(z=x.centerPoint);const se=z.distSqr(x.centerPoint)<.01?x.center:x.screenPointToLocation(A?z.sub(A):z);T?(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(q,x),this._terrainMovement||!l.drag&&!l.zoom?l.drag&&this._terrainMovement?x.setCenter(x.screenPointToLocation(x.centerPoint.sub(A))):this._map.cameraHelper.handleMapControlsPan(q,x,se):(this._terrainMovement=!0,this._map._elevationFreeze=!0,this._map.cameraHelper.handleMapControlsPan(q,x,se))):(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(q,x),this._map.cameraHelper.handleMapControlsPan(q,x,se)),g._applyUpdatedTransform(x),this._map._update(),n.noInertia||this._inertia.record(n),this._fireEvents(l,p,!0)}_fireEvents(n,l,p){const g=fa(this._eventsInProgress),x=fa(n),T={};for(const N in n){const{originalEvent:z}=n[N];this._eventsInProgress[N]||(T[`${N}start`]=z),this._eventsInProgress[N]=n[N]}!g&&x&&this._fireEvent("movestart",x.originalEvent);for(const N in T)this._fireEvent(N,T[N]);x&&this._fireEvent("move",x.originalEvent);for(const N in n){const{originalEvent:z}=n[N];this._fireEvent(N,z)}const A={};let C;for(const N in this._eventsInProgress){const{handlerName:z,originalEvent:H}=this._eventsInProgress[N];this._handlersById[z].isActive()||(delete this._eventsInProgress[N],C=l[z]||H,A[`${N}end`]=C)}for(const N in A)this._fireEvent(N,A[N]);const R=fa(this._eventsInProgress),L=(g||x)&&!R;if(L&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const N=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&N.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(N)}if(p&&L){this._updatingCamera=!0;const N=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),z=H=>H!==0&&-this._bearingSnap<H&&H<this._bearingSnap;!N||!N.essential&&D.prefersReducedMotion?(this._map.fire(new a.l("moveend",{originalEvent:C})),z(this._map.getBearing())&&this._map.resetNorth()):(z(N.bearing||this._map.getBearing())&&(N.bearing=0),N.freezeElevation=!0,this._map.easeTo(N,{originalEvent:C})),this._updatingCamera=!1}}_fireEvent(n,l){this._map.fire(new a.l(n,l?{originalEvent:l}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((n=>{delete this._frameId,this.handleEvent(new Wp("renderFrame",{timeStamp:n})),this._applyChanges()}))}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}class Mt extends a.E{constructor(n,l,p){super(),this._renderFrameCallback=()=>{const g=Math.min((D.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(g)),g<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=n,this._bearingSnap=p.bearingSnap,this.cameraHelper=l,this.on("moveend",(()=>{delete this._requestedCameraState}))}migrateProjection(n,l){n.apply(this.transform),this.transform=n,this.cameraHelper=l}getCenter(){return new a.Q(this.transform.center.lng,this.transform.center.lat)}setCenter(n,l){return this.jumpTo({center:n},l)}getCenterElevation(){return this.transform.elevation}setCenterElevation(n,l){return this.jumpTo({elevation:n},l),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(n){this._centerClampedToGround=n}panBy(n,l,p){return n=a.P.convert(n).mult(-1),this.panTo(this.transform.center,a.e({offset:n},l),p)}panTo(n,l,p){return this.easeTo(a.e({center:n},l),p)}getZoom(){return this.transform.zoom}setZoom(n,l){return this.jumpTo({zoom:n},l),this}zoomTo(n,l,p){return this.easeTo(a.e({zoom:n},l),p)}zoomIn(n,l){return this.zoomTo(this.getZoom()+1,n,l),this}zoomOut(n,l){return this.zoomTo(this.getZoom()-1,n,l),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(n,l){return n!=this.transform.fov&&(this.transform.setFov(n),this.fire(new a.l("movestart",l)).fire(new a.l("move",l)).fire(new a.l("moveend",l))),this}getBearing(){return this.transform.bearing}setBearing(n,l){return this.jumpTo({bearing:n},l),this}getPadding(){return this.transform.padding}setPadding(n,l){return this.jumpTo({padding:n},l),this}rotateTo(n,l,p){return this.easeTo(a.e({bearing:n},l),p)}resetNorth(n,l){return this.rotateTo(0,a.e({duration:1e3},n),l),this}resetNorthPitch(n,l){return this.easeTo(a.e({bearing:0,pitch:0,roll:0,duration:1e3},n),l),this}snapToNorth(n,l){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(n,l):this}getPitch(){return this.transform.pitch}setPitch(n,l){return this.jumpTo({pitch:n},l),this}getRoll(){return this.transform.roll}setRoll(n,l){return this.jumpTo({roll:n},l),this}cameraForBounds(n,l){n=Yt.convert(n).adjustAntiMeridian();const p=l&&l.bearing||0;return this._cameraForBoxAndBearing(n.getNorthWest(),n.getSouthEast(),p,l)}_cameraForBoxAndBearing(n,l,p,g){const x={top:0,bottom:0,right:0,left:0};if(typeof(g=a.e({padding:x,offset:[0,0],maxZoom:this.transform.maxZoom},g)).padding=="number"){const R=g.padding;g.padding={top:R,bottom:R,right:R,left:R}}const T=a.e(x,g.padding);g.padding=T;const A=this.transform,C=new Yt(n,l);return this.cameraHelper.cameraForBoxAndBearing(g,T,C,p,A)}fitBounds(n,l,p){return this._fitInternal(this.cameraForBounds(n,l),l,p)}fitScreenCoordinates(n,l,p,g,x){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(a.P.convert(n)),this.transform.screenPointToLocation(a.P.convert(l)),p,g),g,x)}_fitInternal(n,l,p){return n?(delete(l=a.e(n,l)).padding,l.linear?this.easeTo(l,p):this.flyTo(l,p)):this}jumpTo(n,l){this.stop();const p=this._getTransformForUpdate();let g=!1,x=!1,T=!1;const A=p.zoom;this.cameraHelper.handleJumpToCenterZoom(p,n);const C=p.zoom!==A;return"elevation"in n&&p.elevation!==+n.elevation&&p.setElevation(+n.elevation),"bearing"in n&&p.bearing!==+n.bearing&&(g=!0,p.setBearing(+n.bearing)),"pitch"in n&&p.pitch!==+n.pitch&&(x=!0,p.setPitch(+n.pitch)),"roll"in n&&p.roll!==+n.roll&&(T=!0,p.setRoll(+n.roll)),n.padding==null||p.isPaddingEqual(n.padding)||p.setPadding(n.padding),this._applyUpdatedTransform(p),this.fire(new a.l("movestart",l)).fire(new a.l("move",l)),C&&this.fire(new a.l("zoomstart",l)).fire(new a.l("zoom",l)).fire(new a.l("zoomend",l)),g&&this.fire(new a.l("rotatestart",l)).fire(new a.l("rotate",l)).fire(new a.l("rotateend",l)),x&&this.fire(new a.l("pitchstart",l)).fire(new a.l("pitch",l)).fire(new a.l("pitchend",l)),T&&this.fire(new a.l("rollstart",l)).fire(new a.l("roll",l)).fire(new a.l("rollend",l)),this.fire(new a.l("moveend",l))}calculateCameraOptionsFromTo(n,l,p,g=0){const x=a.$.fromLngLat(n,l),T=a.$.fromLngLat(p,g),A=T.x-x.x,C=T.y-x.y,R=T.z-x.z,L=Math.hypot(A,C,R);if(L===0)throw new Error("Can't calculate camera options with same From and To");const N=Math.hypot(A,C),z=a.aa(this.transform.cameraToCenterDistance/L/this.transform.tileSize),H=180*Math.atan2(A,-C)/Math.PI;let q=180*Math.acos(N/L)/Math.PI;return q=R<0?90-q:90+q,{center:T.toLngLat(),elevation:g,zoom:z,pitch:q,bearing:H}}calculateCameraOptionsFromCameraLngLatAltRotation(n,l,p,g,x){const T=this.transform.calculateCenterFromCameraLngLatAlt(n,l,p,g);return{center:T.center,elevation:T.elevation,zoom:T.zoom,bearing:p,pitch:g,roll:x}}easeTo(n,l){this._stop(!1,n.easeId),((n=a.e({offset:[0,0],duration:500,easing:a.ca},n)).animate===!1||!n.essential&&D.prefersReducedMotion)&&(n.duration=0);const p=this._getTransformForUpdate(),g=this.getBearing(),x=p.pitch,T=p.roll,A="bearing"in n?this._normalizeBearing(n.bearing,g):g,C="pitch"in n?+n.pitch:x,R="roll"in n?this._normalizeBearing(n.roll,T):T,L="padding"in n?n.padding:p.padding,N=a.P.convert(n.offset);let z,H;n.around&&(z=a.Q.convert(n.around),H=p.locationToScreenPoint(z));const q={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},se=this.cameraHelper.handleEaseTo(p,{bearing:A,pitch:C,roll:R,padding:L,around:z,aroundPoint:H,offsetAsPoint:N,offset:n.offset,zoom:n.zoom,center:n.center});return this._rotating=this._rotating||g!==A,this._pitching=this._pitching||C!==x,this._rolling=this._rolling||R!==T,this._padding=!p.isPaddingEqual(L),this._zooming=this._zooming||se.isZooming,this._easeId=n.easeId,this._prepareEase(l,n.noMoveStart,q),this.terrain&&this._prepareElevation(se.elevationCenter),this._ease((ne=>{se.easeFunc(ne),this.terrain&&!n.freezeElevation&&this._updateElevation(ne),this._applyUpdatedTransform(p),this._fireMoveEvents(l)}),(ne=>{this.terrain&&n.freezeElevation&&this._finalizeElevation(),this._afterEase(l,ne)}),n),this}_prepareEase(n,l,p={}){this._moving=!0,l||p.moving||this.fire(new a.l("movestart",n)),this._zooming&&!p.zooming&&this.fire(new a.l("zoomstart",n)),this._rotating&&!p.rotating&&this.fire(new a.l("rotatestart",n)),this._pitching&&!p.pitching&&this.fire(new a.l("pitchstart",n)),this._rolling&&!p.rolling&&this.fire(new a.l("rollstart",n))}_prepareElevation(n){this._elevationCenter=n,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(n,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(n){this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const l=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(n<1&&l!==this._elevationTarget){const p=this._elevationTarget-this._elevationStart;this._elevationStart+=n*(p-(l-(p*n+this._elevationStart))/(1-n)),this._elevationTarget=l}this.transform.setElevation(a.B.number(this._elevationStart,this._elevationTarget,n))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(n){if(!this.terrain&&n.elevation>=0&&n.pitch<=90)return{};const l=n.getCameraLngLat(),p=n.getCameraAltitude(),g=this.terrain?this.terrain.getElevationForLngLatZoom(l,n.zoom):0;if(p<g){const x=this.calculateCameraOptionsFromTo(l,g,n.center,n.elevation);return{pitch:x.pitch,zoom:x.zoom}}return{}}_applyUpdatedTransform(n){const l=[];if(l.push((g=>this._elevateCameraIfInsideTerrain(g))),this.transformCameraUpdate&&l.push((g=>this.transformCameraUpdate(g))),!l.length)return;const p=n.clone();for(const g of l){const x=p.clone(),{center:T,zoom:A,roll:C,pitch:R,bearing:L,elevation:N}=g(x);T&&x.setCenter(T),N!==void 0&&x.setElevation(N),A!==void 0&&x.setZoom(A),C!==void 0&&x.setRoll(C),R!==void 0&&x.setPitch(R),L!==void 0&&x.setBearing(L),p.apply(x)}this.transform.apply(p)}_fireMoveEvents(n){this.fire(new a.l("move",n)),this._zooming&&this.fire(new a.l("zoom",n)),this._rotating&&this.fire(new a.l("rotate",n)),this._pitching&&this.fire(new a.l("pitch",n)),this._rolling&&this.fire(new a.l("roll",n))}_afterEase(n,l){if(this._easeId&&l&&this._easeId===l)return;delete this._easeId;const p=this._zooming,g=this._rotating,x=this._pitching,T=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,p&&this.fire(new a.l("zoomend",n)),g&&this.fire(new a.l("rotateend",n)),x&&this.fire(new a.l("pitchend",n)),T&&this.fire(new a.l("rollend",n)),this.fire(new a.l("moveend",n))}flyTo(n,l){if(!n.essential&&D.prefersReducedMotion){const et=a.O(n,["center","zoom","bearing","pitch","roll","elevation"]);return this.jumpTo(et,l)}this.stop(),n=a.e({offset:[0,0],speed:1.2,curve:1.42,easing:a.ca},n);const p=this._getTransformForUpdate(),g=p.bearing,x=p.pitch,T=p.roll,A=p.padding,C="bearing"in n?this._normalizeBearing(n.bearing,g):g,R="pitch"in n?+n.pitch:x,L="roll"in n?this._normalizeBearing(n.roll,T):T,N="padding"in n?n.padding:p.padding,z=a.P.convert(n.offset);let H=p.centerPoint.add(z);const q=p.screenPointToLocation(H),se=this.cameraHelper.handleFlyTo(p,{bearing:C,pitch:R,roll:L,padding:N,locationAtOffset:q,offsetAsPoint:z,center:n.center,minZoom:n.minZoom,zoom:n.zoom});let ne=n.curve;const le=Math.max(p.width,p.height),he=le/se.scaleOfZoom,xe=se.pixelPathLength;typeof se.scaleOfMinZoom=="number"&&(ne=Math.sqrt(le/se.scaleOfMinZoom/xe*2));const ve=ne*ne;function Pe(et){const xt=(he*he-le*le+(et?-1:1)*ve*ve*xe*xe)/(2*(et?he:le)*ve*xe);return Math.log(Math.sqrt(xt*xt+1)-xt)}function Re(et){return(Math.exp(et)-Math.exp(-et))/2}function Ie(et){return(Math.exp(et)+Math.exp(-et))/2}const $e=Pe(!1);let He=function(et){return Ie($e)/Ie($e+ne*et)},it=function(et){return le*((Ie($e)*(Re(xt=$e+ne*et)/Ie(xt))-Re($e))/ve)/xe;var xt},nt=(Pe(!0)-$e)/ne;if(Math.abs(xe)<2e-6||!isFinite(nt)){if(Math.abs(le-he)<1e-6)return this.easeTo(n,l);const et=he<le?-1:1;nt=Math.abs(Math.log(he/le))/ne,it=()=>0,He=xt=>Math.exp(et*ne*xt)}return n.duration="duration"in n?+n.duration:1e3*nt/("screenSpeed"in n?+n.screenSpeed/ne:+n.speed),n.maxDuration&&n.duration>n.maxDuration&&(n.duration=0),this._zooming=!0,this._rotating=g!==C,this._pitching=R!==x,this._rolling=L!==T,this._padding=!p.isPaddingEqual(N),this._prepareEase(l,!1),this.terrain&&this._prepareElevation(se.targetCenter),this._ease((et=>{const xt=et*nt,yt=1/He(xt),ct=it(xt);this._rotating&&p.setBearing(a.B.number(g,C,et)),this._pitching&&p.setPitch(a.B.number(x,R,et)),this._rolling&&p.setRoll(a.B.number(T,L,et)),this._padding&&(p.interpolatePadding(A,N,et),H=p.centerPoint.add(z)),se.easeFunc(et,yt,ct,H),this.terrain&&!n.freezeElevation&&this._updateElevation(et),this._applyUpdatedTransform(p),this._fireMoveEvents(l)}),(()=>{this.terrain&&n.freezeElevation&&this._finalizeElevation(),this._afterEase(l)}),n),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(n,l){var p;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const g=this._onEaseEnd;delete this._onEaseEnd,g.call(this,l)}return n||(p=this.handlers)===null||p===void 0||p.stop(!1),this}_ease(n,l,p){p.animate===!1||p.duration===0?(n(1),l()):(this._easeStart=D.now(),this._easeOptions=p,this._onEaseFrame=n,this._onEaseEnd=l,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(n,l){n=a.aK(n,-180,180);const p=Math.abs(n-l);return Math.abs(n-360-l)<p&&(n-=360),Math.abs(n+360-l)<p&&(n+=360),n}queryTerrainElevation(n){return this.terrain?this.terrain.getElevationForLngLatZoom(a.Q.convert(n),this.transform.tileZoom):null}}const Bt={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class pa{constructor(n=Bt){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=l=>{!l||l.sourceDataType!=="metadata"&&l.sourceDataType!=="visibility"&&l.dataType!=="style"&&l.type!=="terrain"||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact===!1?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=n}getDefaultPosition(){return"bottom-right"}onAdd(n){return this._map=n,this._compact=this.options.compact,this._container=F.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=F.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=F.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){F.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._sanitizedAttributionHTML=void 0}_setElementTitle(n,l){const p=this._map._getUIString(`AttributionControl.${l}`);n.title=p,n.setAttribute("aria-label",p)}_updateAttributions(){if(!this._map.style)return;let n=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?n=n.concat(this.options.customAttribution.map((g=>typeof g!="string"?"":g))):typeof this.options.customAttribution=="string"&&n.push(this.options.customAttribution)),this._map.style.stylesheet){const g=this._map.style.stylesheet;this.styleOwner=g.owner,this.styleId=g.id}const l=this._map.style.sourceCaches;for(const g in l){const x=l[g];if(x.used||x.usedForTerrain){const T=x.getSource();T.attribution&&n.indexOf(T.attribution)<0&&n.push(T.attribution)}}n=n.filter((g=>String(g).trim())),n.sort(((g,x)=>g.length-x.length)),n=n.filter(((g,x)=>{for(let T=x+1;T<n.length;T++)if(n[T].indexOf(g)>=0)return!1;return!0}));const p=n.join(" | ");p!==this._sanitizedAttributionHTML&&(this._sanitizedAttributionHTML=F.sanitize(p),n.length?(this._innerContainer.innerHTML=this._sanitizedAttributionHTML,this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class Pl{constructor(n={}){this._updateCompact=()=>{const l=this._container.children;if(l.length){const p=l[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?this._compact!==!1&&p.classList.add("maplibregl-compact"):p.classList.remove("maplibregl-compact")}},this.options=n}getDefaultPosition(){return"bottom-left"}onAdd(n){this._map=n,this._compact=this.options&&this.options.compact,this._container=F.create("div","maplibregl-ctrl");const l=F.create("a","maplibregl-ctrl-logo");return l.target="_blank",l.rel="noopener nofollow",l.href="https://maplibre.org/",l.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),l.setAttribute("rel","noopener nofollow"),this._container.appendChild(l),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){F.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class bu{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(n){const l=++this._id;return this._queue.push({callback:n,id:l,cancelled:!1}),l}remove(n){const l=this._currentlyRunning,p=l?this._queue.concat(l):this._queue;for(const g of p)if(g.id===n)return void(g.cancelled=!0)}run(n=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const l=this._currentlyRunning=this._queue;this._queue=[];for(const p of l)if(!p.cancelled&&(p.callback(n),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var kr=a.aC([{name:"a_pos3d",type:"Int16",components:3}]);class Ed extends a.E{constructor(n){super(),this._lastTilesetChange=D.now(),this.sourceCache=n,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=n._source.tileSize*2**this.deltaZoom,n.usedForTerrain=!0,n.tileSize=this.tileSize}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(n,l){this.sourceCache.update(n,l),this._renderableTilesKeys=[];const p={};for(const g of Ne(n,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:l,calculateTileZoom:this.sourceCache._source.calculateTileZoom}))p[g.key]=!0,this._renderableTilesKeys.push(g.key),this._tiles[g.key]||(g.terrainRttPosMatrix32f=new Float64Array(16),a.bN(g.terrainRttPosMatrix32f,0,a.Z,a.Z,0,0,1),this._tiles[g.key]=new ss(g,this.tileSize),this._lastTilesetChange=D.now());for(const g in this._tiles)p[g]||delete this._tiles[g]}freeRtt(n){for(const l in this._tiles){const p=this._tiles[l];(!n||p.tileID.equals(n)||p.tileID.isChildOf(n)||n.isChildOf(p.tileID))&&(p.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map((n=>this.getTileByID(n)))}getTileByID(n){return this._tiles[n]}getTerrainCoords(n){const l={};for(const p of this._renderableTilesKeys){const g=this._tiles[p].tileID,x=n.clone(),T=a.b1();if(g.canonical.equals(n.canonical))a.bN(T,0,a.Z,a.Z,0,0,1);else if(g.canonical.isChildOf(n.canonical)){const A=g.canonical.z-n.canonical.z,C=g.canonical.x-(g.canonical.x>>A<<A),R=g.canonical.y-(g.canonical.y>>A<<A),L=a.Z>>A;a.bN(T,0,L,L,0,0,1),a.L(T,T,[-C*L,-R*L,0])}else{if(!n.canonical.isChildOf(g.canonical))continue;{const A=n.canonical.z-g.canonical.z,C=n.canonical.x-(n.canonical.x>>A<<A),R=n.canonical.y-(n.canonical.y>>A<<A),L=a.Z>>A;a.bN(T,0,a.Z,a.Z,0,0,1),a.L(T,T,[C*L,R*L,0]),a.M(T,T,[1/2**A,1/2**A,0])}}x.terrainRttPosMatrix32f=new Float32Array(T),l[p]=x}return l}getSourceTile(n,l){const p=this.sourceCache._source;let g=n.overscaledZ-this.deltaZoom;if(g>p.maxzoom&&(g=p.maxzoom),g<p.minzoom)return null;this._sourceTileCache[n.key]||(this._sourceTileCache[n.key]=n.scaledTo(g).key);let x=this.sourceCache.getTileByID(this._sourceTileCache[n.key]);if((!x||!x.dem)&&l)for(;g>=p.minzoom&&(!x||!x.dem);)x=this.sourceCache.getTileByID(n.scaledTo(g--).key);return x}anyTilesAfterTime(n=Date.now()){return this._lastTilesetChange>=n}}class Sn{constructor(n,l,p){this._meshCache={},this.painter=n,this.sourceCache=new Ed(l),this.options=p,this.exaggeration=typeof p.exaggeration=="number"?p.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(n,l,p,g=a.Z){var x;if(!(l>=0&&l<g&&p>=0&&p<g))return 0;const T=this.getTerrainData(n),A=(x=T.tile)===null||x===void 0?void 0:x.dem;if(!A)return 0;const C=a.cb([],[l/g*a.Z,p/g*a.Z],T.u_terrain_matrix),R=[C[0]*A.dim,C[1]*A.dim],L=Math.floor(R[0]),N=Math.floor(R[1]),z=R[0]-L,H=R[1]-N;return A.get(L,N)*(1-z)*(1-H)+A.get(L+1,N)*z*(1-H)+A.get(L,N+1)*(1-z)*H+A.get(L+1,N+1)*z*H}getElevationForLngLatZoom(n,l){if(!a.cc(l,n.wrap()))return 0;const{tileID:p,mercatorX:g,mercatorY:x}=this._getOverscaledTileIDFromLngLatZoom(n,l);return this.getElevation(p,g%a.Z,x%a.Z,a.Z)}getElevation(n,l,p,g=a.Z){return this.getDEMElevation(n,l,p,g)*this.exaggeration}getTerrainData(n){if(!this._emptyDemTexture){const g=this.painter.context,x=new a.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new G(g,x,g.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new G(g,new a.R({width:1,height:1}),g.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(g.gl.NEAREST,g.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=a.as([])}const l=this.sourceCache.getSourceTile(n,!0);if(l&&l.dem&&(!l.demTexture||l.needsTerrainPrepare)){const g=this.painter.context;l.demTexture=this.painter.getTileTexture(l.dem.stride),l.demTexture?l.demTexture.update(l.dem.getPixels(),{premultiply:!1}):l.demTexture=new G(g,l.dem.getPixels(),g.gl.RGBA,{premultiply:!1}),l.demTexture.bind(g.gl.NEAREST,g.gl.CLAMP_TO_EDGE),l.needsTerrainPrepare=!1}const p=l&&l+l.tileID.key+n.key;if(p&&!this._demMatrixCache[p]){const g=this.sourceCache.sourceCache._source.maxzoom;let x=n.canonical.z-l.tileID.canonical.z;n.overscaledZ>n.canonical.z&&(n.canonical.z>=g?x=n.canonical.z-g:a.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const T=n.canonical.x-(n.canonical.x>>x<<x),A=n.canonical.y-(n.canonical.y>>x<<x),C=a.cd(new Float64Array(16),[1/(a.Z<<x),1/(a.Z<<x),0]);a.L(C,C,[T*a.Z,A*a.Z,0]),this._demMatrixCache[n.key]={matrix:C,coord:n}}return{u_depth:2,u_terrain:3,u_terrain_dim:l&&l.dem&&l.dem.dim||1,u_terrain_matrix:p?this._demMatrixCache[n.key].matrix:this._emptyDemMatrix,u_terrain_unpack:l&&l.dem&&l.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(l&&l.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:l}}getFramebuffer(n){const l=this.painter,p=l.width/devicePixelRatio,g=l.height/devicePixelRatio;return!this._fbo||this._fbo.width===p&&this._fbo.height===g||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new G(l.context,{width:p,height:g,data:null},l.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(l.context.gl.NEAREST,l.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new G(l.context,{width:p,height:g,data:null},l.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(l.context.gl.NEAREST,l.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=l.context.createFramebuffer(p,g,!0,!1),this._fbo.depthAttachment.set(l.context.createRenderbuffer(l.context.gl.DEPTH_COMPONENT16,p,g))),this._fbo.colorAttachment.set(n==="coords"?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const n=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const l=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let x=0,T=0;x<this._coordsTextureSize;x++)for(let A=0;A<this._coordsTextureSize;A++,T+=4)l[T+0]=255&A,l[T+1]=255&x,l[T+2]=A>>8<<4|x>>8,l[T+3]=0;const p=new a.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(l.buffer)),g=new G(n,p,n.gl.RGBA,{premultiply:!1});return g.bind(n.gl.NEAREST,n.gl.CLAMP_TO_EDGE),this._coordsTexture=g,g}pointCoordinate(n){this.painter.maybeDrawDepthAndCoords(!0);const l=new Uint8Array(4),p=this.painter.context,g=p.gl,x=Math.round(n.x*this.painter.pixelRatio/devicePixelRatio),T=Math.round(n.y*this.painter.pixelRatio/devicePixelRatio),A=Math.round(this.painter.height/devicePixelRatio);p.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),g.readPixels(x,A-T-1,1,1,g.RGBA,g.UNSIGNED_BYTE,l),p.bindFramebuffer.set(null);const C=l[0]+(l[2]>>4<<8),R=l[1]+((15&l[2])<<8),L=this.coordsIndex[255-l[3]],N=L&&this.sourceCache.getTileByID(L);if(!N)return null;const z=this._coordsTextureSize,H=(1<<N.tileID.canonical.z)*z;return new a.$((N.tileID.canonical.x*z+C)/H+N.tileID.wrap,(N.tileID.canonical.y*z+R)/H,this.getElevation(N.tileID,C,R,z))}depthAtPoint(n){const l=new Uint8Array(4),p=this.painter.context,g=p.gl;return p.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),g.readPixels(n.x,this.painter.height/devicePixelRatio-n.y-1,1,1,g.RGBA,g.UNSIGNED_BYTE,l),p.bindFramebuffer.set(null),(l[0]/16777216+l[1]/65536+l[2]/256+l[3])/256}getTerrainMesh(n){var l;const p=((l=this.painter.style.projection)===null||l===void 0?void 0:l.transitionState)>0,g=p&&n.canonical.y===0,x=p&&n.canonical.y===(1<<n.canonical.z)-1,T=`m_${g?"n":""}_${x?"s":""}`;if(this._meshCache[T])return this._meshCache[T];const A=this.painter.context,C=new a.ce,R=new a.aG,L=this.meshSize,N=a.Z/L,z=L*L;for(let Ie=0;Ie<=L;Ie++)for(let $e=0;$e<=L;$e++)C.emplaceBack($e*N,Ie*N,0);for(let Ie=0;Ie<z;Ie+=L+1)for(let $e=0;$e<L;$e++)R.emplaceBack($e+Ie,L+$e+Ie+1,L+$e+Ie+2),R.emplaceBack($e+Ie,L+$e+Ie+2,$e+Ie+1);const H=C.length,q=H+(L+1),se=(L+1)*L,ne=g?a.b8:0,le=g?0:1,he=x?a.b9:a.Z,xe=x?0:1;for(let Ie=0;Ie<=L;Ie++)C.emplaceBack(Ie*N,ne,le);for(let Ie=0;Ie<=L;Ie++)C.emplaceBack(Ie*N,he,xe);for(let Ie=0;Ie<L;Ie++)R.emplaceBack(se+Ie,q+Ie,q+Ie+1),R.emplaceBack(se+Ie,q+Ie+1,se+Ie+1),R.emplaceBack(0+Ie,H+Ie+1,H+Ie),R.emplaceBack(0+Ie,0+Ie+1,H+Ie+1);const ve=C.length,Pe=ve+2*(L+1);for(const Ie of[0,1])for(let $e=0;$e<=L;$e++)for(const He of[0,1])C.emplaceBack(Ie*a.Z,$e*N,He);for(let Ie=0;Ie<2*L;Ie+=2)R.emplaceBack(ve+Ie,ve+Ie+1,ve+Ie+3),R.emplaceBack(ve+Ie,ve+Ie+3,ve+Ie+2),R.emplaceBack(Pe+Ie,Pe+Ie+3,Pe+Ie+1),R.emplaceBack(Pe+Ie,Pe+Ie+2,Pe+Ie+3);const Re=new zr(A.createVertexBuffer(C,kr.members),A.createIndexBuffer(R),a.aF.simpleSegment(0,0,C.length,R.length));return this._meshCache[T]=Re,Re}getMeshFrameDelta(n){return 2*Math.PI*a.bq/Math.pow(2,Math.max(n,0))/5}getMinTileElevationForLngLatZoom(n,l){var p;const{tileID:g}=this._getOverscaledTileIDFromLngLatZoom(n,l);return(p=this.getMinMaxElevation(g).minElevation)!==null&&p!==void 0?p:0}getMinMaxElevation(n){const l=this.getTerrainData(n).tile,p={minElevation:null,maxElevation:null};return l&&l.dem&&(p.minElevation=l.dem.min*this.exaggeration,p.maxElevation=l.dem.max*this.exaggeration),p}_getOverscaledTileIDFromLngLatZoom(n,l){const p=a.$.fromLngLat(n.wrap()),g=(1<<l)*a.Z,x=p.x*g,T=p.y*g,A=Math.floor(x/a.Z),C=Math.floor(T/a.Z);return{tileID:new a.Y(l,0,l,A,C),mercatorX:x,mercatorY:T}}}class Hp{constructor(n,l,p){this._context=n,this._size=l,this._tileSize=p,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const n of this._objects)n.texture.destroy(),n.fbo.destroy()}_createObject(n){const l=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),p=new G(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return p.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),l.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),l.colorAttachment.set(p.texture),{id:n,fbo:l,texture:p,stamp:-1,inUse:!1}}getObjectForId(n){return this._objects[n]}useObject(n){n.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter((l=>n.id!==l)),this._recentlyUsed.push(n.id)}stampObject(n){n.stamp=++this._stamp}getOrCreateFreeObject(){for(const l of this._recentlyUsed)if(!this._objects[l].inUse)return this._objects[l];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const n=this._createObject(this._objects.length);return this._objects.push(n),n}freeObject(n){n.inUse=!1}freeAllObjects(){for(const n of this._objects)this.freeObject(n)}isFull(){return!(this._objects.length<this._size)&&this._objects.some((n=>!n.inUse))===!1}}const En={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class Oi{constructor(n,l){this.painter=n,this.terrain=l,this.pool=new Hp(n.context,30,l.sourceCache.tileSize*l.qualityFactor)}destruct(){this.pool.destruct()}getTexture(n){return this.pool.getObjectForId(n.rtt[this._stacks.length-1].id).texture}prepareForRender(n,l){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=n._order.filter((p=>!n._layers[p].isHidden(l))),this._coordsAscending={};for(const p in n.sourceCaches){this._coordsAscending[p]={};const g=n.sourceCaches[p].getVisibleCoordinates();for(const x of g){const T=this.terrain.sourceCache.getTerrainCoords(x);for(const A in T)this._coordsAscending[p][A]||(this._coordsAscending[p][A]=[]),this._coordsAscending[p][A].push(T[A])}}this._coordsAscendingStr={};for(const p of n._order){const g=n._layers[p],x=g.source;if(En[g.type]&&!this._coordsAscendingStr[x]){this._coordsAscendingStr[x]={};for(const T in this._coordsAscending[x])this._coordsAscendingStr[x][T]=this._coordsAscending[x][T].map((A=>A.key)).sort().join()}}for(const p of this._renderableTiles)for(const g in this._coordsAscendingStr){const x=this._coordsAscendingStr[g][p.tileID.key];x&&x!==p.rttCoords[g]&&(p.rtt=[])}}renderLayer(n,l){if(n.isHidden(this.painter.transform.zoom))return!1;const p=Object.assign(Object.assign({},l),{isRenderingToTexture:!0}),g=n.type,x=this.painter,T=this._renderableLayerIds[this._renderableLayerIds.length-1]===n.id;if(En[g]&&(this._prevType&&En[this._prevType]||this._stacks.push([]),this._prevType=g,this._stacks[this._stacks.length-1].push(n.id),!T))return!0;if(En[this._prevType]||En[g]&&T){this._prevType=g;const A=this._stacks.length-1,C=this._stacks[A]||[];for(const R of this._renderableTiles){if(this.pool.isFull()&&(lu(this.painter,this.terrain,this._rttTiles,p),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(R),R.rtt[A]){const N=this.pool.getObjectForId(R.rtt[A].id);if(N.stamp===R.rtt[A].stamp){this.pool.useObject(N);continue}}const L=this.pool.getOrCreateFreeObject();this.pool.useObject(L),this.pool.stampObject(L),R.rtt[A]={id:L.id,stamp:L.stamp},x.context.bindFramebuffer.set(L.fbo.framebuffer),x.context.clear({color:a.b6.transparent,stencil:0}),x.currentStencilSource=void 0;for(let N=0;N<C.length;N++){const z=x.style._layers[C[N]],H=z.source?this._coordsAscending[z.source][R.tileID.key]:[R.tileID];x.context.viewport.set([0,0,L.fbo.width,L.fbo.height]),x._renderTileClippingMasks(z,H,!0),x.renderLayer(x,x.style.sourceCaches[z.source],z,H,p),z.source&&(R.rttCoords[z.source]=this._coordsAscendingStr[z.source][R.tileID.key])}}return lu(this.painter,this.terrain,this._rttTiles,p),this._rttTiles=[],this.pool.freeAllObjects(),En[g]}return!1}}const zi={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use â + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},Ad=y,Po={hash:!1,interactive:!0,bearingSnap:7,attributionControl:Bt,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:a.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0},Cl={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class wu{constructor(n,l,p=!1){this.mousedown=x=>{this.startMove(x,F.mousePos(this.element,x)),F.addEventListener(window,"mousemove",this.mousemove),F.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=x=>{this.move(x,F.mousePos(this.element,x))},this.mouseup=x=>{this._rotatePitchHanlder.dragEnd(x),this.offTemp()},this.touchstart=x=>{x.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=F.touchPos(this.element,x.targetTouches)[0],this.startMove(x,this._startPos),F.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),F.addEventListener(window,"touchend",this.touchend))},this.touchmove=x=>{x.targetTouches.length!==1?this.reset():(this._lastPos=F.touchPos(this.element,x.targetTouches)[0],this.move(x,this._lastPos))},this.touchend=x=>{x.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHanlder.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=l;const g=new vd;this._rotatePitchHanlder=new Vr({clickTolerance:3,move:(x,T)=>{const A=l.getBoundingClientRect(),C=new a.P((A.bottom-A.top)/2,(A.right-A.left)/2);return{bearingDelta:a.c9(new a.P(x.x,T.y),T,C),pitchDelta:p?-.5*(T.y-x.y):void 0}},moveStateManager:g,enable:!0,assignEvents:()=>{}}),this.map=n,F.addEventListener(l,"mousedown",this.mousedown),F.addEventListener(l,"touchstart",this.touchstart,{passive:!1}),F.addEventListener(l,"touchcancel",this.reset)}startMove(n,l){this._rotatePitchHanlder.dragStart(n,l),F.disableDrag()}move(n,l){const p=this.map,{bearingDelta:g,pitchDelta:x}=this._rotatePitchHanlder.dragMove(n,l)||{};g&&p.setBearing(p.getBearing()+g),x&&p.setPitch(p.getPitch()+x)}off(){const n=this.element;F.removeEventListener(n,"mousedown",this.mousedown),F.removeEventListener(n,"touchstart",this.touchstart,{passive:!1}),F.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),F.removeEventListener(window,"touchend",this.touchend),F.removeEventListener(n,"touchcancel",this.reset),this.offTemp()}offTemp(){F.enableDrag(),F.removeEventListener(window,"mousemove",this.mousemove),F.removeEventListener(window,"mouseup",this.mouseup),F.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),F.removeEventListener(window,"touchend",this.touchend)}}let jn;function Il(_,n,l){const p=new a.Q(_.lng,_.lat);if(_=new a.Q(_.lng,_.lat),n){const g=new a.Q(_.lng-360,_.lat),x=new a.Q(_.lng+360,_.lat),T=l.locationToScreenPoint(_).distSqr(n);l.locationToScreenPoint(g).distSqr(n)<T?_=g:l.locationToScreenPoint(x).distSqr(n)<T&&(_=x)}for(;Math.abs(_.lng-l.center.lng)>180;){const g=l.locationToScreenPoint(_);if(g.x>=0&&g.y>=0&&g.x<=l.width&&g.y<=l.height)break;_.lng>l.center.lng?_.lng-=360:_.lng+=360}return _.lng!==p.lng&&l.isPointOnMapSurface(l.locationToScreenPoint(_))?_:p}const $s={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Ml(_,n,l){const p=_.classList;for(const g in $s)p.remove(`maplibregl-${l}-anchor-${g}`);p.add(`maplibregl-${l}-anchor-${n}`)}class ga extends a.E{constructor(n){if(super(),this._onKeyPress=l=>{const p=l.code,g=l.charCode||l.keyCode;p!=="Space"&&p!=="Enter"&&g!==32&&g!==13||this.togglePopup()},this._onMapClick=l=>{const p=l.originalEvent.target,g=this._element;this._popup&&(p===g||g.contains(p))&&this.togglePopup()},this._update=l=>{var p;if(!this._map)return;const g=this._map.loaded()&&!this._map.isMoving();(l?.type==="terrain"||l?.type==="render"&&!g)&&this._map.once("render",this._update),this._lngLat=this._map.transform.renderWorldCopies?Il(this._lngLat,this._flatPos,this._map.transform):(p=this._lngLat)===null||p===void 0?void 0:p.wrap(),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let x="";this._rotationAlignment==="viewport"||this._rotationAlignment==="auto"?x=`rotateZ(${this._rotation}deg)`:this._rotationAlignment==="map"&&(x=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let T="";this._pitchAlignment==="viewport"||this._pitchAlignment==="auto"?T="rotateX(0deg)":this._pitchAlignment==="map"&&(T=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||l&&l.type!=="moveend"||(this._pos=this._pos.round()),F.setTransform(this._element,`${$s[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${T} ${x}`),D.frameAsync(new AbortController).then((()=>{this._updateOpacity(l&&l.type==="moveend")})).catch((()=>{}))},this._onMove=l=>{if(!this._isDragging){const p=this._clickTolerance||this._map._clickTolerance;this._isDragging=l.point.dist(this._pointerdownPos)>=p}this._isDragging&&(this._pos=l.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new a.l("dragstart"))),this.fire(new a.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._state==="active"&&this.fire(new a.l("dragend")),this._state="inactive"},this._addDragHandler=l=>{this._element.contains(l.originalEvent.target)&&(l.preventDefault(),this._positionDelta=l.point.sub(this._pos).add(this._offset),this._pointerdownPos=l.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=n&&n.anchor||"center",this._color=n&&n.color||"#3FB1CE",this._scale=n&&n.scale||1,this._draggable=n&&n.draggable||!1,this._clickTolerance=n&&n.clickTolerance||0,this._subpixelPositioning=n&&n.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=n&&n.rotation||0,this._rotationAlignment=n&&n.rotationAlignment||"auto",this._pitchAlignment=n&&n.pitchAlignment&&n.pitchAlignment!=="auto"?n.pitchAlignment:this._rotationAlignment,this.setOpacity(n?.opacity,n?.opacityWhenCovered),n&&n.element)this._element=n.element,this._offset=a.P.convert(n&&n.offset||[0,0]);else{this._defaultMarker=!0,this._element=F.create("div");const l=F.createNS("http://www.w3.org/2000/svg","svg"),p=41,g=27;l.setAttributeNS(null,"display","block"),l.setAttributeNS(null,"height",`${p}px`),l.setAttributeNS(null,"width",`${g}px`),l.setAttributeNS(null,"viewBox",`0 0 ${g} ${p}`);const x=F.createNS("http://www.w3.org/2000/svg","g");x.setAttributeNS(null,"stroke","none"),x.setAttributeNS(null,"stroke-width","1"),x.setAttributeNS(null,"fill","none"),x.setAttributeNS(null,"fill-rule","evenodd");const T=F.createNS("http://www.w3.org/2000/svg","g");T.setAttributeNS(null,"fill-rule","nonzero");const A=F.createNS("http://www.w3.org/2000/svg","g");A.setAttributeNS(null,"transform","translate(3.0, 29.0)"),A.setAttributeNS(null,"fill","#000000");const C=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const le of C){const he=F.createNS("http://www.w3.org/2000/svg","ellipse");he.setAttributeNS(null,"opacity","0.04"),he.setAttributeNS(null,"cx","10.5"),he.setAttributeNS(null,"cy","5.80029008"),he.setAttributeNS(null,"rx",le.rx),he.setAttributeNS(null,"ry",le.ry),A.appendChild(he)}const R=F.createNS("http://www.w3.org/2000/svg","g");R.setAttributeNS(null,"fill",this._color);const L=F.createNS("http://www.w3.org/2000/svg","path");L.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),R.appendChild(L);const N=F.createNS("http://www.w3.org/2000/svg","g");N.setAttributeNS(null,"opacity","0.25"),N.setAttributeNS(null,"fill","#000000");const z=F.createNS("http://www.w3.org/2000/svg","path");z.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),N.appendChild(z);const H=F.createNS("http://www.w3.org/2000/svg","g");H.setAttributeNS(null,"transform","translate(6.0, 7.0)"),H.setAttributeNS(null,"fill","#FFFFFF");const q=F.createNS("http://www.w3.org/2000/svg","g");q.setAttributeNS(null,"transform","translate(8.0, 8.0)");const se=F.createNS("http://www.w3.org/2000/svg","circle");se.setAttributeNS(null,"fill","#000000"),se.setAttributeNS(null,"opacity","0.25"),se.setAttributeNS(null,"cx","5.5"),se.setAttributeNS(null,"cy","5.5"),se.setAttributeNS(null,"r","5.4999962");const ne=F.createNS("http://www.w3.org/2000/svg","circle");ne.setAttributeNS(null,"fill","#FFFFFF"),ne.setAttributeNS(null,"cx","5.5"),ne.setAttributeNS(null,"cy","5.5"),ne.setAttributeNS(null,"r","5.4999962"),q.appendChild(se),q.appendChild(ne),T.appendChild(A),T.appendChild(R),T.appendChild(N),T.appendChild(H),T.appendChild(q),l.appendChild(T),l.setAttributeNS(null,"height",p*this._scale+"px"),l.setAttributeNS(null,"width",g*this._scale+"px"),this._element.appendChild(l),this._offset=a.P.convert(n&&n.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",(l=>{l.preventDefault()})),this._element.addEventListener("mousedown",(l=>{l.preventDefault()})),Ml(this._element,this._anchor,"marker"),n&&n.className)for(const l of n.className.split(" "))this._element.classList.add(l);this._popup=null}addTo(n){return this.remove(),this._map=n,this._element.setAttribute("aria-label",n._getUIString("Marker.Title")),n.getCanvasContainer().appendChild(this._element),n.on("move",this._update),n.on("moveend",this._update),n.on("terrain",this._update),n.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),F.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(n){return this._lngLat=a.Q.convert(n),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(n){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),n){if(!("offset"in n.options)){const g=Math.abs(13.5)/Math.SQRT2;n.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[g,-1*(38.1-13.5+g)],"bottom-right":[-g,-1*(38.1-13.5+g)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=n,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(n){return this._subpixelPositioning=n,this}getPopup(){return this._popup}togglePopup(){const n=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:n?(n.isOpen()?n.remove():(n.setLngLat(this._lngLat),n.addTo(this._map)),this):this}_updateOpacity(n=!1){var l,p;if(!(!((l=this._map)===null||l===void 0)&&l.terrain)){const N=this._map.transform.isLocationOccluded(this._lngLat)?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==N&&(this._element.style.opacity=N))}if(n)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout((()=>{this._opacityTimeout=null}),100)}const g=this._map,x=g.terrain.depthAtPoint(this._pos),T=g.terrain.getElevationForLngLatZoom(this._lngLat,g.transform.tileZoom);if(g.transform.lngLatToCameraDepth(this._lngLat,T)-x<.006)return void(this._element.style.opacity=this._opacity);const A=-this._offset.y/g.transform.pixelsPerMeter,C=Math.sin(g.getPitch()*Math.PI/180)*A,R=g.terrain.depthAtPoint(new a.P(this._pos.x,this._pos.y-this._offset.y)),L=g.transform.lngLatToCameraDepth(this._lngLat,T+C)-R>.006;!((p=this._popup)===null||p===void 0)&&p.isOpen()&&L&&this._popup.remove(),this._element.style.opacity=L?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(n){return this._offset=a.P.convert(n),this._update(),this}addClassName(n){this._element.classList.add(n)}removeClassName(n){this._element.classList.remove(n)}toggleClassName(n){return this._element.classList.toggle(n)}setDraggable(n){return this._draggable=!!n,this._map&&(n?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(n){return this._rotation=n||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(n){return this._rotationAlignment=n||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(n){return this._pitchAlignment=n&&n!=="auto"?n:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(n,l){return(this._opacity===void 0||n===void 0&&l===void 0)&&(this._opacity="1",this._opacityWhenCovered="0.2"),n!==void 0&&(this._opacity=n),l!==void 0&&(this._opacityWhenCovered=l),this._map&&this._updateOpacity(!0),this}}const Tu={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Co=0,Ws=!1;const Su={maxWidth:100,unit:"metric"};function Rl(_,n,l){const p=l&&l.maxWidth||100,g=_._container.clientHeight/2,x=_._container.clientWidth/2,T=_.unproject([x-p/2,g]),A=_.unproject([x+p/2,g]),C=Math.round(_.project(A).x-_.project(T).x),R=Math.min(p,C,_._container.clientWidth),L=T.distanceTo(A);if(l&&l.unit==="imperial"){const N=3.2808*L;N>5280?Hs(n,R,N/5280,_._getUIString("ScaleControl.Miles")):Hs(n,R,N,_._getUIString("ScaleControl.Feet"))}else l&&l.unit==="nautical"?Hs(n,R,L/1852,_._getUIString("ScaleControl.NauticalMiles")):L>=1e3?Hs(n,R,L/1e3,_._getUIString("ScaleControl.Kilometers")):Hs(n,R,L,_._getUIString("ScaleControl.Meters"))}function Hs(_,n,l,p){const g=(function(x){const T=Math.pow(10,`${Math.floor(x)}`.length-1);let A=x/T;return A=A>=10?10:A>=5?5:A>=3?3:A>=2?2:A>=1?1:(function(C){const R=Math.pow(10,Math.ceil(-Math.log(C)/Math.LN10));return Math.round(C*R)/R})(A),T*A})(l);_.style.width=n*(g/l)+"px",_.innerHTML=`${g}&nbsp;${p}`}const kl={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},Eu=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Dl(_){if(_){if(typeof _=="number"){const n=Math.round(Math.abs(_)/Math.SQRT2);return{center:new a.P(0,0),top:new a.P(0,_),"top-left":new a.P(n,n),"top-right":new a.P(-n,n),bottom:new a.P(0,-_),"bottom-left":new a.P(n,-n),"bottom-right":new a.P(-n,-n),left:new a.P(_,0),right:new a.P(-_,0)}}if(_ instanceof a.P||Array.isArray(_)){const n=a.P.convert(_);return{center:n,top:n,"top-left":n,"top-right":n,bottom:n,"bottom-left":n,"bottom-right":n,left:n,right:n}}return{center:a.P.convert(_.center||[0,0]),top:a.P.convert(_.top||[0,0]),"top-left":a.P.convert(_["top-left"]||[0,0]),"top-right":a.P.convert(_["top-right"]||[0,0]),bottom:a.P.convert(_.bottom||[0,0]),"bottom-left":a.P.convert(_["bottom-left"]||[0,0]),"bottom-right":a.P.convert(_["bottom-right"]||[0,0]),left:a.P.convert(_.left||[0,0]),right:a.P.convert(_.right||[0,0])}}return Dl(new a.P(0,0))}const Ol=y;d.AJAXError=a.ci,d.Event=a.l,d.Evented=a.E,d.LngLat=a.Q,d.MercatorCoordinate=a.$,d.Point=a.P,d.addProtocol=a.cj,d.config=a.a,d.removeProtocol=a.ck,d.AttributionControl=pa,d.BoxZoomHandler=xd,d.CanvasSource=so,d.CooperativeGesturesHandler=vu,d.DoubleClickZoomHandler=Sd,d.DragPanHandler=da,d.DragRotateHandler=El,d.EdgeInsets=tr,d.FullscreenControl=class extends a.E{constructor(_={}){super(),this._onFullscreenChange=()=>{var n;let l=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;!((n=l?.shadowRoot)===null||n===void 0)&&n.fullscreenElement;)l=l.shadowRoot.fullscreenElement;l===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,_&&_.container&&(_.container instanceof HTMLElement?this._container=_.container:a.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(_){return this._map=_,this._container||(this._container=this._map.getContainer()),this._controlContainer=F.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){F.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const _=this._fullscreenButton=F.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);F.create("span","maplibregl-ctrl-icon",_).setAttribute("aria-hidden","true"),_.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const _=this._getTitle();this._fullscreenButton.setAttribute("aria-label",_),this._fullscreenButton.title=_}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new a.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new a.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},d.GeoJSONSource=ns,d.GeolocateControl=class extends a.E{constructor(_){super(),this._onSuccess=n=>{if(this._map){if(this._isOutOfMapMaxBounds(n))return this._setErrorState(),this.fire(new a.l("outofmaxbounds",n)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=n,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(n),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(n),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new a.l("geolocate",n)),this._finish()}},this._updateCamera=n=>{const l=new a.Q(n.coords.longitude,n.coords.latitude),p=n.coords.accuracy,g=this._map.getBearing(),x=a.e({bearing:g},this.options.fitBoundsOptions),T=Yt.fromLngLat(l,p);this._map.fitBounds(T,x,{geolocateSource:!0})},this._updateMarker=n=>{if(n){const l=new a.Q(n.coords.longitude,n.coords.latitude);this._accuracyCircleMarker.setLngLat(l).addTo(this._map),this._userLocationDotMarker.setLngLat(l).addTo(this._map),this._accuracy=n.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=n=>{if(this._map){if(this.options.trackUserLocation)if(n.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const l=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(n.code===3&&Ws)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new a.l("error",n)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",(n=>n.preventDefault())),this._geolocateButton=F.create("button","maplibregl-ctrl-geolocate",this._container),F.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=n=>{if(this._map){if(n===!1){a.w("Geolocation support is not available so the GeolocateControl will be disabled.");const l=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l)}else{const l=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=l,this._geolocateButton.setAttribute("aria-label",l)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=F.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new ga({element:this._dotElement}),this._circleElement=F.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ga({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",(()=>this.trigger())),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(l=>{l.geolocateSource||this._watchState!=="ACTIVE_LOCK"||l.originalEvent&&l.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new a.l("trackuserlocationend")),this.fire(new a.l("userlocationlostfocus")))}))}},this.options=a.e({},Tu,_)}onAdd(_){return this._map=_,this._container=F.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),(function(){return a._(this,arguments,void 0,(function*(n=!1){if(jn!==void 0&&!n)return jn;if(window.navigator.permissions===void 0)return jn=!!window.navigator.geolocation,jn;try{jn=(yield window.navigator.permissions.query({name:"geolocation"})).state!=="denied"}catch{jn=!!window.navigator.geolocation}return jn}))})().then((n=>this._finishSetupUI(n))),this._container}onRemove(){this._geolocationWatchID!==void 0&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),F.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Co=0,Ws=!1}_isOutOfMapMaxBounds(_){const n=this._map.getMaxBounds(),l=_.coords;return n&&(l.longitude<n.getWest()||l.longitude>n.getEast()||l.latitude<n.getSouth()||l.latitude>n.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const _=this._map.getBounds(),n=_.getSouthEast(),l=_.getNorthEast(),p=n.distanceTo(l),g=Math.ceil(this._accuracy/(p/this._map._container.clientHeight)*2);this._circleElement.style.width=`${g}px`,this._circleElement.style.height=`${g}px`}trigger(){if(!this._setup)return a.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new a.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Co--,Ws=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new a.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new a.l("trackuserlocationstart")),this.fire(new a.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let _;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Co++,Co>1?(_={maximumAge:6e5,timeout:0},Ws=!0):(_=this.options.positionOptions,Ws=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,_)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},d.GlobeControl=class{constructor(){this._toggleProjection=()=>{var _;const n=(_=this._map.getProjection())===null||_===void 0?void 0:_.type;this._map.setProjection(n!=="mercator"&&n?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var _;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),((_=this._map.getProjection())===null||_===void 0?void 0:_.type)==="globe"?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(_){return this._map=_,this._container=F.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=F.create("button","maplibregl-ctrl-globe",this._container),F.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){F.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},d.Hash=us,d.ImageSource=bn,d.KeyboardHandler=_u,d.LngLatBounds=Yt,d.LogoControl=Pl,d.Map=class extends Mt{constructor(_){var n,l;a.cf.mark(a.cg.create);const p=Object.assign(Object.assign(Object.assign({},Po),_),{canvasContextAttributes:Object.assign(Object.assign({},Po.canvasContextAttributes),_.canvasContextAttributes)});if(p.minZoom!=null&&p.maxZoom!=null&&p.minZoom>p.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(p.minPitch!=null&&p.maxPitch!=null&&p.minPitch>p.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(p.minPitch!=null&&p.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(p.maxPitch!=null&&p.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const g=new Gr,x=new cn;if(p.minZoom!==void 0&&g.setMinZoom(p.minZoom),p.maxZoom!==void 0&&g.setMaxZoom(p.maxZoom),p.minPitch!==void 0&&g.setMinPitch(p.minPitch),p.maxPitch!==void 0&&g.setMaxPitch(p.maxPitch),p.renderWorldCopies!==void 0&&g.setRenderWorldCopies(p.renderWorldCopies),super(g,x,{bearingSnap:p.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new bu,this._controls=[],this._mapId=a.a3(),this._contextLost=A=>{A.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new a.l("webglcontextlost",{originalEvent:A}))},this._contextRestored=A=>{this._setupPainter(),this.resize(),this._update(),this.fire(new a.l("webglcontextrestored",{originalEvent:A}))},this._onMapScroll=A=>{if(A.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=p.interactive,this._maxTileCacheSize=p.maxTileCacheSize,this._maxTileCacheZoomLevels=p.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},p.canvasContextAttributes),this._trackResize=p.trackResize===!0,this._bearingSnap=p.bearingSnap,this._centerClampedToGround=p.centerClampedToGround,this._refreshExpiredTiles=p.refreshExpiredTiles===!0,this._fadeDuration=p.fadeDuration,this._crossSourceCollisions=p.crossSourceCollisions===!0,this._collectResourceTiming=p.collectResourceTiming===!0,this._locale=Object.assign(Object.assign({},zi),p.locale),this._clickTolerance=p.clickTolerance,this._overridePixelRatio=p.pixelRatio,this._maxCanvasSize=p.maxCanvasSize,this.transformCameraUpdate=p.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=p.cancelPendingTileRequestsWhileZooming===!0,this._imageQueueHandle=ke.addThrottleControl((()=>this.isMoving())),this._requestManager=new Je(p.transformRequest),typeof p.container=="string"){if(this._container=document.getElementById(p.container),!this._container)throw new Error(`Container '${p.container}' not found.`)}else{if(!(p.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=p.container}if(p.maxBounds&&this.setMaxBounds(p.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this.on("terrain",(()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)})),this.once("idle",(()=>{this._idleTriggered=!0})),typeof window<"u"){addEventListener("online",this._onWindowOnline,!1);let A=!1;const C=uu((R=>{this._trackResize&&!this._removed&&(this.resize(R),this.redraw())}),50);this._resizeObserver=new ResizeObserver((R=>{A?C(R):A=!0})),this._resizeObserver.observe(this._container)}this.handlers=new Al(this,p),this._hash=p.hash&&new us(typeof p.hash=="string"&&p.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:p.center,elevation:p.elevation,zoom:p.zoom,bearing:p.bearing,pitch:p.pitch,roll:p.roll}),p.bounds&&(this.resize(),this.fitBounds(p.bounds,a.e({},p.fitBoundsOptions,{duration:0}))));const T=typeof p.style=="string"||((l=(n=p.style)===null||n===void 0?void 0:n.projection)===null||l===void 0?void 0:l.type)!=="globe";this.resize(null,T),this._localIdeographFontFamily=p.localIdeographFontFamily,this._validateStyle=p.validateStyle,p.style&&this.setStyle(p.style,{localIdeographFontFamily:p.localIdeographFontFamily}),p.attributionControl&&this.addControl(new pa(typeof p.attributionControl=="boolean"?void 0:p.attributionControl)),p.maplibreLogo&&this.addControl(new Pl,p.logoPosition),this.on("style.load",(()=>{if(T||this._resizeTransform(),this.transform.unmodified){const A=a.O(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(A)}})),this.on("data",(A=>{this._update(A.dataType==="style"),this.fire(new a.l(`${A.dataType}data`,A))})),this.on("dataloading",(A=>{this.fire(new a.l(`${A.dataType}dataloading`,A))})),this.on("dataabort",(A=>{this.fire(new a.l("sourcedataabort",A))}))}_getMapId(){return this._mapId}addControl(_,n){if(n===void 0&&(n=_.getDefaultPosition?_.getDefaultPosition():"top-right"),!_||!_.onAdd)return this.fire(new a.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const l=_.onAdd(this);this._controls.push(_);const p=this._controlPositions[n];return n.indexOf("bottom")!==-1?p.insertBefore(l,p.firstChild):p.appendChild(l),this}removeControl(_){if(!_||!_.onRemove)return this.fire(new a.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const n=this._controls.indexOf(_);return n>-1&&this._controls.splice(n,1),_.onRemove(this),this}hasControl(_){return this._controls.indexOf(_)>-1}calculateCameraOptionsFromTo(_,n,l,p){return p==null&&this.terrain&&(p=this.terrain.getElevationForLngLatZoom(l,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(_,n,l,p)}resize(_,n=!0){const[l,p]=this._containerDimensions(),g=this._getClampedPixelRatio(l,p);if(this._resizeCanvas(l,p,g),this.painter.resize(l,p,g),this.painter.overLimit()){const T=this.painter.context.gl;this._maxCanvasSize=[T.drawingBufferWidth,T.drawingBufferHeight];const A=this._getClampedPixelRatio(l,p);this._resizeCanvas(l,p,A),this.painter.resize(l,p,A)}this._resizeTransform(n);const x=!this._moving;return x&&(this.stop(),this.fire(new a.l("movestart",_)).fire(new a.l("move",_))),this.fire(new a.l("resize",_)),x&&this.fire(new a.l("moveend",_)),this}_resizeTransform(_=!0){var n;const[l,p]=this._containerDimensions();this.transform.resize(l,p,_),(n=this._requestedCameraState)===null||n===void 0||n.resize(l,p,_)}_getClampedPixelRatio(_,n){const{0:l,1:p}=this._maxCanvasSize,g=this.getPixelRatio(),x=_*g,T=n*g;return Math.min(x>l?l/x:1,T>p?p/T:1)*g}getPixelRatio(){var _;return(_=this._overridePixelRatio)!==null&&_!==void 0?_:devicePixelRatio}setPixelRatio(_){this._overridePixelRatio=_,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(_){return this.transform.setMaxBounds(Yt.convert(_)),this._update()}setMinZoom(_){if((_=_??-2)>=-2&&_<=this.transform.maxZoom)return this.transform.setMinZoom(_),this._update(),this.getZoom()<_&&this.setZoom(_),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(_){if((_=_??22)>=this.transform.minZoom)return this.transform.setMaxZoom(_),this._update(),this.getZoom()>_&&this.setZoom(_),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(_){if((_=_??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(_>=0&&_<=this.transform.maxPitch)return this.transform.setMinPitch(_),this._update(),this.getPitch()<_&&this.setPitch(_),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(_){if((_=_??60)>180)throw new Error("maxPitch must be less than or equal to 180");if(_>=this.transform.minPitch)return this.transform.setMaxPitch(_),this._update(),this.getPitch()>_&&this.setPitch(_),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(_){return this.transform.setRenderWorldCopies(_),this._update()}project(_){return this.transform.locationToScreenPoint(a.Q.convert(_),this.style&&this.terrain)}unproject(_){return this.transform.screenPointToLocation(a.P.convert(_),this.terrain)}isMoving(){var _;return this._moving||((_=this.handlers)===null||_===void 0?void 0:_.isMoving())}isZooming(){var _;return this._zooming||((_=this.handlers)===null||_===void 0?void 0:_.isZooming())}isRotating(){var _;return this._rotating||((_=this.handlers)===null||_===void 0?void 0:_.isRotating())}_createDelegatedListener(_,n,l){if(_==="mouseenter"||_==="mouseover"){let p=!1;return{layers:n,listener:l,delegates:{mousemove:x=>{const T=n.filter((C=>this.getLayer(C))),A=T.length!==0?this.queryRenderedFeatures(x.point,{layers:T}):[];A.length?p||(p=!0,l.call(this,new Di(_,this,x.originalEvent,{features:A}))):p=!1},mouseout:()=>{p=!1}}}}if(_==="mouseleave"||_==="mouseout"){let p=!1;return{layers:n,listener:l,delegates:{mousemove:T=>{const A=n.filter((C=>this.getLayer(C)));(A.length!==0?this.queryRenderedFeatures(T.point,{layers:A}):[]).length?p=!0:p&&(p=!1,l.call(this,new Di(_,this,T.originalEvent)))},mouseout:T=>{p&&(p=!1,l.call(this,new Di(_,this,T.originalEvent)))}}}}{const p=g=>{const x=n.filter((A=>this.getLayer(A))),T=x.length!==0?this.queryRenderedFeatures(g.point,{layers:x}):[];T.length&&(g.features=T,l.call(this,g),delete g.features)};return{layers:n,listener:l,delegates:{[_]:p}}}}_saveDelegatedListener(_,n){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[_]=this._delegatedListeners[_]||[],this._delegatedListeners[_].push(n)}_removeDelegatedListener(_,n,l){if(!this._delegatedListeners||!this._delegatedListeners[_])return;const p=this._delegatedListeners[_];for(let g=0;g<p.length;g++){const x=p[g];if(x.listener===l&&x.layers.length===n.length&&x.layers.every((T=>n.includes(T)))){for(const T in x.delegates)this.off(T,x.delegates[T]);return void p.splice(g,1)}}}on(_,n,l){if(l===void 0)return super.on(_,n);const p=typeof n=="string"?[n]:n,g=this._createDelegatedListener(_,p,l);this._saveDelegatedListener(_,g);for(const x in g.delegates)this.on(x,g.delegates[x]);return{unsubscribe:()=>{this._removeDelegatedListener(_,p,l)}}}once(_,n,l){if(l===void 0)return super.once(_,n);const p=typeof n=="string"?[n]:n,g=this._createDelegatedListener(_,p,l);for(const x in g.delegates){const T=g.delegates[x];g.delegates[x]=(...A)=>{this._removeDelegatedListener(_,p,l),T(...A)}}this._saveDelegatedListener(_,g);for(const x in g.delegates)this.once(x,g.delegates[x]);return this}off(_,n,l){return l===void 0?super.off(_,n):(this._removeDelegatedListener(_,typeof n=="string"?[n]:n,l),this)}queryRenderedFeatures(_,n){if(!this.style)return[];let l;const p=_ instanceof a.P||Array.isArray(_),g=p?_:[[0,0],[this.transform.width,this.transform.height]];if(n=n||(p?{}:_)||{},g instanceof a.P||typeof g[0]=="number")l=[a.P.convert(g)];else{const x=a.P.convert(g[0]),T=a.P.convert(g[1]);l=[x,new a.P(T.x,x.y),T,new a.P(x.x,T.y),x]}return this.style.queryRenderedFeatures(l,n,this.transform)}querySourceFeatures(_,n){return this.style.querySourceFeatures(_,n)}setStyle(_,n){return(n=a.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},n)).diff!==!1&&n.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&_?(this._diffStyle(_,n),this):(this._localIdeographFontFamily=n.localIdeographFontFamily,this._updateStyle(_,n))}setTransformRequest(_){return this._requestManager.setTransformRequest(_),this}_getUIString(_){const n=this._locale[_];if(n==null)throw new Error(`Missing UI string '${_}'`);return n}_updateStyle(_,n){var l,p;if(n.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",(()=>this._updateStyle(_,n)));const g=this.style&&n.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!_)),_?(this.style=new ia(this,n||{}),this.style.setEventedParent(this,{style:this.style}),typeof _=="string"?this.style.loadURL(_,n,g):this.style.loadJSON(_,n,g),this):((p=(l=this.style)===null||l===void 0?void 0:l.projection)===null||p===void 0||p.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new ia(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(_,n){if(typeof _=="string"){const l=this._requestManager.transformRequest(_,"Style");a.j(l,new AbortController).then((p=>{this._updateDiff(p.data,n)})).catch((p=>{p&&this.fire(new a.k(p))}))}else typeof _=="object"&&this._updateDiff(_,n)}_updateDiff(_,n){try{this.style.setState(_,n)&&this._update(!0)}catch(l){a.w(`Unable to perform style diff: ${l.message||l.error||l}.  Rebuilding the style from scratch.`),this._updateStyle(_,n)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():a.w("There is no style added to the map.")}addSource(_,n){return this._lazyInitEmptyStyle(),this.style.addSource(_,n),this._update(!0)}isSourceLoaded(_){const n=this.style&&this.style.sourceCaches[_];if(n!==void 0)return n.loaded();this.fire(new a.k(new Error(`There is no source with ID '${_}'`)))}setTerrain(_){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),_){const n=this.style.sourceCaches[_.source];if(!n)throw new Error(`cannot load terrain, because there exists no source with ID: ${_.source}`);this.terrain===null&&n.reload();for(const l in this.style._layers){const p=this.style._layers[l];p.type==="hillshade"&&p.source===_.source&&a.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new Sn(this.painter,n,_),this.painter.renderToTexture=new Oi(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=l=>{l.dataType==="style"?this.terrain.sourceCache.freeRtt():l.dataType==="source"&&l.tile&&(l.sourceId!==_.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),this.terrain.sourceCache.freeRtt(l.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new a.l("terrain",{terrain:_})),this}getTerrain(){var _,n;return(n=(_=this.terrain)===null||_===void 0?void 0:_.options)!==null&&n!==void 0?n:null}areTilesLoaded(){const _=this.style&&this.style.sourceCaches;for(const n in _){const l=_[n]._tiles;for(const p in l){const g=l[p];if(g.state!=="loaded"&&g.state!=="errored")return!1}}return!0}removeSource(_){return this.style.removeSource(_),this._update(!0)}getSource(_){return this.style.getSource(_)}addImage(_,n,l={}){const{pixelRatio:p=1,sdf:g=!1,stretchX:x,stretchY:T,content:A,textFitWidth:C,textFitHeight:R}=l;if(this._lazyInitEmptyStyle(),!(n instanceof HTMLImageElement||a.b(n))){if(n.width===void 0||n.height===void 0)return this.fire(new a.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:L,height:N,data:z}=n,H=n;return this.style.addImage(_,{data:new a.R({width:L,height:N},new Uint8Array(z)),pixelRatio:p,stretchX:x,stretchY:T,content:A,textFitWidth:C,textFitHeight:R,sdf:g,version:0,userImage:H}),H.onAdd&&H.onAdd(this,_),this}}{const{width:L,height:N,data:z}=D.getImageData(n);this.style.addImage(_,{data:new a.R({width:L,height:N},z),pixelRatio:p,stretchX:x,stretchY:T,content:A,textFitWidth:C,textFitHeight:R,sdf:g,version:0})}}updateImage(_,n){const l=this.style.getImage(_);if(!l)return this.fire(new a.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const p=n instanceof HTMLImageElement||a.b(n)?D.getImageData(n):n,{width:g,height:x,data:T}=p;if(g===void 0||x===void 0)return this.fire(new a.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(g!==l.data.width||x!==l.data.height)return this.fire(new a.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const A=!(n instanceof HTMLImageElement||a.b(n));return l.data.replace(T,A),this.style.updateImage(_,l),this}getImage(_){return this.style.getImage(_)}hasImage(_){return _?!!this.style.getImage(_):(this.fire(new a.k(new Error("Missing required image id"))),!1)}removeImage(_){this.style.removeImage(_)}loadImage(_){return ke.getImage(this._requestManager.transformRequest(_,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(_,n){return this._lazyInitEmptyStyle(),this.style.addLayer(_,n),this._update(!0)}moveLayer(_,n){return this.style.moveLayer(_,n),this._update(!0)}removeLayer(_){return this.style.removeLayer(_),this._update(!0)}getLayer(_){return this.style.getLayer(_)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(_,n,l){return this.style.setLayerZoomRange(_,n,l),this._update(!0)}setFilter(_,n,l={}){return this.style.setFilter(_,n,l),this._update(!0)}getFilter(_){return this.style.getFilter(_)}setPaintProperty(_,n,l,p={}){return this.style.setPaintProperty(_,n,l,p),this._update(!0)}getPaintProperty(_,n){return this.style.getPaintProperty(_,n)}setLayoutProperty(_,n,l,p={}){return this.style.setLayoutProperty(_,n,l,p),this._update(!0)}getLayoutProperty(_,n){return this.style.getLayoutProperty(_,n)}setGlyphs(_,n={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(_,n),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(_,n,l={}){return this._lazyInitEmptyStyle(),this.style.addSprite(_,n,l,(p=>{p||this._update(!0)})),this}removeSprite(_){return this._lazyInitEmptyStyle(),this.style.removeSprite(_),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(_,n={}){return this._lazyInitEmptyStyle(),this.style.setSprite(_,n,(l=>{l||this._update(!0)})),this}setLight(_,n={}){return this._lazyInitEmptyStyle(),this.style.setLight(_,n),this._update(!0)}getLight(){return this.style.getLight()}setSky(_,n={}){return this._lazyInitEmptyStyle(),this.style.setSky(_,n),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(_,n){return this.style.setFeatureState(_,n),this._update()}removeFeatureState(_,n){return this.style.removeFeatureState(_,n),this._update()}getFeatureState(_){return this.style.getFeatureState(_)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let _=0,n=0;return this._container&&(_=this._container.clientWidth||400,n=this._container.clientHeight||300),[_,n]}_setupContainer(){const _=this._container;_.classList.add("maplibregl-map");const n=this._canvasContainer=F.create("div","maplibregl-canvas-container",_);this._interactive&&n.classList.add("maplibregl-interactive"),this._canvas=F.create("canvas","maplibregl-canvas",n),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const l=this._containerDimensions(),p=this._getClampedPixelRatio(l[0],l[1]);this._resizeCanvas(l[0],l[1],p);const g=this._controlContainer=F.create("div","maplibregl-control-container",_),x=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((T=>{x[T]=F.create("div",`maplibregl-ctrl-${T} `,g)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(_,n,l){this._canvas.width=Math.floor(l*_),this._canvas.height=Math.floor(l*n),this._canvas.style.width=`${_}px`,this._canvas.style.height=`${n}px`}_setupPainter(){const _=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let n=null;this._canvas.addEventListener("webglcontextcreationerror",(p=>{n={requestedAttributes:_},p&&(n.statusMessage=p.statusMessage,n.type=p.type)}),{once:!0});let l=null;if(l=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,_):this._canvas.getContext("webgl2",_)||this._canvas.getContext("webgl",_),!l){const p="Failed to initialize WebGL";throw n?(n.message=p,new Error(JSON.stringify(n))):new Error(p)}this.painter=new dd(l,this.transform),X.testSupport(l)}migrateProjection(_,n){super.migrateProjection(_,n),this.painter.transform=_,this.fire(new a.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(_){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||_,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(_){return this._update(),this._renderTaskQueue.add(_)}_cancelRenderFrame(_){this._renderTaskQueue.remove(_)}_render(_){var n,l,p,g,x;const T=this._idleTriggered?this._fadeDuration:0,A=((n=this.style.projection)===null||n===void 0?void 0:n.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(_),this._removed)return;let C=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const N=this.transform.zoom,z=D.now();this.style.zoomHistory.update(N,z);const H=new a.C(N,{now:z,fadeDuration:T,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),q=H.crossFadingFactor();q===1&&q===this._crossFadingFactor||(C=!0,this._crossFadingFactor=q),this.style.update(H)}const R=((l=this.style.projection)===null||l===void 0?void 0:l.transitionState)>0!==A;(p=this.style.projection)===null||p===void 0||p.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState((g=this.style.projection)===null||g===void 0?void 0:g.transitionState,(x=this.style.projection)===null||x===void 0?void 0:x.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||R)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,T,this._crossSourceCollisions,R),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:T,showPadding:this.showPadding}),this.fire(new a.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,a.cf.mark(a.cg.load),this.fire(new a.l("load"))),this.style&&(this.style.hasTransitions()||C)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const L=this._sourcesDirty||this._styleDirty||this._placementDirty;return L||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new a.l("idle")),!this._loaded||this._fullyLoaded||L||(this._fullyLoaded=!0,a.cf.mark(a.cg.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var _;this._hash&&this._hash.remove();for(const l of this._controls)l.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),typeof window<"u"&&removeEventListener("online",this._onWindowOnline,!1),ke.removeThrottleControl(this._imageQueueHandle),(_=this._resizeObserver)===null||_===void 0||_.disconnect();const n=this.painter.context.gl.getExtension("WEBGL_lose_context");n?.loseContext&&n.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),F.remove(this._canvasContainer),F.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),a.cf.clearMetrics(),this._removed=!0,this.fire(new a.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,D.frame(this._frameRequest,(_=>{a.cf.frame(_),this._frameRequest=null;try{this._render(_)}catch(n){if(!a.ch(n)&&!(function(l){return l.message===od})(n))throw n}}),(()=>{})))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(_){this._showTileBoundaries!==_&&(this._showTileBoundaries=_,this._update())}get showPadding(){return!!this._showPadding}set showPadding(_){this._showPadding!==_&&(this._showPadding=_,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(_){this._showCollisionBoxes!==_&&(this._showCollisionBoxes=_,_?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(_){this._showOverdrawInspector!==_&&(this._showOverdrawInspector=_,this._update())}get repaint(){return!!this._repaint}set repaint(_){this._repaint!==_&&(this._repaint=_,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(_){this._vertices=_,this._update()}get version(){return Ad}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(_){return this._lazyInitEmptyStyle(),this.style.setProjection(_),this._update(!0)}},d.MapMouseEvent=Di,d.MapTouchEvent=Rr,d.MapWheelEvent=hu,d.Marker=ga,d.NavigationControl=class{constructor(_){this._updateZoomButtons=()=>{const n=this._map.getZoom(),l=n===this._map.getMaxZoom(),p=n===this._map.getMinZoom();this._zoomInButton.disabled=l,this._zoomOutButton.disabled=p,this._zoomInButton.setAttribute("aria-disabled",l.toString()),this._zoomOutButton.setAttribute("aria-disabled",p.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(n,l)=>{const p=this._map._getUIString(`NavigationControl.${l}`);n.title=p,n.setAttribute("aria-label",p)},this.options=a.e({},Cl,_),this._container=F.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",(n=>n.preventDefault())),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",(n=>this._map.zoomIn({},{originalEvent:n}))),F.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",(n=>this._map.zoomOut({},{originalEvent:n}))),F.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",(n=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:n}):this._map.resetNorth({},{originalEvent:n})})),this._compassIcon=F.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(_){return this._map=_,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new wu(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){F.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(_,n){const l=F.create("button",_,this._container);return l.type="button",l.addEventListener("click",n),l}},d.Popup=class extends a.E{constructor(_){super(),this._updateOpacity=()=>{this.options.locationOccludedOpacity!==void 0&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:void 0)},this.remove=()=>(this._content&&F.remove(this._content),this._container&&(F.remove(this._container),delete this._container),this._closeButton&&this._closeButton.removeEventListener("click",this._onClose),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new a.l("close"))),this),this._onMouseUp=n=>{this._update(n.point)},this._onMouseMove=n=>{this._update(n.point)},this._onDrag=n=>{this._update(n.point)},this._update=n=>{var l;if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=F.create("div","maplibregl-popup",this._map.getContainer()),this._tip=F.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const A of this.options.className.split(" "))this._container.classList.add(A);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=this._map.transform.renderWorldCopies&&!this._trackPointer?Il(this._lngLat,this._flatPos,this._map.transform):(l=this._lngLat)===null||l===void 0?void 0:l.wrap(),this._trackPointer&&!n)return;const p=this._flatPos=this._pos=this._trackPointer&&n?n:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&n?n:this._map.transform.locationToScreenPoint(this._lngLat));let g=this.options.anchor;const x=Dl(this.options.offset);if(!g){const A=this._container.offsetWidth,C=this._container.offsetHeight;let R;R=p.y+x.bottom.y<C?["top"]:p.y>this._map.transform.height-C?["bottom"]:[],p.x<A/2?R.push("left"):p.x>this._map.transform.width-A/2&&R.push("right"),g=R.length===0?"bottom":R.join("-")}let T=p.add(x[g]);this.options.subpixelPositioning||(T=T.round()),F.setTransform(this._container,`${$s[g]} translate(${T.x}px,${T.y}px)`),Ml(this._container,g,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=a.e(Object.create(kl),_)}addTo(_){return this._map&&this.remove(),this._map=_,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new a.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(_){return this._lngLat=a.Q.convert(_),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(_){return this.setDOMContent(document.createTextNode(_))}setHTML(_){const n=document.createDocumentFragment(),l=document.createElement("body");let p;for(l.innerHTML=_;p=l.firstChild,p;)n.appendChild(p);return this.setDOMContent(n)}getMaxWidth(){var _;return(_=this._container)===null||_===void 0?void 0:_.style.maxWidth}setMaxWidth(_){return this.options.maxWidth=_,this._update(),this}setDOMContent(_){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=F.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(_),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(_){return this._container&&this._container.classList.add(_),this}removeClassName(_){return this._container&&this._container.classList.remove(_),this}setOffset(_){return this.options.offset=_,this._update(),this}toggleClassName(_){if(this._container)return this._container.classList.toggle(_)}setSubpixelPositioning(_){this.options.subpixelPositioning=_}_createCloseButton(){this.options.closeButton&&(this._closeButton=F.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const _=this._container.querySelector(Eu);_&&_.focus()}},d.RasterDEMTileSource=rs,d.RasterTileSource=sn,d.ScaleControl=class{constructor(_){this._onMove=()=>{Rl(this._map,this._container,this.options)},this.setUnit=n=>{this.options.unit=n,Rl(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},Su),_)}getDefaultPosition(){return"bottom-left"}onAdd(_){return this._map=_,this._container=F.create("div","maplibregl-ctrl maplibregl-ctrl-scale",_.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){F.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},d.ScrollZoomHandler=Td,d.Style=ia,d.TerrainControl=class{constructor(_){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=_}onAdd(_){return this._map=_,this._container=F.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=F.create("button","maplibregl-ctrl-terrain",this._container),F.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){F.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},d.TwoFingersTouchPitchHandler=gu,d.TwoFingersTouchRotateHandler=wd,d.TwoFingersTouchZoomHandler=bd,d.TwoFingersTouchZoomRotateHandler=xu,d.VectorTileSource=Jt,d.VideoSource=on,d.addSourceType=(_,n)=>a._(void 0,void 0,void 0,(function*(){if(Cs(_))throw new Error(`A source type called "${_}" already exists.`);((l,p)=>{Ps[l]=p})(_,n)})),d.clearPrewarmedResources=function(){const _=bt;_&&(_.isPreloaded()&&_.numActive()===1?(_.release(Ge),bt=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},d.createTileMesh=ea,d.getMaxParallelImageRequests=function(){return a.a.MAX_PARALLEL_IMAGE_REQUESTS},d.getRTLTextPluginStatus=function(){return zn().getRTLTextPluginStatus()},d.getVersion=function(){return Ol},d.getWorkerCount=function(){return tt.workerCount},d.getWorkerUrl=function(){return a.a.WORKER_URL},d.importScriptInWorkers=function(_){return Wt().broadcast("IS",_)},d.prewarm=function(){Lt().acquire(Ge)},d.setMaxParallelImageRequests=function(_){a.a.MAX_PARALLEL_IMAGE_REQUESTS=_},d.setRTLTextPlugin=function(_,n){return zn().setRTLTextPlugin(_,n)},d.setWorkerCount=function(_){tt.workerCount=_},d.setWorkerUrl=function(_){a.a.WORKER_URL=_}}));var c=t;return c}))})(Bf)),Bf.exports}var CB=PB();const Im=Y0(CB),{useState:IB,useEffect:Mm,useRef:Ea,useMemo:xf,useCallback:up}=xS,MB=kS;function RB(i,e){let t=!1,r=null;return((...o)=>{t?r=o:(i(...o),t=!0,setTimeout(()=>{t=!1,r&&(i(...r),r=null)},e))})}function FB({projectCDs:i=[],focusCD:e=null,height:t="500px",initialZoom:r=13,mapId:o="default-map",CDToSlugMap:c={}}){const d=Ea(r),[a,y]=IB(!0),w=up(X=>{d.current=X},[]),E=`map-container-${o}`,I=`maplibre-map-${o}`,D=o==="home-page-map"?"100vh":t,F=up(()=>{setTimeout(()=>{y(!1)},500)},[]);return xs.jsx(wS,{children:xs.jsxs("div",{className:"relative h-full w-full overflow-hidden rounded-lg",children:[xs.jsx("style",{children:`
          .map-billboard-marker {
            transition: opacity 0.15s ease-out;
          }
          .tooltip-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
            contain: layout style paint;
          }
          .tooltip-content.active {
            border-color: #10b981;
          }
          .tooltip-content h3 {
            font-size: 14px;
            font-weight: 700;
            color: #111827;
            margin: 0 0 2px 0;
            line-height: 1.2;
          }
          .tooltip-content span {
            font-size: 12px;
            color: #6b7280;
          }
          .tooltip-content.active span {
            color: #10b981;
            font-weight: 500;
          }
          .tooltip-arrow {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid white;
            margin: -1px auto 0 auto;
          }
          .tooltip-arrow.active {
            border-top-color: #10b981;
          }
          .maplibregl-canvas {
            outline: none !important;
          }
        `}),xs.jsx("div",{className:`absolute inset-0 bg-card flex items-center justify-center z-20 transition-opacity duration-700 ${a?"opacity-100":"opacity-0 pointer-events-none"}`,style:{height:D},"aria-hidden":!a,children:xs.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[xs.jsx("div",{className:"w-10 h-10 border-4 border-primary/30 border-t-primary rounded-full animate-spin"}),xs.jsx("p",{className:"text-sm text-muted-foreground font-medium",children:"Initializing 3D Map..."})]})}),xs.jsx("div",{id:E,className:"w-full h-full relative bg-slate-50",style:{height:D}}),xs.jsx(kB,{projectCDs:i,focusCD:e,initialZoom:r,onZoomChange:w,mapId:o,mapContainerId:E,mapLibreId:I,CDToSlugMap:c,onMapLoaded:F})]})})}const kB=Kn.memo(function({projectCDs:e,focusCD:t,initialZoom:r,onZoomChange:o,mapId:c,mapContainerId:d,mapLibreId:a,CDToSlugMap:y,onMapLoaded:w}){if(typeof window>"u")return null;const{setMapInstance:E,geojsonData:I,setGeojsonData:D,setDeckOverlay:F}=TS(),X=Ea(null),oe=Ea(null),_e=Ea(null),ge=Ea(null),fe=Ea(null),Te=Ea([]),ke=xf(()=>new Set(e.map(ae=>String(ae).trim())),[e]),Je=xf(()=>{if(!I||!I.features)return[];try{return tE(I)}catch(ae){return console.error("Error generating map geometry:",ae),[]}},[I]),Xe=xf(()=>{if(!I||!I.features)return[];const ae=[];for(const be of I.features){const ye=be.properties?.cdCode||be.properties?.boro_cd||be.properties?.BoroCD,we=ye?String(ye).trim():null;if(be.properties||(be.properties={}),!be.properties.cdCode&&we&&(be.properties.cdCode=we),be.properties.isActive=we&&ke.has(we),!be.properties.centroid)try{const Se=MB(be);be.properties.centroid=Se.geometry.coordinates}catch{}ae.push(be)}return ae},[I,ke]);Mm(()=>{let ae=!1;return(async()=>{if(ae)return;const ye=document.getElementById(d);if(!ye||X.current)return;if(!I)try{const ee=await fetch("/data/cds_nyc.geojson");if(ee.ok){const K=await ee.json();ae||D(K)}}catch(ee){console.error("Failed to load map data",ee)}const we=document.createElement("div");we.id=a,we.style.width="100%",we.style.height="100%",ye.appendChild(we);const Se=new Im.Map({container:a,style:"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",center:[-74.006,40.7128],zoom:r,pitch:45,bearing:-15,minZoom:10,maxZoom:16,antialias:!1,fadeDuration:0,trackResize:!0,renderWorldCopies:!1,preserveDrawingBuffer:!1,refreshExpiredTiles:!1});X.current=Se,c==="default-map"&&E(Se),ES.registerMap(c,Se),Se.addControl(new Im.NavigationControl({visualizePitch:!0,showCompass:!0,showZoom:!0}),"top-right");const Ee=document.createElement("div");Ee.className="map-billboard-marker",Ee.style.cssText=`
        pointer-events: none;
        will-change: transform;
        transform: translateZ(0);
        backface-visibility: hidden;
        opacity: 0;
        padding-bottom: 20px;
        contain: layout style paint;
      `,ge.current=Ee;const W=new Im.Marker({element:Ee,anchor:"bottom",offset:[0,-10]}).setLngLat([-74.006,40.7128]).addTo(Se);return _e.current=W,Se.on("load",()=>{!ae&&w&&w()}),Se.on("moveend",()=>{o&&o(Se.getZoom())}),()=>{ae=!0,_e.current&&_e.current.remove(),X.current&&(X.current.remove(),X.current=null)}})(),()=>{ae=!0}},[c]);const mt=up(ae=>{if(!ae?.object)return;const be=ae.object.properties?.cdCode;if(be&&ke.has(String(be).trim())&&y[be]){const ye=y[be];if(ye.startsWith("http"))window.open(ye,"_blank","noopener,noreferrer");else{const we=ye.startsWith("/projects/")?ye:`/projects/${ye}`;window.location.href=we}}},[ke,y]),G=up(ae=>{const be=X.current;if(!be)return;const ye=ae.object,we=ge.current,Se=_e.current,Ee=be.getCanvas();if(!we||!Se)return;if(!ye){fe.current!==null&&(we.style.opacity="0",fe.current=null,Ee&&(Ee.style.cursor="grab"));return}const W=ye.properties?.cdCode,ee=ye.properties?.isActive;if(Ee&&(Ee.style.cursor=ee?"pointer":"grab"),fe.current===W)return;fe.current=W;let K=null;ye.properties?.centroid?K=ye.properties.centroid:ae.coordinate&&(K=[ae.coordinate[0],ae.coordinate[1]]),K&&(Se.setLngLat(K),we.style.opacity="1",we.innerHTML=`
      <div class="tooltip-content ${ee?"active":""}">
        <h3>${W||"District"}</h3>
        <span>${ee?"â Active Project":"No active project"}</span>
      </div>
      <div class="tooltip-arrow ${ee?"active":""}"></div>
    `)},[]),J=xf(()=>RB(G,16),[G]);return Mm(()=>{if(!X.current||!I)return;const ae=`${c}-layers`,be=[16,185,129,20],ye=[0,0,0,0],we=[16,185,129,200],Se=[156,163,175,100],Ee={pickable:!0,stroked:!0,filled:!0,extruded:!0,wireframe:!1,lineWidthScale:1,lineWidthMinPixels:1,getFillColor:(ee=>ee.properties.isActive?be:ye),getLineColor:(ee=>ee.properties.isActive?we:Se),getElevation:(ee=>ee.properties.isActive?100:0),autoHighlight:!0,highlightColor:[16,185,129,50],pickingRadius:2,parameters:{depthTest:!0,blend:!0},onClick:mt,onHover:J,updateTriggers:{getLineColor:[e],getFillColor:[e],getElevation:[e]}},W=[];if(Xe.length>0&&W.push(new cp({...Ee,id:`${ae}-merged`,data:Xe,material:{ambient:.5,diffuse:.5,shininess:0,specularColor:[0,0,0]}})),Je.length>0&&W.push(new cp({id:`${ae}-outlines`,data:Je,pickable:!1,stroked:!0,filled:!1,lineWidthUnits:"pixels",getLineColor:ee=>{const K=ee.properties?.cdCode;return ke.has(K)?[16,185,129,255]:[100,100,100,100]},getLineWidth:ee=>{const K=ee.properties?.cdCode;return ke.has(K)?3:1},parameters:{depthTest:!1},updateTriggers:{getLineColor:[e],getLineWidth:[e]}})),Te.current=W,oe.current)oe.current.setProps({layers:W});else{const ee=new EB({interleaved:!0,layers:W,_pickable:!0});oe.current=ee,X.current.addControl(ee),F(ee)}},[Xe,Je,ke,mt,J]),Mm(()=>{const ae=ye=>{if(!X.current||!I)return;const we=String(ye).trim(),Se=I.features.find(Ee=>{const W=Ee.properties?.cdCode||Ee.properties?.boro_cd;return String(W).trim()===we});if(Se){const Ee=iE(Se);X.current.flyTo({center:[(Ee.minLng+Ee.maxLng)/2,(Ee.minLat+Ee.maxLat)/2],zoom:13.5,pitch:50,bearing:-10,duration:2e3,essential:!0})}};window.mapFunctions=window.mapFunctions||{},window.mapFunctions[c]={},hv.registerNavigationHandler(c,ae);const be=ye=>{ye.detail?.mapId===c&&ae(ye.detail.cdCode)};return window.addEventListener("navigateToCD",be),()=>{hv.unregisterNavigationHandler(c),window.removeEventListener("navigateToCD",be)}},[c,I]),null});export{FB as default};
